external procedure GetUserName(String,var String);
external procedure PrintLongLine();
external procedure PrintCompanyInfo(string,string);
external procedure M4PadString(string,Integer,string,Boolean,var string);

procedure SetupComCommands(var string StandardMode,var string EmphesizeOn,var string EmphesizeOff,var string LangSetOn,var string BigSizeOn,var string BigSizeOff,
                           var string UnderlineOn,var string UnderlineOff,var string FormFeed,var string CutPaper,var string CashBox,
                           var string CenterOn,var string CenterOff)
begin
  LangSetOn = chr(27) & chr(116) & chr(2) & chr(27) & chr(82) & chr(5);
  StandardMode = chr(27) & chr(83);
  BigSizeOn = chr(29) & chr(33) & chr(16);
//  BigSizeOff = chr(29) & chr(33) & chr(0);
  BigSizeOff = chr(27) & chr(33) & chr(1);
  EmphesizeOn = chr(27) & chr(69) & chr(1);
  EmphesizeOff = chr(27) & chr(69) & chr(0);
  UnderlineOn = chr(27) & chr(45) & chr(1);;
  UnderlineOff = chr(27) & chr(45) & chr(0);;
  FormFeed =  chr(27) & chr(100) & chr(5);
  CutPaper = chr(27) & chr(105);
  CashBox = chr(27) & chr(112) & chr(0);
  CenterOn = chr(27) & chr(97) & chr(1);
  CenterOff = chr(27) & chr(97) & chr(0);
  return;
end;

procedure GRVc_PrintEpsonTMT88IIReceipt_PrinterOn()
begin
  string 20 PrintMode,PrinterOn,InitPrinter;

  PrintMode  = chr(27) & chr(33) & chr(49);/*ESC ! 0*/
  InitPrinter = chr(27) & chr(64);/*ESC @*/
  PrinterOn = chr(27) & chr(61) & chr(1); /*ESC = 1*/

  OutComPort(0,PrinterOn);  
  OutComPort(0,PrintMode);  
  OutComPort(0,InitPrinter);  
  return;
end;

procedure PrintRowsHeader(string h1,Integer p1,string h2,Integer p2)
begin
  Integer Error;
  string 255 s,tstr;

  M4PadString(h1,p1," ",false,tstr);
  s = s & tstr;
  M4PadString(h2,p2," ",true,tstr);
  s = s & tstr;
  Error = OutComPort(1,s & chr(10));
  return;
end;

procedure GRVc_PrintEpsonTMT88IIReceipt_Header(var record GiftReceiptVc GRr)
begin
  String 20 StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,CenterOn,CenterOff;
  String 20 FormFeed,CutPaper,CashBox;
  String 80 s,L1,L2;
  Integer Error;

  SetupComCommands(StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,FormFeed,CutPaper,CashBox,CenterOn,CenterOff);
  GRVc_PrintEpsonTMT88IIReceipt_PrinterOn;
  Error = OutComPort(1,StandardMode);

  Error = OutComPort(1,BigSizeOff);
  PrintCompanyInfo("" &  EmphesizeOn & UnderlineOn,"" & UnderlineOff & EmphesizeOff);
  Error = OutComPort(1,StandardMode);
  Error = OutComPort(1,BigSizeOff);
  
  s = USetStr(11197) & " " & GRr.CustCode;
  Error = OutComPort(1,s & chr(10)); s="";
  if (nonblank(GRr.Addr0)) then begin 
    s = GRr.Addr0;
    Error = OutComPort(1,s & chr(10)); s="";
  end;
  if (nonblank(GRr.Addr1)) then begin
    s = GRr.Addr1;
    Error = OutComPort(1,s & chr(10)); s="";
  end;
  if (nonblank(GRr.Addr2)) then begin
     s = GRr.Addr2;
    Error = OutComPort(1,s & chr(10)); s="";
  end;
  if (nonblank(GRr.Addr3)) then begin
    s = GRr.Addr3;
   Error = OutComPort(1,s & chr(10)); s="";
  end;
  if (nonblank(GRr.InvAddr4)) then begin
    s = GRr.InvAddr4;
    Error = OutComPort(1,s & chr(10)); s="";
  end;
  PrintLongLine;
  Error = OutComPort(1,EmphesizeOn);
  PrintRowsHeader(USetStr(11187),15+10+9,USetStr(11201),9);
  Error = OutComPort(1,EmphesizeOff);
  return;
end;

procedure GRVc_PrintEpsonTMT88IIReceiptRow_SendToCom(string s)
begin
  String 20 StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,CenterOn,CenterOff;
  String 20 FormFeed,CutPaper,CashBox;
  Integer Error;

  SetupComCommands(StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,FormFeed,CutPaper,CashBox,CenterOn,CenterOff);
  Error = OutComPort(1,BigSizeOff & EmphesizeOff);
  Error = OutComPort(1,s & chr(10)); 
  return;
end;

procedure AddStringListRow(string spec,string q,var string res)
begin
  string 255 tstr,tstr2;
  Integer m,al,dl,ql,pl,sl;

//total 45-2
  dl = 15+10+9;
  ql = 9;

  M4PadString(spec,dl," ",false,tstr2);
  tstr = tstr & tstr2;
  M4PadString(q,ql," ",true,tstr2);
  tstr = tstr & tstr2;
  res = tstr;
  return;
end;

procedure AddStringListRow2(string spec,var string res)
begin
  M4PadString(spec,45," ",false,res);
  return;
end;

procedure GRVc_PrintEpsonTMT88IIReceiptRow(row GiftReceiptVc GRrw,record SysFormatBlock SFb)
begin
  string 255 s;
  
  switch (GRrw.stp) begin
      case kInvoiceRowTypeStructuredItemComponent:
        goto LkInvoiceRowTypeNormal1;
      case kInvoiceRowTypeNormal:
LkInvoiceRowTypeNormal1:;
      if (GRrw.Sum!=0) then begin
        AddStringListRow(GRrw.Spec,ValToString(GRrw.Quant,M4Qty,SFb.thousSep,SFb.decimalPt,0),s);
        GRVc_PrintEpsonTMT88IIReceiptRow_SendToCom(s);
        if (nonblank(GRrw.SerialNr)) then begin
          AddStringListRow2(USetStr(24178) & "  " & GRrw.SerialNr,s);
          GRVc_PrintEpsonTMT88IIReceiptRow_SendToCom(s);
        end;
      end;
  end;
  return;
end;

procedure GRVc_PrintEpsonTMT88IIReceipt_Footer(var record GiftReceiptVc GRr,record SysFormatBlock SFb)
begin
  string 255 s;
  String 20 StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,CenterOn,CenterOff;
  String 20 FormFeed,CutPaper,CashBox;
  Integer Error;
  string 60 pername;

  SetupComCommands(StandardMode,EmphesizeOn,EmphesizeOff,LangSetOn,BigSizeOn,BigSizeOff,UnderlineOn,UnderlineOff,FormFeed,CutPaper,CashBox,CenterOn,CenterOff);

  Error = OutComPort(1,BigSizeOff & EmphesizeOff);
  PrintLongLine;
  
  GetUserName(GRr.SalesMan,pername);
  Error = OutComPort(1,USetStr(9230) & ": " & pername & chr(10)); s ="";
  s = USetStr(11224) & ": " & GRr.SerNr & "    " & GRr.TransDate & "  " & GRr.TransTime;
  Error = OutComPort(1,s & chr(10)); s ="";
  Error = OutComPort(1,s & chr(10)); s ="";
  if (GRr.OKFlag!=0) then begin
    Error = OutComPort(1,EmphesizeOn & "      " & USetStr(27520) & chr(10)); 
    Error = OutComPort(1,s & chr(10)); s ="";
//    Error = OutComPort(1,"  For comments and suggetions: 0920-2215318" & chr(10));
//    Error = OutComPort(1,"      customer_service@isetann.com.ph" & chr(10));
    Error = OutComPort(1,s & chr(10)); s ="";
    Error = OutComPort(1,EmphesizeOn & "           " & USetStr(27522) & chr(10) & EmphesizeOff);
  end;
  PrintLongLine;
  s ="";
  Error = OutComPort(1,s & chr(10)); 
  Error = OutComPort(1,s & chr(10)); 
  Error = OutComPort(1,s & chr(10)); 
  Error = OutComPort(1,StandardMode);
  
  return;
end;

global
function Boolean GRVc_PrintEpsonTMT88IIReceipt(var record GiftReceiptVc GRr)
begin
  Boolean res,testf;
  row GiftReceiptVc GRrw;
  record CUVc CUr;
  Integer Error;
  String 20 FormFeed,CutPaper,PrinterOff,s;  
  record LocalMachineBlock LMb;
  record SysFormatBlock SFb;
  val totq,tota;
  vector Boolean vartcodef;
  Integer i,rwcnt;

  BlockLoad(SFb);
  BlockLoad(LMb);
  GRVc_PrintEpsonTMT88IIReceipt_Header(GRr);

  rwcnt = MatRowCnt(GRr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(GRr,i,GRrw);
    testf = true;
    if (testf) then begin
      GRVc_PrintEpsonTMT88IIReceiptRow(GRrw,SFb);
    end;
  end;
  rwcnt = MatRowCnt(GRr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(GRr,i,GRrw);
    switch (GRrw.stp) begin
      case kInvoiceRowTypeStructuredItemComponent:
        goto LkInvoiceRowTypeNormal2;
      case kInvoiceRowTypeNormal:
LkInvoiceRowTypeNormal2:;
        if (nonblank(GRrw.ArtCode)) then begin
          totq = totq + GRrw.Quant;
          if (vartcodef[GRrw.ArtCode]==false) then begin
            tota = tota + 1;
            vartcodef[GRrw.ArtCode] = true;
          end;
        end;
    end;
  end;

  AddStringListRow2(ValToString(tota,M4UVal,SFb.thousSep,SFb.decimalPt,0) & " " & USetStr(24174),s);
  GRVc_PrintEpsonTMT88IIReceiptRow_SendToCom(s);
  GRVc_PrintEpsonTMT88IIReceipt_Footer(GRr,SFb);
    
  FormFeed =  chr(27) & chr(100) & chr(5);
  CutPaper = chr(27) & chr(105);
  PrinterOff = chr(27) & chr(61) & chr(2); //ESC = 2

  Error = OutComPort(1,FormFeed);
  Error = OutComPort(1,CutPaper);
  OutComPort(0,PrinterOff);  
  Error = CloseComPort(1);
  GRVc_PrintEpsonTMT88IIReceipt = res;
  return;
end;

global
function Boolean GRVc_PrintEpsonAxiohmA777Receipt(var record GiftReceiptVc GRr)
begin
  GRVc_PrintEpsonAxiohmA777Receipt = GRVc_PrintEpsonTMT88IIReceipt(GRr);
  return;
end;
