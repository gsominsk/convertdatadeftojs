external function Boolean IsEnterprise();
external function Boolean HasIntegratedNL();
external function Boolean CorrectM4ValProc(val);

global
updating function LongInt VATCodeBlockCheck(var record VATCodeBlock VATCoder,record VATCodeBlock VATCode2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  Integer i,j;
  Integer rwcnt;
  record AccVc Accr;
  row VATCodeBlock VATCoderw;
  row VATCodeBlock VATCode2rw;
  string 255 tstr;
  record TaxRulesVc TaxRuler;
  record CYBlock CYb;
  transaction Boolean gSynchServToOfflineSettingsm;
  Boolean testf;
  record TRGenBlock TRGenb;

  res = 0;
  if (((AutoSyncing and IsLiveSyncPOS) or (gSynchServToOfflineSettingsm)) and ServerMode==false) then begin
    goto LVATCodeBlockCheck;
  end;
  BlockLoad(CYb);

  BlockLoad(TRGenb);
  rwcnt = MatRowCnt(VATCoder);
  for (i=0; i<rwcnt;i=i+1) begin
    MatRowGet(VATCoder,i,VATCoderw);
    if (len(VATCoderw.VATCode)>10) then begin
      RecordCheckError(20413,"",i,"VATCode");      
      res = -1;
      goto LVATCodeBlockCheck;
    end;
    for (j=(i+1); j<rwcnt; j=j+1) begin
      MatRowGet(VATCoder,j,VATCode2rw);
       if (VATCode2rw.VATCode==VATCoderw.VATCode) then begin
         RecordCheckError(1545,VATCode2rw.VATCode,j,"VATCode");      
         res = -1;
         goto LVATCodeBlockCheck;
       end;
    end;
    if (CorrectM4ValProc(VATCoderw.ExVatpr)==false) then begin
      RecordCheckError(1019,VATCoderw.ExVatpr,i,"ExVatpr");      
      res = -1;
      goto LVATCodeBlockCheck;
    end;
    if (CorrectM4ValProc(VATCoderw.IncVatpr)==false) then begin
      RecordCheckError(1019,VATCoderw.IncVatpr,i,"IncVatpr");      
      res = -1;
      goto LVATCodeBlockCheck;
    end;
    testf = true;
    if (ProgramType>=typStandardOrganizer) and (ProgramType<=typStdAccountsServer) then begin
      if (ProgramType!=typStdAccounts) and (ProgramType!=typStdNominalLedger) and (ProgramType!=typStdStock) then begin
        testf = false;
      end;
    end;
    if (testf) then begin
      if (IsEnterprise or HasIntegratedNL) then begin 
        if (nonblank(VATCoderw.SalesVATAcc)) then begin
          Accr.AccNumber = VATCoderw.SalesVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.SalesVATAcc,i,"SalesVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.PurchVATAcc)) then begin
          Accr.AccNumber = VATCoderw.PurchVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.PurchVATAcc,i,"PurchVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.Tax1Acc)) then begin
          Accr.AccNumber = VATCoderw.Tax1Acc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.Tax1Acc,i,"Tax1Acc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.PayPurchVATAcc)) then begin
          Accr.AccNumber = VATCoderw.PayPurchVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.PayPurchVATAcc,i,"PayPurchVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.PaySalesVATAcc)) then begin
          Accr.AccNumber = VATCoderw.PaySalesVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.PaySalesVATAcc,i,"PaySalesVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.CorSalesVATAcc)) then begin
          Accr.AccNumber = VATCoderw.CorSalesVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.CorSalesVATAcc,i,"CorSalesVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.CorPurchVATAcc)) then begin
          Accr.AccNumber = VATCoderw.CorPurchVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.CorPurchVATAcc,i,"CorPurchVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        
        if (nonblank(VATCoderw.CredSalesVATAcc)) then begin
          Accr.AccNumber = VATCoderw.CredSalesVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.CredSalesVATAcc,i,"CredSalesVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.CredPurchVATAcc)) then begin
          Accr.AccNumber = VATCoderw.CredPurchVATAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.CredPurchVATAcc,i,"CredPurchVATAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
        if (nonblank(VATCoderw.HotelWIPAcc)) then begin
          Accr.AccNumber = VATCoderw.HotelWIPAcc;
          if (ReadFirstMain(Accr,1,true)==false) then begin
            RecordCheckError(1007,VATCoderw.HotelWIPAcc,i,"HotelWIPAcc");      
            res = -1;
            goto LVATCodeBlockCheck;
          end;
        end;
      end;
      if (CorrectM4ValProc(VATCoderw.ExVatpr)==false) then begin
        RecordCheckError(1019,VATCoderw.ExVatpr,i,"ExVatpr");      
        res = -1;
        goto LVATCodeBlockCheck;
      end;
      if (CorrectM4ValProc(VATCoderw.IncVatpr)==false) then begin
        RecordCheckError(1019,VATCoderw.IncVatpr,i,"IncVatpr");      
        res = -1;
        goto LVATCodeBlockCheck;
      end;
      if (HasLocalization("POL")) then begin
        if (blank(VATCoderw.VATRateTier)) then begin
          RecordCheckError(1058,VATCoderw.VATRateTier,i,"VATRateTier");      
          res = -1;
          goto LVATCodeBlockCheck;
        end;
        if (blank(VATCoderw.TaxRules)) then begin
          RecordCheckError(1058,VATCoderw.TaxRules,i,"TaxRules");      
          res = -1;
          goto LVATCodeBlockCheck;
        end;
      end;
      if (nonblank(VATCoderw.TaxRules)) then begin
        TaxRuler.Code = VATCoderw.TaxRules;
        if (ReadFirstMain(TaxRuler,1,true)==false) then begin
          RecordCheckError(1290,": " & VATCoderw.TaxRules,i,"TaxRules");      
          res = -1;
          goto LVATCodeBlockCheck;
        end;
      end;
      if (CYb.ForceTaxRules!=0) then begin
        if (blank(VATCoderw.TaxRules)) then begin
          RecordCheckError(1058,"",i,"TaxRules");      
          res = -1;
          goto LVATCodeBlockCheck;
        end;
      end;      
    end;
  end;
LVATCodeBlockCheck:;
  VATCodeBlockCheck = res;
  RETURN;
END;
