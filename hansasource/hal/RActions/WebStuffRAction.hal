external procedure SumUpShopBasket(var record WebNGShopBasketVc);

global
function LongInt WebParamConvVcRecordCheck(var record WebParamConvVc WebParamConvr,record WebParamConvVc WebParamConv2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  record WebParamConvVc WPCr;
  Integer insertmode,updatemode;

  insertmode = 1;
  updatemode = 2;
  res = 0;
  if (blank(WebParamConvr.Parameter)) then begin
    RecordCheckError(1058,"",-1,"Parameter");      
    res = -1; 
    goto LWebParamConvVcRecordCheck;
  end;
  if (blank(WebParamConvr.Converted)) then begin
    RecordCheckError(1058,"",-1,"Converted");      
    res = -1; 
    goto LWebParamConvVcRecordCheck;
  end;
  if (stat==insertmode) then begin
    WPCr.Converted = WebParamConvr.Converted;
    WPCr.Paramf = WebParamConvr.Paramf;
    if (ReadFirstKey("Converted",WPCr,2,true)) then begin
      RecordCheckError(1063,"",-1,"Converted");      
      res = -1; 
      goto LWebParamConvVcRecordCheck;
    end;
  end;
LWebParamConvVcRecordCheck:; 
  WebParamConvVcRecordCheck = res;
  RETURN;
END;

global
function LongInt WebNewAdvertVcRecordCheck(var record WebNewAdvertVc WebNewAdvertr,record WebNewAdvertVc WebNewAdvert2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;
  record WebNewAdvertVc oldWebNewAdvertr;
  Integer insertmode,updatemode;
  
  insertmode = 1;
  updatemode = 2;
  if (blank(WebNewAdvertr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");
    res = -1;
    goto LWebNewAdvertVcRecordCheck;
  end;
  if (WebNewAdvertr.AlwaysOnWeb!=0) then begin
    oldWebNewAdvertr.AlwaysOnWeb = 1;
    oldWebNewAdvertr.Language = WebNewAdvertr.Language;
    if (ReadFirstKey("AlwaysOnWeb",oldWebNewAdvertr,2,true)) then begin
      if (oldWebNewAdvertr.Code!=WebNewAdvertr.Code) then begin
        RecordCheckError(1063,". Always Viewable can only be set on ONE record per language.",-1,"SerNr");
        res = -1;
        goto LWebNewAdvertVcRecordCheck;
      end;
    end;
  end;
  res = 0;
LWebNewAdvertVcRecordCheck:;  
  WebNewAdvertVcRecordCheck = res;
  RETURN;
END;

global
function LongInt WebNGMenuVcRecordDefaults(var record WebNGMenuVc WMr,record WebNGMenuVc WM2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WMr.ShowWhenLoggedIn = 1;
  WMr.ShowWhenLoggedOut = 1;
  WebNGMenuVcRecordDefaults = res;
  return;
end;

global
function LongInt WebNGTranslateVcRecordDefaults(var record WebNGTranslateVc WebNGTranslater,record WebNGTranslateVc WebNGTranslate2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;

  WebNGTranslater.LastChanged = CurrentDate;
  WebNGTranslater.HtmlTranslation = 1;
  WebNGTranslater.FileName = -1;
  WebNGTranslateVcRecordDefaults = res; 
  RETURN;
END;

global
function LongInt WebNGTranslateVcRecordSave(var record WebNGTranslateVc WebNGTranslater,record WebNGTranslateVc WebNGTranslate2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;

  WebNGTranslater.LastChanged = CurrentDate;
  WebNGTranslateVcRecordSave = res;
  RETURN;
END;

global
function LongInt WebNGTranslateVcRecordUpdate(var record WebNGTranslateVc WebNGTranslater,record WebNGTranslateVc WebNGTranslate2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;

  WebNGTranslater.LastChanged = CurrentDate;
  WebNGTranslateVcRecordUpdate = res;
  RETURN;
END;

global
function LongInt WebNGTranslateVcRemoveTest(var record WebNGTranslateVc WebNGTranslater,record WebNGTranslateVc WebNGTranslate2r,LongInt stat,LongInt long4)
BEGIN
  LongInt res;

  res = 1;
  if (UserCanAction("DeleteWebTranslation",true)) then begin
    res = 0;
  end else begin
    MessageBox(1560,"");
  end;
  WebNGTranslateVcRemoveTest = res;
  RETURN;
END;

global
function LongInt WebNGTranslateVcRecordCheck(var record WebNGTranslateVc WebNGTranslater,record WebNGTranslateVc WebNGTranslate2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (WebNGTranslater.FileName<0) then begin
    RecordCheckError(1058,"",-1,"FileName");      
    res = -1;
    goto LWebNGTranslateVcRecordCheck;
  end;
LWebNGTranslateVcRecordCheck:;
  WebNGTranslateVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGCountryVcRecordDefaults(var record WebNGCountryVc WCr,record WebNGCountryVc WC2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WCr.ShowOnWeb = 1;
  WebNGCountryVcRecordDefaults = res;
  return;
end;

global
function LongInt WebNGStructVcRecordDefaults(var record WebNGStructVc WSr,record WebNGStructVc WS2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  if (SingleUserMode) then begin
    WSr.SerNr = NextSerNr("WebNGStructVc",CurrentDate,-1,false,"");
  end;
  WSr.Mother = -1;
  WebNGStructVcRecordDefaults = res;
  return;
end;

global
function LongInt WebNGStructVcRecordDuplicate(var record WebNGStructVc WSr,record WebNGStructVc WS2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WSr.SerNr = -1;
  if (SingleUserMode) then begin
    WSr.SerNr = NextSerNr("WebNGStructVc",CurrentDate,-1,false,"");
  end;
  WebNGStructVcRecordDuplicate = res;
  return;
end;

global
function LongInt WebNGStructVcRecordCheck(var record WebNGStructVc WSr,record WebNGStructVc WS2r,LongInt stat,LongInt long4)
begin
  Integer insertmode,updatemode;
  record WebNGStructVc WS3r;
  LongInt res;
  boolean testf,foundf;

  insertmode = 1;//Rs_insert
  updatemode = 2;//Rs_update

  res = 0;
  if (WSr.SerNr<=0) then begin
    WSr.SerNr = NextSerNr("WebNGStructVc",CurrentDate,-1,false,"");
  end;
  if (stat==insertmode or WSr.Mother!=WS2r.Mother or WSr.Name!=WS2r.Name) then begin
    WS3r.Mother = WSr.Mother;
    testf = true;
    foundf = false;
    while (LoopKey("Mother",WS3r,1,testf)) begin
      if (WS3r.Mother!=WSr.Mother) then begin
        testf = false;
      end;
      if (testf) then begin
        if (WS3r.SerNr!=WS2r.SerNr) then begin
          if (WS3r.Mother==WSr.Mother and WS3r.Name==WSr.Name) then begin
            foundf = true;
            goto LStructSearch;
          end;
        end;
      end;
    end;
    LStructSearch:;
    if (foundf) then begin
      RecordCheckError(1547,"",-1,"Name");
      res = -1;
      goto LWebNGStructVcRecordCheck;
    end;
  end;
  if (WSr.LogAccess==1 and blank(WSr.Comment)) then begin
    RecordCheckError(22905,"",-1,"Comment");
    res = -1;
    goto LWebNGStructVcRecordCheck;
  end;
LWebNGStructVcRecordCheck:;
  WebNGStructVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGContentVcRecordDefaults(var record WebNGContentVc WCr,record WebNGContentVc WC2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  if (SingleUserMode) then begin
    WCr.SerNr = NextSerNr("WebNGContentVc",CurrentDate,-1,false,"");
  end;
  WebNGContentVcRecordDefaults = res;
  return;
end;

global
function LongInt WebNGContentVcRecordDuplicate(var record WebNGContentVc WCr,record WebNGContentVc WC2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WCr.SerNr = -1;
  if (SingleUserMode) then begin
    WCr.SerNr = NextSerNr("WebNGContentVc",CurrentDate,-1,false,"");
  end;
  WebNGContentVcRecordDuplicate = res;
  return;
end;

global
function LongInt WebNGContentVcRecordCheck(var record WebNGContentVc WCr,record WebNGContentVc WC2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (WCr.SerNr<=0) then begin
    WCr.SerNr = NextSerNr("WebNGContentVc",CurrentDate,-1,false,"");
  end;
LWebNGContentVcRecordCheck:;
  WebNGContentVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGProductVcRecordCheck(var record WebNGProductVc WPr,record WebNGProductVc WP2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WPr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1;
    goto LWebNGProductVcRecordCheck;
  end;
LWebNGProductVcRecordCheck:;
  WebNGProductVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGComponentVcRecordCheck(var record WebNGComponentVc WCr,record WebNGComponentVc WC2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WCr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1;
    goto LWebNGComponentVcRecordCheck;
  end;
LWebNGComponentVcRecordCheck:;
  WebNGComponentVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGContentCatVcRecordCheck(var record WebNGContentCatVc WCCr,record WebNGContentCatVc WCC2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WCCr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1;
    goto LWebNGContentCatVc;
  end;
LWebNGContentCatVc:;
  WebNGContentCatVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGComponentCatVcRecordCheck(var record WebNGComponentCatVc WCCr,record WebNGComponentCatVc WCC2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WCCr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1;
    goto LWebNGComponentCatVcRecordCheck;
  end;
LWebNGComponentCatVcRecordCheck:;
  WebNGComponentCatVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGProductCatVcRecordCheck(var record WebNGProductCatVc WPCr,record WebNGProductCatVc WPC2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WPCr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1;
    goto LWebNGProductCatVcRecordCheck;
  end;
LWebNGProductCatVcRecordCheck:;
  WebNGProductCatVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGShopBasketVcRecordCheck(var record WebNGShopBasketVc WSBr,record WebNGShopBasketVc WSB2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (WSBr.CompanyNr<0) then begin
    RecordCheckError(1008,"",-1,"CustCode");
    res = -1;
    goto LWebNGShopBasketVcRecordCheck;
  end;
  if (WSBr.BasketNo<0) then begin
    RecordCheckError(1008,"",-1,"CustCode");
    res = -1;
    goto LWebNGShopBasketVcRecordCheck;
  end;
  
  if (blank(WSBr.SessionID)) then begin
    if (blank(WSBr.CustCode)) then begin
      RecordCheckError(1058,"",-1,"CustCode");
      res = -1;
      goto LWebNGShopBasketVcRecordCheck;
    end;
    if (WSBr.CompanyNr==0) then begin
      RecordCheckError(1058,"",-1,"CompanyNr");
      res = -1;
      goto LWebNGShopBasketVcRecordCheck;
    end;
  end else begin
    if (nonblank(WSBr.CustCode)) then begin
      RecordCheckError(2010,"",-1,"SessionID");
      res = -1;
      goto LWebNGShopBasketVcRecordCheck;      
    end;
    if (WSBr.CompanyNr!=0) then begin
      RecordCheckError(2010,"",-1,"CompanyNr");
      res = -1;
      goto LWebNGShopBasketVcRecordCheck;      
    end;
  end;
  
  SumUpShopBasket(WSBr);
  
LWebNGShopBasketVcRecordCheck:;
  WebNGShopBasketVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGTranslateVcRecordInIndex(record WebNGTranslateVc WTr,string indexname)
BEGIN
  LongInt res;
 
  res = 1; 
  if (indexname=="ElementLangCode" or indexname=="ElementLastChanged" or indexname=="ElementComment") then begin
    if (WTr.FileName!=0) then begin
      res = 0;
    end;
  end;
  if (indexname=="ContentLangCode" or indexname=="ContentLastChanged" or indexname=="ContentComment") then begin
    if (WTr.FileName!=1) then begin
      res = 0;
    end;
  end;
  if (indexname=="ProductLangCode" or indexname=="ProductLastChanged" or indexname=="ProductComment") then begin
    if (WTr.FileName!=2) then begin
      res = 0;
    end;
  end;
  if (indexname=="PageLangCode" or indexname=="PageLastChanged" or indexname=="PageComment") then begin
    if (WTr.FileName!=4) then begin
      res = 0;
    end;
  end;

  WebNGTranslateVcRecordInIndex = res;
  RETURN;
END;

function string 255 GenerateRandomHex(integer length)
begin
  string 100 ast;
  LongInt pos;
  LongInt i;
  string 255 res,tstr;
  
  res = "";
  Randomize;
  ast = "0F3481ADE786F29523AAADECCBB123456FF987C2A3B4D6DD7EE8F922F33E5"; // 61 characters
  for (i=0;i<length;i=i+1) begin
    if (mod(i,8) == 0 and i!=0) then begin
      res = res & "-";
    end;
    pos = Random(0,60);
    tstr = Mid(ast,pos,1);
    res = res & tstr;    
  end;

  GenerateRandomHex = res;
  return;
end;

function string 255 MakePaySessionUUIDString()
begin
  record WebNGPaySessionVc WPSr;
  string 255 res;
  boolean foundf;
  
  foundf = false;
  while (foundf==false) begin
    res = GenerateRandomHex(40);
    WPSr.UUID = res;
    if (ReadFirstMain(WPSr,1,true)==false) then begin
      foundf = true;
    end;
  end;
  MakePaySessionUUIDString = res;
  return;
end;

global
function LongInt WebNGPaySessionVcRecordDefaults(var record WebNGPaySessionVc WPSr,record WebNGPaySessionVc WPS2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WPSr.UUID = MakePaySessionUUIDString; //TODO: Get system to generate proper UUID
  WPSr.CreatedDate = CurrentDate;
  WPSr.CreatedTime = CurrentTime;

  WebNGPaySessionVcRecordDefaults = res;
  return;
end;

global
function LongInt WebNGPaySessionVcRecordDuplicate(var record WebNGPaySessionVc WPSr,record WebNGPaySessionVc WPS2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  WPSr.UUID = MakePaySessionUUIDString; //TODO: Get system to generate proper UUID
  WPSr.CreatedDate = CurrentDate;
  WPSr.CreatedTime = CurrentTime;

  WebNGPaySessionVcRecordDuplicate = res;
  return;
end;

global
function LongInt WebNGPaySessionVcRecordCheck(var record WebNGPaySessionVc WPSr,record WebNGPaySessionVc WPS2r,LongInt stat,LongInt long4)
begin
  LongInt res;

  res = 0;
  if (blank(WPSr.UUID)) then begin
    RecordCheckError(1058,"",-1,"UUID");      
    res = -1;
    goto LWebNGPaySessionVcRecordCheck;
  end;
  if (WPSr.AppID<=0) then begin
    RecordCheckError(1008,"",-1,"AppID");      
    res = -1;
    goto LWebNGPaySessionVcRecordCheck;
  end;
  
  WPSr.CreatedDate = WPS2r.CreatedDate;
  WPSr.CreatedTime = WPS2r.CreatedTime;

LWebNGPaySessionVcRecordCheck:;
  WebNGPaySessionVcRecordCheck = res;
  return;
end;

global
function LongInt WebNGCompCountryVcRecordCheck(var record WebNGCompCountryVc WCCr,record WebNGCompCountryVc WCC2r,LongInt stat,LongInt long4)
begin
  record WebNGCompCountryVc WCC3r;
  LongInt res;
  boolean foundf,defaultfound;
  
  res = 0;
  if (blank(WCCr.Country)) then begin
    RecordCheckError(1008,"",-1,"Country");
    res = -1;
    goto LWebNGCompCountryVcRecordCheck;
  end;
  
  if (WCCr.CountryDefault==1) then begin
    foundf = true;
    defaultfound = false;
    WCC3r.Country = WCCr.Country;
    while (LoopKey("Country",WCC3r,1,foundf)) begin
      if (WCC3r.Country!=WCCr.Country) then begin
        foundf = false;
      end;
      if (foundf) then begin
        if (WCC3r.CompanyNr!=WCCr.CompanyNr and WCC3r.CountryDefault==1) then begin
          defaultfound = true;
          foundf = false;
        end;
      end;
    end;
    if (defaultfound) then begin
      RecordCheckError(20266,"",-1,"Country");
      res = -1;
      goto LWebNGCompCountryVcRecordCheck;
    end;
  end;
  
LWebNGCompCountryVcRecordCheck:;
  WebNGCompCountryVcRecordCheck = res;
  return;
end;

function boolean PayDealIsCashType(string paydeal)
begin
  record PDVc PDr;
  boolean res;
  
  res = false;
  PDr.Code = paydeal;
  if (ReadFirstMain(PDr,1,true)) then begin
    if (PDr.PDType==2) then begin
      res = true;
    end;
  end;
  
  PayDealIsCashType = res;
  return;
end;

global
updating function LongInt WebNGShopCompBlockCheck(var record WebNGShopCompBlock WSCb,record WebNGShopCompBlock WSC2b,LongInt stat,LongInt long4)
begin
  longint res;
  res = 0;

  if (WSCb.PayTypeCreditCard==1) then begin
    if (blank(WSCb.PayDealCreditCard)) then begin
      RecordCheckError(1256,"",-1,"PayDealCreditCard");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
    if (PayDealIsCashType(WSCb.PayDealCreditCard)==false) then begin
      RecordCheckError(1958,"",-1,"PayDealCreditCard");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
  end;
  if (WSCb.PayTypeOrder==1) then begin
    if (blank(WSCb.PayDealOrder)) then begin
      RecordCheckError(1256,"",-1,"PayDealOrder");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
  end;
  if (WSCb.PayTypeInvoice==1) then begin
    if (blank(WSCb.PayDealInvoice)) then begin
      RecordCheckError(1256,"",-1,"PayDealInvoice");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
  end;
  if (WSCb.PayTypeDirectDebit==1) then begin
    if (blank(WSCb.PayDealDirectDebit)) then begin
      RecordCheckError(1256,"",-1,"PayDealDirectDebit");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
    if (PayDealIsCashType(WSCb.PayDealDirectDebit)==false) then begin
      RecordCheckError(1958,"",-1,"PayDealDirectDebit");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
  end;
  if (WSCb.PayTypePayPal==1) then begin
    if (blank(WSCb.PayDealPayPal)) then begin
      RecordCheckError(1256,"",-1,"PayDealPayPal");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
    if (PayDealIsCashType(WSCb.PayDealPayPal)==false) then begin
      RecordCheckError(1958,"",-1,"PayDealPayPal");
      res = -1;
      goto LWebNGShopCompBlockCheck;
    end;
  end;
LWebNGShopCompBlockCheck:;
  WebNGShopCompBlockCheck = res;
  return;
end;

global
function LongInt WebNGElementVcRecordCheck(var record WebNGElementVc WEr,record WebNGElementVc WE2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  
  res = 0;
  if (WEr.LogAccess==1 and blank(WEr.Comment)) then begin
    RecordCheckError(22905,"",-1,"Comment");
    res = -1;
    goto LWebNGElementVcRecordCheck;
  end;
  if (WEr.Type==kElementTypeCreateMailForm) then begin
    if (blank(WEr.HALFunc)) then begin
      RecordCheckError(1058,"",-1,"HALFunc");
      res = -1;
      goto LWebNGElementVcRecordCheck;
    end;
  end;
LWebNGElementVcRecordCheck:;
  WebNGElementVcRecordCheck = res;
  return;
end;
