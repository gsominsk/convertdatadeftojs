external procedure NextM4Number(string,var string);
external procedure NextM4Number(string,var string);
external function Boolean SerNrTestVATDeclVc(LongInt,Date,var Boolean);

global
procedure GetNextVATDeclNr(var string vatdeclnr)
begin
  record SRBlock SRb;
  record VATDeclVc VATDr;

  BlockLoad(SRb);
  NextM4Number(SRb.LastVATDeclCode,vatdeclnr);
  if (nonblank(vatdeclnr)) then begin
    VATDr.Code = vatdeclnr;
    if (ReadFirstMain(VATDr,1,true)==false) then begin
      SRb.LastVATDeclCode = vatdeclnr;
    end else begin
      if (CountRecords("VATDeclVc")==0) then begin 
        vatdeclnr = "1";
        goto LGetNextVATDeclNr;
      end;    
      VATDr.Code = "ÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖÖ";
      if (ReadLastMain(VATDr,1,false)) then begin
        NextM4Number(VATDr.Code,vatdeclnr);
      end else begin
        vatdeclnr = "1";
      end;
    end;
  end;
LGetNextVATDeclNr:;
  return;
end;

global
function LongInt VATDeclVcRecordDefaults(var record VATDeclVc VATDr,record VATDeclVc VATD2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  LongInt vatdeclnr;
  string 255 tstr;
  
  if (SingleUserMode) then begin
    GetNextVATDeclNr(tstr);
    VATDr.Code = tstr;    
    vatdeclnr = NextSerNr("VATDeclVc",VATDr.TransDate,-1,false,"");
    if (StringToLongInt(VATDr.Code)<vatdeclnr) then begin
      VATDr.Code = vatdeclnr;
    end;
  end else begin
    VATDr.Code = "";
  end;
  VATDeclVcRecordDefaults = res; 
  return;
end;

global
function LongInt VATDeclVcRecordDuplicate(var record VATDeclVc VATDr,record VATDeclVc VATD2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  LongInt vatdeclnr;
  string 255 tstr;
  
  VATDr.OKFlag = 0;
  if (SingleUserMode) then begin
    GetNextVATDeclNr(tstr);
    VATDr.Code = tstr;    
    vatdeclnr = NextSerNr("VATDeclVc",VATDr.TransDate,-1,false,"");
    if (StringToLongInt(VATDr.Code)<vatdeclnr) then begin
      VATDr.Code = vatdeclnr;
    end;
  end else begin
    VATDr.Code = "";
  end;
  VATDeclVcRecordDuplicate = res; 
  return;
end;

global
function LongInt VATDeclVcRecordCheck(record VATDeclVc VATDr,record VATDeclVc VATD2r,LongInt stat,LongInt long4)
begin
  LongInt res;
  Boolean gentrans;
  string 255 tstr;
  record PRVc lVATDr;
  LongInt vatdeclnr;
  
  res = 0;
  if (blank(VATDr.Code)) then begin
    GetNextVATDeclNr(tstr);
    lVATDr.Code = tstr;
    if (ReadFirstMain(lVATDr,1,true)) then begin
      RecordCheckError(1547,tstr,-1,"Code");      
      res = -1;
      goto LVATDeclVcRecordCheck;
    end;
    VATDr.Code = tstr;
    vatdeclnr = NextSerNr("VATDeclVc",VATDr.TransDate,-1,false,"");
    if (StringToLongInt(VATDr.Code)<vatdeclnr) then begin
      VATDr.Code = vatdeclnr;
    end;    
  end;  
  if (blank(VATDr.Code)) then begin
    RecordCheckError(1058,"",-1,"Code");      
    res = -1; 
    goto LVATDeclVcRecordCheck;
  end;
  if (SerNrTestVATDeclVc(StringToLongInt(VATDr.Code),VATDr.TransDate,gentrans)==false) then begin
    RecordCheckError(1557,"",-1,"Code");      
    res = -1; 
    goto LVATDeclVcRecordCheck;
  end;
LVATDeclVcRecordCheck:;
  VATDeclVcRecordCheck = res;
  return;
end;
