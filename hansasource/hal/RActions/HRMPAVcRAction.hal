external function Boolean IsUnOKAllowed(string,Date);

global
updating function LongInt HRMPAVcRecordCheck(record HRMPAVc HRMPAr,record HRMPAVc HRMPA2r,LongInt stat,LongInt check)
begin
  LongInt oldnr;
  LongInt res;
  record CUVc CUr;
  record HRMPFVc HRMPFr;
  record HRMPRVc HRMPRr;
  record HRMPACVc HRMPACr;
  Date td;
  row HRMPAVc HRMPArw;
  Integer i,rwcnt;
  Boolean transf,unokf;

  res = 0;
  oldnr = HRMPAr.SerNr;

  transf = false;
  if (HRMPAr.OKFlag==1) then begin
    if (stat==Rs_insert) then begin transf = true; end;
    if (stat==Rs_update) then begin
      if (HRMPA2r.OKFlag==0) then begin transf = true; end;
    end;
  end;
  if (HRMPAr.OKFlag==0) then begin//unok
    if (stat==Rs_update) then begin
      if (HRMPA2r.OKFlag==1) then begin unokf = true; end;
    end;
  end;
  if (unokf) then begin
    if (IsUnOKAllowed("HRMPAVc",HRMPAr.TransDate)==false) then begin
      RecordCheckError(1046,"",-1,"TransDate");      
      res = -1; 
    end;    
    goto LHRMPAVcRecordCheck;
  end;
  if (transf) then begin
    if (UserCanAction("HRMPAOK",true)==false) then begin
      RecordCheckError(1274,StringFromStringSet(3,"HRMPAOK"),-1,"SerNr");      
      res = -1; 
      goto LHRMPAVcRecordCheck;
    end;
  end;  

  if (HRMPAr.SerNr<=0) then begin
    HRMPAr.SerNr = NextSerNr("HRMPAVc",HRMPAr.TransDate,-1,false,"");
  end;

  HRMPACr.Code = HRMPAr.PAClass;
  if (ReadFirstMain(HRMPACr,1,true)==false) then begin
    RecordCheckError(1120,HRMPAr.PAClass,-1,"PAClass");      
    res = -1;
    goto LHRMPAVcRecordCheck;
  end;
  CUr.Code = HRMPAr.Interviewer;
  if (ReadFirstMain(CUr,1,true)==false) then begin
    RecordCheckError(1120,HRMPAr.Interviewer,-1,"Interviewer");      
    res = -1;
    goto LHRMPAVcRecordCheck;
  end;
  if (CUr.EmployeeType==0) then begin
    RecordCheckError(1120,HRMPAr.Interviewer,-1,"Interviewer");      
    res = -1; 
    goto LHRMPAVcRecordCheck;
  end;
  if (CUr.blockedFlag!=0) then begin
    RecordCheckError(1265,HRMPAr.Interviewer,-1,"Interviewer");      
    res = -1;
    goto LHRMPAVcRecordCheck;
  end;
  CUr.Code = HRMPAr.Employee;
  if (ReadFirstMain(CUr,1,true)==false) then begin
    RecordCheckError(1120,HRMPAr.Employee,-1,"Employee");      
    res = -1;
    goto LHRMPAVcRecordCheck;
  end;
  if (CUr.EmployeeType==0) then begin
    RecordCheckError(1120,HRMPAr.Employee,-1,"Employee");      
    res = -1; 
    goto LHRMPAVcRecordCheck;
  end;
  if (CUr.blockedFlag!=0) then begin
    RecordCheckError(1265,HRMPAr.Employee,-1,"Employee");      
    res = -1;
    goto LHRMPAVcRecordCheck;
  end;

  rwcnt = MatRowCnt(HRMPAr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(HRMPAr,i,HRMPArw);
    HRMPFr.Code = HRMPArw.PerfFactor;
    if (ReadFirstMain(HRMPFr,1,true)==false) then begin
      RecordCheckError(1120,HRMPArw.PerfFactor,i,"PerfFactor");      
      res = -1;
      goto LHRMPAVcRecordCheck;
    end;
    HRMPRr.Code = HRMPArw.PerfRating;
    if (ReadFirstMain(HRMPRr,1,true)==false) then begin
      RecordCheckError(1120,HRMPArw.PerfRating,i,"PerfRating");      
      res = -1;
      goto LHRMPAVcRecordCheck;
    end;
  end;
LHRMPAVcRecordCheck:;  
  if (res!=0) then begin HRMPAr.SerNr = oldnr; end;
  HRMPAVcRecordCheck = res;
  return;
end;