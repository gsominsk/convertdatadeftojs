remote updating procedure UpdateBankRecW(var record BankRecVc);
remote updating procedure UpdateObjBal(string,string,Date,val,val,string,Boolean);
remote updating procedure UpdateSubsytem(record TRVc,row TRVc);
external function Integer GetIntYc(Date);

updating procedure SetDanTRReconciled(record DanTRVc DanTRr)
begin
  integer i,rwcnt;
  row DanTRVc DanTRrw;
  LongInt sernr;
  date td;
  record TRVc oldTRr,TRr;
  row TRVc TRrw;
  
  rwcnt = MatRowCnt(DanTRr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(DanTRr,i,DanTRrw);
    if (sernr>0) then begin
      if (sernr!=DanTRrw.TransNr) then begin
        goto LSetDanTRReconciled;
      end;
    end;
    sernr = DanTRrw.TransNr;
    td = DanTRrw.RowTransDate;
  end;
  if (blankdate(td)) then begin
    td = DanTRr.TransDate;
  end;

  TRr.Number = sernr;
  TRr.IntYc = GetIntYc(td);
  if (ReadFirstMain(TRr,2,true)) then begin
    RecordCopy(oldTRr,TRr);
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      TRrw.Reconsf = 1;
      MatRowPut(TRr,i,TRrw);
      UpdateObjBal(TRrw.AccNumber,";;;",TRr.TransDate,TRrw.DebVal,TRrw.CredVal,"transdebit",false);
      UpdateObjBal(TRrw.AccNumber,";;;",TRr.TransDate,TRrw.DebVal2,TRrw.CredVal2,"transdebit2",false);
      UpdateSubsytem(TRr,TRrw);
    end;
    if (RecordUpdate(oldTRr,TRr,false)==0) then begin
    end;
  end;
LSetDanTRReconciled:;
  return;
end;

updating procedure ActivateAndRefreshAccReconWn(LongInt dantrwn)
begin
  record BankRecVc prevBankRecr;
  record BankRecVc BankRecr;
  Integer wn;
  
  wn = FindWindow("BankRecWClass");
  if (wn>0) then begin
    GetPrevWindowRecord(wn,prevBankRecr);
    GetWindowRecord(wn,BankRecr);
    UpdateBankRecW(BankRecr);
    PutWindowRecord(wn,BankRecr);
//    CloseWindow(dantrwn);
    SelectWindow(wn);
  end;
  
  return;
end;

global
updating function LongInt DanTRVcRecordSaveClient(LongInt wn,var record DanTRVc DTr,record DanTRVc DT2r,LongInt long3,LongInt long4)
begin
  if (DTr.OKFlag!=0) then begin
    SetDanTRReconciled(DTr);
    ActivateAndRefreshAccReconWn(wn);
  end;
  return;
end;

global
updating function LongInt DanTRVcRecordUpdateClient(LongInt wn,var record DanTRVc DTr,record DanTRVc DT2r,LongInt long3,LongInt long4)
begin
  if (DTr.OKFlag!=0 and DT2r.OKFlag==0) then begin
    SetDanTRReconciled(DTr);
    ActivateAndRefreshAccReconWn(wn);
  end;
  return;
end;