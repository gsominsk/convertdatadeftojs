external function Integer CountObjects(string);

procedure ExportEVENTCREATE(LongInt sernr)
BEGIN
  string 255 tstr;
  
  ExportPadString("/EVENT, CREATE",14," ",false);
  NewLine;
  ExportPadString("EventId = ",10," ",false);
  ExportPadString("3011 ",4,"0",false);
  NewLine;    
  ExportPadString("DocNo = ",8," ",false);
  tstr = sernr;
  ExportPadString(tstr,10,"0",true);
  NewLine;    
  ExportPadString("MessageType = ",14," ",false);
  ExportPadString("INVOIC",6," ",false);
  NewLine;    
  ExportPadString("/END",4," ",false);
  NewLine;      
  NewLine;      
  RETURN;
END;

procedure ExportCYNameAndOrgNr2(record CYBlock CYRec)
BEGIN  
  ExportPadString("AddressCode = ",14," ",false);
  ExportPadString(CYRec.ANACode,len(CYRec.ANACode)," ",false);
  NewLine;
  ExportPadString("GovRefNo = ",11," ",false);
  ExportPadString(CYRec.VATNr,len(CYRec.VATNr)," ",false);
  RETURN;
END;

procedure ExportINVOICLN(LongInt sernr,string artcode,Integer linenr,string spec,val qty,val sum)
BEGIN
  string 255 tstr;
  record INVc INr;
  record UnitVc Unitr;

  ExportPadString("/INVOICLN, INSERT",17," ",false);
  NewLine;    
  ExportPadString("DocNo = ",8," ",false);
  tstr = sernr;
  ExportPadString(tstr,10,"0",true);
  NewLine;    
  ExportPadString("LineNo = ",9," ",false);
  tstr = linenr;
  ExportPadString(tstr,4,"0",true);
  NewLine;    
  ExportPadString("ItemDescType = ",15," ",false);
  ExportPadString("F",1," ",false);
  NewLine;    
  ExportPadString("ItemDesc = ",11," ",false);
  ExportPadString(spec,34," ",false);
  NewLine;    
/*
  INr.Code = artcode;
  if (ReadFirstMain(INr,1,true)) then begin
    tstr = INr.Unittext;
//    Unitr.Code = INr.Unittext;
//    if (ReadFirstMain(Unitr,1,true)) then begin
//    end;    
  end else begin
    tstr = "";
  end;
*/
  tstr = "PCE";
  ExportPadString("QuantityMeasUnit = ",19," ",false);
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("InvoicedQuantity = ",19," ",false);
  tstr = qty;
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("LineItemAmount = ",17," ",false);
  tstr = sum;
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("/END",4," ",false);
  NewLine;    
  NewLine;
  RETURN;
END;

procedure GetVATprc(string vatcode,var val resp)
BEGIN
  record VATCodeBlock VATRec;
  row VATCodeBlock VATrw;
  Integer i,rwcnt;
  
  BlockLoad(VATRec);
  rwcnt = MatRowCnt(VATRec);
  for (i=i;i<rwcnt;i=i+1) begin
    MatRowGet(VATRec,i,VATrw);
    if (vatcode==VATrw.VATCode) then begin
      resp = VATrw.ExVatpr;
      if (resp==0)  then begin
        resp = VATrw.ExVatpr;
      end;  
      i = rwcnt;
    end;
  end;
  RETURN;
END;

procedure ExportCUData(record CUVc CUr)
BEGIN
  val vatprc;
  string 255 tstr;
  Integer jj;

  ExportPadString("VatRate = ",10," ",false);
  GetVATprc(CUr.VATCode,vatprc);
  jj = CountObjects(vatprc);  
  tstr = vatprc;
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  NewLine;
  RETURN;
END;

procedure ExportINVOICHDbegin(record CUVc CUr,record EDIIVVc IVr,record CYBlock CYRec)
BEGIN
  string 255 tstr;  
  
  ExportPadString("/INVOICHD, INSERT",17," ",false);
  NewLine;    
  ExportPadString("DocNo = ",8," ",false);
  tstr = IVr.SerNr;
  ExportPadString(tstr,10,"0",true);
  NewLine;    
  ExportPadString("ShortCode = ",12," ",false);
  ExportPadString("NFAB",4," ",false);
  NewLine;    
  ExportPadString("DocType = ",10," ",false);
  tstr = "380";
  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin
    tstr = "381";
  end;
  ExportPadString(tstr,3," ",false);
  NewLine;    
  ExportPadString("DocDate = ",12," ",false);
  tstr = DateToString(IVr.InvDate,"YYYYMMDD");  
  ExportPadString(tstr,8," ",false);
  NewLine;
  ExportPadString("SpecialCondition = ",19," ",false);
  ExportPadString("Z01",3," ",false);
  NewLine;
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "VR FORDRAN ENLIGT DENNA FAKTURA HAR …VERLTITS TILL NORDBANKEN FINANS";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString(CUr.RegNr1,len(CUr.RegNr1)," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = " AB (PUBL), 103 82 STOCKHOLM. BETALNING MED BEFRIANDE VERKAN KAN ENDAS";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "T SKE TILL NORDBANKEN FINANS AB (PUBL). LIKVIDEN ERL€GGES GENOM INS€TT";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "NING P NORDBANKEN FINANS ABs (PUBL) BANKGIRONUMMER 5823-2257 ELLER PO";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "STGIRO 6402305-4. VAR GOD ANGIV D€RVID HELA FAKTURANUMRET. INV€NDNING";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "AR MOT DENNA FAKTURA SKA OMEDELBART MEDDELAS NORDBANKEN FINANS AB (PUB";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("FreeTextAgency = ",17," ",false);
  ExportPadString("",0," ",false);
  NewLine;    
  ExportPadString("GeneralText = ",14," ",false);
  tstr = "L), KUNDSERVICE, 103 82 STOCKHOLM, TFN 08-787 65 00.";
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("AddressCode = ",14," ",false);
  ExportPadString("BY" & CUr.Code,len(CUr.Code) + 2," ",false);
  NewLine;    
  ExportPadString("GovRefNo = ",11," ",false);
  tstr = CUr.VATNr;
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  NewLine;  
  ExportCYNameAndOrgNr2(CYRec);  
  NewLine;    
  NewLine;  
  ExportPadString("DTFCategory = ",14," ",false);
  tstr = "";
  ExportPadString("S",1," ",false);
  NewLine;    
  ExportCUData(CUr);
  
  ExportPadString("RefInvoicingCurr = ",19," ",false);
  ExportPadString(IVr.CurncyCode,len(IVr.CurncyCode)," ",false);
  NewLine;    
  ExportPadString("PayTermsType = ",15," ",false);
  ExportPadString("3",1," ",false);
  NewLine;    
  ExportPadString("PayRefDateCode = ",17," ",false);
  ExportPadString("6",1," ",false);
  NewLine;    
  ExportPadString("NetDueDate = ",17," ",false);
  tstr = DateToString(IVr.PayDate,"YYYYMMDD");    
  ExportPadString(tstr,8," ",false);
  NewLine;    
  ExportPadString("TotTaxableAmount = ",17," ",false);
  tstr = IVr.Sum1;    
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;    
  ExportPadString("MessTotDtfAmount = ",17," ",false);
  tstr = IVr.Sum3;    
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;
  ExportPadString("MessTotAmount = ",17," ",false);
  tstr = IVr.Sum4;
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;
  ExportPadString("/END",4," ",false);
  NewLine;
  NewLine;
  RETURN;
END;

procedure ExportINVOICHDend(LongInt sernr,Integer rwcnt)
BEGIN
  string 255 tstr;
  
  ExportPadString("/INVOICHD, UPDATE",17," ",false);
  NewLine;
  ExportPadString("DocNo = ",8," ",false);
  tstr = sernr;
  ExportPadString(tstr,10,"0",true);
  NewLine;
  ExportPadString("NoOfLineItems = ",16," ",false);
  tstr = rwcnt;
  ExportPadString(tstr,4,"0",true);
  NewLine;
  ExportPadString("/END",4," ",false);
  NewLine;
  NewLine;
  RETURN;
END;

procedure GetCoutryDesc(string countrycode,var string resp)
BEGIN
  record CountryVc Countryr;
  
  resp = "";
  Countryr.Code = countrycode;
  if (ReadFirstMain(Countryr,1,true)) then begin
    resp = Countryr.Comment;
  end;
  RETURN;
END;

procedure ExportGEOADDRStaticInfo()
BEGIN
  ExportPadString("/GEOADDR, UPDATE",16," ",false);
  NewLine;  
  ExportPadString("AddressCode = ",14," ",false);
  ExportPadString("PE556021-1475",13," ",false);
  NewLine;
  ExportPadString("PartyType = ",12," ",false);
  ExportPadString("PE",2," ",false);
  NewLine;
  ExportPadString("PartyIdCode = ",14," ",false);
  ExportPadString("556021-1475",11," ",false);
  NewLine;
  ExportPadString("/END",4," ",false);
  NewLine;
  NewLine;    
  RETURN;
END;

procedure CYExportGEOADDR(record CYBlock CYRec)
BEGIN
  string 255 tstr;
  
  ExportPadString("/GEOADDR, UPDATE",16," ",false);
  NewLine;  
  ExportPadString("AddressCode = ",14," ",false);
  ExportPadString("II" & CYRec.ANACode,len(CYRec.ANACode) + 2," ",false);
  NewLine;
  ExportPadString("PartyType = ",12," ",false);
  ExportPadString("II",2," ",false);
  NewLine;
  ExportPadString("PartyIdCode = ",14," ",false);
  ExportPadString(CYRec.ANACode,len(CYRec.ANACode)," ",false);
  NewLine;
  ExportPadString("PartyName = ",12," ",false);
  ExportPadString(CYRec.CompName,len(CYRec.CompName)," ",false);
  NewLine;
  ExportPadString("StreetName = ",13," ",false);
  ExportPadString(CYRec.Addr0,len(CYRec.Addr0)," ",false);
  NewLine;
  ExportPadString("CityName = ",11," ",false);
  tstr = ConvertSpecStr(CYRec.Addr1,"POSTALCODE");
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;
  ExportPadString("PostCode = ",11," ",false);
  tstr = ConvertSpecStr(CYRec.Addr1,"CITY");
  ExportPadString(tstr,len(tstr)," ",false);
  NewLine;
  ExportPadString("/END",4," ",false);
  NewLine;
  NewLine;    
  RETURN;
END;

procedure ExportGEOADDR(record CUVc CUr,record EDIIVVc IVr)
BEGIN
  string 255 tstr;
  
  ExportPadString("/GEOADDR, UPDATE",16," ",false);
  NewLine;  
  ExportPadString("AddressCode = ",14," ",false);
  ExportPadString("BY" & IVr.CustCode,len(IVr.CustCode) + 2," ",false);
  NewLine;
  ExportPadString("PartyType = ",12," ",false);
  ExportPadString("BY",2," ",false);
  NewLine;
  ExportPadString("PartyIdCode = ",14," ",false);
  ExportPadString(IVr.CustCode,len(IVr.CustCode)," ",false);
//  ExportPadString(CUr.ANACode,len(CUr.ANACode)," ",false);
  NewLine;
  ExportPadString("PartyName = ",12," ",false);
  ExportPadString(IVr.Addr0,len(IVr.Addr0)," ",false);
  NewLine;
  ExportPadString("StreetName = ",13," ",false);
  ExportPadString(IVr.Addr1,len(IVr.Addr1)," ",false);
  NewLine;
  if (IVr.ExportFlag==0) then begin
    ExportPadString("CityName = ",11," ",false);
    tstr = ConvertSpecStr(IVr.Addr2,"CITY");
    ExportPadString(tstr,len(tstr)," ",false);
    NewLine;
    ExportPadString("PostCode = ",11," ",false);
    tstr = ConvertSpecStr(IVr.Addr2,"POSTALCODE");
    ExportPadString(tstr,len(tstr)," ",false);
    NewLine;
  end else begin
    ExportPadString("CityName = ",11," ",false);
    GetCoutryDesc(CUr.CountryCode,tstr);
    ExportPadString(tstr,len(tstr)," ",false);
    NewLine;
    ExportPadString("PostCode = ",11," ",false);
    ExportPadString("",0," ",false);
    NewLine;
    ExportPadString("CoutryCode = ",13," ",false);
    ExportPadString(CUr.CountryCode,len(CUr.CountryCode)," ",false);
    NewLine;
  end; 
  ExportPadString("/END",4," ",false);
  NewLine;
  NewLine;
  RETURN;
END;

global
procedure EDIStrEn(record RcVc RepSpec)
BEGIN
  record CYBlock CYRec;
  record EDIIVVc IVr;
  record CUVc CUr;  
  row EDIIVVc IVrw;
  Integer i,rwcnt; 
  string 20 frcu,tocu;
  LongInt friv,toiv;
  Boolean TrHs,testf;
  LongInt ivcnt;
  
  BlockLoad(CYRec);
  ivcnt = 0;
  friv = FirstInRange(RepSpec.f1,10);
  toiv = LastInRange(RepSpec.f1,10);
  frcu = FirstInRange(RepSpec.f2,20);
  tocu = LastInRange(RepSpec.f2,20);
  TrHs = true;
  IVr.SerNr = friv;
  while (LoopMain(IVr,1,TrHs)) begin
    if (nonblank(RepSpec.f1)) then begin
      if (IVr.SerNr>toiv) then begin TrHs = false; end;
    end;  
    if (TrHs) then begin
      testf = true;
      if (nonblank(RepSpec.f2)) then begin
        if (IVr.CustCode<frcu) then begin testf = false; end;
        if (IVr.CustCode>tocu) then begin testf = false; end;
      end;
      if (RepSpec.flags[1]==0) then begin
        if (IVr.ExportedFlag!=0) then begin testf = false; end;
      end;
      CUr.Code = IVr.CustCode;
      if (ReadFirstMain(CUr,1,true)==false) then begin 
        testf = false;
      end else begin
        if (CUr.EDIFlag==0) then begin testf = false; end;
      end;
      if (testf) then begin
        ivcnt = ivcnt + 1;
        
        ExportGEOADDR(CUr,IVr);
        CYExportGEOADDR(CYRec);
        ExportGEOADDRStaticInfo;
        ExportINVOICHDbegin(CUr,IVr,CYRec);
        rwcnt = MatRowCnt(IVr); 
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVr,i,IVrw);
          ExportINVOICLN(IVr.SerNr,IVrw.ArtCode,i+1,IVrw.Spec,IVrw.Quant,IVrw.Sum);          
        end;
        ExportINVOICHDend(IVr.SerNr,rwcnt);
        ExportEVENTCREATE(IVr.SerNr);          
      end;  
    end;  
  end;
  RETURN;
END;
