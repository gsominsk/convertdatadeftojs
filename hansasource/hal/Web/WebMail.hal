external procedure ToolWebOutMailText(record MailVc,string);
external procedure FindUserMailboxName(string,var string,var string);
external procedure ToolWebLineStart();
external procedure ToolWebLineEnd();
external procedure ToolWebMailList(string,string,string,string,LongInt,Integer);
external function Boolean LoggedInTest();
external procedure WebStartNavBar();
external procedure WebEndNavBar();
external procedure ToolWebHiddenField(string,string);
external procedure WebEditField(string,string,string,string,Integer,Integer);
external procedure WebTextArea(string,record MailVc,string,Integer,Integer);
external procedure WebNavLink(string,string,string,string);
external procedure ToolWebSetMainTitle();
external procedure ToolWebStartPage();
external procedure ToolWebStartBody(string);
external procedure ToolWebEndPage(Boolean);
external procedure ToolWebStartHeader();
external procedure ToolWebListTable(Integer,Integer,string);
external procedure ToolWebListTableEnd();
external procedure ToolWebTableHdr(string,string,string);
external procedure ToolWebStartHeaderEnd();
external procedure WebLeadText(string,string);
external procedure WebLeadText2(string,string);
external procedure ToolWebOutHeader(string);
external procedure WebNavBar(string,Boolean,Boolean,LongInt,LongInt,string,string);
external procedure ToolWebConfList(string,LongInt,Integer);
external procedure WebNavBar2(string,Boolean,Boolean,LongInt,LongInt,LongInt,string,string,LongInt,Integer);
external procedure ToolWebPushButton(string,string,string);

global
procedure GetConfCode(string confname,var string confcode)
begin
  record ConfVc Confr;
  
  Confr.AddrName = confname;
  if (ReadFirstKey("AddrName",Confr,1,true)) then begin
    confcode = Confr.SerNr;
  end else begin
    confcode = "";
  end;
  return;
end;

global
procedure GetConfName(string confcode,var string confname)
begin
  record ConfVc Confr;
  
  Confr.SerNr = confcode;
  if (ReadFirstMain(Confr,1,true)) then begin
    confname = Confr.AddrName;
  end else begin
    confname = "";
  end;
  return;
end;

/*
global
procedure FindUserInMailbox(string name,var string mailboxcode)
begin
  record ConfVc Confr;

  Confr.AddrName = name;
  if (ReadFirstKey("AddrName",Confr,1,true)) then begin
    mailboxcode = Confr.SerNr;
  end;
  return;
end;
*/

global
function Integer FirstToRow(record MailVc Mailr,var string torow) 
begin
  row MailVc marw;
  Integer rwcnt;
  Integer i;
  Integer res;

  res = -1;
  torow = "";
  rwcnt = MatRowCnt(Mailr);
  if (rwcnt>0) then begin
    MatRowGet(Mailr,0,marw);
    res = 1;
    torow = marw.AddrCode;
    for (i=1;i<rwcnt;i=i+1) begin
      MatRowGet(Mailr,i,marw);
      if (marw.RowTyp==0) then begin
        torow = marw.AddrCode;
        res = 0;
        i = rwcnt;
      end;
    end;
  end;
  FirstToRow = res;
  return;
end;

global
function Integer FirstLocalToRow(record LocalMailVc LocalMailr,var string torow) 
begin
  row LocalMailVc marw;
  Integer rwcnt;
  Integer i;
  Integer res;

  res = -1;
  torow = "";
  rwcnt = MatRowCnt(LocalMailr);
  if (rwcnt>0) then begin
    MatRowGet(LocalMailr,0,marw);
    res = 1;
    torow = marw.AddrCode;
    for (i=1;i<rwcnt;i=i+1) begin
      MatRowGet(LocalMailr,i,marw);
      if (marw.RowTyp==0) then begin
        torow = marw.AddrCode;
        res = 0;
        i = rwcnt;
      end;
    end;
  end;
  FirstLocalToRow = res;
  return;
end;

/*
global
procedure FirstFromRow(record MailVc Mailr,var string torow) 
begin
  row MailVc marw;
  Integer rwcnt;
  Integer i;

  torow = "";
  rwcnt = MatRowCnt(Mailr);
  if (rwcnt>0) then begin
    MatRowGet(Mailr,0,marw);
    torow = marw.AddrCode;
    for (i=1;i<rwcnt;i=i+1) begin
      MatRowGet(Mailr,i,marw);
      if (marw.RowTyp==1) then begin
        torow = marw.AddrCode;
        i = rwcnt;
      end;
    end;
  end;
  return;
end;
*/

global
procedure WebPublicMailView(record MailVc Mailr,Boolean onlytextfield)
begin
  if (onlytextfield==false) then begin
    WebOutString("<table width=100% cellspacing=0 cellpadding=1>");  
    ToolWebLineStart;
    WebOutString("<td width=75% bgcolor=#CCCCFF><font face=Verdana color=""#000099""><strong><small><small>");
    WebOutString(Mailr.Header); 
    WebOutString("</td>");
    WebOutString("<td width=25% bgcolor=#CCCCFF><font face=Verdana color=""#000099""><strong><small><small>");
    WebOutString(Mailr.TransDate); 
    WebOutString("</td>");
    ToolWebLineEnd;
    WebOutNL;
    ToolWebLineStart;
    WebOutString(" <td valaign=""top"" align==""left"" width=100% colspan=2 bordercolor=#FFFFFF bgcolor=#FFFFFF>");
    WebOutString("<font color=""#000099"" face=Verdana><small><small>");
    ToolWebOutMailText(Mailr,"");
    WebOutString("</td></tr>");
    WebOutString("</table>");
  end else begin
    ToolWebOutMailText(Mailr,"");
  end;
  WebOutNL;
  return;
end;

procedure SetFromToField(record MailVc Mailr,var record MailVc Mail2r,Boolean mailexists,Integer rowtyp)
begin
  row MailVc marw;
  string 255 therow;
  Integer rwcnt,i;
  string 60 mailboxcode;
  string 60 mailboxname;
  string 60 confcode;
  string 200 confname;

  RecordNew(Mail2r);
  if (mailexists) then begin
    therow = "";
    rwcnt = MatRowCnt(Mailr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(Mailr,i,marw);
      if (marw.RowTyp==rowtyp) then begin
        if (nonblank(therow)) then begin
          AddToText(therow,Mail2r);
          AddToText(",",Mail2r);
        end;
        therow = marw.AddrCode;
      end;
    end;
    if (nonblank(therow)) then begin
      AddToText(therow,Mail2r);
    end;
  end else begin
    confcode = WebGetArg("confcode");
    FindUserMailboxName(CurrentUser,mailboxcode,mailboxname);
    if (rowtyp==0) then begin
      GetConfName(confcode,confname);
      if (confname<>mailboxname) then begin
        AddToText(confname,Mail2r);
      end;
    end;
    if (rowtyp==1) then begin
      AddToText(mailboxname,Mail2r);
    end;
  end;
  return;
end;

global
updating procedure WebMailView()
begin
  record MailVc Mailr;
  record MailVc Mail2r;
  LongInt wmailnumber;
  string 60 confcode;
  Boolean mailexists;

  if (LoggedInTest()) then begin
  wmailnumber = WebGetArg("mailnumber");
  confcode = WebGetArg("confcode");
  Mailr.SerNr = wmailnumber;
  if (ReadFirstMain(Mailr,1,true)==false) then begin
    mailexists = false;
    Mailr.TransDate = CurrentDate;
    Mailr.Header = "";
  end else begin
    mailexists = true;
    SetReadFlag(Mailr,0,"");
  end;

  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("to_field");
  ToolWebStartHeader;
  if (wmailnumber>0) then begin
    ToolWebOutHeader("Inspect/Edit Mail");
  end else begin
    ToolWebOutHeader("New Mail");
  end;
  ToolWebStartHeaderEnd;
  WebStartNavBar;
  WebNavLink("Back",WebGetArg("backpage"),"sernr=" & WebGetArg("backnr") & "&confcode=" & confcode,"");
  WebEndNavBar;
  WebOutNL;
  if (Mailr.LockedFlag==0) then begin
    WebOutString("<form name=""HansaForm"" method=""POST"" action=""");
  end else begin
    WebOutString("<form name=""HansaForm"" method="""" action=""");
  end;
  WebOutLink("/WebMailSend.hal?sessionid=" & WebGetArg("sessionid") & "&sernr=" & WebGetArg("sernr") & "&mailnumber=" & wmailnumber);
  WebOutString(""">");
  WebOutNL;
  WebOutString("<table border=0 width=""100%"" cellspacing=0 cellpadding=1>");
  ToolWebHiddenField("backpage",WebGetArg("backpage"));
  ToolWebHiddenField("confcode",WebGetArg("confcode"));
  ToolWebLineStart;
  WebLeadText2("From:","10%");
  ToolWebLineEnd;
  ToolWebLineStart;
  SetFromToField(Mailr,Mail2r,mailexists,1);
  WebTextArea("from_field",Mail2r,"100%",1,80);//it was "2" rows before
  ToolWebLineEnd;
  ToolWebLineStart;
  WebLeadText2("Date:","10%");
  ToolWebLineEnd;
  ToolWebLineStart;
  WebEditField("date_field","text",Mailr.TransDate,"90%",15,10);
  ToolWebLineEnd;
  ToolWebLineStart;
  WebLeadText2("To:","10%");
  SetFromToField(Mailr,Mail2r,mailexists,0);
  ToolWebLineEnd;
  ToolWebLineStart;
  WebTextArea("to_field",Mail2r,"90%",1,80);
  ToolWebLineEnd;
  ToolWebLineStart;
  WebLeadText2("CC:","10%");
  ToolWebLineEnd;
  ToolWebLineStart;
  SetFromToField(Mailr,Mail2r,mailexists,3);
  WebTextArea("cc_field",Mail2r,"90%",1,80);
  ToolWebLineEnd;
  ToolWebLineStart;
  WebLeadText2("Subject:","10%");
  ToolWebLineEnd;
  ToolWebLineStart;
  RecordNew(Mail2r);
  AddToText(Mailr.Header,Mail2r);
  WebTextArea("subject_field",Mail2r,"90%",1,80);
  ToolWebLineEnd;
  ToolWebLineStart;
//  WebLeadText2("","10%");
  WebTextArea("mail_body",Mailr,"90%",10,80);
  ToolWebLineEnd;
  ToolWebLineStart;
//  WebLeadText2("","10%");
  if (Mailr.LockedFlag==0) then begin
    WebOutString("<td width=""90%"" align=""left"" valign=""top""><input type=""submit"" value=""Save"" name=""b1""></td>");
  end else begin
    WebOutString("<td width=""90%"" align=""left"" valign=""top""></td>");
  end;
  ToolWebLineEnd;
  WebOutString("</table>");
  WebOutString("</form>");
  ToolWebEndPage(true);
  end;
  return;
end;

global
procedure WebMailBrowse()
begin
  string 60 mailboxcode;
  string 60 mailboxname;
  record CYBlock CYr;
  Integer showmax;
  LongInt msernr;  
  record WebControlBlock WCr;
  string 60 ckey;
  LongInt prevval,nextval;
  LongInt maxval,pages;
  Boolean prevf,nextf;

  if (LoggedInTest()) then begin
  BlockLoad(WCr);
  BlockLoad(CYr);
  FindUserMailboxName(CurrentUser,mailboxcode,mailboxname);
  msernr = WebGetArg("sernr");
  if (msernr==-1) then begin msernr = 0; end;
  showmax = 10;
  if (WCr.MatLines>0) then begin
    showmax = WCr.MatLines;
  end;
  ckey = "UserSer:" & mailboxcode;
  
  prevf = true;
  nextf = true;
  prevval = msernr-showmax;
  if (prevval<0) then begin 
    prevval = 0;
    prevf = false;
  end;
  nextval = msernr+showmax;
  maxval = RecordsInIndex("MailVc",ckey);
  if (nextval>maxval) then begin
    nextval = msernr;
    nextf = false;
  end;
  pages=maxval/showmax;
  if ((pages*showmax)!=maxval) then begin
    pages=pages+1;
  end; 

  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("");
  ToolWebStartHeader;
  ToolWebOutHeader("Mailbox: " & mailboxname);
  ToolWebStartHeaderEnd;

//  WebNavBar("WebMailBrowse.hal",prevf,nextf,nextval,prevval,"","");
  WebNavBar2("WebMailBrowse.hal",prevf,nextf,nextval,prevval,msernr,"","",pages,showmax);

  ToolWebListTable(5,0,"0");
  ToolWebLineStart;
  ToolWebTableHdr("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;","left","53");
  ToolWebTableHdr("Subject","left","268");
  ToolWebTableHdr("Address","left","154");
  ToolWebTableHdr("Date/Time","left","138");
  ToolWebLineEnd;
  ToolWebMailList(mailboxcode,mailboxcode,mailboxname,"WebMailBrowse.hal",msernr,showmax);
  ToolWebListTableEnd;
  ToolWebEndPage(true);
  end;
  return;
end;

global
procedure WebPublicConf(string confname,LongInt maxmail,Boolean onlytextfield)
begin
  record MailVc Mailr;
  string 60 ckey;
  LongInt loopcnt;
  LongInt looppos;
  Boolean found;
  string 60 confcode;

  loopcnt = 0;
  GetConfCode(confname,confcode);
  ckey = "UserTime:" & confcode;
  looppos = RecordsInIndex("MailVc",ckey)+1;
  SetLoopPosition(Mailr,looppos);
  found = true;
  while (LoopBackKey(ckey,Mailr,1,found)) begin
    if (found) then begin
      loopcnt = loopcnt + 1;
      if (maxmail>-1) then begin
        if (loopcnt>maxmail) then begin
          found = false;
        end;
      end;
      if (found) then begin
        WebPublicMailView(Mailr,onlytextfield);
      end;
    end;
  end;
  return;
end;

global
procedure WebPublicConf2(string thecode,Boolean onlytextfield)
begin
  record MailVc Mailr;
//  record WebConferenceBlock WCfr;
//  row WebConferenceBlock WCfrw;
  string 60 ckey;
  string 60 confname;
  string 60 confcode;
  LongInt loopcnt,looppos,maxmail;
  Integer i,rwcnt;
  Boolean found;
  record ConfAliasVc CFr;

  loopcnt = 0;
/*
  BlockLoad(WCfr);
  rwcnt = MatRowCnt(WCfr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(WCfr,i,WCfrw);
    if (WCfrw.Code==thecode) then begin
      confname = WCfrw.WebConf;
      maxmail = WCfrw.MailQty;
      i = rwcnt;
    end;
  end;
*/
  CFr.Code = thecode;
  if (ReadFirstMain(CFr,1,true)) then begin
    confname = CFr.WebConf;
    maxmail = CFr.MailQty;
  end;
  GetConfCode(confname,confcode);
  ckey = "UserTime:" & confcode;
  looppos = RecordsInIndex("MailVc",ckey)+1;
  SetLoopPosition(Mailr,looppos);
  found = true;
  while (LoopBackKey(ckey,Mailr,1,found)) begin
    if (found) then begin
      loopcnt = loopcnt + 1;
      if (maxmail>-1) then begin
        if (loopcnt>maxmail) then begin
          found = false;
        end;
      end;
      if (found) then begin
        WebPublicMailView(Mailr,onlytextfield);
      end;
    end;
  end;
  return;
end;

global
procedure WebConf2Browse()
begin
  string 60 mailboxcode;
  string 60 mailboxname;
  LongInt msernr;
  Integer showmax;
  string 60 confcode;
  string 255 confname;
  record WebControlBlock WCr;
  string 60 ckey;
  LongInt prevval,nextval;
  LongInt maxval,pages;
  Boolean prevf,nextf;

  if (LoggedInTest()) then begin
  BlockLoad(WCr);
  FindUserMailboxName(CurrentUser,mailboxcode,mailboxname);
  msernr = WebGetArg("sernr");
  if (msernr==-1) then begin msernr = 0; end;
  confcode = WebGetArg("confcode");
  if (blank(confcode)) then begin confcode = "0"; end;
  GetConfName(confcode,confname);
  showmax = 10;
  if (WCr.MatLines>0) then begin
    showmax = WCr.MatLines;
  end;
  ckey = "UserSer:" & confcode;
  
  prevf = true;
  nextf = true;
  prevval = msernr-showmax;
  if (prevval<0) then begin 
    prevval = 0;
    prevf = false;
  end;
  nextval = msernr+showmax;
  maxval = RecordsInIndex("MailVc",ckey);
  if (nextval>maxval) then begin
    nextval = msernr;
    nextf = false;
  end;
  pages=maxval/showmax;
  if ((pages*showmax)!=maxval) then begin
    pages=pages+1;
  end; 

  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("");
  ToolWebStartHeader;
  ToolWebOutHeader("Conference: " & confname);
  ToolWebStartHeaderEnd;

//  WebNavBar("WebConf2Browse.hal",prevf,nextf,nextval,prevval,"",confcode);
  WebNavBar2("WebConf2Browse.hal",prevf,nextf,nextval,prevval,msernr,"",confcode,pages,showmax);

  ToolWebListTable(5,0,"0");
//  ToolWebListTable(5,750,"0");
  ToolWebLineStart;
  ToolWebTableHdr("Status","left","53");
  ToolWebTableHdr("Subject","left","268");
  ToolWebTableHdr("Address","left","154");
  ToolWebTableHdr("Date/Time","left","138");
  ToolWebLineEnd;
  ToolWebMailList(confcode,mailboxcode,confname,"WebConf2Browse.hal",msernr,showmax);
  ToolWebListTableEnd;
  ToolWebEndPage(true);
  end;
  return;
end;

global
procedure WebConfBrowse()
begin
  LongInt msernr;
  Integer showmax;
  string 60 confcode;
  string 255 confname;
  record WebControlBlock WCr;
  string 60 ckey;
  LongInt prevval,nextval;
  LongInt maxval,pages;
  Boolean prevf,nextf;

  if (LoggedInTest()) then begin
  BlockLoad(WCr);
  msernr = WebGetArg("sernr");
  if (msernr==-1) then begin msernr = 0; end;
  confcode = WebGetArg("confcode");
  if (blank(confcode)) then begin confcode = "0"; end;
  GetConfName(confcode,confname);
  showmax = 10;
  if (WCr.MatLines>0) then begin
    showmax = WCr.MatLines;
  end;
  ckey = "SubConfAddrName:" & confcode;
  
  prevf = true;
  nextf = true;
  prevval = msernr-showmax;
  if (prevval<0) then begin 
    prevval = 0;
    prevf = false;
  end;
  nextval = msernr+showmax;
  maxval = RecordsInIndex("ConfVc",ckey);
  if (nextval>maxval) then begin
    nextval = msernr;
    nextf = false;
  end;
  pages=maxval/showmax;
  if ((pages*showmax)!=maxval) then begin
    pages=pages+1;
  end; 

  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("");
  ToolWebStartHeader;
  if (nonblank(confname)) then begin
    ToolWebOutHeader("Conferences: " & confname);
  end else begin
    ToolWebOutHeader("Main Conferences");
  end;
  ToolWebStartHeaderEnd;
//  WebNavBar("WebConfBrowse.hal",prevf,nextf,nextval,prevval,"",confcode);
  WebNavBar2("WebConfBrowse.hal",prevf,nextf,nextval,prevval,msernr,"",confcode,pages,showmax);
  ToolWebListTable(2,0,"0");
//  ToolWebListTable(2,750,"0");
  ToolWebLineStart;
  ToolWebTableHdr("Name","left","300");
  ToolWebTableHdr("Comment","left","300");
  ToolWebLineEnd;
  ToolWebConfList(confcode,msernr,showmax);
  ToolWebListTableEnd;
  ToolWebEndPage(true);
  end;
  return;
end;
