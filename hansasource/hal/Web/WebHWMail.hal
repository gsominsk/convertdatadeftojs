external updating procedure IVCreateHtmlFile(record IVVc,record MailVc,Boolean);
external updating procedure ORCreateHtmlFile(record ORVc,record MailVc);
external procedure ORMultiLineText(record ORVc,record INVc,string,Integer);
external procedure GetPayDealText(string,string,var string);

global
updating function Integer CreateMailFromWebIV(LongInt invno,var string warning)
BEGIN
  Integer res;
  record LTxtVc LTxtr;
  record CUVc CUr;
  record ContactVc CCr;
  record IVVc IVr;
  row IVVc IVrw;
  row MailVc MArw;
  Integer i,rwcnt;
  string 255 mailboxnr,tstr;
  string 1 TAB;
  record MailSettingsBlock MSb;
  record WebRegMailBlock WRMb;
  record MailVc Mailr;
  
  BlockLoad(MSb);  
  BlockLoad(WRMb);  
  res = 0;
  if (WRMb.IVMail==0) then begin
    goto LCreateMailFromWebIV;
  end;
  RecordNew(Mailr);
  IVr.SerNr = invno;
  if (ReadFirstMain(IVr,1,true)==false) then begin 
    res = 2289;
    goto LCreateMailFromWebIV;
  end;  
  TAB = chr(9);
 // FindUserMailboxName(CurrentUser,mailboxnr,tstr);
  tstr = MSb.Admin;
  if (blank(tstr)) then begin
    res = 2289;
    warning = CurrentUser;
    goto LCreateMailFromWebIV;
  end;  
  Mailr.SendFlag = 1;
  MArw.RowTyp = 1;
  MArw.AddrCode = tstr;
  MatRowPut(Mailr,0,MArw);
  CUr.Code = IVr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin end;
  MArw.RowTyp = 0;
  MArw.AddrCode = CUr.eMail;
  if (nonblank(IVr.ClientContact)) then begin
    CCr.Company = CUr.Code;
    CCr.Name = IVr.ClientContact;
    if (ReadFirstMain(CCr,2,true)) then begin
      if (nonblank(CCr.Email)) then begin
        MArw.AddrCode = CCr.Email;
      end;
    end;
  end;
  if (blank(MArw.AddrCode)) then begin
    res = 2289;
    warning = CUr.Code;
    goto LCreateMailFromWebIV;
  end;
  MatRowPut(Mailr,1,MArw);
  Mailr.Header = WRMb.IVHeader;//ORMailr.Header & " " & USetStr(1816);
  LTxtr.Code = WRMb.IVFirstTxt;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  rwcnt = MatRowCnt(IVr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(IVr,i,IVrw);
    tstr = IVrw.ArtCode & TAB;
    tstr = tstr & ValToString(IVrw.Quant,M4UVal,"",".",0) & TAB;
    tstr = tstr & Left(IVrw.Spec,60) & TAB;
    tstr = tstr & IVrw.Price & TAB;
    if (IVrw.vRebate!=0) then begin
      tstr = tstr & "-" & ValToString(IVrw.vRebate,M4UVal,"",".",0) & "%" &  TAB;
    end;
    tstr = tstr & IVrw.Sum & TAB;
    LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  end;
  tstr = TAB & TAB & TAB & "=====";
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2685) & TAB & IVr.Sum1;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2686) & TAB & IVr.Sum3;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2687) & TAB & IVr.Sum4;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  GetPayDealText(IVr.PayDeal,IVr.LangCode,tstr);
  tstr = USetStr(3060) & " " & tstr;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);

  LTxtr.Code = WRMb.IVLastTxt;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  Mailr.TransDate = CurrentDate;
  Mailr.SerNr = NextSerNr("MailVc",Mailr.TransDate,-1,false,"");
  if (RecordStore(Mailr,false)) then begin end;
  IVCreateHtmlFile(IVr,Mailr,false);
  
LCreateMailFromWebIV:;  
  CreateMailFromWebIV = res;
  RETURN;
END;

updating function Integer CreateMailFromORD(record ORVc ORr,var record MailVc Mailr,var string warning)
BEGIN
  Integer res;
  record LTxtVc LTxtr;
  record CUVc CUr;
  record ContactVc CCr;
  row ORVc ORrw;
  row MailVc MArw;
  Integer i,rwcnt;
  string 255 mailboxnr,tstr;
  string 1 TAB;
  record ORMailBlock ORMailr;
  record MailSettingsBlock MSRec;
  record WebORMailBlock WORb;
  record WebRegMailBlock WRMb;
  
  BlockLoad(MSRec);  
  BlockLoad(WORb);  
  BlockLoad(WRMb);  
  res = 0;
  if (ReadFirstMain(ORr,0,true)) then begin end;  
  TAB = chr(9);
 // FindUserMailboxName(CurrentUser,mailboxnr,tstr);
  tstr = MSRec.Admin;
  if (blank(tstr)) then begin
    res = 2289;
    warning = CurrentUser;
    goto LCreateMailFromORD;
  end;  
  Mailr.SendFlag = 1;
  MArw.RowTyp = 1;
  MArw.AddrCode = tstr;
  MatRowPut(Mailr,0,MArw);
  BlockLoad(ORMailr);
  CUr.Code = ORr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin end;
  MArw.RowTyp = 0;
  MArw.AddrCode = CUr.eMail;
  if (nonblank(ORr.CustContact)) then begin
    CCr.Company = CUr.Code;
    CCr.Name = ORr.CustContact;
    if (ReadFirstMain(CCr,2,true)) then begin
      if (nonblank(CCr.Email)) then begin
        MArw.AddrCode = CCr.Email;
      end;
    end;
  end;
  if (blank(MArw.AddrCode)) then begin
    res = 2289;
    warning = CUr.Code;
    goto LCreateMailFromORD;
  end;
  MatRowPut(Mailr,1,MArw);
  Mailr.Header = WORb.Header;//ORMailr.Header & " " & USetStr(1816);
  if (blank(Mailr.Header)) then begin
    Mailr.Header = WRMb.ORHeader;
  end;
//  Mailr.Header = Mailr.Header & ORr.SerNr;
  LTxtr.Code = WORb.FirstTxt;
  if (blank(LTxtr.Code)) then begin
    LTxtr.Code = WRMb.ORFirstTxt;
  end;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  rwcnt = MatRowCnt(ORr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORr,i,ORrw);
    tstr = ORrw.ArtCode & TAB;
    tstr = tstr & ValToString(ORrw.Quant,M4UVal,"",".",0) & TAB;
    tstr = tstr & Left(ORrw.Spec,60) & TAB;
    tstr = tstr & ORrw.Price & TAB;
    if (ORrw.vRebate!=0) then begin
      tstr = tstr & "-" & ValToString(ORrw.vRebate,M4UVal,"",".",0) & "%" &  TAB;
    end;
    tstr = tstr & ORrw.Sum & TAB;
    LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  end;
  tstr = TAB & TAB & TAB & "=====";
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2685) & TAB & ORr.Sum1;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2686) & TAB & ORr.Sum3;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = TAB & TAB & TAB & USetStr(2687) & TAB & ORr.Sum4;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  GetPayDealText(ORr.PayDeal,ORr.LangCode,tstr);
  tstr = USetStr(3060) & " " & tstr;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  LTxtr.Code = WORb.LastTxt;
  if (blank(LTxtr.Code)) then begin
    LTxtr.Code = WRMb.ORLastTxt;
  end;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  Mailr.TransDate = CurrentDate;
  Mailr.SerNr = NextSerNr("MailVc",Mailr.TransDate,-1,false,"");
  if (RecordStore(Mailr,false)) then begin end;
LCreateMailFromORD:;  
  CreateMailFromORD = res;
  RETURN;
END;

updating function Integer CreateMailForNewCU(record CUVc CUr,var record MailVc Mailr,var string warning,string passwd)
BEGIN
  Integer res;
  record LTxtVc LTxtr;
  row MailVc MArw;
  Integer i,rwcnt;
  string 255 mailboxnr,tstr;
  string 1 TAB;
  record WebRegMailBlock RegMailr;
  record MailSettingsBlock MSRec;
  
  BlockLoad(MSRec);  
  BlockLoad(RegMailr);  
  res = 0;
  if (ReadFirstMain(CUr,1,true)) then begin end;  
  TAB = chr(9);
  tstr = MSRec.Admin;
  if (blank(tstr)) then begin
    res = 2289;
    warning = CurrentUser;
    goto LCreateMailFromReg;
  end;  
  Mailr.SendFlag = 1;
  MArw.RowTyp = 1;
  MArw.AddrCode = tstr;
  MatRowPut(Mailr,0,MArw);
  MArw.RowTyp = 0;
  MArw.AddrCode = CUr.eMail;
  if (blank(MArw.AddrCode)) then begin
    res = 2289;
    warning = CUr.Code;
    goto LCreateMailFromReg;
  end;
  MatRowPut(Mailr,1,MArw);
  Mailr.Header = RegMailr.Header;
  LTxtr.Code = RegMailr.FirstTxt;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  tstr = USetStr(9334) & TAB;
  tstr = tstr & CUr.Code & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20504) & TAB;
  tstr = tstr & CUr.Name & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20505) & TAB;
  tstr = tstr & CUr.Person & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20506) & TAB;
  tstr = tstr & CUr.InvAddr0 & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20506) & TAB;
  tstr = tstr & CUr.InvAddr1 & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20506) & TAB;
  tstr = tstr & CUr.InvAddr2 & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20506) & TAB;
  tstr = tstr & CUr.InvAddr3 & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20506) & TAB;
  tstr = tstr & CUr.InvAddr4 & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20507) & TAB;
  tstr = tstr & CUr.VATNr & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20508) & TAB;
  tstr = tstr & CUr.eMail & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20509) & TAB;
  tstr = tstr & CUr.Phone & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20510) & TAB;
  tstr = tstr & CUr.Fax & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20512) & TAB;
  tstr = tstr & CUr.Comment & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
  tstr = USetStr(20511) & TAB;
  tstr = tstr & passwd & TAB;
  LineTextPut(Mailr,LineTextCnt(Mailr),tstr);

  LTxtr.Code = RegMailr.LastTxt;
  if (ReadFirstMain(LTxtr,1,true)) then begin
    rwcnt = LineTextCnt(LTxtr);
    for (i=0;i<rwcnt;i=i+1) begin
      tstr = LineTextGet(LTxtr,i);
      LineTextPut(Mailr,LineTextCnt(Mailr),tstr);
    end;    
    AddCRToText(Mailr);
  end;
  Mailr.TransDate = CurrentDate;
  Mailr.SerNr = NextSerNr("MailVc",Mailr.TransDate,-1,false,"");
  if (RecordStore(Mailr,false)) then begin end;
LCreateMailFromReg:;  
  CreateMailForNewCU = res;
  RETURN;
END;

global 
updating procedure CreateMailFromORDPaysan(record ORVc ORr)
BEGIN
  Integer wn,nwn;
  record MailVc Mailr;
  Integer err;
  string 255 tstr;
/*what ? */
  err = CreateMailFromORD(ORr,Mailr,tstr);
  if (err!=0) then begin
//    MessageBox(err,": " & tstr);
  end else begin
    ORCreateHtmlFile(ORr,Mailr);
  end;

  RETURN;
END;

global 
updating procedure CreateMailFromNewCur(record CUVc CUr,string passwd)
BEGIN
  Integer wn,nwn;
  record MailVc Mailr;
  Integer err;
  string 255 tstr;

  err = CreateMailForNewCU(CUr,Mailr,tstr,passwd);
  if (err!=0) then begin
//    MessageBox(err,": " & tstr);
  end;
  RETURN;
END;
