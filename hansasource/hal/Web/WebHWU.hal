external function Boolean InterNetAddrTest(string);
external updating function Boolean SendMailFromSystem(string,string,string,string,LongInt,Integer,string);
external function string 200 ToolWebReturnTheText(Integer);
external function string 60 GetWHUCountryCode2(Integer);
external function val GetCourseEventRowPrice(var record CourseEventVc, integer, boolean);
external procedure CourseEventVc_UpdatePrice(var record CourseEventVc);

external procedure ToolWebHBSDivCommentAndLink(string,string,string,string,string);
external procedure ToolWebEndTable();
external procedure ToolWebStartTable();
external function Integer InString2(string,string);
external procedure ReverseString(string,var string);
external procedure SplitAddress(string,var string,var string);
external function Boolean GetNextCustNr(var string);
external procedure ToolWebHiddenField(string,string);
external procedure ToolWebHBSDivContactLine(string,string,string,Boolean);
external Function Boolean WebHBSDivPublicMain(string,string,LongInt,LongInt,Boolean,Boolean);
external function string 255 ToolWebBuildLink(string,string);
external procedure ToolWebHBSDivStartPage();
external procedure ToolWebHBSDivSetMainTitle();
external procedure ToolWebHBSDivStartBody(string,string);
external procedure ToolWebLineStart();
external procedure ToolWebLineEnd();
external procedure ToolWebHBSDivEndPage();
external function string 200 GetWebLanguage();
external procedure ToolWebHBSDivPrintHeaderLang(string,string,string);
external function string 60 GetCountryCode(string);
external procedure WebSetLanguage(var string);


procedure SplitPostcodeCity(string instr, var string postcode,var string city)
begin
  Integer where;
  
  ReverseString(instr,postcode);
  where = InString2(postcode," ");
  where = len(instr) - where;
  postcode = Left(instr,where);  
  city = Right(instr,Len(instr)-where);
  return;
end;

global
function string 255 TranslateString(string english_str,string langcode)
begin
  record WebTextVc WebTextr;
  row WebTextVc WebTextrw;
  integer rwcnt,i;
  string 255 res;
  Boolean found;
  
  res = english_str;
  WebTextr.Code = english_str;  
  found = ReadFirstMain(WebTextr,1,true);
  if (!found) then begin
    WebTextr.Comment = english_str;  
    found = ReadFirstKey("Comment",WebTextr,1,true);
  end;  
  if (found) then begin
    res = WebTextr.Comment;
    rwcnt = MatRowCnt(WebTextr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(WebTextr,i,WebTextrw);
      if (langcode==WebTextrw.LangCode) then begin
        res = WebTextrw.Comment;
        goto LTranslateString;
      end;
    end;
  end;
LTranslateString:;
  TranslateString = res;
  return;
end;

global
procedure GetCourseStr(record CourseVc Courser,var string name,var string description,var string length, string langcode, var boolean translated)
begin
  Boolean res;
  Integer i,rwcnt;
  row CourseVc Courserw;
  boolean found;
  
  translated = false;
  found = false;
  rwcnt = MatRowCnt(Courser);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Courser,i,Courserw);
    if (langcode==Courserw.LangCode) then begin
      found = true;
      translated = true;
      name = Courserw.LangName;
      description = Courserw.LangDescription;
      length = Courserw.LangLength;
      goto LGetCourseStr;
    end;
  end;
  if(found == false) then begin
    name = Courser.Name;
    description = Courser.Description;
    length = Courser.Length;
  end;    
LGetCourseStr:;
  return;
end;

function string 60 GetHWUCountry(string country_code, string langcode)
BEGIN
  record CountryVc Cr;
  row CountryVc Crw;
  integer rwcnt,i;
  string 60 res;
    
  res = "";
  Cr.Code = country_code;
  if (ReadFirstMain(Cr,1,true)) then begin
    res = Cr.Comment;
    rwcnt = MatRowCnt(Cr);
    for(i=0;i<rwcnt;i=i+1) begin
      MatRowGet(Cr,i,Crw);
      if(Crw.LangCode == langcode) then begin
        res = Crw.Text;
      end;
    end;
  end;
  GetHWUCountry = res;
  RETURN;
END;

global
function string 60 GetMonthString(integer current_month,string langcode)
begin
  string 60 res;  
  record DNMVc DNMr;

  DNMr.LangCode = langcode;
  if (ReadFirstMain(DNMr,1,true)) begin
    switch(current_month) begin
      case 1:
        res = DNMr.January;
      case 2:
        res = DNMr.February;
      case 3:
        res = DNMr.March;
      case 4:
        res = DNMr.April;
      case 5:
        res = DNMr.May;
      case 6:
        res = DNMr.June;
      case 7:
        res = DNMr.July;
      case 8:
        res = DNMr.August;
      case 9:
        res = DNMr.September;
      case 10:
        res = DNMr.October;
      case 11:
        res = DNMr.November;
      case 12:
        res = DNMr.December;
    end;
  end else begin
    switch(current_month) begin
      case 1:
        res = "January";
      case 2:
        res = "February";
      case 3:
        res = "March";
      case 4:
        res = "April";
      case 5:
        res = "May";
      case 6:
        res = "June";
      case 7:
        res = "July";
      case 8:
        res = "August";
      case 9:
        res = "September";
      case 10:
        res = "October";
      case 11:
        res = "November";
      case 12:
        res = "December";    
    end;
  end;
  GetMonthString = res;
  return;
end;

global  
procedure WebOutStringNL(string tstr)
begin
  WebOutString(tstr);
  WebOutNL;
  return;
end;


global
procedure WebHWUDivOutTextLang(record CourseVc Courser,string tothead)
begin
  record NotepadVc Noter;
  record RLinkVc RLr;
  string 255 theheader;
  Integer cnt;
  Boolean printf,translated;
  string 60 langcode;
  string 255 name,description,length;
  
  WebSetLanguage(langcode);  
  
  //override langcode for specific countries
  switch (WebGetArg("company")) begin
    case "37": langcode = "ZA";
  end;

  GetCourseStr(Courser,name,description,length,langcode,translated);  
  printf = false;
  cnt = 1;
  theheader = tothead;
  while (ReadRecordLink(Courser,cnt,Noter,RLr)) begin
    cnt = cnt + 1;
    if (langcode==Noter.LangCode) then begin // WebLanguage(1)
      ToolWebHBSDivPrintHeaderLang(theheader,tothead,name);
      WebOutNL;
      WebOutString("<div class=""deftxt"">");
      WebOutText(Noter,false,"");
      WebOutString("</div>");
      WebOutNL;
      printf = true;
      goto LWebHBSDivOutTextLang;
    end;
  end;

  if(printf == false) then begin
    cnt = 1;
    langcode = "EN";        
    while (ReadRecordLink(Courser,cnt,Noter,RLr)) begin
      cnt = cnt + 1;
      if (langcode==Noter.LangCode) then begin // WebLanguage(1)
        ToolWebHBSDivPrintHeaderLang(theheader,tothead,RLr.Comment);
        WebOutNL;
        WebOutString("<div class=""deftxt"">");
        WebOutText(Noter,false,"");
        WebOutString("</div>");
        WebOutNL;
        goto LWebHBSDivOutTextLang;
      end;
    end;
  end;
LWebHBSDivOutTextLang:;
  WebOutNL;
  return;
end;


global
procedure WebHWUDivMailView()
begin
  record CourseEventVc CourseEventr;
  string 200 tstr;
  record CourseVc Courser;
  Integer oldcomp,newcomp;
  Boolean res;
  string 255 llink2,langcode,courseno;
  
  courseno = WebGetArg("courseno");
  
  CourseEventr.SerNr = courseno;
  if (ReadFirstMain(CourseEventr,1,true)) then begin end;
  WebSetLanguage(langcode);
  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;
  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");
  WebOutString("<table bgcolor=""#FFFFFF"" width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");
  ToolWebLineStart;
  WebOutString("<th>" & tstr & "</th>");
  ToolWebLineEnd;
  ToolWebLineStart;
  WebOutString("<td>");
  
  
  Courser.Code = WebGetArg("coursecode");

  if (ReadFirstMain(Courser,1,true)) then begin
    WebHWUDivOutTextLang(Courser,Courser.Name);
  end;

  WebOutString("</td>");
  ToolWebLineEnd;
  
  if (CourseEventr.SerNr>0) then begin
    ToolWebLineStart;
    WebOutString("<td>");

    llink2 = ToolWebBuildLink("WebHWUApplyForTraining.hal","&company=" & newcomp & "&langcode=" & langcode & "&courseno=" & CourseEventr.SerNr & "&currentcust=" & CurrentCust);
    if ((CourseEventr.MaxPersons-CourseEventr.NoOfPersons) <= 0)  or ((CurrentDate>CourseEventr.LastBookingDate) and (nonblankdate(CourseEventr.LastBookingDate))) then begin
      WebOutStringNL("<span class=""redfont""><b>" & TranslateString("30043",langcode) & "</b></span>");          
    end else begin
      if ((CourseEventr.MaxPersons-CourseEventr.NoOfPersons) <= 3) then begin
        WebOutStringNL("      <A class=""yellowfont"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30006",langcode) & "</a></span>");
      end else begin
        WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30001",langcode) & "</a></span>");
      end;
    end;
    WebOutString("</td>");
    ToolWebLineEnd;
  end;  

  WebOutString("</table>");
  ToolWebHBSDivEndPage;
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;



// **********************************
// ******* Course Descriptions *******
// **********************************
global
procedure WebHWUPlanCourse(string langcode)
begin
  record CourseEventVc CourseEventr;
  record CourseVc Courser;  
  boolean foundf,testf,first_loop,translated;
  integer month,day,last_month,current_month;
  date first_of_month;
  string 60 last_type,company,country;
  string 255 llink,llink2,name,description,length,month_str,tstr;
  record ResVc Resr;  
  Integer oldcomp,newcomp;
  Boolean res;

  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;
  
  WebSetLanguage(langcode);  
  company = WebGetArg("company");
//  country = GetCountryCode(langcode);
  country = GetWHUCountryCode2(newcomp);  
  first_loop = true;

  WebHBSDivPublicMain("PLANEDU",langcode,1 ,-1 ,true ,false);
                     //thecode,norofmails,maxchars,skipspecial,clickable
  
  foundf = true;
  CourseEventr.CountryCode = country;
  month = GetMonth(CurrentDate);
  day = GetDay(CurrentDate);
  first_of_month = AddDay(CurrentDate,-(day-1));


  // **********************************
  // ******* Local Educations *********
  // **********************************    
  CourseEventr.CountryCode = country;
  //CourseEventr.TransDate = first_of_month;
  CourseEventr.TransDate = CurrentDate;
  while(LoopKey("CountryCode",CourseEventr,2,foundf)) begin
  
    if(CourseEventr.CountryCode <> country) then begin
      foundf = false;
    end;
    
    if((CourseEventr.StatusFlag == 0) and (foundf == true)) then begin
    
      if(first_loop) then begin
        // Print heading
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""0"">");        
        WebOutStringNL("<tr valign=""top"">");
        WebOutStringNL("<td class=""heading2"">" & TranslateString("30031",langcode) & "&nbsp;" & GetHWUCountry(country,langcode) & "<br><br></td>");
        WebOutStringNL("</tr>");
        WebOutStringNL("</table>");        
        first_loop = false;
      end;
    
      current_month = GetMonth(CourseEventr.TransDate);
      if(current_month <> last_month) then begin  
        // Print header
        month_str = GetMonthString(current_month,langcode);
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");
        WebOutStringNL("  <tr><th>" & month_str & "</th></tr>");
        WebOutStringNL("</table>");
        last_month = current_month;
      end;
      
      Courser.Code = CourseEventr.CourseCode;
      if(ReadFirstMain(Courser,1,true)) then begin
        GetCourseStr(Courser,name,description,length,langcode,translated);
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");  
        WebOutStringNL("  <tr class=""even"">");
        WebOutStringNL("    <td height=""11"" VALIGN=top align=""left""><span class=""news""><b>" & name & "</b><br>");
        WebOutString(TranslateString("30015",langcode) & ":&nbsp;" & CourseEventr.TransDate);
        if(CourseEventr.TransDate <> CourseEventr.EndDate) then begin
          WebOutStringNL("-" & CourseEventr.EndDate);        
        end;
        Resr.Code = CourseEventr.ConferenceLocation;
        if(ReadFirstMain(Resr,1,true)) then begin end;

        tstr = Resr.Addr1;
        if (nonblank(tstr)) then begin
          if (nonblank(Resr.Addr2)) then begin
            tstr = tstr & ", ";
          end;
        end;
        tstr = tstr & Resr.Addr2;
        if (nonblank(tstr)) then begin
          if (nonblank(Resr.Addr3)) then begin
            tstr = tstr & ", ";
          end;
        end;
        tstr = tstr & Resr.Addr3;
        
        WebOutStringNL("<br>" & TranslateString("30030",langcode) & ":&nbsp;" & tstr);
        WebOutStringNL("<br></span>");
        llink = ToolWebBuildLink("WebHWUDivMailView.hal","&company=" & company & "&langcode=" & langcode & "&coursecode=" & Courser.Code & "&courseno=" & CourseEventr.SerNr & "&currentcust=" & CurrentCust);
        llink2 = ToolWebBuildLink("WebHWUApplyForTraining.hal","&company=" & company & "&langcode=" & langcode & "&courseno=" & CourseEventr.SerNr & "&currentcust=" & CurrentCust);
        if((CourseEventr.MaxPersons-CourseEventr.NoOfPersons) <= 0)  or ((CurrentDate>CourseEventr.LastBookingDate) and (nonblankdate(CourseEventr.LastBookingDate))) then begin
          WebOutStringNL("<span class=""redfont""><b>" & TranslateString("30043",langcode) & "</b></span>");          
        end else begin
          if((CourseEventr.MaxPersons-CourseEventr.NoOfPersons) <= 3) then begin
            WebOutStringNL("      <A class=""yellowfont"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
            WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30006",langcode) & "</a></span>");          
          end else begin
            WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
            WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30001",langcode) & "</a></span>");
          end;
        end;
        WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30037",langcode) & "</a></span>");        
        WebOutStringNL("    </td>");
        WebOutStringNL("  </tr>");
        WebOutStringNL("</table>");  
      end;
    end;
  end;
  
  // ******************************************
  // ******* International Educations *********
  // ****************************************** 
  ResetLoop(CourseEventr);
  foundf = true;
  first_loop = true;
  last_month = 0;
  CourseEventr.CountryCode = "";
  //CourseEventr.TransDate = first_of_month;
  CourseEventr.TransDate = CurrentDate;  
  while(LoopKey("CountryCode",CourseEventr,2,foundf)) begin
  
    if(CourseEventr.CountryCode <> "") then begin
      foundf = false;
    end;
    
    if((CourseEventr.StatusFlag == 0) and (foundf == true)) then begin
    
      if(first_loop) then begin
        // Print heading
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""0"">");
        WebOutStringNL("<tr valign=""top"">");
        WebOutStringNL("<td class=""heading2""><br><br>" & TranslateString("30020",langcode) & "<br><br></td>");
        WebOutStringNL("</tr>");
        WebOutStringNL("</table>");
        first_loop = false;
      end;
    
      current_month = GetMonth(CourseEventr.TransDate);
      if(current_month <> last_month) then begin
        // Print header
        month_str = GetMonthString(current_month,langcode);
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");
        WebOutStringNL("  <tr><th>" & month_str & "</th></tr>");
        WebOutStringNL("</table>");
        last_month = current_month;
      end;

      Courser.Code = CourseEventr.CourseCode;

      if(ReadFirstMain(Courser,1,true)) then begin
        GetCourseStr(Courser,name,description,length,langcode,translated);

        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");  
        WebOutStringNL("  <tr class=""even"">");
        WebOutStringNL("    <td height=""11"" VALIGN=top align=""left""><span class=""news""><b>" & name & "</b><br>");
        WebOutStringNL(TranslateString("30015",langcode) & ":" & CourseEventr.TransDate);
        if(CourseEventr.TransDate <> CourseEventr.EndDate) then begin
          WebOutStringNL(" - " & CourseEventr.EndDate);        
        end;
        Resr.Code = CourseEventr.ConferenceLocation;
        if(ReadFirstMain(Resr,1,true)) then begin end;
        tstr = Resr.Addr1;
        if (nonblank(tstr)) then begin
          if (nonblank(Resr.Addr2)) then begin
            tstr = tstr & ", ";
          end;
        end;
        tstr = tstr & Resr.Addr2;
        if (nonblank(tstr)) then begin
          if (nonblank(Resr.Addr3)) then begin
            tstr = tstr & ", ";
          end;
        end;
        tstr = tstr & Resr.Addr3;        

        WebOutStringNL("<br>" & TranslateString("30030",langcode) & ":" & tstr);
        if(nonblank(CourseEventr.LangCode)) then begin
          WebOutStringNL("<br>" & TranslateString("30022",langcode) & ":&nbsp;" & CourseEventr.LangCode &"</span>");
        end;
        WebOutStringNL("<br></span>");        
        llink = ToolWebBuildLink("WebHWUDivMailView.hal","&company=" & company & "&langcode=" & langcode & "&coursecode=" & Courser.Code & "&courseno=" & CourseEventr.SerNr & "&currentcust=" & CurrentCust);
        llink2 = ToolWebBuildLink("WebHWUApplyForTraining.hal","&company=" & company & "&langcode=" & langcode & "&courseno=" & CourseEventr.SerNr & "&currentcust=" & CurrentCust);
        WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30001",langcode) & "</a></span>");        
        WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30037",langcode) & "</a></span>");
        WebOutStringNL("    </td>");
        WebOutStringNL("  </tr>");
        WebOutStringNL("</table>");  
      end;
    end;
  end;
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure GetTypeStr(record CourseTypeVc CourseTyper,var string type_str, string langcode)
begin
  Integer i,rwcnt;
  row CourseTypeVc CourseTyperw;
  boolean found;

  found = false;
  rwcnt = MatRowCnt(CourseTyper);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(CourseTyper,i,CourseTyperw);
    if (langcode==CourseTyperw.LangCode) then begin
      found = true;
      type_str = CourseTyperw.Text;
      goto LGetTypeStr;
    end;
  end;

  if(found == false) then begin
    type_str = CourseTyper.Comment;
  end;

LGetTypeStr:;
  return;
end;

// **********************************
// ******* Course Descriptions *******
// **********************************
global
procedure WebHWUCourseDescription(string langcode)
begin
  record CourseVc Courser;
  boolean foundf,testf,translated;
  record CourseTypeVc CourseTyper;
  string 60 last_type,company,country;
  string 255 llink,name,description,length,type_str,tstr;
  Integer oldcomp,newcomp;
  Boolean res;

  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;

  WebSetLanguage(langcode);
//  country = GetCountryCode(langcode);  
  country = GetWHUCountryCode2(newcomp);  

  WebHBSDivPublicMain("COURSEDES",langcode,1,-1,true ,false);  
                      //thecode, norofmails,maxchars,skipspecial,clickable
  foundf = true;

//  WebOutStringNL("<table cellspacing=""0"" cellpadding=""0"" border=""0"">");
//  WebOutStringNL("  <tr valign=""top"">");
//  WebOutStringNL("    <td class=""heading2"">" & GetHWUCountry(country,langcode) & "</td>");
//  WebOutStringNL("  </tr>");
//  WebOutStringNL("</table>");  

  while(LoopKey("Type",Courser,1,foundf)) begin
    GetCourseStr(Courser,name,description,length,langcode,translated)
    if(translated == false) then begin
      goto SkipCourse;
    end;
    
    if (Courser.Terminated == 0) then begin
      if (last_type <> Courser.Type) then begin  
        // Print header
        CourseTyper.Code = Courser.Type;
        if(ReadFirstMain(CourseTyper,1,true)) then begin end;  
        GetTypeStr(CourseTyper,type_str,langcode);
        WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");
        WebOutStringNL("  <tr><th>" & type_str & "</th></tr>");
        WebOutStringNL("</table>");
        last_type = Courser.Type;
      end;

      WebOutStringNL("<table width=""100%"" cellspacing=""0"" cellpadding=""3"" border=""1"" class=""deftbl"">");  
      WebOutStringNL("  <tr class=""even"">");
      WebOutStringNL("    <td height=""11"" VALIGN=top align=""left""><span class=""news""><b>" & name & "</b><br>");
      WebOutStringNL(description & ". " & length & "<br></span>");
      
      llink = ToolWebBuildLink("WebHWUDivMailView.hal","&company=" & company & "&langcode=" & langcode & "&coursecode=" & Courser.Code);
      WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink & """)>");
      WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30037",langcode) & "</a></span>");
      WebOutStringNL("    </td>");
      WebOutStringNL("  </tr>");
      WebOutStringNL("</table>");  
    end;
SkipCourse:;    
  end;                        
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

// **********************************
// ******* Home *********************
// **********************************
global
procedure WebCustomHAL3()
begin
  record CourseEventVc CourseEventr;
  record CourseVc Courser;
  string 60 langcode,countrycode;
  boolean foundf,first_course,translated;
  string 255 name,description,length,llink,llink2;

  WebSetLanguage(langcode);
  
  WebOutStringNL("<table cellspacing=""0"" cellpadding=""0"" border=""0"" width=""100%"">");
  WebOutStringNL("  <tr valign=""top"">");
  WebOutStringNL("    <td width=""181"">");
  WebOutStringNL("      <img src=""/picts/hansaworlduni2.png"" alt="""" width=""181"" height=""158""><br><br>");
  
  foundf = true;
  first_course = true;
  
  countrycode = GetCountryCode(langcode);
  CourseEventr.CountryCode = countrycode;
  CourseEventr.TransDate = CurrentDate;
  
  while(LoopKey("CountryCode",CourseEventr,2,foundf)) begin
  
    if(CourseEventr.CountryCode <> countrycode) then begin
      foundf = false;
    end;
    

    if((CourseEventr.StatusFlag == 0) and (foundf == true) and (CourseEventr.ShowOnFirstPage==1)) then begin
      Courser.Code = CourseEventr.CourseCode;
      if(ReadFirstMain(Courser,1,true)) then begin  

        GetCourseStr(Courser,name,description,length,langcode,translated);
      
        if(first_course) then begin
          WebOutStringNL("      <br><div class=""heading3"">" & TranslateString("30039",langcode) & "</div><br>");
          first_course = false;
        end;
        
        WebOutStringNL("      <table cellspacing=""0"" cellpadding=""0"" border=""0"" width=""100%"">");
        WebOutStringNL("        <tr valign=""top"">");
        WebOutStringNL("          <td class=""news"">");
        
        WebOutStringNL("<b>" & name & " " & CourseEventr.TransDate & "</b><br>");
        WebOutStringNL(description & "<br>");
        llink = ToolWebBuildLink("WebHWUDivMailView.hal","&langcode=" & langcode & "&coursecode=" & Courser.Code);
        llink2 = ToolWebBuildLink("WebHWUApplyForTraining.hal","&langcode=" & langcode & "&courseno=" & CourseEventr.SerNr);
        WebOutStringNL("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink2 & """)>");
        WebOutStringNL("        <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30001",langcode) & "</a></span>");      
        WebOutStringNL("            <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink & """)>");
        WebOutStringNL("            <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"" alt=""Read more"">" & TranslateString("30037",langcode) & "</a></span><br><br>");
        WebOutStringNL("		  </td>");
        WebOutStringNL("        </tr>");
        WebOutStringNL("      </table>    ");
      end;
    end;
  end;
  
  WebOutStringNL("	</td>");
  WebOutStringNL("  <td width=""16"">&nbsp;&nbsp;&nbsp;</td>");
  WebOutStringNL("  <td width=""289"" class=""welcome"">");
  
  WebHBSDivPublicMain("HOME",langcode,1,-1,true ,false);  
                      //thecode, norofmails,maxchars,skipspecial,clickable

/*  
  WebOutStringNL("    <img src=""/gfx/tk06.gif"" width=""309"" height=""18"" alt=""""><br>");
  WebOutStringNL("    <img src=""/gfx/1.gif"" width=""1"" height=""5"" alt=""""><br><br><br>");
  WebOutStringNL("    <img src=""/gfx/1.gif"" width=""1"" height=""5"" alt=""""><br><br><br>");
*/  
  WebOutStringNL("  </td>");
  WebOutStringNL("  </tr>");
  WebOutStringNL("</table>");
  
  return;
end;

global
procedure WebHWUDivTermView()
begin
  string 60 langcode;
  Integer oldcomp,newcomp;
  Boolean res;

  oldcomp = CurrentCompany;
  res = SetCompany(1,false);

  WebSetLanguage(langcode);

  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");
  
  WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
  WebOutStringNL("<tr valign=""top"">");
  WebOutStringNL("<td class=""heading2"">&nbsp;<br><br></td>");
  WebOutStringNL("</tr>");
  WebOutStringNL("</table>");
  
  WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
  WebOutStringNL("  <tr><th>" & TranslateString("30045",langcode) & "</th></tr>");
  WebOutStringNL("</table>");
  
  WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
  WebOutString("<tr>");
  WebOutString("  <td width=""28%"" class=""feedback-txt"">");
  
  WebHBSDivPublicMain("COURSETERMS",langcode,1,-1,true,false);  
                     //thecode,norofmails,maxchars,skipspecial,clickable
                      
  WebOutString("  </td>");
  WebOutString("</tr>");
  WebOutString("<tr>");  
  WebOutStringNL("<td class=""readmoreMenuLink""><img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0""><a href=""JavaScript:history.back()"">" & TranslateString("30007",langcode) & "</a></td>");
  WebOutString("</tr>");
  WebOutString("</table>");
  ToolWebHBSDivEndPage;    

  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure WebHWUApplyForTrainingEx(string errorfield,string error_message)
begin
  record CourseEventVc CourseEventr;
  record CourseVc Courser;
  Boolean res,translated;
  string 200 tstr,currentcu;
  string 255 llink;
  LongInt interestf;
  string 60 langcode;
  longint courseno;
  string 255 name,description,length;
  string 255 postalcode,city,bgcolor,email;
  record ResVc Resr;
  record CUVc CUr;
  Integer oldcomp,newcomp;

  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;

  WebSetLanguage(langcode);
  courseno = WebGetArg("courseno");
  
  CourseEventr.SerNr = courseno;
  if(ReadFirstMain(CourseEventr,1,true)) then begin end;
  Courser.Code = CourseEventr.CourseCode;
  if(ReadFirstMain(Courser,1,true)) then begin end;
  GetCourseStr(Courser,name,description,length,langcode,translated);
  Resr.Code = CourseEventr.ConferenceLocation;
  if(ReadFirstMain(Resr,1,true)) then begin end;
  currentcu = WebGetArg("currentcust");
  CUr.Code = currentcu;
  if (ReadFirstMain(CUr,1,true)==false) then begin end;
  


  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");

  if (blank(currentcu)) then begin

    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
    WebOutStringNL("<tr valign=""top"">");
    WebOutStringNL("<td class=""heading2"">&nbsp;<br><br></td>");
    WebOutStringNL("</tr>");
    WebOutStringNL("</table>");
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
    WebOutStringNL("  <tr><th>" & TranslateString("30045",langcode) & "</th></tr>");
    WebOutStringNL("</table>");
    
    WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
    WebOutString("<tr>");
    WebOutString("  <td width=""28%"" class=""feedback-txt"">");
    
    WebHBSDivPublicMain("COURSECUSTINFO",langcode,1,-1,true,false);  
                       //thecode,norofmails,maxchars,skipspecial,clickable
                        
    WebOutString("  </td>");
    WebOutString("</tr>");
    WebOutString("</table>");

  end else begin
    WebOutString("<form method=""post"" action=""");
    llink = ToolWebBuildLink("WebHWUAskForPayment.hal","&langcode=" & langcode & "&companyname=" & CUr.Name & "&currentcust=" & WebGetArg("currentcust") & "&company=" & WebGetArg("company") & "&sessionid=" & WebGetArg("sessionid"));
    WebOutLink(llink);  
    WebOutString(""">");


    WebOutStringNL("<input type=""hidden"" name=""courseno"" value=""" & CourseEventr.SerNr & """>");
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
    WebOutStringNL("<tr valign=""top"">");
    WebOutStringNL("<td class=""heading2"">&nbsp;</td>");
    WebOutStringNL("</tr>");
    WebOutStringNL("</table>");
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
    WebOutStringNL("  <tr><th>" & TranslateString("30013",langcode) & "</th></tr>");
    WebOutStringNL("</table>");
    WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30012",langcode) & ":</td><td width=""72%"">" & name & "</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30015",langcode) & ":</td><td width=""72%"">" & CourseEventr.TransDate & "</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30023",langcode) & ":</td><td width=""72%"">" & length & "</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30033",langcode) & ":</td><td width=""72%"">" & CourseEventr.Price & " " & CourseEventr.CurncyCode & "</td></tr>");  
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"">&nbsp;</td></tr>");    
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30003",langcode) & ":</td><td width=""72%"">" & Resr.Addr1 & "</td></tr>");    
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"">" & Resr.Addr2 & "</td></tr>");      
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"">" & Resr.Addr3 & "</td></tr>");        
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"">&nbsp;</td></tr>");
    WebOutStringNL("</table>");  
      
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
    WebOutStringNL("  <tr><th>" & TranslateString("30027",langcode) & "</th></tr>");
    WebOutStringNL("</table>");  
    WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");  
    
    if(nonblank(error_message)) then begin
      WebOutString("<tr><td colspan=""2"" class=""redfont"">" & error_message & "</td></tr>");  
    end;
    ToolWebHBSDivContactLine(TranslateString("30004",langcode),"","",false);
    
    
    if ((nonblank(error_message)) and (blank(WebGetArg("personname1")))) then begin bgcolor = "#FFF5EE"; end else begin bgcolor = ""; end;  
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30026",langcode) & " 1</td><td width=""72%""><input value=""" & WebGetArg("personname1") & """ type=""text"" name=""personname1"" size=""31"" class=""feedback"">*</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30026",langcode) & " 2</td><td width=""72%""><input value=""" & WebGetArg("personname2") & """ type=""text"" name=""personname2"" size=""31"" class=""feedback""></td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30026",langcode) & " 3</td><td width=""72%""><input value=""" & WebGetArg("personname3") & """ type=""text"" name=""personname3"" size=""31"" class=""feedback""></td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30026",langcode) & " 4</td><td width=""72%""><input value=""" & WebGetArg("personname4") & """ type=""text"" name=""personname4"" size=""31"" class=""feedback""></td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30026",langcode) & " 5</td><td width=""72%""><input value=""" & WebGetArg("personname5") & """ type=""text"" name=""personname5"" size=""31"" class=""feedback""></td></tr>");
    if (blank(CUr.Name)) then begin
      if ((nonblank(error_message)) and (blank(CUr.Name))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = ""; end;  
      WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30010",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("companyname") & """ type=""text"" name=""companyname"" size=""31"" class=""feedback"">*</td></tr>");
    end else begin
      WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30010",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & CUr.Name & "</td></tr>");
    end;

    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30016",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("department") & """ type=""text"" name=""department"" size=""31"" class=""feedback""></td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30048",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("title") & """ type=""text"" name=""title"" size=""31"" class=""feedback""></td></tr>");
    ToolWebHBSDivContactLine("<br>" & TranslateString("30021",langcode),"","",false);    
    if ((nonblank(error_message)) and (blank(WebGetArg("addr1")))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = ""; end;  
    tstr = WebGetArg("addr1");
    if (blank(tstr)) then begin
      tstr = CUr.InvAddr0;
    end;
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30044",langcode) & "</td><td width=""72%""><input value=""" & tstr & """ type=""text"" name=""addr1"" size=""31"" class=""feedback"">*</td></tr>");
    
    SplitPostcodeCity(CUr.InvAddr1,postalcode,city);  

    if ((nonblank(error_message)) and (blank(WebGetArg("postalcode")))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = ""; end;  
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30032",langcode) & "</td><td width=""72%""><input value=""" & postalcode & """ type=""text"" name=""postalcode"" size=""31"" class=""feedback"">*</td></tr>");
    if ((nonblank(error_message)) and (blank(WebGetArg("city")))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = ""; end;  
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30009",langcode) & "</td><td width=""72%""><input value=""" & city & """ type=""text"" name=""city"" size=""31"" class=""feedback"">*</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30011",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("country") & """ type=""text"" name=""country"" size=""31"" class=""feedback""></td></tr>");
    
    if ((nonblank(error_message)) and (blank(WebGetArg("phone")))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = ""; end;  
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30029",langcode) & "</td><td width=""72%""><input value=""" & CUr.Phone & """ type=""text"" name=""phone"" size=""31"" class=""feedback"">*</td></tr>");
    if ((nonblank(error_message)) and (blank(WebGetArg("email")))) then begin bgcolor="#FFF5EE"; end else begin bgcolor = "FFFFFF"; end;  
    if ((nonblank(error_message)) and (InternetAddrTest(WebGetArg("email"))==false)) then begin bgcolor="#FFF5EE"; end else begin bgcolor = "FFFFFF"; end;  
    tstr = WebGetArg("email");
    if (blank(tstr)) then begin
      tstr = CUr.eMail;
    end;
    WebOutString("<tr><td bgcolor=""" & bgcolor & """ width=""28%"" class=""feedback-txt"">" & TranslateString("30017",langcode) & "</td><td width=""72%""><input value=""" & tstr & """ type=""email"" name=""email"" size=""31"" class=""feedback"">*</td></tr>");
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30014",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("custcode") & """ type=""text"" name=""custcode"" size=""31"" class=""feedback""></td></tr>");
    ToolWebHBSDivContactLine("<br>" & TranslateString("30028",langcode),"","",false);
    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30025",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("order_personname") & """ type=""text"" name=""order_personname"" size=""31"" class=""feedback""></td></tr>");  
  //  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30017",langcode) & "</td><td width=""72%""><input value=""" & WebGetArg("order_email") & """ type=""email"" name=""order_email"" size=""31"" class=""feedback""></td></tr>");
    WebOutString("<tr><td colspan=""2"" class=""feedback-txt""><br><input type=""checkbox"" name=""accept"">" & TranslateString("30019",langcode) & "<br><br></td></tr>");  
    llink = ToolWebBuildLink("WebHWUDivTermView.hal","&langcode=" & langcode & "&currentcust=" & WebGetArg("currentcust") & "&company=" & WebGetArg("company"));
    WebOutString("<tr>");
    WebOutString("  <td colspan=""2"" class=""feedback-txt"">");
    WebOutString("      <A class=""readmoreMenuLink"" HREF=javascript:jsOpenReadMore(""" & llink & """)>");
    WebOutString("      <img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0"">" & TranslateString("30038",langcode) & "</a><br></span><br>");
    WebOutString("  </td>");
    WebOutString("</tr>");
    WebOutString("<tr><td colspan=""2"" class=""readmoreMenuLink""><img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0""><a href=""#"" onclick=""window.print()"">" & TranslateString("30036",langcode) & "</a><br><br></td></tr>");
    
    interestf = -1;
    if (nonblank(WebGetArg("interestFlag"))) then begin
      interestf = StringToInt(WebGetArg("interestFlag"));
    end;
    WebOutString("<tr valign=""top""><td class=""feedback-txt"">");
    WebOutString("</td>");
    WebOutString("<td class=""feedback"">");
    WebOutString("</td>");
    ToolWebLineEnd;
    ToolWebHiddenField("function",WebGetArg("function"));
    WebOutString("<tr valign=""top"">");
    WebOutString("<td width=""28%"">&nbsp;</td>");
    WebOutString("<td align=""right"" width=""72%"">");
    WebOutString("<input type=""reset"" name=""Reset"" value=""" & TranslateString("30040",langcode) & """>");  
    WebOutString("&nbsp;&nbsp;&nbsp;<input type=""submit"" name=""Submit"" value=""" & TranslateString("30041",langcode) & """>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
    WebOutString("</td>");
    ToolWebLineEnd;
    WebOutString("</table>");
    WebOutString("</form>");
    WebOutString("<p>&nbsp;</p>");
  end;
  ToolWebHBSDivEndPage;  

  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure WebHWUApplyForTraining()
begin
  WebHWUApplyForTrainingEx("","");
  return;
end;

updating procedure SendMailToCourseEventResponsible(LongInt SerNr,string responsible,string ContactName)
begin
  Integer oldcomp;
  boolean res;

  oldcomp = CurrentCompany;  
  res = SetCompany(1,false);
  if (SendMailFromSystem("",responsible,"Course Evenr: " & SerNr & ", New Participant: " & ContactName ,"",-1,-1,"")) then begin
  end;
  ResetCompany(oldcomp);
  return;
end;

function boolean ValidateHWUForm(string langcode)
begin
  string 20 errorfield;
  boolean res;
  
  res = false;
  errorfield = "";
  if (blank(WebGetArg("companyname"))) then begin errorfield = "companyname"; end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("personname1"))) then begin errorfield = "personname1"; end;
  end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("addr1"))) then begin errorfield = "addr1"; end;
  end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("postalcode"))) then begin errorfield = "postalcode"; end;
  end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("city"))) then begin errorfield = "city"; end;
  end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("phone"))) then begin errorfield = "phone"; end;
  end;
  if (blank(errorfield)) then begin
    if (blank(WebGetArg("email"))) then begin errorfield = "email"; end;
  end;
  if (blank(errorfield)) then begin
    if (InterNetAddrTest(WebGetArg("email"))==false) then begin
      errorfield = "email";
    end;
  end;

  if (nonblank(errorfield)) then begin
    WebHWUApplyForTrainingEx(errorfield,TranslateString("30005",langcode));
    goto LValidateHWUForm;
  end;

  if (blank(WebGetArg("accept"))) then begin errorfield = "accept"; end;
  if (nonblank(errorfield)) then begin
    WebHWUApplyForTrainingEx(errorfield,TranslateString("30049",langcode));
    goto LValidateHWUForm;    
  end;
  
  res = true;
LValidateHWUForm:;
  ValidateHWUForm = res;
  return;
end;

procedure PersitsFieldValues()
begin
  WebOutStringNL("<input type=""hidden"" name=""courseno"" value=""" & WebGetArg("courseno") & """>");
  WebOutStringNL("<input type=""hidden"" name=""personname1"" value=""" & WebGetArg("personname1") & """>");
  WebOutStringNL("<input type=""hidden"" name=""personname2"" value=""" & WebGetArg("personname2") & """>");
  WebOutStringNL("<input type=""hidden"" name=""personname3"" value=""" & WebGetArg("personname3") & """>");
  WebOutStringNL("<input type=""hidden"" name=""personname4"" value=""" & WebGetArg("personname4") & """>");
  WebOutStringNL("<input type=""hidden"" name=""personname5"" value=""" & WebGetArg("personname5") & """>");
  WebOutStringNL("<input type=""hidden"" name=""companyname"" value=""" & WebGetArg("companyname") & """>");
  WebOutStringNL("<input type=""hidden"" name=""department"" value=""" & WebGetArg("department") & """>");
  WebOutStringNL("<input type=""hidden"" name=""title"" value=""" & WebGetArg("title") & """>");
  WebOutStringNL("<input type=""hidden"" name=""addr1"" value=""" & WebGetArg("addr1") & """>");
  WebOutStringNL("<input type=""hidden"" name=""postalcode"" value=""" & WebGetArg("postalcode") & """>");
  WebOutStringNL("<input type=""hidden"" name=""city"" value=""" & WebGetArg("city") & """>");
  WebOutStringNL("<input type=""hidden"" name=""country"" value=""" & WebGetArg("country") & """>");
  WebOutStringNL("<input type=""hidden"" name=""phone"" value=""" & WebGetArg("phone") & """>");
  WebOutStringNL("<input type=""hidden"" name=""email"" value=""" & WebGetArg("email") & """>");
  WebOutStringNL("<input type=""hidden"" name=""custcode"" value=""" & WebGetArg("custcode") & """>");
  WebOutStringNL("<input type=""hidden"" name=""order_personname"" value=""" & WebGetArg("order_personname") & """>");
  WebOutStringNL("<input type=""hidden"" name=""accept"" value=""" & WebGetArg("accept") & """>");
  return;
end;

global
procedure WebHWUAskForPayment()
begin
  record CourseEventVc CourseEventr;
  record CourseVc Courser;
  Boolean res,translated;
  string 200 tstr,currentcu;
  string 255 llink;
  LongInt interestf;
  string 60 langcode;
  longint courseno;
  string 255 name,description,length;
  string 255 postalcode,city,bgcolor;
  record ResVc Resr;
  record CUVc CUr;
  Integer oldcomp,newcomp;

  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;

  WebSetLanguage(langcode);
  
  if (ValidateHWUForm(langcode)==false) then begin
    goto LWebHWUAskForPayment;
  end;
  
  courseno = WebGetArg("courseno");
  
  CourseEventr.SerNr = courseno;
  if(ReadFirstMain(CourseEventr,1,true)) then begin end;
  Courser.Code = CourseEventr.CourseCode;
  if(ReadFirstMain(Courser,1,true)) then begin end;
  GetCourseStr(Courser,name,description,length,langcode,translated);
  Resr.Code = CourseEventr.ConferenceLocation;
  if(ReadFirstMain(Resr,1,true)) then begin end;
  currentcu = WebGetArg("currentcust");
  CUr.Code = currentcu;
  if (ReadFirstMain(CUr,1,true)==false) then begin end;
  
  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("",""); 

  if (blank(currentcu)) then begin

    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
    WebOutStringNL("<tr valign=""top"">");
    WebOutStringNL("<td class=""heading2"">&nbsp;<br><br></td>");
    WebOutStringNL("</tr>");
    WebOutStringNL("</table>");
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
    WebOutStringNL("  <tr><th>" & TranslateString("30045",langcode) & "</th></tr>");
    WebOutStringNL("</table>");
    
    WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
    WebOutString("<tr>");
    WebOutString("  <td width=""28%"" class=""feedback-txt"">");
    
    WebHBSDivPublicMain("COURSECUSTINFO",langcode,1,-1,true,false);  
                       //thecode,norofmails,maxchars,skipspecial,clickable
                        
    WebOutString("  </td>");
    WebOutString("</tr>");
    WebOutString("</table>");

  end else begin

    WebOutString("<form method=""post"" action=""");
    llink = ToolWebBuildLink("/WebHWUPayment.hal","&langcode=" & langcode & "&companyname=" & CUr.Name & "&currentcust=" & WebGetArg("currentcust") & "&company=" & WebGetArg("company") & "&sessionid=" & WebGetArg("sessionid"));
    WebOutString(llink);  
    WebOutString(""">");

    PersitsFieldValues; //output hidden fields to store user submitted values
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
    WebOutStringNL("<tr valign=""top"">");
    WebOutStringNL("<td class=""heading2"">&nbsp;</td>");
    WebOutStringNL("</tr>");
    WebOutStringNL("</table>");
    
    WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
    WebOutStringNL("  <tr><th>" & TranslateString("30058",langcode) & "</th></tr>");
    WebOutStringNL("</table>");
    WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
    WebOutString("<tr><td colspan=""2"" width=""100%"" class=""feedback-txt"">");
    WebOutString(TranslateString("30059",langcode));
    WebOutString("</td></tr>");

    WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"">&nbsp;</td></tr>");
    WebOutString("<tr valign=""top"">");
    WebOutString("<td width=""28%"">&nbsp;</td>");
    WebOutString("<td align=""right"" width=""72%"">");
    WebOutString("<input type=""submit"" name=""SubmitCC"" value=""" & TranslateString("30060",langcode) & """>");  
    WebOutString("&nbsp;&nbsp;&nbsp;<input type=""submit"" name=""SubmitIV"" value=""" & TranslateString("30061",langcode) & """>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
    WebOutString("</td></tr>");
    ToolWebLineEnd;

    WebOutStringNL("</table>");  
    
    WebOutString("</form>");  
  end;
  
LWebHWUAskForPayment:;  
  return;
end;

global
updating procedure WebHWUStoreForm(longint invno,longint orderno,Longint courseno,string companyname,string addr1,string postalcode,string country,string phone,string email,string city,
        array string personnames,string department,string title,string order_personname,string cust_code) 
begin
  record CourseEventVc CourseEventr;
  row CourseEventVc CourseEventrw;
  record CourseVc Courser;
  record CUVc CUr;
  record ResVc Resr;
  record ContactRelVc ContactRelr;
  record CUVc ContactCUr;
  string 255 tstr;
  integer rwcnt;
  string 255 name,description,length,langcode;
  string 20 errorfield;
  boolean found_cust,translated,res;
  val price;
  Integer oldcomp,newcomp;
  Integer fieldnr;
  integer i,cnt;


  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;
  
  WebSetLanguage(langcode);
    
/*  
  if(blank(WebGetArg("companyname")) or blank(WebGetArg("personname")) or blank(WebGetArg("addr1")) or
     blank(WebGetArg("postalcode")) or blank(WebGetArg("city")) or blank(WebGetArg("phone")) or blank(WebGetArg("email"))) then begin
     WebHWUApplyForTrainingEx("",TranslateString("30005",langcode));
     goto LWebHWUStoreForm;
  end;
  if (blank(WebGetArg("accept"))) then begin
    WebHWUApplyForTrainingEx("",TranslateString("30049",langcode));
     goto LWebHWUStoreForm;    
  end;    
*/

  CourseEventr.SerNr = courseno;
  if (ReadFirstMain(CourseEventr,1,true)) then begin
    Courser.Code = CourseEventr.CourseCode;
    if (ReadFirstMain(Courser,1,true)) then begin end;
    GetCourseStr(Courser,name,description,length,langcode,translated);
    Resr.Code = CourseEventr.ConferenceLocation;
    if (ReadFirstMain(Resr,1,true)) then begin end;          
    
    found_cust = false;
    if (nonblank(cust_code)) then begin
      CUr.Code = cust_code;
      if(ReadFirstMain(CUr,1,true)) then begin
        found_cust = true;
      end;
    end;
    if (not found_cust) then begin
      CUr.Name = companyname; 
      if (ReadFirstKey("Name",CUr,1,true)==false) then begin
        RecordNew(CUr);
        CUr.Name = companyname;
        CUr.InvAddr0 = addr1;
        CUr.InvAddr1 = postalcode & " " & city;
        CUr.InvAddr2 = country;
        CUr.Phone = phone;
        CUr.eMail = email;
        if(GetNextCustNr(tstr)) then begin end;
        CUr.Code = tstr;
        if (RecordStore(CUr,true)) then begin end;
      end;
    end;
    
    for (i=1;i<=5;i=i+1) begin
      if (nonblank(personnames[i])) then begin
        ContactRelr.ContactName = personnames[i];
        ContactRelr.CustCode = CUr.Code;
        if (ReadFirstKey("Contact",ContactRelr,2,true)==false) then begin
          RecordNew(ContactCUr);
          ContactCUr.Name = personnames[i];
          ContactCUr.InvAddr0 = CUr.InvAddr0;
          ContactCUr.InvAddr1 = CUr.InvAddr1;
          ContactCUr.InvAddr2 = CUr.InvAddr2;
          ContactCUr.InvAddr3 = CUr.InvAddr3;
          ContactCUr.InvAddr4 = CUr.InvAddr4;
          ContactCUr.NoLetterPosting = CUr.NoLetterPosting;
          ContactCUr.NoMailPosting = CUr.NoMailPosting;
          ContactCUr.Phone = CUr.Phone;
          ContactCUr.Fax = CUr.Fax;
          ContactCUr.Department = department;
          ContactCUr.CUType = 0;
          if(GetNextCustNr(tstr)) then begin end;
          ContactCUr.Code = tstr;
          if (RecordStore(ContactCUr,true)) then begin 
            RecordNew(ContactRelr);
            ContactRelr.CustCode = CUr.Code;
            ContactRelr.CustName = CUr.Name;
            ContactRelr.ContactCode = ContactCUr.Code;
            ContactRelr.ContactName = ContactCUr.Name;
            ContactRelr.ContactPhone = ContactCUr.Phone;
            ContactRelr.ContactMobile = ContactCUr.Mobile;
            ContactRelr.ContacteMail = ContactCUr.eMail;
            ContactRelr.ContactTitle = ContactCUr.Title;
            ContactRelr.ContactAltPhone = ContactCUr.AltPhone;
            if (RecordStore(ContactRelr,true)) then begin
            end;
          end;      
        end else begin
          ContactCUr.Code = ContactRelr.ContactCode;
          if (ReadFirstMain(ContactCUr,1,true)) then begin
          end;
        end;
        
        rwcnt = MatRowCnt(CourseEventr);
        CourseEventrw.CustCode = CUr.Code;
        CourseEventrw.ContactName = personnames[i];
        CourseEventrw.ContactCode = ContactCUr.Code;
        CourseEventrw.PriceListRow = CUr.PLCode;
        CourseEventrw.Source = "WEB";    
        CourseEventrw.BookingDate = CurrentDate;        
        CourseEventrw.Reference = order_personname;
        CourseEventrw.ItemCode = Courser.ItemCode;
        MatRowPut(CourseEventr,rwcnt,CourseEventrw);
        CourseEventrw.Price = GetCourseEventRowPrice(CourseEventr,rwcnt,true);

        if (blank(CourseEventrw.Price)) then begin
          CourseEventrw.Price = CourseEventr.Price;
        end;
        CourseEventrw.InvoiceNo = invno;
        MatRowPut(CourseEventr,rwcnt,CourseEventrw);

        CourseEventVc_UpdatePrice(CourseEventr);
        if (RecordStore(CourseEventr,true)) then begin
          if (nonblank(CourseEventr.Responsible)) then begin
            SendMailToCourseEventResponsible(CourseEventr.SerNr,CourseEventr.Responsible,CourseEventrw.ContactName);
          end else begin
            if (nonblank(Courser.Responsible)) then begin
              SendMailToCourseEventResponsible(CourseEventr.SerNr,Courser.Responsible,CourseEventrw.ContactName);
            end;
          end;
        end;
      end; //if nonblank
    end; // for personname&i
  end;

  WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class="""">");
  WebOutStringNL("<tr valign=""top"">");
  WebOutStringNL("<td class=""heading2"">&nbsp;<br><br></td>");
  WebOutStringNL("</tr>");
  WebOutStringNL("</table>");
  
  WebOutStringNL("<table align=""center"" width=""90%"" cellspacing=""1"" cellpadding=""3"" border=""0"" class=""deftbl"">");
  WebOutStringNL("  <tr><th>" & TranslateString("30008",langcode) & "</th></tr>");
  WebOutStringNL("</table>");
  
  WebOutString("<table align=""center"" bgcolor=""#FFFFFF"" width=""90%"" cellspacing=""3"" cellpadding=""3"" border=""0"" class="""">");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt""><b>" & TranslateString("30046",langcode) & "</b><br>" & TranslateString("30002",langcode) & "</td></tr>");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt"">&nbsp;</td></tr>");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt""><b>" & TranslateString("30018",langcode) & ":</b></td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30042",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.eMail & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30012",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & name & "</td></tr>");      
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30015",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & CourseEventr.TransDate & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30047",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & left(CourseEventr.StartTime,5) & "-" & left(CourseEventr.EndTime,5) &  "</td></tr>");  
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30030",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" &  Resr.Addr1 & "</td></tr>");          
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"" class=""feedback-txt"">" &  Resr.Addr2 & "</td></tr>");            
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"" class=""feedback-txt"">" &  Resr.Addr3 & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30023",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" &  Courser.Length & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30034",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" &  CourseEventr.Price & " " &  CourseEventr.CurncyCode & "</td></tr>");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt"">&nbsp;</td></tr>");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt""><b>" & TranslateString("30027",langcode) & ":</b></td></tr>");
  cnt = 0;
  for (i=1;i<=5;i=i+1) begin
    if (nonblank(personnames[i])) then begin
      cnt = cnt+1;
      WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30024",langcode) & " " & cnt & ":</td><td width=""72%"" class=""feedback-txt"">" & personnames[i] & "</td></tr>");
    end;
  end;
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30010",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" &  CUr.Name & "</td></tr>");    
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30016",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.Department & "</td></tr>");      
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30048",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.Title & "</td></tr>");        
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30003",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.InvAddr0 & "</td></tr>");          
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.InvAddr1 & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">&nbsp;</td><td width=""72%"" class=""feedback-txt"">" & country & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30029",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.Phone & "</td></tr>");
  WebOutString("<tr><td width=""28%"" class=""feedback-txt"">" & TranslateString("30017",langcode) & ":</td><td width=""72%"" class=""feedback-txt"">" & ContactCUr.eMail & "</td></tr>");  
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt"">&nbsp;</td></tr>");

  // also include link to invoice (make sure it shows even if something failed: no invno = -1)
  WebOutString("<tr><td align=""left"" colspan=""2"" width=""28%"" class=""readmoreMenuLink""><img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0""><a href=""");
  WebOutString("Javascript:void(0)"" onClick=""h2 = window.open('./WebCCPaymentInvoice.hal?langcode=" & langcode & "&invno=" & invno & "&ordno=" & orderno & "&ccnumber=" & right(WebGetArg("ccnumber"),4) & "&company=" & CurrentCompany & "','Item view','scrollbars=yes,rezisable=yes,width=780,height=790')");
  WebOutString(""">" & ToolWebReturnTheText(20197) & "</a></td></tr>");
  WebOutString("<tr><td colspan=""2"" width=""28%"" class=""feedback-txt"">&nbsp;</td></tr>");
  
  WebOutString("<tr><td align=""left"" colspan=""2"" width=""28%"" class=""readmoreMenuLink""><img src=""/gfx/dot04.gif"" width=""15"" height=""9"" border=""0""><a href=""#"" onclick=""window.print()"">" & TranslateString("30035",langcode) & "</a></td></tr>");

LWebHWUStoreForm:;
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure DoWebHWUUniversity(string langcode)
begin  
  record WebLinkListsVc WLLr;
  row WebLinkListsVc WLLrw;
  Integer i,rwcnt;
  Integer oldcomp;
  Boolean res;
  string 255 currentcu;
  
  currentcu = WebGetArg("currentcust");
  
  if (nonblank(currentcu)) or nonblank(CurrentCust) then begin
    WebHWUPlanCourse(langcode);
  end else begin
    oldcomp = CurrentCompany;  
    res = SetCompany(1,false);
    WebOutString("<p class=""heading3"">" & ToolWebReturnTheText(20198) & "</p>");
    WLLr.Code = WebGetArg("whatlogmenu");
    if (blank(WLLr.Code)) then begin
      WLLr.Code = "UNIVERSITY";
    end;
    if (ReadFirstMain(WLLr,1,true)) then begin
      rwcnt = MatRowCnt(WLLr);
      if (rwcnt>0) then begin
        ToolWebStartTable;
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(WLLr,i,WLLrw);
          ToolWebHBSDivCommentAndLink(WLLrw.Comment,WLLrw.LinkComment,"WebHBSDivMain.hal",WLLrw.LinkString & "&function=WebHWUPlanCourse.hal","");
        end;
        ToolWebEndTable;
      end;
    end;
    ResetCompany(oldcomp);
  end;
  return;
end;
