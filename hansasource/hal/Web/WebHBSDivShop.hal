external updating function Boolean CreateContractFromOrder(record CUVc,LongInt,var string,string);
external updating function LongInt ToolWebStoreTheOrder(string);
external function string 200 GetWebLanguage();
external function string 255 FindINObjects(string,string);
external function string 255 GeneratePassword2(Integer);
external updating Function Boolean ToolWebRegisterAndSendLetter(record CUVc,string,Boolean,Boolean);
external updating function Boolean StoreLetAsAct(record LetVc,var record ActVc);
external procedure GetCustEmail(record CUVc,var string);

//external procedure WebHBSPreIndex();
//external procedure WebHBSAfterIndex();
external function string 200 ToolWebReturnTheText(Integer);

external function Boolean ToolWebHBSUseLink();
external procedure COSumup(var record COVc);
external function Boolean PasteCust2InCO(var record COVc,Boolean,var string);
external updating function Integer RecordAction_raPasteOrdInInv(var record IVVc,LongInt,Boolean,var Integer);
external updating function Integer RecordAction_raPasteOrdInShip(var record SHVc,LongInt,var string);
external procedure COVcGetCalcItemPrice(record COVc,Integer,var val);
external procedure CalcSum(val,val,val,val,var val,Integer);

external function ToolWebHBSDivDisplayItemLinePict(string,string,string,string,string,string,integer);

external procedure ToolWebHBSDivStartBody(string,string);
external procedure ToolWebStartTable();
external procedure ToolWebEndTable();
//external procedure WebHBSIndex();
external procedure ToolWebHBSDivShopLine(string,string,string,string,Boolean);
external function val GetStockQty(string,string,Date,Boolean);
external procedure ToolWebPushButton(string,string,string);
external procedure ToolWebHBSDivEditFieldBrowse(string,string,string,string,Integer,Integer,Integer);
external function Boolean BuildWebOrd(string,LongInt,var record ORVc,var Boolean,string);
external updating procedure ToolWebStoreTheItem();
external procedure ToolWebHBSDivInfoCell(string,string,string);
external function Boolean GetNextCustNr(var string);
external procedure ToolWebSetCustInfo(var record CUVc);
external function Boolean ToolWebItemHasPict(var record WebHTMLVc,string,string);
external procedure ToolWebDisplayHTMLExtra(record WebHTMLVc,string,string);
external procedure ToolWebHBSDivItemListMenu(string,string,string,string,var Integer);
external function Boolean ToolWebGetCustAndSettings(var record CUVc,var Boolean,var Boolean);
external function val QtyInBasket(String,Integer);
external function Boolean GetItemPriceDiscount3(string,val,var record INVc,string,val,val,val,val,val,string,string,string,string,
                                                var val,var string,var val,var string,var val,var string,Integer,var Boolean,Date,Time,
                                                string,Boolean,var Boolean,string,var string,var val,string,string,var string);
external procedure ToolWebHBSThirdPart();
external procedure ToolWebHBSDivSetMainTitle();
external procedure ToolWebHBSDivStartPage();
external procedure ToolWebHBSDivEndPage();
external Function Boolean WebHBSDivPublicMain(string,string,LongInt,LongInt,Boolean,Boolean);
external procedure ToolWebHiddenField(string,string);
external procedure ToolWebLineStart();
external procedure ToolWebLineEnd();
external procedure ToolWebHBSDivListTable(Integer,Integer,string);
external procedure ToolWebHBSDivListTableEnd();
external procedure ToolWebHBSDivTableHdr(string,string,string);
external procedure ToolWebHBSDivTableData(string,string,string,string,string,string,Integer);
external procedure AddListLink(string,string,Integer,Integer,string);
external function string 255 ToolWebBuildLink(string,string);

external procedure WebLeftShopMenu();
external function string 200 ToolWebReturnTheText(Integer); //WNS
external procedure CreateFormToPaySite(string,string);
external procedure CreateLinkFromPaySite(string);

external updating function LongInt ToolWebStoreTheOrder2(var LongInt,string,Boolean);
external procedure ToolWebHBSShopBasket();
external updating function Integer CreateMailFromWebIV(LongInt,var string);
external procedure WebHWInfoCell(string,string,string);
external function Boolean GetItemNameStr(Integer,var string,string,string,string);
external procedure AddLinkedItemsToArr(record INVc,var array string,var integer);
external procedure RemoveItemFromArr(string,var array string,var integer);
external procedure ToolWebHBSDivListSuggestedItems(array string,integer,string);
external function string 255 GetUnitText(string,string);
external procedure ToolWebHBSDivShopBasketNew(string);

procedure ToolWebHBSGetDispGroup(string curcustno,var string dgroup)
begin
  record CUVc CUr;
  record CCatVc CCatr;
  record WebControlBlock WCr;
  
  CUr.Code = curcustno;
  if (ReadFirstMain(CUr,1,true)) then begin
    if (nonblank(CUr.MainDispGroup)) then begin
      dgroup = CUr.MainDispGroup;
    end else begin
      CCatr.Code = CUr.CustCat;
      if (ReadFirstMain(CCatr,1,true)) then begin
        dgroup = CCatr.MainDispGroup;
      end;
    end;
  end;
  if (blank(dgroup)) then begin
    BlockLoad(WCr);
    dgroup = WCr.DispGroup;
  end;
  if (blank(dgroup)) then begin
    dgroup = "WSHOP";
  end;
  return;
end;

global
procedure ToolWebHBSDivNotLoggedinMess()
begin
  Boolean res;

//  ToolWebHBSDivSetMainTitle;
//  ToolWebHBSDivStartBody("","");
  res = WebHBSDivPublicMain("WWWNOTLOGGEDIN",GetWebLanguage,-1,-1,false,false); //Fine
//  ToolWebHBSDivEndPage;
  return;
end;

global
function Boolean LoggedInHBSDivTest()
begin
  Boolean res;
  
  if (WebLoginStatus==3) then begin
    res = true;
  end else begin
    res = false;
    ToolWebHBSDivNotLoggedinMess;
  end;
  LoggedInHBSDivTest = res;
  return;
end;

global
procedure WebHBSDivShopWelcome()
begin
  Boolean res;

  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");
  res = WebHBSDivPublicMain("WELCOMESHOP",GetWebLanguage,-1,-1,false,false); //Fine
  ToolWebHBSDivEndPage;
  return;
end;

global
procedure ToolWebHBSDivShopChoose(string langcode)
begin
  Boolean res;

  res = WebHBSDivPublicMain("WSCOUNTRYINDEX",langcode,-1,-1,false,false);
  AddListLink("WebHBSDivShopIndex","Denmark",19,2,langcode);
  AddListLink("WebHBSDivShopIndex","Estonia",25,2,langcode);
  AddListLink("WebHBSDivShopIndex","Estonia HansaRaama",74,2,langcode);
  AddListLink("WebHBSDivShopIndex","Finland",40,2,langcode);
  AddListLink("WebHBSDivShopIndex","Latvia",26,2,langcode);
  AddListLink("WebHBSDivShopIndex","Lithuania",28,2,langcode);
  AddListLink("WebHBSDivShopIndex","Norway",24,2,langcode);
  AddListLink("WebHBSDivShopIndex","Poland",36,2,langcode);
  AddListLink("WebHBSDivShopIndex","Russia",29,2,langcode);
  AddListLink("WebHBSDivShopIndex","South Africa",37,2,langcode);
  AddListLink("WebHBSDivShopIndex","Sweden",39,2,langcode);
  AddListLink("WebHBSDivShopIndex","United Kingdom",63,2,langcode);
  return;
end;

procedure ToolWebHBSPrintRegister(string langcode)
begin
  WebOutString("<form method=""post"" action=""");
  WebOutString(ToolWebBuildLink("WebHBSDivMainUpdate.hal","&function=WebHBSDivStoreCust&company=" & WebGetArg("company") & "&langcode=" & langcode));
  WebOutString(""">");
  WebOutString("<table width=""100%"" border=""0"" cellpadding=""1"" cellspacing=""0"">");
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20059) & " (*)","companyname","text",WebGetArg("companyname"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20058) & " (*)","personname","text",WebGetArg("personname"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20069),"address1","text",WebGetArg("address1"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20070),"address2","text",WebGetArg("address2"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20071),"address3","text",WebGetArg("address3"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20072),"address4","text",WebGetArg("address4"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20073),"address5","text",WebGetArg("address5"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20082) & " (*)","orgnr","text",WebGetArg("orgnr"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20062) & " (*)","phone","text",WebGetArg("phone"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20060),"email","text",WebGetArg("email"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20063),"fax","text",WebGetArg("fax"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20083) & " (*)","passwd","password",WebGetArg("passwd"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20084),"message","text",WebGetArg("message"),false);
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20066),"","text","",false);
  ToolWebHiddenField("backpage",WebGetArg("backpage"));
  WebOutString("<tr valign=""top"">");
  WebOutString("<td width=""28%"">&nbsp;</td>");
  WebOutString("<td width=""72%"">");
  WebOutString("<input type=""submit"" name=""Submit"" value=""" & ToolWebReturnTheText(20067) & """>");
  WebOutString("<input type=""reset"" name=""Reset"" value=""" & ToolWebReturnTheText(20068) & """>");
  WebOutString("</td>");
  WebOutString("</tr>");
  WebOutString("</table>");
  WebOutString("</form>");
  return;
end;

global
updating procedure WebHBSDivStoreCust(string langcode)
begin
  record CUVc CUr;
  record CUVc tempCUr;
  Boolean storef;
  string 255 passw;
  Integer oldcomp,newcomp;
  Boolean res,res1;
  
  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res1 = SetCompany(newcomp,false);
  end;  
  storef = true;
//  res = WebHBSDivPublicMain("WWWREGISTER",langcode,-1,-1,false,false);
  WebOutString("<table width=""100%"" border=""0"" cellpadding=""1"" cellspacing=""0"">");
  ToolWebLineStart;
  RecordNew(CUr);
  CUr.Name = WebGetArg("companyname");
  if (nonblank(CUr.Name)) then begin
    if (ReadFirstKey("Name",CUr,1,true)) then begin
      ToolWebHBSDivInfoCell(ToolWebReturnTheText(20085),"100%","false");
      ToolWebLineEnd;
      ToolWebLineStart;
      WebOutString("<td>");
      ToolWebHBSPrintRegister(langcode);
      storef = false;
    end;
  end;
  CUr.VATNr = WebGetArg("orgnr");
  if ((storef) and (nonblank(CUr.VATNr))) then begin
    if (ReadFirstKey("VATNr",CUr,1,true)) then begin
      ToolWebHBSDivInfoCell(ToolWebReturnTheText(20085),"100%","false");
      ToolWebLineEnd;
      ToolWebLineStart;
      WebOutString("<td>");
      ToolWebHBSPrintRegister(langcode);
      storef = false;
    end;
  end;
  if (storef) then begin
    CUr.CUType = 1;
    CUr.Name = WebGetArg("companyname");
    CUr.Person = WebGetArg("personname");
    CUr.InvAddr0 = WebGetArg("address1");
    CUr.InvAddr1 = WebGetArg("address2");
    CUr.InvAddr2 = WebGetArg("address3");
    CUr.InvAddr3 = WebGetArg("address4");
    CUr.InvAddr4 = WebGetArg("address5");
    CUr.VATNr = WebGetArg("orgnr");
    CUr.eMail = WebGetArg("email");
    CUr.Phone = WebGetArg("phone");
    CUr.Fax = WebGetArg("fax");
    CUr.AllowLogin = 1;
    CUr.CustCat = "WWW";
    CUr.Comment = WebGetArg("message");
    if (GetNextCustNr(passw)) then begin end;
    CUr.Code = passw;
    RecordCopy(tempCUr,CUr);
    if (ReadFirstMain(tempCUr,1,true)) then begin
      storef = false;
    end;
    passw = WebGetArg("passwd");
    if (blank(CUr.Code)) then begin
      ToolWebHBSDivInfoCell(ToolWebReturnTheText(20086),"100%","false");
      ToolWebLineEnd;
      ToolWebLineStart;
      WebOutString("<td>");
      ToolWebHBSPrintRegister(langcode);
      storef = false;
    end;
    if ((blank(CUr.Name)) or
        (blank(CUr.Person)) or
        (blank(CUr.VATNr)) or
        (blank(CUr.Phone)) or
        (blank(passw))) then begin
      ToolWebHBSDivInfoCell(ToolWebReturnTheText(20087),"100%","false");
      ToolWebLineEnd;
      ToolWebLineStart;
      WebOutString("<td>");
      ToolWebHBSPrintRegister(langcode);
      storef = false;
    end;
  end;
  if (storef) then begin
    ToolWebSetCustInfo(CUr);
    storef = WebStoreCust(CUr,passw);
    ToolWebHBSDivInfoCell(ToolWebReturnTheText(20088) & " " & CUr.Code,"100%","false");
  end else begin
    WebOutString("</td>");
  end;
  ToolWebLineEnd;
  WebOutString("</table>");
  if (storef) then begin
    res = WebHBSDivPublicMain("WWWREGISTERDONE",langcode,-1,-1,false,false);
    WebOutString("<p class=""bluefont"">" & CUr.VATNr & "</p>");
  end;
  if (res1) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure WebHBSDivRegister()
begin
  Boolean res;
  string 20 langcode; //Fine
  
//  ToolWebHBSDivStartPage;
//  ToolWebHBSDivSetMainTitle;
//  ToolWebHBSDivStartBody("","");
  res = WebHBSDivPublicMain("WWWSHOPREGISTER",langcode,-1,-1,false,false);
  ToolWebHBSPrintRegister(langcode);
//  ToolWebHBSDivEndPage;
  return;
end;

global
procedure WebHBSDivPassword(string langcode)
begin
  Boolean res;
  
  res = WebHBSDivPublicMain("REGISTER1",langcode,-1,-1,false,false);
  WebOutString("<form method=""post"" action=""");
  WebOutString(ToolWebBuildLink("WebHBSDivMain.hal","&function=WebHBSDivPassword2&company=" & WebGetArg("company") & "&langcode=" & langcode));
  WebOutString(""">");
  WebOutString("<table width=""100%"" border=""0"" cellpadding=""1"" cellspacing=""0"">");
  ToolWebHBSDivShopLine(ToolWebReturnTheText(20051) & " (*)","login","text","",false);

  WebOutString("<tr valign=""top"">");
  WebOutString("<td width=""28%"">&nbsp;</td>");
  WebOutString("<td width=""72%"">");
  WebOutString("<p><input type=""submit"" name=""Submit"" value=""" & ToolWebReturnTheText(20050) & """>");
  WebOutString("</td>");
  WebOutString("</tr>");
  WebOutString("</table>");
  WebOutString("</form>");

  return;
end;

global
procedure WebHBSDivPassword2(string langcode)
begin
  Boolean res,setcomp;
  record CUVc CUr;
  string 20 newcomp;
  Integer oldcomp;
  string 60 emailaddr;

  newcomp = WebGetArg("company");
  if (nonblank(newcomp)) then begin
    oldcomp = CurrentCompany;  
    setcomp = SetCompany(StringToInt(newcomp),false);
  end;
  CUr.Code = WebGetArg("login");
  if (ReadFirstMain(CUr,1,true)) then begin
    GetCustEmail(CUr,emailaddr);
    if ((nonblank(CUr.Fax)) or (nonblank(emailaddr))) then begin
      res = WebHBSDivPublicMain("REGISTER2",langcode,-1,-1,false,false);
      if (CUr.AllowLogin==1) then begin    
        WebOutString(ToolWebReturnTheText(20048) & "<p>");
        WebOutNL;
      end;
      WebOutString("<form method=""post"" action=""");
      WebOutString(ToolWebBuildLink("WebHBSDivMainUpdate.hal","&function=WebHBSDivCreatePassword&company=" & WebGetArg("company") & "&langcode=" & langcode));
      WebOutString(""">");
      WebOutNL;

      WebOutString("<table width=""100%"" border=""0"" cellpadding=""1"" cellspacing=""0"">");
      if (nonblank(CUr.Fax)) then begin
        WebOutString("<tr><td>");
        WebOutString("<input type=""checkbox"" name=""fax"" value=""on"" checked>");
        WebOutString(ToolWebReturnTheText(20046) & CUr.Fax);
        WebOutString("</tr></td>");
        WebOutNL;
      end;

      if (nonblank(emailaddr)) then begin
        WebOutString("<tr><td>");
        WebOutString("<input type=""checkbox"" name=""email"" value=""on"" checked>");
        WebOutString(ToolWebReturnTheText(20047) & emailaddr);
        WebOutString("</tr></td>");
        WebOutNL;
      end;

      WebOutString("<tr><td>");
      ToolWebHiddenField("login",WebGetArg("login"));
      WebOutString("<input type=""submit"" value=""" & ToolWebReturnTheText(20050) & """ name=""b1"">");
      WebOutString("</tr></td>");
      WebOutNL;
      WebOutString("</table>");
      WebOutString("</form>");
      WebOutNL;
    end else begin
//      GeneratePassword2(CUr,passwd,6); when password resets only, need to make sure, JJ
//      error = WebStoreCust(CUr,passwd);
      res = WebHBSDivPublicMain("REGFAIL",langcode,-1,-1,false,false);
    end;
  end else begin
    res = WebHBSDivPublicMain("REGFAIL",langcode,-1,-1,false,false);
  end;
  if (setcomp) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
updating procedure WebHBSDivCreatePassword(string langcode)
begin
  record CUVc CUr;
  string 60 passwd;
  Boolean error;
  string 20 newcomp;
  Integer oldcomp;
  Boolean res;

  res = false;
  newcomp = WebGetArg("company");
  if (nonblank(newcomp)) then begin
    oldcomp = CurrentCompany;  
    res = SetCompany(StringToInt(newcomp),false);
  end;
  CUr.Code = WebGetArg("login");
  error = ReadFirstMain(CUr,1,true);
  passwd = GeneratePassword2(6);
  if (ToolWebRegisterAndSendLetter(CUr,passwd,WebGetArg("fax")=="on",WebGetArg("email")=="on")) then begin
    CUr.AllowLogin = 1;
    error = WebStoreCust(CUr,passwd);
    res = WebHBSDivPublicMain("REGDONE",langcode,-1,-1,false,false);
  end else begin
//##
  end;
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

global
procedure ToolWebHBSDivItemHeader(Boolean total)
begin
  ToolWebHBSDivListTable(7,0,"0");
  ToolWebLineStart;
if (false) then begin
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20089),"left","15%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20090),"center","8%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20091),"left","8%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20092),"left","45%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20093),"right","9%");
//  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20094),"right","3%");
  if (total) then begin
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20095),"right","11%");
  end else begin
    ToolWebHBSDivTableHdr("","right","11%");
  end;
end else begin
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20092),"left","50%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20090),"center","12%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20091),"left","12%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20093),"right","11%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20095),"right","15%");
end;
  ToolWebLineEnd;
  return;
end;

global
procedure ToolWebHBSDivDisplayItemLine(string curitemno,string linkargs,val qty,string unittext,string spec,val reb,val price,string curcode,val totsum,Boolean printtot,Integer rwt)
begin
  record BaseCurBlock BCr;
  string 60 tstr;
  
  ToolWebLineStart;
if (false) then begin
  ToolWebHBSDivTableData(curitemno,"WebHBSDivMain.hal",linkargs & "&function=" & "WebHBSDivItemView","left","","",rwt); //WNS
  if (qty<>0) then begin
    tstr = ValToString(qty,M4UVal,"","",0);
  end else begin
    tstr = "";
  end;
  ToolWebHBSDivTableData(tstr,"","","center","","",rwt);
  ToolWebHBSDivTableData(unittext,"","","left","","",rwt);
  ToolWebHBSDivTableData(spec,"","","left","","",rwt);
  ToolWebHBSDivTableData(price,"","","right","","",rwt);
/*
  if (printtot==false) then begin
    tstr = curcode;
     if (blank(tstr)) then begin
       BlockLoad(BCr);
       tstr = BCr.BaseCur1;
     end;
    ToolWebHBSDivTableData(tstr,"","","right","","",rwt);
  end;
  if (reb<>0) then begin
    tstr = ValToString(reb,M4UVal," ",".",0);
  end else begin
    tstr = "";
  end;
  ToolWebHBSDivTableData(tstr,"","","right","","",rwt);
*/
  if (printtot) then begin
    ToolWebHBSDivTableData(totsum,"","","right","","",rwt);
  end;
end else begin
  if ((nonblank(linkargs)) and (nonblank(curitemno))) then begin
    ToolWebHBSDivTableData(spec,"WebHBSDivMain.hal",linkargs & "&function=" & "WebHBSDivItemView","left","","",rwt); //WNS
  end else begin
    ToolWebHBSDivTableData(spec,"","","left","","",rwt); //WNS
  end;
  if (qty<>0) then begin
    tstr = ValToString(qty,M4UVal,"","",0);
  end else begin
    tstr = "";
  end;
  ToolWebHBSDivTableData(tstr,"","","center","","",rwt);
  ToolWebHBSDivTableData(unittext,"","","left","","",rwt);
  ToolWebHBSDivTableData(price,"","","right","","",rwt);
  ToolWebHBSDivTableData(totsum,"","","right","","",rwt);
end;
  ToolWebLineEnd;
  return;
end;

procedure ToolWebHBSDivDispGroups(string itcode,LongInt msernr,Integer maxlines,string langcode)
begin
  row INVc INrw;
  Integer rwcnt,i;
  Boolean testf;
  String 60 pstr;
  record DIVc DIr;
  record CUVc CUr;
  record INVc INr;
  record INVc IN2r;
  string 60 ckey;
  string 100 spec,tempstr;
  LongInt loopcnt;
  LongInt looppos;
  Boolean found;
  Integer rwt;
  string 255 linkargs;
  string 10 dgroup;
  Integer pos,dicnt;
  string 5 nsep;
  Boolean tmpf;
  Boolean overmax;
  Boolean headerf;
  string 20 curitemno;
  string 100 curitemname;
  string 20 salesacc,vatcode,tax2code,taxtemplatecode;
  val price,reb,cost,qty,instock,tax2prc;
  Boolean calcprice;
  Boolean showstocklevel;
  Boolean showprices,dummyf;
  Boolean hasextralines;
  Time blankt;

  loopcnt = 1;
  rwt = 1;
  overmax = false;
  headerf = false;
  pos = 0;
  dicnt = 0;
  CUr.Code = CurrentCust;
  if (ToolWebGetCustAndSettings(CUr,showstocklevel,showprices)) then begin end;
  ckey = "DICode:" & itcode;
  found = true;
  DIr.Code = "";
  ResetLoop(DIr);
  while (LoopKey(ckey,DIr,1,found)) begin
    if (DIr.Code==itcode) then begin found = false; end;
    if (found) then begin
      dicnt = dicnt + 1;
      if (dicnt>msernr) then begin
        spec = DIr.Name;
        linkargs = "function=WebHBSDivCustProd" & "&company=" & WebGetArg("company") & "&langcode=" & langcode & "&itcode=" & DIr.Code; //WNS
        ToolWebHBSDivItemListMenu(spec,"WebHBSDivMain.hal",linkargs,"",rwt); //WNS
        loopcnt = loopcnt + 1;
        if (loopcnt>maxlines) then begin
          found = false;
          overmax = true;
        end;
      end;
    end;
  end;
  if (msernr>dicnt) then begin
    looppos = msernr-dicnt;
  end;
//  ToolWebHBSDivListTable(2,480,"0");
  pos = 0;
  found = true;
  ckey = "DICode:" & itcode;
  INr.Code = "";
  while (LoopKey(ckey,INr,1,found)) begin
    if (found) then begin
      dicnt = dicnt + 1;
      if (dicnt>msernr) then begin
        curitemno = INr.Code;
        qty = QtyInBasket(curitemno,0);
        if (GetItemPriceDiscount3(curitemno,qty,IN2r,CUr.CurncyCode,0,0,0,0,0,
                langcode,CUr.CustCat,CUr.PLCode,CUr.RebCode,
                price,curitemname,reb,vatcode,cost,salesacc,
                CUr.ExportFlag,calcprice,CurrentDate,blankt,CUr.Code,true,dummyf,CUr.PayDeal,tax2code,tax2prc,"","",taxtemplatecode)==false) then begin     
          IN2r.Name = "";
        end;
        if (showprices==false) then begin
          price = BlankVal;
        end;
        spec = curitemname;
        linkargs = "&function=WebHBSDivItemView" & "&company=" & WebGetArg("company") & "&langcode=" & langcode & "&itcode=" & itcode & "&itemcode=" & curitemno;
        if (false) then begin
          rwcnt = MatRowCnt(INr);
          testf = false;
          pstr="";
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(IN2r,i,INrw);
            if (INrw.LangCode=="PICT") then begin
              testf = true;
              pstr = INrw.Text;
              i = rwcnt;
            end;
          end;
          ToolWebHBSDivDisplayItemLinePict("WebHBSDivMain.hal",linkargs,IN2r.Group,spec,pstr,langcode,rwt);        
        end else begin
          ToolWebHBSDivItemListMenu(spec,"WebHBSDivMain.hal",linkargs,"",rwt);
          hasextralines = true;
          rwcnt = MatRowCnt(INr);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(IN2r,i,INrw);
            if (blank(INrw.LangCode)) then begin
              WebOutString("<tr><td width=""100%"" align=""left"" class=""deftxt"">");
              WebOutString("&nbsp;&nbsp;" & INrw.Text);
              WebOutString("</td></tr>");
              hasextralines = true;
            end;
          end;
          if (hasextralines) then begin
            WebOutString("<tr><td width=""100%"" align=""left"" class=""deftxt"">");
            WebOutString("&nbsp;");
            WebOutString("</td></tr>");
          end;
          loopcnt = loopcnt + 1;
        end;
        rwt = rwt + 1;
        if (rwt>2) then begin rwt = 1; end;
        loopcnt = loopcnt + 1;
        if (loopcnt>maxlines) then begin
          found = false;
          overmax = true;
        end;
      end;
    end;
  end;
//  ToolWebHBSDivListTableEnd;  
  return;
end;

global
procedure WebHBSDivCustProd()
begin
  string 60 mailboxcode;
  string 60 mailboxname;
  record CYBlock CYr;
  record WebHTMLVc WHr;
  record WebControlBlock WCr;
  record DIVc DIr;
  string 20 itcode;
  string 60 ckey;
  LongInt prevval,nextval,maxval;
  Boolean prevf,nextf,mainf;
  LongInt msernr,pages;
  Integer showmax;
  Integer oldcomp,newcomp;
  Boolean res,res1;
  string 20 langcode;

  langcode = GetWebLanguage; //Fine
  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res1 = SetCompany(newcomp,false);
  end;
  BlockLoad(CYr);
  BlockLoad(WCr);
  
  msernr = WebGetArg("sernr");
  if (msernr==-1) then begin msernr = 0; end;
  itcode = WebGetArg("itcode");
  if (blank(itcode)) then begin
    mainf = true;
    ToolWebHBSGetDispGroup(CurrentCust,itcode);
  end;
  showmax = 50;
/*
  showmax = 10;
  if (WCr.MatLines>0) then begin
    showmax = WCr.MatLines;
  end;
  ckey = "DICode:" & itcode;
  maxval = RecordsInIndex("DIVc",ckey);
  maxval = maxval + RecordsInIndex("INVc",ckey);
  
  prevf = true;
  nextf = true;
  prevval = msernr-showmax;
  if (prevval<0) then begin 
    prevval = 0;
    prevf = false;
  end;
  nextval = msernr+showmax;
  if (nextval>maxval) then begin
    nextval = msernr;
    nextf = false;
  end;
  pages=maxval/showmax;
  if ((pages*showmax)!=maxval) then begin
    pages=pages+1;
  end; 
  */
  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");
  WebOutString("<table border=""0"" width=""100%""><tr><td width=100% valign=top>");
  WebOutString("<table border=""0"" cellspacing=""0"" cellpadding=""1"">");

  ToolWebHBSGetDispGroup("",itcode);

  ToolWebHBSDivDispGroups(itcode,msernr,showmax,langcode);
  WebOutString("</table>");
  WebOutString("</td>");
  WebOutString("<td valign=top>");
  if (ToolWebItemHasPict(WHr,itcode,"BDG")==true) then begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end else begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end;
  ToolWebHBSThirdPart;
  ToolWebHBSDivEndPage;
  if (res1) then begin
    ResetCompany(oldcomp);
  end;
  return;  
end;

updating procedure UpdateHBSContract(LongInt orderno)
begin
  record IVVc IVr;
  record INVc INr;
  record COVc COr;
  record COVc CO2r;
  record COVc oldCOr;
  record ORVc ORr;
  record CUVc CUr;
  record SHVc SHr;
  record SHVc oldSHr;
  row ORVc ORrw;
  row COVc COrw;
  Integer rwcnt,i,corwcnt,j,postoplace,errcode;
  Boolean foundf,testf,cofound;
  record GeneralOptionBlock GenOptr;
  string 255 curitemname,salesacc,vatcode,tax2code,taxtemplatecode;
  string 255 warning;
  val t,price,vreb,baseprice,tax2prc;
  Boolean calcpricef;
  Boolean dummyf;
  Boolean onlycontitems;
  Time blankt;
  
  cofound = false;
  ORr.SerNr = orderno;
  if (ReadFirstMain(ORr,1,true)) then begin
    BlockLoad(GenOptr);
    foundf = true;
    CUr.Code = ORr.CustCode;
    if (ReadFirstMain(CUr,1,true)) then begin
      if (CUr.CustCat=="WWW") then begin
        foundf = false;
      end;
    end;
    COr.CustCode = ORr.CustCode;
    while (LoopKey("CustCode",COr,1,foundf)) begin
      if (COr.CustCode!=ORr.CustCode) then begin
        foundf = false;
      end;
      testf = foundf;
      if (testf) then begin
        if ((blankdate(COr.endDate)) or (COr.endDate>CurrentDate)) then begin
          if ((COr.OKFlag!=0) and (COr.Accepted!=0)) then begin
            if (cofound) then begin
              /// What to do if another valid contract is found..
            end;
            RecordCopy(CO2r,COr);
            cofound = true;
          end;
        end;
      end;
    end;
  end;
  if (cofound==false) then begin
    RecordNew(CO2r);
    CO2r.CustCode = ORr.CustCode;
    if (PasteCust2InCO(CO2r,true,warning)) then begin
      CO2r.startDate = CurrentDate;
      CO2r.endDate = AddDay(CurrentDate,30);
      if (RecordStore(CO2r,false)) then begin end;
      cofound = true;
    end;
  end;
  if (cofound) then begin
    onlycontitems = true;
    RecordCopy(oldCOr,CO2r);
    rwcnt = MatRowCnt(ORr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(ORr,i,ORrw);
      INr.Code = ORrw.ArtCode;
      if (ReadFirstMain(INr,1,true)) then begin
        if (nonblank(INr.RentalItem)) then begin
          corwcnt = MatRowCnt(CO2r);
          postoplace = corwcnt;
          foundf = false;
          for (j=0;j<corwcnt;j=j+1) begin
            MatRowGet(CO2r,j,COrw);
            if (COrw.ArtCode==INr.RentalItem) then begin
              foundf = true;
              COrw.Quant = COrw.Quant + ORrw.Quant;
              postoplace = j;
              j = corwcnt;
            end;
          end;
          if (foundf==false) then begin
            ClearRow(CO2r,COrw,1);
            COrw.stp = 1;
            COrw.ArtCode = INr.RentalItem;
            COrw.OrgArtCode = ORrw.ArtCode;
            COrw.OrgSerNr = ORrw.SerialNr;
            COrw.Quant = ORrw.Quant;
            COrw.Type = "";
            if (GetItemPriceDiscount3(COrw.ArtCode,COrw.Quant,INr,CO2r.CurncyCode,
                                  CO2r.FrRate,CO2r.ToRateB1,CO2r.ToRateB2,CO2r.BaseRate1,CO2r.BaseRate2,
                                  CO2r.LangCode,CO2r.CustCat,CO2r.PriceList,CO2r.RebCode,
                                  price,curitemname,vreb,vatcode,baseprice,salesacc,
                                  CO2r.ExportFlag,calcpricef,CO2r.CODate,blankt,CO2r.CustCode,true,dummyf,CUr.PayDeal,tax2code,tax2prc,"","",taxtemplatecode)) then begin
              COrw.Price = price;
              COrw.Spec = curitemname;
              COrw.vRebate = vreb;
              COrw.VATCode = vatcode;
              COrw.BasePrice = baseprice;
              COrw.SalesAcc = salesacc;
              COrw.ArtCode = INr.Code;
              if (nonblank(CO2r.CustVATCode)) then begin COrw.VATCode = CO2r.CustVATCode; end;
              COrw.Contact = "";
              COrw.Objects = FindINObjects(INr.Objects,INr.Group);
              COrw.PriceFactor = INr.PriceFactor;
              foundf = true;
            end;
          end;
          if (foundf) then begin
            CalcSum(COrw.Quant,COrw.Price,COrw.PriceFactor,COrw.vRebate,t,GenOptr.UseDiscount);
            COrw.Sum = t;
            MatRowPut(CO2r,postoplace,COrw);
            if (calcpricef) then begin
              COVcGetCalcItemPrice(CO2r,postoplace,t);
            end;
          end;
        end else begin
          onlycontitems = false;
        end;
      end else begin
        onlycontitems = false;
      end;
    end;
    if (onlycontitems) then begin
      COSumup(CO2r);
      if (RecordUpdate(oldCOr,CO2r,true)==0) then begin
        RecordNew(SHr);
        if (RecordAction_raPasteOrdInShip(SHr,orderno,warning)==0) then begin
          if (SHr.OKFlag==0) then begin
            RecordCopy(oldSHr,SHr);
            SHr.OKFlag = 1;
            if (RecordUpdate(oldSHr,SHr,true)==0) then begin
              RecordNew(IVr);
              if (RecordAction_raPasteOrdInInv(IVr,orderno,true,errcode)==0) then begin
              end;
            end;
          end;
        end;
      end;
    end;
  end;
  return;
end;

global
updating procedure ToolWebHBSDivShopBasketStep2Complete(longint orderno)
begin
  string 20 langcode;
  record IVVc IVr;
  string 200 activcode;
  record CUVc CUr;
  boolean res;
  
  if (LoggedInHBSDivTest()) then begin
    langcode = GetWebLanguage; //Fine
    
    if (orderno<0) then begin
      ToolWebHBSShopBasket;
    end else begin
      IVr.OrderNr = orderno;
      if (ReadFirstKey("OrderNr",IVr,1,true)) then begin end;
      CUr.Code = CurrentCust;
      if (ReadFirstMain(CUr,1,true)==false) then begin
        CUr.Name = "";
      end;
      res = WebHBSDivPublicMain("WWWPREDONEINVOICE",langcode,-1,-1,false,false);
      if (nonblank(IVr.SerNr)) then begin
        WebOutString("<p><a href=""Javascript:void(0)"" onClick=""jsOpenReadMore('./WebCCPaymentInvoice.hal?WebCCPaymentInvoice.hal?invno=" & IVr.SerNr & "&ordno=" & orderno & "&ccnumber=" & right(WebGetArg("ccnumber"),4) & "&company=" & CurrentCompany & "','Item view','scrollbars=yes ,rezisable=yes,width=780,height=790')"">" & ToolWebReturnTheText(20197) & "</a></p>");  //invoice details
      end else begin
        WebOutString("<p><a href=""Javascript:void(0)"" onClick=""jsOpenReadMore('./WebStandardOrder.hal?WebCCPaymentInvoice.hal?ordno=" & orderno & "&ccnumber=" & right(WebGetArg("ccnumber"),4) & "&company=" & CurrentCompany & "','Item view','scrollbars=yes ,rezisable=yes,width=780,height=790')"">" & ToolWebReturnTheText(20196) & "</a></p>"); //order details
      end;
      res = WebHBSDivPublicMain("WWWAFTERDONEINVOICE",langcode,-1,-1,false,false);
      if (CreateContractFromOrder(CUr,orderno,activcode,langcode)) then begin
//          res = WebHBSDivPublicMain("WWWACTIVATIONCODE",langcode,-1,-1,false,false);
//          WebOutString("<p class=""bluefont"">" & activcode & "</p>");
      end;
    end;
  end;
end;

global
updating procedure WebHBSDivShopBasketStep2()
begin
  record WebHTMLVc WHr;
  LongInt orderno,invno;
  Boolean res;
  string 20 langcode;
  string 255 warning;
  integer err;
  record CUVc CUr;
  string 200 activcode;

  if (LoggedInHBSDivTest()) then begin
    langcode = GetWebLanguage; //Fine
    
    orderno = ToolWebStoreTheOrder2(invno,WebGetArg("CreditCardType"),true);

    if (orderno<0) then begin
      ToolWebHBSShopBasket;
    end else begin
//      UpdateHBSContract(orderno);
      err = CreateMailFromWebIV(invno,warning);
      LogText(0,"CreateMailFromWebIV return value = " & err);
      CUr.Code = CurrentCust;
      if (ReadFirstMain(CUr,1,true)==false) then begin
        CUr.Name = "";
      end;
      res = WebHBSDivPublicMain("WWWPREDONEINVOICE",langcode,-1,-1,false,false);
      WebOutString("<p><a href=""Javascript:void(0)"" onClick=""jsOpenReadMore('./WebCCPaymentInvoice.hal?WebCCPaymentInvoice.hal?invno=" & invno & "&ordno=" & orderno & "&ccnumber=" & right(WebGetArg("ccnumber"),4) & "&company=" & CurrentCompany & "','Item view','scrollbars=yes ,rezisable=yes,width=780,height=790')"">" & ToolWebReturnTheText(20197) & "</a></p>");
      res = WebHBSDivPublicMain("WWWAFTERDONEINVOICE",langcode,-1,-1,false,false);
      if (CreateContractFromOrder(CUr,orderno,activcode,langcode)) then begin
//          res = WebHBSDivPublicMain("WWWACTIVATIONCODE",langcode,-1,-1,false,false);
//          WebOutString("<p class=""bluefont"">" & activcode & "</p>");
      end;
    end;
  end;
end;

global
procedure WebHBSDivShopBasket()
begin
  record ORVc ORr;
  record CUVc CUr;
  Boolean res;
  Boolean proceedf;
  row ORVc ORrw;
  record INVc INr;
  Integer rwt;
  Integer rwcnt,i;
  string 255 linkargs;
  Boolean freightf;
  string 20 langcode;

  proceedf = false;
  if (LoggedInHBSDivTest()) then begin
  langcode = GetWebLanguage; //Fine
  CUr.Code = CurrentCust;
  if (ReadFirstMain(CUr,1,true)==false) then begin
    CUr.Name = "";
  end;
  res = BuildWebOrd(CurrentCust,-1,ORr,freightf,langcode);
  rwcnt = MatRowCnt(ORr);
  if (rwcnt>0) then begin proceedf = true; end;
  ToolWebHBSDivStartPage;
  ToolWebHBSDivSetMainTitle;
  ToolWebHBSDivStartBody("","");
  res = WebHBSDivPublicMain("WWWPRESHOPBASK",langcode,-1,-1,false,false);
  WebOutString("<table border=""0"" width=""100%"" align=""left"">");
  ToolWebLineStart;
  if (proceedf==true) then begin
    WebOutString("<td>");
    ToolWebHBSDivItemHeader(true);
    rwcnt = MatRowCnt(ORr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(ORr,i,ORrw);
      INr.Code = ORrw.ArtCode;
      if (ReadFirstMain(INr,1,true)==false) then begin
        INr.Unittext = "";
      end;
      linkargs = "company=" & WebGetArg("company") & "&langcode=" & langcode & "&itcode=" & WebGetArg("itcode") & "&itemcode=" & ORrw.ArtCode;
      ToolWebHBSDivDisplayItemLine(ORrw.ArtCode,linkargs,ORrw.Quant,INr.Unittext,ORrw.Spec,ORrw.vRebate,ORrw.Price,ORr.CurncyCode,ORrw.Sum,true,rwt);
      rwt = rwt + 1;
      if (rwt>1) then begin rwt = 0; end;
    end;
    ToolWebHBSDivListTableEnd;
    WebOutString("</td>");
    ToolWebLineEnd;
    ToolWebLineStart;
    WebOutString("<td>");
    ToolWebHBSDivListTable(3,0,"0");
    ToolWebLineStart;
    ToolWebHBSDivInfoCell(ToolWebReturnTheText(20104),"80%","right");
    ToolWebHBSDivInfoCell(ORr.Sum1,"20%","right");
    ToolWebLineEnd;
    ToolWebLineStart;
    ToolWebHBSDivInfoCell(ToolWebReturnTheText(20105),"80%","right");
    ToolWebHBSDivInfoCell(ORr.Sum3,"20%","right");
    ToolWebLineEnd;
    ToolWebLineStart;
    ToolWebHBSDivInfoCell(ToolWebReturnTheText(20106),"80%","right");
    ToolWebHBSDivInfoCell(ORr.Sum4,"20%","right");
    ToolWebLineEnd;
    if (nonblank(ORr.CurncyCode)) then begin
      ToolWebLineStart;
      ToolWebHBSDivInfoCell(ToolWebReturnTheText(20108),"80%","right");
      ToolWebHBSDivInfoCell(ORr.CurncyCode,"20%","right");
      ToolWebLineEnd;
    end;
    ToolWebHBSDivListTableEnd;
    WebOutString("</td>");
    ToolWebLineEnd;
    ToolWebLineStart;
    WebOutString("<td>");
    ToolWebHBSDivListTable(3,0,"0");
    WebOutString("<form name=""HansaForm"" method=""POST"" action=""");
    WebOutLink(ToolWebBuildLink("WebHBSDivShopBasketStep2.hal","&company=" & WebGetArg("company") & "&langcode=" & langcode & "&itemcode=" & WebGetArg("itemcode")));
    WebOutString(""">");
    ToolWebLineStart;
    WebOutString("<td align=""right"" bgcolor=""#FFFFFF"" valign=""top""><input type=""submit"" value=""" & ToolWebReturnTheText(20119) & """ name=""b1""></td>");
    ToolWebLineEnd;
    WebOutString("</form>");
    ToolWebHBSDivListTableEnd;
    WebOutString("</td>");
  end else begin
    ToolWebHBSDivInfoCell(ToolWebReturnTheText(20107),"100%","false");
  end;
  ToolWebLineEnd;
  WebOutString("</table>");
  if (proceedf==true) then begin
    res = WebHBSDivPublicMain("WWWAFTERSHOPBASK",langcode,-1,-1,false,false);
  end;
  ToolWebHBSThirdPart;
  ToolWebHBSDivEndPage;
  end;
  return;  
end;

global
procedure ToolWebHBSDivCustProdNew(string langcode)
begin
  string 60 mailboxcode;
  string 60 mailboxname;
  record CYBlock CYr;
  record WebHTMLVc WHr;
  record WebControlBlock WCr;
  record DIVc DIr;
  string 20 itcode;
  string 60 ckey;
  LongInt prevval,nextval,maxval;
  Boolean prevf,nextf,mainf;
  LongInt msernr,pages;
  Integer showmax;
  Integer oldcomp,newcomp;
  Boolean res,res1;

  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res1 = SetCompany(newcomp,false);
  end;
  BlockLoad(CYr);
  BlockLoad(WCr);
  
  msernr = WebGetArg("sernr");
  if (msernr==-1) then begin msernr = 0; end;
  itcode = WebGetArg("itcode");
  if (blank(itcode)) then begin
    mainf = true;
    ToolWebHBSGetDispGroup(CurrentCust,itcode);
  end;
  showmax = 50;
  WebOutString("<table border=""0"" width=""100%""><tr><td width=100% valign=top>");
  WebOutString("<table border=""0"" cellspacing=""0"" cellpadding=""1"">");

  ToolWebHBSGetDispGroup("",itcode);

  ToolWebHBSDivDispGroups(itcode,msernr,showmax,langcode);
  WebOutString("</table>");
  WebOutString("</td>");
  WebOutString("<td valign=top>");
  if (ToolWebItemHasPict(WHr,itcode,"BDG")==true) then begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end else begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end;
  ToolWebHBSThirdPart;
  if (res1) then begin
    ResetCompany(oldcomp);
  end;
  return;  
end;

global
procedure ToolWebHBSDivItemViewNew(string langcode)
begin
  record INVc INr;
  record CUVc CUr;
  record WebHTMLVc WHr;
  string 20 curitemno;
  string 100 curitemname;
  string 20 salesacc,vatcode,qtystr,tax2code,taxtemplatecode;
  val price,reb,cost,qty,instock,ordqty,tax2prc;
  Boolean calcprice;
  Boolean showstocklevel;
  Boolean showprices,dummyf;
  Integer rwt;
  Integer oldcomp,newcomp;
  Boolean res;
  Time blankt;
  
  oldcomp = CurrentCompany;
  newcomp = StringToInt(WebGetArg("company"));
  if ((newcomp>0) and (oldcomp!=newcomp)) then begin
    res = SetCompany(newcomp,false);
  end;
  rwt = 0;
  showstocklevel = false;
  showprices = true;
  curitemno = WebGetArg("itemcode");
  if (ToolWebGetCustAndSettings(CUr,showstocklevel,showprices)) then begin end;
  qty = 1;
  if (GetItemPriceDiscount3(curitemno,qty,INr,CUr.CurncyCode,0,0,0,0,0,
                  langcode,CUr.CustCat,CUr.PLCode,CUr.RebCode,
                  price,curitemname,reb,vatcode,cost,salesacc,
                  CUr.ExportFlag,calcprice,CurrentDate,blankt,CUr.Code,true,dummyf,CUr.PayDeal,tax2code,tax2prc,"","",taxtemplatecode)==false) then begin     
      INr.Name = "";
  end;
  
  if (showprices==false) then begin
    price = BlankVal;
  end;
  instock = GetStockQty(INr.Code,"",CurrentDate,false);
  qty = QtyInBasket(curitemno,0);
  qtystr = ValToString(qty,M4UVal," ",".",0);
  if (qtystr=="0") then begin
    qtystr = "";
  end;
  WebOutString("<table width=""100%"">");
  WebOutString("<tr><td>");
  if (ToolWebItemHasPict(WHr,curitemno,"BP")==true) then begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end else begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end;
  WebOutNL;
  WebOutString("</td></tr>");
  WebOutString("<tr><td>");
  WebOutNL;
  if (WebLoginStatus==3) then begin
    WebOutString("<form name=""HansaForm"" method=""POST"" action=""");
    WebOutLink(ToolWebBuildLink("WebHBSDivMainUpdate.hal","&function=" & "WebHBSDivStoreItem" & "&company=" & WebGetArg("company") & "&langcode=" & langcode & "&backnr=" & WebGetArg("backnr") & "&sernr=" & WebGetArg("sernr") & "&itemcode=" & curitemno & "&itcode=" & WebGetArg("itcode")));
    WebOutString(""">");
  end;
  if (showstocklevel) then begin
    ToolWebHBSDivListTable(7,0,"0");
    ToolWebLineStart;
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20096),"left","12%");
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20097),"center","10%");
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20098),"left","33%");
  end else begin
    ToolWebHBSDivListTable(6,0,"0");
    ToolWebLineStart;
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20096),"left","15%");
    ToolWebHBSDivTableHdr(ToolWebReturnTheText(20098),"left","38%");
  end;
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20099),"right","15%");
  ToolWebHBSDivTableHdr("","right","2%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20100),"left","13%");
  ToolWebHBSDivTableHdr(ToolWebReturnTheText(20091),"left","17%");
  ToolWebLineEnd;

  WebOutString("<tr height=32>");
  ToolWebHiddenField("backpage",WebGetArg("backpage"));
  if (showstocklevel) then begin
    ToolWebHBSDivTableData(curitemno,"","","left","12%","",rwt);
    ToolWebHBSDivTableData(instock,"","","center","10%","",rwt);
    ToolWebHBSDivTableData(curitemname,"","","left","33%","",rwt);
  end else begin
    ToolWebHBSDivTableData(curitemno,"","","left","15%","",rwt);
    ToolWebHBSDivTableData(curitemname,"","","left","38%","",rwt);
  end;
  ToolWebHBSDivTableData(price,"","","right","15%","",rwt);
  ToolWebHBSDivTableData("","","","right","2%","",rwt);
  ToolWebHBSDivEditFieldBrowse("ord_qty","text",qtystr,"7%",5,7,rwt);
  ToolWebHBSDivTableData(GetUnitText(INr.Unittext, langcode),"","","left","8%","",rwt); //WNS
  qtystr = ValToString(qty,M4UVal,"","",rwt);
  if (qtystr=="0") then begin
    qtystr = "";
  end;
  WebOutString("<td bordercolor=white width=""15%"" align=""left"" bgcolor=""white"">");

  if (WebLoginStatus==3) then begin
    if (nonblank(CurrentCust)) then begin
      ToolWebPushButton(ToolWebReturnTheText(20101),"submit","b1");
    end else begin
      ToolWebHBSDivTableData(ToolWebReturnTheText(20049),"WebHBSDivMain.hal","company=" & WebGetArg("company") & "&langcode=" & langcode,"left","8%","",rwt);
    end;
  end else begin
    ToolWebHBSDivTableData(ToolWebReturnTheText(20049),"WebHBSDivMain.hal","company=" & WebGetArg("company") & "&langcode=" & langcode,"left","8%","",rwt);
  end;

  WebOutString("</td>");
  ToolWebLineEnd;
  if (WebLoginStatus==3) then begin
    WebOutString("</form>");
  end;
  WebOutString("</table>");
  WebOutString("</td></tr>");
  ToolWebHBSDivListTableEnd;
  if (res) then begin
    ResetCompany(oldcomp);
  end;
  return;
end;

//WNS:end

global
updating procedure WebHBSDivStoreItem()
begin
  if (LoggedInHBSDivTest()) then begin
    ToolWebStoreTheItem;
    if (nonblank(WebGetArg("itcode"))) then begin
      ToolWebHBSDivCustProdNew(GetWebLanguage); // I am trying to get rid of GetWebLanguage in all normal places, langcode should be passed around....
    end else begin
      ToolWebHBSDivShopBasketNew(GetWebLanguage); // I am trying to get rid of GetWebLanguage in all normal places, langcode should be passed around....
    end;
  end;
  return;
end;

