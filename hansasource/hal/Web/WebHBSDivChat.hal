external function string 200 GetWebLanguage();
external procedure ToolWebLineStart();
external procedure ToolWebLineEnd();
external procedure ToolWebHBSDivStartDivClass(string);
external procedure ToolWebHBSDivEndDivClass(string);
external procedure ToolWebHBSDivSetMainWithTimeout(string,string);
external procedure ToolWebHBSDivStartPage();
external procedure ToolWebHBSDivStartBody(string,string);
external procedure ToolWebHBSDivEndPage();
external procedure ToolWebHBSDivSetMainTitle();
external procedure ToolWebHBSDivStartDiv(string);
external procedure ToolWebHBSDivEndDiv(string);
external procedure ToolWebStartTable();
external procedure ToolWebEndTable();
external function Boolean ToolWebHBSUseLink();
external function Boolean LoggedInHBSDivTest();
external function string 255 ToolWebBuildLink(string,string);

function Boolean LoggedInHBSDivChatTest()
begin
  Boolean res;
  
  if (WebLoginStatus==3) then begin
    res = true;
  end else begin
    res = false;
    ToolWebHBSDivStartPage;
    ToolWebHBSDivSetMainTitle;
    ToolWebHBSDivStartBody("chatText","chatstyle.css");
    WebOutString("<p class=""heading3"" align=""center"">Please Login for Chat</p>");
    ToolWebHBSDivEndPage;
  end;
  LoggedInHBSDivChatTest = res;
  return;
end;

procedure ShowChatText(LongInt chatid)
begin
  LongInt rwcnt,i;
  string 255 username;
  
  if (WebLoginStatus!=3) then begin
    ToolWebHBSDivStartDivClass("webusererrorchatarea");
    WebOutString("You are no longer logged in, please close this chat and login again.");
    ToolWebHBSDivEndDivClass("webusererrorchatarea");
  end;
  rwcnt = ChatTextRowCnt(chatid);
  for (i=rwcnt-1;i>=0;i=i-1) begin
    ToolWebHBSDivStartDivClass("chatnames");
    username = ChatGetUsrText(chatid,i);
    if (blank(username)) then begin
      username = "Unknown";
    end;
    WebOutString(username);
    ToolWebHBSDivEndDivClass("chatnames");
    ToolWebHBSDivStartDivClass("webuserchatarea");
    WebOutString(ChatGetTheText(chatid,i));
    ToolWebHBSDivEndDivClass("webuserchatarea");
  end;
/*
  if (WebLoginStatus!=3) then begin
    ToolWebHBSDivStartDivClass("webuserchatarea");
    WebOutString("You are no longer logged in, please close this chat and login again.");
    ToolWebHBSDivEndDivClass("webuserchatarea");
  end;
*/
  return;
end;

global
procedure WebChatTextFrame()
begin
  record ExtChatUsersVc ExtChatUserr;
  LongInt chatid;
  string 255 chattext;
  
  if (LoggedInHBSDivChatTest) then begin
    chattext = WebGetArg("chatText");
    chatid = WebGetArg("chatident");
    if (nonblank(chattext)) then begin
      ChatAddText(chatid,chattext);
    end;
    ToolWebHBSDivStartPage;
    ToolWebHBSDivSetMainTitle;
//    ToolWebHBSDivStartBody("","chatstyle.css");
    WebOutString("<link rel=""stylesheet"" href=""/lib/chatstyle.css"" type=""text/css"">");
    WebOutNL;
    WebOutString("<script language=""JavaScript"">");
    WebOutNL;
    WebOutString("function jsGoDown() {");
    WebOutNL;
    WebOutString("  location.href = ""#bottom"";");
    WebOutNL;
    WebOutString("}");
    WebOutNL;
    WebOutNL;
    WebOutString("</script>");
    WebOutNL;
    WebOutString("</head>");
    WebOutNL;
    WebOutString("<body onload=""jsGoDown();""");
    WebOutString(">");
    WebOutNL;

    WebOutString("<center>");
    ShowChatText(chatid);
    WebOutString("</center>");
    WebOutString("<a name=""bottom""/>");
    ExtChatUserr.IDNr = chatid;
/* chatid is the id of the chat, not the person....
    if (ReadFirstKey("IDNr",ExtChatUserr,1,true)) then begin
      if (UserOnline(ExtChatUserr.UserMailboxName)==false) then begin
        ToolWebHBSDivStartDivClass("webusererrorchatarea");
        WebOutString(ExtChatUserr.UserMailboxName & " has left the chat.");
        ToolWebHBSDivEndDivClass("webusererrorchatarea");
      end;
    end;
*/
    ToolWebHBSDivEndPage;
  end;
  return;
end;

global
procedure WebChatEntryFrame()
begin
  LongInt chatid;
  string 255 llink;
  string 20 langcode;

  if (LoggedInHBSDivChatTest) then begin
    langcode = GetWebLanguage; //Fine
    chatid = WebGetArg("chatident");
    ToolWebHBSDivStartPage;
    ToolWebHBSDivSetMainTitle;
    ToolWebHBSDivStartBody("chatText","chatstyle.css");
    ToolWebHBSDivStartDiv("mainchatbox");
    ToolWebHBSDivStartDiv("chatfield");
    WebOutString("<br />");
    WebOutString("<center>");
    WebOutString("<form name=""HansaForm"" method=""post"" style=""display: inline""  onSubmit=""top.ChatEntryFrame.location.reload();"" action=""");
    llink = ToolWebBuildLink("WebChatTextFrame.hal","&company=" & WebGetArg("company") & "&langcode=" & langcode & "&chatident=" & WebGetArg("chatident"));
    if (ToolWebHBSUseLink) then begin
      WebOutLink(llink);
    end else begin
      WebOutString(llink);
    end;
    WebOutString(""" target=""ChatFrame"">");
    WebOutString("<input type=""text"" name=""chatText"" style=""width: 350px"" maxlength=80/>");
    WebOutString("&nbsp;&nbsp;");
    WebOutString("<input type=""submit"" value=""Send/Refresh"">");
    WebOutString("</form>");

    WebOutString("</center>");

    ToolWebHBSDivEndDiv("chatfield");
    ToolWebHBSDivEndDiv("mainchatbox");

    ToolWebHBSDivEndPage;
  end;
  return;
end;

global
procedure WebHBSDivChatIndex()
begin
  string 20 langcode;

  if (LoggedInHBSDivChatTest) then begin
    langcode = GetWebLanguage; //Fine
    WebOutString("<!DOCTYPE html PUBLIC ""-//W3C//DTD XHTML 1.0 Frameset//EN"" ""http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"">");
    WebOutNL;
    WebOutString("<html xmlns=""http://www.w3.org/1999/xhtml"" xml:lang=""" & WebGetArg("language") & """ lang=""" & WebGetArg("language") & """>");
    WebOutNL;
    WebOutString("<head><title>HansaWorld Chat</title></head>");
    WebOutNL;
    WebOutString("<frameset rows=""*,50"" cols=""*"" frameborder=""NO"" border=""0"" framespacing=""0"">"); 
    WebOutNL;
    WebOutString("<frame src=""" & ToolWebBuildLink("WebChatTextFrame.hal","&company=" & WebGetArg("company") & "&langcode=" & langcode & "&chatident=" & WebGetArg("chatident")) & """ noresize marginwidth=""0"" marginheight=""0"" scrolling=""yes"" name=""ChatFrame"">");
    WebOutNL;
    WebOutString("<frame src=""" & ToolWebBuildLink("WebChatEntryFrame.hal","&company=" & WebGetArg("company") & "&langcode=" & langcode & "&chatident=" & WebGetArg("chatident")) & """ noresize marginwidth=""0"" marginheight=""0"" scrolling=""NO"" name=""ChatEntryFrame"">");
    WebOutNL;
    WebOutString("</frameset>");
    WebOutNL;
    WebOutString("<noframes><body bgcolor=""#FFFFFF"">");
    WebOutNL;
    WebOutString("</body></noframes>");
    WebOutNL;
    WebOutString("</html>");
    WebOutNL;
  end;
  return;
end;

global
procedure WebHBSDivChatInitiate()
begin
  record ExtChatUsersVc ExtChatUserr;
  string 20 langcode;
  LongInt chatid;
  
  if (LoggedInHBSDivChatTest) then begin
    if (WebGetArg("startchat")=="true") then begin
      ExtChatUserr.IDNr = WebGetArg("chatuserid");
      if (ReadFirstKey("IDNr",ExtChatUserr,1,true)) then begin
        langcode = GetWebLanguage; //Fine
        chatid = ChatCreate(ExtChatUserr.UserMailboxName);
        ToolWebHBSDivSetMainWithTimeout(0,ToolWebBuildLink("WebHBSDivChatIndex.hal","&company=" & WebGetArg("company") & "&langcode=" & langcode & "&chatident=" & chatid));
        ToolWebHBSDivStartPage;
        ToolWebHBSDivSetMainTitle;
        ToolWebHBSDivStartBody("chatText","chatstyle.css");
        WebOutString("<p class=""heading3"" align=""center"">Initiating</p>");
        ToolWebHBSDivEndPage;
      end;
    end;
  end;
  return;
end;

global
procedure WebHBSDivChat()
begin
  record ExtChatUsersVc ExtChatUserr;
  string 20 langcode;
  Boolean foundf;
  string 255 llink;
  
  if (LoggedInHBSDivChatTest) then begin
    WebOutString("<table width=""480""  border=""0"" cellspacing=""0"" cellpadding=""0"">");
    ExtChatUserr.Status = 1;
    foundf = true;
    while (LoopKey("Status",ExtChatUserr,1,foundf)) begin
      if (UserOnline(ExtChatUserr.UserMailboxName)) then begin
        langcode = GetWebLanguage; //Fine
        ToolWebLineStart;
        WebOutString("<td>");
        WebOutString("<a class=""listMenuLink"" href=javascript:jsOpenChat(""");
        llink = ToolWebBuildLink("WebHBSDivChatInitiate.hal","langcode=" & langcode & "&chatuserid=" & ExtChatUserr.IDNr & "&startchat=true");
        if (ToolWebHBSUseLink) then begin
          WebOutLink(llink);
        end else begin
          WebOutString(llink);
        end;
        WebOutString(""")>");
        WebOutString(ExtChatUserr.UserMailboxName);
        WebOutString("</a>");
        WebOutNL;
        WebOutString("</td>");
        WebOutString("<td class=""deftxt"">");
        WebOutString(ExtChatUserr.Comment);
        WebOutString("</td>");
        WebOutString("<td class=""deftxt"">");
        WebOutString(ExtChatUserr.Languages);
        WebOutString("</td>");
        WebOutString("<td class=""deftxt"">");
        WebOutString(ExtChatUserr.Country);
        WebOutString("</td>");
        ToolWebLineEnd;
      end;
    end;
    ToolWebEndTable;
  end;
  return;
end;

