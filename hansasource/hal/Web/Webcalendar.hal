external function Boolean GetGlobalUserMainCompany(string,var string);
external function Boolean LoggedInTest();
external procedure GetConfName(string,var string);
external procedure ToolWebStartPage();
external procedure ToolWebSetMainTitle();
external procedure ToolWebStartBody(string);
external procedure ToolWebStartHeader();
external procedure ToolWebOutHeader(string);
external procedure ToolWebStartHeaderEnd();
external procedure ToolWebLineStart();
external procedure ToolWebInfoCell(string,string,string);
external procedure ToolWebPushButton(string,string,string);
external procedure ToolWebLineEnd();
external procedure vTimeDiff(Time, Time, var val);
external function LongInt DateDiff(Date,Date);
external procedure ToolWebEndPage(Boolean);

global
procedure ToolWebDataLink2(string webname,string weblink,string webarg,string thealign,string thesize,string target,Integer rwt)
begin
  string 255 llink,tstr;
  string 20 bgcolr;
  string 20 localign;

  localign = thealign;
  if (blank(localign)) then begin
    localign = "left";
  end;

  WebOutString(tstr);
  if (nonblank(weblink)) then begin
    tstr = "<a";
    if (nonblank(target)) then begin
      tstr = tstr & " target =""" & target & """";
    end;
    tstr = tstr & " href=""";
    WebOutString(tstr);
    llink = weblink & "?sessionid=" & WebGetArg("sessionid");
    if (nonblank(webarg)) then begin
      llink = llink & "&" & webarg;
    end;
    WebOutLink(llink);
    WebOutString(""">");
  end; 
  WebOutNL;
  if (nonblank(webname)) then begin
    WebOutString(webname);
  end else begin
    WebOutString("&nbsp;");
  end;
L55:;
  if (nonblank(weblink)) then begin
    WebOutString("</a>");
  end;
  return;
end;

global
function Date CalStartDate(LongInt year)
begin
  record WeekVc Wkr;
  row WeekVc Wkrw;
  Date sdate;
  Integer rwcnt,i;
  
  sdate=CurrentDate;

  Wkr.CountryCode = "ENG";
  if (LoopMain(Wkr,1,true)) begin
    rwcnt = MatRowCnt(Wkr);
    for (i=0; i<rwcnt; i=i+1) begin
    	MatRowGet(Wkr,i,Wkrw);
 	if (Wkrw.Year==year) then begin
          sdate=Wkrw.FirstDayofW1;
          goto LYcToStr1;
        end;
    end;
  end;
  LYcToStr1:;  
  CalStartDate = sdate;
  return;
end;

global
function LongInt FindActWeek(LongInt year)
begin
  LongInt i;
  Date sdate;

  sdate=CalStartDate(year);
  i=DateDiff(CurrentDate,sdate);
  i=i/7;
  i=i+1;
  FindActWeek=i;
end;

procedure NewAct(date sdate)
begin
  string 255 linkarg; 

  WebOutString("<br>");
  linkarg = "&backnr=" & WebGetArg("backnr") & "&date_field=" & sdate &  "&mailnumber=-1&todof=0" & "&act_week=" &WebGetArg("act_week") & "&act_user=" &WebGetArg("act_user") & "&act_year=" &WebGetArg("act_year"); 
  ToolWebDataLink2("New Activity","WebRegAct.hal",linkarg,"left","","",0);
  WebOutNL;
 return;
end;

global
procedure MonthView(date sdate)
begin
  record DNMVc DNMr;
  date abi;

  DNMr.LangCode="ENG";
  if (LoopMain(DNMr,1,true)) begin
    WebOutString("<td width=133 align=center>");
    abi=sdate;
    WebOutString(DNMr.Monday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td><td width=133 align=center>");
    abi=AddDay(sdate,1);
    WebOutString(DNMr.Tuesday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td><td width=133 align=center>");
    abi=AddDay(sdate,2);
    WebOutString(DNMr.Wednesday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td><td width=133 align=center>");
    abi=AddDay(sdate,3);
    WebOutString(DNMr.Thursday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td><td width=133 align=center>");
    abi=AddDay(sdate,4);
    WebOutString(DNMr.Friday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td><td width=133 align=center>");
    abi=AddDay(sdate,5);
    WebOutString(DNMr.Saturday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("</td>");
  end;
 return;
end;

global
procedure LastMonthView(date sdate)
begin
  record DNMVc DNMr;
  date abi;

  DNMr.LangCode="ENG";
  if (LoopMain(DNMr,1,true)) begin
    ToolWebLineEnd;
    ToolWebLineStart;
    WebOutString("<td width=100% align=center>");
    WebOutString("<hr style=""width: 100%; height: 1px;"" noshade=""noshade"">");
    abi=sdate;
    abi=AddDay(sdate,6);
    WebOutString(DNMr.Sunday & ":");
    WebOutString(abi);
    NewAct(abi);  
    WebOutString("<hr style=""width: 100%; height: 1px;"" noshade=""noshade"">");
    WebOutString("</td>");
    ToolWebLineEnd;
    ToolWebLineStart;
  end;
 return;
end;

global
procedure ToolWebCalendarList(record RcVc RepSpec,string usercode,var val tottimev,var LongInt actcnt, LongInt act_week,String act_user,LongInt act_year)
begin
  record ActVc Actr;
  row ActVc Actrw;
  Boolean TrHs,testf,firstf;
  string 255 ckey;
  string 255 tstr;
  string 255 linkarg; 
  Date oldDate, abi, abi2;
  Time timet,blanktimet;
  val timev;
  Integer i,help,cnt;
  string 20 bgcolr;
  string 60 compcode;
  Integer oldcomp;
  
  oldcomp = CurrentCompany;
  if (GetGlobalUserMainCompany(CurrentUser,compcode)) then begin
    if (nonblank(compcode)) then begin
      if (SetCompanyCode(compcode,false)) then begin
      end;
    end;
  end;

  firstf = false;
  Actr.OKFlag = 0;
  Actr.TransDate = RepSpec.sStartDate;
  abi2=Actr.TransDate;
  if (RepSpec.flags[2]==0) then begin
    Actr.OKFlag = 1;  
  end;
  help=0;
  oldDate = AddDay(RepSpec.sStartDate,-1);   
  Actr.TodoFlag = 0;
  ckey = "UserMain:";
  ckey = ckey & usercode;
  TrHs = true;
  actcnt=0;
  cnt=0;
  while (LoopKey(ckey,Actr,1,TrHs)) begin
    if (Actr.TodoFlag!=0) then begin TrHs = false; end;
    testf = false;
    if (TrHs) then begin
      testf = true;
      if (DateInRange(Actr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin testf = false; end;
      if (Actr.Invalid!=0) then begin testf = false; end;
      if (Actr.PrivateFlag!=0) then begin
        if ((SetInSet(CurrentUser,Actr.MainPersons)==false) and
            (SetInSet(CurrentUser,Actr.CCPersons)==false)) then begin
          testf = false;
        end;
      end;
      if (testf) then begin
        actcnt=1;
        if (oldDate!=Actr.TransDate) begin
          if (help!=0) then begin     
            WebOutString("</table></td>");
          end; 
          abi=AddDay(oldDate,1);
          while (abi!=Actr.TransDate) begin
            help=help+1;
            if (help==6) then begin
              WebOutString("<td><table cellpadding=""0"" cellspacing=""0"" border=""0"" width=100%><tr>");
            end;
            WebOutString("<td><br>");
            WebOutString("</td>");
            if (help==7) then begin
              WebOutString("</tr>");
            end;
            abi=AddDay(abi,1);
          end;
          help=help+1;
          if (help==6) then begin
            WebOutString("<td><table cellpadding=""0"" cellspacing=""0"" border=""0"" width=100%><tr>");
          end;
          if (help==7) then begin
            LastMonthView(abi2);
          end;
          WebOutString("<td valign=""top"" align=""left""><table cellpadding=""0"" cellspacing=""0"" border=""0"">");
          tstr = "";
//          WebOutString("<br>");  
        end;
        tstr = Mid(Actr.StartTime,0,5);
/*
        switch (cnt) begin
          case 0: bgcolr = "#DFDFDF"; cnt = 1;
	  case 1: bgcolr = "#FFFFFF"; cnt = 0;
        end;
*/
        WebOutString("<tr><td width=100% bgcolor="""& bgcolr &""">");
    	WebOutString(tstr&"-");
        if ((nonblankdate(Actr.EndDate)) and (Actr.TransDate!=Actr.EndDate)) then begin
          WebOutString("***");
          WebOutString("<br>");  
        end else begin
          tstr = Mid(Actr.EndTime,0,5);
          WebOutString(tstr);
          WebOutString("<br>");
        end;
        linkarg = "&mailnumber=" & Actr.SerNr & "&stime=" & Actr.StartTime & "&todof=" & Actr.TodoFlag & "&user=" & usercode & "&date_field=" & Actr.TransDate & "&act_week=" & act_week & "&act_user=" & act_user & "&act_year=" & act_year;
        ToolWebDataLink2(Actr.Comment,"WebRegAct.hal",linkarg,"left","","",0);
        WebOutString("<br>");  
        timet = blanktimet;
        if (Actr.CalTimeFlag==1) then begin
          if (nonblanktime(Actr.CostTime)) then begin
            vTimeDiff(timet,Actr.CostTime,timev);
          end else begin
            vTimeDiff(Actr.EndTime,Actr.StartTime,timev);
          end;  
          tottimev = tottimev + timev;
        end;
        if (Actr.OKFlag!=0) then begin
          WebOutString("");
        end;
/*
        if (RepSpec.ArtMode==1) then begin
          WebOutString(Actr.ActType);
          WebOutString("<br>");  
          WebOutString(Actr.ActResult);
          WebOutString("<br>");  
        end;        
*/
        WebOutString("</td></tr>");
	    oldDate = Actr.TransDate;
        actcnt = actcnt + 1;
      end;
    end;    
  end;
  if (help==7) then begin
    WebOutString("</table></td></tr></table></td>");
  end;
  if (help==6) then begin
    WebOutString("</table></td>");
    LastMonthView(abi2);
    WebOutString("<td><br></td></tr></table></td>");
  end;
  if ((help>=1) and (help<=5)) then begin
    WebOutString("</table></td>");
    for (i=help; i<=4; i=i+1) begin
      WebOutString("<td><br></td>");
    end;
    WebOutString("<td><table cellpadding=""0"" cellspacing=""0"" border=""0"" width=100%><tr><td><br></td>");
    LastMonthView(abi2);
    WebOutString("<td><br></td></tr></table></td>");
  end;
  if (help==0) then begin
    WebOutString("<td><br></td><td><br></td><td><br></td><td><br></td><td><br></td><td><table cellpadding=""0"" cellspacing=""0"" border=""0"" width=100%><tr><td><br></td>");
    LastMonthView(abi2);
    WebOutString("<td><br></td></tr></table></td>");
  end;
  ResetCompany(oldcomp);
  return;
end;

global
procedure WebCalendar()
begin
  record RcVc RepSpec;
  record UserVc Userr;
  record WebControlBlock WCr;
  string 255 seltuser,confname;
  string 60 confcode,ckey;
  LongInt msernr,prevval,nextval,maxval,pages,actcnt,year,wnr,selted,selted2;
  val tottimev;
  Integer showmax,i,j;
  Date sdate;
  Boolean foundf,prevf,nextf;

  if (LoggedInTest()) then begin
    BlockLoad(WCr);
    msernr = WebGetArg("sernr");
    if (msernr==-1) then begin msernr = 0; end;
    confcode = WebGetArg("confcode");
    if (blank(confcode)) then begin confcode = "0"; end;
    GetConfName(confcode,confname);
    showmax = 10;
    if (WCr.MatLines>0) then begin
      showmax = WCr.MatLines;
    end;
    ckey = "SubConfAddrName:" & confcode;
  
    prevf = true;
    nextf = true;
    prevval = msernr-showmax;
    if (prevval<0) then begin 
      prevval = 0;
      prevf = false;
    end;
    nextval = msernr+showmax;
    maxval = RecordsInIndex("ConfVc",ckey);
    if (nextval>maxval) then begin
      nextval = msernr;
      nextf = false;
    end;
    pages=maxval/showmax;
    if ((pages*showmax)!=maxval) then begin
      pages=pages+1;
    end; 
    ToolWebStartPage;
    ToolWebSetMainTitle;
    ToolWebStartBody("act_text");
    ToolWebStartHeader;
    ToolWebOutHeader("Calendar");
    ToolWebStartHeaderEnd;
    
    year=GetYear(CurrentDate);
    seltuser=WebGetArg("act_user");
    selted=WebGetArg("act_week");
    selted2=WebGetArg("act_year");
 
    if (selted<1) then begin
      selted2=year;
      selted=FindActWeek(year); 
      seltuser=CurrentUser;
    end; 
    WebOutString("<center><table border=""1px"" cellpadding=""0"" cellspacing=""0"" width=798>");
    ToolWebLineStart;  
    WebOutString("<form name=""HansaForm"" method=""POST"" action=""");
    WebOutLink("WebCalendar.hal?sessionid=" & WebGetArg("sessionid") & "&backnr=" & WebGetArg("backnr"));
    WebOutString(""">");
    WebOutString("<td><table><tr>");
    ToolWebInfoCell("ID:","50","right");
    WebOutString("<td><select name=act_user>");
    foundf = true;
    Userr.Code = "";
    while(LoopKey("Code",Userr,1,foundf)) begin
      if (foundf) then begin
        WebOutString("<option");
        if (Userr.Code==seltuser) then begin
          WebOutString(" selected");
        end;
        WebOutString(" value=""" & Userr.Code & """>" & Userr.Code & "</option>");
      end;
    end;
    WebOutString("</select></td>");
    ToolWebInfoCell("Week:","50","right");
    WebOutString("<td><select name=act_week>");
    for (j=1; j<52; j=j+1) begin
      WebOutString("<option");
      if (j==selted) then begin
        WebOutString(" selected");
      end;
      WebOutString(" value=""" & j & """>" & j & "</option>");
    end;
    WebOutString("</select></td>");
    ToolWebInfoCell("Year:","50","right");
    WebOutString("<td><select name=act_year>"); 
    for (j=year-3; j<year+2; j=j+1) begin
      WebOutString("<option");
      if (j==selted2) then begin
        WebOutString(" selected");
      end;
      WebOutString(" value=""" & j & """>" & j & "</option>");
    end;
    WebOutString("</select></td>");
    WebOutString("<td colspan=2 align=right>");
    ToolWebPushButton("Find","submit","b1");
    WebOutString("</td></tr></table></td>");
    WebOutString("</form>");
    WebOutString("</tr></table></center>");

    WebOutString("<center><table border=""1px"" cellpadding=""1"" cellspacing=""0"" width=798>");
    actcnt = 0;
    wnr=selted;
    year=selted2;
    RepSpec.f1=seltuser;
    sdate=CalStartDate(year);
    wnr=wnr*7-7;
    RepSpec.sStartDate = AddDay(sdate,wnr);     
    wnr=wnr+6;
    RepSpec.sEndDate = AddDay(sdate,wnr);     
    ToolWebLineStart; 
    MonthView(RepSpec.sStartDate);
    ToolWebLineEnd;
    ToolWebLineStart; 
    ToolWebCalendarList(RepSpec,RepSpec.f1,tottimev,actcnt,selted,seltuser,selted2);
    ToolWebLineEnd;
    WebOutString("</table></center>");
   
    ToolWebEndPage(true);
  end;
  return;
end;
