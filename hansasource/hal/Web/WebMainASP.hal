// WebMainASP.hal

external procedure ToolWebOutHeader(string);
external procedure ToolWebLineStart();
external procedure ToolWebLineEnd();
external function Boolean LoggedInTest();
external function Boolean ToolWebItemHasPict(var record WebHTMLVc,string,string);
external procedure ToolWebDisplayHTMLExtra(record WebHTMLVc,string,string);
external procedure ToolWebViewShopList(record ORVc);
external procedure ToolWebGetDispGroup(string,var string);
external procedure ToolWebInfoCell(string,string,string);
external procedure WebStartNavBar();
external procedure WebEndNavBar();
external procedure FindUserMailboxName(string,var string,var string);
external procedure DoHttpReport();
external procedure ToolWebHiddenField(string,string);
external procedure WebEditField(string,string,string,string,Integer,Integer);
external procedure ToolWebPushButton(string,string,string);
external procedure ToolWebMenuItem(string,string,string,string,var Integer);
external procedure WebNavLink(string,string,string,string);
external procedure ToolWebSetMainTitle();
external procedure ToolWebStartPage();
external procedure ToolWebStartBody(string);
external procedure ToolWebEndPage(Boolean);
external procedure ToolWebStartTable();
external procedure ToolWebEndTable();
external procedure ToolWebStartHeader();
external procedure WebLink(string,string,string,string);
external procedure ToolWebListTable(Integer,Integer,string);
external procedure ToolWebListTableEnd();
external procedure ToolWebTableHdr(string,string,string);
external procedure ToolWebStartHeaderEnd();
external procedure WebMenuItemNoSess(string,string,string);
external procedure ToolWebOutHeaderBegin(string);
external procedure ToolWebOutHeaderEnd();
external procedure WebLeadText(string,string);
external procedure WebLeadText2(string,string);
external procedure ToolWebDispGroups(string,LongInt,Integer);
external procedure DisplaySearchResult(string,Integer,string,string,string,LongInt);
external procedure ToolWebTableData(string,string,string,string,string,string,Integer);
external procedure WebEditFieldBrowse(string,string,string,string,Integer,Integer,Integer);
external procedure ToolWebListAR(string,LongInt,Integer,var val,Boolean);
external procedure WebPublicConf(string,LongInt,Boolean);
external function Boolean ToolWebGetCustAndSettings(var record CUVc,var Boolean,var Boolean);
external function val QtyInBasket(String,Integer);
external procedure ToolWebRadioButtonDiv(string,string,Integer,Boolean);

Function
Boolean UserExistsInCompany(string usercode,Integer compnr)
begin
  record UserVc USr;
  Boolean res;

  res = false;
  if (SetCompany(compnr,false)) then begin
    USr.Code = usercode;
    if (ReadFirstMain(USr,1,true)) then begin
      res = true;
    end;
  end;
  UserExistsInCompany = res;
  return;
end;

global
procedure WebMainASPBureau()
begin
  string 60 mailboxcode;
  string 60 mailboxname;
  record WebHTMLVc WHr;
  string 20 itcode;
  Integer rwt;
  record CompaniesBlock CPr;
  row CompaniesBlock CPrw;
  Integer i,rwcnt;
  Integer oldcomp;

  oldcomp = CurrentCompany;  
  if (LoggedInTest()) then begin
  BlockLoad(CPr);
  FindUserMailboxName(CurrentUser,mailboxcode,mailboxname);
  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("");
  ToolWebStartHeader;
  ToolWebOutHeader("ASP Main Menu");
  ToolWebStartHeaderEnd;
  
  rwt = 0;
  WebOutString("<table width=""100%""><tr><td width=180 valign=top>");
  ToolWebStartTable;
  rwcnt = MatRowCnt(CPr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(CPr,i,CPrw);

//    if (UserExistsInCompany(CurrentUser,i+1)) then begin
      ToolWebMenuItem(CPrw.CompName,"WebBureauLogin.hal","compcode=" & i+1,"",rwt); // SetCompany does it on company LINE
//    end;
  end;
  ToolWebMenuItem("Logout","WebDoLogout.hal","","",rwt);
  ToolWebEndTable;
  WebOutString("</td>");
  WebOutString("<td valign=top>");
  if (ToolWebItemHasPict(WHr,CurrentUser,"USERHOME")==true) then begin
    WebOutString("<tr><td>");
    ToolWebDisplayHTMLExtra(WHr,"","");
    WebOutString("</td></tr>");
  end else begin
    ToolWebDisplayHTMLExtra(WHr,"","");
  end;
  WebOutString("</td></tr></table>");
  ToolWebEndPage(true);
  ResetCompany(oldcomp);
  end;
  return;  
end;

global
procedure WebBureauLogin()
begin
  Integer oldcomp;
  Integer newcomp;
  Boolean res;

  oldcomp = CurrentCompany;  
  newcomp = StringToInt(WebGetArg("compcode"));
  if ((newcomp<1) or (newcomp>99)) then begin
    newcomp = 1;
  end;
  if (blank(WebGetArg("firstlogin"))) then begin
//    WebLogOut;
  end;
  res = SetCompany(newcomp,false);
  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("login");
  ToolWebStartHeader;
  ToolWebOutHeader("Login");
  ToolWebStartHeaderEnd;
  WebOutString("<form name=""HansaForm"" action=""dologin?company=" & newcomp & """ METHOD=""POST"">");
  WebOutNL;
  WebOutString("<table cellspacing=""0"" cellpadding=""0"" border=""0"" width=""200"">");
  ToolWebLineStart;
  ToolWebInfoCell("User ID","100","left");
  WebOutNL;
  WebEditField("login","text","","90",15,20);
  ToolWebLineEnd;
  ToolWebLineStart;
  ToolWebInfoCell("Password","100","left");
  WebOutNL;
  WebEditField("passwd","password","","90",15,32);
  WebOutNL;
  if (nonblank(WebGetArg("firstlogin"))) then begin
    ToolWebHiddenField("userpage","WebMainASPBureau.hal");
  end else begin
    ToolWebHiddenField("userpage","WebMainUser.hal");
  end;
  WebOutNL;
  ToolWebHiddenField("custpage","WebMainCust.hal"); // Shouldn't be allowed in...
  WebOutNL;
  ToolWebLineEnd;
  WebOutString("</table>");
  ToolWebPushButton("Log In","submit","name");
  WebOutString("</form>");
  ToolWebEndPage(true);
  ResetCompany(oldcomp);
  return;
end;

global
procedure WebClientLogin()
begin
  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("compcode");
  ToolWebStartHeader;
  ToolWebOutHeader("Login");
  ToolWebStartHeaderEnd;
  WebOutString("<form name=""HansaForm"" action=""dologinasp"" METHOD=""POST"">");
  WebOutNL;
  WebOutString("<table cellspacing=""0"" cellpadding=""0"" border=""0"" width=""200"">");
  ToolWebLineStart;
  ToolWebLineStart;
  ToolWebInfoCell("User ID","100","left");
  WebOutNL;
  WebEditField("login","text","","90",15,20);
  ToolWebLineEnd;
  ToolWebLineStart;
  ToolWebInfoCell("Password","100","left");
  WebOutNL;
  WebEditField("passwd","password","","90",15,32);
  WebOutNL;
  ToolWebHiddenField("userpage","WebMainUser.hal");
  WebOutNL;
  ToolWebHiddenField("custpage","WebMainCust.hal");
  WebOutNL;
  ToolWebLineEnd;
  WebOutString("</table>");
  ToolWebPushButton("Log In","submit","name");
  WebOutString("</form>");
  ToolWebEndPage(true);
  return;
end;

// Since FirstOffice ASP is a specific product, it will replace the Hansa WebMain in some neat way.
global
procedure WebMain()
begin
  record CYBlock CYr;
  record WebControlBlock WCr;
  string 60 confname;
  LongInt maxmail;
  string 60 itcode;
  Integer rwt;
  Integer oldcomp;
  Boolean res;

  oldcomp = CurrentCompany;  
  res = SetCompany(1,false);
  BlockLoad(CYr);
  BlockLoad(WCr);
  confname = WebGetArg("confname");
  maxmail = WebGetArg("maxmail");
  if (maxmail==-1) then begin
    maxmail = "10";
  end;
  if (blank(confname)) then begin
    confname = WCr.WebStartConf;
    maxmail = WCr.WebStartConfNr;
  end;
  ToolWebStartPage;
  ToolWebSetMainTitle;
  ToolWebStartBody("");
  ToolWebStartHeader;
  ToolWebOutHeader("Welcome to " & CYr.CompName);
  ToolWebStartHeaderEnd;
  
  rwt = 0;
  WebOutString("<table width=""100%""> <tr> <td width=180 valign=top>");
  ToolWebStartTable;

  ToolWebGetDispGroup("",itcode);
  ToolWebMenuItem("Login for Bureau","WebBureauLogin.hal","compcode=1&firstlogin=1","",rwt);
  ToolWebMenuItem("Login for Clients","WebClientLogin.hal","","",rwt);

  ToolWebMenuItem("News","WebMain.hal","confname=" & WCr.NewsConf & "&maxmail=" & WCr.NewsConfNr,"",rwt);
  ToolWebMenuItem("Terms & Conditions","WebMain.hal","confname=" & WCr.TermsConf & "&maxmail=" & WCr.TermsConfNr,"",rwt);
  ToolWebMenuItem("Company Info","WebMain.hal","confname=" & WCr.CompInfoConf & "&maxmail=" & WCr.CompInfoConfNr,"",rwt);
  ToolWebMenuItem("Partners & Investors","WebMain.hal","confname=" & WCr.PartnersConf & "&maxmail=" & WCr.PartnersConfNr,"",rwt);
  ToolWebMenuItem("Contact Us","WebMain.hal","confname=" & WCr.ContactUsConf & "&maxmail=" & WCr.ContactUsConfNr,"",rwt);
  ToolWebMenuItem("FAQ","WebMain.hal","confname=" & WCr.FAQConf & "&maxmail=" & WCr.FAQConfNr,"",rwt);
  ToolWebMenuItem("Help","WebMain.hal","confname=" & WCr.HelpConf & "&maxmail=" & WCr.HelpConfNr,"",rwt);
  ToolWebEndTable;
  WebOutString("</td><td valign=top>");
  WebPublicConf(confname,maxmail,false);
  WebOutString("</td></tr></table>");
  ToolWebEndPage(true);
  ResetCompany(oldcomp);
  return;
end;

