remote procedure slRestAccHALRemote(string,var Array string,var LongInt);
external procedure SplitEclass(string,var Array string);
remote procedure RestAccPriceLookup_PasteArtCode(var record SoftFVc,Integer,record LocalMachineBlock);
//external function Boolean RestAccPriceLookpup_PasteArtCodeFromLocalIN(var record SoftFVc,Integer,record LocalMachineBlock);

global 
function Boolean RestAccPriceLookupDClassArtCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
begin  
  record SoftFVc RestAccPLr;
  Boolean found;
  record LocalMachineBlock LMb;
  
  if (changedf) then begin
    GetWindowRecord(wn,RestAccPLr);
    BlockLoad(LMb);
//    found = RestAccPriceLookpup_PasteArtCodeFromLocalIN(RestAccPLr,rownr,LMb);
    if (found==false) then begin
      RestAccPriceLookup_PasteArtCode(RestAccPLr,rownr,LMb);
    end;
    PutWindowRecord(wn,RestAccPLr);      
  end;
  RestAccPriceLookupDClassArtCodeEFAfter = true;
  return;
end;

global
function Boolean RestAccPriceLookupDClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
  Boolean res;

  switch (fieldname) begin
    case "ArtCode": res = RestAccPriceLookupDClassArtCodeEFAfter(wn,rownr,changed!=0);
  end;
  RestAccPriceLookupDClassAfterEditField = res;
  return;
end;  

global
procedure RestAccPriceLookupPasteItem(string artcode)
BEGIN
  Integer wn,rownr;
  record INVc INr;
  record SoftFVc RestAccPLr;
  row SoftFVc RestAccPLrw;
  Boolean testf,found;
  Integer i,rwcnt;
  record LocalMachineBlock LMb;

  wn = CurWindow;
  GetWindowRecord(wn,RestAccPLr);
/*  
  INr.Code = artcode;
  if (ReadFirstMain(INr,1,true)==false) then begin 
    goto LRestAccPriceLookupPasteItem;
  end;
*/  
  rownr = WindowActiveRow(wn);
  testf = true;
  WindowDeactivateField(wn);
  if (testf) then begin
    if (rownr>=0) then begin
      GetWindowRecord(wn,RestAccPLr);  
      MatRowGet(RestAccPLr,rownr,RestAccPLrw);
      if (nonblank(artcode)) then begin
        if (artcode!=RestAccPLrw.ArtCode) then begin
          testf = false;
        end;
      end;
      if (testf) then begin
        RestAccPLrw.Quant = RestAccPLrw.Quant + 1;
        MatRowPut(RestAccPLr,rownr,RestAccPLrw);
        PutWindowRecord(wn,RestAccPLr);  
        WindowFieldGoto(wn,RestAccPLr,rownr,"Quant",true);
        goto LRestAccPriceLookupPasteItem;
      end;
    end;
  end;
  if (nonblank(artcode)) then begin
    GetWindowRecord(wn,RestAccPLr);  
    rwcnt = MatRowCnt(RestAccPLr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(RestAccPLr,i,RestAccPLrw);
      if (blank(RestAccPLrw.ArtCode)) then begin
        rownr = i;
        goto L55RestAccPriceLookupPasteItem;
      end;
    end;
    rownr = rwcnt;
L55RestAccPriceLookupPasteItem:;  
    BlockLoad(LMb);
    ClearRow(RestAccPLr,RestAccPLrw,1);
    RestAccPLrw.ArtCode = artcode;
    MatRowPut(RestAccPLr,rownr,RestAccPLrw);
//    found = RestAccPriceLookpup_PasteArtCodeFromLocalIN(RestAccPLr,rownr,LMb);
    if (found==false) then begin
      RestAccPriceLookup_PasteArtCode(RestAccPLr,rownr,LMb);
    end;
    PutWindowRecord(wn,RestAccPLr);  
    WindowFieldGoto(wn,RestAccPLr,rownr,"Quant",true);
  end;
LRestAccPriceLookupPasteItem:;
  return;
end;

global
procedure RestAccPriceLookupToolKeyPadAdd()
begin
  Integer wn,rownr;
  record INVc INr;
  record SoftFVc RestAccPLr;
  row SoftFVc RestAccPLrw;
  Boolean testf,found;
  Integer i,rwcnt;
  record LocalMachineBlock LMb;

  wn = CurWindow;
  if (WindowActiveField(wn)=="Quant") then begin testf = true; end;
  if (WindowActiveField(wn)=="Price") then begin testf = true; end;
  if (ReadMarkedRecord(wn,INr)) then begin 
  end;
  WindowDeactivateField(wn);
  if (testf) then begin
    rownr = WindowActiveRow(wn);
    if (rownr>=0) then begin
      GetWindowRecord(wn,RestAccPLr);  
      MatRowGet(RestAccPLr,rownr,RestAccPLrw);
      if (nonblank(INr.Code)) then begin
        if (INr.Code!=RestAccPLrw.ArtCode) then begin
          testf = false;
        end;
      end;
      if (testf) then begin
        RestAccPLrw.Quant = RestAccPLrw.Quant + 1;
        MatRowPut(RestAccPLr,rownr,RestAccPLrw);
        PutWindowRecord(wn,RestAccPLr);  
        goto LRestAccPriceLookupToolKeyPadAdd;
      end;
    end;
  end;
  if (nonblank(INr.Code)) then begin
    GetWindowRecord(wn,RestAccPLr);  
    rwcnt = MatRowCnt(RestAccPLr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(RestAccPLr,i,RestAccPLrw);
      if (blank(RestAccPLrw.ArtCode)) then begin
        rownr = i;
        goto L55RestAccPriceLookupToolKeyPadAdd;
      end;
    end;
    rownr = rwcnt;
L55RestAccPriceLookupToolKeyPadAdd:;  
    BlockLoad(LMb);
    ClearRow(RestAccPLr,RestAccPLrw,1);
    RestAccPLrw.ArtCode = INr.Code;
    MatRowPut(RestAccPLr,rownr,RestAccPLrw);
//    found = RestAccPriceLookpup_PasteArtCodeFromLocalIN(RestAccPLr,rownr,LMb);
    if (found==false) then begin
      RestAccPriceLookup_PasteArtCode(RestAccPLr,rownr,LMb);
    end;
    PutWindowRecord(wn,RestAccPLr);  
    WindowFieldGoto(wn,RestAccPLr,rownr,"Quant",true);
  end;
LRestAccPriceLookupToolKeyPadAdd:;  
  return;
end;  

global 
procedure slRestAccPriceLookupHAL(Integer wn)
begin
  record SoftFVc RestAccPLr;
  Array string 255 anames;
  LongInt i,acnt;
  string 255 tstr;

  acnt = 0;
  ClearStringList(wn);
  slRestAccHALRemote(GetWindowSubset(wn),anames,acnt);
  for (i=0;i<acnt;i=i+1) begin
    tstr = anames[i];
    SetListString(wn,len(tstr),tstr,false);
  end;  
  PutWindowRecord(wn,RestAccPLr);
  return;
end;

global
function string 40 RestAccPriceLookupITDefault(string tstr)
begin
  string 40 lsubset;
  record LocalMachineBlock LMr;
  record MainStockBlock MSb;
  record DIVc DIr;
  
//  lsubset = RestAccITDefaultRemote(tstr,CurMachineName);
  BlockLoad(LMr);
  if (nonblank(LMr.DefRestDisp)) then begin
    lsubset = LMr.DefRestDisp;
  end else begin
    BlockLoad(MSb);
    if (nonblank(MSb.StartClass)) then begin
      lsubset = MSb.StartClass;
    end else begin
      DIr.Code = "";
      if (LoopMain(DIr,1,true)) then begin
        lsubset = DIr.Code;
      end;
    end;
  end;
  RestAccPriceLookupITDefault = lsubset;
  return;
end;

global
procedure RestAccPriceLookupToolUp()
begin
  record SoftFVc RestAccPLr;
  record DIVc DIr;
  Array string 20 ac;
  string 255 lsubset;
  Integer wn;

  wn = CurWindow;
  GetWindowRecord(wn,RestAccPLr);
  DIr.Code = GetWindowSubset(wn);
  if (ReadFirstMain(DIr,1,true)) then begin
    SplitEclass(DIr.DispGroups,ac);
    SetWindowSubset(wn,ac[0]);
    if (blank(GetWindowSubset(wn))) then begin
      lsubset = RestAccPriceLookupITDefault("");
      SetWindowSubset(wn,lsubset);      
    end;
  end;
  slRestAccPriceLookupHAL(wn);
  UpdateBrowses("INVc");
  PutWindowRecord(wn,RestAccPLr);
  RETURN;
END;  

global
procedure RestAccPriceLookupToolFileDesktop()
begin
  record SoftFVc RestAccPLr;
  Integer wn;
  string 255 lsubset;

  wn = CurWindow;
  GetWindowRecord(wn,RestAccPLr);
  lsubset = RestAccPriceLookupITDefault("");
  SetWindowSubset(wn,lsubset);      
  slRestAccPriceLookupHAL(wn);
  UpdateBrowses("INVc");
  PutWindowRecord(wn,RestAccPLr);
  return;
end;

global
function Boolean RestAccPriceLookupDClassRLClick(Integer wn,Integer rownr)
begin
  record INVc INr;

  RestAccPriceLookupToolKeyPadAdd;
  RestAccPriceLookupDClassRLClick = true;
  return;
end;
