external updating procedure VerifoneBanksys_Purchase(val,string,string,Integer);
remote procedure PausedPOInvoices(string,var array record IVCashVc);
remote procedure ORPasteNPTSSClassRemote(string,var record IVCashVc);
remote procedure QTPasteNPTSSClassRemote(string,var record IVCashVc);
external updating procedure OpenStdCCWindow(integer);
external procedure GetAROnAccAcc(string,var string);
external procedure AddInvoiceLineType(Integer,Integer ,Boolean);
external procedure RowCalculateTaxMatrix_IVVc(var record IVVc,Integer,row IVVc);
external procedure RowCalculateTaxMatrix_RestAccVc(var record RestAccVc,Integer,row RestAccVc);
remote function Boolean SerialNrForOneItem(string,var record SerBalVc);
external updating function Boolean GSXResellerAutoEnrollmentIVCash(record GSXSettingsBlock,string,record IVCashVc,Integer,var string);
external updating function Boolean GSXResellerCancelAutoEnrollmentIVCash(record GSXSettingsBlock,string,record IVCashVc,Integer,var string);
external updating function boolean GSXResellerLogin(string,string,string,var string,var string);
external function integer GetSelectedPOSItemRowIndex(integer);
external function Boolean GSXResellerWarrantyStatusIVCash(string,record IVCashVc,Integer,array string,integer,var record SVOSerVc,var record NotepadVc,var record NotepadVc,var string);
external procedure IVCashLastSPrsm();
external updating procedure CreateMailFromIVCashDsm();
external procedure OpenCashDrawer_IVCashVc(record IVCashVc);
external function val AbsoluteVal(val);
external procedure WindowFieldGotoForTouchScreen(Integer,Integer,string,Boolean);
remote procedure IVVc_PasteInvDate(var record IVVc,record LocalMachineBlock,var Integer,var Integer);
remote procedure PasteIVCashInvDate(integer,var record  IVCashVc);
external procedure IVDClassTouchScreenMainSerialNrExecute(LongInt);
external procedure OpenCashDrawer();
external procedure RowCalculateTaxMatrix_IVCashVc(var record IVCashVc,Integer,row IVCashVc);
external function Boolean IVCashDchrsum(record IVCashVc,Integer,Integer);
external procedure IVCashDchsum(record IVCashVc,Integer);
external function Boolean GetPMRow(string,var row PMBlock);
external function Boolean IVDchrsum(var record IVVc,Integer);
external procedure IVDchsum(var record IVVc,Integer);
remote procedure NPTSPaymentPasteAmounts_IVVc(var record IVVc,Array string,Array string,Array Integer,Array string,Array val,Array string,Array string,Integer);
remote procedure LoyaltyPointsPayment_IVVc(var record IVVc,val,string);
remote function Integer IVVc_PasteGiftCertificate(var record IVVc,Integer,Integer);
external function Boolean IVVc_PasteQuantity(var record IVVc,Integer);
external procedure IVDClass_RefreshStringList(Integer,record IVVc);
external procedure IVSumup(var record IVVc,Boolean);
external procedure IVVc_PasteLoyaltyCardNr(var record IVVc,record LocalMachineBlock);
external function Boolean srlRestAccLPrint(var record RestAccVc,string,string);
external procedure RestAccDchsum(record RestAccVc,Integer);
external function Boolean RestAccDchrsum(var record RestAccVc,Integer,Integer);
remote function val GetServiceCharge(var record RestAccVc,record LocalMachineBlock,Boolean);
external procedure FindCCAccountID(string,string,Integer,var record CCAccountIDVc,Integer);
external procedure CancelAndOverrideLogout();
external procedure NPTSSearchItemOnceMore();
remote function Boolean IVCashVc_PasteQuant(var record IVCashVc,Integer);
external procedure SetPOSWindowDisplayAmount(string,val);
remote procedure RestAccVc_PasteLoyaltyCardNr(var record RestAccVc);
remote procedure NPTSPaymentPasteAmounts_RestAccVc(var record RestAccVc,Array string,Array string,Array Integer,Array string,Array val,Array string,Array string,Integer);
remote function Integer TestOpenOnHotelGuestTouchScreenOClass(record RcVc,var string,var string);
external procedure RestAccDClass_RefreshStringList(Integer,record RestAccVc);
remote procedure RestAccSumup(var record RestAccVc,string);
external procedure RestAccSumupSoftEditFields(Integer,record RestAccVc);
external function Boolean IVCashPrintReceipt(Integer,var record IVCashVc,record IVCashVc,Integer,Boolean,Boolean,Integer,Integer);
external procedure CashPayTouchScreenKeypad();
remote procedure LoyaltyPointsPayment_IVCashVc(var record IVCashVc,val,string);
remote function Integer IVCashVc_PasteGiftCertificate(var record IVCashVc,Integer,Integer);
remote function Integer SCDiscountCardExecuteRemote(var record IVCashVc,record RcVc);
remote function Boolean IVCashVc_PasteQuant(var record IVCashVc,Integer);
external procedure CntPOSCurrencies(var Array string,var Array Boolean,var Integer);
external procedure IVCashDClass_RefreshStringList(Integer,record IVCashVc);
remote function Boolean GetFullCurncyPurchaseRate(var string,Date,var val,var val,var val,var val,var val);
remote procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
remote procedure NPTSPaymentPasteAmounts(var record IVCashVc,Array string,Array string,Array Integer,Array string,Array val,Array string,Array string,Integer);
remote procedure CntNPTSPaymentCurrenciesRemote(string,var Array string,var Array string,var Array Integer,var Array string,var Integer);
external procedure IVCashSumupSoftEditFields(Integer,record IVCashVc);
external procedure SetPOSWindowDisplay(string,string);
external procedure M4PadString(string,Integer,string,Boolean,var string);
remote procedure IVCashSumup(var record IVCashVc,Boolean);
remote procedure IVCashVc_PasteLoyaltyCardNr(var record IVCashVc);
external function Integer OpenCCPayWindow(string,longint,integer,val,val,val,string,string,
                          integer,integer,
                          integer,string,date,string,string,
                          integer,string,
                          string,string,string,string,string,string,string,string,
                          string,string,string,string,string,string,
                          string,Integer);
external procedure PCEftpos_Transaction_Request(Integer,val,val,Boolean,string,string,string);
external procedure Bambora_Transaction_Request(Integer,val,val,Boolean,string,string,string,string,val,string,val);
external procedure Bambora_Cancel_Request(Integer);
remote procedure IVVc_PasteSalesMan(var record IVVc,string);

global 
procedure SelectHWStoreWClass()
begin
  Integer wn;
  
  if (IsStandardProduct) then begin
    wn = FindWindow("HWStoreWClass");
    if (wn>0) then begin
      SelectWindow(wn);
    end;
  end;
  return;
end;

global
procedure SetPOSWindowDisplay_PaymentRow(string spec,val v)
begin
  string 255 tstr;
  
  if (v<0) then begin
    tstr = USetStr(24193) & "   " & ValToString(-v,M4Val,ThousandSeparator,DecimalSeparator,0);
    SetPOSWindowDisplay(spec,tstr);
  end else begin
    tstr = USetStr(24193) & "   " & ValToString(0.00,M4Val,ThousandSeparator,DecimalSeparator,0);
    SetPOSWindowDisplay("",tstr);
  end;
  return;
end;

/*
procedure 
begin
  record RcVc RepSpec;
  Integer nwn;
  
  nwn = OpenWindow("CCPayDClass",0,mwn,"","",RepSpec);
  DeselectWindow(nwn,false);
  RepSpec.long1 = recordnr;
  RepSpec.long2 = rownr;
  RepSpec.vals0 = amount;
  RepSpec.vals3 = taxamount;
  RepSpec.vals4 = freightamount;
  RepSpec.f2 = cardnumber;
  RepSpec.f3 = comment;
  if (blank(RepSpec.f3)) then begin
    RepSpec.f3 = recordnr;
  end;
  RepSpec.f5 = authcode;
  RepSpec.f6 = transid;
  RepSpec.f8 = filename;
  RepSpec.ArtMode = paymentnr;
  RepSpec.flags[0] = txtype;
  RepSpec.flags[1] = lcardholdertype;
  RepSpec.CurncyCode = curncy;
  RepSpec.f9 = carddata;

  if (TouchScreenInterface) then begin
    RepSpec.flags[10] = 1;
  end else begin
    RepSpec.flags[10] = 0;
  end;
  RepSpec.flags[11] = newrowstp;
  RepSpec.f7 = newrowpmcode;
  return;
end;
*/
  
global
updating procedure ProceedCCPayTouchScreenDClass()
begin
  Integer wn,mwn,nwn;
  record RcVc RepSpec;
  record IVVc orgIVr;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  record IVCashVc orgIVCashr;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  val from,to1,to2,base1,base2;
  string 255 crncy,transid,cardnumber;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;
  record LocalMachineBlock LMb;
  Integer wnst,txtype;
  record CCAccountIDVc CCAccountIDr;  
  record CCMerchantIDVc CCMerchantIDr;  
  Date blankd;
  integer i,rwcnt,cardholdertype;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
            if (IVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
        end;
        BlockLoad(LMb);
        if (AbsoluteVal(IVr.Sum4)<AbsoluteVal(RepSpec.vals0)) then begin
          CloseWindow(wn);
          MessageBox(20878,"");
          WindowFieldGoto(wn,IVr,-1,"vals0",true);
          goto LProceedCCPayTouchScreenDClass;
        end;
        if (LMb.CCRequireAuthCode!=0) then begin
          if (blank(RepSpec.f1)) then begin
            MessageBox(1058,"");
            WindowFieldGoto(wn,RepSpec,-1,"f1",true);
            goto LProceedCCPayTouchScreenDClass;
          end;
        end;
        if (IVr.OKFlag!=0) then begin
          IVr.OKFlag = 0;
        end;
        txtype = kCardTransactionPay;
        FindCCAccountID(RepSpec.CurncyCode,LMb.LocalMachineCode,kCCAccountTypePOS,CCAccountIDr,kCardHolderPresent);
        CCMerchantIDr.Code = CCAccountIDr.MerchantID;
        ReadFirstMain(CCMerchantIDr,1,true);
        if (CCMerchantIDr.Partner==kCCPartnerAuthorizeNetCHPresent) then begin
          CloseWindow(wn);
          if (WindowDoOK(mwn,0)) then begin
            ReRunWindowDef(mwn);
            GetWindowRecord(mwn,IVr);
            if (RepSpec.vals0<0) then begin
              txtype = kCardTransactionRefund;
              rwcnt = MatRowCnt(IVr);
              for (i=0;i<rwcnt;i=i+1) begin
                MatRowGet(IVr,i,IVrw);
                if (IVrw.stp==kInvoiceRowTypeCredit) then begin
                  i = rwcnt;
                end;
              end;
              orgIVr.SerNr = IVrw.OrdRow;
              if (ReadFirstMain(orgIVr,1,true)) then begin
                rwcnt = MatRowCnt(orgIVr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(orgIVr,i,IVrw);
                  if (IVrw.stp==kInvoiceRowTypeCreditCardPayment) then begin
                    cardnumber = IVrw.CreditCard;
                    transid = IVrw.CCTransID;
                    i = rwcnt;
                  end;
                end;
              end;
            end;
            nwn = OpenCCPayWindow("IVVc",IVr.SerNr,-1,RepSpec.vals0,0,0,RepSpec.CurncyCode,IVr.InvComment,
                          txtype,-1,kCardHolderPresent,cardnumber,blankd,"",transid,
                          kInvoiceRowTypeCreditCardPayment,RepSpec.AccStr,
                          "","","","","","","","",
                          "","","","","","",
                          "",mwn);
          end;
          goto LProceedCCPayTouchScreenDClass;
        end;
        if (CCMerchantIDr.Partner==kCCPartnerPCEftpos or CCMerchantIDr.Partner==kCCPartnerBambora) then begin
          if (WindowDoOK(mwn,0)) then begin
            ReRunWindowDef(mwn);
            GetWindowRecord(mwn,IVr);
            if (RepSpec.vals0<0) then begin
            //  goto LProceedCCPayTouchScreenDClass;
            end;
            if (CCMerchantIDr.Partner==kCCPartnerPCEftpos) then begin
              PCEftpos_Transaction_Request(wn,0.00,RepSpec.vals0,false,CCAccountIDr.KEY,IVr.SerNr,CCAccountIDr.KEY2);
            end else begin
              Bambora_Transaction_Request(wn,0.00,RepSpec.vals0,false,CCAccountIDr.KEY,IVr.SerNr,CCAccountIDr.KEY2,RepSpec.CurncyCode,RepSpec.vals2,"IVVc",IVr.Sum4);
            end;
          end;
          goto LProceedCCPayTouchScreenDClass;
        end;
    
        ClearRow(IVr,IVrw,kInvoiceRowTypeCreditCardPayment);
        IVrw.stp = kInvoiceRowTypeCreditCardPayment;
        IVrw.Sum = RepSpec.vals0;
        IVrw.PayMode = RepSpec.AccStr;
        IVrw.Spec = RepSpec.f6;
        IVrw.AuthorizationCode = RepSpec.f1;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,IVr.TransDate,from,to1,to2,base1,base2);
        IVrw.CurncyCode = crncy;
        IVrw.FrRate = from;
        IVrw.ToRateB1 = to1;
        IVrw.ToRateB2 = to2;
        IVrw.BaseRate1 = base1;
        IVrw.BaseRate2 = base2;  
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
        IVSumup(IVr,true);
        PutWindowRecord(mwn,IVr);
        WindowFieldGoto(wn,IVr,-1,"touchscreenitem",true);
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
        end;
        BlockLoad(LMb);
        if (AbsoluteVal(IVCashr.Sum4)<AbsoluteVal(RepSpec.vals0)) then begin
          CloseWindow(wn);
          MessageBox(20878,"");
          WindowFieldGoto(wn,IVCashr,-1,"vals0",true);
          goto LProceedCCPayTouchScreenDClass;
        end;
        if (LMb.CCRequireAuthCode!=0) then begin
          if (blank(RepSpec.f1)) then begin
            MessageBox(1058,"");
            WindowFieldGoto(wn,RepSpec,-1,"f1",true);
            goto LProceedCCPayTouchScreenDClass;
          end;
        end;
        if (IVCashr.OKFlag!=0) then begin
          IVCashr.OKFlag = 0;
        end;
        txtype = kCardTransactionPay;
//        FindCCAccountID(RepSpec.CurncyCode,LMb.LocalMachineCode,kCCAccountTypePOS,CCAccountIDr,kCardHolderPresent);
        FindCCAccountID(RepSpec.CurncyCode,LMb.LocalMachineCode,kCCAccountTypePOS,CCAccountIDr,kCardHolderAny);
//jjchnotp        
        CCMerchantIDr.Code = CCAccountIDr.MerchantID;
        ReadFirstMain(CCMerchantIDr,1,true);
        if (CCMerchantIDr.Partner==kCCPartnerAuthorizeNetCHPresent or
            CCMerchantIDr.Partner==kCCPartnerAuthorizeNetCHNotPresent or
            CCMerchantIDr.Partner==kCCPartnerStripe or
            CCMerchantIDr.Partner==kCCPartnerElavonCHNotPresent or
            CCMerchantIDr.Partner==kCCPartnerElavonCHPresent) then begin
          CloseWindow(wn);
          if (WindowDoOK(mwn,0)) then begin
            ReRunWindowDef(mwn);
            GetWindowRecord(mwn,IVCashr);
            if (RepSpec.vals0<0) then begin
              txtype = kCardTransactionRefund;
              rwcnt = MatRowCnt(IVCashr);
              for (i=0;i<rwcnt;i=i+1) begin
                MatRowGet(IVCashr,i,IVCashrw);
                if (IVCashrw.stp==kInvoiceRowTypeReturnIVNr) then begin
                  i = rwcnt;
                end;
              end;
              orgIVCashr.SerNr = IVCashrw.OrgIVNr;
              if (ReadFirstMain(orgIVCashr,1,true)) then begin
                rwcnt = MatRowCnt(orgIVCashr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(orgIVCashr,i,IVCashrw);
                  if (IVCashrw.stp==kInvoiceRowTypeCreditCardPayment) then begin
                    cardnumber = IVCashrw.CreditCard;
                    transid = IVCashrw.CCTransID;
                    i = rwcnt;
                  end;
                end;
              end;
            end;
            if (CCMerchantIDr.Partner==kCCPartnerAuthorizeNetCHPresent or CCMerchantIDr.Partner==kCCPartnerElavonCHPresent) then begin
              cardholdertype = kCardHolderPresent;
            end;
            if (CCMerchantIDr.Partner==kCCPartnerAuthorizeNetCHNotPresent or CCMerchantIDr.Partner==kCCPartnerStripe or CCMerchantIDr.Partner==kCCPartnerElavonCHNotPresent) then begin
              cardholdertype = kCardHolderNotPresent;
            end;
            nwn = OpenCCPayWindow("IVCashVc",IVCashr.SerNr,-1,RepSpec.vals0,0,0,RepSpec.CurncyCode,IVCashr.InvComment,
                          txtype,-1,cardholdertype,cardnumber,blankd,"",transid,
                          kInvoiceRowTypeCreditCardPayment,RepSpec.AccStr,
                          "","","","","","","","",
                          "","","","","","",
                          "",mwn);
          end;
          goto LProceedCCPayTouchScreenDClass;
        end;
        
        if (CCMerchantIDr.Partner==kCCPartnerPCEftpos or CCMerchantIDr.Partner==kCCPartnerBambora) then begin
          if (WindowDoOK(mwn,0)) then begin
            ReRunWindowDef(mwn);
            GetWindowRecord(mwn,IVCashr);
            if (RepSpec.vals0<0) then begin
//              goto LProceedCCPayTouchScreenDClass;
            end;
            if (CCMerchantIDr.Partner==kCCPartnerPCEftpos) then begin
              PCEftpos_Transaction_Request(wn,0.00,RepSpec.vals0,false,CCAccountIDr.KEY,IVCashr.SerNr,CCAccountIDr.KEY2);
            end else begin
              Bambora_Transaction_Request(wn,0.00,RepSpec.vals0,false,CCAccountIDr.KEY,IVCashr.SerNr,CCAccountIDr.KEY2,RepSpec.CurncyCode,RepSpec.vals2,"IVCashVc",IVCashr.Sum4);
            end;
          end;
          goto LProceedCCPayTouchScreenDClass;
        end;
    
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeCreditCardPayment);
        IVCashrw.stp = kInvoiceRowTypeCreditCardPayment;
        IVCashrw.Sum = RepSpec.vals0;
        IVCashrw.PayMode = RepSpec.AccStr;
        IVCashrw.Spec = RepSpec.f6;
        IVCashrw.AuthorizationCode = RepSpec.f1;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,IVCashr.TransDate,from,to1,to2,base1,base2);
        IVCashrw.CurncyCode = crncy;
        IVCashrw.FrRate = from;
        IVCashrw.ToRateB1 = to1;
        IVCashrw.ToRateB2 = to2;
        IVCashrw.BaseRate1 = base1;
        IVCashrw.BaseRate2 = base2;  
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        IVCashSumup(IVCashr,true);
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCCPayTouchScreenDClass;
            end;
        end;
        if (RestAccr.Sum4<RepSpec.vals0) then begin
          CloseWindow(wn);
          MessageBox(20878,"");
          WindowFieldGoto(wn,RestAccr,-1,"vals0",true);
          goto LProceedCCPayTouchScreenDClass;
        end;
        
        ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeCreditCardPayment);
        RestAccrw.stp = kInvoiceRowTypeCreditCardPayment;
        RestAccrw.Sum = RepSpec.vals0;
        RestAccrw.PayMode = RepSpec.AccStr;
        RestAccrw.Spec = RepSpec.f6;
        RestAccrw.AuthorizationCode = RepSpec.f1;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,RestAccr.TransDate,from,to1,to2,base1,base2);
        RestAccrw.CurncyCode = crncy;
        RestAccrw.FrRate = from;
        RestAccrw.ToRateB1 = to1;
        RestAccrw.ToRateB2 = to2;
        RestAccrw.BaseRate1 = base1;
        RestAccrw.BaseRate2 = base2;  
        MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
        RestAccSumup(RestAccr,"");
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
          SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetValue);
          OpenCashDrawer;
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
          OpenCashDrawer_IVCashVc(IVCashr);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
          SetPOSWindowDisplayAmount(USetStr(27350),RestAccr.Sum4-RestAccr.TendValue);
          OpenCashDrawer;
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedCCPayTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedChequePayTouchScreenDClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
            if (IVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
        end;
        if (IVr.OKFlag!=0) then begin
          IVr.OKFlag = 0;
        end;
        
        ClearRow(IVr,IVrw,kInvoiceRowTypeChequePayment);
        IVrw.stp = kInvoiceRowTypeChequePayment;
        IVrw.Sum = RepSpec.vals0;
        IVrw.PayMode = RepSpec.AccStr;
        IVrw.Spec = RepSpec.f6;
        IVrw.CheckNr = RepSpec.f1;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
        PutWindowRecord(mwn,IVr);
        WindowFieldGoto(wn,IVr,-1,"touchscreenitem",true);
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
        end;
        if (IVCashr.OKFlag!=0) then begin
          IVCashr.OKFlag = 0;
        end;
        
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeChequePayment);
        IVCashrw.stp = kInvoiceRowTypeChequePayment;
        IVCashrw.Sum = RepSpec.vals0;
        IVCashrw.PayMode = RepSpec.AccStr;
        IVCashrw.Spec = RepSpec.f6;
        IVCashrw.CheckNr = RepSpec.f1;
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedChequePayTouchScreenDClass;
            end;
        end;
        ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeChequePayment);
        RestAccrw.stp = kInvoiceRowTypeChequePayment;
        RestAccrw.Sum = RepSpec.vals0;
        RestAccrw.PayMode = RepSpec.AccStr;
        RestAccrw.Spec = RepSpec.f6;
        RestAccrw.CheckNr = RepSpec.f1;
        MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
        RestAccSumup(RestAccr,"");
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
          SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetValue);
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedChequePayTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedGiftVoucherTouchScreenDClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  record GCSVc GCSr;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;
  Boolean found;
  record DefCashBlock DCb;
  row PMBlock PMrw;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    GCSr.BarCode = RepSpec.f1;
    found = ReadFirstKey("BarCode",GCSr,1,true);
    if (found==false) then begin    
      GCSr.SerNr = StringToLongInt(RepSpec.f1);
      found = ReadFirstMain(GCSr,1,true);
    end;
    if (found==false) then begin    
      MessageBox(2184,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedGiftVoucherTouchScreenDClass;
    end;
    if (GCSr.ExpiryDate<CurrentDate) then begin 
      MessageBox(2185,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedGiftVoucherTouchScreenDClass;
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
            if (IVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
        end;
        BlockLoad(DCb);
        ClearRow(IVr,IVrw,kInvoiceRowTypeGiftVoucherPayment);
        IVrw.stp = kInvoiceRowTypeGiftVoucherPayment;
        IVrw.Sum = RepSpec.vals0;
        if (IVrw.Sum>GCSr.Balance) then begin
          IVrw.Sum = GCSr.Balance;
        end;
        IVrw.VATCode = DCb.DefGCSVATCode;          
        IVrw.PayMode = RepSpec.AccStr;
        if (GetPMRow(IVrw.PayMode,PMrw)) then begin end;
        IVrw.SalesAcc = PMrw.AccNr;
        IVrw.Spec = RepSpec.f6;
        IVrw.GCNr = GCSr.SerNr;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
        IVSumup(IVr,true);
        PutWindowRecord(mwn,IVr);
        WindowFieldGoto(wn,IVr,-1,"touchscreenitem",true);
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
        end;
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeGiftVoucherPayment);
        IVCashrw.stp = kInvoiceRowTypeGiftVoucherPayment;
        IVCashrw.Sum = RepSpec.vals0;
        if (IVCashrw.Sum>GCSr.Balance) then begin
          IVCashrw.Sum = GCSr.Balance;
        end;
        IVCashrw.PayMode = RepSpec.AccStr;
        IVCashrw.Spec = RepSpec.f6;
        IVCashrw.GCNr = GCSr.SerNr;
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        IVCashSumup(IVCashr,true);
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherTouchScreenDClass;
            end;
        end;
        ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeGiftVoucherPayment);
        RestAccrw.stp = kInvoiceRowTypeGiftVoucherPayment;
        RestAccrw.Sum = RepSpec.vals0;
        if (RestAccrw.Sum>GCSr.Balance) then begin
          RestAccrw.Sum = GCSr.Balance;
        end;
        RestAccrw.PayMode = RepSpec.AccStr;
        RestAccrw.Spec = RepSpec.f6;
        RestAccrw.GCNr = GCSr.SerNr;
        MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
        RestAccSumup(RestAccr,"");
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
          SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetValue);
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedGiftVoucherTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedGiftVoucherSalesTouchScreenDClass()
begin
  Integer wn,mwn,rownr,err,i;
  record RcVc RepSpec;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  record IVCashVc curIVCashr;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  record GCVc GCr;
  record GCSVc GCSr;
  record GCTypeVc GCTr;
  Boolean found;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    GCr.SerNr = StringToLongInt(RepSpec.f1);
    found = ReadFirstMain(GCr,1,true);
    if (found==false) then begin    
      GCr.BarCode = RepSpec.f1;
      found = ReadFirstKey("BarCode",GCr,1,true);
    end;
    if (found==false) then begin    
      MessageBox(2184,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedGiftVoucherSalesTouchScreenDClass;
    end;
    GCSr.SerNr = GCr.SerNr;
    if (ReadFirstMain(GCSr,1,true)) then begin
      MessageBox(2186,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedGiftVoucherSalesTouchScreenDClass;
    end;
    if (GCr.ExpiryDate<CurrentDate) then begin 
      MessageBox(2185,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedGiftVoucherSalesTouchScreenDClass;
    end;
    if (nonblank(GCr.Type)) then begin
      GCTr.Code = GCr.Type;
      ReadFirstMain(GCTr,1,true);
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
            if (IVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
        end;
        rownr = MatRowCnt(IVr);
        ClearRow(IVr,IVrw,kInvoiceRowTypeGiftVoucherSold);
        IVrw.stp = kInvoiceRowTypeGiftVoucherSold;
        IVrw.GCNr = GCr.SerNr;
        IVrw.PayMode = RepSpec.AccStr;
        if (nonblank(GCTr.PayMode)) then begin
          IVrw.PayMode = GCTr.PayMode;
        end;
        MatRowPut(IVr,rownr,IVrw);
        err = IVVc_PasteGiftCertificate(IVr,rownr,kInvoiceRowTypeGiftVoucherSold);
        if (err!=0) then begin
          MessageBox(err,"");
          CloseWindow(wn);
          goto LProceedGiftVoucherSalesTouchScreenDClass;
        end;
        PutWindowRecord(mwn,IVr);
        WindowFieldGoto(wn,IVr,-1,"touchscreenitem",true);
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        curIVCashr = IVCashr;
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
        end;
        rownr = MatRowCnt(IVCashr);
        for (i=0;i<rownr;i=i+1) begin
          MatRowGet(IVCashr,i,IVCashrw);
          if (IVCashrw.stp==kInvoiceRowTypeGiftVoucherSold) then begin
            if (GCr.SerNr==IVCashrw.GCNr) then begin
              MessageBox(2186,"");
              CloseWindow(wn);
              goto LProceedGiftVoucherSalesTouchScreenDClass;
            end;
          end;
        end;            
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeGiftVoucherSold);
        IVCashrw.stp = kInvoiceRowTypeGiftVoucherSold;
        IVCashrw.GCNr = GCr.SerNr;
        IVCashrw.PayMode = RepSpec.AccStr;
        if (nonblank(GCTr.PayMode)) then begin
          IVCashrw.PayMode = GCTr.PayMode;
        end;
        MatRowPut(IVCashr,rownr,IVCashrw);
        err = IVCashVc_PasteGiftCertificate(IVCashr,rownr,kInvoiceRowTypeGiftVoucherSold);
        if (err!=0) then begin
          MessageBox(err,"");
          CloseWindow(wn);
          goto LProceedGiftVoucherSalesTouchScreenDClass;
        end;
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
      end;
    end else begin
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
      end;
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedGiftVoucherSalesTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedOnAccountPaymentTouchScreenDClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  Boolean found;
  record DefCashBlock DCb;
  row PMBlock PMrw;
  string 255 crncy;
  val from,to1,to2,base1,base2;
  record CUVc CUr;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOnAccountPaymentTouchScreenDClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedOnAccountPaymentTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOnAccountPaymentTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedOnAccountPaymentTouchScreenDClass;
            end;
        end;
        CUr.Code = IVCashr.CustCode;
        ReadFirstMain(CUr,1,true);
        if (CUr.OnAccount==0) then begin
          MessageBox(1200,"");
          CloseWindow(wn);
          goto LProceedOnAccountPaymentTouchScreenDClass;
        end;
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeOnAccountPayment);
        IVCashrw.stp = kInvoiceRowTypeOnAccountPayment;
        GetAROnAccAcc(IVCashr.CustCode,IVCashrw.SalesAcc);
        IVCashrw.Sum = RepSpec.vals0;
        IVCashrw.PayMode = RepSpec.AccStr;
        IVCashrw.CurncyCode = RepSpec.CurncyCode;
        IVCashrw.Spec = RepSpec.f6;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,IVCashr.TransDate,from,to1,to2,base1,base2);
        IVCashrw.CurncyCode = crncy;
        IVCashrw.FrRate = from;
        IVCashrw.ToRateB1 = to1;
        IVCashrw.ToRateB2 = to2;
        IVCashrw.BaseRate1 = base1;
        IVCashrw.BaseRate2 = base2;  
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedOnAccountPaymentTouchScreenDClass:;  
  return;
end;


global
updating function Boolean GiftVoucherSalesTouchScreenDClassOnOKWindow(Integer wn)
begin
  boolean res;

  ProceedGiftVoucherSalesTouchScreenDClass;
  GiftVoucherSalesTouchScreenDClassOnOKWindow = res;
  return;
end;

global
updating procedure ProceedCashPayTouchScreenDClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  val from,to1,to2,base1,base2;
  string 255 crncy;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVVc":
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        if (IVCashr.OKFlag!=0) then begin
          IVCashr.OKFlag = 0;
        end;
        
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeCashPayment);
        IVCashrw.stp = kInvoiceRowTypeCashPayment;
        IVCashrw.Sum = RepSpec.vals0;
        IVCashrw.PayMode = RepSpec.AccStr;
        IVCashrw.Spec = RepSpec.f6;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,IVCashr.TransDate,from,to1,to2,base1,base2);
        IVCashrw.CurncyCode = crncy;
        IVCashrw.FrRate = from;
        IVCashrw.ToRateB1 = to1;
        IVCashrw.ToRateB2 = to2;
        IVCashrw.BaseRate1 = base1;
        IVCashrw.BaseRate2 = base2;  
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGoto(wn,IVCashr,-1,"touchscreenitem",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
                
        ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeCreditCardPayment);
        RestAccrw.stp = kInvoiceRowTypeCashPayment;
        RestAccrw.Sum = RepSpec.vals0;
        RestAccrw.PayMode = RepSpec.AccStr;
        RestAccrw.Spec = RepSpec.f6;
        crncy = RepSpec.CurncyCode;
        GetFullCurncyRate(crncy,RestAccr.TransDate,from,to1,to2,base1,base2);
        RestAccrw.CurncyCode = crncy;
        RestAccrw.FrRate = from;
        RestAccrw.ToRateB1 = to1;
        RestAccrw.ToRateB2 = to2;
        RestAccrw.BaseRate1 = base1;
        RestAccrw.BaseRate2 = base2;  
        MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
        RestAccSumup(RestAccr,"");
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          OpenCashDrawer_IVCashVc(IVCashr);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
          OpenCashDrawer;
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedCashPayTouchScreenDClass:;  
  return;
end;

global
procedure CancelCCPayTouchScreenDClass()
begin
  record CCMerchantIDVc CCMerchantIDr;  
  record LocalMachineBlock LMb;
  record CCAccountIDVc CCAccountIDr;  
  record RcVc RepSpec;
  Integer wn;

  wn = CurWindow;
  BlockLoad(LMb);
  GetWindowRecord(wn,RepSpec);
  FindCCAccountID(RepSpec.CurncyCode,LMb.LocalMachineCode,kCCAccountTypePOS,CCAccountIDr,kCardHolderAny);
  CCMerchantIDr.Code = CCAccountIDr.MerchantID;
  ReadFirstMain(CCMerchantIDr,1,true);
  if (CCMerchantIDr.Partner==kCCPartnerBambora) then begin
    Bambora_Cancel_Request(wn);
  end;
  CloseWindow(wn);
  return;
end;

global
function string 255 LocalMachinePaymentMode(string defaultpaymode,Integer rowtype,string crncy,string localmachine,string drawer)
begin
  string 255 res;
  record RestPMBlock RestPMb;
  row RestPMBlock RestPMbrw;
  Integer i,rwcnt;
  Boolean testf;
  record DefCashBlock DCb;
  
  res = defaultpaymode;
  if (blank(res)) then begin
    BlockLoad(DCb);
    switch (rowtype) begin
      case kInvoiceRowTypeCashPayment:
        res = DCb.DefCashPayMode;
      case kInvoiceRowTypeCreditCardPayment:
        res = DCb.DefCCPayMode;
    end;
  end;
  BlockLoad(RestPMb);
  rwcnt = MatRowCnt(RestPMb);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(RestPMb,i,RestPMbrw);
    testf = true;
    if (rowtype!=RestPMbrw.rowstp) then begin testf = false; end;
    if (nonblank(crncy)) then begin
      if (crncy!=RestPMbrw.CurncyCode) then begin testf = false; end;
    end;
    if (nonblank(localmachine)) then begin
      if (SetInSet(localmachine,RestPMbrw.MachineName)==false) then begin testf = false; end;
    end;
    if (nonblank(drawer)) then begin
      if (SetInSet(drawer,RestPMbrw.Drawers)==false) then begin testf = false; end;
    end;
    if (testf) then begin
      res = RestPMbrw.PMCode;
      goto LLocalMachinePaymentMode;
    end;
  end;
LLocalMachinePaymentMode:;  
  LocalMachinePaymentMode = res;  
  return;
end;

global
updating procedure ProceedNPTSCashPaymentTClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  Array string 255 acrncy;
  Array Boolean achangecrncyf;
  Integer i,acrncnt;
  string 255 crncy;
  val fr,to1,to2,br1,br2,sum4;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  
  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        sum4 = IVCashr.Sum4;
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        if (IVCashr.OKFlag!=0) then begin
          IVCashr.OKFlag = 0;
        end;
        CntPOSCurrencies(acrncy,achangecrncyf,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
        
          ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeCashPayment);
          IVCashrw.stp = kInvoiceRowTypeCashPayment;
          IVCashrw.Sum = StringToVal(GetWindowString(wn,"NPTSCashPaymentCashReceived" & i),M4Val);
          IVCashrw.BasePrice = StringToVal(GetWindowString(wn,"NPTSCashPaymentChangeGiven" & i),M4Val);
          if (IVCashrw.Sum!=0 or IVCashrw.BasePrice!=0) then begin
            crncy = GetWindowString(wn,"NPTSCashPaymentCurrency" & i);
            IVCashrw.PayMode = LocalMachinePaymentMode(RepSpec.AccStr,kInvoiceRowTypeCashPayment,crncy,IVCashr.LocalMachineCode,IVCashr.DrawerCode);
            if (blank(IVCashrw.PayMode)) then begin
              IVCashrw.PayMode = RepSpec.AccStr;
            end;
            IVCashrw.Spec = RepSpec.f6;
            if (GetFullCurncyPurchaseRate(crncy,CurrentDate,fr,to1,to2,br1,br2)==false) then begin
              GetFullCurncyRate(crncy,CurrentDate,fr,to1,to2,br1,br2);
            end;
            IVCashrw.CurncyCode = crncy;
            IVCashrw.FrRate = fr;
            IVCashrw.ToRateB1 = to1;
            IVCashrw.ToRateB2 = to2;
            IVCashrw.BaseRate1 = br1;
            IVCashrw.BaseRate2 = br2;  
            MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
          end;
        end;
        IVCashSumup(IVCashr,true);
        if (IVCashr.InvType==kPOSInvoiceTypeCredit) then begin
          if (IVCashr.RetValue!=0) then begin
            MessageBox(20878,"");
            WindowFieldGoto(wn,RepSpec,-1,"NPTSCashPaymentCashReceived0",true);
            goto LProceedCashPayTouchScreenDClass;
          end;
        end;
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
      case "IVVc":
        sum4 = IVr.Sum4;
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        if (IVr.OKFlag!=0) then begin
          IVr.OKFlag = 0;
        end;
        CntPOSCurrencies(acrncy,achangecrncyf,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
        
          ClearRow(IVr,IVrw,kInvoiceRowTypeCashPayment);
          IVrw.stp = kInvoiceRowTypeCashPayment;
          IVrw.Sum = StringToVal(GetWindowString(wn,"NPTSCashPaymentCashReceived" & i),M4Val);
          if (IVrw.Sum!=0) then begin
            IVrw.PayMode = RepSpec.AccStr;
            IVrw.Spec = RepSpec.f6;
            crncy = GetWindowString(wn,"NPTSCashPaymentCurrency" & i);
            if (GetFullCurncyPurchaseRate(crncy,CurrentDate,fr,to1,to2,br1,br2)==false) then begin
              GetFullCurncyRate(crncy,CurrentDate,fr,to1,to2,br1,br2);
            end;
            IVrw.CurncyCode = crncy;
            IVrw.FrRate = fr;
            IVrw.ToRateB1 = to1;
            IVrw.ToRateB2 = to2;
            IVrw.BaseRate1 = br1;
            IVrw.BaseRate2 = br2;  
            MatRowPut(IVr,MatRowCnt(IVr),IVrw);
          end;
        end;
        IVSumup(IVr,true);
        PutWindowRecord(mwn,IVr);
        WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;

        CntPOSCurrencies(acrncy,achangecrncyf,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
        
          ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeCreditCardPayment);
          RestAccrw.stp = kInvoiceRowTypeCashPayment;
          RestAccrw.Sum = StringToVal(GetWindowString(wn,"NPTSCashPaymentCashReceived" & i),M4Val);
          if (RestAccrw.Sum>0) then begin
            RestAccrw.PayMode = RepSpec.AccStr;
            RestAccrw.Spec = RepSpec.f6;
            crncy = GetWindowString(wn,"NPTSCashPaymentCurrency" & i);
            if (GetFullCurncyPurchaseRate(crncy,CurrentDate,fr,to1,to2,br1,br2)==false) then begin
              GetFullCurncyRate(crncy,CurrentDate,fr,to1,to2,br1,br2);
            end;
            RestAccrw.CurncyCode = crncy;
            RestAccrw.FrRate = fr;
            RestAccrw.ToRateB1 = to1;
            RestAccrw.ToRateB2 = to2;
            RestAccrw.BaseRate1 = br1;
            RestAccrw.BaseRate2 = br2;  
            MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
          end;
        end;        
        RestAccSumup(RestAccr,"");
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          IVDClass_RefreshStringList(mwn,IVr);
          SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetnValue);
          OpenCashDrawer;
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
          OpenCashDrawer_IVCashVc(IVCashr);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
          SetPOSWindowDisplayAmount(USetStr(27350),RestAccr.Sum4-RestAccr.TendValue);
          OpenCashDrawer;
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedCashPayTouchScreenDClass:;  
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  return;
end;

global
procedure CancelNPTSCashPaymentTClass()
begin
  Integer mwn;
  record RcVc RepSpec;
  
  mwn =  MotherWIndow(CurWindow);
  CloseWindow(CurWindow);
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  return;
end;

global
updating procedure ProceedNPTSPaymentTClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  string 255 crncy;
  val fr,to1,to2,br1,br2,sum4;
  val totpaymentv,totcashv;
  Array string 255 acrncy,alabel,apaymentmode;
  Array Integer apaymenttype;
  Array val apaymentv;
  Array string 255 apaymentchecknr;
  Array string 255 apaymentauthcode;
  Integer i,acrncnt,rwcnt;
  record LocalMachineBlock LMb;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  row RestAccVc RestAccrw;
  vector val vpaymodeamounts;
  Boolean testf;
  record RestBlock Restb;
  record IVVc prevIVr;
  record IVVc IVr;
  row IVVc IVrw;
  transaction Integer gTransferRestAccToKitchenOrder;
  record RestSetupVc RSr;
  Integer ProceedPaymentPrintKitchenOrder,ProceedPaymentPrintReceipt,ProceedPaymentSaveTab;
  
  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    BlockLoad(LMb);
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        sum4 = IVCashr.Sum4;
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        if (IVCashr.OKFlag!=0) then begin
          IVCashr.OKFlag = 0;
        end;
        rwcnt = MatRowCnt(IVCashr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVCashr,i,IVCashrw);
          switch (IVCashrw.stp) begin
/*          
            case kInvoiceRowTypeLoyaltyPointsPayment:
              MatRowDelete(IVCashr,i);
              rwcnt = MatRowCnt(IVCashr);
              i = 0;
*/              
            case kInvoiceRowTypeCashPayment:
              MatRowDelete(IVCashr,i);
              rwcnt = MatRowCnt(IVCashr);
              i = 0;
/*              
            case kInvoiceRowTypeCreditCardPayment:
              MatRowDelete(IVCashr,i);
              rwcnt = MatRowCnt(IVCashr);
              i = 0;
            case kInvoiceRowTypeChequePayment:
              MatRowDelete(IVCashr,i);
              rwcnt = MatRowCnt(IVCashr);
              i = 0;
            case kInvoiceRowTypeGiftVoucherPayment:
//              MatRowDelete(IVCashr,i);
//              rwcnt = MatRowCnt(IVCashr);
//              i = 0;
*/
          end;
        end;
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVCashr,i,IVCashrw);
          switch (IVCashrw.stp) begin
            case kInvoiceRowTypeCreditCardPayment:
              vpaymodeamounts[IVCashrw.PayMode] = vpaymodeamounts[IVCashrw.PayMode] + IVCashrw.Sum; 
          end;
        end;
        CntNPTSPaymentCurrenciesRemote(LMb.LocalMachineCode,alabel,acrncy,apaymenttype,apaymentmode,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeChequePayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassChequeAmount" & apaymentmode[i]),M4Val);
              apaymentchecknr[i] = GetWindowString(wn,"NPTSPaymentTClassChequeNr" & apaymentmode[i]);
            case kInvoiceRowTypeCreditCardPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val) - vpaymodeamounts[apaymentmode[i]];
              apaymentauthcode[i] = GetWindowString(wn,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i]);
              if (LMb.CCRequireAuthCode!=0) then begin
                if (blank(apaymentauthcode[i])) and (apaymentv[i]>0) then begin
                  MessageBox(1058,"");
                  WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i],true);
                  goto LProceedCashPayTouchScreenDClass;
                end;
              end;
            case kInvoiceRowTypeGiftVoucherPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassGVPAmount" & apaymentmode[i]),M4Val);
            otherwise
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val);
          end;
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeCashPayment:
              totcashv = totcashv + apaymentv[i];
            case kInvoiceRowTypeCreditCardPayment:
              totcashv = totcashv + apaymentv[i];
          end;
          totpaymentv = totpaymentv + apaymentv[i];
        end;
        if ((totpaymentv-totcashv)>=IVCashr.Sum4) then begin
          if (totpaymentv>totcashv) then begin
            MessageBox(20878,"");
            WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAmount" & apaymentmode[0],true);
            goto LProceedCashPayTouchScreenDClass;
          end;
        end;
        NPTSPaymentPasteAmounts(IVCashr,alabel,acrncy,apaymenttype,apaymentmode,apaymentv,apaymentchecknr,apaymentauthcode,acrncnt);
//        IVCashr.OKFlag = 1;
        PutWindowRecord(mwn,IVCashr);
        WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",true);
      case "IVVc":
        sum4 = IVr.Sum4;
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        if (IVr.OKFlag!=0) then begin
          IVr.OKFlag = 0;
        end;
        rwcnt = MatRowCnt(IVr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVr,i,IVrw);
          switch (IVrw.stp) begin
/*          
            case kInvoiceRowTypeLoyaltyPointsPayment:
              MatRowDelete(IVr,i);
              rwcnt = MatRowCnt(IVr);
              i = 0;
*/              
            case kInvoiceRowTypeCashPayment:
              MatRowDelete(IVr,i);
              rwcnt = MatRowCnt(IVr);
              i = 0;
/*              
            case kInvoiceRowTypeCreditCardPayment:
              MatRowDelete(IVr,i);
              rwcnt = MatRowCnt(IVr);
              i = 0;
            case kInvoiceRowTypeChequePayment:
              MatRowDelete(IVr,i);
              rwcnt = MatRowCnt(IVr);
              i = 0;
            case kInvoiceRowTypeGiftVoucherPayment:
//              MatRowDelete(IVr,i);
//              rwcnt = MatRowCnt(IVr);
//              i = 0;
*/
          end;
        end;
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVr,i,IVrw);
          switch (IVrw.stp) begin
            case kInvoiceRowTypeCreditCardPayment:
              vpaymodeamounts[IVrw.PayMode] = vpaymodeamounts[IVrw.PayMode] + IVrw.Sum; 
          end;
        end;

        CntNPTSPaymentCurrenciesRemote(LMb.LocalMachineCode,alabel,acrncy,apaymenttype,apaymentmode,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeChequePayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassChequeAmount" & apaymentmode[i]),M4Val);
              apaymentchecknr[i] = GetWindowString(wn,"NPTSPaymentTClassChequeNr" & apaymentmode[i]);
            case kInvoiceRowTypeCreditCardPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val) - vpaymodeamounts[apaymentmode[i]];
              apaymentauthcode[i] = GetWindowString(wn,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i]);
              if (LMb.CCRequireAuthCode!=0) then begin
                if (blank(apaymentauthcode[i])) and (apaymentv[i]>0) then begin
                  MessageBox(1058,"");
                  WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i],true);
                  goto LProceedCashPayTouchScreenDClass;
                end;
              end;
            case kInvoiceRowTypeGiftVoucherPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassGVPAmount" & apaymentmode[i]),M4Val);
            otherwise
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val);
          end;
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeCashPayment:
              totcashv = totcashv + apaymentv[i];
            case kInvoiceRowTypeCreditCardPayment:
              totcashv = totcashv + apaymentv[i];
          end;
          totpaymentv = totpaymentv + apaymentv[i];
        end;
        if ((totpaymentv-totcashv)>IVr.Sum4) then begin
          if (totpaymentv>totcashv) then begin
            MessageBox(20878,"");
            WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAmount" & apaymentmode[0],true);
            goto LProceedCashPayTouchScreenDClass;
          end;
        end;
        NPTSPaymentPasteAmounts_IVVc(IVr,alabel,acrncy,apaymenttype,apaymentmode,apaymentv,apaymentchecknr,apaymentauthcode,acrncnt);
//        IVr.OKFlag = 1;
        PutWindowRecord(mwn,IVr);
        WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",true);
        OpenStdCCWindow(mwn);
      case "RestAccVc":
        BlockLoad(Restb);
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedCashPayTouchScreenDClass;
            end;
        end;
        rwcnt = MatRowCnt(RestAccr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(RestAccr,i,RestAccrw);
          switch (RestAccrw.stp) begin
/*          
            case kInvoiceRowTypeLoyaltyPointsPayment:
              MatRowDelete(RestAccr,i);
              rwcnt = MatRowCnt(RestAccr);
              i = 0;
*/              
            case kInvoiceRowTypeCashPayment:
              MatRowDelete(RestAccr,i);
              rwcnt = MatRowCnt(RestAccr);
              i = 0;
/*          
            case kInvoiceRowTypeCreditCardPayment:
              MatRowDelete(RestAccr,i);
              rwcnt = MatRowCnt(RestAccr);
              i = 0;
            case kInvoiceRowTypeChequePayment:
              MatRowDelete(RestAccr,i);
              rwcnt = MatRowCnt(RestAccr);
              i = 0;
            case kInvoiceRowTypeGiftVoucherPayment:
              MatRowDelete(RestAccr,i);
              rwcnt = MatRowCnt(RestAccr);
              i = 0;
*/
          end;
        end;
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(RestAccr,i,RestAccrw);
          switch (RestAccrw.stp) begin
            case kInvoiceRowTypeCreditCardPayment:
              vpaymodeamounts[RestAccrw.PayMode] = vpaymodeamounts[RestAccrw.PayMode] + RestAccrw.Sum; 
          end;
        end;

        CntNPTSPaymentCurrenciesRemote(LMb.LocalMachineCode,alabel,acrncy,apaymenttype,apaymentmode,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeChequePayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassChequeAmount" & apaymentmode[i]),M4Val);
              apaymentchecknr[i] = GetWindowString(wn,"NPTSPaymentTClassChequeNr" & apaymentmode[i]);
            case kInvoiceRowTypeCreditCardPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val) - vpaymodeamounts[apaymentmode[i]];
              apaymentauthcode[i] = GetWindowString(wn,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i]);
              if (LMb.CCRequireAuthCode!=0) then begin
                if (blank(apaymentauthcode[i])) and (apaymentv[i]>0) then begin
                  MessageBox(1058,"");
                  WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAuthorizationCode" & apaymentmode[i],true);
                  goto LProceedCashPayTouchScreenDClass;
                end;
              end;
            case kInvoiceRowTypeGiftVoucherPayment:
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassGVPAmount" & apaymentmode[i]),M4Val);
            otherwise
              apaymentv[i] = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount" & apaymentmode[i]),M4Val);
          end;
          switch (apaymenttype[i]) begin
            case kInvoiceRowTypeCashPayment:
              totcashv = totcashv + apaymentv[i];
            case kInvoiceRowTypeCreditCardPayment:
              totcashv = totcashv + apaymentv[i];
          end;
          totpaymentv = totpaymentv + apaymentv[i];
        end;
        if ((totpaymentv-totcashv)>=RestAccr.Sum4) then begin
          if (totpaymentv>totcashv) then begin
            MessageBox(20878,"");
            WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAmount" & apaymentmode[0],true);
            goto LProceedCashPayTouchScreenDClass;
          end;
        end;
        if (RepSpec.vals1>=0) then begin
          if ((totpaymentv-totcashv)>RepSpec.vals1) then begin testf = true; end;
        end else begin
          if ((totpaymentv-totcashv)<RepSpec.vals1) then begin testf = true; end;
        end;        
        if (testf) then begin
          for (i=0;i<acrncnt;i=i+1) begin
            switch (apaymenttype[i]) begin
              case kInvoiceRowTypeCashPayment:
              otherwise
                if (apaymentv[i]>0) then begin
                  MessageBox(24184,"");
                  WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentTClassAmount" & apaymentmode[i],true);
                  goto LProceedCashPayTouchScreenDClass;
                end;
            end;
          end;
        end;
        NPTSPaymentPasteAmounts_RestAccVc(RestAccr,alabel,acrncy,apaymenttype,apaymentmode,apaymentv,apaymentchecknr,apaymentauthcode,acrncnt);
        PutWindowRecord(mwn,RestAccr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "IVVc":
          GetWindowRecord(mwn,IVr);
          SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetnValue);
          IVDClass_RefreshStringList(mwn,IVr);
          OpenCashDrawer;
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
          OpenCashDrawer_IVCashVc(IVCashr);
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
          
          ProceedPaymentPrintKitchenOrder = Restb.ProceedPaymentPrintKitchenOrder;
          ProceedPaymentPrintReceipt = Restb.ProceedPaymentPrintReceipt;
          ProceedPaymentSaveTab = Restb.ProceedPaymentSaveTab;
          
          RSr.BranchID = RestAccr.BranchID;
          RSr.Name = RestAccr.CUName;
          
          if (ReadFirstKey("Name",RSr,2,true)) then begin
            ProceedPaymentPrintKitchenOrder = RSr.ProceedPaymentPrintKitchenOrder;
            ProceedPaymentPrintReceipt = RSr.ProceedPaymentPrintReceipt;
            ProceedPaymentSaveTab = RSr.ProceedPaymentSaveTab;
          end;
          
          if (ProceedPaymentPrintKitchenOrder!=0) then begin
            gTransferRestAccToKitchenOrder = 1;
            srlRestAccLPrint(RestAccr,"","RestAccKitchenForm");
          end;
          if (ProceedPaymentPrintReceipt!=0) then begin
            RestAccr.Closed = 1;
            srlRestAccLPrint(RestAccr,"","RestAccForm");
          end;
          if (ProceedPaymentSaveTab!=0) then begin
            WindowDoNew(mwn,0);
          end;
          OpenCashDrawer;
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedCashPayTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedOpenOnHotelGuestTouchScreenOClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record RestAccVc prevRestAccr;
  record RestAccVc RestAccr;
  record IVCashVc prevIVCashr;
  record IVCashVc IVCashr;
  string 255 errstr,fieldgoto;
  Integer err;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    err = TestOpenOnHotelGuestTouchScreenOClass(RepSpec,errstr,fieldgoto);
    if (err!=0) then begin
      MessageBox(err," " & errstr);
      WindowFieldGoto(wn,RepSpec,-1,fieldgoto,true);
      goto LProceedOpenOnHotelGuestTouchScreenDClass;
    end;

    switch (GetWindowFileName(mwn)) begin
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedOpenOnHotelGuestTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedOpenOnHotelGuestTouchScreenDClass;
            end;
        end;
        RestAccr.Resource = RepSpec.f1;
        RestAccr.GuestCode = RepSpec.f2;
        RestAccr.CUCode = RepSpec.f3;
        PutWindowRecord(mwn,RestAccr);
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOpenOnHotelGuestTouchScreenDClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOpenOnHotelGuestTouchScreenDClass;
            end;
        end;
        IVCashr.Resource = RepSpec.f1;
        IVCashr.GuestCode = RepSpec.f2;
        IVCashr.CustCode = RepSpec.f3;
        PutWindowRecord(mwn,IVCashr);
    end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      CloseWindow(wn);
      switch (GetWindowFileName(mwn)) begin
        case "RestAccVc":
          GetWindowRecord(mwn,RestAccr);
          RestAccDClass_RefreshStringList(mwn,RestAccr);
        case "IVCashVc":
          GetWindowRecord(mwn,IVCashr);
          IVCashDClass_RefreshStringList(mwn,IVCashr);
      end;
    end else begin
      CloseWindow(wn);
      SelectHWStoreWClass;
    end;
  end;
LProceedOpenOnHotelGuestTouchScreenDClass:;  
  return;
end;

global
updating procedure ProceedAmendLineNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr,t2;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  row RestAccVc RestAccrw;
  Boolean ivcashcommandf;
  record LocalMachineBlock LMb;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  record GeneralOptionBlock GenOptRec;
  
  ivcashcommandf = true;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
        end;
        BlockLoad(GenOptRec);
        rownr = RepSpec.long1;
        MatRowGet(IVCashr,rownr,IVCashrw);
        IVCashrw.Quant = RepSpec.vals0;
        MatRowPut(IVCashr,rownr,IVCashrw);
        if (IVCashVc_PasteQuant(IVCashr,rownr)) then begin    
        end;
        MatRowGet(IVCashr,rownr,IVCashrw);
//        IVCashrw.Quant = RepSpec.vals0;
        IVCashrw.Price = RepSpec.vals1;
        IVCashrw.vRebate = RepSpec.vals2;
        IVCashrw.Sum = RepSpec.vals3;
        IVCashrw.VATCode = RepSpec.f2;
        IVCashrw.Spec = RepSpec.f1;
        MatRowPut(IVCashr,rownr,IVCashrw);      

        IVCashDchrsum(IVCashr,rownr,GenOptRec.UseDiscount);
        MatRowGet(IVCashr,rownr,IVCashrw);
        RowCalculateTaxMatrix_IVCashVc(IVCashr,rownr,IVCashrw);
        MatRowPut(IVCashr,rownr,IVCashrw);      
        IVCashDchsum(IVCashr,rownr);
        IVCashSumup(IVCashr,true);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        tstr = ValToString(IVCashrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(IVCashrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(IVCashrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),30-len(tstr)," ",true,t2);
        tstr = tstr & t2;
        if (HasLocalization("POL")) then begin
          tstr = tstr & chr(10) & USetStr(24171) & ": " & IVCashr.Sum4;
        end;
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        SetPOSWindowDisplay(IVCashrw.ArtCode & " " & IVCashrw.Spec,tstr);
        OverrideLogout;
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
        end;
        rownr = RepSpec.long1;
        MatRowGet(IVr,rownr,IVrw);
        IVrw.Quant = RepSpec.vals0;
        IVrw.Price = RepSpec.vals1;
        IVrw.vRebate = RepSpec.vals2;
        IVrw.Sum = RepSpec.vals3;
        IVrw.VATCode = RepSpec.f2;
        IVrw.Location = RepSpec.f3;
        IVrw.Spec = RepSpec.f1;
        RowCalculateTaxMatrix_IVVc(IVr,rownr,IVrw);
        MatRowPut(IVr,rownr,IVrw);      
        IVDchrsum(IVr,rownr);
        IVDchsum(IVr,rownr);
        IVSumup(IVr,true);
//        IVSumupSoftEditFields(mwn,IVr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        tstr = ValToString(IVrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(IVrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(IVrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),30-len(tstr)," ",true,t2);
        tstr = tstr & t2;
        if (HasLocalization("POL")) then begin
          tstr = tstr & chr(10) & USetStr(24171) & ": " & IVCashr.Sum4;
        end;
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        SetPOSWindowDisplay(IVrw.ArtCode & " " & IVrw.Spec,tstr);        
        OverrideLogout;
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
        end;
        BlockLoad(LMb);
        rownr = RepSpec.long1;
        MatRowGet(RestAccr,rownr,RestAccrw);
        RestAccrw.Quant = RepSpec.vals0;
        RestAccrw.Price = RepSpec.vals1;
        RestAccrw.vRebate = RepSpec.vals2;
        RestAccrw.Sum = RepSpec.vals3;
        RestAccrw.VATCode = RepSpec.f2;
        RestAccrw.MealCourse = RepSpec.f11;
        RestAccrw.SeatCode = RepSpec.f12;
        RestAccrw.Spec = RepSpec.f1;
        RowCalculateTaxMatrix_RestAccVc(RestAccr,rownr,RestAccrw);
        MatRowPut(RestAccr,rownr,RestAccrw);
        RestAccDchrsum(RestAccr,rownr,0);
        RestAccDchsum(RestAccr,rownr);
        RestAccr.ServCharge = GetServiceCharge(RestAccr,LMb,true);
        RestAccSumup(RestAccr,"");
        RestAccSumupSoftEditFields(mwn,RestAccr);
        PutWindowRecord(mwn,RestAccr);
        RestAccDClass_RefreshStringList(mwn,RestAccr);
        tstr = ValToString(RestAccrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(RestAccrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(RestAccrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),30-len(tstr)," ",true,t2);
        tstr = tstr & t2;  
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        SetPOSWindowDisplay(RestAccrw.ArtCode & " " & RestAccrw.Spec,tstr);
        OverrideLogout;
        ivcashcommandf = false;
    end;
  end;
LProceedAmendLineNPTSSClass:;  
  if (ivcashcommandf) then begin
    //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
    WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  end;
  if (rownr>=0) then begin
    SetSelectedListLine(mwn,rownr);
  end;
  return;
end;

global
function Boolean SplitItemNPTSSClassClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  CancelAndOverrideLogout;
  
  SplitItemNPTSSClassClassOnClose = true;
  return;
end;

global
function Boolean LoyaltyPointsBonusNPTSSClassClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  CancelAndOverrideLogout;
  
  LoyaltyPointsBonusNPTSSClassClassOnClose = true;
  return;
end;


global
function Boolean LoyalCardNPTSSClassClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  CancelAndOverrideLogout;
  
  LoyalCardNPTSSClassClassOnClose = true;
  return;
end;

global
updating procedure ProceedAmendLineNPTSSClass()
begin  
  ProceedAmendLineNPTSSClassExecute(CurWindow);
  return;
end;

global
function Boolean AmendLineNPTSSClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  CancelAndOverrideLogout;
  
  AmendLineNPTSSClassOnClose = true;
  return;
end;

global
updating procedure ProceedAddOrderDiscountNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr,t2;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  row RestAccVc RestAccrw;
  Boolean ivcashcommandf;
  record LocalMachineBlock LMb;
  Integer i,rwcnt;
  
  ivcashcommandf = true;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
      /*
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
        end;
        rownr = RepSpec.long1;
        MatRowGet(IVCashr,rownr,IVCashrw);
        IVCashrw.Quant = RepSpec.vals0;
        MatRowPut(IVCashr,rownr,IVCashrw);
        if (IVCashVc_PasteQuant(IVCashr,rownr)) then begin    
        end;
        MatRowGet(IVCashr,rownr,IVCashrw);
//        IVCashrw.Quant = RepSpec.vals0;
        IVCashrw.Price = RepSpec.vals1;
        IVCashrw.vRebate = RepSpec.vals2;
        IVCashrw.Sum = RepSpec.vals3;
        MatRowPut(IVCashr,rownr,IVCashrw);      
        IVCashSumup(IVCashr,true);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        tstr = ValToString(IVCashrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(IVCashrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(IVCashrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),30-len(tstr)," ",true,t2);
        tstr = tstr & t2;  
        SetPOSWindowDisplay(IVCashrw.ArtCode & " " & IVCashrw.Spec,tstr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        OverrideLogout;
        */
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedAmendLineNPTSSClass;
            end;
        end;
        BlockLoad(LMb);
        rwcnt = MatRowCnt(RestAccr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(RestAccr,i,RestAccrw);
          if (RestAccrw.stp==1) and (RestAccrw.ovst==0) then begin
            RestAccrw.vRebate = RepSpec.vals2;        
            MatRowPut(RestAccr,i,RestAccrw);
            RestAccDchrsum(RestAccr,i,0);
            RestAccDchsum(RestAccr,i);
          end;
        end;                
        RestAccr.ServCharge = GetServiceCharge(RestAccr,LMb,true);
        RestAccSumup(RestAccr,"");
        RestAccSumupSoftEditFields(mwn,RestAccr);
        PutWindowRecord(mwn,RestAccr);
        RestAccDClass_RefreshStringList(mwn,RestAccr);
        tstr = ValToString(RestAccrw.Quant,M4UVal,ThousandSeparator,DecimalSeparator,0) & "*" & ValToString(RestAccrw.Price,M4Val,ThousandSeparator,DecimalSeparator,0);
        M4PadString(ValToString(RestAccrw.Sum,M4Val,ThousandSeparator,DecimalSeparator,0),30-len(tstr)," ",true,t2);
        tstr = tstr & t2;  
        SetPOSWindowDisplay(RestAccrw.ArtCode & " " & RestAccrw.Spec,tstr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        OverrideLogout;
        ivcashcommandf = false;
    end;
  end;
LProceedAmendLineNPTSSClass:;  
  if (ivcashcommandf) then begin
    //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
    WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  end;
  return;
end;

global
updating procedure ProceedAddOrderDiscountNPTSSClass()
begin  
  ProceedAddOrderDiscountNPTSSClassExecute(CurWindow);
  return;
end;

global
function Boolean AddOrderDiscountNPTSSClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  CancelAndOverrideLogout;
  
  AddOrderDiscountNPTSSClassOnClose = true;
  return;
end;

global
updating procedure ProceedLoyalCardNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  record IVVc IVr;
  record IVVc prevIVr;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  string 255 tstr,t2;
  record LoyaltyCardVc LoyaltyCardr;
  record LocalMachineBlock LMb;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);

        LoyaltyCardr.SerNr = RepSpec.f1;
        if (ReadFirstMain(LoyaltyCardr,1,true)==false) then begin
          MessageBox(26435,"");
          WindowFieldGoto(wn,RepSpec,-1,"f1",false);
          goto LProceedLoyalCardNPTSSClass;
        end;
        if (nonblankdate(LoyaltyCardr.ExpiryDate)) then begin
          if (LoyaltyCardr.ExpiryDate<IVCashr.TransDate) then begin
            MessageBox(26438,"");
            WindowFieldGoto(wn,RepSpec,-1,"f1",false);
            goto LProceedLoyalCardNPTSSClass;
          end;
        end;
        if (LoyaltyCardr.Closed!=0) then begin
          MessageBox(26434,"");
          WindowFieldGoto(wn,RepSpec,-1,"f1",false);
          goto LProceedLoyalCardNPTSSClass;
        end;
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
        end;
        IVCashr.LoyaltyCardNr = RepSpec.f1;
        IVCashVc_PasteLoyaltyCardNr(IVCashr);
        IVCashSumup(IVCashr,true);
        PutWindowRecord(mwn,IVCashr);
        ReRunWindowDef(mwn);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        IVCashSumupSoftEditFields(mwn,IVCashr);
//        WindowDoOK(mwn,0);
        CloseWindow(wn);
        WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",true);
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);

        LoyaltyCardr.SerNr = RepSpec.f1;
        if (ReadFirstMain(LoyaltyCardr,1,true)==false) then begin
          MessageBox(26435,"");
          WindowFieldGoto(wn,RepSpec,-1,"f1",false);
          goto LProceedLoyalCardNPTSSClass;
        end;
        if (nonblankdate(LoyaltyCardr.ExpiryDate)) then begin
          if (LoyaltyCardr.ExpiryDate<IVr.TransDate) then begin
            MessageBox(26438,"");
            WindowFieldGoto(wn,RepSpec,-1,"f1",false);
            goto LProceedLoyalCardNPTSSClass;
          end;
        end;
        if (LoyaltyCardr.Closed!=0) then begin
          MessageBox(26434,"");
          WindowFieldGoto(wn,RepSpec,-1,"f1",false);
          goto LProceedLoyalCardNPTSSClass;
        end;
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
        end;
        BlockLoad(LMb);
        IVr.LoyaltyCardNr = RepSpec.f1;
        IVVc_PasteLoyaltyCardNr(IVr,LMb);
        IVSumup(IVr,true);
//        IVSumupSoftEditFields(mwn,IVr);
        PutWindowRecord(mwn,IVr);
        ReRunWindowDef(mwn);
        IVDClass_RefreshStringList(mwn,IVr);
//        WindowDoOK(mwn,0);
        CloseWindow(wn);
        WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",true);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyalCardNPTSSClass;
            end;
        end;
        RestAccr.LoyaltyCardNr = RepSpec.f1;
        RestAccVc_PasteLoyaltyCardNr(RestAccr);
        RestAccSumup(RestAccr,"");
        RestAccSumupSoftEditFields(mwn,RestAccr);
        PutWindowRecord(mwn,RestAccr);
        ReRunWindowDef(mwn);
        RestAccDClass_RefreshStringList(mwn,RestAccr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
    end;
  end;
LProceedLoyalCardNPTSSClass:;  
  return;
end;

global
updating procedure ProceedLoyalCardNPTSSClass()
begin  
  ProceedLoyalCardNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean LoyalCardNPTSSClassOnOKWindow(integer wn)
begin
  ProceedLoyalCardNPTSSClassExecute(wn);
  LoyalCardNPTSSClassOnOKWindow = false;
  return;
end;

global
updating procedure ProceedSerialNoScanNPTSSClassExecute(Integer wn)
begin
  Integer mwn,nwn,rownr;
  record RcVc RepSpec;
  record RcVc newRepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  string 255 tstr,t2;
  record ACPVc ACPr;
  record SerBalVc SBr;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSerialNoScanNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSerialNoScanNPTSSClass;
            end;
        end;
        rownr = RepSpec.long1;
        MatRowGet(IVCashr,rownr,IVCashrw);
        IVCashrw.SerialNr = RepSpec.f1;
        if (SerialNrForOneItem(IVCashrw.SerialNr,SBr)) then begin
          IVCashrw.Location = SBr.Location;
        end;
        MatRowPut(IVCashr,rownr,IVCashrw);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        ReRunWindowDef(mwn);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        PutWindowString(mwn,"ivcashcommandlastitemsernrf","");
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSerialNoScanNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSerialNoScanNPTSSClass;
            end;
        end;
        rownr = RepSpec.long1;
        MatRowGet(IVr,rownr,IVrw);
        IVrw.SerialNr = RepSpec.f1;
        if (SerialNrForOneItem(IVrw.SerialNr,SBr)) then begin
          IVrw.Location = SBr.Location;
        end;
        MatRowPut(IVr,rownr,IVrw);
//        IVSumupSoftEditFields(mwn,IVr);
        PutWindowRecord(mwn,IVr);
        ReRunWindowDef(mwn);
        IVDClass_RefreshStringList(mwn,IVr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        PutWindowString(mwn,"ivcashcommandlastitemsernrf","");
        ACPr.ArtCode = IVrw.ArtCode;
        if (ReadFirstMain(ACPr,1,true)) then begin
          IVDClassTouchScreenMainSerialNrExecute(rownr);
        end;
    end;
  end;
LProceedSerialNoScanNPTSSClass:;  
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  return;
end;

global
updating procedure ProceedSerialNoScanNPTSSClass()
begin  
  ProceedSerialNoScanNPTSSClassExecute(CurWindow);
  return;
end;

global
procedure CancelSerialNoScanNPTSSClass()
begin
  Integer mwn;
  
  mwn = MotherWindow(CurWindow);
  CloseWindow(CurWindow);
  PutWindowString(mwn,"ivcashcommandlastitemsernrf","");
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
end;

global
updating function boolean SerialNoScanNPTSSClassOnOKWindow(integer wn)
begin
  ProceedSerialNoScanNPTSSClassExecute(wn);
  SerialNoScanNPTSSClassOnOKWindow = false;
  return;
end;

global
function Boolean SerialNoScanNPTSSClassOnClose(Integer wn,Integer wn2)
begin
  Integer nwn;
  
  SerialNoScanNPTSSClassOnClose = true;
  return;
end;

global
updating procedure ProceedSCDiscountCardNPTSSClassExecute(Integer wn)
begin
  Integer mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  string 255 tstr,t2;
  Integer err;
  LongInt printrownr;
  record LocalMachineBlock LMb;
  Integer wnst;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    if (blank(RepSpec.f1)) then begin
      MessageBox(24187,"");
      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      goto LProceedSCDiscountCardNPTSSClassExecute;
    end;
    if (blank(RepSpec.f2)) then begin
      MessageBox(24188,"");
      WindowFieldGoto(wn,RepSpec,-1,"f2",true);
      goto LProceedSCDiscountCardNPTSSClassExecute;
    end;
    if (RepSpec.vals0==0) then begin
      MessageBox(24189,"");
      WindowFieldGoto(wn,RepSpec,-1,"vals0",true);
      goto LProceedSCDiscountCardNPTSSClassExecute;
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSCDiscountCardNPTSSClassExecute1;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedSCDiscountCardNPTSSClassExecute1;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedSCDiscountCardNPTSSClassExecute1;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedSCDiscountCardNPTSSClassExecute1;
            end;
        end;
        err = SCDiscountCardExecuteRemote(IVCashr,RepSpec);
        if (err!=0) then begin
          MessageBox(err,"");
          CloseWindow(wn);
          goto LProceedSCDiscountCardNPTSSClassExecute;
        end;
        wnst = WindowState(mwn);
        PutWindowRecord(mwn,IVCashr);
        ReRunWindowDef(mwn);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        if (WindowDoOK(mwn,0)) then begin
          GetWindowRecord(mwn,IVCashr);      
          BlockLoad(LMb);
          if (LMb.IncrementalReceiptPrinting!=0) then begin
            GetPrevWindowRecord(mwn,prevIVCashr);      
            printrownr = StringToLongInt(GetWindowString(mwn,"touchscreenitemlastrownr"));
            if (printrownr>=0) then begin
              if (IVCashPrintReceipt(mwn,IVCashr,prevIVCashr,printrownr,false,false,LMb.IncrementalReceiptPrinting,wnst)) then begin
              end;
            end;
          end;
          PutWindowString(mwn,"touchscreenitemlastrownr",MatRowCnt(IVCashr)-1);
        end;
        CloseWindow(wn);
    end;
  end;
LProceedSCDiscountCardNPTSSClassExecute1:;  
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
LProceedSCDiscountCardNPTSSClassExecute:;  
  return;
end;

global
updating procedure ProceedSCDiscountCardNPTSSClass()
begin  
  ProceedSCDiscountCardNPTSSClassExecute(CurWindow);
  return;
end;

global
updating function boolean ProceedSCDiscountCardNPTSSClassOnOKWindow(integer wn)
begin
  ProceedSCDiscountCardNPTSSClassExecute(wn);
  return;
end;

// it is above
global
updating procedure ProceedReturnInvNoNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr,t2;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
        end;
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeReturnIVNr);    
        IVCashrw.OrgIVNr = RepSpec.long1;
        IVCashrw.StandProblemCode = RepSpec.f1;
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        
        IVCashSumup(IVCashr,true);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
    end;
  end;
LProceedReturnInvNoNPTSSClass:;  
  WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",true);
  return;
end;

global
updating procedure ProceedReturnInvNoNPTSSClass()
begin  
  ProceedReturnInvNoNPTSSClassExecute(CurWindow);
  return;
end;

global
updating procedure ProceedReturnReasonNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  string 255 tstr,t2;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
        end;
        IVCashr.InvComment = RepSpec.f2;
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedReturnInvNoNPTSSClass;
            end;
        end;
        IVr.InvComment = RepSpec.f2;
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
    end;
  end;
LProceedReturnInvNoNPTSSClass:;  
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  return;
end;

global
updating procedure ProceedReturnReasonNPTSSClass()
begin  
  ProceedReturnReasonNPTSSClassExecute(CurWindow);
  return;
end;

global
updating procedure ProceedLoyaltyPointsBonusNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr,t2;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  row RestAccVc RestAccrw;
  Boolean ivcashcommandf;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  
  ivcashcommandf = true;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
        end;
        ClearRow(IVCashr,IVCashrw,kInvoiceRowTypeLoyaltyPointsBonus);    
        IVCashrw.Points = RepSpec.vals0;
        MatRowPut(IVCashr,MatRowCnt(IVCashr),IVCashrw);
        
        IVCashSumup(IVCashr,true);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
        end;
        ClearRow(IVr,IVrw,kInvoiceRowTypeLoyaltyPointsBonus);    
        IVrw.Points = RepSpec.vals0;
        MatRowPut(IVr,MatRowCnt(IVr),IVrw);
        
        IVSumup(IVr,true);
//        IVSumupSoftEditFields(mwn,IVr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
      case "RestAccVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPointsBonusNPTSSClass;
            end;
        end;
        ClearRow(RestAccr,RestAccrw,kInvoiceRowTypeLoyaltyPointsBonus);    
        RestAccrw.Points = RepSpec.vals0;
        MatRowPut(RestAccr,MatRowCnt(RestAccr),RestAccrw);
        
        RestAccSumup(RestAccr,true);
        RestAccSumupSoftEditFields(mwn,RestAccr);
        PutWindowRecord(mwn,RestAccr);
        RestAccDClass_RefreshStringList(mwn,RestAccr);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        ivcashcommandf = false;
    end;
  end;
LProceedLoyaltyPointsBonusNPTSSClass:;  
  if (ivcashcommandf) then begin
    //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
    WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
  end;
  return;
end;

global
updating procedure ProceedLoyaltyPointsBonusNPTSSClass()
begin  
  ProceedLoyaltyPointsBonusNPTSSClassExecute(CurWindow);
  return;
end;

global
updating procedure ProceedLoyaltyPaymentNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr,t2;
  record IVVc IVr;
  record IVVc prevIVr;
  row IVVc IVrw;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
          case Rs_normal:
            if (IVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
        end;
        LoyaltyPointsPayment_IVCashVc(IVCashr,RepSpec.vals0,RepSpec.FirstAcc);
        
        IVCashSumup(IVCashr,true);
        IVCashSumupSoftEditFields(mwn,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        SetPOSWindowDisplay_PaymentRow(IVCashrw.Spec,IVCashr.RetValue);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        OverrideLogout;
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
          case Rs_normal:
            if (IVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
            if (IVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedLoyaltyPaymentNPTSSClass;
            end;
        end;
        LoyaltyPointsPayment_IVVc(IVr,RepSpec.vals0,RepSpec.FirstAcc);
        
        IVSumup(IVr,true);
//        IVSumupSoftEditFields(mwn,IVr);
        PutWindowRecord(mwn,IVr);
        IVDClass_RefreshStringList(mwn,IVr);
        SetPOSWindowDisplay_PaymentRow(IVrw.Spec,IVr.RetValue);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
        OverrideLogout;
    end;
  end;
LProceedLoyaltyPaymentNPTSSClass:;  
  //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
  return;
end;

global
updating procedure ProceedLoyaltyPaymentNPTSSClass()
begin  
  ProceedLoyaltyPaymentNPTSSClassExecute(CurWindow);
  return;
end;

function Boolean GiftVoucherTouchScreenDClassf1EFAfter(Integer wn,Boolean changedf)
begin
  record GCSVc GCSr;
  record RcVc RepSpec;
  Boolean res,found;
  
  res = true;
  if (changedf) then begin
    GetWindowRecord(wn,RepSpec);
    GCSr.BarCode = RepSpec.f1;
    found = ReadFirstKey("BarCode",GCSr,1,true);
    if (found==false) then begin    
      GCSr.SerNr = StringToLongInt(RepSpec.f1);
      found = ReadFirstMain(GCSr,1,true);
    end;
    if (found==false) then begin    
//      MessageBox(2184,"");
//      WindowFieldGoto(wn,RepSpec,-1,"f1",true);
      res = false;
      goto LGiftVoucherTouchScreenDClassf1EFAfter;
    end;
    RepSpec.vals0 = GCSr.Balance;
    PutWindowRecord(wn,RepSpec);
  end;
LGiftVoucherTouchScreenDClassf1EFAfter:;  
  GiftVoucherTouchScreenDClassf1EFAfter = res;
  return;
end;

global
function Boolean GiftVoucherTouchScreenDClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
  Boolean res;

  switch (fieldname) begin
    case "f1": res = GiftVoucherTouchScreenDClassf1EFAfter(wn,changed!=0);
  end;
  res = true;
  GiftVoucherTouchScreenDClassAfterEditField = res;
  return;
end;

global
updating procedure ProceedEnterBaggerNPTSOClass()
begin
  Integer wn,mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);

    DeselectWindow(mwn,false);
    GetWindowRecord(mwn,IVCashr);
    switch (WindowState(mwn)) begin
      case Rs_update:
        GetPrevWindowRecord(mwn,prevIVCashr);
        if (prevIVCashr.OKFlag!=0) then begin
          CloseWindow(wn);
          goto LProceedEnterBaggerNPTSOClass;
        end;
        if (prevIVCashr.Invalid!=0) then begin
          CloseWindow(wn);
          goto LProceedEnterBaggerNPTSOClass;
        end;
      case Rs_normal:
        GetWindowRecord(mwn,prevIVCashr);
        if (prevIVCashr.OKFlag!=0) then begin
          CloseWindow(wn);
          goto LProceedEnterBaggerNPTSOClass;
        end;
        if (prevIVCashr.Invalid!=0) then begin
          CloseWindow(wn);
          goto LProceedEnterBaggerNPTSOClass;
        end;
    end;
    IVCashr.Bagger = RepSpec.f1;
    PutWindowRecord(mwn,IVCashr);
  end;
  if (WindowDoOK(mwn,0)) then begin
    DeselectWindow(wn,false);
    GetWindowRecord(wn,RepSpec);
    CloseWindow(wn);
    ReRunWindowDef(mwn);
    //WindowFieldGoto(mwn,IVCashr,-1,"ivcashcommand",false);
    WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",false);
  end else begin
    CloseWindow(wn);
  end;
LProceedEnterBaggerNPTSOClass:;
  return;
end;

global
updating procedure ProceedEnterSalesmanNPTSOClass()
begin
  Integer wn,mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  record RestAccVc RestAccr;
  record RestAccVc prevRestAccr;
  record IVVc IVr;
  record IVVc prevIVr;
  record UserVc Userr;
  string 255 tstr;

  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);

    DeselectWindow(mwn,false);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
        end;
        Userr.Code = RepSpec.f1;    
        if (ReadFirstMain(Userr,1,true)==false) then begin
          MessageBox(20170,": " & RepSpec.f1);
          goto LProceedEnterSalesmanNPTSOClass;
        end;
        IVCashr.SalesMan = RepSpec.f1;
        PutWindowRecord(mwn,IVCashr);
      case "IVVc":
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
        end;
        Userr.Code = RepSpec.f1;    
        if (ReadFirstMain(Userr,1,true)==false) then begin
          MessageBox(20170,": " & RepSpec.f1);
          goto LProceedEnterSalesmanNPTSOClass;
        end;
        tstr = IVr.SalesMan;
        IVr.SalesMan = RepSpec.f1;
        IVVc_PasteSalesMan(IVr,tstr);
        PutWindowRecord(mwn,IVr);
      case "RestAccVc":
        GetWindowRecord(mwn,RestAccr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevRestAccr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevRestAccr);
            if (prevRestAccr.Closed!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
            if (prevRestAccr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterSalesmanNPTSOClass;
            end;
        end;
        Userr.Code = RepSpec.f1;    
        if (ReadFirstMain(Userr,1,true)==false) then begin
          MessageBox(20170,": " & RepSpec.f1);
          goto LProceedEnterSalesmanNPTSOClass;
        end;
        RestAccr.Cashier = RepSpec.f1;
        PutWindowRecord(mwn,RestAccr);
    end;
  end;
  if (WindowDoOK(mwn,0)) then begin
    DeselectWindow(wn,false);
    GetWindowRecord(wn,RepSpec);
    CloseWindow(wn);
    ReRunWindowDef(mwn);
  end else begin
    CloseWindow(wn);
  end;
LProceedEnterSalesmanNPTSOClass:;
  return;
end;

global
procedure IVCashDClassTouchScreenChangeAddress()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (HasLocalization("POL")==false) then begin
    if (IVCashr.OKFlag!=0) then begin testf = false; end;
  end;
//in SL we allow to change address on OKed invoice
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.f6 = IVCashr.Addr0;
    RepSpec.f1 = IVCashr.Addr1;
    RepSpec.f2 = IVCashr.Addr2;
    RepSpec.f3 = IVCashr.Addr3;
    RepSpec.f4 = IVCashr.InvAddr3;
    RepSpec.f5 = IVCashr.InvAddr4;
    RepSpec.f10 = IVCashr.RegNr1;
    RepSpec.f11 = IVCashr.RegNr2;
    RepSpec.f12 = IVCashr.VATNr;
    wn = OpenWindow("ChangeAddressNPTSIVCashSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenChangeDiscountMatrix()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.FirstAcc = IVCashr.RebCode;
    wn = OpenWindow("ChangeDiscountMatrixNPTSIVCashSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"FirstAcc",false);    
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenChangeTerms()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.FirstAcc = IVCashr.PayDeal;
    RepSpec.f1 = IVCashr.CustOrdNr;
    RepSpec.f2 = IVCashr.OurContact;
    RepSpec.f3 = IVCashr.ClientContact;
    RepSpec.f4 = IVCashr.OfficialSerNr;
    RepSpec.LastAcc = IVCashr.Location;
    RepSpec.Language = IVCashr.LangCode;
    RepSpec.ObjStr = IVCashr.Objects;
    wn = OpenWindow("ChangeTermsNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenCommentLine()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.long1 = GetSelectedPOSItemRowIndex(mwn);
    wn = OpenWindow("CommentLineNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenHeaderLine()
begin
  Integer wn,mwn,line,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    RepSpec.long1 = GetSelectedPOSItemRowIndex(mwn);
    wn = OpenWindow("HeaderLineNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenHiddenLine()
begin
  Integer wn;
  record IVCashVc IVCashr;

  wn = CurWindow;
  AddInvoiceLineType(GetSelectedPOSItemRowIndex(wn)+1,10,false);
  GetWindowRecord(wn,IVCashr);
  IVCashDClass_RefreshStringList(wn,IVCashr);
  return;
end;

//shortkeys
global
updating function Boolean NPTSCashPaymentTClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedNPTSCashPaymentTClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  NPTSCashPaymentTClassFunctionKey = res;
  return;
end;

global
updating function Boolean CCPayTouchScreenDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;

  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedCCPayTouchScreenDClass;
      res = true;
    case 2: 
      CancelCCPayTouchScreenDClass;
      res = true;
    case 3: 
      CashPayTouchScreenKeypad;
      res = true;
  end;
  CCPayTouchScreenDClassFunctionKey = res;
  return;
end;

global
updating function Boolean DCPayTouchScreenDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedCCPayTouchScreenDClass;
      res = true;
    case 2: 
      CancelCCPayTouchScreenDClass;
      res = true;
    case 3: 
      CashPayTouchScreenKeypad;
      res = true;
  end;
  DCPayTouchScreenDClassFunctionKey = res;
  return;
end;

global
updating function Boolean OnAccountPaymentTouchScreenDClassOnOKWindow(Integer wn)
begin
  boolean res;

  ProceedOnAccountPaymentTouchScreenDClass;
  OnAccountPaymentTouchScreenDClassOnOKWindow = res;
  return;
end;

global
updating function Boolean OnAccountPaymentTouchScreenDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedOnAccountPaymentTouchScreenDClass;
      res = true;
    case 2: 
      CancelCCPayTouchScreenDClass;
      res = true;
  end;
  OnAccountPaymentTouchScreenDClassFunctionKey = res;
  return;
end;

global
updating function Boolean GiftVoucherTouchScreenDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedGiftVoucherTouchScreenDClass;
      res = true;
    case 2: 
      CancelCCPayTouchScreenDClass;
      res = true;
    case 3: 
      CashPayTouchScreenKeypad;
      res = true;
  end;
  GiftVoucherTouchScreenDClassFunctionKey = res;
  return;
end;

global
updating function Boolean ChequePayTouchScreenDClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedChequePayTouchScreenDClass;
      res = true;
    case 2: 
      CancelCCPayTouchScreenDClass;
      res = true;
    case 3: 
      CashPayTouchScreenKeypad;
      res = true;
  end;
  ChequePayTouchScreenDClassFunctionKey = res;
  return;
end;


global
updating function Boolean LoyalCardNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedLoyalCardNPTSSClass;
      res = true;
    case 2: 
      CancelAndOverrideLogout;
      res = true;
  end;
  LoyalCardNPTSSClassFunctionKey = res;
  return;
end;

global
updating function Boolean EnterBaggerNPTSOClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedEnterBaggerNPTSOClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  EnterBaggerNPTSOClassFunctionKey = res;
  return;
end;

global
updating function Boolean EnterSalesmanNPTSOClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedEnterSalesmanNPTSOClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  EnterSalesmanNPTSOClassFunctionKey = res;
  return;
end;

global
updating function Boolean SCDiscountCardNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedSCDiscountCardNPTSSClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  SCDiscountCardNPTSSClassFunctionKey = res;
  return;
end;

global
updating function Boolean AmendLineNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedAmendLineNPTSSClass;
      res = true;
    case 2: 
      CancelAndOverrideLogout;
      res = true;
    case 3: 
      CashPayTouchScreenKeypad;
      res = true;
  end;
  AmendLineNPTSSClassFunctionKey = res;
  return;
end;

global
updating function Boolean LoyaltyPaymentNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedLoyaltyPaymentNPTSSClass;
      res = true;
    case 2: 
      CancelAndOverrideLogout;
      res = true;
  end;
  LoyaltyPaymentNPTSSClassFunctionKey = res;
  return;
end;

global
updating function Boolean NPTSPaymentTClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedNPTSPaymentTClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  NPTSPaymentTClassFunctionKey = res;
  return;
end;

global
updating procedure ProceedNPTSPaymentBLayoutTClass()
begin
  ProceedNPTSPaymentTClass;
  return;
end;

global
updating procedure NPTSPaymentOneMode()
begin
  Integer wn,mwn,vwn;
  record RcVc RepSpec;
  record RcVc vRepSpec;
  record IVCashVc prevIVCr;
  record IVCashVc IVCr;
  row IVCashVc IVCrw;
  string 255 crncy;
  val fr,to1,to2,br1,br2,sum4;
  val totpaymentv,totcashv;
  Array string 255 acrncy,alabel,apaymentmode;
  Array Integer apaymenttype;
  Array val apaymentv;
  Array string 255 apaymentchecknr;
  Array string 255 apaymentauthcode;
  Integer i,acrncnt,rwcnt;
  record LocalMachineBlock LMb;
  record RahaxiBlock Rahaxib;
  vector val vpaymodeamounts;
  Boolean testf;
  string 255 paymode,tstr,tag;
  Integer stp,selpmrow;
  LongInt pos;
  val received;
  
  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    BlockLoad(LMb);
    GetWindowRecord(wn,RepSpec);
    tstr = PushButtonTag;
    pos = 0;
    GetNextSubstring(tstr,pos,",",paymode);
    GetNextSubstring(tstr,pos,",",tstr);
    stp = StringToInt(tstr);
    
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        sum4 = IVCr.Sum4;
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCr);
            if (prevIVCr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedNPTSPaymentOneModeTClass;
            end;
            if (prevIVCr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedNPTSPaymentOneModeTClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCr);
            if (prevIVCr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedNPTSPaymentOneModeTClass;
            end;
            if (prevIVCr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedNPTSPaymentOneModeTClass;
            end;
        end;
        if (IVCr.OKFlag!=0) then begin
          IVCr.OKFlag = 0;
        end;
        CntNPTSPaymentCurrenciesRemote(LMb.LocalMachineCode,alabel,acrncy,apaymenttype,apaymentmode,acrncnt);
        for (i=0;i<acrncnt;i=i+1) begin
          if (apaymenttype[i]==stp and apaymentmode[i]==paymode) then begin
            selpmrow = i;
            i = acrncnt;
          end;
        end;

        received = StringToVal(GetWindowString(wn,"NPTSPaymentTClassAmount"),M4Val);
        if (RepSpec.vals1>=0) then begin
          if (received<=0) then begin
            MessageBox(24191,"");
            goto LProceedNPTSPaymentOneModeTClass;
          end;
        end else begin
          if (received>0) then begin
            MessageBox(24191,"");
            goto LProceedNPTSPaymentOneModeTClass;
          end;
        end;
        totpaymentv = received;
        if (stp==kInvoiceRowTypeCashPayment) then begin
          totcashv = received;
        end;

        rwcnt = MatRowCnt(IVCr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(IVCr,i,IVCrw);
          switch (IVCrw.stp) begin
            case kInvoiceRowTypeCashPayment:
              vpaymodeamounts[IVCrw.PayMode] = vpaymodeamounts[IVCrw.PayMode] + IVCrw.Sum; 
              totcashv = totcashv + IVCrw.Sum;
              totpaymentv = totpaymentv + IVCrw.Sum;
            case kInvoiceRowTypeCreditCardPayment:
              vpaymodeamounts[IVCrw.PayMode] = vpaymodeamounts[IVCrw.PayMode] + IVCrw.Sum; 
              totpaymentv = totpaymentv + IVCrw.Sum;
            case kInvoiceRowTypeChequePayment:
              vpaymodeamounts[IVCrw.PayMode] = vpaymodeamounts[IVCrw.PayMode] + IVCrw.Sum; 
              totpaymentv = totpaymentv + IVCrw.Sum;
            case kInvoiceRowTypeGiftVoucherPayment:
              vpaymodeamounts[IVCrw.PayMode] = vpaymodeamounts[IVCrw.PayMode] + IVCrw.Sum; 
              totpaymentv = totpaymentv + IVCrw.Sum;
          end;
        end;

        if ((totpaymentv-totcashv)>IVCr.Sum4) then begin
          if (totpaymentv>totcashv) then begin
            MessageBox(20878,"");
            WindowFieldGoto(wn,RepSpec,-1,"NPTSPaymentBLayoutReceived",true);
            goto LProceedNPTSPaymentOneModeTClass;
          end;
        end;
        
        crncy = acrncy[selpmrow];

        if (GetFullCurncyPurchaseRate(crncy,IVCr.TransDate,fr,to1,to2,br1,br2)==false) then begin
          GetFullCurncyRate(crncy,IVCr.TransDate,fr,to1,to2,br1,br2);
        end;
        if (stp==kInvoiceRowTypeCreditCardPayment) then begin
          BlockLoad(Rahaxib);
          switch (Rahaxib.TerminalType) begin
            case kLocalCCTerminalVerifoneBanksys:
              vRepSpec.UsedOnly = kLocalCCTerminalVerifoneBanksys;
              vRepSpec.ArtMode = 1;
              vRepSpec.long1 = IVCr.SerNr;
              vRepSpec.AccStr = paymode;
              vRepSpec.f5 = alabel[selpmrow];
              vRepSpec.CurncyCode = crncy;
              vwn = OpenWindow("CCPayVerifoneProcessingWClass",0,wn,"","",vRepSpec);
              DeselectWindow(vwn,false);
              VerifoneBanksys_Purchase(received,paymode,alabel[selpmrow],vwn);
              goto LProceedNPTSPaymentOneModeTClass;
          end;


        end;
        ClearRow(IVCr,IVCrw,stp);

        IVCrw.stp = stp;
        IVCrw.Spec = alabel[selpmrow];
        IVCrw.Sum = received;
        IVCrw.PayMode = paymode;
        IVCrw.CurncyCode = crncy;
        IVCrw.FrRate = fr;
        IVCrw.ToRateB1 = to1;
        IVCrw.ToRateB2 = to2;
        IVCrw.BaseRate1 = br1;
        IVCrw.BaseRate2 = br2;  
        IVCrw.AuthorizationCode = GetWindowString(wn,"NPTSPaymentBLayoutAuthorizationCode");
        MatRowPut(IVCr,MatRowCnt(IVCr),IVCrw);

        PutWindowRecord(mwn,IVCr);
   end;
    if (WindowDoOK(mwn,0)) then begin
      DeselectWindow(wn,false);
      GetWindowRecord(wn,RepSpec);
      switch (GetWindowFileName(mwn)) begin
        case "IVCashVc":
          GetWindowRecord(mwn,IVCr);
          SetPOSWindowDisplay_PaymentRow(IVCrw.Spec,IVCr.RetValue);
          IVCashDClass_RefreshStringList(mwn,IVCr);
//          OpenCashDrawer_IVCashVc(IVCr);//only when OKING 
          PutWindowString(wn,"NPTSPaymentTClassAmount","");
          RepSpec.vals1 = IVCr.Sum4;

          RepSpec.vals1 = RepSpec.vals1 - totpaymentv;
          if (RepSpec.vals1<0) then begin RepSpec.vals1 = 0; end;
          RepSpec.vals2 = RepSpec.vals1;
          PutWindowString(wn,"NPTSPaymentTClassTotalDue",RepSpec.vals2);
          if (RepSpec.vals0<0) then begin
            RepSpec.vals0 = 0;
          end;

          PutWindowString(wn,"NPTSPaymentTClassBase1ChangeAmount",RepSpec.vals0);
          WindowFieldGotoForTouchScreen(wn,-1,"NPTSPaymentTClassAmount",true);
      end;
    end else begin
      CloseWindow(wn);
//?      SelectHWStoreWClass;
    end;
  end;
LProceedNPTSPaymentOneModeTClass:;  
  return;
end;

global
updating function Boolean NPTSPaymentOneModeTClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      NPTSPaymentOneMode;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  NPTSPaymentOneModeTClassFunctionKey = res;
  return;
end;

global
updating function Boolean NPTSOneModePaymentTClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedNPTSPaymentTClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  NPTSOneModePaymentTClassFunctionKey = res;
  return;
end;

global
updating function Boolean NPTSPaymentBLayoutTClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedNPTSPaymentBLayoutTClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  NPTSPaymentBLayoutTClassFunctionKey = res;
  return;
end;

global
updating function Boolean INNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      NPTSSearchItemOnceMore;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  INNPTSSClassFunctionKey = res;
  return;
end;

global
function Boolean SyncClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ToolAction(CurWindow,ToolStopSync,0,false);
      CloseWindow(CurWindow);
      res = true;
    case 2: 
      ToolAction(CurWindow,ToolStopSync,0,false);
      CloseWindow(CurWindow);
      res = true;
  end;
  SyncClassFunctionKey = res;
  return;
end;

global
function Boolean SyncOrExitClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ToolAction(CurWindow,ToolStopSync,0,false);
      CloseWindow(CurWindow);
      res = true;
    case 2: 
      ToolAction(CurWindow,ToolStopSync,0,false);
      CloseWindow(CurWindow);
      res = true;
  end;
  SyncOrExitClassFunctionKey = res;
  return;
end;

global
procedure IVCashDClassTouchScreenEditCustomerRecord()
begin
  record CUVc CUr;
  record IVCashVc IVCashr;
  Integer wn,nwn;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVCashr);
  CUr.Code = IVCashr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
    nwn = OpenWindow("CUDClass",0,wn,"","",CUr);
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenEditDate()
begin
  record IVCashVc IVCashr;
  Integer wn,nwn;
  record RcVc RepSpec;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVCashr);
  RepSpec.d1 = IVCashr.InvDate;
  nwn = OpenWindow("ChangeDateNPTSSClass",0,wn,"","",RepSpec);
  return;
end;

global
procedure ProceedChangeDateNPTSSClassExecute(Integer wn)
begin
  Integer mwn,rownr;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  record IVVc IVr;
  record IVVc prevIVr;
  string 255 tstr,t2;
  Boolean ivcashcommandf;
  Integer i,rwcnt,err1,err2;
  record LocalMachineBlock LMb;
  
  ivcashcommandf = true;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
        end;
        IVCashr.InvDate = RepSpec.d1;
        PasteIVCashInvDate(mwn,IVCashr);
        IVCashr.TransDate = RepSpec.d1;
        PutWindowRecord(mwn,IVCashr);
//        IVCashDClass_RefreshStringList(mwn,IVCashr);
        ReRunWindowDef(mwn);
        CloseWindow(wn);
      case "IVVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVr);
            if (prevIVr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
            if (prevIVr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedChangeDateNPTSSClassExecute;
            end;
        end;
        BlockLoad(LMb);
        IVr.InvDate = RepSpec.d1;
        IVVc_PasteInvDate(IVr,LMb,err1,err2);
//        IVCashr.TransDate = RepSpec.d1;
        PutWindowRecord(mwn,IVr);
//        IVDClass_RefreshStringList(mwn,IVr);
        ReRunWindowDef(mwn);
        CloseWindow(wn);
    end;
  end;
LProceedChangeDateNPTSSClassExecute:;  
  if (ivcashcommandf) then begin
    //WindowFieldGoto(mwn,RepSpec,-1,"ivcashcommand",true);
    WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
  end;
  return;
end;

global
procedure ProceedChangeDateNPTSSClass()
begin  
  ProceedChangeDateNPTSSClassExecute(CurWindow);
  return;
end;

global
function Boolean ChangeDateNPTSSClassFunctionKey(LongInt keycode,Boolean shflag,Boolean ctrlflag)
begin
  Integer wn;
  Boolean res;
    
  wn = CurWindow;
  switch (keycode) begin
    case 1: 
      ProceedChangeDateNPTSSClass;
      res = true;
    case 2: 
      CancelNPTSCashPaymentTClass;
      res = true;
  end;
  ChangeDateNPTSSClassFunctionKey = res;
  return;
end;

global
procedure IVCashDClassTouchScreenPreviousSalesPrices()
begin
  IVCashLastSPrsm;
  return;
end;

global
updating procedure IVCashDClassTouchScreenSendEmail()
begin
  CreateMailFromIVCashDsm;
  return;
end;

updating procedure AttachGSXNotesToSVOSer(record SVOSerVc SVOSerr,record NotepadVc csNotesr,record NotepadVc Notesr)
begin
  if (SizeTextCnt(csNotesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,csNotesr,CurrentCompany);
  end;
  if (SizeTextCnt(Notesr)>0) then begin
    CreateRecordLink(SVOSerr,CurrentCompany,Notesr,CurrentCompany);
  end;
  return;
end;

global
updating procedure IVCashDClassTouchScreenAppleWarrantyStatusCheck()
begin
  Integer wn,rownr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  Boolean eligiblef,resellerstatusf;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVCashr,rownr,IVCashrw);
    ACPr.ArtCode = IVCashrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVCashDClassTouchScreenAppleWarrantyStatusCheck;
    end;
    if (blank(IVCashrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVCashDClassTouchScreenAppleWarrantyStatusCheck;
    end;
    SVOSerr.ItemCode = IVCashrw.ArtCode;
    SVOSerr.SerialNr = IVCashrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    resellerstatusf = true;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVCashrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVCashr.CustCode;
      SVOSerr.CustName = IVCashr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = true;
//        resellerstatusf = false;// we should be able to check status is eligible
      end;
      if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
          eligiblef = false;
          resellerstatusf = false;
        end;
        if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
          eligiblef = true;
          resellerstatusf = false;
        end;
      end;
    end;
//686641
    if (resellerstatusf) then begin
      BlockLoad(GSb);
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
  //      if (GSXWarrantyStatus(sessionID,IVCashrw.MotherNr,d,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
        if (GSXResellerWarrantyStatusIVCash(sessionID,IVCashr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);      
  
          if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
          end;
          if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
          end;

          if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
              MessageBox(23704," " & SVOSerr.WarrantyStatus);
            end;
            if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
              MessageBox(23706," " & SVOSerr.WarrantyStatus);
            end;
          end;
          if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23705,"");
          end;
        end else begin 
          MessageBox(0,errormsg);
        end;
  //    if (GSXLogout(sessionID)) then begin StopAlert("logout ok"); end;
      end else begin
        MessageBox(0,errormsg);
  //      IVCashrw.MotherNr = "";
  //      MatRowPut(IVCashr,rownr,IVCashrw);
  //      PutWindowRecord(wn,IVCashr);
  //      WindowDoOK(wn,0);
      end;
    end else begin
      if (eligiblef) then begin
        MessageBox(23706,"");
      end else begin
        MessageBox(23704,"");
      end;
    end;
  end;
  if (testf) then begin
  end;
LIVCashDClassTouchScreenAppleWarrantyStatusCheck:;
  return;
end;

global
updating procedure IVCashDClassTouchScreenAppleCreateAEOrder()
begin
  Integer wn,rownr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  Boolean eligiblef,resellerstatusf;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVCashr,rownr,IVCashrw);
    if (IVCashrw.AEStatus==kGSXAutoEnrollmentSent) then begin
      MessageBox(23708,"");
      goto LIVCashDClassTouchScreenAppleCreateAEOrder;
    end;
    ACPr.ArtCode = IVCashrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVCashDClassTouchScreenAppleCreateAEOrder;
    end;
    if (blank(IVCashrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVCashDClassTouchScreenAppleCreateAEOrder;
    end;
    BlockLoad(GSb);
    SVOSerr.ItemCode = IVCashrw.ArtCode;
    SVOSerr.SerialNr = IVCashrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    resellerstatusf = true;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVCashrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVCashr.CustCode;
      SVOSerr.CustName = IVCashr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = true;
        resellerstatusf = false;
      end;
      if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        eligiblef = false;
        resellerstatusf = false;
      end;
      if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
        if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
          eligiblef = false;
          resellerstatusf = false;
        end;
        if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
          eligiblef = true;
          resellerstatusf = false;
        end;
      end;
    end;
    if (resellerstatusf) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
  //      if (GSXWarrantyStatus(sessionID,IVCashrw.MotherNr,d,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
        if (GSXResellerWarrantyStatusIVCash(sessionID,IVCashr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);      
  
          if (SVOSerr.CoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.CoverageEndDate)) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
            eligiblef = false;
          end;
          if (blankdate(SVOSerr.CoverageEndDate)) and (SVOSerr.ContractCoverageEndDate<CurrentDate) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23704," " & SVOSerr.WarrantyStatus);
            eligiblef = false;
          end;

          if (nonblankdate(SVOSerr.CoverageEndDate)) and (nonblankdate(SVOSerr.ContractCoverageEndDate)) then begin
            if (SVOSerr.ContractCoverageEndDate<CurrentDate) then begin
              MessageBox(23704," " & SVOSerr.WarrantyStatus);
              eligiblef = false;
            end;
            if (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
              MessageBox(23706," " & SVOSerr.WarrantyStatus);
              eligiblef = false;
            end;
          end;
          if (SVOSerr.CoverageEndDate>CurrentDate) and (blankdate(SVOSerr.ContractCoverageEndDate)) then begin
            MessageBox(23705,"");
            eligiblef = true;
          end;
        end else begin 
          MessageBox(0,errormsg);
          eligiblef = false;
        end;
        
      end;
    end else begin
      if (eligiblef==false) then begin
        MessageBox(23704,"");
      end;
    end;
    if (eligiblef) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerAutoEnrollmentIVCash(GSb,sessionID,IVCashr,rownr,errormsg)) then begin
          MatRowGet(IVCashr,rownr,IVCashrw);
          IVCashrw.AEStatus = kGSXAutoEnrollmentSent;
          MatRowPut(IVCashr,rownr,IVCashrw);
          PutWindowRecord(wn,IVCashr);
          WindowDoOK(wn,0);
          IVCashDClass_RefreshStringList(wn,IVCashr);
        end;
      end;
      MessageBox(0,errormsg);
    end;
  end;
LIVCashDClassTouchScreenAppleCreateAEOrder:;
  return;
end;

global
updating procedure IVCashDClassTouchScreenAppleCancelAEOrder()
begin
  Integer wn,rownr;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr;
  Boolean testf,found;
  record ACPVc ACPr;
  record SVOSerVc SVOSerr;
  record INVc INr;
  record NotepadVc csNotesr,Notesr;
  array string 255 a_partNumbers;
  string 255 sessionID,errormsg;
  record GSXSettingsBlock GSb;
  date d;
  
  wn = CurWindow;
  rownr = GetSelectedPOSItemRowIndex(wn);
  GetWindowRecord(wn,IVCashr);
  testf = true;
//  if (IVCashr.OKFlag!=0) then begin testf = false; end;
//  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (rownr<0) then begin testf = false; end;
  if (testf) then begin
    MatRowGet(IVCashr,rownr,IVCashrw);
    if (IVCashrw.AEStatus!=kGSXAutoEnrollmentSent) then begin
      MessageBox(23705,"");
      goto LIVCashDClassTouchScreenAppleCancelAEOrder;
    end;
    ACPr.ArtCode = IVCashrw.ArtCode;
    if (ReadFirstMain(ACPr,1,true)==false) then begin
      MessageBox(23702,"");
      goto LIVCashDClassTouchScreenAppleCancelAEOrder;
    end;
    if (blank(IVCashrw.MotherNr)) then begin
      MessageBox(23700,"");
      goto LIVCashDClassTouchScreenAppleCancelAEOrder;
    end;
    BlockLoad(GSb);
    SVOSerr.ItemCode = IVCashrw.ArtCode;
    SVOSerr.SerialNr = IVCashrw.MotherNr;
    found = ReadFirstMain(SVOSerr,2,true);
    if (found==false) then begin
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      found = ReadFirstMain(SVOSerr,1,true);
    end;
    testf = false;
    if (found==false) then begin
      RecordNew(SVOSerr);
      SVOSerr.ItemCode = ""; //IVCashrw.ArtCode; find item code of serial nr , but what in case of items we have not sold ? 
      SVOSerr.SerialNr = IVCashrw.MotherNr;
      INr.Code = SVOSerr.ItemCode;
      if (ReadFirstMain(INr,1,true)) then begin
        SVOSerr.ItemName = INr.Name;
      end;
      SVOSerr.CustCode = IVCashr.CustCode;
      SVOSerr.CustName = IVCashr.Addr0;
      //TODO: fill in all more of the basics (cost, sold date that we know about, etc)
    end else begin
      if (SVOSerr.CoverageEndDate>CurrentDate) and (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
        testf = true;
      end;
      if (nonblank(SVOSerr.APPAgreementNumber)) then begin
        testf = true;
      end;
    end;
    if (testf==false) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerWarrantyStatusIVCash(sessionID,IVCashr,rownr,a_partNumbers,0,SVOSerr,csNotesr,Notesr,errormsg)) then begin
          RecordStore(SVOSerr,true);
          AttachGSXNotesToSVOSer(SVOSerr,csNotesr,Notesr);
          if (SVOSerr.CoverageEndDate>CurrentDate) and (SVOSerr.ContractCoverageEndDate>CurrentDate) then begin
            testf = true;
          end;
          if (nonblank(SVOSerr.APPAgreementNumber)) then begin
            testf = true;
          end;
        end else begin 
          MessageBox(0,errormsg);
        end;        
      end;
    end;
    if (testf) then begin
      if (GSXResellerLogin(GSb.AppleID,GSb.Password,GSb.AccountNo,sessionID,errormsg)) then begin
        if (GSXResellerCancelAutoEnrollmentIVCash(GSb,sessionID,IVCashr,rownr,errormsg)) then begin
          MatRowGet(IVCashr,rownr,IVCashrw);
          IVCashrw.AEStatus = kGSXAutoEnrollmentCancelled;
          MatRowPut(IVCashr,rownr,IVCashrw);
          PutWindowRecord(wn,IVCashr);
          WindowDoOK(wn,0);
          IVCashDClass_RefreshStringList(wn,IVCashr);
        end;
      end;
      MessageBox(0,errormsg);
    end else begin
      MessageBox(23704,"");
    end;
  end;
LIVCashDClassTouchScreenAppleCancelAEOrder:;
  return;
end;

global
procedure IVCashDClassTouchScreenMainSerialNrExecute(LongInt rownr)
begin
  Integer wn,mwn,line;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  row IVCashVc IVCashrw;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  RepSpec.long1 = rownr;
  if (RepSpec.long1<0) then begin
    RepSpec.long1 = GetSelectedPOSItemRowIndex(mwn);
  end;
  if (RepSpec.long1>=0) then begin
    GetWindowRecord(mwn,IVCashr);
    MatRowGet(IVCashr,RepSpec.long1,IVCashrw);
    testf = true;
    if (IVCashr.OKFlag!=0) then begin testf = false; end;
    if (IVCashr.Invalid!=0) then begin testf = false; end;
    if (RepSpec.long1<0) then begin testf = false; end;
    if (testf) then begin
      RepSpec.f1 = IVCashrw.MotherNr;
      RepSpec.f2 = IVCashrw.MotherSecondarySerialNr;
      RepSpec.f3 = IVCashrw.MotherAlternateDeviceID;
      wn = OpenWindow("MainSerialNrNPTSSClass",0,mwn,"","",RepSpec);
      WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
    end;
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenMainSerialNr()
begin
  IVCashDClassTouchScreenMainSerialNrExecute(-1);
  return;
end;

updating procedure ProceedQTPasteNPTSSClassExecute(Integer wn)
begin
  Integer mwn,nwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr,prevIVCashr;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    if (blank(RepSpec.f1)) then begin
      goto LProceedQTPasteNPTSSClassExecute;
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedQTPasteNPTSSClassExecute;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedQTPasteNPTSSClassExecute;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedQTPasteNPTSSClassExecute;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedQTPasteNPTSSClassExecute;
            end;
        end;
        QTPasteNPTSSClassRemote(RepSpec.f1,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        GetWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
        CloseWindow(wn);
        ReRunWindowDef(mwn);
    end;
  end;
LProceedQTPasteNPTSSClassExecute:;  
  return;
end;

global
updating procedure ProceedQTPasteNPTSSClass()
begin
  ProceedQTPasteNPTSSClassExecute(CurWindow);
  return;
end;

global
procedure IVCashDClassTouchScreenPasteQT()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("QTPasteNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

updating procedure ProceedORPasteNPTSSClassExecute(Integer wn)
begin
  Integer mwn,nwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr,prevIVCashr;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    if (blank(RepSpec.f1)) then begin
      goto LProceedORPasteNPTSSClassExecute;
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedORPasteNPTSSClassExecute;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedORPasteNPTSSClassExecute;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedORPasteNPTSSClassExecute;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedORPasteNPTSSClassExecute;
            end;
        end;
        ORPasteNPTSSClassRemote(RepSpec.f1,IVCashr);
        PutWindowRecord(mwn,IVCashr);
        GetWindowRecord(mwn,IVCashr);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
        CloseWindow(wn);
        ReRunWindowDef(mwn);
    end;
  end;
LProceedORPasteNPTSSClassExecute:;  
  return;
end;

global
updating procedure ProceedORPasteNPTSSClass()
begin
  ProceedORPasteNPTSSClassExecute(CurWindow);
  return;
end;

global
updating procedure ProceedEnterReferenceNumberNPTSSClass()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr,prevIVCashr;
  
  wn = CurWindow;
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    if (blank(RepSpec.f1)) then begin
      goto LProceedEnterReferenceNumberNPTSSClass;
    end;
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterReferenceNumberNPTSSClass;
            end;
            if (prevIVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterReferenceNumberNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterReferenceNumberNPTSSClass;
            end;
            if (IVCashr.Invalid!=0) then begin
              CloseWindow(wn);
              goto LProceedEnterReferenceNumberNPTSSClass;
            end;
        end;
        IVCashr.RefStr = RepSpec.f1;
        PutWindowRecord(mwn,IVCashr);
        GetWindowRecord(mwn,IVCashr);
        ReRunWindowDef(mwn);
        IVCashDClass_RefreshStringList(mwn,IVCashr);
        WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true);
        CloseWindow(wn);
    end;
  end;
LProceedEnterReferenceNumberNPTSSClass:;  
  return;
end;

global
procedure IVCashDClassTouchScreenPasteOR()
begin
  Integer wn,mwn;
  record RcVc RepSpec;
  record IVCashVc IVCashr;
  string 255 tstr;
  Boolean testf;
  
  mwn = CurWindow;
  RecordClear(RepSpec);
  GetWindowRecord(mwn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    wn = OpenWindow("ORPasteNPTSSClass",0,mwn,"","",RepSpec);
    WindowFieldGoto(wn,RepSpec,-1,"f1",false);    
  end;
  return;
end;

global
updating procedure IVCashDClassTouchScreenPauseSales()
begin
  Integer wn;
  record IVCashVc IVCashr;
  string 255 tstr;
  Boolean testf;
  
  wn = CurWindow;
  GetWindowRecord(wn,IVCashr);
  testf = true;
  if (IVCashr.OKFlag!=0) then begin testf = false; end;
  if (IVCashr.Invalid!=0) then begin testf = false; end;
  if (testf) then begin
    WindowDoOK(wn,0);
    CloseWindow(wn);
    RecordNew(IVCashr);
    wn = OpenWindow("NPTSIVCashDClass",0,0,"","",IVCashr);
  end;
  return;
end;

global
procedure IVCashDClassTouchScreenResumeSales()
begin
  array record IVCashVc aIVCashr;
  record IVCashVc IVCashr;
  record RcVc RepSpec;
  Integer wn,i;
  
  wn = CurWindow;
  PausedPOInvoices(CurrentUser,aIVCashr);
  if (aIVCashr.length==0) then begin
    goto LIVCashDClassTouchScreenResumeSales;
  end;
  CloseWindow(wn);
  if (aIVCashr.length>1) then begin
    wn = OpenWindow("PausedIVCashLClass",0,0,"","",RepSpec);
    if (wn>0) then begin
      for (i=0;i<aIVCashr.length;i=i+1) begin
        RecordCopy(IVCashr,aIVCashr[i]);
        AddListRow(wn,"pausedsales",1,IVCashr.SerNr,0);
        AddListData(wn,"pausedsales","nr",IVCashr.SerNr);
        AddListData(wn,"pausedsales","custcode",IVCashr.CustCode);
        AddListData(wn,"pausedsales","date",IVCashr.InvDate);
      end;      
//      ReRunWindowDef(wn);
      StringListScrollBottom(wn);
      SetSelectedListLine(wn,0);
    end;
  end else begin
    RecordCopy(IVCashr,aIVCashr[0]);
    wn = OpenWindow("NPTSIVCashDClass",0,0,"","",IVCashr);
    WindowFieldGotoForTouchScreen(wn,-1,"ivcashcommand",false);
  end;
LIVCashDClassTouchScreenResumeSales:;  
  return;
end;

global
function Boolean PausedIVCashLClassOnOKWindow(Integer wn)
begin
  Integer nwn;
  record IVCashVc IVCashr;

  IVCashr.SerNr = StringToLongInt(GetListString(wn,SelectedListLine(wn)));
  if (ReadFirstMain(IVCashr,1,true)) then begin
    nwn = OpenWindow("NPTSIVCashDClass",0,0,"","",IVCashr);
    WindowFieldGotoForTouchScreen(nwn,-1,"ivcashcommand",false);
  end;
  CloseWindow(wn);
  PausedIVCashLClassOnOKWindow = false;
  return;
end;

global
updating procedure ProceedOfficialSerNrNPTSSClassExecute(Integer wn)
begin
  Integer mwn,nwn,rownr;
  record RcVc RepSpec;
  record RcVc newRepSpec;
  record IVCashVc IVCashr;
  record IVCashVc prevIVCashr;
  string 255 tstr,t2;
  
  DeselectWindow(wn,true);
  mwn = MotherWindow(wn);
  if (mwn!=0) then begin
    GetWindowRecord(wn,RepSpec);
    switch (GetWindowFileName(mwn)) begin
      case "IVCashVc":
        DeselectWindow(mwn,false);
        GetWindowRecord(mwn,IVCashr);
        switch (WindowState(mwn)) begin
          case Rs_update:
            GetPrevWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOfficialSerNrNPTSSClass;
            end;
          case Rs_normal:
            GetWindowRecord(mwn,prevIVCashr);
            if (prevIVCashr.OKFlag!=0) then begin
              CloseWindow(wn);
              goto LProceedOfficialSerNrNPTSSClass;
            end;
        end;
        IVCashr.OfficialSerNr = RepSpec.f1;
        IVCashr.Status = kRecordStatusManual;
        PutWindowRecord(mwn,IVCashr);
        ReRunWindowDef(mwn);
        WindowDoOK(mwn,0);
        CloseWindow(wn);
    end;
  end;
LProceedOfficialSerNrNPTSSClass:;  
  WindowFieldGotoForTouchScreen(mwn,-1,"ivcashcommand",true); 
  return;
end;

global
updating procedure ProceedOfficialSerNrNPTSSClass()
begin  
  if (UserCanAction("OverrideLegalSerialNr",false)) then begin
    ProceedOfficialSerNrNPTSSClassExecute(CurWindow);
  end else begin
    MessageBox(1274,StringFromStringSet(3,"OverrideLegalSerialNr"));
  end;
  return;
end;