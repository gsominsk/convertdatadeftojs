/* RestKOWActions.hal */

remote updating procedure MarkKODelivered(record RcVc);
remote procedure KOrdPopulateHtml(record LocalMachineBlock,record RcVc,var string,string);
external function LongInt DateDiff(Date,Date);
external function LongInt TimeToSeconds2(Time);

function string 255 PageStart1()
begin
  string 255 res;
  
//  res = res & "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\" \"http://www.w3.org/TR/html4/strict.dtd\">" & chr(10);
  res = res & "<!DOCTYPE HTML>" & chr(10);

  res = res & "<html>" & chr(10);
  res = res & "  <head><meta http-equiv='Compatible' content='IE=9' />" & chr(10);

  if (FileExists(ResourceFolder & "/kostyles.css")) then begin 
    if (WindowsMode) then begin
      res = res & "    <link rel='stylesheet' href='res://" & ResourceFolder & "/kostyles.css' type='text/css' />" & chr(10);
    end else begin
      res = res & "    <link rel='stylesheet' href='file://" & ResourceFolder & "/kostyles.css' type='text/css' />" & chr(10);
    end;
  end else begin  
    res = res & "<style>" & chr(10);
    res = res & "html, body, div, span, applet, object, iframe," & chr(10);
    res = res & "h1, h2, h3, h4, h5, h6, p, blockquote, pre," & chr(10);
    res = res & "a, abbr, acronym, address, big, cite, code," & chr(10);
    res = res & "del, dfn, em, img, ins, kbd, q, s, samp," & chr(10);
    res = res & "small, strike, strong, sub, sup, tt, var," & chr(10);
    res = res & "b, u, i, center," & chr(10);
    res = res & "dl, dt, dd, ol, ul, li," & chr(10);
    res = res & "fieldset, form, label, legend," & chr(10);
    res = res & "table, caption, tbody, tfoot, thead, tr, th, td," & chr(10);
    res = res & "article, aside, canvas, details, embed, " & chr(10);
    res = res & "figure, figcaption, footer, header, hgroup, " & chr(10);
    res = res & "menu, nav, output, ruby, section, summary," & chr(10);
    res = res & "time, mark, audio, video, font {" & chr(10);
    res = res & "	margin: 0;" & chr(10);
    res = res & "	padding: 0;" & chr(10);
    res = res & "	border: 0;" & chr(10);
    res = res & "	font-size: 100%;" & chr(10);
    res = res & "	font: inherit;" & chr(10);
    res = res & "	vertical-align: baseline;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "/* HTML5 display-role reset for older browsers */" & chr(10);
    res = res & "article, aside, details, figcaption, figure, " & chr(10);
    res = res & "footer, header, hgroup, menu, nav, section {" & chr(10);
    res = res & "	display: block;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "body {" & chr(10);
    res = res & "	line-height: 1;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "ol, ul {" & chr(10);
    res = res & "	list-style: none;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "blockquote, q {" & chr(10);
    res = res & "	quotes: none;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "blockquote:before, " & chr(10);
    res = res & "blockquote:after," & chr(10);
    res = res & "q:before, q:after {" & chr(10);
    res = res & "	content: '';" & chr(10);
    res = res & "	content: none;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "table {" & chr(10);
    res = res & "	border-collapse: collapse;" & chr(10);
    res = res & "	border-spacing: 0;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "body, input, a{" & chr(10);
    res = res & "font-family:sans-serif; " & chr(10);
    res = res & "font-weight: regular;" & chr(10);
    res = res & "color:#000;" & chr(10);
    res = res & "-webkit-user-select: none;  /* Chrome all / Safari all */-moz-user-select: none;     /* Firefox all */" & chr(10);
    res = res & "-ms-user-select: none;      /* IE 10+ */" & chr(10);
    res = res & "-o-user-select: none;" & chr(10);
    res = res & "user-select: none; " & chr(10);
    res = res & "letter-spacing:.3pt;" & chr(10);
    res = res & "margin:0;" & chr(10);
    res = res & "padding:0;" & chr(10);
    res = res & "font-size:17px;" & chr(10);
    res = res & "font-weight:300;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "" & chr(10);
    res = res & "table{" & chr(10);
    res = res & "height:100%;" & chr(10);
    res = res & "width:100%;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOHeadingmain{" & chr(10);
    res = res & "height:30px;" & chr(10);
    res = res & "padding:0 12px;" & chr(10);
    res = res & "font-size:13px;" & chr(10);
    res = res & "box-shadow: 0 -3px 3px rgba(0,0,0,.5) inset;" & chr(10);
    res = res & "justify-content:space-between;" & chr(10);
    res = res & "-webkit-justify-content:space-between;" & chr(10);
    res = res & "align-items: center;" & chr(10);
    res = res & "-webkit-align-items:center;" & chr(10);
    res = res & "overflow:hidden;" & chr(10);
    res = res & "font-weight:400;" & chr(10);
    res = res & "text-shadow:0 1px 1px #fff;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOHeadingmain, " & chr(10);
    res = res & "#Blankpanel{" & chr(10);
  //  res = res & "background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QTg2RUQ4MkRBMTUyMTFFMzgwMjlEREQwMzdBOUVFRTgiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QTg2RUQ4MkNBMTUyMTFFMzgwMjlEREQwMzdBOUVFRTgiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmRpZDowMTgwMTE3NDA3MjA2ODExOEMxNDgxQUI4MDQ4OTE5RiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowMTgwMTE3NDA3MjA2ODExOEMxNDgxQUI4MDQ4OTE5RiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PkliuqAAAAG1SURBVHjabJNZksMwCAVlxXH2+18y+77Y8bTdU5QnGT4ohODxQCi93++madq2PZ/P7UBOpxO6rmuPz+cT/Xg80IfDQTtfLpecc0ppsViQj0ECerlcokejUeqFGmgg0K/Xi3pVVeX5fM5BbOOu12saiFigYIzHY4qhOVK5JAcMLqpeiCuKounFY1mW3EJqtVqRM5lMBCUsT6dTaNMhETaPB4O7qMwRgmRyi60/2y3FYYKXa8lTEw/tWDlYGAbcbrcDqOswJqztnEOMbv+TLD0HOJvNYs4Ifd7vd9gxpPQlDKzoqvfJ0IMzWDC83W4COXwaFoUAcpwcBJPvDnZsApno4/FoYwos8HzQTvYDsHuDsA+i+P5DARcim83mNzkslxF4Hww4cZ0ix9hWqXXJwTnu6l5i1YejhpS7bUqS4fBOtu7Gfr+P4sLhJAyC3bab7Ns6PDzf3SqSpyzMu1WzIKhBAVa2PdwW4OT1Z9pUwwvJf0eCM5qXl0D4u9Xg6VkMHp0Efgxed4bvASgLwy0GYTj9njjxdKs5fNjhhoes12v73G63wdz49NGGo6Jn9wkD2h9wcfwRYAAC4X4OjxIVuQAAAABJRU5ErkJggg==');" & chr(10);
    res = res & "opacity:1;" & chr(10);
    res = res & "background-color:rgba(255,255,255,1);" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain{" & chr(10);
    res = res & "xheight:95%;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain #Blankpanel{" & chr(10);
    res = res & "box-shadow: 0 2px 0 #fff inset, 0 -2px 0 #fff inset, 2px 0 0 #fff inset, -2px 0 0 #fff inset,  0 0 8px #000 inset;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "input, a{" & chr(10);
    res = res & "background:none;" & chr(10);
    res = res & "background-color:rgba(255,255,255,1);" & chr(10);
    res = res & "border:none;" & chr(10);
    res = res & "border-radius:4px;" & chr(10);
    res = res & "padding:4px 8px;" & chr(10);
    res = res & "color:#888;" & chr(10);
    res = res & "box-shadow:0 0 2px #000 inset;" & chr(10);
    res = res & "box-shadow:0 0 2px rgba(0,0,0,.2) inset;" & chr(10);
    res = res & "transition:box-shadow .1s;" & chr(10);
    res = res & "-webkit-transition:box-shadow .1s;" & chr(10);
    res = res & "transition-timing-function: ease-Out;" & chr(10);
    res = res & "-webkit-transition-timing-function: ease-Out;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOHeadingmain input, #KOHeadingmain a{" & chr(10);
    res = res & "color:#000;" & chr(10);
    res = res & "padding:2px 8px;" & chr(10);
    res = res & "font-size:15px;" & chr(10);
    res = res & "border:1px solid #b3b3b3;" & chr(10);
    res = res & "} " & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain input:active, #KOHeadingmain input:active, a:active{" & chr(10);
    res = res & "box-shadow:0 0 6px #000 inset;" & chr(10);
    res = res & "box-shadow:0 0 6px rgba(0,0,0,.8) inset;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOHeadingmain, " & chr(10);
    res = res & "#KOmain tr{" & chr(10);
    res = res & "  display: -webkit-box;      /* OLD - iOS 6-, Safari 3.1-6 */" & chr(10);
    res = res & "  display: -moz-box;         /* OLD - Firefox 19- (buggy but mostly works) */" & chr(10);
    res = res & "  display: -ms-flexbox;      /* TWEENER - IE 10 */" & chr(10);
    res = res & "  display: -webkit-flex;     /* NEW - Chrome */" & chr(10);
    res = res & "  display: flex; " & chr(10);
    res = res & "  flex-direction: row;" & chr(10);
    res = res & "  -webkit-flex-direction: row;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain tr{" & chr(10);
    res = res & "height:150px;" & chr(10);
    res = res & "width:100%;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain td{" & chr(10);
    res = res & "width:20%;" & chr(10);
    res = res & "height:100%;" & chr(10);
    res = res & "float:left;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain tr, " & chr(10);
    res = res & "#KOmain td{" & chr(10);
    res = res & "position:relative;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain td, #KOmain th{" & chr(10);
    res = res & "box-shadow:0 2px 0 #fff inset, 0 -2px 0 #fff inset, 2px 0 0 #fff inset, -2px 0 0 #fff inset;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain td div," & chr(10);
    res = res & "#KOmain th div{" & chr(10);
    res = res & "margin:4px 12px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain td #KOpanelNo{" & chr(10);
    res = res & "margin-top:12px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#OpenKODetailsBtn, " & chr(10);
    res = res & "#OpenKODeliveredBtn{" & chr(10);
    res = res & "position:absolute;" & chr(10);
    res = res & "bottom:14;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#OpenKODetailsBtn{" & chr(10);
    res = res & "left:0;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#OpenKODeliveredBtn{" & chr(10);
    res = res & "right:0;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "/*details Panel*/" & chr(10);
    res = res & "" & chr(10);
    res = res & "" & chr(10);
    res = res & "#OpenKODeliverReturnBtn{" & chr(10);
    res = res & "text-align:right;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel table{" & chr(10);
    res = res & "display:flex;" & chr(10);
    res = res & "justify-content: center;" & chr(10);
    res = res & "-webkit-justify-content: center;" & chr(10);
    res = res & "height:auto;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel tr{" & chr(10);
    res = res & "display:table-row;" & chr(10);
    res = res & "height:24px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#DetailedRowHead th{" & chr(10);
    res = res & "background:lightgrey;" & chr(10);
    res = res & "height:40px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel td, " & chr(10);
    res = res & "#div_main_details_panel th{" & chr(10);
    res = res & "float:none;" & chr(10);
    res = res & "display:table-cell;" & chr(10);
    res = res & "vertical-align:middle;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel td div{" & chr(10);
    res = res & "height:24px;" & chr(10);
    res = res & "line-height:24px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel .ItemCodeClass," & chr(10);
    res = res & "#div_main_details_panel #KODetailedcol1{" & chr(10);
    res = res & "text-align:right;" & chr(10);
    res = res & "width:10%;" & chr(10);
    res = res & "} " & chr(10);
    res = res & "#div_main_details_panel .ItemQtyClass," & chr(10);
    res = res & "#div_main_details_panel #KODetailedcol2{" & chr(10);
    res = res & "text-align:right;" & chr(10);
    res = res & "width:10%;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#div_main_details_panel .ItemSpecClass, " & chr(10);
    res = res & "#div_main_details_panel #KODetailedcol3{" & chr(10);
    res = res & "width:80%;" & chr(10);
    res = res & "text-align:left;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "@media all and (max-height: 800px){" & chr(10);
    res = res & ".MainPanelDisplay #KOmain td div{" & chr(10);
    res = res & "margin:4px 20px" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain td #KOpanelNo{" & chr(10);
    res = res & "margin:20px 20px 4px 20px " & chr(10);
    res = res & "}" & chr(10);
    res = res & "#div_main_details_panel td div{" & chr(10);
    res = res & "height:32px;" & chr(10);
    res = res & "line-height:32px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#OpenKODetailsBtn, " & chr(10);
    res = res & "#OpenKODeliveredBtn{" & chr(10);
    res = res & "bottom:20px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "#KOmain a{" & chr(10);
    res = res & "height:20px;" & chr(10);
    res = res & "line-height:20px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "@media all and (max-height: 700px){" & chr(10);
    res = res & ".MainPanelDisplay #KOmain tr{" & chr(10);
    res = res & "height:130px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#DetailedRowHead th{" & chr(10);
    res = res & "background:lightgrey;" & chr(10);
    res = res & "height:35px;" & chr(10);
    res = res & "font-size:16px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain td div{" & chr(10);
    res = res & "font-size:16px;" & chr(10);
    res = res & "margin:4px 16px" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain td #KOpanelNo{" & chr(10);
    res = res & "margin:17px 17px 4px 17px " & chr(10);
    res = res & "}" & chr(10);
    res = res & "#div_main_details_panel td div{" & chr(10);
    res = res & "height:24px;" & chr(10);
    res = res & "line-height:24px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain a{" & chr(10);
    res = res & "font-size:16px;" & chr(10);
    res = res & "height:16px;" & chr(10);
    res = res & "line-height:16px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "}" & chr(10);
    res = res & "" & chr(10);
    res = res & "@media all and (max-height: 600px){" & chr(10);
    res = res & ".MainPanelDisplay #KOmain tr{" & chr(10);
    res = res & "height:120px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#DetailedRowHead th{" & chr(10);
    res = res & "background:lightgrey;" & chr(10);
    res = res & "height:30px;" & chr(10);
    res = res & "font-size:14px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain td div{" & chr(10);
    res = res & "font-size:14px;" & chr(10);
    res = res & "margin:4px 14px" & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain td #KOpanelNo{" & chr(10);
    res = res & "margin:14px 14px 4px 14px " & chr(10);
    res = res & "}" & chr(10);
    res = res & "#KOmain a{" & chr(10);
    res = res & "font-size:14px;" & chr(10);
    res = res & "height:14px;" & chr(10);
    res = res & "line-height:14px;" & chr(10);
    res = res & "}" & chr(10);
    res = res & "}" & chr(10);
    res = res & "</style>" & chr(10);        
  end; 

  PageStart1 = res;
  return;
end;

function string 255 PageStart2()
begin
  string 255 res;
  
//  res = res &     "<script src=""" & ResourcePath & "/iap.js"" type=""text/javascript""></script>" & chr(10); // not needed for  Kitchen order
  
  PageStart2 = res;
  return;
end;

function string 255 PageStart3(boolean main,string class)
begin
  string 255 res;
  
  if (WindowsMode) then begin
    res = res &   "  <script type='text/javascript' src='res://" & ResourceFolder & "/jquery-1.5.1-htmlrep.js'></script>" & chr(10);
  end else begin
    res = res &   "  <script type='text/javascript' src='file://" & ResourceFolder & "/jquery-1.5.1-htmlrep.js'></script>" & chr(10);
  end;  
  
  res = res & "  </head>" & chr(10);
  res = res & "  <body class='" & class &"'>" & chr(10);
  res = res & "    <div id='container'>" & chr(10);
  if (main) then begin
    res = res & "      <div id='contentMain'>" & chr(10);
  end else begin
    res = res & "      <div id='content'>" & chr(10);
  end;
  PageStart3 = res;
  return;
end;

function string 255 PageEnd()
begin
  string 255 res;
  
  res = res & "       </div>" & chr(10);
  res = res & "     </div>" & chr(10);
  res = res & "   </body>" & chr(10);
  res = res & "</html>" & chr(10);
  
  PageEnd = res;
  return;
end;

global
function string 255 OpenKODeliveredReturnButton(integer wn,string class,string value)
begin
  string 255 res;

  res = res & "<div id='OpenKODeliverReturnBtn'>" & chr(10);
//  res = res & "<input type=""button"" value=""" & value & """ ";
//  res = res & "onclick=""HansaWorld.callHal('ClickOpenKODetailsReturn','" & wn & "')"">" & chr(10);
//  res = res & "</input>" & chr(10);
  
  // Link was preferred 
  res = res & "<a onclick='HansaWorld.callHal('ClickOpenKODetailsReturn','" & wn & "')'>";
  res = res & value;
  res = res & "</a>" & chr(10);
    
  res = res & "</div>" & chr(10);

  OpenKODeliveredReturnButton = res;
  return;
end;

procedure DisplayKitchenOrders(Integer wn,record RcVc RepSpec)
begin
  string 255 html,allhtml,tstr,KOScreenDept,BodyClassStr;
  LongInt i,j;
  longint refreshsec;
  record LocalMachineBlock LMb;
  time defdt;
  boolean breakf;

  BlockLoad(LMb);

  RepSpec.flags[0] = 5;                         // Max no. horizontal panels
  RepSpec.flags[1] = wn;                        // current window
  RepSpec.flags[2] = LMb.KitchenOrdDetailed;    // Show Detailed items
  PutWindowRecord(wn,RepSpec);
  
  if (BlankTime(LMb.KitchenRefreshInt)) then begin 
    defdt.minute = 1;
  end else begin
    defdt = LMb.KitchenRefreshInt;
  end;
  refreshsec = TimeToSeconds2(defdt);
  
  KOScreenDept = RepSpec.f1;

  BodyClassStr = "MainPanelDisplay";
  if (LMb.KitchenOrdDetailed!=0) then begin 
    BodyClassStr = "KitchenOrdDetailedAll";  
  end;
//  if (blank(KOScreenDept)) then begin 
//    breakf = true;
//    html = html & "<div id='KOHeading1'>" & USetStr(10231) & "</div>" & chr(10);
//  end;  
  if (blank(refreshsec<=0)) then begin 
    breakf = true;
    html = html & "<div id='KOHeading1'>" & USetStr(10232) & "</div>" & chr(10);
  end;    
//  if (FileExists(ResourceFolder & "/kostyles.css")==false) then begin 
//  if (FileExists("kostyles.css")==false) then begin 
//    breakf = true;
//    html = html & "<div id='KOHeading1'>" & USetStr(10236) & " " & ResourceFolder & "/kostyles.css" &  "</div>" & chr(10);
//  end;    
  
  if (breakf==false) then begin 
    html = html & "<div id='KOHeadingmain'>" & chr(10);
    
    html = html & "<div id='KOHeading1'>" & USetStr(10234) & LMb.BranchID & chr(10);
    html = html & "</div>" & chr(10); 

    if (RepSpec.long1>-1) then begin 
      BodyClassStr = "ListItemsForOneReservation";
      html = html & "<div id='KOHeadingTabNo'>"  & USetStr(12553) & " : " & RepSpec.long1 & chr(10);
      html = html & "</div>" & chr(10);     
      html = html & OpenKODeliveredReturnButton(wn,"KODeliverReturnBtn",USetStr(17481));   
    end;

    html = html & "</div>" & chr(10);
  
    html = html & "<div id='KOmain'>" & chr(10);
    
    KOrdPopulateHtml(LMb,RepSpec,html,tstr);
    
    html = html & "</div>" & chr(10);
  end;
    
  allhtml = PageStart1 & PageStart2 & PageStart3(true,BodyClassStr) & html & PageEnd;
  
  if (TestEnablerFile("EnNoKOWriteHtmlFile")) then begin
    Delete_File("KOwindow.html");
    MilliSleep(100);
    WriteStringToFile(allhtml,"KOwindow.html",0);
//    RunProgram("/bin/bash","tidy.sh KOwindow.html"); // debug command
  end;
  
  SetWebPageData(wn,"$KO",allhtml);  
  return;
end;

global
procedure RefreshKOScreen(string arg)
begin
  record RcVc RepSpec;
  record LocalMachineBlock LMb;
  integer wn;
  time t;
  longint refreshsec;
  
  wn = FindWindow("RestKItchenOrdWClass");
  if (wn>0) then begin
    GetWindowRecord(wn,RepSpec);
    DisplayKitchenOrders(wn,RepSpec);
  end;
  if (arg=="STARTIDLETASK") then begin 
    BlockLoad(LMb);
    if (BlankTime(LMb.KitchenRefreshInt)) then begin 
      t.minute = 1;
    end else begin
      t = LMb.KitchenRefreshInt;
    end;   
    refreshsec = TimeToSeconds2(t);
    if (refreshsec<=0) then begin 
      refreshsec = 60;
    end;     
    if (ClientMode or SingleUserMode) then begin 
      RemoveTask("RefreshKOScreenIdleTask");
      NewPeriodicTask("RefreshKOScreenIdleTask","Refresh Kitchen Order Screen","RefreshKOScreen","",refreshsec,"");    
    end;  
  end;
  return;
end;

global
function Boolean RestKItchenOrdWClassOnClose(Integer wn,Integer wn2)
begin
  Boolean res;
  
  if (ClientMode or SingleUserMode) then begin 
    RemoveTask("RefreshKOScreenIdleTask");
  end;
  RestKItchenOrdWClassOnClose = res;
  return;
end;

global
function boolean RestKItchenOrdWClassOnOpenWindow(integer wn)
begin
  record LocalMachineBlock LMb;
  record RcVc RepSpec;
  time t; 
  longint refreshsec;
   
  BlockLoad(LMb);
  GetWindowRecord(wn,RepSpec);
  
  if (NonBlank(LMb.KitchenOrdScrDep)) then begin 
    RepSpec.f1 = LMb.KitchenOrdScrDep;
    PutWindowRecord(wn,RepSpec);
  end;

  DisplayKitchenOrders(wn,RepSpec);

  if (BlankTime(LMb.KitchenRefreshInt)) then begin 
    t.minute = 1;
  end else begin
    t = LMb.KitchenRefreshInt;
  end;
  refreshsec = TimeToSeconds2(t);
  if (refreshsec<=0) then begin 
    refreshsec = 60;
  end; 
  if (ClientMode or SingleUserMode) then begin 
    RemoveTask("RefreshKOScreenIdleTask");
    NewPeriodicTask("RefreshKOScreenIdleTask","Refresh Kitchen Order Screen","RefreshKOScreen","",refreshsec,"");    
  end;  
  
  RestKItchenOrdWClassOnOpenWindow = false;
  return;
end;

global
updating procedure ClickOpenKOList(string wnStr)
begin
  string 255 tstr,KOSerNr,WindowNo;
  longint pos,wn;
  record RcVc RepSpec;

  if (ClientMode or SingleUserMode) then begin   
    tstr = wnStr;
    pos = 0;
    GetNextSubstring(tstr,pos,",",WindowNo);
    GetNextSubstring(tstr,pos,",",KOSerNr);
  
    wn = StringToInt(WindowNo);
    GetWindowRecord(wn,RepSpec);
    RepSpec.long1 = -1;
    PutWindowRecord(wn,RepSpec);
    RestKItchenOrdWClassOnOpenWindow(wn);  
  end;
end;

global
updating procedure ClickOpenKODetails(string wnStr)
begin
  string 255 tstr,KOSerNr,WindowNo;
  longint pos,wn;
  record RcVc RepSpec;

  if (ClientMode or SingleUserMode) then begin   
    RemoveTask("RefreshKOScreenIdleTask");
    tstr = wnStr;
    pos = 0;
    GetNextSubstring(tstr,pos,",",WindowNo);
    GetNextSubstring(tstr,pos,",",KOSerNr);
  
    wn = StringToInt(WindowNo);
    GetWindowRecord(wn,RepSpec);
    RepSpec.long1 = StringToLongInt(KOSerNr);
    PutWindowRecord(wn,RepSpec);    
    DisplayKitchenOrders(wn,RepSpec);  
  end;
end; 

global
procedure ClickOpenKODelivered(string wnStr)
begin
  string 255 tstr,KOSerNr,WindowNo;
  longint pos;
  record RcVc RepSpec,RepSpec2;
  integer wn;
  
  if (ClientMode or SingleUserMode) then begin 
    RemoveTask("RefreshKOScreenIdleTask");
  
    tstr = wnStr;
    pos = 0;
    GetNextSubstring(tstr,pos,",",WindowNo);
    GetNextSubstring(tstr,pos,",",KOSerNr);

    if (nonblank(WindowNo)) then begin 
      wn = StringToInt(WindowNo);
      GetWindowRecord(wn,RepSpec2);
      RepSpec.f1 = RepSpec2.f1;
    end;

    RepSpec.f3 = KOSerNr;
    qupdating.MarkKODelivered(RepSpec);
  end;
end;

global
updating procedure ClickOpenKODetailsReturn(string wnStr)
begin
  string 255 tstr,KOSerNr,WindowNo;
  longint pos,wn;
  record RcVc RepSpec;

  if (ClientMode or SingleUserMode) then begin   
    RemoveTask("RefreshKOScreenIdleTask");
    tstr = wnStr;
    pos = 0;
    GetNextSubstring(tstr,pos,",",WindowNo);
  
    wn = StringToInt(WindowNo);
    GetWindowRecord(wn,RepSpec);
    RepSpec.long1 = -1;
    PutWindowRecord(wn,RepSpec);    
    RefreshKOScreen("STARTIDLETASK");  
  end;
end; 

function Boolean RestKItchenOrdWClassf1EFAfter(Integer wn,Integer fn,Integer rownr,Integer changedf)
begin
  Boolean res;
  record RcVc RepSpec;
  
  res = true;
  if (changedf!=0) then begin 
    GetWindowRecord(wn,RepSpec);
    DisplayKitchenOrders(wn,RepSpec);
  end;
  
  RestKItchenOrdWClassf1EFAfter = res;
  return;
end;

global
function Boolean RestKItchenOrdWClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
begin
  Boolean res;
  
  res = false;
  switch (fieldname) begin
    case "f1": res = RestKItchenOrdWClassf1EFAfter(wn,fn,rownr,changed);
  end;
  RestKItchenOrdWClassAfterEditField = res;
  return;
end;
