external function string 40 SerialNrSClassSpecPName(string);
external function string 40 DelAddrSClassSpecPName(string);

function Boolean CollectionVcEFActiveCheck(string fieldname,Integer wn,Integer wnst)
BEGIN
  Boolean res;
  record CollectionVc Collectionr;
  Integer updatemode;

  updatemode = 2;//Rs_update
  res = true;
  switch (fieldname) begin
    case "Comment":
    case "LangCode":;
    otherwise
      if (wnst==updatemode) then begin
        GetWindowRecord(wn,Collectionr);
        if (Collectionr.OKFlag!=0) then begin
          res = false;
        end;  
      end;  
  end;
  CollectionVcEFActiveCheck = res;
  RETURN;
END;

global
function Boolean CollectionDClassActiveEditField(Integer wn,string fieldname,Integer fn,Integer wnst,Integer rownr,Integer ef)
BEGIN
  Boolean res;
  
  res = CollectionVcEFActiveCheck(fieldname,wn,wnst);
  CollectionDClassActiveEditField = res;
  return;
end;

function Boolean CollectionButtonAction(string fieldname,Integer wn,Integer wnst)
begin
  Boolean res;
  record CollectionVc Collectionr;
  Integer normalmode,updatemode;
 
  res = true;
  normalmode = 0;//Rs_normal
  updatemode = 2;//Rs_update
  if (WindowState(wn)==normalmode) then begin
    GetWindowRecord(wn,Collectionr);
    if (Collectionr.OKFlag!=0) then begin
      switch (fieldname) begin
        case "OKFlag":
          res = false;
          if (UserCanAction("UnOKAll",false)) then begin
            res = true;
          end;
        otherwise
          res = false;
      end;
    end;
  end;  
  if (WindowState(wn)==updatemode) then begin
    GetPrevWindowRecord(wn,Collectionr);
    if (Collectionr.OKFlag!=0) then begin
      switch (fieldname) begin
        otherwise
          res = false;
      end;
    end;
  end;
  CollectionButtonAction = res;
  return;
end;

global
function Boolean CollectionDClassOKFlagButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;

  res = CollectionButtonAction("OKFlag",wn,WindowState(wn));
  CollectionDClassOKFlagButtonAction = res;
  RETURN;
END;

global
function string 40 CollectionDClassSpecPasteName(Integer wn,string defpsname)
begin
  string 40 psname;
  
  psname = defpsname;
  switch (WindowActiveField(wn)) begin
    case "DelAddrCode": psname = DelAddrSClassSpecPName(defpsname);
    case "SerialNr": psname = SerialNrSClassSpecPName(defpsname);
  end;
  CollectionDClassSpecPasteName = psname;
  return;
end;
