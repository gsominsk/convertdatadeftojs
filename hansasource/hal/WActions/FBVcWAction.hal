external procedure FBSumup(var record FBVc);
remote function Boolean FBVc_PasteDebVal(var record FBVc,Integer,var Integer);
remote function Boolean FBVc_PasteCredVal(var record FBVc,Integer,var Integer);
remote function Boolean FBVc_PasteDeb2Val(var record FBVc,Integer,var Integer);
remote function Boolean FBVc_PasteCred2Val(var record FBVc,Integer,var Integer);

procedure FBAccName(record FBVc FBp,row FBVc FBrwp)
BEGIN
  record AccVc Accr;
  Boolean Accs;
  string 255 tstr;

  if (nonblank(FBrwp.AccNumber)) then begin
    Accr.AccNumber = FBrwp.AccNumber;
    Accs = ReadFirstKey("AccNumber",Accr,1,true);
    if (Accs==false) then begin
      tstr = USetStr(1023);
      FBrwp.Comment = tstr;
      Beep;
    end else begin
      FBrwp.Comment = Accr.Comment;
      FBrwp.CurncyCode = Accr.Curncy;
    end;
  end else begin
    ClearRow(FBp,FBrwp,1);
    FBrwp.Comment = "";
  end;
  RETURN;
END;

function Boolean FBDClassAccNumberEFAfter(Integer wn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record FBVc FBr;
  row FBVc FBrw;
  string 255 tstr;

  DeselectWindow(wn,false);
  GetWindowRecord(wn,FBr);    
  MatRowGet(FBr,rownr,FBrw);
  tstr = USetStr(1023);
  if ((changed!=0) or (blank(FBrw.Comment)) or (FBrw.Comment==tstr)) then begin
    res = true;
    FBAccName(FBr,FBrw);
    MatRowPut(FBr,rownr,FBrw);
    PutWindowRecord(wn,FBr);        
  end;
  FBDClassAccNumberEFAfter = res;
  RETURN;
END;

function Boolean FBDClassDebValEFAfter(Integer wn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record FBVc FBr;
  Integer mesnr;

  if (changed!=0) then begin
    res = true;
    DeselectWindow(wn,false);
    GetWindowRecord(wn,FBr);    
    if (FBVc_PasteDebVal(FBr,rownr,mesnr)) then begin
      if (mesnr!=0) then begin
        MessageBox(mesnr,"");
      end;
      PutWindowRecord(wn,FBr);        
    end else begin
      Beep;
    end;
  end;
  FBDClassDebValEFAfter = res;
  RETURN;
END;

function Boolean FBDClassDeb2ValEFAfter(Integer wn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record FBVc FBr;
  Integer mesnr;

  if (changed!=0) then begin
    res = true;
    DeselectWindow(wn,false);
    GetWindowRecord(wn,FBr);    
    if (FBVc_PasteDeb2Val(FBr,rownr,mesnr)) then begin
      if (mesnr!=0) then begin
        MessageBox(mesnr,"");
      end;
      PutWindowRecord(wn,FBr);        
    end else begin
      Beep;
    end;
  end;
  FBDClassDeb2ValEFAfter = res;
  RETURN;
END;

function Boolean FBDClassCredValEFAfter(Integer wn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record FBVc FBr;
  Integer mesnr;

  if (changed!=0) then begin
    res = true;
    DeselectWindow(wn,false);
    GetWindowRecord(wn,FBr);    
    if (FBVc_PasteCredVal(FBr,rownr,mesnr)) then begin
      PutWindowRecord(wn,FBr);        
    end else begin
      Beep;
    end;
  end;
  FBDClassCredValEFAfter = res;
  RETURN;
END;

function Boolean FBDClassCred2ValEFAfter(Integer wn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record FBVc FBr;
  Integer mesnr;

  if (changed!=0) then begin
    res = true;
    DeselectWindow(wn,false);
    GetWindowRecord(wn,FBr);    
    if (FBVc_PasteCred2Val(FBr,rownr,mesnr)) then begin
      PutWindowRecord(wn,FBr);        
    end else begin
      Beep;
    end;
  end;
  FBDClassCred2ValEFAfter = res;
  RETURN;
END;

global
function Boolean FBDClassAfterEditField(Integer wn,string fieldname,Integer fn,Integer rownr,Integer changed)
BEGIN
  Boolean res;
  
  res = false;
  switch (fieldname) begin
    case "AccNumber": res = FBDClassAccNumberEFAfter(wn,rownr,changed);
    case "DebVal": res = FBDClassDebValEFAfter(wn,rownr,changed);
    case "CredVal": res = FBDClassCredValEFAfter(wn,rownr,changed);
    case "Deb2Val": res = FBDClassDeb2ValEFAfter(wn,rownr,changed);
    case "Cred2Val": res = FBDClassCred2ValEFAfter(wn,rownr,changed);
    
  end;
  FBDClassAfterEditField = res;
  RETURN;
END;

global
function Boolean FBDClassOnOverStrike(Integer wn,Integer rownr)
BEGIN
  record FBVc FBr;
  val t;

  if (rownr>=0) then begin
    GetWindowRecord(wn,FBr);    
    FBSumup(FBr);
    PutWindowRecord(wn,FBr);    
  end;
  FBDClassOnOverStrike = true;
  RETURN;
END;
