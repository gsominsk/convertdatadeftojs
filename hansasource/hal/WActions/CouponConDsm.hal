remote function Boolean PasteVendInVI(record VIVc,var string,Boolean);
external procedure VISumup(record VIVc,var val);

global
procedure CouponConsm()
begin
  record RcVc RepSpec;
  record CouponConVc CouponConr;
  
  GetWindowRecord(CurWindow,CouponConr);
  RepSpec.repname = "CouponConsRn";
  RepSpec.long1   = CouponConr.SerNr; 
  RepSpec.Media   = mtScreen;    
  RunReport(RepSpec,0); 
  return;
end;

global
updating
procedure GenCouponVIVcsm()
begin
  record RcVc RepSpec; 
  record CouponConVc CouponConr;
  record AccVc Accr;
  row CouponConVc CouponConrw;
  record CredCardTypeVc CredCardTyper;
  record VIVc VIr;
  record CUVc VEr;
  row VIVc VIrw;
  Integer wn,i,rows;
  val bal;
  string 200 warn;
  
  GetWindowRecord(CurWindow,CouponConr);
  RecordNew(VIr);
  wn = OpenWindow("VIDClass",1,0,"","",VIr);
  CredCardTyper.Code = CouponConr.CardType;
  if readfirstmain(CredCardTyper,1,true) then begin
    VIr.VECode = CredCardTyper.VECode;
    if PasteVendInVI(VIr,warn,true) then begin end;  
  end;
  VIr.InvoiceNr = CouponConr.NrLiq;
  VIr.OKPersons = CurrentUser;
  
  rows = matrowcnt(CouponConr);
  for(i=0; i<rows; i=i+1) begin
    MatRowGet( CouponConr,i,CouponConrw);
    Accr.AccNumber = CouponConrw.AccNumber;
    if readfirstmain(Accr,1,true) then begin
      ClearRow(VIr,VIrw,1);
      if nonblank(Accr.VATCode) then begin
        VIrw.VATCode   = Accr.VATCode;
        VIrw.TaxTemplateCode = Accr.TaxTemplateCode;
      end else begin  
        VEr.Code = CredCardTyper.VECode;
        if readfirstmain(VEr,1,true) then begin
          VIrw.VATCode   = Accr.VATCode;
          VIrw.TaxTemplateCode = Accr.TaxTemplateCode;
        end;
      end;
      VIrw.AccNumber = CouponConrw.AccNumber;
      VIrw.Comment   = CouponConrw.Comment;
      VIrw.Sum       = CouponConrw.Amount;
      MatRowPut(VIr,i,VIrw);
    end;
  end;
  // Add Commision
  if nonblank(CredCardTyper.AccNumber1) then begin
    ClearRow(VIr,VIrw,1);
    Accr.AccNumber = CredCardTyper.AccNumber1;
    if readfirstmain(Accr,1,true) then begin
      VIrw.AccNumber = Accr.AccNumber;
      VIrw.Comment   = Accr.Comment;
      VIrw.VATCode   = Accr.VATCode;
      VIrw.TaxTemplateCode = Accr.TaxTemplateCode;
      VIrw.Sum       = -1 * 5000;
      MatRowPut(VIr,i,VIrw);
      i = i + 1;
    end;
  end;
  if nonblank(CredCardTyper.AccNumber) then begin
    ClearRow(VIr,VIrw,1);
    Accr.AccNumber = CredCardTyper.AccNumber1;
    if readfirstmain(Accr,1,true) then begin
      VIrw.AccNumber = Accr.AccNumber;
      VIrw.Comment   = Accr.Comment;
      VIrw.VATCode   = Accr.VATCode;
      VIrw.TaxTemplateCode = Accr.TaxTemplateCode;
      VIrw.Sum       = 5000;
      MatRowPut(VIr,i,VIrw);
      i = i + 1;
    end;
  end;
  VISumup(VIr,bal);  // ?? 
  PutWindowRecord(wn,VIr);
  return;
end;

