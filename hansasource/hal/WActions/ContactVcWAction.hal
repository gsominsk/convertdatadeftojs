remote function Boolean CurUserHasMailbox(var string);

global
function Boolean ContactDClassCompanyEFAfter(Integer wn,Integer fn, Integer rownr,Integer changed)
BEGIN
  Boolean res;
  record ContactVc CTr;
  record CUVc CUr;

  res = true;
  if (changed!=0) then begin
    GetWindowRecord(wn,CTr);
    CUr.Code = CTr.Company;
    if (ReadFirstMain(CUr,1,true)) then begin
      CTr.CompName = CUr.Name;
      CTr.Adress0 = CUr.InvAddr0;
      CTr.Adress1 = CUr.InvAddr1;
      CTr.Adress2 = CUr.InvAddr2;
      CTr.Adress3 = CUr.InvAddr3;
      CTr.Adress4 = CUr.InvAddr4;
      CTr.NoLetterPosting = CUr.NoLetterPosting;
      CTr.NoMailPosting = CUr.NoMailPosting;
      CTr.Phone = CUr.Phone;
      CTr.Fax = CUr.Fax;
      PutWindowRecord(wn,CTr);    
    end else begin
      Beep;
    end;
  end;
  ContactDClassCompanyEFAfter = res;
  RETURN;
END;

global
function Boolean ContactDClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
BEGIN
  Boolean res;

  switch (fieldname) begin
    case "Company": res = ContactDClassCompanyEFAfter(wn,fn,rownr,changed);
  end;
  ContactDClassAfterEditField = res;
  RETURN;
END;

global
procedure DropContactLClassOnMailLClass(Integer frwn,Integer town)
BEGIN
  record ContactVc Contactr;
  record MailVc Mailr;
  row MailVc MArw;
  Integer r,nwn;
  string 255 warntext;
  Integer i,rwcnt;
  
  if ((GetWindowFileName(frwn)=="ContactVc") and (GetWindowFileName(town)=="MailVc")) then begin
    if (CurUserHasMailbox(warntext)) then begin
      RecordNew(Mailr);
      nwn = OpenWindow("MailDClass",1,0,"","",Mailr);  
      rwcnt = MatRowCnt(Mailr);
      i = 1;
      while (GetRecordFromBrowse(Contactr,frwn,i)) begin
        if ((Contactr.Closed==0) and (IsRecordLocked(Contactr)==false)) then begin
          if (nonblank(Contactr.Email)) then begin
            MArw.RowTyp = 0;
            MArw.AddrCode = Contactr.Email;
            MatRowPut(Mailr,rwcnt,MArw);        
            rwcnt = rwcnt + 1;
          end;
        end;
        i = i + 1;
      end;          
      PutWindowRecord(nwn,Mailr)
    end;
  end;  
  RETURN;
END;
