remote function Integer CreateDebitNoteCheckRemote(record CheckVc,var record IVVc,var string);

global
procedure OpenOPFromChecksm()
begin
  record CheckVc Checkr;
  record OPVc OPr;
  Integer wn,wn1;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if ((Checkr.Openf==kCheckTypeEndorsed) or (Checkr.Openf==kCheckTypeBouncedfromEndorsed) or (Checkr.Openf==kCheckTypeEndorsedfromReconciled)) then begin
    if (Checkr.ToType==2) or (Checkr.ToFileName=="OPVc") then begin
      OPr.SerNr = Checkr.ToNo;
      if (ReadFirstMain(OPr,1,true)) then begin
        DeselectWindow(wn,false);
        wn1 = OpenWindow("OPDClass",0,0,"","",OPr);
      end;
    end;
  end;  
  return;
end;

global
procedure OpenIPFromChecksm()
begin
  record CheckVc Checkr;
  record IPVc IPr;
  Integer wn,wn1;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf>0) then begin
    if (Checkr.ToType==0 and Checkr.FromFileName=="IPVc") or (Checkr.ToFileName=="IPVc") then begin
      IPr.SerNr = Checkr.FromNo;
      if (ReadFirstMain(IPr,1,true)) then begin
        DeselectWindow(wn,false);
        wn1 = OpenWindow("IPDClass",0,0,"","",IPr);
      end;
    end;
  end;  
  return;
end;

global
procedure OpenChqDepFromChecksm()
begin 
  record CheckVc Checkr;
  record ChqDepVc ChqDepr;
  Integer wn,wn1;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf>0) then begin
    if (Checkr.ToType==3) or (Checkr.ToFileName=="CLOutVc") then begin
      ChqDepr.SerNr = Checkr.ToNo;
      if (ReadFirstMain(ChqDepr,1,true)) then begin
        DeselectWindow(wn,false);
        wn1 = OpenWindow("ChqDepDClass",0,0,"","",ChqDepr);
      end;
    end;
  end;
  return;
end;

global
procedure OpenCLOutFromCheckDsm()
begin 
  record CheckVc Checkr;
  record CLOutVc CLOutr;
  Integer wn,wn1;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf>0) then begin
    if (Checkr.ToType==4) or (Checkr.ToFileName=="CLOutVc") then begin
      CLOutr.SerNr = Checkr.ToNo;
      if (ReadFirstMain(CLOutr,1,true)) then begin
        DeselectWindow(wn,false);
        wn1 = OpenWindow("CLOutDClass",0,0,"","",CLOutr);
      end;
    end;
  end;
  return;
end;

global
procedure OpenCLInFromCheckDsm()
begin 
  record CheckVc Checkr;
  record CLInVc CLInr;
  Integer wn,wn1;

  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf>0) then begin
    if (Checkr.FromFileName=="CLInVc") then begin
      CLInr.SerNr = Checkr.FromNo;
      if (ReadFirstMain(CLInr,1,true)) then begin
        DeselectWindow(wn,false);
        wn1 = OpenWindow("CLInDClass",0,0,"","",CLInr);
      end;
    end;
  end;
  return;
end;

global
procedure OpenRegisterFromCheckDsm()
begin
  record CheckVc Checkr;
  Integer wn;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (nonblank(Checkr.ToFileName)) then begin
    switch (Checkr.ToFileName) begin
      case "CLOutVc": OpenCLOutFromCheckDsm;
      case "ChqDepVc": OpenChqDepFromChecksm;
      case "OPVc": OpenOPFromChecksm;
    end;
  end else begin
    if (Checkr.FromFileName=="CLInVc") then begin 
      OpenCLInFromCheckDsm;
    end else begin
      switch (Checkr.ToType) begin
        case 0: OpenIPFromChecksm;
        case 2: OpenOPFromChecksm;
        case 3: OpenChqDepFromChecksm;
        case 4: OpenCLOutFromCheckDsm;
      end;
    end;
  end;
  return;
end;

global
updating
procedure CancelChecksm()
begin 
  record CheckVc Checkr;
  record AccBlock Accb;
  Integer wn,wn1;
  
  wn = CurWindow;
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf==kCheckTypeAccepted) then begin
    BlockLoad(Accb);
    Checkr.Openf = kCheckTypeCancelled;
    if (Checkr.OrigAccNr==Accb.ARAcc) then begin
      if (RecordStore(Checkr,true)) then begin end;
    end;
  end;
  return;
end;

global
procedure CreateDebitNoteCheckDsm()
begin
  Integer wn,nwn;
  record CheckVc Checkr;
  record IVVc IVr;
  string 255 rlink;
  
  wn = CurWindow;
  DeselectWindow(wn,false);
  GetWindowRecord(wn,Checkr);
  if (Checkr.Openf==kCheckTypeBounced or Checkr.Openf==kCheckTypeBouncedfromEndorsed or Checkr.Openf==kCheckTypeCancelled) then begin
    CreateDebitNoteCheckRemote(Checkr,IVr,rlink);
    nwn = OpenWindow("IVDClass",1,0,"","",IVr);
    if (nwn>0) then begin
      PutWindowString(nwn,"RLINKFILENAME","CheckVc");
      PutWindowString(nwn,"RLINK",rlink);
    end;
  end;
  return;
end;