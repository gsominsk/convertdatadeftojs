external function string 40 SerialNrSClassSpecPName(string);

global
function Boolean OffHireDClassOKFlagButtonAfter(Integer wn,Boolean changedf)
begin        
  record OffHireVc OffHirer;  
  row OffHireVc OffHirerw;  
  record RentResVc RentResr;  
  integer rwcnt,i;
  Boolean res;
  longint LastRes;

  LastRes = -1;
  DeselectWindow(wn,false);
  if (WindowState(wn)==1) then begin goto LOffHireDClassButtonAfter; end;//Rs_insert
  GetWindowRecord(wn,OffHirer);
  
  rwcnt = MatRowCnt(OffHirer);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(OffHirer,i,OffHirerw);
    if (OffHirerw.RentResSerNo<>LastRes) then begin
      RentResr.SerNr = OffHirerw.RentResSerNo;
      if (ReadFirstMain(RentResr,1,true)) then begin
        if (OffHirer.TransDate<>RentResr.EndDate) then begin
          MessageBox(20566,"");
          goto LOffHireDClassButtonAfter;
        end;
      end;
      LastRes = OffHirerw.RentResSerNo;
    end;
  end;
LOffHireDClassButtonAfter:;
  OffHireDClassOKFlagButtonAfter = res;  
  return;
end;

function Boolean OffHireButtonAction(string fieldname,Integer wn,Integer wnst)
begin
  Boolean res;
  record OffHireVc OffHirer;
  Integer normalmode,updatemode;
 
  res = true;
  normalmode = 0;//Rs_normal
  updatemode = 2;//Rs_update
  if (WindowState(wn)==normalmode) then begin
    GetWindowRecord(wn,OffHirer);
    if (OffHirer.OKFlag==1) then begin
      switch (fieldname) begin
        case "OKFlag":
          res = false;
          if (UserCanAction("UnOKAll",false)) then begin
//            res = true;// updating stock , cannot work here
          end;
        otherwise
          res = false;
      end;
    end;
  end;  
  if (WindowState(wn)==updatemode) then begin
    GetPrevWindowRecord(wn,OffHirer);
    if (OffHirer.OKFlag==1) then begin
      switch (fieldname) begin
        case "OKFlag":
          res = false;
          if (UserCanAction("UnOKAll",false)) then begin
//            res = true;// updating stock , cannot work here
          end;
        otherwise
          res = false;
      end;
    end;
  end;
  OffHireButtonAction = res;
  return;
end;

global
function Boolean OffHireDClassOKFlagButtonAction(Integer wn,Integer value)
BEGIN
  Boolean res;

  res = OffHireButtonAction("OKFlag",wn,WindowState(wn));
  OffHireDClassOKFlagButtonAction = res;
  RETURN;
END;

global
function string 40 OffHireDClassSpecPasteName(Integer wn,string defpsname)
begin
  string 255 psname;
  
  psname = defpsname;
  switch (WindowActiveField(wn)) begin
    case "SerialNr": psname = SerialNrSClassSpecPName(defpsname);
  end;
  OffHireDClassSpecPasteName = psname;
  return;
end;
