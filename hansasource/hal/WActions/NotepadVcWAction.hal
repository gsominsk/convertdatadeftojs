global
function Boolean NotepadDClassOnOpenWindow(Integer wn)
begin
  record NotepadVc Noter;
  record RLinkVc RLr;
  
  if (WindowState(wn)!=Rs_insert) then begin
    GetWindowRecord(wn,Noter);
    RLr.ToRecidStr = BuildRecordIdStr(Noter,CurrentCompany);
    if (ReadFirstKey("ToRecKey",RLr,1,true)) then begin
    end;
    PutWindowString(wn,"NotepadRLinkComment",RLr.Comment);
  end;
  NotepadDClassOnOpenWindow = false;
  return;
end;

global
procedure NotepadDClassOnWindowRecordChange(Integer wn)
begin
  record NotepadVc Noter;
  record RLinkVc RLr;

  if (WindowState(wn)!=Rs_insert) then begin
    GetWindowRecord(wn,Noter);
    RLr.ToRecidStr = BuildRecordIdStr(Noter,CurrentCompany);
    if (ReadFirstKey("ToRecKey",RLr,1,true)) then begin
    end;
    PutWindowString(wn,"NotepadRLinkComment",RLr.Comment);
  end;
  return;
end;

global
updating function Boolean NotepadDClassOnClose(Integer wn,Integer wn2)
begin
  string 255 loc;
  date dt;
  record NotepadVc Noter;
  record RLinkVc RLr;
  record RLinkVc oldRLr;
  string 255 newcomment;
  
  newcomment = GetWindowString(wn,"NotepadRLinkComment");
  GetWindowRecord(wn,Noter);
  RLr.ToRecidStr = BuildRecordIdStr(Noter,CurrentCompany);
  if (ReadFirstKey("ToRecKey",RLr,1,true)) then begin
    if (newcomment!=RLr.Comment) then begin
      RecordCopy(oldRLr,RLr);
      RLr.Comment = newcomment;
      RecordUpdate(oldRLr,RLr,false);
      if (MotherWindow(wn)>0) then begin
//        UpdateArchive(MotherWindow(wn));
      end;
    end;
  end;
  UpdateArchive(-1);
  NotepadDClassOnClose = false;
  return;
end;

global
updating function Boolean NotepadDClassOnOKWindow(Integer wn)
begin
  string 255 loc;
  date dt;
  record NotepadVc Noter;
  record RLinkVc RLr;
  record RLinkVc oldRLr;
  string 255 newcomment;
  
  newcomment = GetWindowString(wn,"NotepadRLinkComment");
  GetWindowRecord(wn,Noter);
  RLr.ToRecidStr = BuildRecordIdStr(Noter,Noter.CompanyNr);
  if (ReadFirstKey("ToRecKey",RLr,1,true)) then begin
    if (newcomment!=RLr.Comment) then begin
      RecordCopy(oldRLr,RLr);
      RLr.Comment = newcomment;
      RecordUpdate(oldRLr,RLr,false);
      if (MotherWindow(wn)>0) then begin
//        UpdateArchive(MotherWindow(wn));
      end;
    end;
  end;
  UpdateArchive(-1);
  NotepadDClassOnOKWindow = true;
  return;
end;


global
function Boolean NotepadDClassActiveEditField(Integer wn,string fieldname,Integer fn,Integer wnst,Integer rownr,Integer changed)
begin
  Boolean res;
  LongInt sz;
  record NotepadVc Noter;
  
  res = true;
  GetWindowRecord(wn,Noter);
  switch (fieldname) begin
    case "Math": 
      if (LastChar!=8) then begin//backspace
        sz = SizeTextCnt(Noter);
        if ((sz+1)>30720) then begin
          MessageBox(1622,"");
          res = false;
        end;
      end;
  end;
  NotepadDClassActiveEditField = res;
  return;
end;
