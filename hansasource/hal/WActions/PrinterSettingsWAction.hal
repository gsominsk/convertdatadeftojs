external function Boolean FindLocalSerialPortDevice(Integer,LongInt,string,var record LSerialPortDeviceVc);
external function integer PMsgOpen(record LSerialPortDeviceVc);
external procedure PMsgClose(integer);
external function boolean PMsgSend(record LSerialPortDeviceVc,var array string,var array string);
external procedure PMsgStack_StatusRequest(record LSerialPortDeviceVc,var array string);
external procedure PMsgStack_SetDate(record LSerialPortDeviceVc,var array string,date); 
external function LongInt PMsg_SyncDateAndTime(record LSerialPortDeviceVc,date,time);

global
procedure PSWClassDateTime()
begin
  record LSerialPortDeviceVc LSPDr;
  record LocalMachineBlock LMb;
  date d;
  Integer res,noErr,wn,mwn;
  record RcVc RepSpec;
  array string 255 msgstack,answers;
  
  BlockLoad(LMb);  
  if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalPrinter,-1,LMb.LocalMachineCode,LSPDr)) then begin  
    noErr = 1;
    res = PMsgOpen(LSPDr);
    if (res==noErr) then begin
      PMsgStack_StatusRequest(LSPDr,msgstack);
      PMsgSend(LSPDr,msgstack,answers);
      RepSpec.d1 = answers[PMsgVar_Date];
      RepSpec.sStartTime = answers[PMsgVar_Time];
      PMsgClose(1);
      mwn = CurWindow;
      wn = OpenWindow("PSDateTimeWClass",0,mwn,"","",RepSpec);
    end;
  end else begin
    MessageBox(20990,"");
  end;
  
  return;
end;

global
function Boolean PSDateTimeWClassOnOKWindow(Integer wn)
begin
  record LSerialPortDeviceVc LSPDr;
  record LocalMachineBlock LMb;
  array string 255 msgbuffer;
  Integer res,noErr;
  record RcVc RepSpec;
  
  BlockLoad(LMb);  
  if (FindLocalSerialPortDevice(kSerialPortDeviceClassFiscalPrinter,-1,LMb.LocalMachineCode,LSPDr)) then begin  
    DeselectWindow(wn,true);
    GetWindowRecord(wn,RepSpec);
    PMsgStack_SetDate(LSPDr,msgbuffer,RepSpec.d1);
    res = PMsg_SyncDateAndTime(LSPDr,RepSpec.d1,RepSpec.sStartTime);
    if (res==0) then begin
      CloseWindow(wn);
    end else begin
      MessageBox(res,"");
    end;
  end else begin
    MessageBox(20990,"");
  end;
  PSDateTimeWClassOnOKWindow = false;
  return;
end;
