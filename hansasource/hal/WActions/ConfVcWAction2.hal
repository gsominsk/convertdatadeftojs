external procedure FindUserMailboxName(string,var string,var string);

global
function Boolean GetConfWIcn(string subsetname,LongInt pos,var Integer icnp,var Integer icn2p,record ConfVc Confp)
BEGIN
  Boolean res;
  record ConfVc Confr;
  string 255 ckey;
  string 255 user;

  ckey = "SubConfAddrName:";
  if (blank(subsetname)) then begin
    user = "-1";
  end else begin
    user = subsetname;
  end;
  ckey = ckey & user;  
  SetLoopPosition(Confr,pos);
  if (LoopKey(ckey,Confr,1,true)==false) then begin goto LGetConfWIcn; end;
  res = true;
  RecordCopy(Confp,Confr);
    switch (Confr.Class) begin
      case kConfClassConference:
        icnp = 20407;
      case kConfClassNews:
        icnp = 20401;
      case kConfClassBillboard:
        icnp = 20409;
      case kConfClassLibrary:
        icnp = 20403;
      case kConfClassFolder:
        icnp = 29023;
      case kConfClassMailbox:
        icnp = 20501;
      case kConfClassArchive:
        icnp = 29021;
      otherwise
        icnp = 20407;
    end;
    icn2p = icnp + 1;
LGetConfWIcn:;
  GetConfWIcn = res;
  RETURN;
END;

global 
function Boolean GetConf2WIcn(Integer wn,LongInt pos,var Integer icnp,var Integer icn2p,
                            var string aaddrname,var LongInt sernrp,var Integer accfp,var Integer classp)
begin
  Boolean res;
/*  
  LongInt i;
  Integer rwcnt;
  Integer icn,ic2n;
  string 255 addrname;
  LongInt sernr;
  Integer cclass;
  Integer accf;
  void* robase;
  LongInt ropoff;
  LongInt rosz;

  icnp = -1;
  icn2p = -1;
  aaddrname = "";
  sernrp = -1;
  accfp = -1;
  classp = -1;
  
  rosz = HM4GetSize(WnWind(wn)->iconlisth);
  if (rosz<2) then begin goto LGetConf2WIcn; end;
  robase = (char*)HM2Lock(WnWind(wn)->iconlisth,&state);
  ropoff = 0;
  rwcnt = GetTurnedInt(robase,&ropoff);
  for (i=0;i<rwcnt;i++) {
    sernr = GetTurnedLongInt(robase,&ropoff);
    cclass = GetTurnedInt(robase,&ropoff);
    accf = GetTurnedInt(robase,&ropoff);
      
    icn = GetTurnedInt(robase,&ropoff);
    ic2n = GetTurnedInt(robase,&ropoff);
    GetTurnedStr(robase,&ropoff,addrname);
    if (i==pos) then {
      res = true;
      if (icnp!=NIL) then *icnp = icn;
      if (icn2p!=NIL) then *icn2p = ic2n;
      if (aaddrname!=NIL) then strpcpy(aaddrname,addrname);
      if (sernrp!=NIL) then *sernrp = sernr;
      if (accfp!=NIL) then *accfp = accf;
      if (classp!=NIL) then *classp = cclass;
      goto LGetConf2WIcn;
    };
  };
*/  
LGetConf2WIcn:;
  GetConf2WIcn = res;
  return;
end;

global
function Integer CheckConfAccess(record ConfVc Mailboxp,record ConfVc Confp)
BEGIN
  Integer res;
  Integer rwcnt1,rwcnt2;
  Integer i,j;
  row ConfVc crw1;
  row ConfVc crw2;
  record ConfAccVc ConfAccr;
  
  rwcnt2 = MatRowCnt(Confp);
  if (rwcnt2==0) then begin
    res = kAccessLevelFull;
    goto LCheckConfAccess;
  end;
  rwcnt1 = MatRowCnt(Mailboxp);
  for (i=0;i<rwcnt1;i=i+1) begin
    MatRowGet(Mailboxp,i,crw1);
    for (j=0;j<rwcnt2;j=j+1) begin
      MatRowGet(Confp,j,crw2);
      if (crw1.Group==crw2.Group) then begin
        res = kAccessLevelFull;
        ConfAccr.Code = crw2.Group;
        if (ReadFirstMain(ConfAccr,1,true)) then begin
          if (ConfAccr.AccLevel==kAccessLevelDummy) then begin
            res = kAccessLevelFull;
          end else begin
            res = ConfAccr.AccLevel;
          end;
        end;
        goto LCheckConfAccess;
      end;
    end;
  end;
LCheckConfAccess:;
  CheckConfAccess = res;
  return;
end;

global
function Integer CheckCurrentUserConfAccess(record ConfVc Confp)
begin
  record ConfVc Mailboxr;
  string 255 cstr,tstr;
  LongInt mailboxnr;

  FindUserMailboxName(CurrentUser,cstr,tstr);
  mailboxnr = StringToLongInt(cstr);
  Mailboxr.SerNr = mailboxnr;
  ReadFirstMain(Mailboxr,1,true);
  CheckCurrentUserConfAccess = CheckConfAccess(Mailboxr,Confp);
  return;
end;

global
function Boolean UserHasConfAccess(LongInt sernr)
begin
  record ConfVc Mailboxr;
  record ConfVc Confr;
  string 255 cstr,tstr;
  LongInt mailboxnr;
  Boolean res;

  res = false;
  FindUserMailboxName(CurrentUser,cstr,tstr);
  mailboxnr = StringToLongInt(cstr);
  Mailboxr.SerNr = mailboxnr;
  if (ReadFirstMain(Mailboxr,1,true)) then begin
    Confr.SerNr = sernr;
    if (ReadFirstMain(Confr,1,true)) then begin
      if (CheckConfAccess(Mailboxr,Confr)!=0) then begin
        res = true;
      end;
    end;
  end;
  UserHasConfAccess = res;
  return;
end;

global
function LongInt FillConfWNew(string subsetname,LongInt pos,Integer avis,Area res)
begin
  LongInt i;
  Integer icn,ic2n;
  record ConfVc Mailboxr;
  record ConfVc Confr;
  string 255 cstr,ckey;
  Integer accf;
  LongInt mailboxnr;
  string 255 tstr;
  Integer vis;
  LongInt sernr,vmaxp; 
  Integer confclass;
  
  vis = avis;
  accf = 1;
  FindUserMailboxName(CurrentUser,cstr,tstr);
  mailboxnr = StringToLongInt(cstr);
  Mailboxr.SerNr = mailboxnr;
  if (ReadFirstMain(Mailboxr,1,true)) then begin end;  
  ckey = "SubConfAddrName:";
  cstr = subsetname;
  if (blank(cstr)) then begin
    cstr = "-1";
  end;
  ckey = ckey & cstr;

  vmaxp = RecordsInIndex("ConfVc",ckey);
  
  sernr = StringToLongInt(subsetname);
  if (sernr<0) then begin
    if (vis==-1) then begin
      vis = vmaxp;
    end;
    AddIntToArea(vis,res);  
  end else begin
    Confr.SerNr = sernr;
    if (ReadFirstMain(Confr,1,true)) then begin
      confclass = Confr.Class;
      if (confclass==kConfClassFolder) then begin
        vmaxp = vmaxp + 1;
      end;
      if (vis==-1) then begin
        vis = vmaxp;
      end;
      if (Confr.MotherConf>-1) then begin
        tstr = USetStr(1440);
        AddIntToArea(vis+1,res);
        AddLongToArea(Confr.MotherConf,res);
        AddIntToArea(4,res);
        AddIntToArea(1,res);
        AddIntToArea(801,res);
        AddIntToArea(802,res);
        AddStringToArea(tstr,res);
        goto L55;
      end;
      Confr.SerNr = Confr.MotherConf;
      if (ReadFirstMain(Confr,1,true)) then begin
        AddIntToArea(vis+1,res);  
        AddLongToArea(Confr.SerNr,res);  
        AddIntToArea(Confr.Class,res);  //4
        AddIntToArea(1,res);  
        AddIntToArea(801,res);  
        AddIntToArea(802,res);  
        AddStringToArea(Confr.AddrName,res);
        goto L55;
      end;
    end else begin
      if (vis==-1) then begin
        vis = vmaxp;
      end;
    end;
    AddIntToArea(vis,res);  
  end;
L55:;
  for (i=0;i<vis;i=i+1) begin  
    if (GetConfWIcn(subsetname,pos+i,icn,ic2n,Confr)) begin
      accf = CheckConfAccess(Mailboxr,Confr);
      AddLongToArea(Confr.SerNr,res);  
      AddIntToArea(Confr.Class,res);
      AddIntToArea(accf,res);
      AddIntToArea(icn,res);  
      AddIntToArea(ic2n,res);  
      AddStringToArea(Confr.AddrName,res);
    end else begin
      AddLongToArea(-1,res);  
      AddIntToArea(0,res);
      AddIntToArea(0,res);
      AddIntToArea(0,res);
      AddIntToArea(0,res);
      AddStringToArea("",res);
    end;
  end;
  FillConfWNew = vmaxp;
  RETURN;
END;
