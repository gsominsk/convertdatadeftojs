remote updating procedure PullBookingComStatusReply(Area,Area,boolean);
remote procedure EnableRoomsAtBooking(array record AgentRoomVc);
external procedure ActVcRecordDefClient(var record ActVc);
external procedure MakeActFromRes(record ResVc,record ActVc);

global
procedure ResHistDsm()
BEGIN
  record ResVc Resr;
  record RcVc RepSpec;
  Integer wn;

  wn = CurWindow;
  GetWindowRecord(wn,Resr);
  RepSpec.repname = "ResHistRn";
  RepSpec.f1 = Resr.Code;
  RepSpec.Media = mtScreen;
  RepSpec.sEndDate = CurrentDate;
  RepSpec.sStartDate = AddYear(RepSpec.sEndDate,-1);
  RepSpec.flags[0] = 1;
  RunReport(RepSpec,0);
  RETURN;
END;

global
procedure LastGuestLsm()
BEGIN
  record RcVc RepSpec;
  Integer wn;
  record ResVc Resr;      

  wn = CurWindow;
  if (GetRecordFromBrowse(Resr,wn,1)) then begin
    RepSpec.repname = "LastGuestRn";
    RepSpec.f1 = Resr.Code;
    RepSpec.Media = mtScreen;
    RunReport(RepSpec,0);
  end;  
  RETURN;
END;

global
procedure LastGuestDsm()
BEGIN
  record RcVc RepSpec;
  Integer wn;
  record ResVc Resr;      

  wn = CurWindow;
  GetWindowRecord(wn,Resr);
  RepSpec.repname = "LastGuestRn";
  RepSpec.f1 = Resr.Code;
  RepSpec.Media = mtScreen;
  RunReport(RepSpec,0);
  RETURN;
END;

global
updating procedure NewActRoomDsm()
BEGIN
  record ResVc Resr;
  record ActVc Actr;
  Integer wn,nwn;
  
  wn = CurWindow;
  GetWindowRecord(wn,Resr);
  RecordNew(Actr);
  ActVcRecordDefClient(Actr);
  MakeActFromRes(Resr,Actr);
  nwn = OpenWindow("ActDClass",1,0,"","",Actr);  
  RETURN;
END;

global
updating procedure ResVcCreateActivity()
begin
  NewActRoomDsm;
  return;
end;

global
updating procedure ResStateChangesm()
BEGIN
  Integer wn,i;
  record ResVc Resr;   
  record HotelBlock HotelBlockr;   

  wn = CurWindow;
  i = 1;
  blockload(HotelBlockr);
  while (GetRecordFromBrowse(Resr,wn,i)) begin
    if (Resr.ResStatus == HotelBlockr.FromResStatus) then begin
      Resr.ResStatus = HotelBlockr.ToResStatus;
    end else begin  
      if (Resr.ResStatus == HotelBlockr.ToResStatus) then begin
        Resr.ResStatus = HotelBlockr.FromResStatus;
      end;
    end;
    i = i + 1;
    if RecordStore(Resr,true) then begin end;
  end;  
  UpdateBrowses("ResVc");
  RETURN;
END;

global
procedure EnableRoomsAtBookingLsm()
begin
  Integer i,wn;
  record AgentRoomVc ARr;   
  array record AgentRoomVc aARr;

  if (UserCanAction("EnableRoomBookingCom",true)) then begin
    wn = CurWindow;
    i = 1;
    while (GetRecordFromBrowse(ARr,wn,i)) begin
      aARr[aARr.length] = ARr;
      i = i + 1;
    end;
    EnableRoomsAtBooking(aARr);
  end;
  return;
end;

global
procedure EnableRoomsAtBookingDsm()
begin
  Integer wn;
  record AgentRoomVc ARr;   
  array record AgentRoomVc aARr;

  if (UserCanAction("EnableRoomBookingCom",true)) then begin
    wn = CurWindow;
    DeselectWindow(wn,false);
    GetWindowRecord(wn,ARr);
    aARr[aARr.length] = ARr;
    EnableRoomsAtBooking(aARr);
  end;
  return;
end;

global
updating procedure ResBookingComStatusDsm()
begin
  Integer wn;
  record ResVc Resr;   
  Area reply;
  Area replyheader;
  boolean timeout;

  wn = CurWindow;
  GetWindowRecord(wn,Resr);
  PullBookingComStatusReply(reply,replyheader,false);
  return;
end;
