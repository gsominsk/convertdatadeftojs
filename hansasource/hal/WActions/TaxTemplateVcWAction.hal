external procedure GetVATRow(string,var row VATCodeBlock);

function Boolean TaxTemplateDClassVATCodeEFAfter(Integer wn,Integer rownr,Boolean changedf)
begin
  Boolean res;
  record TaxTemplateVc TTr;
  row TaxTemplateVc TTrw;
  row VATCodeBlock VATCbrw;

  res = true;
  if (changedf) then begin
    if (rownr>=0) then begin
      GetWindowRecord(wn,TTr);
      MatRowGet(TTr,rownr,TTrw)
      GetVATRow(TTrw.VATCode,VATCbrw);
      TTrw.VATRate = VATCbrw.ExVatpr;
      if (blank(TTrw.VATRate)) then begin
        TTrw.VATRate = -(1-(100.00/(100.00-VATCbrw.IncVatpr)))*100;
      end;
      TTrw.Comment = VATCbrw.Comment;
      MatRowPut(TTr,rownr,TTrw)
      PutWindowRecord(wn,TTr);
    end;
  end;
  TaxTemplateDClassVATCodeEFAfter = res;
  return;
end;

global
function Boolean TaxTemplateDClassAfterEditField(Integer wn,string fieldname,Integer fn, Integer rownr,Integer changed)
begin
  Boolean res;

  switch (fieldname) begin
    case "VATCode": res = TaxTemplateDClassVATCodeEFAfter(wn,rownr,changed!=0);
  end;
  TaxTemplateDClassAfterEditField = res;
  return;
end;

global
function Boolean TaxTemplateDClassActiveEditField(Integer wn,string fieldname,Integer fn,Integer wnst,Integer rownr,Integer changed)
begin
  Boolean res;

  res = true;
  switch (fieldname) begin
    case "VATRate": res = false;
  end;
  TaxTemplateDClassActiveEditField = res;
  return;
end;
