external function roundmode DefaultRoundMode();
external function Integer Norm2Cont(string,val,val);
external procedure SpecialRateCalc(val,val,val,var val);
external procedure GetFullCurncyRate (var string,Date,var val,var val,var val,var val,var val);
external procedure FBSumup(var record FBVc);

procedure FBUpdateDebRows(var row FBVc FBrp,Date trdat)
BEGIN
  val sv,frrate,tor1,tor2,base1,base2;
  val temp;

  FBrp.CredVal = sv;
  FBrp.Cred2Val = sv;
  FBrp.CurCredVal = sv;
  if ((FBrp.DebVal==0) and (FBrp.Deb2Val!=0)) then begin
    goto LFBUpdateDebRows;
  end;
  GetFullCurncyRate(FBrp.CurncyCode,trdat,frrate,tor1,tor2,base1,base2);  
  SpecialRateCalc(FBrp.DebVal,base1,base2,sv);
  sv = Round(sv,DefaultRoundMode);
  FBrp.Deb2Val = sv;
LFBUpdateDebRows:;  
  RETURN;
END;

procedure UpdateCredRows(var row FBVc FBrp,Date trdat)
BEGIN
  val sv,frrate,tor1,tor2,base1,base2;
  val temp;

  FBrp.DebVal = sv;
  FBrp.Deb2Val = sv;
  FBrp.CurDebVal = sv;
  if ((FBrp.CredVal==0) and (FBrp.Cred2Val!=0)) then begin
    goto LUpdateCredRows;
  end;
  GetFullCurncyRate(FBrp.CurncyCode,trdat,frrate,tor1,tor2,base1,base2);  
  SpecialRateCalc(FBrp.CredVal,base1,base2,sv);
  sv = Round(sv,DefaultRoundMode);
  FBrp.Cred2Val = sv;
LUpdateCredRows:;  
  RETURN;
END;

global
function Boolean FBVc_PasteDebVal(var record FBVc FBp,Integer rownr,var Integer messnr)
BEGIN
  Boolean res;
  row FBVc FBrw;
  record CYBlock CompYear;
  
  MatRowGet(FBp,rownr,FBrw);
  FBUpdateDebRows(FBrw,FBp.TransDate);
  MatRowPut(FBp,rownr,FBrw);
  BlockLoad(CompYear);
  if (CompYear.trDoNVTest==1) then begin
    messnr = Norm2Cont(FBrw.AccNumber,FBrw.DebVal,0);
  end;
  FBSumup(FBp);
  res = true;
  FBVc_PasteDebVal = res;
  RETURN;
END;

global
function Boolean FBVc_PasteCredVal(var record FBVc FBp,Integer rownr,var Integer messnr)
BEGIN
  Boolean res;
  row FBVc FBrw;
  record CYBlock CompYear;
  
  MatRowGet(FBp,rownr,FBrw);
  UpdateCredRows(FBrw,FBp.TransDate);
  MatRowPut(FBp,rownr,FBrw);
  BlockLoad(CompYear);
  if (CompYear.trDoNVTest==1) then begin
    messnr = Norm2Cont(FBrw.AccNumber,0,FBrw.CredVal);
  end;
  FBSumup(FBp);
  res = true;
  FBVc_PasteCredVal = res;
  RETURN;
END;

global
function Boolean FBVc_PasteDeb2Val(var record FBVc FBp,Integer rownr,var Integer messnr)
BEGIN
  Boolean res;
  row FBVc FBrw;
  record CYBlock CompYear;
  
  BlockLoad(CompYear);
  if (CompYear.trDoNVTest==1) then begin
    MatRowGet(FBp,rownr,FBrw);
    messnr = Norm2Cont(FBrw.AccNumber,FBrw.Deb2Val,0);
  end;
  FBSumup(FBp);
  res = true;
  FBVc_PasteDeb2Val = res;
  RETURN;
END;

global
function Boolean FBVc_PasteCred2Val(var record FBVc FBp,Integer rownr,var Integer messnr)
BEGIN
  Boolean res;
  row FBVc FBrw;
  record CYBlock CompYear;
  
  BlockLoad(CompYear);
  if (CompYear.trDoNVTest==1) then begin
    MatRowGet(FBp,rownr,FBrw);
    messnr = Norm2Cont(FBrw.AccNumber,0,FBrw.Cred2Val);
  end;
  FBSumup(FBp);
  res = true;
  FBVc_PasteCred2Val = res;
  RETURN;
END;

