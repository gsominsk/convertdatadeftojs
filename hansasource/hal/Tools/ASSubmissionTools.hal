global
function string 255 GetNextSKU(string skunr)
begin
  string 255 res;
  record SRBlock SRb;
  string 255 lastsku;
  integer OldComp;

  OldComp = CurrentCompany;
  SetServerCompany(1);  // HansaMail
  BlockLoad(SRb);
  lastsku = skunr;
  if (StringToVal(lastsku,M40Val)>=StringToVal("10000001",M40Val)) and (StringToVal(lastsku,M40Val)<=StringToVal("99999999",M40Val)) or (blank(lastsku)) then begin
    if (StringToVal(lastsku,M40Val)<StringToVal(SRb.LastSKU,M40Val)) then begin
      lastsku = SRb.LastSKU;
    end;
  end;
  if (blank(lastsku)) then begin
    res = "10000001";
  end else begin
    res = StringToLongInt(lastsku) + 1;
  end;
  SetServerCompany(OldComp);
  GetNextSKU = res;
  return;
end;

function string 255 SKUForASInApp(string ASInApp)
begin
  string 255 res,index;
  Boolean found,testf;
  record ASSubmissionVc ASSr;
  row ASSubmissionVc ASSrw;
  Integer i,rwcnt;

  ResetLoop(ASSr);
  found = true;
  index = "ASInApp:" & ASInApp;
  while (LoopKey(index,ASSr,1,found)) begin
    if (found) then begin
      testf = true;
      if (testf) then begin
        rwcnt = MatRowCnt(ASSr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(ASSr,i,ASSrw);
          if (ASSrw.ASInApp==ASInApp) then begin
            if (StringToVal(ASSr.ApplicationSKU,M40Val)>=StringToVal("10000001",M40Val)) and (StringToVal(ASSr.ApplicationSKU,M40Val)<=StringToVal("99999999",M40Val)) then begin
              i = rwcnt;
              found = false;
              res = ASSrw.ASInAppSKU;
            end;
          end;
        end;
      end;
    end;
  end;
  SKUForASInApp = res;
  return;
end;

global
updating function Integer SKUsASSubmissionGenerate(var record ASSubmissionVc ASSr)
begin
//updating for making sure other operation menu dont get same SKUs
  Integer res;
  row ASSubmissionVc ASSrw;
  Integer i,rwcnt;
  string 255 lastsku;
  record ASSubmissionVc oldASSr;
  
  if (ASSr.ASStore=="G") then begin
    goto LSKUsASSubmissionGenerate;
  end;
  RecordCopy(oldASSr,ASSr);
  if (blank(ASSr.ApplicationSKU)) then begin
    ASSr.ApplicationSKU = GetNextSKU("");
  end;
  if (StringToVal(ASSr.ApplicationSKU,M40Val)>=StringToVal("10000001",M40Val)) and (StringToVal(ASSr.ApplicationSKU,M40Val)<=StringToVal("99999999",M40Val)) then begin
    lastsku = ASSr.ApplicationSKU;
  end;
  rwcnt = MatRowCnt(ASSr);
/*  
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ASSr,i,ASSrw);
    if (blank(ASSrw.ASInAppSKU)) then begin
      ASSrw.ASInAppSKU = SKUForASInApp(ASSrw.ASInApp);
      MatRowPut(ASSr,i,ASSrw);
    end;
  end;
*/
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ASSr,i,ASSrw);
    if (nonblank(ASSrw.ASInAppSKU)) then begin
      if (StringToVal(ASSrw.ASInAppSKU,M40Val)>StringToVal(lastsku,M40Val)) and (StringToVal(ASSrw.ASInAppSKU,M40Val)>=StringToVal("10000001",M40Val)) and (StringToVal(ASSrw.ASInAppSKU,M40Val)<=StringToVal("99999999",M40Val)) then begin
        lastsku = ASSrw.ASInAppSKU;
      end;
    end;
  end;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ASSr,i,ASSrw);
    if (blank(ASSrw.ASInAppSKU)) then begin
      ASSrw.ASInAppSKU = GetNextSKU(lastsku);
      if (StringToVal(ASSrw.ASInAppSKU,M40Val)>StringToVal(lastsku,M40Val)) and (StringToVal(ASSrw.ASInAppSKU,M40Val)>=StringToVal("10000001",M40Val)) and (StringToVal(ASSrw.ASInAppSKU,M40Val)<=StringToVal("99999999",M40Val)) then begin
        lastsku = ASSrw.ASInAppSKU;
      end;
      MatRowPut(ASSr,i,ASSrw);
    end;
  end;
  RecordUpdate(oldASSr,ASSr,true);
LSKUsASSubmissionGenerate:;  
  SKUsASSubmissionGenerate = res;
  return;
end;
