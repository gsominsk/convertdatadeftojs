external function Boolean IsEnterprise();
external procedure RsrtEventSumup(record RsrtEventVc);

procedure NewRsrtEvent(string eventtype,string rescode,Date td,Time st,Time et,var record RsrtEventVc REventr)
begin
  record RsrtEventTypeVc RETr;
  record ResTypeVc RTr;
  record ResVc Resr;
  LongInt maxpersons;
  Integer nwn;

  RecordClear(REventr);
  RETr.Code = eventtype;
  ReadFirstMain(RETr,1,true);
  Resr.Code = rescode;
  ReadFirstMain(Resr,1,true);
  maxpersons = Resr.MaxPersons;
  if (maxpersons<0) then begin
    maxpersons = RETr.MaxPersons;
  end;
  
  RecordNew(REventr);
  REventr.EventType = eventtype;
  REventr.Comment = RETr.Comment;
  REventr.ResCode = rescode;
  REventr.ResLoc = RTr.ResLoc;
  REventr.StartDate = td;
  REventr.EndDate = td;
  REventr.StartTime = st;
  REventr.EndTime = et;
  REventr.ScheduleStartTime = st;
  REventr.ScheduleEndTime = et;
  REventr.MaxPersons = maxpersons;
  REventr.MinPersons = RETr.MinPersons;

  REventr.MaxAge = RETr.MaxAge;
  REventr.MinAge = RETr.MinAge;
  REventr.ResLoc = RETr.ResLoc;
  REventr.ResLoc = Resr.ResLoc;
  RsrtEventSumup(REventr);
  REventr.SerNr = NextSerNr("RsrtEventVc",REventr.StartDate,-1,false,""); 
  return;
end;

function Boolean NewRsrtEvent_JobVc(LongInt nr,string eventtype,string rescode,Date td,Time st,Time et,string package,LongInt seqnr,var record RsrtEventVc REventr)
begin
  Boolean res;
  record JobVc Jobr;
  row JobVc Jobrw;
  record ResVc Resr;
  record RsrtEventTypeVc RETr;
  row RsrtEventVc REventrw;
  LongInt l,pers;
  Integer i,rwcnt;
  Integer nwn;
  record ResTypeVc RTr;
  LongInt maxpersons;
  record INVc INr;
  
  RecordClear(REventr);
  Jobr.SerNr = nr;
  if (ReadFirstMain(Jobr,1,true)) then begin    
    RTr.Code = Jobr.Type;
    if (ReadFirstMain(RTr,1,true)) then begin
    end;
    RETr.Code = eventtype;
    ReadFirstMain(RETr,1,true);
    INr.Code = RETr.ArtCode;
    ReadFirstMain(INr,1,true);
    Resr.Code = rescode;
    ReadFirstMain(Resr,1,true);
    maxpersons = Resr.MaxPersons;
    if (maxpersons<0) then begin
      maxpersons = RETr.MaxPersons;
    end;
    
    RecordNew(REventr);
    REventr.EventType = eventtype;
    REventr.Comment = RETr.Comment;
    REventr.ResCode = rescode;
    REventr.ResLoc = RTr.ResLoc;
    REventr.StartDate = td;
    REventr.EndDate = td;
    REventr.StartTime = st;
    REventr.EndTime = et;
    REventr.ScheduleStartTime = st;
    REventr.ScheduleEndTime = et;
    REventr.MaxPersons = maxpersons;
    REventr.MinPersons = RETr.MinPersons;

    REventr.MaxAge = RETr.MaxAge;
    REventr.MinAge = RETr.MinAge;
    REventr.ResLoc = RETr.ResLoc;
    
    rwcnt = MatRowCnt(Jobr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(Jobr,i,Jobrw);
      ClearRow(REventr,REventrw,1);
      REventrw.JobNr = Jobr.SerNr;
      REventrw.CustCode = Jobr.CUCode;
      REventrw.CustName = Jobr.CUName;
      REventrw.GuestCode = Jobrw.GuestCode;
      REventrw.GuestName = Jobrw.CUName;
      REventrw.Invoicing = kResortEventOnReservation;
      REventrw.Price = INr.UPrice1;
      REventrw.RsrtEventTypePack = package;
      REventrw.SequenceNr = seqnr;
      MatRowPut(REventr,MatRowCnt(REventr),REventrw);      
    end;
    pers = Jobr.Persons;
    if (IsEnterprise) then begin
      if (Jobr.Children>0) then begin
        pers = pers + Jobr.Children;
      end;
    end;    
    if (rwcnt<pers) then begin
      for (l=rwcnt;l<pers;l=l+1) begin
        ClearRow(REventr,REventrw,1);
        REventrw.JobNr = Jobr.SerNr;
        REventrw.CustCode = Jobr.CUCode;
        REventrw.CustName = Jobr.CUName;
        REventrw.Invoicing = kResortEventOnReservation;
        REventrw.Price = INr.UPrice1;
        REventrw.RsrtEventTypePack = package;
        REventrw.SequenceNr = seqnr;
        MatRowPut(REventr,MatRowCnt(REventr),REventrw);      
      end;
    end;
    RsrtEventSumup(REventr);
    REventr.SerNr = NextSerNr("RsrtEventVc",REventr.StartDate,-1,false,"");            
    res = true;
  end;
  NewRsrtEvent_JobVc = res;
  return;
end;


global
function Integer DblNewRsrtEventVcRemote(string eventtype,string rescode,Date td,Time st,Time et,string package,LongInt seqnr,string filename,LongInt nr,
                                       var record RsrtEventVc REventr)
begin
  Integer res;
  
  REventr.EventType = eventtype;
  REventr.ResCode = rescode;
  REventr.StartDate = td;
  REventr.ScheduleStartTime = st;
  if (ReadFirstKey("ActEventTypeSchedule",REventr,4,true)==false) then begin
    switch (filename) begin
      case "JobVc":
        NewRsrtEvent_JobVc(nr,eventtype,rescode,td,st,et,package,seqnr,REventr);
      otherwise
        NewRsrtEvent(eventtype,rescode,td,st,et,REventr);
    end;
    res = 0;
  end else begin
    res = 1;
  end;
  DblNewRsrtEventVcRemote = res;
  return;
end;
