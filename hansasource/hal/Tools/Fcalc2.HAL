
#ifdef HAL 


external function val FADDSUB(string);

//-----------------------------------------------------
Global Function val FCALC(string exp)
begin
  FCALC=FADDSUB(exp);
  return;
end;

//--------------------------------------------
global procedure getvarval(string varname,record SMVc vararray,var string varvalstr) 
begin
  row SMVc vr;
  integer amr,i;
  string 250 res;
  
  amr=MatrowCnt(vararray);
  res="";
  for (i=0;i<amr;i=i+1) begin
    MatRowGet(vararray,i,vr);
    if (vr.AccNumber==varname) then begin
      res=vr.Comment; 
      i=amr;
    end;
  end;
  varvalstr=res;
  return;
end;

//--------------------------------------------
global procedure addvarval(string varname,var record SMVc vararray,string varvalstr) 
begin
  row SMVc vr;
  integer amr;
  
  amr=MatrowCnt(vararray);
  vr.AccNumber=varname;
  vr.Comment=varvalstr;
  MatRowPut(vararray,amr,vr);
  
  return;
end;

//---------------------------------------------
procedure spacedelete(var string exp)
begin
  string 250 newexp;
  integer i,ls;
  ls=len(exp);
  newexp="";
  for (i=0;i<ls;i=i+1) begin
    if (mid(exp,i,1)<>" ") then begin
      newexp=newexp & mid(exp,i,1);   
    end;
  end;
  exp=newexp;
  return;
end;

//----------------------------------------------
Global Function val FCALCWITHVAR(string exp,var record SMVc vararray,string expname)
begin
  string 250 newexp,varvalstr,varname,tt,prstr;
  string 1 ws,ss;
  integer i,j,ls,es;
  Val res;
  transaction string 1 gDelimCharacter;

  spacedelete(exp);

  ls=len(exp);
  newexp="";
  for(i=0;i<ls;i=i+1) begin
    switch (mid(exp,i,1)) begin
      case "#":
        for (j=i+1;j<ls;j=j+1) begin
          ws=mid(exp,j,1);
          es=0; 
          if (ws=="+") or (ws=="-") or (ws=="/") or (ws=="*")  or (ws==gDelimCharacter) or (ws==")") then begin
            es=j;
            j=ls;
          end; 
          if (es==0) then begin es=ls; end; 
        end;  
        varname=mid(exp,i+1,es-i-1);
        getvarval(varname,vararray,varvalstr);
        newexp=newexp & varvalstr;
        i=es-1;
      case "&":
        for (j=i+1;j<ls;j=j+1) begin
          ws=mid(exp,j,1);
          es=0; 
          if (ws=="+") or (ws=="-") or (ws=="/") or (ws=="*")  or (ws==gDelimCharacter) or (ws==")") then begin
            es=j;
            j=ls;
          end; 
          if (es==0) then begin es=ls; end; 
        end;  
        varname=mid(exp,i+1,es-i-1);
        getvarval(varname,vararray,varvalstr);
    //   getspecval(varname,RepSpec,varvalstr);
        newexp=newexp & varvalstr;
        i=es-1;
      otherwise
        prstr=newexp & mid(exp,i,1);
        newexp=prstr;
    end;  
  end;
  res= FCALC(newexp);

  if (expname<>"") then begin  
    tt=res;
    addvarval(expname,vararray,tt) ;
  end;
  FCALCWITHVAR=res; 
  return;
end;



#endif
