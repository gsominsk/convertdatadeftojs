external procedure StripSpace(var string,string);
external function roundmode SetRoundModeD(Integer);
external function val ValFromString(string,string,string);
external procedure M4PadString(string,Integer,string,Boolean,var string);

procedure GetChar(string in,var string out,Integer i)
BEGIN
  string 255 tstr;
  
  if (i>len(in)) then begin 
    out = "";
    goto LGetChar; 
  end;
  tstr = Right(in,(len(in)-i)+1); 
  out = Left(tstr,1); 
LGetChar:;  
  RETURN;
END;

global
procedure CalcNorCheck(var string refstr,Boolean mod10)
BEGIN
  Integer j,t,l,tmp1,tmp2;
  LongInt c,s;
  string 60 check1,check2;
  string 1 res,t2;
  string 255 tstr;

  c = -1;
  res = false;
  check1 = " 121212121212121212121212121212";
  check2 = " 765432765432765432765432765432";
  if (len(refstr)==0) then begin goto LCalcNorCheck; end;
  c = 0;
  t = len(refstr);
  l = len(check1);
  if (mod10==true) then begin
    for (j = 0; j<t; j=j+1) begin
      GetChar(refstr,t2,t-j);
      tmp1 = asc(t2) - 48;
      GetChar(check1,t2,l-j);
      tmp2 = asc(t2) - 48;
      s = tmp1 * tmp2;  
      if (s>9) then begin
        tstr = s;      
        GetChar(tstr,t2,1);      
        tmp1 = asc(t2) - 48;
        GetChar(tstr,t2,2);      
        tmp2 = asc(t2) - 48;
        s = tmp1 + tmp2;      
      end;
      c = c + s;    
    end;
    if (c==0) then begin
      res = "-";
    end else begin
      c = MOD(c,10);
      s = 10;
      c = s - c;
      if (c==10) then begin c = 0; end;
      res = c;
    end;    
    refstr = refstr & res;
  end;
  if (mod10==false) then begin
    c = 0;
    for (j = 0; j<t; j=j+1) begin
      GetChar(refstr,t2,t-j);
      tmp1 = asc(t2) - 48;
      GetChar(check2,t2,l-j);
      tmp2 = asc(t2) - 48;
      s = tmp1 * tmp2;        
      c = c + s;    
    end;
    c = MOD(c,11);
    s = 11;
    c = s - c;
    if (c==11) then begin
      res = "0";
      goto L90;
    end;
    if (c==10) then begin
      res = "-";
      goto L90;
    end;
    res = c;
L90:;
    refstr = refstr & res;
  end;  
LCalcNorCheck:;
  RETURN;
END;

global
procedure CreateKIDCode2(string cust,LongInt inv,var string tstr,record BankFileBlock bfr)
BEGIN
  string 255 t2;
  integer lstr;

  tstr = "";  
  if (bfr.ReceiptBank==kReceiptBankSGFinansNorway) then begin
    tstr = "9";
    M4PadString(bfr.ClientNr,4,"0",true,t2);
    tstr = tstr & t2;
    M4PadString(inv,8,"0",true,t2);
    tstr = tstr & t2;
    tstr = tstr & "00";
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankCITIChech) then begin
    tstr = "9";
    M4PadString(bfr.ClientNr,4,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString(inv,8,"0",true,t2);
    tstr = tstr & t2;
    tstr = tstr & "00";
    goto LCreateKIDCode2;
  end;

  if (bfr.ReceiptBank==kReceiptBankPBKOutsourcingSweden) then begin
    M4PadString(bfr.ClientNr,4,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString(inv,8,"0",true,t2);
    tstr = tstr & t2;
    lstr = len(tstr) + 2;
    lstr = lstr - 10;
    t2 = ValToString(lstr,M40Val,"","",0);
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;

  if (bfr.ReceiptBank==kReceiptBankBGcStandardSweden) then begin
    M4PadString("1111",4,"1111",false,t2);
    tstr = tstr & t2;
    M4PadString(inv,10,"0",true,t2);
    tstr = tstr & t2;
    lstr = len(tstr) + 2;
    lstr = lstr - 10;
    t2 = ValToString(lstr,M40Val,"","",0);
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;

  if (bfr.ReceiptBank==kReceiptBankNordeaFinans) then begin//Nordea
    M4PadString(Left(cust,7),7,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString(bfr.ClientNr,4,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString(inv,7,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString("1",1,"0",true,t2); 
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankeCredit) then begin
    tstr = "1";
    tstr = tstr & bfr.ClientNr;
    M4PadString(inv,7,"0",true,t2);          
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;
//some lap  
  if (bfr.ReceiptBank==kReceiptBankNORDFinansDenmark) then begin // This is for Nord Finans - DK HŠr
    tstr = "0000";
    tstr = tstr & bfr.ClientNr;    
    M4PadString(inv,5,"0",true,t2);          
    tstr = tstr & t2;  
    tstr = tstr & "000";   
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==12) then begin
    M4PadString(cust,14,"0",true,tstr);          
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==11) then begin //Kid Code 15(2)
    M4PadString(inv,14,"0",true,tstr);          
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==10) then begin //Kid Code 14
    M4PadString(inv,8,"0",true,tstr);          
    M4PadString(cust,7,"0",true,t2);          
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==9) then begin
    M4PadString(inv,8,"0",true,tstr);          
    M4PadString(cust,6,"0",true,t2);          
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==8) then begin
    tstr = "1";
    M4PadString(bfr.ClientNr,3,"0",true,t2);          
    tstr = tstr & t2;
    M4PadString(inv,7,"0",true,t2);          
    tstr = tstr & t2;
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankNORDFinansNorway) then begin // This is for Nord Finans - NOR
    tstr = "0109";
    tstr = tstr & bfr.ClientNr;    
    M4PadString(inv,5,"0",true,t2);          
    tstr = tstr & t2;  
    tstr = tstr & "000";   
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankKFinansNorway) then begin
    tstr = "000";
    M4PadString(cust,4,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(bfr.ClientNr,4,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(inv,7,"0",true,t2);          
    tstr = tstr & t2;    
    tstr = tstr & "1";    
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankDNBNorway) then begin
    tstr = "5";
    M4PadString(bfr.ClientNr,4,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(inv,7,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(cust,7,"0",true,t2);          
    tstr = tstr & t2;    
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankBedriftsfinans) then begin
    tstr = "0109";
    M4PadString(bfr.ClientNr,3,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(inv,9,"0",true,t2);          
    tstr = tstr & t2;    
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankFinansNorway) then begin
    tstr = "0109";
    tstr = tstr & bfr.ClientNr;        
    M4PadString(inv,5,"0",true,t2);          
    tstr = tstr & t2;    
    tstr = tstr & "000";    
    goto LCreateKIDCode2;
  end;
  if (bfr.ReceiptBank==kReceiptBankGjensidigeNorway) then begin
    tstr = "9";
    t2 = Left(bfr.ClientNr,4);
    tstr = tstr & t2;    
    M4PadString(cust,9,"0",true,t2);          
    tstr = tstr & t2;    
    M4PadString(inv,8,"0",true,t2);          
    tstr = tstr & t2;    
    tstr = tstr & "00";    
    goto LCreateKIDCode2;
  end;
  if (len(cust)<6) then begin
    M4PadString(cust,6,"0",true,tstr);      
  end else  begin
    tstr = cust;
  end;  
  M4PadString(inv,9,"0",true,t2);      
  tstr = tstr & t2;
LCreateKIDCode2:;  
  RETURN;
END;

global
procedure CreateKIDCode(string cust,LongInt inv,var string res)
BEGIN
  record BankFileBlock bfr;
  string 255 tstr;

  BlockLoad(bfr);
  CreateKIDCode2(cust,inv,tstr,bfr);
  if (bfr.KIDMod<>1) then begin
    CalcNorCheck(tstr,true);
  end else begin
    CalcNorCheck(tstr,false);
  end;
  res = tstr;
  RETURN;
END;

global
procedure CreateKIDNoCheck(string cust,LongInt inv,var string res)
BEGIN
  record BankFileBlock bfr;

  BlockLoad(bfr);
  CreateKIDCode2(cust,inv,res,bfr);
  RETURN;
END;

global
function Boolean check_ref(string arefstr)
BEGIN
  Integer j,c;
  Boolean res;
  string 20 check;
  string 1 oldref;
  Integer t;
  string 255 refstr;

  check = "731731731731731731731";
  refstr = arefstr;
  if (HasLocalization("FIN")) then begin
    StripSpace(refstr,refstr);
  end;
  if (len(refstr)==0) then begin
    res = true;
    goto Lcheck_ref;
  end;
  t = len(refstr);  
  oldref = Mid(refstr,t-1,1); 
  t = t - 1;
  for (j=0;j<t;j=j+1) begin
    c = c + ((asc(Mid(refstr,t-j-1,1))-asc("0"))*(asc(Mid(check,j,1))-asc("0")));
  end;
  c = ((c / 10) + 1 ) * 10 - c;
  c = Mod(c,10);
  c = c + asc("0");
  if (c==asc(oldref)) then begin
    res = true;
  end;
Lcheck_ref:;  
  check_ref = res;
  RETURN;
END;

function string 2 IntCredRefConvertCharToDigits(string refstr)
begin
  string 255 res;
  string 2 ch;
  integer i,l;
  
  l = Len(refstr);
  for (i=0;i<l;i=i+1) begin
    ch = Mid(refstr,i,1);
    switch(UpperCase(ch)) begin
      case "A": ch = "10";
      case "B": ch = "11";
      case "C": ch = "12";
      case "D": ch = "13";
      case "E": ch = "14";
      case "F": ch = "15";
      case "G": ch = "16";
      case "H": ch = "17";
      case "I": ch = "18";
      case "J": ch = "19";
      case "K": ch = "20";
      case "L": ch = "21";
      case "M": ch = "22";
      case "N": ch = "23";
      case "O": ch = "24";
      case "P": ch = "25";
      case "Q": ch = "26";
      case "R": ch = "27";
      case "S": ch = "28";
      case "T": ch = "29";
      case "U": ch = "30";
      case "V": ch = "31";
      case "W": ch = "32";
      case "X": ch = "33";
      case "Y": ch = "34";
      case "Z": ch = "35";
    end;
    res = res & ch;
  end;
  
  IntCredRefConvertCharToDigits = res;
  return;
end;

global
function string 255 CreateInternationalCreditorReference(string refstr)
begin
  string 255 res;
  string 255 convrefstr;
  integer t,i,l;
  val v,d;
  roundmode rnd;
  
  convrefstr = IntCredRefConvertCharToDigits(refstr);
  v = ValFromString(convrefstr & "271500","","");
  d = v/97;
  rnd.decimals = 0;
  rnd.mode = kRoundingModeTruncate;
  d = Round(d,rnd);
  d = v - (97*d);
  t = 98 - d;
  res = "RF";
  if (t<10) then begin
    res = res & "0" & t;
  end else begin
    res = res & t;
  end;
  l = Len(convrefstr);
  for (i=0;i<l;i=i+1) begin
    if (Mod(i,4)==0) then begin
      res = res & " ";
    end;
    res = res & Mid(convrefstr,i,1);
  end;
  
  CreateInternationalCreditorReference = res;
  return;
end;
