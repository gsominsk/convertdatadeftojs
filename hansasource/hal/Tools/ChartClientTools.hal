external procedure DefaultPeriod(var string);
external procedure In2Period(var string,var Date,var Date);

function string 255 SetPeriod(Integer months)
begin
  Date sd,ed;

  sd = CurrentDate;
  sd = AddMonth(sd,-(months-1));
  sd.day = 1;
  ed = CurrentDate;
  ed.day = DaysInMonth(ed.year,ed.month);
  SetPeriod = sd & ":" & ed;
  return;
end;

global
procedure ChartClicked(string arg)
begin
  record RcVc RepSpec;
  Integer nwn,wn;
  record ModuleBlock Modb;
  Date sd,ed;

  if (SendLevel>0) then begin
    goto LChartClicked_out;
  end;

  wn = CurWindow;
  switch (arg) begin
    case "$BIWClass_BIChart":
    otherwise
      if (UserCanAction("ViewBI",true)) then begin
        BlockLoad(Modb);
        if (Modb.BI) then begin
          switch (arg) begin
            case "$ResDCLass_BIChart": begin
              end;
            case "$INDCLass_BIChart": begin
              record INVc INr;
              
              if (GetWindowClass(wn)=="INDClass") then begin
                GetWindowRecord(wn,INr);
              end;
              RepSpec.flags[1] = 0;
              RepSpec.f2 = INr.Code;
              RepSpec.Period2Str = SetPeriod(12);
              end;
            case "$ITDCLass_BIChart": begin
              record ITVc ITr;
              
              if (GetWindowClass(wn)=="ITDClass") then begin
                GetWindowRecord(wn,ITr);
              end;
              RepSpec.flags[1] = 0;
              RepSpec.f6 = ITr.Code;
              RepSpec.Period2Str = SetPeriod(12);
              end;
            case "$CCATDCLass_BIChart": begin
              record CCatVc CCatr;
              
              if (GetWindowClass(wn)=="CCatDClass") then begin
                GetWindowRecord(wn,CCatr);
              end;
              RepSpec.flags[1] = 2;
              RepSpec.f4 = CCatr.Code;
              RepSpec.Period2Str = SetPeriod(12);
              end;
            case "$CUDCLass_BIChart": begin
              record CUVc CUr;
              
              if (GetWindowClass(wn)=="CUDClass") then begin
                GetWindowRecord(wn,CUr);
              end;
              RepSpec.flags[1] = 2;
              RepSpec.f1 = CUr.Code;
              RepSpec.Period2Str = SetPeriod(12);
              end;
//            case "$DashboardWClass_Pipeline":
            case "$DashboardWClass_PnL":
              sd = AddMonth(CurrentDate,-1);
              ed = sd;
              sd = AddMonth(sd,-5);
              sd.day = 1;
              ed.day = DaysInMonth(ed.year,ed.month);
              RepSpec.Period2Str = sd & ":" & ed;
            case "$DashboardWClass_TopItemGroups":
              RepSpec.flags[1] = 3;
              RepSpec.Period2Str = SetPeriod(1);
            case "$DashboardWClass_TopSalesmen":
              RepSpec.flags[1] = 6;
              RepSpec.Period2Str = SetPeriod(1);
            case "$DashboardWClass_DebCred":
              sd = "01/01/1980";
              ed = CurrentDate;
              ed.day = DaysInMonth(ed.year,ed.month);
              RepSpec.Period2Str = sd & ":" & ed;
            case "$DashboardWClass_TopCustomers":
              RepSpec.flags[1] = 2;
              RepSpec.Period2Str = SetPeriod(1);
            otherwise
              DefaultPeriod(RepSpec.Period2Str);
          end;
          In2Period(RepSpec.Period2Str,RepSpec.sStartDate,RepSpec.sEndDate);
          nwn = OpenWindow("BIWClass",1,0,"","",RepSpec);
//          PutWindowString(nwn,"BIWClass_BIChart",arg);
        end;
      end;
  end;
LChartClicked_out:;
end;

global
procedure ChartDatumClicked(string arg)
begin
  record RcVc RepSpec;
  Integer nwn;

  nwn = OpenWindow("BIWClass",1,0,"","",RepSpec);
end;

global
function Boolean BIWClassArtModeButtonAfter(Integer wn,Boolean changedf)
begin        
  record RcVc RepSpec;  
  Boolean res;

  GetWindowRecord(wn,RepSpec);
  PutWindowRecord(wn,RepSpec);
  BIWClassArtModeButtonAfter = res;  
  return;
end;

global
procedure BIWClassClearSelection()
begin
  record RcVc RepSpec,newRepSpec;
  
  DeselectWindow(CurWindow,false);
  GetWindowRecord(CurWindow,RepSpec);
  RecordClear(newRepSpec);
  WindowFieldGoto(CurWindow,newRepSpec,-1,"Period2Str",true);
  PutWindowRecord(CurWindow,newRepSpec);
  KeyPadEnter(CurWindow);
  newRepSpec.Period2Str = RepSpec.Period2Str;
  newRepSpec.sStartDate = RepSpec.sStartDate;
  newRepSpec.sEndDate = RepSpec.sEndDate;
  WindowFieldGoto(CurWindow,newRepSpec,-1,"Period2Str",true);
  PutWindowRecord(CurWindow,newRepSpec);
  KeyPadEnter(CurWindow);
  return;
end;
