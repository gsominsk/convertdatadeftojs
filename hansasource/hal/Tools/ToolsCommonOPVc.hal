external function val ISAccess_GetUserWeight(record ISAccessBlock,string);

global
function val GetOPSignedWeight(LongInt OPNr,var string SignedBy)
begin
  val res;
  record ERecordStatusVc ERecordStatusr;
  Boolean TrHs;
  record ISAccessBlock ISAccessRec;
  
  BlockLoad(ISAccessRec);
  ERecordStatusr.FileName = "OPVc";
  ERecordStatusr.Status = 7;
  ERecordStatusr.TheirRecipient = "";
  ERecordStatusr.CustSerNr = OPNr;
  TrHs = true;
  SignedBy = "";
  while (LoopKey("FileNameStatusTheir",ERecordStatusr,4,TrHs)) begin
    if (ERecordStatusr.FileName!="OPVc") then begin TrHs = false; end;
    if (StringToLongInt(ERecordStatusr.CustSerNr)!=OPNr) then begin TrHs = false; end;
    if (ERecordStatusr.Status!=7) then begin TrHs = false; end;
    if (TrHs) then begin
      res = res + ISAccess_GetUserWeight(ISAccessRec,ERecordStatusr.CustID);
      if (nonblank(SignedBy)) then begin
        SignedBy = SignedBy & ",";
      end;
      SignedBy = SignedBy & ERecordStatusr.CustID;
    end;
  end;
  
  GetOPSignedWeight = res;
  return;  
end;

global
function Boolean UserHasSignedOP(LongInt OPNr,string UserCode)
begin
  Boolean res;
  record ERecordStatusVc ERecordStatusr;
  Boolean TrHs;
  
  ERecordStatusr.FileName = "OPVc";
  ERecordStatusr.Status = 7;
  ERecordStatusr.TheirRecipient = "";
  ERecordStatusr.CustSerNr = OPNr;
  TrHs = true;
  while (LoopKey("FileNameStatusTheir",ERecordStatusr,4,TrHs)) begin
    if (ERecordStatusr.FileName!="OPVc") then begin TrHs = false; end;
    if (StringToLongInt(ERecordStatusr.CustSerNr)!=OPNr) then begin TrHs = false; end;
    if (ERecordStatusr.Status!=7) then begin TrHs = false; end;
    if (TrHs) then begin
      if (ERecordStatusr.CustID==UserCode) then begin
        res = true;
        TrHs = false;
      end;
    end;
  end;
  
  UserHasSignedOP = res;
  return;
end;
