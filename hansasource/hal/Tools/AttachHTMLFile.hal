external function integer GetGuestsInJob(record JobVc);
external function LongInt YearsOld(Date);
external function LongInt DateDiff(Date,Date);
remote function integer GetPersonsInJob(Record JobVc);
remote function integer GetRoomsInJob(Record JobVc);
remote procedure GetEvents(Record JobVc,Boolean,var string);
external procedure MulVATIV(string,val,var val,var val,Integer,Integer);
external function Boolean GetPD(var record PDVc);
external procedure AddVATBase(var record SMVc,string,val,val,Integer,Integer,Integer);
external procedure SetupVATBase(var record SMVc,var Integer);
external function string 255 CreateInvoiceNumber(LongInt,string);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function val MulWithRateToBase1(var string,Date,val,roundmode);
external function Integer TypeOfCurncy(var string,var Integer);
external procedure TRExtYc(record TRVc,var string);
external function Integer GetIntYc(Date);

procedure GetWebCharSet(var string wcharset,string defcharset)
BEGIN
  record WebControlBlock WCr;

  BlockLoad(WCr);
  wcharset = WCr.WebCharSet;
  if (blank(wcharset)) then begin
    wcharset = defcharset;
  end;
  if (blank(wcharset)) then begin
    wcharset = "UTF-8";
  end;
  RETURN;
END;

global
procedure ExportHTMLBegin()
BEGIN
  ExportPadString("<html>",6,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportHTMLEnd()
BEGIN
  ExportPadString("</html>",7,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportHEADBegin()
BEGIN
  ExportPadString("<head>",6,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportHEADEnd()
BEGIN
  ExportPadString("</head>",7,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportMETA(string charset)
BEGIN
  string 255 tstr;
  string 255 wcharset;
  
  GetWebCharSet(wcharset,charset);
  tstr = "<meta http-equiv=""content-type"" content=""text/html;charset=" & wcharset & """>";
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTITLE(string title)
BEGIN
  ExportPadString("  <title>",9,"",false);
  ExportPadString(title,BytesInString(title),"",false);
  ExportPadString("</title>",8,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportBODYBegin(Integer marginwidth, Integer leftmargin)
BEGIN
  string 255 tstr;
  
  tstr = "<body marginwidth=""" & marginwidth & """ marginheight=""0"" leftmargin=""" & leftmargin & """ topmargin=""0"">";
  ExportPadString(" ",2," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  
  tstr = "<META http-equiv=Content-Type content='text/html; charset=UTF-8'>";
  ExportPadString(" ",2," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportBODYEnd()
BEGIN
  ExportPadString(" ",2," ",false);
  ExportPadString("</body>",7,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTABLEBegin(Integer spaces,Integer border,string bordercolor,string rules,string cellpadding,string cellspacing,string width)
BEGIN
  string 255 tstr;
  
  tstr = "<table";
  
  if (border>=0) then begin
    tstr = tstr & " border=""" & border & """";
  end;
  if (nonblank(bordercolor)) then begin
    tstr = tstr & " bordercolor=""" & bordercolor &  """";
  end;
  if (nonblank(rules)) then begin
    tstr = tstr & " rules=""" & rules &  """";
  end;
  if (nonblank(cellpadding)) then begin
    tstr = tstr & " cellpadding=""" & cellpadding &  """";
  end;
  if (nonblank(cellspacing)) then begin
    tstr = tstr & " cellspacing=""" & cellspacing &  """";
  end;
  tstr = tstr & " width=""" & width & """>";
  ExportPadString("",spaces," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTABLEEnd(Integer spaces)
BEGIN
  ExportPadString("",spaces," ",false);
  ExportPadString("</table>",8,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTRBegin(Integer spaces)
BEGIN
  ExportPadString("",spaces," ",false);
  ExportPadString("<tr>",4,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTREnd(Integer spaces)
BEGIN
  ExportPadString("",spaces," ",false);
  ExportPadString("</tr>",5,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportDIVBegin(Integer spaces,string align)
BEGIN
  string 255 tstr;
  
  tstr = "<div";
  if (nonblank(align)) then begin
    tstr = tstr & " align=""" & align & """";
  end;
  tstr = tstr & ">";
  ExportPadString("",spaces," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportDIVEnd(Integer spaces)
BEGIN
  ExportPadString("",spaces," ",false);
  ExportPadString("</div>",6,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportDIV2Begin(string class,string id)
begin
  string 255 tstr;
  
  tstr = "<div";
  
  if (nonblank(class)) then begin
    tstr = tstr & " class=""" & class & """";
  end;
  
  if (nonblank(id)) then begin
    tstr = tstr & " id=""" & class & """";
  end;
  
  tstr = tstr & ">";
  ExportPadString(tstr,BytesInString(tstr),"",false);
  
  return;
end;

global
procedure ExportDIV2End()
begin
  ExportPadString("</div>",6,"",false);
  return;
end;

global
procedure ExportTH(Integer spaces,string text)
begin
  string 255 tstr;

  tstr = "<th";
  tstr = tstr & ">";
  if (nonblank(text)) then begin 
    tstr = tstr & text;
  end;
  ExportPadString("",spaces," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString(chr(13),1,"",false);
  return;
end;

global
procedure ExportTD(Integer spaces,string align,string colspan,Boolean strongf,Integer fontsize,Boolean boldf,string text)
BEGIN
  string 255 tstr;
  
  tstr = "<td";
  if (nonblank(align)) then begin 
    tstr = tstr & " align=""" & align & """";
  end;
  if (nonblank(colspan)) then begin 
    tstr = tstr & " colspan=""" & colspan & """";
  end;
  tstr = tstr & ">";
  if (strongf) then begin
    tstr = tstr & "<strong>";
  end;
  if (fontsize>=0) then begin 
    tstr = tstr & "<font face=""Arial"" size=""" & fontsize & """>";
  end;
  if (boldf) then begin
    tstr = tstr & "<b>";
  end;
  if (nonblank(text)) then begin 
    tstr = tstr & text;
  end;
  if (boldf) then begin
    tstr = tstr & "</b>";
  end;
  if (fontsize>=0) then begin 
    tstr = tstr & "</font>";
  end;
  if (strongf) then begin
    tstr = tstr & "</strong>";
  end;
  ExportPadString("",spaces," ",false);
  ExportPadString(tstr,BytesInString(tstr),"",false);
  ExportPadString("</td>",5,"",false);
  ExportPadString(chr(13),1,"",false);
  RETURN;
END;

global
procedure ExportTDTR(string text,boolean ifblankf)
begin
  string 255 tstr;
  
  if (ifblankf or nonblank(text)) then begin
    tstr = "<tr><td>" & text & "</td></tr>";
    ExportPadString(tstr,BytesInString(tstr),"",false);
  end;
  
  return;
end;

global
procedure ExportTDBegin()
begin
  string 255 tstr;
  tstr = "<td>";
  
  ExportPadString(tstr,BytesInString(tstr),"",false);
  
  RETURN;
END;

global
procedure ExportTDEnd()
begin
  string 255 tstr;
  tstr = "</td>";
  
  ExportPadString(tstr,BytesInString(tstr),"",false);
  
  return;
end;

global
updating procedure QTCreateHtmlFile(record QTVc QTr,record MailVc Mailr)
BEGIN
  string 255 fname;
  record CYBlock CompRec;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  row QTVc QTrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  PDr.Code = QTr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = QTr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = QTr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  fname = USetStr(1820) & " " & QTr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11410) & QTr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11410) & ": " & QTr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11420));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11421));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,PDr.pdComment);
  ExportTD(8,"","",false,-1,false,"");
  if (nonblank(QTr.Addr0)) then begin
    ExportTD(8,"right","",false,2,false,QTr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11429));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,QTr.Addr1);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CompRec.Phone);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,QTr.Addr2);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11430));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,QTr.Addr3);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CompRec.Fax);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,QTr.InvAddr3);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,QTr.InvAddr4);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11422));
  ExportTD(8,"","",false,1,false,USetStr(11423));
  ExportTD(8,"right","",false,1,false,USetStr(11424));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,QTr.QTDate);
  ExportTD(8,"","",false,2,false,QTr.ValidUntilDate);
  ExportTD(8,"right","",false,2,false,QTr.CustContact);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11425));
  ExportTD(8,"","",false,1,false,USetStr(11426));
  ExportTD(8,"right","",false,1,false,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,QTr.PlanShip);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11428));
//  ExportTD(8,"","",false,1,false,USetStr(11429));   //msm 02-04-2003
  ExportTD(8,"","",false,1,false,USetStr(9337));
  ExportTD(8,"right","",false,1,false,USetStr(11612));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,QTr.SalesMan);
  ExportTD(8,"","",false,2,false,CompRec.Phone);
  ExportTD(8,"right","",false,2,false,CompRec.Fax);
  ExportTREnd(6);  
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11432));
  ExportTD(8,"right","",false,1,false,USetStr(11433));
  ExportTD(8,"left","10",false,1,false,USetStr(11434));
  ExportTD(8,"right","",false,1,false,USetStr(11435));
  ExportTD(8,"right","",false,1,false,USetStr(11436));
  ExportTD(8,"right","",false,1,false,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(QTr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(QTr,i,QTrw);
    if (QTrw.stp==10) then begin 
      goto LQTHIDDENLine;
    end;    
    ExportTRBegin(6);
    ExportTD(8,"left","",false,2,false,QTrw.ArtCode);
    ExportTD(8,"right","",false,2,false,QTrw.Quant);
    ExportTD(8,"left","10",false,2,false,QTrw.Spec);
    ExportTD(8,"right","",false,2,false,QTrw.Price);
    ExportTD(8,"right","",false,2,false,QTrw.vRebate);
    ExportTD(8,"right","",false,2,false,QTrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,QTrw.VATCode,QTrw.Sum,blankval,vatcnt,QTr.InclVAT,QTr.NoTAXonVAT);
  end;
LQTHIDDENLine:;  
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,true,QTr.CurncyCode);
  ExportTD(8,"right","",false,2,true,QTr.Sum1);
  ExportTD(8,"right","",false,2,true,QTr.Sum3);
  ExportTD(8,"right","",false,2,true,QTr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,QTr.InclVAT,QTr.NoTAXonVAT);
      ExportTD(8,"right","",false,2,false,t);
      if (QTr.InclVAT!=0) then begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      end else begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      end;
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  RETURN;
END;

global
updating procedure OYCreateHtmlFile(record OYVc OYr,record MailVc Mailr)
begin
  string 255 fname;
  record CYBlock CompRec;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  row OYVc OYrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  PDr.Code = OYr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = OYr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = OYr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  fname = USetStr(1820) & " " & OYr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11410) & OYr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11410) & ": " & OYr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11420));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11421));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,PDr.pdComment);
  ExportTD(8,"","",false,-1,false,"");
  if (nonblank(OYr.Addr0)) then begin
    ExportTD(8,"right","",false,2,false,OYr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11429));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,OYr.Addr1);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CompRec.Phone);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,OYr.Addr2);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11430));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,OYr.Addr3);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CompRec.Fax);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,OYr.InvAddr3);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,OYr.InvAddr4);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11422));
  ExportTD(8,"","",false,1,false,USetStr(11423));
  ExportTD(8,"right","",false,1,false,USetStr(11424));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,OYr.OYDate);
  ExportTD(8,"","",false,2,false,OYr.ValidUntilDate);
  ExportTD(8,"right","",false,2,false,OYr.CustContact);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11425));
  ExportTD(8,"","",false,1,false,USetStr(11426));
  ExportTD(8,"right","",false,1,false,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,OYr.PlanShip);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11428));
//  ExportTD(8,"","",false,1,false,USetStr(11429));   //msm 02-04-2003
  ExportTD(8,"","",false,1,false,USetStr(9337));
  ExportTD(8,"right","",false,1,false,USetStr(11612));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,OYr.SalesMan);
  ExportTD(8,"","",false,2,false,CompRec.Phone);
  ExportTD(8,"right","",false,2,false,CompRec.Fax);
  ExportTREnd(6);  
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11432));
  ExportTD(8,"right","",false,1,false,USetStr(11433));
  ExportTD(8,"left","10",false,1,false,USetStr(11434));
  ExportTD(8,"right","",false,1,false,USetStr(11435));
  ExportTD(8,"right","",false,1,false,USetStr(11436));
  ExportTD(8,"right","",false,1,false,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(OYr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(OYr,i,OYrw);
    if (OYrw.stp==10) then begin 
      goto LOYHIDDENLine;
    end;    
    ExportTRBegin(6);
    ExportTD(8,"left","",false,2,false,OYrw.ArtCode);
    ExportTD(8,"right","",false,2,false,OYrw.Quant);
    ExportTD(8,"left","10",false,2,false,OYrw.Spec);
    ExportTD(8,"right","",false,2,false,OYrw.Price);
    ExportTD(8,"right","",false,2,false,OYrw.vRebate);
    ExportTD(8,"right","",false,2,false,OYrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,OYrw.VATCode,OYrw.Sum,blankval,vatcnt,OYr.InclVAT,OYr.NoTAXonVAT);
  end;
LOYHIDDENLine:;  
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,true,OYr.CurncyCode);
  ExportTD(8,"right","",false,2,true,OYr.Sum1);
  ExportTD(8,"right","",false,2,true,OYr.Sum3);
  ExportTD(8,"right","",false,2,true,OYr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,OYr.InclVAT,OYr.NoTAXonVAT);
      ExportTD(8,"right","",false,2,false,t);
      if (OYr.InclVAT!=0) then begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      end else begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      end;
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  return;
end;

global
updating procedure RentQTCreateHtmlFile(record RentQTVc RentQTr,record MailVc Mailr)
BEGIN
  string 255 fname;
  record CYBlock CompRec;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  row RentQTVc RentQTrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  PDr.Code = RentQTr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = RentQTr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = RentQTr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  fname = USetStr(2061) & " " & RentQTr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11410) & RentQTr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11410) & ": " & RentQTr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11420));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11421));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,PDr.pdComment);
  ExportTD(8,"","",false,-1,false,"");
  if (nonblank(RentQTr.Addr0)) then begin
    ExportTD(8,"right","",false,2,false,RentQTr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTREnd(6);
  if (nonblank(RentQTr.Addr1)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,RentQTr.Addr1);  
    ExportTREnd(6);
  end;
  if (nonblank(RentQTr.Addr2)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,RentQTr.Addr2);  
    ExportTREnd(6);
  end;
  if (nonblank(RentQTr.Addr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,RentQTr.Addr3);  
    ExportTREnd(6);
  end;
  if (nonblank(RentQTr.InvAddr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,RentQTr.InvAddr3);
    ExportTREnd(6);
  end;
  if (nonblank(RentQTr.InvAddr4)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,RentQTr.InvAddr4);
    ExportTREnd(6);
  end;
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11422));
  ExportTD(8,"","",false,1,false,USetStr(11423));
  ExportTD(8,"right","",false,1,false,USetStr(11424));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,RentQTr.TransDate);
  ExportTD(8,"","",false,2,false,RentQTr.ValidUntilDate);
  ExportTD(8,"right","",false,2,false,RentQTr.ClientContact);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11425));
  ExportTD(8,"","",false,1,false,USetStr(11426));
  ExportTD(8,"right","",false,1,false,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,RentQTr.startDate);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11428));
//  ExportTD(8,"","",false,1,false,USetStr(11429));   //msm 02-04-2003
  ExportTD(8,"","",false,1,false,USetStr(9337));
  ExportTD(8,"right","",false,1,false,USetStr(11430));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,RentQTr.SalesMan);
  ExportTD(8,"","",false,2,false,CompRec.Phone);
  ExportTD(8,"right","",false,2,false,CompRec.Fax);
  ExportTREnd(6);  
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11432));
  ExportTD(8,"right","",false,1,false,USetStr(11433));
  ExportTD(8,"left","10",false,1,false,USetStr(11434));
  ExportTD(8,"right","",false,1,false,USetStr(11435));
  ExportTD(8,"right","",false,1,false,USetStr(11436));
  ExportTD(8,"right","",false,1,false,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(RentQTr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(RentQTr,i,RentQTrw);
    ExportTRBegin(6);
    ExportTD(8,"left","",false,2,false,RentQTrw.ArtCode);
    ExportTD(8,"right","",false,2,false,RentQTrw.Quant);
    ExportTD(8,"left","10",false,2,false,RentQTrw.Spec);
    ExportTD(8,"right","",false,2,false,RentQTrw.Price);
    ExportTD(8,"right","",false,2,false,RentQTrw.vRebate);
    ExportTD(8,"right","",false,2,false,RentQTrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,RentQTrw.VATCode,RentQTrw.Sum,blankval,vatcnt,RentQTr.InclVAT,0);
  end;
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,true,RentQTr.CurncyCode);
  ExportTD(8,"right","",false,2,true,RentQTr.Sum1);
  ExportTD(8,"right","",false,2,true,RentQTr.Sum3);
  ExportTD(8,"right","",false,2,true,RentQTr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,RentQTr.InclVAT,0);
      ExportTD(8,"right","",false,2,false,t);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  RETURN;
END;

global
updating procedure ORCreateHtmlFile(record ORVc ORr,record MailVc Mailr)
BEGIN
  string 255 fname;
  record CYBlock CompRec;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  row ORVc ORrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  PDr.Code = ORr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = ORr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = ORr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  fname = USetStr(1816) & " " & ORr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11411) & ORr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11411) & ": " & ORr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11420));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11421));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,PDr.pdComment);
  ExportTD(8,"","",false,-1,false,"");
  if (nonblank(ORr.Addr0)) then begin
    ExportTD(8,"right","",false,2,false,ORr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTREnd(6);
  if (nonblank(ORr.Addr1)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,ORr.Addr1);  
    ExportTREnd(6);
  end;
  if (nonblank(ORr.Addr2)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,ORr.Addr2);  
    ExportTREnd(6);
  end;
  if (nonblank(ORr.Addr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,ORr.Addr3);  
    ExportTREnd(6);
  end;
  if (nonblank(ORr.InvAddr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,ORr.InvAddr3);
    ExportTREnd(6);
  end;
  if (nonblank(ORr.InvAddr4)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,ORr.InvAddr4);
    ExportTREnd(6);
  end;
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11422));
  ExportTD(8,"","",false,1,false,USetStr(11423));
  ExportTD(8,"right","",false,1,false,USetStr(11424));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,ORr.OrdDate);
  ExportTD(8,"","",false,2,false,"");
  ExportTD(8,"right","",false,2,false,ORr.CustContact);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11425));
  ExportTD(8,"","",false,1,false,USetStr(11426));
  ExportTD(8,"right","",false,1,false,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,ORr.PlanShip);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11428));
  ExportTD(8,"","",false,1,false,USetStr(11429));
  ExportTD(8,"right","",false,1,false,USetStr(11430));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,ORr.SalesMan);
  ExportTD(8,"","",false,2,false,CompRec.Phone);
  ExportTD(8,"right","",false,2,false,CompRec.Fax);
  ExportTREnd(6);  
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11432));
  ExportTD(8,"right","",false,1,false,USetStr(11433));
  ExportTD(8,"left","10",false,1,false,USetStr(11434));
  ExportTD(8,"right","",false,1,false,USetStr(11435));
  ExportTD(8,"right","",false,1,false,USetStr(11436));
  ExportTD(8,"right","",false,1,false,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(ORr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORr,i,ORrw);
    if (ORrw.stp==10) then begin 
      goto LORHIDDENLine;
    end;        
    ExportTRBegin(6);
    ExportTD(8,"left","",false,2,false,ORrw.ArtCode);
    ExportTD(8,"right","",false,2,false,ORrw.Quant);
    ExportTD(8,"left","10",false,2,false,ORrw.Spec);
    ExportTD(8,"right","",false,2,false,ORrw.Price);
    ExportTD(8,"right","",false,2,false,ORrw.vRebate);
    ExportTD(8,"right","",false,2,false,ORrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,ORrw.VATCode,ORrw.Sum,blankval,vatcnt,ORr.InclVAT,ORr.NoTAXonVAT);
  end;
LORHIDDENLine:;  
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,true,ORr.CurncyCode);
  ExportTD(8,"right","",false,2,true,ORr.Sum1);
  ExportTD(8,"right","",false,2,true,ORr.Sum3);
  ExportTD(8,"right","",false,2,true,ORr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,ORr.InclVAT,ORr.NoTAXonVAT);
      if (ORr.InclVAT==0) then begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
        ExportTD(8,"right","",false,2,false,t);
        ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      end else begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal - t);
        ExportTD(8,"right","",false,2,false,t);
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      end;
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  RETURN;
END;

global
updating procedure POCreateHtmlFile(record POVc POr,record MailVc Mailr)
BEGIN
  string 255 fname;
  record CYBlock CompRec;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  row POVc POrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  string 255 tstr;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  PDr.Code = POr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = POr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = POr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  fname = USetStr(2062) & " " & POr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11413) & POr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11413) & ": " & POr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11420));
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11421));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,PDr.pdComment);
  ExportTD(8,"","",false,-1,false,"");
  if (nonblank(POr.Addr0)) then begin
    ExportTD(8,"right","",false,2,false,POr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTREnd(6);
  if (nonblank(POr.Addr1)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,POr.Addr1);  
    ExportTREnd(6);
  end;
  if (nonblank(POr.Addr2)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,POr.Addr2);  
    ExportTREnd(6);
  end;
  if (nonblank(POr.Addr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,POr.Addr3);  
    ExportTREnd(6);
  end;
  if (nonblank(POr.InvAddr3)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,POr.InvAddr3);
    ExportTREnd(6);
  end;
  if (nonblank(POr.InvAddr4)) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"","",false,-1,false,"");
    ExportTD(8,"right","",false,2,false,POr.InvAddr4);
    ExportTREnd(6);
  end;
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11422));
  ExportTD(8,"left","",false,1,false,USetStr(11428));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,POr.TransDate);
  ExportTD(8,"left","",false,2,false,POr.SalesMan);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11425));
  ExportTD(8,"","",false,1,false,USetStr(11426));
  ExportTD(8,"right","",false,1,false,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,POr.PlanShip);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11432));
  ExportTD(8,"right","",false,1,false,USetStr(11433));
  ExportTD(8,"left","10",false,1,false,USetStr(11434));
  ExportTD(8,"right","",false,1,false,USetStr(11435));
  ExportTD(8,"right","",false,1,false,USetStr(11436));
  ExportTD(8,"right","",false,1,false,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(POr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(POr,i,POrw);
    ExportTRBegin(6);
    tstr = POrw.VEArtCode;
    if (blank(tstr)) then begin
      tstr = POrw.ArtCode;
    end;
    ExportTD(8,"left","",false,2,false,tstr);
    ExportTD(8,"right","",false,2,false,POrw.Quant);
    ExportTD(8,"left","10",false,2,false,POrw.Spec);
    ExportTD(8,"right","",false,2,false,POrw.Price);
    ExportTD(8,"right","",false,2,false,POrw.vRebate);
    ExportTD(8,"right","",false,2,false,POrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,POrw.VATCode,POrw.Sum,blankval,vatcnt,POr.InclVAT,POr.NoTAXonVAT);
  end;
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,true,POr.CurncyCode);
  ExportTD(8,"right","",false,2,true,POr.Sum1);
  ExportTD(8,"right","",false,2,true,POr.Sum3);
  ExportTD(8,"right","",false,2,true,POr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,POr.InclVAT,POr.NoTAXonVAT);
      ExportTD(8,"right","",false,2,false,t);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  RETURN;
END;

global
updating procedure JobCreateHtmlFile(record JobVc Jobr,record MailVc Mailr)
BEGIN
  string 255 fname,tstr,OutFlight,InFlight,Usages,HabType;
  record CYBlock CompRec;
  record ResTypeVc ResTyper;
  record CUVc CUr;
  record ResUsageVc ResUsager;
  record CUVc Profiler;
  row JobVc Jobrw;
  Integer i,rwcnt,vatcnt,nrnights,nrpaxs,nrhab;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CompRec);
  ResTyper.Code = Jobr.Type;
  if (ReadFirstMain(ResTyper,1,true)) then begin
    HabType = ResTyper.Comment;
  end;
  CUr.Code = Jobr.Source;
  if (ReadFirstMain(CUr,1,true)) then begin
  end;  
  ResUsager.Code = Jobr.ResUsage;
  if (ReadFirstMain(ResUsager,1,true)) then begin
    Usages = ResUsager.Comment;
  end;
  
  nrnights = Datediff(Jobr.EndDate,Jobr.TransDate);
  nrpaxs   = GetPersonsInJob(Jobr);
  nrhab    = GetRoomsInJob(Jobr); 
  GetEvents(Jobr,true,OutFlight);
  GetEvents(Jobr,true,InFlight);
  if blank(OutFlight) then begin OutFlight = USetStr(20720); end;
  if blank(InFlight) then begin InFlight = USetStr(20720); end;

  fname = USetStr(11414) & Jobr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(11414) & Jobr.SerNr); 
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(11414) & ": " & Jobr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,1,true,USetStr(20721) & " ");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,Jobr.SourceName);


  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,CUr.InvAddr0);  
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,USetStr(20724) & " " & Jobr.CustContact & ", ");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,CUr.InvAddr1);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,CUr.InvAddr2 & " " & CUr.InvAddr3);  
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,USetStr(20722) & " ");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,USetStr(20723) & ":" & CUr.Phone);
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,USetStr(20725) & ": " & Jobr.CUName");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",false,2,false,"");
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,USetStr(20726) & ": " & nrpaxs);
  ExportTD(8,"","",false,-1,false,USetStr(20728) & ": " & Inflight);
  ExportTD(8,"right","",false,2,false,"");
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,USetStr(20727) & ": " & nrnights);
  ExportTD(8,"","",false,-1,false,USetStr(20729) & ": " & Outflight);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,USetStr(9923) & ": " & Jobr.TransDate);
  ExportTD(8,"left","",false,2,false,USetStr(20730) & ": " & Jobr.PriceList);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,USetStr(9922) & ": " & Jobr.EndDate);
  ExportTD(8,"left","",false,2,false,USetStr(20731) & ": " & GetGuestsInJob(Jobr));
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,USetStr(20732) & ": " & Usages);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,"");
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,USetStr(20733) & ": " & nrhab);
  ExportTD(8,"","",false,-1,false,USetStr(20734) & ": " & HabType);
  ExportTD(8,"right","",false,2,false,"");
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,"");
  ExportTD(8,"","",false,2,false,"");
  ExportTD(8,"right","",false,2,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTABLEEnd(4);
//  ExportTABLEBegin(4,0,"","","2","2","100%");
//  ExportTRBegin(6);
//  ExportTD(8,"center","15",false,1,true,USetStr(11431));
//  ExportTREnd(6);  
//  ExportTABLEEnd(4);
  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,USetStr(20735));
  ExportTD(8,"right","",false,2,false,USetStr(20736));
  ExportTD(8,"right","10",false,2,false,USetStr(20737));
  ExportTD(8,"right","",false,2,false,USetStr(20738));
  ExportTD(8,"right","",false,2,false,USetStr(20739)); 
  ExportTD(8,"right","",false,2,false,USetStr(20740));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(Jobr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Jobr,i,Jobrw);
    Profiler.Code = Jobrw.GuestCode;
    if readfirstmain(Profiler,1,true) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,1,false,Jobrw.CUName);
      switch (Profiler.Gender) begin
        case 0: tstr = USetStr(20745);
        case 1: tstr = USetStr(20746);
      end;        
      ExportTD(8,"right","",false,1,false,tstr);
      ExportTD(8,"right","10",false,1,false,Profiler.PassportNr);
      ExportTD(8,"right","",false,1,false,Profiler.Nationality);
      ExportTD(8,"right","",false,1,false,YearsOld(Profiler.BirthDate));
      switch (Profiler.MarStatus) begin
        case 0: tstr = USetStr(20741);
        case 1: tstr = USetStr(20742);
        case 2: tstr = USetStr(20743);
        case 3: tstr = USetStr(20744);
      end;
      ExportTD(8,"right","",false,1,false,tstr);
      ExportTREnd(6);
    end;
  end;
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  ExportDIVBegin(4,"right");

  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"right","",false,1,false,"Precio");
//  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,"Total");
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"right","",false,2,true,Jobr.PLPrice);
//  ExportTD(8,"right","",false,2,true,POr.Sum3);
  ExportTD(8,"right","",false,2,true,Jobr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTREnd(6);    
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,USetStr(11438));
  ExportTD(8,"right","",false,1,false,USetStr(11439));
  ExportTD(8,"right","",false,1,false,USetStr(11440));
  ExportTD(8,"right","",false,1,false,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      ExportTD(8,"right","",false,2,false,t);
      ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      ExportTREnd(6);      
    end;
  end;
  ExportTABLEEnd(4);
  ExportDIVEnd(4);
  
  ExportTRBegin(6);
  ExportTD(8,"left","",true,3,true,CompRec.CompName);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,3,true,USetStr(20747));
  ExportTREnd(6);  
  
  ExportBODYEnd;
  ExportHTMLEnd;
  CloseFile;
  if (RECORDLINKFILE(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  RETURN;
END;

global
updating procedure IVCreateHtmlFile(record IVVc IVr,record MailVc Mailr,Boolean onserverf)
begin
  string 255 fname;
  record CYBlock CYb;
  record PDVc PDr;
  record DMVc DMr;
  record ShipDealVc ShipDealr;
  record UserVc Userr;
  record BankVc Bankr;
  row IVVc IVrw;
  Integer i,rwcnt,vatcnt;
  record SMVc VATr;
  row SMVc VATrw;
  val t,t1;
  string 255 tstr;
  
  if (onserverf) then begin
    SetFileOnServer(true);
  end;
  RecordNew(VATr);
  SetupVATBase(VATr,vatcnt);            
  BlockLoad(CYb);
  PDr.Code = IVr.PayDeal;
  if (GetPD(PDr)) then begin
  end;  
  ShipDealr.Code = IVr.ShipDeal;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
  end;
  DMr.Code = IVr.ShipMode;
  if (ReadFirstMain(DMr,1,true)) then begin
  end;
  Userr.Code = IVr.SalesMan;
  if (ReadFirstMain(Userr,1,true)) then begin
  end;
  Bankr.Code = IVr.BankCode;
  if (ReadFirstMain(Bankr,1,true)==false) then begin
    Bankr.Code = CYb.BankCode;
    if ( ReadFirstMain(Bankr,1,true)) then begin
    end;
  end;

  fname = USetStr(1803) & " " & IVr.SerNr;
  fname = fname & ".html";
  CreateFile(fname);
  ExportHTMLBegin;
  ExportHEADBegin;
  ExportMETA("UTF-8");  
  ExportTITLE(USetStr(1803) & IVr.SerNr);
  ExportHEADEnd;
  ExportBODYBegin(50,50);
  
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,5,true,CYb.CompName);
//  ExportTD(8,"","",false,-1,false,"<img src=""logo.gif"" WIDTH=60 HEIGHT=30>");//why not wrking ? 
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,5,true,USetStr(11412));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"right","",true,4,true,IVr.SerNr);
  ExportTREnd(6);
  ExportTABLEEnd(4);
  
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,1,true,USetStr(11421));
  ExportTD(8,"left","",true,1,true,USetStr(11422));
  ExportTD(8,"right","",true,1,true,USetStr(11459));
  ExportTREnd(6);
  ExportTRBegin(6);
  if (nonblank(IVr.Addr0)) then begin
    ExportTD(8,"left","",false,2,false,IVr.Addr0);  
  end else begin
    ExportTD(8,"","",false,-1,false,"");
  end;
  ExportTD(8,"left","",false,2,false,IVr.InvDate);
  ExportTD(8,"right","",false,2,false,IVr.CustCode);  
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.Addr1);  
  ExportTD(8,"left","",true,1,true,USetStr(11420));
  ExportTD(8,"right","",true,1,true,USetStr(11424));
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.Addr2);  
  ExportTD(8,"left","",false,2,false,PDr.pdComment);  
  ExportTD(8,"right","",false,2,false,IVr.ClientContact);  
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.Addr3);  
  ExportTD(8,"left","",true,1,true,USetStr(11461));
  ExportTD(8,"right","",true,1,true,USetStr(11462));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.InvAddr3);
  ExportTD(8,"left","",false,2,false,IVr.PayDate);  
  ExportTD(8,"right","",false,2,false,IVr.OurContact);  
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.InvAddr4);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);

  ExportTRBegin(6);
  ExportTD(8,"left","",true,1,true,USetStr(11460));
  ExportTD(8,"","",true,1,true,USetStr(11426));
  ExportTD(8,"right","",true,1,true,USetStr(11427));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,IVr.VATNr);
  ExportTD(8,"","",false,2,false,ShipDealr.Comment);
  ExportTD(8,"right","",false,2,false,DMr.Comment);
  ExportTREnd(6);
  
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",true,1,true,USetStr(11428));
//  ExportTD(8,"","",false,1,false,USetStr(11429));
//  ExportTD(8,"right","",true,1,true,USetStr(11430));
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,2,false,Userr.Name);
//  ExportTD(8,"","",false,2,false,CYb.Phone);
//  ExportTD(8,"right","",false,2,false,CYb.Fax);
  ExportTREnd(6);  
  ExportTABLEEnd(4);

  ExportTABLEBegin(4,0,"","","5","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"","5",false,-1,false,"");
  ExportTD(8,"","5",false,-1,false,"");
  ExportTD(8,"","5",false,-1,false,"");
  ExportTREnd(6);
  ExportTABLEEnd(4);

  ExportTABLEBegin(4,1,"black","none","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,1,true,USetStr(11432));
  ExportTD(8,"right","",true,1,true,USetStr(11433));
  ExportTD(8,"left","10",true,1,true,USetStr(11434));
  ExportTD(8,"right","",true,1,true,USetStr(11435));
  ExportTD(8,"right","",true,1,true,USetStr(11436));
  ExportTD(8,"right","",true,1,true,USetStr(11437));
  ExportTREnd(6);  
  rwcnt = MatRowCnt(IVr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(IVr,i,IVrw);
    if (IVrw.stp==10) then begin 
      goto LIVHIDDENLine;
    end;        
    ExportTRBegin(6);
    ExportTD(8,"left","",false,2,false,IVrw.ArtCode);
    ExportTD(8,"right","",false,2,false,IVrw.Quant);
    ExportTD(8,"left","10",false,2,false,IVrw.Spec);
    ExportTD(8,"right","",false,2,false,IVrw.Price);
    ExportTD(8,"right","",false,2,false,IVrw.vRebate);
    ExportTD(8,"right","",false,2,false,IVrw.Sum);
    ExportTREnd(6);  
    AddVATBase(VATr,IVrw.VATCode,IVrw.Sum,blankval,vatcnt,IVr.InclVAT,IVr.NoTAXonVAT);
  end;
LIVHIDDENLine:;  
  ExportTABLEEnd(4);
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportDIVBegin(4,"right");
  ExportTABLEBegin(4,0,"","","0","0","30%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",true,1,true,USetStr(11458));
  ExportTD(8,"right","",true,2,true,IVr.CurncyCode);
  ExportTREnd(6);  
  if (IVr.InclVAT==0) then begin
    ExportTRBegin(6);
    ExportTD(8,"","",false,1,false,"");
    ExportTD(8,"","",false,1,false,"");
    ExportTD(8,"right","",true,1,true,USetStr(11456) & ":");
    ExportTD(8,"right","",true,2,true,IVr.Sum1);
    ExportTREnd(6);  
  end;
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",true,1,true,USetStr(11440) & ":");
  ExportTD(8,"right","",true,2,true,IVr.Sum3);
  ExportTREnd(6);  
  ExportTRBegin(6);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",true,1,true,USetStr(11457) & ":");
  ExportTD(8,"right","",true,2,true,IVr.Sum4);
  ExportTREnd(6);  
  ExportTABLEEnd(4);  
  
  ExportTABLEBegin(4,0,"","","2","2","100%");
  ExportTRBegin(6);
  ExportTD(8,"","",false,-1,false,"");
  ExportTREnd(6);  
  ExportTABLEEnd(4);    
  
  ExportTABLEBegin(4,1,"black","none","2","2","30%");
  ExportTRBegin(6);
  ExportTD(8,"left","",true,1,true,USetStr(11438));//here
  ExportTD(8,"right","",true,1,true,USetStr(11439));
  ExportTD(8,"right","",true,1,true,USetStr(11440));
  ExportTD(8,"right","",true,1,true,USetStr(11441));  
  ExportTREnd(6); 
  for (i=0;i<vatcnt;i=i+1) begin
    MatRowGet(VATr,i,VATrw);
    if (VATrw.DebVal!=0) then begin
      ExportTRBegin(6);
      ExportTD(8,"left","",false,2,false,VATrw.VATCode);
      MulVATIV(VATrw.VATCode,VATrw.DebVal,t,t1,IVr.InclVAT,IVr.NoTAXonVAT);
      if (IVr.InclVAT==0) then begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
        ExportTD(8,"right","",false,2,false,t);
        ExportTD(8,"right","",false,2,false,VATrw.DebVal + t);
      end else begin
        ExportTD(8,"right","",false,2,false,VATrw.DebVal - t);
        ExportTD(8,"right","",false,2,false,t);
        ExportTD(8,"right","",false,2,false,VATrw.DebVal);
      end;
      ExportTREnd(6);      
    end;
  end;       
  ExportTABLEEnd(4);
  ExportDIVEnd(4);


  ExportTABLEBegin(4,0,"","","3","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"","5",false,-1,false,"");
  ExportTD(8,"","5",false,-1,false,"");
  ExportTD(8,"","5",false,-1,false,"");
  ExportTREnd(6);
  ExportTABLEEnd(4);

  ExportTABLEBegin(4,1,"black","none","0","0","100%");
  ExportTRBegin(6);
  ExportTREnd(6);    
  ExportTABLEEnd(4);
  ExportTABLEBegin(4,0,"","","0","0","100%");
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CYb.CompName);
  ExportTD(8,"","",false,1,false,USetStr(11443) & ": " & CYb.Phone);
  ExportTD(8,"","",false,1,false,USetStr(11463) & ": " & CYb.OrgNr);
  tstr = Bankr.Nr2;
  if (blank(tstr)) then begin tstr = CYb.Bank1; end;
  if (blank(tstr)) then begin tstr = CYb.Bank2; end;
  ExportTD(8,"right","",false,1,false,USetStr(11464) & ": " & tstr);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CYb.Addr0 & ", " & CYb.Addr1);
  ExportTD(8,"","",false,1,false,USetStr(11444) & ": " & CYb.Fax);
  ExportTD(8,"","",false,1,false,USetStr(11465) & ": " & CYb.VATNr);
  tstr = "";
  if (nonblank(CYb.Bank1)) then begin tstr = CYb.Bank2; end;
  ExportTD(8,"right","",false,1,false,tstr);
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CYb.Addr2);
  ExportTD(8,"","",false,1,false,CYb.wwwAddr);
  ExportTD(8,"","",false,1,false,CYb.emailAddr);
  ExportTD(8,"right","",false,1,false,"");
  ExportTREnd(6);
  ExportTRBegin(6);
  ExportTD(8,"left","",false,1,false,CYb.Addr3);
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"","",false,1,false,"");
  ExportTD(8,"right","",false,1,false,Bankr.Name);
  ExportTREnd(6);

  ExportTABLEEnd(4);
  
  ExportBODYEnd;
  ExportHTMLEnd;  
  CloseFile;
  if (RecordLinkFile(fname,0,Mailr,CurrentCompany)) then begin end;
  Delete_File(fname);
  if (onserverf) then begin
    SetFileOnServer(false);
  end;  
  return;
end;