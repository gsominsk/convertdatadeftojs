external function Boolean ReadTAcc(string,string,Boolean,var record TAccVc);
external function LongInt GetCurUserLastNr(string);

global
procedure CreateNewTTR(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,var record TTRVc TTRr)
BEGIN
  RecordNew(TTRr);
  TTRr.TAccGroup = Group;
  TTRr.TransDate = TRr.TransDate;
  TTRr.AccNumber = TRrw.TAccNumber;
  TTRr.Comment = TRrw.Comment;
  TTRr.B1Val = TRrw.DebVal - TRrw.CredVal;
  TTRr.B2Val = TRrw.DebVal2 - TRrw.CredVal2;
  TTRr.TRNumber = TRr.Number;
  TTRr.TRIntYc = TRr.IntYc;
  TTRr.TRRow = rownr;
  RETURN;
END;

global
updating procedure StoreTTR(var record TTRVc TTRr)
BEGIN
  LongInt newnr;

  newnr = GetCurUserLastNr("TTRVc");    
  TTRr.SerNr = NextSerNr("TTRVc",TTRr.TransDate,newnr,false,"");
  if (TTRr.SerNr>0) then begin
    if (MatRowCnt(TTRr)>0) then begin
      if (RecordStore(TTRr,false)) then begin end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_FromAT2UnitVc(string code,string field,Integer rownr)
BEGIN
  string 255 res;
  record AT2UnitVc AT2Unitr;
  
  AT2Unitr.InventoryNr = code;
  if (ReadFirstMain(AT2Unitr,1,true)) then begin
    res = GetFieldValueByName(AT2Unitr,field,rownr);
  end; 
  GetFieldValueByName_FromAT2UnitVc = res;
  RETURN;
END;

function string 255 GetFieldValueByName_FromINVc(string code,string field,Integer rownr)
BEGIN
  string 255 res;
  record INVc INr;
  
  INr.Code = code;
  if (ReadFirstMain(INr,1,true)) then begin
    res = GetFieldValueByName(INr,field,rownr);
  end; 
  GetFieldValueByName_FromINVc = res;
  RETURN;
END;

function string 255 GetFieldValueByName_VIVc(record VIVc VIr,Integer vi,string FileName,string field)
BEGIN
  string 255 res;
  row VIVc VIrw;
  
  if (vi>=0) then begin
    MatRowGet(VIr,vi,VIrw);
  end;
  switch (FileName) begin
    case "INVc":  
      if (nonblank(VIrw.Item)) then begin
        res = GetFieldValueByName_FromINVc(VIrw.Item,field,-1);
      end;
  end;
  GetFieldValueByName_VIVc = res;
  RETURN;
END;
  
updating procedure AddExtraInforToTTR_VIVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record VIVc VIr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer vi,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "VIVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(VIr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "VIVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_VIVc(VIr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(VIr);
    for (vi=0;vi<vrwcnt;vi=vi+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "VIVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(VIr,TTRMapr.Field,vi);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "VIVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_VIVc(VIr,vi,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_VIVc(record TRVc TRr,record VIVc VIr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromVI!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_VIVc(TRr,TRrw,i,TAccr.Group,VIr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_TRVc(string TFromFileName,string TFromCode,string FileName,string field)
BEGIN
  string 255 res;
  
  if (TFromFileName==FileName) then begin
    switch (FileName) begin
      case "AT2UnitVc":  
        if (nonblank(TFromCode)) then begin
          res = GetFieldValueByName_FromAT2UnitVc(TFromCode,field,-1);
        end;
      end;
  end;
  GetFieldValueByName_TRVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_TRVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer ri,rrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "TRVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(TRr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "TRVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_TRVc(TRrw.TFromFileName,TRrw.TFromCode,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    rrwcnt = MatRowCnt(TRr);
    for (ri=0;ri<rrwcnt;ri=ri+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "TRVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(TRr,TTRMapr.Field,ri);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "TRVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_TRVc(TRrw.TFromFileName,TRrw.TFromCode,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_TRVc(var record TRVc TRr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromTR!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_TRVc(TRr,TRrw,i,TAccr.Group);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_ExpVc(record ExpVc Expr,Integer exp,string FileName,string field)
BEGIN
  string 255 res;
  row ExpVc Exprw;
  
  if (exp>=0) then begin
    MatRowGet(Expr,exp,Exprw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_ExpVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_ExpVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record ExpVc Expr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer exp,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "ExpVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(Expr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "ExpVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_ExpVc(Expr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(Expr);
    for (exp=0;exp<vrwcnt;exp=exp+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "ExpVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(Expr,TTRMapr.Field,exp);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "ExpVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_ExpVc(Expr,exp,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_ExpVc(record TRVc TRr,record ExpVc Expr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromExp!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_ExpVc(TRr,TRrw,i,TAccr.Group,Expr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_IVVc(record IVVc IVr,Integer iv,string FileName,string field)
BEGIN
  string 255 res;
  row IVVc IVrw;
  
  if (iv>=0) then begin
    MatRowGet(IVr,iv,IVrw);
  end;
  switch (FileName) begin
    case "INVc":  
      if (nonblank(IVrw.ArtCode)) then begin
        res = GetFieldValueByName_FromINVc(IVrw.ArtCode,field,-1);
      end;
  end;
  GetFieldValueByName_IVVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_IVVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record IVVc IVr,record AccBlock ARAccb)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer iv,ivrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  
  row IVVc IVrw;
  string 255 objstr;

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "IVVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(IVr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "IVVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_IVVc(IVr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    ivrwcnt = MatRowCnt(IVr);
    for (iv=0;iv<ivrwcnt;iv=iv+1) begin   
      MatRowGet(IVr,i,IVrw);
      storerowttrf = false;   
      objstr = "";
      if (ARAccb.SkipObjectsOnIVFromHeader==0) then begin
        objstr = IVr.Objects;
      end;
      if (nonblank(IVrw.Objects)) then begin
        if (nonblank(objstr)) then begin
          objstr = objstr & ",";
        end;  
      end;
      objstr = objstr & IVrw.Objects;

      if (TRrw.TAccNumber==IVrw.SalesAcc) and (TRrw.Objects==objstr) then begin
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "IVVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(IVr,TTRMapr.Field,iv);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "IVVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_IVVc(IVr,iv,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_IVVc(record TRVc TRr,record IVVc IVr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;
  record AccBlock ARAccb;

  BlockLoad(TTRb);
  if (TTRb.FromIV!=0) then begin
    BlockLoad(ARAccb);
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_IVVc(TRr,TRrw,i,TAccr.Group,IVr,ARAccb);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_ProdVc(record ProdVc Prodr,Integer prod,string FileName,string field)
BEGIN
  string 255 res;
  row ProdVc Prodrw;
  
  if (prod>=0) then begin
    MatRowGet(Prodr,prod,Prodrw);
  end;
  switch (FileName) begin
    case "INVc":  
      if (nonblank(Prodrw.Item)) then begin
        res = GetFieldValueByName_FromINVc(Prodrw.Item,field,-1);
      end;
  end;
  GetFieldValueByName_ProdVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_ProdVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record ProdVc Prodr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer prod,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "ProdVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(Prodr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "ProdVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_ProdVc(Prodr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(Prodr);
    for (prod=0;prod<vrwcnt;prod=prod+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "ProdVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(Prodr,TTRMapr.Field,prod);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "ProdVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_ProdVc(Prodr,prod,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_ProdVc(record TRVc TRr,record ProdVc Prodr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromProd!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_ProdVc(TRr,TRrw,i,TAccr.Group,Prodr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_AT2WrofVc(record AT2WrofVc AT2Wrofr,Integer i,string FileName,string field)
BEGIN
  string 255 res;
  row AT2WrofVc AT2Wrofrw;
  
  if (i>=0) then begin
    MatRowGet(AT2Wrofr,i,AT2Wrofrw);
  end;
  switch (FileName) begin
    case "AT2UnitVc":  
      if (nonblank(AT2Wrofrw.AT2Code)) then begin
        res = GetFieldValueByName_FromAT2UnitVc(AT2Wrofrw.AT2Code,field,-1);
      end;
  end;
  GetFieldValueByName_AT2WrofVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_AT2WrofVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record AT2WrofVc AT2Wrofr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer wrof,rwcnt;
  row TTRVc TTRrw;
  Integer i,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "AT2WrofVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(AT2Wrofr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "AT2WrofVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_AT2WrofVc(AT2Wrofr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(AT2Wrofr);
    for (wrof=0;wrof<vrwcnt;wrof=wrof+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "AT2WrofVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(AT2Wrofr,TTRMapr.Field,wrof);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "AT2WrofVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_AT2WrofVc(AT2Wrofr,wrof,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_AT2WrofVc(record TRVc TRr,record AT2WrofVc AT2Wrofr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromAT2Wrof!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_AT2WrofVc(TRr,TRrw,i,TAccr.Group,AT2Wrofr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_OPVc(record OPVc OPr,Integer op,string FileName,string field)
BEGIN
  string 255 res;
  row OPVc OPrw;
  
  if (op>=0) then begin
    MatRowGet(OPr,op,OPrw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_OPVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_OPVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record OPVc OPr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer op,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "OPVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(OPr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "OPVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_OPVc(OPr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(OPr);
    for (op=0;op<vrwcnt;op=op+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "OPVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(OPr,TTRMapr.Field,op);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "OPVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_OPVc(OPr,op,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_OPVc(record TRVc TRr,record OPVc OPr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromOP!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_OPVc(TRr,TRrw,i,TAccr.Group,OPr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_IPVc(record IPVc IPr,Integer ip,string FileName,string field)
BEGIN
  string 255 res;
  row IPVc IPrw;
  
  if (ip>=0) then begin
    MatRowGet(IPr,ip,IPrw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_IPVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_IPVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record IPVc IPr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer ip,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "IPVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(IPr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "IPVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_IPVc(IPr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(IPr);
    for (ip=0;ip<vrwcnt;ip=ip+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "IPVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(IPr,TTRMapr.Field,ip);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "IPVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_IPVc(IPr,ip,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_IPVc(record TRVc TRr,record IPVc IPr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromIP!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_IPVc(TRr,TRrw,i,TAccr.Group,IPr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_PPVc(record PPVc PPr,Integer pp,string FileName,string field)
BEGIN
  string 255 res;
  row PPVc PPrw;
  
  if (pp>=0) then begin
    MatRowGet(PPr,pp,PPrw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_PPVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_PPVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record PPVc PPr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer pp,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "PPVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(PPr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "PPVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_PPVc(PPr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(PPr);
    for (pp=0;pp<vrwcnt;pp=pp+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "PPVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(PPr,TTRMapr.Field,pp);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "PPVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_PPVc(PPr,pp,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_PPVc(record TRVc TRr,record PPVc PPr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromPP!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_PPVc(TRr,TRrw,i,TAccr.Group,PPr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_PUVc(record PUVc PUr,Integer pu,string FileName,string field)
BEGIN
  string 255 res;
  row PUVc PUrw;
  
  if (pu>=0) then begin
    MatRowGet(PUr,pu,PUrw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_PUVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_PUVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record PUVc PUr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer pu,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "PUVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(PUr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "PUVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_PUVc(PUr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(PUr);
    for (pu=0;pu<vrwcnt;pu=pu+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "PUVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(PUr,TTRMapr.Field,pu);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "PUVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_PUVc(PUr,pu,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_PUVc(record TRVc TRr,record PUVc PUr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromPU!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_PUVc(TRr,TRrw,i,TAccr.Group,PUr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

function string 255 GetFieldValueByName_SHVc(record SHVc SHr,Integer sh,string FileName,string field)
BEGIN
  string 255 res;
  row SHVc SHrw;
  
  if (sh>=0) then begin
    MatRowGet(SHr,sh,SHrw);
  end;
  switch (FileName) begin
  end;
  GetFieldValueByName_SHVc = res;
  RETURN;
END;

updating procedure AddExtraInforToTTR_SHVc(record TRVc TRr,row TRVc TRrw,Integer rownr,string Group,record SHVc SHr)
BEGIN
  record TAccGroupVc TAccGroupr;
  record TTRVc TTRr,tempTTRr;
  record TTRMapVc TTRMapr;
  row TAccGroupVc TAccGrouprw;
  Integer i,rwcnt;
  row TTRVc TTRrw;
  Integer sh,vrwcnt;
  Integer stp;
  Boolean storerowttrf,storettrf;  

  TAccGroupr.Code = Group;
  if (ReadFirstMain(TAccGroupr,1,true)) then begin    
    CreateNewTTR(TRr,TRrw,rownr,TAccGroupr.Code,tempTTRr);
    storettrf = true;
    rwcnt = MatRowCnt(TAccGroupr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TAccGroupr,i,TAccGrouprw);
      TTRMapr.Code = TAccGrouprw.Field;
      TTRMapr.FileName = "SHVc";
      TTRMapr.Type = 0;
      if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
        stp = TTRMapr.RowType;
        ClearRow(tempTTRr,TTRrw,stp);
        TTRrw.stp = stp;
        TTRrw.Value = GetFieldValueByName(SHr,TTRMapr.Field,-1);
        if (nonblank(TTRrw.Value)) then begin
          MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
        end;
      end else begin
        TTRMapr.FromFileName = "SHVc";
        TTRMapr.Type = 0;
        TTRMapr.Code = TAccGrouprw.Field;
        if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(tempTTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName_SHVc(SHr,-1,TTRMapr.FileName,TTRMapr.Field);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(tempTTRr,MatRowCnt(tempTTRr),TTRrw);
          end;
        end;
      end;
    end;
    RecordCopy(TTRr,tempTTRr);
    
    vrwcnt = MatRowCnt(SHr);
    for (sh=0;sh<vrwcnt;sh=sh+1) begin   
      storerowttrf = false;   
      for (i=0;i<rwcnt;i=i+1) begin
        MatRowGet(TAccGroupr,i,TAccGrouprw);
        TTRMapr.Code = TAccGrouprw.Field;
        TTRMapr.FileName = "SHVc";
        TTRMapr.Type = 1;
        if (ReadFirstKey("CodeFNType",TTRMapr,3,true)) then begin
          stp = TTRMapr.RowType;
          ClearRow(TTRr,TTRrw,stp);
          TTRrw.stp = stp;
          TTRrw.Value = GetFieldValueByName(SHr,TTRMapr.Field,sh);
          if (nonblank(TTRrw.Value)) then begin
            MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
            storerowttrf = true;
          end;
        end else begin
          TTRMapr.FromFileName = "SHVc";
          TTRMapr.Type = 1;
          TTRMapr.Code = TAccGrouprw.Field;
          if (ReadFirstKey("FFNType",TTRMapr,3,true)) then begin
            stp = TTRMapr.RowType;
            ClearRow(tempTTRr,TTRrw,stp);
            TTRrw.stp = stp;
            TTRrw.Value = GetFieldValueByName_SHVc(SHr,sh,TTRMapr.FileName,TTRMapr.Field);
            if (nonblank(TTRrw.Value)) then begin
              MatRowPut(TTRr,MatRowCnt(TTRr),TTRrw);
              storerowttrf = true;
            end;
          end;
        end;
      end;
      if (storerowttrf) then begin
        StoreTTR(TTRr);
        RecordCopy(TTRr,tempTTRr);
        storettrf = false;
      end;
    end;
    if (storettrf) then begin
      StoreTTR(TTRr);
    end;
  end;
  RETURN;
END;

global
updating procedure AddTTrans_SHVc(record TRVc TRr,record SHVc SHr)
BEGIN
  row TRVc TRrw;
  Integer i,rwcnt;
  record TAccVc TAccr;
  record TTRBlock TTRb;

  BlockLoad(TTRb);
  if (TTRb.FromSH!=0) then begin
    rwcnt = MatRowCnt(TRr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(TRr,i,TRrw);
      if (TRrw.stp==1) and (TRrw.ovst==0) then begin
        if (nonblank(TRrw.TAccNumber)) then begin      
          TAccr.TAccNumber = TRrw.TAccNumber;
          if (ReadFirstMain(TAccr,1,true)) then begin
            AddExtraInforToTTR_SHVc(TRr,TRrw,i,TAccr.Group,SHr);
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;
