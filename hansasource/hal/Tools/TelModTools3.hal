// Countries

global
function boolean FitCntyHeader(String Dialed,var string CntyCode,Var String Zone,Var String Desc)
begin
  Integer pos,l;
  String 255 tstr;
  Record TelCntyVc TelCntyr;
  Boolean res;
  
  tstr = left(Dialed,1);
  pos = 0; res = true;
  l = len(Dialed);
  while (pos<l) begin
    TelCntyr.Code = tstr;
    if readfirstmain(TelCntyr,1,true) then begin   // Get exact match
      CntyCode = tstr;
      Zone = TelCntyr.Zone;
      Desc = TelCntyr.Name;
      goto LFitHeaderCode;
    end else begin
      pos = pos + 1;
      tstr = tstr & mid(Dialed,pos,1);  
    end;
  end;
  res = false;
LFitHeaderCode:; 
  FitCntyHeader = res;
  return;
end;

function boolean FitUrbanHeader(String Dialed,var string CityCode,Var String Zone,Var String Desc)
begin
  Integer pos,l;
  String 255 tstr;
  Record TelCityVc TelCityr;
  Boolean res;
  
  tstr = left(Dialed,1);
  pos = 0; res = true;
  l = len(Dialed);
  while (pos<l) begin
    TelCityr.Code = tstr;
    if readfirstmain(TelCityr,1,true) then begin   // Get exact match
      CityCode = tstr;
      Zone = TelCityr.Zone;
      Desc = TelCityr.Name;
      goto LFitUrbanHeader;
    end else begin
      pos = pos + 1;
      tstr = tstr & mid(Dialed,pos,1);
    end;
  end;
  res = false;
LFitUrbanHeader:;
  FitUrbanHeader = res;
  return;
end;

global
function val CalcTelPrice(String Struc,Val durat)  // duration in secs
begin
  val res;
  Record TelPriceStrucVc TelPriceStrucr;

  res = -1;
  TelPriceStrucr.Code = Struc;
  if readfirstmain(TelPriceStrucr,1,true) then begin
    res = ((durat/TelPriceStrucr.PulseSec)  * TelPriceStrucr.PulsePrice);  // Como es el redondeo aqui ?
  end;
  CalcTelPrice = res;
  return;
end;

global
function val CalculatePyTelCost(Val durat,String DialedPhNr)
begin
  val cost;
  String 100 tstr,Desc,Prefix,Zone,Dialed;
   
  cost = 0;
  Dialed = DialedPhNr;
  if (left(Dialed,1)=="0") then begin
    Dialed = mid(Dialed,1,len(Dialed)); 
    if (left(Dialed,2)=="02") then begin
      Dialed = mid(Dialed,2,len(Dialed)); 
      //stopalert("Internaltional Call" & Dialed);
      if FitCntyHeader(Dialed,Prefix,Zone,Desc) then begin
        cost = CalcTelPrice(Zone,durat);
      end;
    end else begin
       //stopalert("Urban Call");
      if FitUrbanHeader(Dialed,Prefix,Zone,Desc) then begin
        cost = CalcTelPrice(Zone,durat);
      end;
    end;
  end else begin
     //stopalert("Local Call");
     cost = CalcTelPrice("7",durat);
  end;
  CalculatePyTelCost = cost;
  return;
end;

global
function val CalculateArgTelCost(Val durat,String DialedPhNr)
begin
  val cost;
  String 100 tstr,Desc,Prefix,Zone,Dialed;
   
  CalculateArgTelCost = cost;
  return;
end;

global
procedure GetTelCallType( string Number, var string CallTypeCode )
begin
  String 30 Resultado,tstr;
  record CYBlock Info;

  Blockload(Info);
  if (Info.CountryCode=="AR") then begin
    if (mid(Number,0,2)=="00") then begin 
      Resultado="DDI"; 
    end else begin
      if (mid(Number,0,4)=="0800") then begin
        Resultado="TOL";
      end else begin
        if (mid(Number,0,4)=="0810") then begin
          Resultado="LOC";
        end else begin
          if (mid(Number,0,4)=="0610") then begin
            Resultado="WEB";
          end else begin
            if (mid(Number,0,1)=="0") then begin
              Resultado="DDN";
            end else begin
              if (mid(Number,0,2)=="15") then begin
                Resultado="CEL";
              end else begin
                Resultado="LOC";
              end;
            end;   
          end; 
        end;
      end;
    end;
  end;
  if (Info.CountryCode=="PY") then begin
  if (left(Number,1)=="0") then begin
    tstr = mid(Number,1,len(Number)); 
    if (left(tstr,2)=="02") then begin
      Resultado="INT";
    end else begin
      Resultado="NAT";
    end;
  end else begin
    Resultado="LOC";
  end;
  end;
  if (Info.CountryCode=="HN") then begin
    if (mid(Number,0,2)=="00") then begin 
      Resultado="DDI"; 
    end else begin
      if (mid(Number,0,4)=="0800") then begin
        Resultado="TOL";
      end else begin
        if (mid(Number,0,4)=="0810") then begin
          Resultado="LOC";
        end else begin
          if (mid(Number,0,4)=="0610") then begin
            Resultado="WEB";
          end else begin
            if (mid(Number,0,1)=="0") then begin
              Resultado="URB";
            end else begin
              if (mid(Number,0,1)=="9") then begin
                Resultado="CEL";
              end else begin
                Resultado="LOC";
              end;
            end;   
          end; 
        end;
      end;
    end;
  end;
  CallTypeCode = Resultado;
  return;
end;
