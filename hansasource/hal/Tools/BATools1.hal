external updating procedure CreateAndForwardMail(record MailVc,string,string);
external function Boolean InterNetAddrTest(string);
external function Boolean FindUserInMailbox(string,var string,var LongInt);

global
updating procedure CheckAndSendExternalMail(longint actsernr,string filename,string ToAddrCode,string FromAddrCode,longint MailSerNr)
begin
  record ConfAutoReplyVc ConfAutoReplyr;
  record ActVc Actr;
  boolean testf,testf2;
  string 255 tstr;
  record MailVc Mailr;
  LongInt l;

  testf = true;
  Actr.SerNr = actsernr;
  if (ReadFirstMain(Actr,1,true)==false) then begin testf = false; end;   
  if (testf) then begin 
    if (FindUserInMailbox(ToAddrCode,tstr,l)) then begin
      ConfAutoReplyr.SerNr = l;
      if (ReadFirstMain(ConfAutoReplyr,1,true)) then begin
        if (ConfAutoReplyr.ForwardEnabled!=0) then begin
          if (nonblank(ConfAutoReplyr.ForwardTo) and InterNetAddrTest(ConfAutoReplyr.ForwardTo)) then begin 
            Mailr.SerNr = MailSerNr;
            testf2 = ReadFirstMain(Mailr,1,true);
          end;
        end;  
      end;
    end;  
  end;
  if (testf2) then begin 
    CreateAndForwardMail(Mailr,FromAddrCode,ConfAutoReplyr.ForwardTo);
  end;
end;