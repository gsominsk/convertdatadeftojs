external function Boolean VIVc_PasteVECode(var record VIVc,Integer,Boolean,Boolean,var string);
external updating procedure AddRsrtEventRowToEventShopBask(record HotelBlock,LongInt,record RsrtEventVc,row RsrtEventVc);

global
updating procedure AddRsrtEventRowPackageToEventShopBask(record HotelBlock Hotelb,LongInt mothershopbasknr,record RsrtEventVc motherREr,row RsrtEventVc RsrtEventrw)
begin
  record RsrtEventHistVc REHr;
  Boolean found,testf;
  record ShopBaskVc ShopBaskr;
  record RsrtEventVc REr;
  row RsrtEventVc RErw;
  Integer i,rwcnt;
  
  if (nonblank(RsrtEventrw.RsrtEventTypePack)) then begin
    found = true;
    REHr.SequenceNr = RsrtEventrw.SequenceNr;
    while (LoopKey("SequenceNr",REHr,1,found)) begin
      if (REHr.SequenceNr!=RsrtEventrw.SequenceNr) then begin found = false; end;
      if (found) then begin
        testf = true;
        if (REHr.EventNr==motherREr.SerNr) then begin testf = false; end;        
        if (testf) then begin
          ShopBaskr.OwnerSerNr = REHr.EventNr;
          ShopBaskr.Owner = kShopBaskOwnerRsrtEvent;
          testf = ReadFirstKey("OwnerSerNr",ShopBaskr,2,true)==false;
        end;
        if (testf) then begin
          REr.SerNr = REHr.EventNr;
          if (ReadFirstMain(REr,1,true)) then begin
            rwcnt = MatRowCnt(REr);
            for (i=0;i<rwcnt;i=i+1) begin
              MatRowGet(REr,i,RErw);
              switch (RErw.Invoicing) begin
                case kResortEventInvoiceable:
                  AddRsrtEventRowToEventShopBask(Hotelb,mothershopbasknr,REr,RErw);
                case kResortEventOnReservation:
//                  AddRsrtEventRowToReservationShopBask(Hotelb,REr,RErw);
              end;
            end;
          end;
        end;
      end;
    end;
  end;
  return;
end;  

global
function Boolean CreateVIFromRsrtEvent(record RsrtEventVc RsrtEventr,var record VIVc VIr,var string vewarn)
begin
  Boolean res;
  RecordNew(VIr);
  
  VIr.VECode = RsrtEventr.VECode;
  if (VIVc_PasteVECode(VIr,1,false,true,vewarn)==false) then begin
  end;  
  CreateVIFromRsrtEvent = true;
  return;
end;  
