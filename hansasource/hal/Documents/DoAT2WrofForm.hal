external function Boolean FindTheUser(var record UserVc);
external function Boolean FindFormcode(Integer,Integer);
external procedure OneAT2UnitDeprCalculation(Integer,Integer,Integer,Boolean,Date,Date,string,var val,var val,var val,var val,var string,val,val,Boolean);
external procedure GetDepreciationPrc(string,var val);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure CommonDocumentFields(record RcVc);
external function Boolean GetLastDprStartVal(Integer,string,val,var val,var val);
external procedure GetAssetCurDepartment(string,var string);
external procedure GetUserName(string, var string);
external procedure GetMonthText(string,date, var string);

function Boolean GetAssetClass(string code,row AC2Block resACrw)
begin
  Boolean res;
  record AC2Block AC2b;
  row AC2Block ACrw;
  Integer i,rwcnt;
  
  blockload(AC2b);
  rwcnt = MatRowCnt(AC2b);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(AC2b,i,ACrw);
    if (ACrw.Code==code) then begin
      CopyRow(AC2b,ACrw,resACrw);
      i = rwcnt; 
      res = true;
    end;
  end;
  GetAssetClass = res;
  return;
end;

global
procedure GetUserJob(string user, var string res)
begin
  record UserVc Userr;

  Userr.Code = user;
  res = "";
  if ReadFirstMain(Userr,1,true) then begin
    res = Userr.Job;
  end;

  return;
end;

procedure CalcDeprVal(record AT2UnitVc AT2Unitr,record AT2WrofVc AT2Wrofr,var val res)
BEGIN
  record AT2AccBlock AT2AccRec;
  Date sd,ed;
  val tdprv,dprv;
  val t;
  
  res = blankval;
  ed = AT2Wrofr.TransDate;
  ed = AddDay(ed,-1);
  ed = AddDay(ed,-GetDay(ed) + DaysInMonth(GetYear(ed),GetMonth(ed)));
  if (AT2AccRec.Model==0) then begin
    sd = AT2Unitr.StartingDate1;
  end else begin  
    sd = AT2Unitr.StartingDate2;
  end;  
  OneAT2UnitDeprCalculation(AT2AccRec.Model,1,0,false,sd,ed,AT2Unitr.InventoryNr,dprv,tdprv,t,t,AT2Unitr.Model1,blankval,AT2Unitr.ResVal,false);
  res = tdprv + dprv;
//  res = blankval;
  RETURN;
END;

procedure PrintAT2WrofRows(record RcVc RepSpec,record AT2WrofVc AT2Wrofr)
BEGIN
  Integer i,rwcnt;
  row AT2WrofVc AT2Wrofrw;
  record AT2Vc AT2r;
  record AT2UnitVc AT2Unitr;
  record AT2AccBlock AT2AccRec;
  row AC2Block ACrw;
  string 255 tstr;
  integer months,years;
  val t,t2;
  record UserVc Userr;
  
  blockload(AT2AccRec);
  rwcnt = MatRowCnt(AT2Wrofr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(AT2Wrofr,i,AT2Wrofrw);
    AT2Unitr.InventoryNr = AT2Wrofrw.InventoryNr;
    if (ReadFirstMain(AT2Unitr,1,true)) then begin
    end;    
    if (GetAssetClass(AT2Unitr.AT2Class,ACrw)==false) then begin
      AT2r.Code = AT2Unitr.AT2Code;
      ReadFirstMain(AT2r,1,true);      
      GetAssetClass(AT2r.AT2Class,ACrw)
    end;
    OUTFORMFIELD("F_TRANSNR",i+1);          
    OUTFORMFIELD("F_FIXASSETCODE",AT2Wrofrw.InventoryNr);
    OUTFORMFIELD("F_FIXASSETNAME",AT2Wrofrw.Description);
    OUTFORMFIELD("F_SERIALNR",AT2Unitr.SerialNr);
    OUTFORMFIELD("F_COSTACCOUNT",AT2Wrofrw.Account);
    OUTFORMFIELD("F_ASSETACC",ACrw.Asset1Acc);
    OUTFORMFIELD("F_DEPRACC",ACrw.Depr1Acc);
    OUTFORMFIELD("F_DEPRCOSTACC",ACrw.Cost1Acc);

    OUTFORMFIELD("F_OBJECT",AT2Wrofrw.Objects);
    OUTFORMFIELD("F_SALESPRICE",AT2Wrofrw.SalesVal);
    OUTFORMFIELD("F_INVENTORYNR",AT2Wrofrw.InventoryNr);
    OUTFORMFIELD("F_ANTAL",AT2Wrofrw.Qty);
    OUTFORMFIELD("F_ACUMULATEDDEPR",AT2Wrofrw.DprVal);
    OUTFORMFIELD("F_ENDBAL",AT2Unitr.PurchVal-AT2Wrofrw.DprVal);
    OUTFORMFIELD("F_RESPONSIBLEPERSON",AT2Unitr.RespPerson);
    Userr.Code = AT2Unitr.RespPerson;
    FindTheUser(Userr);
    OUTFORMFIELD("F_RESPONSIBLEPERSONNAME",Userr.Name);
    OUTFORMFIELD("F_PRODDATE",AT2Unitr.ProdDate);
    OUTFORMFIELD("F_PURCHASEDATE",AT2Unitr.PurchaseDate);
    OUTFORMFIELD("F_STARTDATE",AT2Unitr.StartingDate1);
    GetDepreciationPrc(AT2Unitr.Model1,t);
    years = 100 / t;
    months = 100 / t * 12;
    OUTFORMFIELD("F_DEPRPRC",t);
    if (FieldInForm("F_DEPRPRC2")) then begin
      GetDepreciationPrc(AT2Unitr.Model2,t);
      OUTFORMFIELD("F_DEPRPRC2",t);
    end;
    OUTFORMFIELD("F_PERIODMONTH",months);    
    OUTFORMFIELD("F_PERIODYEAR",years);
    
    if (FIELDINFORM("F_REVALUATEDVALUE")) then begin
      if (GetLastDprStartVal(0,AT2Wrofrw.InventoryNr,AT2Unitr.PurchVal,t,t2)) then begin 
      end;
      OUTFORMFIELD("F_REVALUATEDVALUE",t);
    end;
    if (FIELDINFORM("F_DEPARTMENT")) then begin
      GetAssetCurDepartment(AT2Wrofrw.InventoryNr,tstr);
      OUTFORMFIELD("F_DEPARTMENT",tstr);
    end;          
    if (FIELDINFORM("F_DEPRVAL")) then begin
      CalcDeprVal(AT2Unitr,AT2Wrofr,t);
      if (t != 0) then begin
        OUTFORMFIELD("F_DEPRVAL",t);
      end;
    end;          

    OUTFORMFIELD("F_STARTDEPCODE",AT2Unitr.DepCode);
    OUTFORMFIELD("F_STARTDEPNAME",AT2Unitr.DepName);
    OUTFORMFIELD("F_PURCHVAL",AT2Unitr.PurchVal);
    OUTFORMFIELD("F_COMMENT",AT2Unitr.Comment);
    OUTFORMFIELD("F_DOCTYPE",USetStr(23467));
    EndFormRow;        
  end;  
  RETURN;
END;


global
procedure DoAT2WrofForm(record RcVc RepSpec,record AT2WrofVc AT2Wrofr)
BEGIN
  record CUVc CUr;
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
    
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoAT2WrofForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(AT2Wrofr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,AT2Wrofr.SerNr,FDrw.PrintGroupCode,
                        "",intdocnr,"AT2WrofVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(FDrw.FPCode,MatRowCnt(AT2Wrofr));
        OUTFORMFIELD("F_SERNR",AT2Wrofr.SerNr);
        OUTFORMFIELD("F_TRANSDATE",AT2Wrofr.TransDate);
        OUTFORMFIELD("F_COMMENT",AT2Wrofr.Comment);
        OUTFORMFIELD("F_SALESACC",AT2Wrofr.Account);
        OUTFORMFIELD("F_SIGNATURE",AT2Wrofr.Sign);
        OUTFORMFIELD("F_REFERENSNUMMER",AT2Wrofr.RefStr);

        OUTFORMFIELD("F_DOCUMENTNO",RepSpec.f5);
        if (FieldInForm("F_DATEYEAR")) then begin
          OUTFORMFIELD("F_DATEYEAR", GetYear(RepSpec.d1));
        end;
        if (FieldInForm("F_DATEDAY")) then begin
          OUTFORMFIELD("F_DATEDAY", GetDay(RepSpec.d1));
        end;
        if (FieldInForm("F_DATEMONTHTEXT")) then begin
          GetMonthText(FDrw.LangCode,RepSpec.d1, tstr);
          OUTFORMFIELD("F_DATEMONTHTEXT",tstr);
        end;
        if (FieldInForm("F_DATEYEAR2")) then begin
          OUTFORMFIELD("F_DATEYEAR2", GetYear(RepSpec.d2));
        end;
        if (FieldInForm("F_DATEDAY2")) then begin
          OUTFORMFIELD("F_DATEDAY2",GetDay(RepSpec.d2));
        end;
        if (FieldInForm("F_DATEMONTHTEXT2")) then begin
          GetMonthText(FDrw.LangCode,RepSpec.d2, tstr);
          OUTFORMFIELD("F_DATEMONTHTEXT2",tstr);
        end;
        if (FieldInForm("F_COMMMEMBER1")) then begin
          GetUserName(RepSpec.f2, tstr);
          OUTFORMFIELD("F_COMMMEMBER1",tstr);
          GetUserJob(RepSpec.f2, tstr);
          OUTFORMFIELD("F_MEMBER1JOB",tstr);
        end;
        if (FieldInForm("F_COMMMEMBER2")) then begin
          GetUserName(RepSpec.f3,tstr);
          OUTFORMFIELD("F_COMMMEMBER2",tstr);
          GetUserJob(RepSpec.f3, tstr);
          OUTFORMFIELD("F_MEMBER2JOB",tstr);
        end;
        if (FieldInForm("F_COMMMEMBER3")) then begin
          GetUserName(RepSpec.f4,tstr);
          OUTFORMFIELD("F_COMMMEMBER3",tstr);
          GetUserJob(RepSpec.f4, tstr);
          OUTFORMFIELD("F_MEMBER3JOB",tstr);
        end;

        PrintAT2WrofRows(RepSpec,AT2Wrofr);
        CloseForm;        
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoAT2WrofForm:;  
  RETURN;  
END;     
 
