external function Integer OPTestApprovalStatus(record OPVc);
external updating procedure RecLAction_rlOPDPrint(record RcVc,var record OPVc,Integer,Boolean,Boolean);

global
updating procedure OPDForm(record RcVc RepSpec)
BEGIN
  Boolean TrHs,testf;
  record OPVc oldOPr;
  record OPVc OPr;
  row OPVc OPrw;
  row OPVc OP2rw;
  LongInt afr,ato;
  LongInt recid;
  Integer i,j,rwcnt,err;
  LongInt nextchnr;
  Boolean nextchnrf;
  transaction record RcVc gOP2DFormRepSpec;
  vector Boolean vcheqf;
  
  StartPrintDialogGroup;
  RecordCopy(gOP2DFormRepSpec,RepSpec);
  afr = FirstInRange(RepSpec.f1,10);
  ato = LastInRange(RepSpec.f1,10);
  nextchnr = FirstInRange(RepSpec.f2,10);
  OPr.SerNr = 0;
  if (afr!=-1) then begin OPr.SerNr = afr; end;
  TrHs = true;
  while (LoopMain(OPr,1,TrHs)) begin
    RecordCopy(oldOPr,OPr);
    if (TrHs) then begin
      if (ato!=-1) then begin
        if (OPr.SerNr>ato) then begin
          TrHs = false;
        end;
      end;
    end;
    if (TrHs) then begin
      testf = true;
      err = OPTestApprovalStatus(OPr);
      if (err!=0) then begin
        MessageBox(err,": " & OPr.SerNr);
        testf = false;
      end;
      if (testf) then begin 
        nextchnrf = false;
        if ((RepSpec.OnlyUnprntd==1) or (OPr.SentFlag==0)) then begin
          rwcnt = MatRowCnt(OPr);
          if (rwcnt>=1) then begin
            if (nextchnr>0) then begin
              for (i=0;i<rwcnt;i=i+1) begin
                MatRowGet(OPr,i,OPrw);
                nextchnrf = false;
                if (OPrw.ChequeNr<=0) and (vcheqf[OPrw.VECode & ":" & OPr.SerNr]==false) then begin
                  OPrw.ChequeNr = nextchnr;
                  MatRowPut(OPr,i,OPrw);
                  vcheqf[OPrw.VECode & ":" & OPr.SerNr] = true;
                  for (j=i+1;j<rwcnt;j=j+1) begin
                    MatRowGet(OPr,j,OP2rw);
                    if (OP2rw.VECode==OPrw.VECode) then begin
                      OP2rw.ChequeNr = nextchnr;
                      MatRowPut(OPr,j,OP2rw);
                    end;
                  end;
                  nextchnr = nextchnr + 1;
                  nextchnrf = true;
                end;
                if (nextchnrf) then begin
                  if (RecordUpdate(oldOPr,OPr,true)==0) then begin
                  end;
                end;
              end;
            end;
          end;
          RecLAction_rlOPDPrint(RepSpec,OPr,1,false,false);
          if (rwcnt>=1) then begin
            if (nextchnr>0) then begin
              nextchnrf = false;
              for (i=0;i<rwcnt;i=i+1) begin
                MatRowGet(OPr,i,OPrw);
                if (OPrw.ChequeNr>nextchnr) then begin
                  nextchnr = OPrw.ChequeNr;
                  nextchnrf = true;
                end;
              end;
              if (nextchnrf) then begin
                nextchnr = nextchnr + 1;
                RepSpec.f2 = nextchnr;          
                gOP2DFormRepSpec.f2 = RepSpec.f2;
              end;
            end;
          end;
        end;
      end; 
    end;
  end;
  EndPrintDialogGroup;
  RETURN;
END;

global
updating procedure OP2DForm(var record RcVc RepSpec)
BEGIN
  Boolean TrHs,testf;
  record OPVc oldOPr;
  record OPVc OPr;
  record OPVc newOPr;
  row OPVc OPrw;
  LongInt afr,ato;
  LongInt recid;
  Integer i,rwcnt,err;
  LongInt nextchnr;
  transaction record RcVc gOP2DFormRepSpec;
  string 255 suppliercode;
  
  StartPrintDialogGroup;
  RecordCopy(gOP2DFormRepSpec,RepSpec);
  afr = FirstInRange(RepSpec.f1,10);
  ato = LastInRange(RepSpec.f1,10);
  nextchnr = FirstInRange(RepSpec.f2,10);
  OPr.SerNr = 0;
  if (afr!=-1) then begin OPr.SerNr = afr; end;
  TrHs = true;
  while (LoopMain(OPr,1,TrHs)) begin
    RecordCopy(oldOPr,OPr);
    if (TrHs) then begin
      if (ato!=-1) then begin
        if (OPr.SerNr>ato) then begin
          TrHs = false;
        end;
      end;
    end;
    testf = TrHs;
    if ((RepSpec.OnlyUnprntd==0) and (OPr.SentFlag!=0)) then begin
      testf = false;
    end;
    if (nonblank(RepSpec.f3) and OPr.PayMode!=RepSpec.f3) then begin
      testf = false;
    end;
    err = OPTestApprovalStatus(OPr);
    if (err!=0) then begin
      MessageBox(err,": " & OPr.SerNr);
      testf = false;
    end;
    if (testf) then begin
      rwcnt = MatRowCnt(OPr);
      suppliercode = "";
      if (rwcnt>=1) then begin      
        if (nextchnr>0) then begin
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(OPr,i,OPrw);
            if (Blank(suppliercode) and OPrw.ChequeNr==-1) then begin 
              suppliercode = OPrw.VECode;
            end else begin
              if (OPrw.ChequeNr!=-1) then begin 
                nextchnr = OPrw.ChequeNr + 1;
              end;
            end;
            if (OPrw.ChequeNr==-1 and suppliercode==OPrw.VECode) then begin 
              OPrw.ChequeNr = nextchnr;
              MatRowPut(OPr,i,OPrw);
            end else begin
              if (NonBlank(suppliercode) and suppliercode!=OPrw.VECode) then begin 
                suppliercode = OPrw.VECode;
                nextchnr = nextchnr + 1;
                OPrw.ChequeNr = nextchnr;
                MatRowPut(OPr,i,OPrw);              
              end;
            end;
          end;        
          if (RecordUpdate(oldOPr,OPr,true)==0) then begin
          end;
        end;
      end;
      RecLAction_rlOPDPrint(RepSpec,OPr,2,false,false);
      newOPr.SerNr = OPr.SerNr;
      if (ReadFirstMain(newOPr,1,true)) then begin end;
      rwcnt = MatRowCnt(newOPr);
      if (rwcnt>=1) then begin
        if (nextchnr>0) then begin
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(newOPr,i,OPrw);
            if (OPrw.ChequeNr<=0) then begin
              if (OPrw.ChequeNr>nextchnr) then begin
                nextchnr = OPrw.ChequeNr;
              end;
            end;
          end;
          nextchnr = nextchnr + 1;
          RepSpec.f2 = nextchnr;          
          gOP2DFormRepSpec.f2 = RepSpec.f2;
        end;
      end;
    end;
  end;
  EndPrintDialogGroup;
  RETURN;
END;