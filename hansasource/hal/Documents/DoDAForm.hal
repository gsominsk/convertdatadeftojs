external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external procedure Val2ToText(string,val,Integer,string,string,var string);
external procedure GetFieldArgument(record DocVc,Integer,var string);
external procedure GetLangNr(string,var record LangNrVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Boolean FindFormcode(Integer,Integer);
external procedure CommonDocumentFields(record RcVc);
external function Integer NumberofDocumentPages(string,Integer);

procedure PrintDA(record RcVc RepSpec,record DAVc DAr,string formcode)
begin
  record DocVc Docr;
  row DAVc DArw;
  Integer i,rwcnt;
  string 255 tstr,fldarg;
  val t,tcur;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  record UserVc Userr;
  record PRVc PRr;
  val totqty;

  GetLangNr("",LangNrr);  
  BlockLoad(SysFormatRec);
  Userr.Code = DAr.Person;
  if (ReadFirstMain(Userr,1,true)) then begin
  end;
  Docr.Code = formcode;
  if (ReadFirstMain(Docr,1,true)) then begin
  end;
  OUTFORMFIELD("F_SERNR",DAr.SerNr);
  OUTFORMFIELD("F_TRANSDATE",DAr.TransDate);
  OUTFORMFIELD("F_COMMENT",DAr.Comment);
  OUTFORMFIELD("F_PERSON",DAr.Person);
  OUTFORMFIELD("F_PERSNAME",Userr.Name);
  OUTFORMFIELD("F_PERSONSPEC",Userr.Spec);
  OUTFORMFIELD("F_DEPARTMENT",Userr.Department);

  PrintValue("F_TOTALAMOUNT",DAr.PayVal,M4Val,LangNrr,SysFormatRec,false);
  if (FIELDINFORM("F_AMOUNTINTEXT")) then begin
    GetFieldArgument(Docr,F_AMOUNTINTEXT,fldarg);
    Val2ToText(fldarg,DAr.PayVal,M4Val,DAr.CurncyCode,"",tstr);
    OUTFORMFIELD("F_AMOUNTINTEXT",tstr);
  end;
//  OUTFORMFIELD("F_PRCODE",DAr.PRCode);
  if (FIELDINFORM("F_PROJECTNAME")) then begin
    PRr.Code = DAr.PRCode;
    if (ReadFirstMain(PRr,1,true)) then begin
      OUTFORMFIELD("F_PROJECTNAME",PRr.Name);
    end;
  end;
  
  rwcnt = MatRowCnt(DAr);
  OUTFORMFIELD("F_TOTANTAL",rwcnt+1);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(DAr,i,DArw);
    switch (DArw.stp) begin
      case 1:
        OUTFORMFIELD("F_TRANSROW",i+1);
        OUTFORMFIELD("F_DESCRIPTION",DArw.Comment);
        OUTFORMFIELD("F_ORDERDATE",DArw.Date);
        OUTFORMFIELD("F_COUNTRYCODE",DArw.Country);
        PrintValue("F_AMOUNT",DArw.Compensation,M4Val,LangNrr,SysFormatRec,false);
        PrintValue("F_BELOPP",DArw.Compensation,M4Val,LangNrr,SysFormatRec,false);

        OUTFORMFIELD("F_BREAKFAST",StringFromSet(562,DArw.Breakfast));
        PrintValue("F_BREAKFASTRATE",DArw.BreakfastRate,M4Val,LangNrr,SysFormatRec,false);
        PrintValue("F_BREAKFASTSUM",DArw.BreakfastSum,M4Val,LangNrr,SysFormatRec,false);
        OUTFORMFIELD("F_LUNCH",StringFromSet(562,DArw.Lunch));
        PrintValue("F_LUNCHRATE",DArw.LunchRate,M4Val,LangNrr,SysFormatRec,false);
        PrintValue("F_LUNCHSUM",DArw.LunchSum,M4Val,LangNrr,SysFormatRec,false);
        OUTFORMFIELD("F_DINNER",StringFromSet(562,DArw.Dinner));
        PrintValue("F_DINNERRATE",DArw.DinnerRate,M4Val,LangNrr,SysFormatRec,false);
        PrintValue("F_DINNERSUM",DArw.DinnerSum,M4Val,LangNrr,SysFormatRec,false);
        EndFormRow;
    end;
  end;  
  return;
end;

global
procedure DoDAForm(record RcVc RepSpec,record DAVc DAr)
begin
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;

  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoDAForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(DAr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,DAr.SerNr,FDrw.PrintGroupCode,
                        "",intdocnr,"DAVc",formcode)) then
        begin
          goto LBREAKDA;
        end;
      end;
    end;
LBREAKDA:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(formcode,MatRowCnt(DAr));          
        PrintDA(RepSpec,DAr,formcode);
        CloseForm;
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoDAForm:;  
  return;
end;
