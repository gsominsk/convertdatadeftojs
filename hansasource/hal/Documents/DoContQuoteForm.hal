external procedure OutAddress(string,string,string,string,string,string,string);
external function Boolean FindFormcode(Integer,Integer);
external procedure SetFaxInfo(string,string,string,string);
external procedure SelectUnitText(string,string,var string);
external procedure ItemBC39(string,var string);
external procedure ItemBCEAN(string,var string);
external procedure ItemBCEAN13(string,var string);
external procedure ValToText(val,Integer,string,string,var string);
external procedure GetUserName(string,var string);
external procedure GetLangNr(string,var record LangNrVc);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);

procedure PrintCQ(record CQVc CQr,string formcode)
BEGIN
  record LangNrVc LangNrr;
  record SysFormatBlock SysFormatRec;
  record CUVc VEr;
  record CUVc CUr;
  record INVc INr;
  row CQVc CQrw;
  Integer i,rwcnt;
  string 255 tstr;

  BlockLoad(SysFormatRec);  
  GetLangNr("",LangNrr);
  VEr.Code = CQr.VECode;
  if (ReadFirstMain(VEr,1,true)) then begin
  end;
  CUr.Code = CQr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
    SetFaxInfo(CUr.Person,CUr.Name,CUr.Fax,USetStr(1820));
  end;
  OUTFORMFIELD("F_TRANSDATE",CQr.CQDate);  
  OUTFORMFIELD("F_PARTNERNAME",VEr.Name);
  OUTFORMFIELD("F_PARTNERCONTACT",VEr.Person);
  OUTFORMFIELD("F_PARTNERFAX",VEr.Fax);
  OUTFORMFIELD("F_PARTNERPHONE",VEr.Phone);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.Name);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.InvAddr0);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.InvAddr1);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.InvAddr2);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.InvAddr3);
  OUTFORMFIELD("F_PARTNERADRESS",VEr.InvAddr4);
  OUTFORMFIELD("F_DESCRIPTION",CQr.Text0);
  OUTFORMFIELD("F_COMMENT",CQr.Text1);
  OUTFORMFIELD("F_COMMENT",CQr.Text2);
  OUTFORMFIELD("F_COMMENT",CQr.Text3);
  OUTFORMFIELD("F_COMMENT",CQr.Text4);
  OUTFORMFIELD("F_COMMENT",CQr.Text5);
  OUTFORMFIELD("F_COMMENT",CQr.Text6);
  OUTFORMFIELD("F_COMMENT",CQr.Text7);
  OUTFORMFIELD("F_COMMENT",CQr.Text8);
  OUTFORMFIELD("F_COMMENT",CQr.Text9);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text1);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text2);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text3);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text4);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text5);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text6);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text7);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text8);
  OUTFORMFIELD("F_KOMMENTAR",CQr.Text9);
  OUTFORMFIELD("F_KUNDNR",CQr.CustCode);
  OUTFORMFIELD("F_NUMMER",CQr.SerNr);
  OutAddress("F_ADRESS",CQr.Name,CQr.Addr0,CQr.Addr1,CQr.Addr2,CQr.InvAddr3,CQr.InvAddr4);
  OUTFORMFIELD("F_ADDR1",CQr.Name);
  OUTFORMFIELD("F_ADDR2",CQr.Addr0);
  OUTFORMFIELD("F_ADDR3",CQr.Addr1);
  OUTFORMFIELD("F_ADDR4",CQr.Addr2);
  OUTFORMFIELD("F_INVADDR3",CQr.InvAddr3);
  OUTFORMFIELD("F_INVADDR4",CQr.InvAddr4);
  OUTFORMFIELD("F_VARREFERENS",CQr.OurContact);
  OUTFORMFIELD("F_ERREFERENS",CQr.ClientContact);
  if (FIELDINFORM("F_SALJARNAMN")) then begin
    GetUserName(CQr.SalesMan,tstr);
    OUTFORMFIELD("F_SALJARNAMN",tstr);
  end;  
  OUTFORMFIELD("F_PERIODLENGTH",CQr.invTimes);
  OUTFORMFIELD("F_PERIODTYPE",USetStr(2991));
  PrintValue("F_ATTBETALA",CQr.PeriodCost,M4Val,LangNrr,SysFormatRec,false);
  if (FIELDINFORM("F_ATTBETALATEXT")) then begin
    ValToText(CQr.PeriodCost,M4Val,"","",tstr);
    OUTFORMFIELD("F_ATTBETALATEXT",tstr);  
  end;
  OUTFORMFIELD("F_KUNDMOMSNR",CUr.VATNr);
  OUTFORMFIELD("F_KUNDFAX",CUr.Fax);
  OUTFORMFIELD("F_TAKECONTACT",CQr.MakeContact);
  OUTFORMFIELD("F_VALIDTO",CQr.ValidTo);
  rwcnt = MatRowCnt(CQr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(CQr,i,CQrw);
    INr.Code = CQrw.ArtCode;
    if (ReadFirstMain(INr,1,true)) then begin
    end;
    OUTFORMFIELD("F_ARTNR",CQrw.ArtCode);
    OUTFORMFIELD("F_ARTNR2",CQrw.ArtCode);
    if (FIELDINFORM("F_ARTNRBC39")) then begin
      ItemBC39(CQrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBC39",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN")) then begin
      ItemBCEAN(CQrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBCEAN",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN13")) then begin
      ItemBCEAN13(CQrw.ArtCode,tstr);      
      OUTFORMFIELD("F_ARTNRBCEAN13",tstr);
    end;  
    OUTFORMFIELD("F_ARTGRUPP",INr.Group);
    PrintValue("F_ANTAL",CQrw.Quant,M4UVal,LangNrr,SysFormatRec,false);
    PrintValue("F_BELOPP",CQrw.Price,M4Val,LangNrr,SysFormatRec,false);
    SelectUnitText("",INr.Unittext,tstr);    
    OUTFORMFIELD("F_ENHET",tstr);
    OUTFORMFIELD("F_SPECIFIKATION",CQrw.Spec);
    OUTFORMFIELD("F_ITEMTYPE",CQrw.Type);
    EndFormRow;
  end;  
  RETURN;
END;

global
procedure DoContQuoteForm(record RcVc RepSpec,record CQVc CQr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  Integer i,rwcnt;
  string 255 tstr;
    
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoContQuoteForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,CQr.SerNr,FDrw.PrintGroupCode,
                        "",intdocnr,"CQVc",formcode)) then
        begin
          goto LBREAKContQuote;
        end;
    end;
LBREAKContQuote:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        PrintCQ(CQr,formcode);
        CloseForm;
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoContQuoteForm:;  
  RETURN;
END;

global
procedure DoCreditQueryForm(record RcVc RepSpec,record CQVc CQr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  Integer i,rwcnt;
  string 255 tstr;
    
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoCreditQueryForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,CQr.SerNr,FDrw.PrintGroupCode,
                        "",intdocnr,"CQVc",formcode)) then
        begin
          goto LBREAKCreditQuery;
        end;
    end;
LBREAKCreditQuery:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        PrintCQ(CQr,formcode);
        CloseForm;
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoCreditQueryForm:;  
  RETURN;
END;
