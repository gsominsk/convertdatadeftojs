external procedure GetLangNr(string,var record LangNrVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure CommonDocumentFields(record RcVc);

procedure PrintORProgRows(record RcVc RepSpec,record ORProgVc ORProgr,record LangNrVc LangNrr,record SysFormatBlock SysFormatRec)
BEGIN
  Integer i,rwcnt;
  row ORProgVc ORProgrw;
  string 255 tstr;
  val t,t1;
  record INVc INr;
  val vatprc,vatval,vatexclprc,vatinclprc;

  rwcnt = MatRowCnt(ORProgr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(ORProgr,i,ORProgrw);
    switch (ORProgrw.stp) begin
    case 1:
      INr.Code = ORProgrw.ArtCode;
      if (ReadFirstMain(INr,1,true)) then begin
      end;
      OUTFORMFIELD("F_ARTNR",ORProgrw.ArtCode);
      OUTFORMFIELD("F_ARTNR2",ORProgrw.ArtCode);
    end;
    EndFormRow;
  end;  
LPrintORProgRows:;  
  RETURN;
END;

global
procedure DoORProgForm(record RcVc RepSpec,record ORProgVc ORProgr)
BEGIN
  record CUVc CUr;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  record LangNrVc LangNrr;
  record SysFormatBlock SysFormatRec;
  record FormDefVc FDr;
  row FormDefVc FDrw;

  BlockLoad(SysFormatRec);  
  GetLangNr("",LangNrr);
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoORProgForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,-1,FDrw.PrintGroupCode,
                      "",intdocnr,"ORProgVc",formcode)) then
      begin
        goto LBREAK;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          CommonDocumentFields(RepSpec);
          NumberofDocumentPages(FDrw.FPCode,MatRowCnt(ORProgr));
          OUTFORMFIELD("F_SERNR",ORProgr.SerNr);
          OUTFORMFIELD("VENAME",ORProgr.VEName);
          PrintORProgRows(RepSpec,ORProgr,LangNrr,SysFormatRec);
          CloseForm;        
      end else begin
//        StopAlert(USetStr(1546) & formcode);
        printf = false;
      end;
    end else begin
//      StopAlert(USetStr(1546) & formcode);
      printf = false;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoORProgForm:;  
  RETURN;  
END;     
 
