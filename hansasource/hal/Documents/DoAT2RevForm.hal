external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure CommonDocumentFields(record RcVc);


procedure PrintAT2RevRows(record RcVc RepSpec,record AT2RevVc AT2Revr)
BEGIN
  Integer i,rwcnt;
  row AT2RevVc AT2Revrw;
  string 255 tstr;
  val t;
  
  rwcnt = MatRowCnt(AT2Revr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(AT2Revr,i,AT2Revrw);
    OUTFORMFIELD("F_TRANSNR",i+1);          
    OUTFORMFIELD("F_STARTDATUM",AT2Revrw.StartDate);
    OUTFORMFIELD("F_ENDDATE",AT2Revrw.EndDate);
    OUTFORMFIELD("F_BESKRIVNING",AT2Revrw.Comment);
    OUTFORMFIELD("F_COEFFICIENT",AT2Revrw.Coefficient);
    EndFormRow;        
  end;  
  RETURN;
END;

global
procedure DoAT2RevForm(record RcVc RepSpec,record AT2RevVc AT2Revr)
BEGIN
  record CUVc CUr;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  record FormDefVc FDr;
  row FormDefVc FDrw;
    
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoAT2RevForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,AT2Revr.SerNr,FDrw.PrintGroupCode,
                      "",intdocnr,"AT2RevVc",formcode)) then
      begin
        goto LBREAK;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(FDrw.FPCode,MatRowCnt(AT2Revr));
        OUTFORMFIELD("F_SERNR",AT2Revr.SerNr);
        OUTFORMFIELD("F_TRANSDATE",AT2Revr.TransDate);
        OUTFORMFIELD("F_COMMENT",AT2Revr.Description);
        OUTFORMFIELD("F_GRUPP",AT2Revr.AT2GroupCode);
        PrintAT2RevRows(RepSpec,AT2Revr);
        CloseForm;        
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoAT2RevForm:;  
  RETURN;  
END;     
 
