external procedure PrintCurrencyName(string,string);
external procedure PrintCurrencyCode(string,string);
external function Boolean FindFormcode(Integer,Integer);
external function val MulRateToBase2(var string,val,val,val,val,val,val,roundmode);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external procedure GetMonthText(string,Date,var string);
external procedure GetSuppBankSWIFT(string,var string);
external procedure GetSuppBankName(string,var string);
external procedure GetUserName(string,var string);
external procedure ValToText(val,Integer,string,string,var string);
external procedure RussianPaymentNr(LongInt,var string);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external procedure CommonDocumentFields(record RcVc);
external procedure GetLangNr(string,var record LangNrVc);

global
procedure DoCLOut2Form(record RcVc RepSpec,record VIVc VIr)
BEGIN
  string 255 tstr;
  val t;
  record CUVc VEr;
  record UserVc Userr;
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  Boolean printf,langf;
  Integer intdocnr;
  string 30 formcode,langcode;
  
  GetLangNr(VIr.LangCode,LangNrr);      
  if (VIr.OKFlag==0) then begin
//    goto LDoCLOut2Form;//?
  end;
  BlockLoad(SysFormatRec);
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoCLOut2Form;
  end;
  rwcnt = MatRowCnt(FDr);
  langcode = VIr.LangCode;
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(FDr,i,FDrw);
    if (FDrw.LangCode==langcode) then begin
      i = -1;
      langf = true;
    end;
  end;
  if (langf==false) then begin langcode = ""; end;
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(VIr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,VIr.SerNr,FDrw.PrintGroupCode,
                        langcode,intdocnr,"VIVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          CommonDocumentFields(RepSpec);
          OUTFORMFIELD("F_DEBVAL",VIr.CurncyCode);
          OUTFORMFIELD("F_SUMMAMOMS",VIr.CalcVATVal);
          if (FIELDINFORM("F_BASE1BETALA")) then begin
            t = MulRateToBase1(VIr.CurncyCode,VIr.PayVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);
            tstr = ValToString(t,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
            OUTFORMFIELD("F_BASE1BETALA",tstr);
          end;
          if (FIELDINFORM("F_BASE2BETALA")) then begin
            t = MulRateToBase2(VIr.CurncyCode,VIr.PayVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);
            tstr = ValToString(t,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
            OUTFORMFIELD("F_BASE2BETALA",tstr);
          end;
          if (FIELDINFORM("F_RUSPAYNR")) then begin
            RussianPaymentNr(VIr.SerNr,tstr);
            OUTFORMFIELD("F_RUSPAYNR",tstr);
          end;  
          OUTFORMFIELD("F_TRANSDATE",VIr.TransDate);
          OUTFORMFIELD("F_SERNR",VIr.SerNr);
          tstr = ValToString(VIr.PayVal,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
          OUTFORMFIELD("F_ATTBETALA",tstr);
          if (FIELDINFORM("F_ATTBETALATEXT")) then begin
            ValToText(VIr.PayVal,M4Val,VIr.CurncyCode,"",tstr);
            OUTFORMFIELD("F_ATTBETALATEXT",tstr);        
          end;            
          OUTFORMFIELD("F_COMMENT",VIr.Comment);
          OUTFORMFIELD("F_PERSON",VIr.Sign);
          if (FIELDINFORM("F_SALJARNAMN")) then begin
            GetUserName(VIr.Sign,tstr);
            OUTFORMFIELD("F_SALJARNAMN",VIr.Sign);
          end;
          VEr.Code = VIr.VECode;
          if (ReadFirstMain(VEr,1,true)) then begin end;
          OUTFORMFIELD("F_ADRESS",VEr.Name);
          OUTFORMFIELD("F_ADRESS",VEr.BankAccount);
          if (FIELDINFORM("F_BANKNAME")) then begin
            GetSuppBankName(VEr.AccOperator,tstr);
            OUTFORMFIELD("F_BANKNAME",tstr);
          end;  
          if (FIELDINFORM("F_SWIFT")) then begin
            GetSuppBankSWIFT(VEr.AccOperator,tstr);
            OUTFORMFIELD("F_SWIFT",tstr);
          end;  
          OUTFORMFIELD("F_ADDR1",VEr.InvAddr0);
          OUTFORMFIELD("F_ADDR2",VEr.InvAddr1);
          OUTFORMFIELD("F_ADDR3",VEr.InvAddr2);
          OUTFORMFIELD("F_INVADDR3",VEr.InvAddr3);
          OUTFORMFIELD("F_INVADDR4",VEr.InvAddr4);
          OUTFORMFIELD("F_LEVVATNR",VEr.VATNr);
          if (FIELDINFORM("F_SIGNATURE")) then begin
            GetUserName(VIr.Sign,tstr);
            OUTFORMFIELD("F_SIGNATURE",VIr.Sign);
          end;
          OUTFORMFIELD("F_DATEDAY",GetDay(VIr.TransDate));
          OUTFORMFIELD("F_DATEMONTH",GetMonth(VIr.TransDate));
          GetMonthText(VIr.LangCode,VIr.TransDate,tstr);
          OUTFORMFIELD("F_DATEMONTHTEXT",tstr);
          OUTFORMFIELD("F_DATEYEAR",GetYear(VIr.TransDate));
          PrintCurrencyCode("F_VALUTA",VIr.CurncyCode);
          if (FIELDINFORM("F_VALUTANAMN")) then begin
            PrintCurrencyName("F_VALUTANAMN",VIr.CurncyCode);
          end;
          CloseForm;          
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoCLOut2Form:;
  RETURN;  
END;    