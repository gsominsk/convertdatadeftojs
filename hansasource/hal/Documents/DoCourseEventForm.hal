external function Boolean FindFormcode(Integer,Integer);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure GetLangNr(string,var record LangNrVc);
external procedure CommonDocumentFields(record RcVc);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);

procedure PrintCourseEventRows(record RcVc RepSpec,record CourseEventVc CourseEventr,record SysFormatBlock SFb,record LangNrVc LangNrr)
BEGIN
  Integer i,rwcnt;
  row CourseEventVc CourseEventrw;
  string 255 tstr;

  rwcnt = MatRowCnt(CourseEventr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(CourseEventr,i,CourseEventrw);
    OUTFORMFIELD("F_CONTACT",CourseEventrw.ContactCode);
    OUTFORMFIELD("F_NAMN",CourseEventrw.ContactName);
    PrintValue("F_ROWPRICE",CourseEventrw.Price,M4Val,LangNrr,SFb,false);
    OUTFORMFIELD("F_AGREEDDISCOUNT",CourseEventrw.Discount);    
//    OUTFORMFIELD("F_ITEMTYPE",CourseEventrw.Hotel);
    OUTFORMFIELD("F_NIGHTS",CourseEventrw.Nights);    
    OUTFORMFIELD("F_FAKTFAKTURANR",CourseEventrw.InvoiceNo);
    OUTFORMFIELD("F_ARTNR",CourseEventrw.ItemCode);
    PrintValue("F_SENTPRICE",CourseEventrw.HotelPrice,M4Val,LangNrr,SFb,false);
    OUTFORMFIELD("F_REFERENSNUMMER",CourseEventrw.Reference);    
    OUTFORMFIELD("F_BOOKDATE",CourseEventrw.BookingDate);
    OUTFORMFIELD("F_STATUS",CourseEventrw.Status);
    OUTFORMFIELD("F_SOURCE",CourseEventrw.Source);
    OUTFORMFIELD("F_CANCELDATE",CourseEventrw.CancelDate);
    OUTFORMFIELD("F_ITEMTYPE",CourseEventrw.ConfDate);
    OUTFORMFIELD("F_NOTIFYDATE",CourseEventrw.NotifyDate);
    OUTFORMFIELD("F_KUNDNR",CourseEventrw.CustCode);
    PrintValue("F_BELOPP",CourseEventrw.Sum,M4Val,LangNrr,SFb,false);
    EndFormRow;   
  end;
  RETURN;
END;

global
procedure DoCourseEventForm(record RcVc RepSpec,record CourseEventVc CourseEventr)
begin
  record CUVc CUr;
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  record DocVc Docr;
  row DocVc Docrw;
  record LangNrVc LangNrr;
  Boolean printf,langf;
  Integer intdocnr;
  string 30 formcode,langcode;
  record SysFormatBlock SFb;
  
  BlockLoad(SFb);  
  GetLangNr(CourseEventr.LangCode,LangNrr);      
  langcode = CourseEventr.LangCode;
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,2,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoContractForm;
  end;
  rwcnt = MatRowCnt(FDr);
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(FDr,i,FDrw);
    if (FDrw.LangCode==langcode) then begin
      i = -1;
      langf = true;
    end;
  end;
  if (langf==false) then begin langcode = ""; end;
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(0,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,CourseEventr.SerNr,FDrw.PrintGroupCode,
                        langcode,intdocnr,"COVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          CommonDocumentFields(RepSpec);
          NumberofDocumentPages(FDrw.FPCode,MatRowCnt(CourseEventr));

          OUTFORMFIELD("F_COURSECODE",CourseEventr.CourseCode);
          OUTFORMFIELD("F_COURSENAME",CourseEventr.CourseName);
          OUTFORMFIELD("F_EVENTTYPE",CourseEventr.Type);
          OUTFORMFIELD("F_INVITEM",CourseEventr.ItemCode);
          OUTFORMFIELD("F_OBJECT",CourseEventr.Objects);
          OUTFORMFIELD("F_STARTTIME",CourseEventr.StartTime);
          OUTFORMFIELD("F_ENDTIME",CourseEventr.EndTime);
          OUTFORMFIELD("F_TRANSDATUM",CourseEventr.TransDate);
          OUTFORMFIELD("F_ENDDATE",CourseEventr.EndDate);
          OUTFORMFIELD("F_LASTFAKTDATUM",CourseEventr.LastTransferDate);
          OUTFORMFIELD("F_DATUM",CourseEventr.NextConfDate);
          OUTFORMFIELD("F_COMMENT",CourseEventr.Comment);
          OUTFORMFIELD("F_RESSTATUS",CourseEventr.ResStatus);
          OUTFORMFIELD("F_MAXQTY",CourseEventr.MaxPersons);
          OUTFORMFIELD("F_TOTPERSONS",CourseEventr.NoOfPersons);
          OUTFORMFIELD("F_SALESMAN",CourseEventr.SalesMan);
          OUTFORMFIELD("F_SALESGROUP",CourseEventr.SalesGroup);
          OUTFORMFIELD("F_LOCATION",CourseEventr.ConferenceLocation);
          OUTFORMFIELD("F_LOCATIONNAME",CourseEventr.ConferenceLocationName);
          OUTFORMFIELD("F_RESOURCE",CourseEventr.Hotel);
          OUTFORMFIELD("F_RESOURCENAME",CourseEventr.HotelName);
          OUTFORMFIELD("F_PRICELIST",CourseEventr.PLPrice);
          PrintValue("F_PRIS",CourseEventr.Price,M4Val,LangNrr,SFb,false);
          PrintValue("F_RABATT",CourseEventr.Discount,M4Val,LangNrr,SFb,false);
          PrintValue("F_SUMMA",CourseEventr.Sum,M4Val,LangNrr,SFb,false);
          PrintValue("F_SUMOTHER",CourseEventr.InvoicedSum,M4Val,LangNrr,SFb,false);
          OUTFORMFIELD("F_USEDFROM",CourseEventr.BookDate);
//          OUTFORMFIELD("F_INVLEVSATT",CourseEventr.TotalSum4);
          OUTFORMFIELD("F_DURATIONDAYS",CourseEventr.NrOfDays);
          PrintValue("F_VATVAL",CourseEventr.VatSum,M4Val,LangNrr,SFb,false);
          PrintValue("F_VATTOT",CourseEventr.TotalVatSum,M4Val,LangNrr,SFb,false);
          OUTFORMFIELD("F_REGDATUM",CourseEventr.CreatedDate);          
          OUTFORMFIELD("F_HEADER",CourseEventr.HeaderInfo1);
          OUTFORMFIELD("F_HEADER",CourseEventr.HeaderInfo2);
          OUTFORMFIELD("F_HEADER",CourseEventr.HeaderInfo3);          
          OUTFORMFIELD("F_FOOTER",CourseEventr.FooterInfo1);
          OUTFORMFIELD("F_FOOTER",CourseEventr.FooterInfo2);
          OUTFORMFIELD("F_FOOTER",CourseEventr.FooterInfo3);          
          OUTFORMFIELD("F_MINPERSONS",CourseEventr.MinPersons);          
          OUTFORMFIELD("F_GILTIGTDATUM",CourseEventr.LastBookingDate);
          OUTFORMFIELD("F_COUNTRYCODE",CourseEventr.CountryCode);
          OUTFORMFIELD("F_ACTTYPE",CourseEventr.ActType);
          OUTFORMFIELD("F_CURRESPONSIBLEPERSON",CourseEventr.Responsible);

          PrintCourseEventRows(RepSpec,CourseEventr,SFb,LangNrr);

          CloseForm;
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoContractForm:;  
  return;
end;
