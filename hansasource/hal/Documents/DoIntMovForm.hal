external function Boolean FindFormcode(Integer,Integer);
external procedure SetConversionFields(record INVc,val,var val,var val,var val);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external procedure BC39(string,var string);
external procedure ItemBC39(string,var string);
external procedure ItemBCEAN(string,var string);
external procedure ItemBCEAN13(string,var string);
external procedure RussianPaymentNr(LongInt,var string);
external procedure CommonDocumentFields(record RcVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure GetLangNr(string,var record LangNrVc);

procedure PrintInternMovRows(record RcVc RepSpec,record InternMovVc InternMovr,record LangNrVc LangNrr,record SysFormatBlock SysFormatRec,
                             record MainStockBlock MSb,
                             var val totbasprice,var val totinprice,var val totprice,var val totqty,var val totweight,var val totvolume)
BEGIN
  record INVc INr;
  row InternMovVc InternMovrw;
  Integer i,rwcnt,rownr;
  val qtyconv1,qtyconv2,qtyconv3;
  string 255 tstr;
 
  rwcnt = MatRowCnt(InternMovr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(InternMovr,i,InternMovrw);
    INr.Code = InternMovrw.ArtCode;
    if (ReadFirstMain(INr,1,true)) then begin end;
    SetConversionFields(INr,InternMovrw.Quant,qtyconv1,qtyconv2,qtyconv3);      
    OUTFORMFIELD("F_CONVERSION1",qtyconv1);
    OUTFORMFIELD("F_CONVERSION2",qtyconv2);
    OUTFORMFIELD("F_CONVERSION3",qtyconv3);
    PrintValue("F_CONVERSIONVAL1",INr.Conversion1,M4UVal,LangNrr,SysFormatRec,false);
    PrintValue("F_CONVERSIONVAL2",INr.Conversion2,M4UVal,LangNrr,SysFormatRec,false);
    OUTFORMFIELD("F_COMMODITYCODE",INr.EUCodex);
    OUTFORMFIELD("F_ALTERNATIVECODE",INr.AlternativeCode);
    OUTFORMFIELD("F_ENHET",INr.Unittext);
    OUTFORMFIELD("F_SHELFCODE",INr.InvCode);
    PrintValue("F_BASPRIS",INr.UPrice1,M423Val,LangNrr,SysFormatRec,false);
    PrintValue("F_WIDTH",INr.Width,M4Qty,LangNrr,SysFormatRec,false);
    PrintValue("F_HEIGHT",INr.Height,M4Qty,LangNrr,SysFormatRec,false);
    PrintValue("F_DEPTH",INr.Depth,M4Qty,LangNrr,SysFormatRec,false);
    PrintValue("F_WEIGHT",INr.Weight,M4Qty,LangNrr,SysFormatRec,false);
    PrintValue("F_VOLUME",INr.Volume,M4Qty,LangNrr,SysFormatRec,false);
    PrintValue("F_ROWWEIGHT",InternMovrw.Quant*INr.Weight,M4Qty,LangNrr,SysFormatRec,false);
    totweight = totweight + InternMovrw.Quant*INr.Weight;
    PrintValue("F_ROWVOLUME",InternMovrw.Quant*INr.Volume,M4Qty,LangNrr,SysFormatRec,false);
    totvolume = totvolume + InternMovrw.Quant*INr.Volume;
    PrintValue("F_SUMBASPRIS",InternMovrw.Quant*INr.UPrice1,M4Val,LangNrr,SysFormatRec,false);
//    PrintValue("F_SUMFIFO",InternMovrw.FIFORowVal,M45Val,LangNrr,SysFormatRec,false);
    totbasprice = totbasprice + InternMovrw.Quant*INr.UPrice1;
    
    if (FIELDINFORM("F_ARTNRBC39")) then begin
      ItemBC39(InternMovrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBC39",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN")) then begin
      ItemBCEAN(InternMovrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBCEAN",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN13")) then begin
      ItemBCEAN13(InternMovrw.ArtCode,tstr);    
      OUTFORMFIELD("F_ARTNRBCEAN13",tstr);
    end;  
    if (FIELDINFORM("F_SERIENRBC39")) then begin
      BC39(InternMovrw.SerialNr,tstr);    
      OUTFORMFIELD("F_SERIENRBC39",tstr);
    end;  
    OUTFORMFIELD("F_ARTNR",InternMovrw.ArtCode);
    OUTFORMFIELD("F_ARTNR2",InternMovrw.ArtCode);
    OUTFORMFIELD("F_SERIENR",InternMovrw.SerialNr);
    OUTFORMFIELD("F_SPECIFIKATION",InternMovrw.Spec);
    if (MSb.UnitConvCalc==0) then begin
      PrintValue("F_ANTAL2",InternMovrw.Quant*INr.UnitCoefficient,M4UVal,LangNrr,SysFormatRec,false);
    end else begin
      PrintValue("F_ANTAL2",InternMovrw.Quant/INr.UnitCoefficient,M4UVal,LangNrr,SysFormatRec,false);
    end;
    PrintValue("F_ANTAL2",InternMovrw.Quant*INr.UnitCoefficient,M4UVal,LangNrr,SysFormatRec,false);
    totqty = totqty + InternMovrw.Quant;
//    PrintValue("F_PRIS",InternMovrw.NewPrice,M45Val,LangNrr,SysFormatRec,false);
//    totprice = totprice + InternMovrw.Quant*InternMovrw.NewPrice;
//    PrintValue("F_ROWPRICE",InternMovrw.BasePrice,M45Val,LangNrr,SysFormatRec,false);
//    PrintValue("F_BELOPP",InternMovrw.Quant*InternMovrw.BasePrice,M45Val,LangNrr,SysFormatRec,false);
//    totinprice = totinprice + InternMovrw.Quant*InternMovrw.BasePrice;
//    PrintValue("F_SUMBASPRIS",InternMovrw.Quant*InternMovrw.NewPrice,M45Val,LangNrr,SysFormatRec,false);
    if (nonblank(InternMovrw.ArtCode)) then begin
      rownr = rownr + 1;
      OUTFORMFIELD("F_ROWNR",rownr);      
    end;      
    EndFormRow;
  end;
  RETURN;
END;

global
procedure DoInternMovForm(record RcVc RepSpec,record InternMovVc InternMovr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  Integer i,rwcnt;
  record LocationVc FromLocr;
  record LocationVc ToLocr;
  record MainStockBlock MainStockRec;
  val totbasprice,totinprice,totprice,totqty,totweight,totvolume;
  string 255 tstr;
  record MainStockBlock MSb;
  
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
    
  BlockLoad(MainStockRec);
  BlockLoad(SysFormatRec);  
  BlockLoad(MSb);
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto L99;
  end;
  rwcnt = MatRowCnt(FDr);
  GetLangNr("",LangNrr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(InternMovr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,InternMovr.SerNr,FDrw.PrintGroupCode,
                        "",intdocnr,"InternMovVc",formcode)) then
        begin
          goto LBREAKInternMov;
        end;
      end;
    end;
LBREAKInternMov:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(FDrw.FPCode,MatRowCnt(InternMovr));
        if (FIELDINFORM("F_RUSPAYNR")) then begin
          RussianPaymentNr(InternMovr.SerNr,tstr);
          OUTFORMFIELD("F_RUSPAYNR",tstr);
        end;  
        if (blank(InternMovr.FrLocation)) then begin
          FromLocr.Code = MainStockRec.MainStock;
        end else begin
          FromLocr.Code = InternMovr.FrLocation;
        end;
        if (blank(InternMovr.ToLocation)) then begin
          ToLocr.Code = MainStockRec.MainStock;
        end else begin
          ToLocr.Code = InternMovr.ToLocation;
        end;
        if (ReadFirstMain(FromLocr,1,true)) then begin end;
        if (ReadFirstMain(ToLocr,1,true)) then begin end;
        OUTFORMFIELD("F_LEVDATUM",InternMovr.TransDate);
        OUTFORMFIELD("F_DUEDATE",InternMovr.TransDate);
        OUTFORMFIELD("F_TRANSDATE",InternMovr.TransDate);
        OUTFORMFIELD("F_NUMMER",InternMovr.SerNr);
        OUTFORMFIELD("F_LEVNUMMER",InternMovr.SerNr);
        OUTFORMFIELD("F_COMMENT",InternMovr.Comment);
        OUTFORMFIELD("F_FROMLOCATION",InternMovr.FrLocation);
        OUTFORMFIELD("F_TOLOCATION",InternMovr.ToLocation);
        
        OUTFORMFIELD("F_FROMNAME",FromLocr.Name);
        OUTFORMFIELD("F_FROMPHONE",FromLocr.Phone);
        OUTFORMFIELD("F_FROMFAX",FromLocr.Fax);
        OUTFORMFIELD("F_FROMCONTACT",FromLocr.Contact);
        OUTFORMFIELD("F_FROMADRESS",FromLocr.Addr0);
        OUTFORMFIELD("F_FROMADRESS",FromLocr.Addr1);
        OUTFORMFIELD("F_FROMADRESS",FromLocr.Addr2);
        OUTFORMFIELD("F_FROMADRESS",FromLocr.Addr3);
        OUTFORMFIELD("F_FROMADRESS",FromLocr.Addr4);
        OUTFORMFIELD("F_TONAME",ToLocr.Name);
        OUTFORMFIELD("F_TOPHONE",ToLocr.Phone);
        OUTFORMFIELD("F_TOFAX",ToLocr.Fax);
        OUTFORMFIELD("F_TOCONTACT",ToLocr.Contact);
        OUTFORMFIELD("F_TOADRESS",ToLocr.Addr0);
        OUTFORMFIELD("F_TOADRESS",ToLocr.Addr1);
        OUTFORMFIELD("F_TOADRESS",ToLocr.Addr2);
        OUTFORMFIELD("F_TOADRESS",ToLocr.Addr3);
        OUTFORMFIELD("F_TOADRESS",ToLocr.Addr4);        
        PrintInternMovRows(RepSpec,InternMovr,LangNrr,SysFormatRec,MSb,totbasprice,totinprice,totprice,totqty,totweight,totvolume);
//        PrintValue("F_TOTALINPRICE",totinprice,M45Val,LangNrr,SysFormatRec,false);
        PrintValue("F_TOTBASPRIS",totbasprice,M45Val,LangNrr,SysFormatRec,false);
//        PrintValue("F_TOTPRIS",totprice,M45Val,LangNrr,SysFormatRec,false);
        PrintValue("F_TOTQTY",totqty,M45Val,LangNrr,SysFormatRec,false);
        PrintValue("F_TOTVOLUME",totvolume,M4Qty,LangNrr,SysFormatRec,false);
        PrintValue("F_TOTWEIGHT",totweight,M4Qty,LangNrr,SysFormatRec,false);
        CloseForm;
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
L99:;
  RETURN;
END;
