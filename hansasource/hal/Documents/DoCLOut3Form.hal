external procedure PrintCurrencyName(string,string);
external procedure PrintCurrencyCode(string,string);
external function Boolean FindFormcode(Integer,Integer);
external function val MulRateToBase2(var string,val,val,val,val,val,val,roundmode);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external procedure RussianPaymentNr(LongInt,var string);
external procedure GetMonthText(string,Date,var string);
external procedure GetUserName(string,var string);
external procedure ValToText(val,Integer,string,string,var string);
external procedure GetCorspAccNumber(string,var string);
external procedure CommonDocumentFields(record RcVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure GetLangNr(string,var record LangNrVc);

procedure PrintFormRowFields(Array LongInt VIPaySernrs,Array string VIPayComments,
                             Array string VIPayPaymodes,Array val VIPayRecvals,Array Date VIPayInvdates,Integer rowsnr)
BEGIN
  Integer i;
  string 255 tstr;
  
  for (i=0;i<=rowsnr;i=i+1) begin
    OUTFORMFIELD("F_INVOICENR",VIPaySernrs[i]);
    if (VIPaySernrs[i]!=-1) then begin
      OUTFORMFIELD("F_CREDVAL",VIPayRecvals[i]);
    end;
    EndFormRow;
  end;
  RETURN;
END;

procedure PrintFormFields(record CLOutVc CLOutr,record SysFormatBlock SysFormatRec,record LangNrVc LangNrr)
BEGIN
  record UserVc Userr;
  val t;
  string 255 tstr;

  tstr = ValToString(CLOutr.NetVal,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
  OUTFORMFIELD("F_DEBVAL",tstr);
  tstr = ValToString(CLOutr.VATVal,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
  OUTFORMFIELD("F_SUMMAMOMS",tstr);
  if (FIELDINFORM("F_BASE1BETALA")) then begin
    t = MulRateToBase1(CLOutr.CurncyCode,CLOutr.Total,CLOutr.FrRate,CLOutr.ToRateB1,CLOutr.ToRateB2,CLOutr.BaseRate1,CLOutr.BaseRate2,DefaultCurRoundOff);
    tstr = ValToString(t,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
    OUTFORMFIELD("F_BASE1BETALA",tstr);
  end;
  if (FIELDINFORM("F_BASE2BETALA")) then begin
    t = MulRateToBase2(CLOutr.CurncyCode,CLOutr.Total,CLOutr.FrRate,CLOutr.ToRateB1,CLOutr.ToRateB2,CLOutr.BaseRate1,CLOutr.BaseRate2,DefaultCurRoundOff);
    tstr = ValToString(t,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
    OUTFORMFIELD("F_BASE2BETALA",tstr);
  end;
  if (FIELDINFORM("F_RUSPAYNR")) then begin
    RussianPaymentNr(CLOutr.SerNr,tstr);
    OUTFORMFIELD("F_RUSPAYNR",tstr);
  end;  
  if (FIELDINFORM("F_SECACC")) then begin
    GetCorspAccNumber(CLOutr.CorspCode,tstr);
    OUTFORMFIELD("F_SECACC",tstr);
  end;  
  OUTFORMFIELD("F_TRANSDATE",CLOutr.TransDate);
  OUTFORMFIELD("F_SERNR",CLOutr.SerNr);
  tstr = ValToString(CLOutr.Total,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
  OUTFORMFIELD("F_ATTBETALA",tstr);
  if (FIELDINFORM("F_ATTBETALATEXT")) then begin
    ValToText(CLOutr.Total,M4Val,CLOutr.CurncyCode,"",tstr);
    OUTFORMFIELD("F_ATTBETALATEXT",tstr);        
  end;    
  OUTFORMFIELD("F_COMMENT",CLOutr.Comment);
  OUTFORMFIELD("F_PERSON",CLOutr.Person);
  if (FIELDINFORM("F_SALJARNAMN")) then begin
    GetUserName(CLOutr.Person,tstr);
    OUTFORMFIELD("F_SALJARNAMN",tstr);
  end;  
  OUTFORMFIELD("F_ADRESS",CLOutr.CUName);
  OUTFORMFIELD("F_ADDR1",CLOutr.Addr0);
  OUTFORMFIELD("F_ADDR2",CLOutr.Addr1);
  OUTFORMFIELD("F_ADDR3",CLOutr.Addr2);
  OUTFORMFIELD("F_INVADDR3",CLOutr.Addr3);
  OUTFORMFIELD("F_INVADDR4",CLOutr.Addr4);
  if (FIELDINFORM("F_SIGNATURE")) then begin
    GetUserName(CurrentUser,tstr);
    OUTFORMFIELD("F_SIGNATURE",tstr);
  end;  
  Userr.Code = CLOutr.Person;
  if (ReadFirstMain(Userr,1,true)) then begin end;
  OUTFORMFIELD("F_OURREF",Userr.CurOurContact);
  OUTFORMFIELD("F_PERSONACCOUNT",Userr.PersAcc);
  OUTFORMFIELD("F_PERSONID",Userr.IDCode);
  OUTFORMFIELD("F_PERSONSPEC",Userr.Spec);
  OUTFORMFIELD("F_PERSONCOMMENT",Userr.Comment);
  OUTFORMFIELD("F_DATEDAY",GetDay(CLOutr.TransDate));
  OUTFORMFIELD("F_DATEMONTH",GetMonth(CLOutr.TransDate));
  OUTFORMFIELD("F_DATEYEAR",GetYear(CLOutr.TransDate));
  GetMonthText(CLOutr.LangCode,CLOutr.TransDate,tstr);
  OUTFORMFIELD("F_DATEMONTHTEXT",tstr);
  PrintCurrencyCode("F_VALUTA",CLOutr.CurncyCode);
  if (FIELDINFORM("F_VALUTANAMN")) then begin
    PrintCurrencyName("F_VALUTANAMN",CLOutr.CurncyCode);
  end;  
  tstr = ValToString(CLOutr.NetVal,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
  OUTFORMFIELD("F_SUMMA",tstr);
  tstr = ValToString(CLOutr.VATVal,M4Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
  OUTFORMFIELD("F_MOMS",tstr);
  OUTFORMFIELD("F_KUNDNR",CLOutr.CUCode);
  OUTFORMFIELD("F_KUNDNAMN",CLOutr.CUName);
  OUTFORMFIELD("F_REFERENSNUMMER",CLOutr.RefStr);
  RETURN;
END;

global
procedure DoCLOut3Form(record RcVc RepSpec,record PPVc PPr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  record VIVc VIr;
  record UserVc Userr;
  record CLOutVc OPDr;
  row PPVc PPrw;
  row PPVc PP2rw;
  Integer j,k,rownr;
  Integer ovst;
  Boolean VIs,VEs;
  Array string 20 apersons;
  Array LongInt asernrs;
  Array Date aregdates;
  Array string 5 acurncycodes;

  Array LongInt VIPaySernrs;
  Array string 5 VIPayCurencycodes;
  Array val VIPayRecvals;
  Array Date VIPayInvDates;
  Array string 60 VIPayComments;
  Array string 2 VIPayPaymodes;

  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  Integer i,rwcnt,doccnt;
    
  GetLangNr("",LangNrr);
  BlockLoad(SysFormatRec);  
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoCLOut3Form;
  end;
  doccnt = MatRowCnt(FDr);
  rwcnt = MatRowCnt(PPr);
  for (i=0; i<rwcnt; i=i+1) begin
    MatRowGet(PPr,i,PPrw);
    if (PPrw.ovst==0) then begin
      apersons[i] = PPrw.Person;
      asernrs[i] = PPr.SerNr;
      aregdates[i] = PPr.RegDate;
      acurncycodes[i] = PPr.CurncyCode;
    end;
  end;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PPr,i,PPrw);
    if (PPrw.ovst==0) then begin
      if (blank(apersons[i])) then begin goto L77; end;
      for (j=0;j<i;j=j+1) begin
        if (apersons[j]==apersons[i]) then begin goto L77; end;
      end;
      for (j=0;j<rwcnt;j=j+1) begin
        VIPaySernrs[j] = -1;
      end;
      rownr = 0;
      VIPaySernrs[rownr] = asernrs[i];
      VIPayRecvals[rownr] = PPrw.PayVal;
      VIPayCurencycodes[rownr] = acurncycodes[i];
      VIPayInvDates[rownr] = aregdates[i];
      VIPayComments[rownr] = PPrw.Comment;
      VIPayPaymodes[rownr] = PPr.PayMode;
      OPDr.Total = PPrw.PayVal;
      for (j=i+1;j<rwcnt;j=j+1) begin
        if (apersons[j]==apersons[i]) then begin          
          MatRowGet(PPr,j,PP2rw);
          OPDr.Total = OPDr.Total + PP2rw.PayVal;
          rownr = rownr + 1;
          VIPaySernrs[rownr] = asernrs[i];
          VIPayRecvals[rownr] = PPrw.PayVal;
          VIPayCurencycodes[rownr] = acurncycodes[i];
          VIPayInvDates[rownr] = aregdates[i];
          VIPayComments[rownr] = PPrw.Comment;
          VIPayPaymodes[rownr] = PPr.PayMode;
        end;
      end;
      Userr.Code = apersons[i];
      if (ReadFirstMain(Userr,1,true)) then begin end;
      OPDr.SerNr = PPr.SerNr;
      OPDr.TransDate = PPr.TransDate;
      OPDr.OKFlag = PPr.DoneFlag;
      OPDr.ExportedFlag = PPr.ExportedFlag;
      OPDr.Person = PPrw.Person;
      OPDr.CUName = Userr.Comment;
      OPDr.Addr0 = Userr.Spec;
      OPDr.Addr1 = Userr.IDCode;
      OPDr.Comment = PPrw.Comment;
      intdocnr = 1;
      printf = true;
      while (printf) begin  
        formcode = "";
        for (k=doccnt-1;k>=0;k=k-1) begin
          MatRowGet(FDr,k,FDrw);
          if (FindFormcode(PPr.DoneFlag,FDrw.Typ)) then begin 
            if (Getformcode(k,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,PPr.SerNr,FDrw.PrintGroupCode,
                          "",intdocnr,"PPVc",formcode)) then
            begin
              goto LBREAK;
            end;
          end;
        end;
LBREAK:;
        if (nonblank(formcode)) then begin
          if (OpenForm(formcode)) then begin
            CommonDocumentFields(RepSpec);    
//            NumberofDocumentPages(formcode,MatRowCnt(PPr));        
            PrintFormFields(OPDr,SysFormatRec,LangNrr);
            PrintFormRowFields(VIPaySernrs,VIPayComments,VIPayPaymodes,VIPayRecvals,VIPayInvdates,rownr);
            CloseForm;
          end else begin
            printf = false;
            MessageBox(1546,formcode);
          end;
        end else begin
          printf = false;
          if (intdocnr==1) then begin
            MessageBox(1624, " " & USetStr(1623));
          end;
        end;
        intdocnr = intdocnr + 1;
      end;
    end;
L77:; 
  end;
LDoCLOut3Form:;  
  RETURN;
END;