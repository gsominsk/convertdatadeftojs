external procedure PrintCurrencyName(string,string);
external procedure PrintCurrencyCode(string,string);
external procedure PortugueseFormFields(Integer);
external procedure GetFullCurncyRateText(Boolean,var string,val,val,val,val,val);
external procedure GetCurncyComment(string,var string);
external procedure OutAddress(string,string,string,string,string,string,string);
external procedure GetUserName(string,var string);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external procedure GetLangNr(string,var record LangNrVc);
external procedure CommonDocumentFields(record RcVc);
external function Integer NumberofDocumentPages(string,Integer);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external procedure SetRowStyle(record Docvc,string,Integer,string,val);

procedure GetPRClass(string prcode,var string res)
BEGIN
  record PRVc PRr;
  
  res = "";
  PRr.Code = prcode;
  if (ReadFirstMain(PRr,1,true)) then begin
    res = PRr.PRClass;
  end;  
  RETURN;
END;

procedure PrintTBBudget(string formcode,record RcVc RepSpec,record TBBUVc TBBUr)
BEGIN
  record DocVc Docr;
  row TBBUVc TBBUrw;
  record PRVc PRr;
  record CUVc CUr;
  Integer i,rwcnt;
  string 255 tstr,fldarg;
  val t,tcur;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  record SalesGroupVc SGr;

  Docr.Code = formcode;
  if (ReadFirstMain(Docr,1,true)) then begin
  end;
  GetLangNr("",LangNrr);  
  BlockLoad(SysFormatRec);
  PRr.Code = TBBUr.PRCode;
  if (ReadFirstMain(PRr,1,true)) then begin
  end;
  CUr.Code = TBBUr.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
  end;
  if (HasLocalization("PRT")) then begin
    PortugueseFormFields(2754);
  end;  
  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc0);
  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc1);
  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc2);
  OUTFORMFIELD("F_LEDARE",PRr.Leader);  
  OUTFORMFIELD("F_LEDARE2",PRr.Leader2);  
  OUTFORMFIELD("F_LEDARE3",PRr.Leader3);  
  OUTFORMFIELD("F_LEDARE4",PRr.Leader4);  
  OUTFORMFIELD("F_LEDARE5",PRr.Leader5);  
  OUTFORMFIELD("F_NAMN",PRr.LeaderName);  
  OUTFORMFIELD("F_NAMN2",PRr.Leader2Name);  
  OUTFORMFIELD("F_NAMN3",PRr.Leader3Name);  
  OUTFORMFIELD("F_NAMN4",PRr.Leader4Name);  
  OUTFORMFIELD("F_NAMN5",PRr.Leader5Name);  
  OUTFORMFIELD("F_STARTDATUM",PRr.StartDate);
  OUTFORMFIELD("F_ENDDATE",PRr.EndDate);
  OUTFORMFIELD("F_KONTAKT",PRr.Contact);

  OUTFORMFIELD("F_FROMCONTACT",CUr.Person);
  OUTFORMFIELD("F_KUNDFAX",CUr.Fax);
  OUTFORMFIELD("F_ORGCUSTNAME",CUr.Name);
  OutAddress("F_ADRESS",CUr.Name,CUr.InvAddr0,CUr.InvAddr1,CUr.InvAddr2,CUr.InvAddr3,CUr.InvAddr4);
  OUTFORMFIELD("F_FAKTADRESS",CUr.InvAddr0);
  OUTFORMFIELD("F_FAKTADRESS",CUr.InvAddr1);
  OUTFORMFIELD("F_FAKTADRESS",CUr.InvAddr2);
  OUTFORMFIELD("F_FAKTADRESS",CUr.InvAddr3);
  OUTFORMFIELD("F_FAKTADRESS",CUr.InvAddr4);
  OUTFORMFIELD("F_ADRESSATT",CUr.InvAddr2);
  OUTFORMFIELD("F_FROMADRESS",CUr.Name);
  OUTFORMFIELD("F_FROMADRESS",CUr.InvAddr0);
  OUTFORMFIELD("F_FROMADRESS",CUr.InvAddr1);
  OUTFORMFIELD("F_FROMADRESS",CUr.InvAddr2);
  OUTFORMFIELD("F_FROMADRESS",CUr.InvAddr3);
  OUTFORMFIELD("F_FROMADRESS",CUr.InvAddr4);

  OUTFORMFIELD("F_MARKUP",TBBUr.Markup);
  PrintValue("F_TOTSUM",TBBUr.TotSum,M4Val,LangNrr,SysFormatRec,false);

  PrintCurrencyCode("F_VALUTA",TBBUr.CurncyCode);
  if (FIELDINFORM("F_VALUTANAMN")) then begin
    PrintCurrencyName("F_VALUTANAMN",TBBUr.CurncyCode);
  end;  
  GetFullCurncyRateText(true,tstr,TBBUr.FrRate,TBBUr.ToRateB1,TBBUr.ToRateB2,TBBUr.BaseRate1,TBBUr.BaseRate2);         
  OUTFORMFIELD("F_RATE",tstr);

  OUTFORMFIELD("F_SALESGROUP",TBBUr.SalesGroup);  
  SGr.SGroupCode = TBBUr.SalesGroup;
  ReadFirstMain(SGr,1,true);
  OUTFORMFIELD("F_SALESGROUPNAME",SGr.SGroupName);  

  OUTFORMFIELD("F_SALESMAN",TBBUr.SalesMan);  
  GetUserName(TBBUr.SalesMan,tstr);  
  OUTFORMFIELD("F_SALJARNAMN",tstr);
  OUTFORMFIELD("F_PROJECT",TBBUr.PRCode);
  OUTFORMFIELD("F_PROJEKTNUMMER",TBBUr.PRCode);
  OUTFORMFIELD("F_PROJECTNAME",TBBUr.PRName);
  PrintValue("F_TOTOUTQTY",TBBUr.SumOther-TBBUr.SumTime,M4Qty,LangNrr,SysFormatRec,false);
  PrintValue("F_TOTINQTY",TBBUr.SumOther,M4Qty,LangNrr,SysFormatRec,false);
  PrintValue("F_TOTQTY",TBBUr.SumTime,M4Qty,LangNrr,SysFormatRec,false);
  PrintValue("F_SUMTIME",TBBUr.SumTime,M4Val,LangNrr,SysFormatRec,false);
  PrintValue("F_SUMMATERIAL",TBBUr.SumMaterial,M4Val,LangNrr,SysFormatRec,false);
  PrintValue("F_SUMSTOCKED",TBBUr.SumStocked,M4Val,LangNrr,SysFormatRec,false);
  PrintValue("F_SUMOTHER",TBBUr.SumOther,M4Val,LangNrr,SysFormatRec,false);
  PrintValue("F_SUMPRIS",TBBUr.SumTime+TBBUr.SumMaterial+TBBUr.SumStocked+TBBUr.SumOther,M4Val,LangNrr,SysFormatRec,false);

  OUTFORMFIELD("F_TEXT",TBBUr.Text0);
  OUTFORMFIELD("F_TEXT",TBBUr.Text1);
  OUTFORMFIELD("F_TEXT",TBBUr.Text2);
  OUTFORMFIELD("F_TEXT",TBBUr.Text3);
  OUTFORMFIELD("F_TEXT",TBBUr.Text4);
  OUTFORMFIELD("F_TEXT",TBBUr.Text5);
  OUTFORMFIELD("F_TEXT",TBBUr.Text6);
  OUTFORMFIELD("F_TEXT",TBBUr.Text7);
  OUTFORMFIELD("F_TEXT",TBBUr.Text8);
  OUTFORMFIELD("F_TEXT",TBBUr.Text9);
  PrintValue("F_TOTPRIS",TBBUr.SumOther-TBBUr.SumTime,M4Val,LangNrr,SysFormatRec,false);
  OUTFORMFIELD("F_KUNDNR",TBBUr.CustCode);
  GetPRClass(TBBUr.PRCode,tstr);
  OUTFORMFIELD("F_KUNDNR",tstr);
  rwcnt = MatRowCnt(TBBUr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(TBBUr,i,TBBUrw);
    SetRowStyle(Docr,"TBBUVc",TBBUrw.stp,TBBUrw.ArtCode,TBBUrw.Sum);

    OUTFORMFIELD("F_PROJECTSTAGE",TBBUrw.PRStage);
    OUTFORMFIELD("F_PROJECTSTAGESIGN",TBBUrw.PRStageSign);        
    OUTFORMFIELD("F_ROWGP",TBBUrw.GM);        
    
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        OUTFORMFIELD("F_ARTNR",TBBUrw.ArtCode);
	      end;
	    case 3:
	      OUTFORMFIELD("F_ARTNR",TBBUrw.ArtCode);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        OUTFORMFIELD("F_PERSON",TBBUrw.EMCode);
	      end;
	    case 3:
	      OUTFORMFIELD("F_PERSON",TBBUrw.EMCode);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_ANTAL",TBBUrw.Qty,M4Qty,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_ANTAL",TBBUrw.Qty,M4Qty,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_COMMENT",tstr);
	    case 1:
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        if (blank(TBBUrw.ArtCode)) then begin
	          OUTFORMFIELD("F_COMMENT",TBBUrw.Spec);
	        end;
	      end;
	    case 2:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_COMMENT",tstr);
	    case 3:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_COMMENT",tstr);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_SPECIFIKATION",tstr);
	    case 1:
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        if (blank(TBBUrw.ArtCode)) then begin
	          OUTFORMFIELD("F_SPECIFIKATION",TBBUrw.Spec);
	        end;
	      end;
	    case 2:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_SPECIFIKATION",tstr);
	    case 3:
	      tstr = TBBUrw.Comment;
	      if ((TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        tstr = TBBUrw.Spec;
	      end;
	      OUTFORMFIELD("F_SPECIFIKATION",tstr);
	  end;  
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_ROWPRICE",TBBUrw.Price,M423Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_ROWPRICE",TBBUrw.Price,M423Val,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_UNITPRICE",TBBUrw.Price,M423Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_UNITPRICE",TBBUrw.Price,M423Val,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_UNITPRICE",TBBUrw.Discount,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_UNITPRICE",TBBUrw.Discount,M4Val,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode) or (TBBUrw.stp==17)) then begin
	        PrintValue("F_SUMMA",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 1:
	      if (TBBUrw.stp==9) then begin
	        PrintValue("F_SUMMA",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 2:
	      if ((blank(TBBUrw.ArtCode)) and (nonblank(TBBUrw.Comment)) or (TBBUrw.stp==9) or (TBBUrw.stp==17)) then begin
	        PrintValue("F_SUMMA",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_SUMMA",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	  end;  
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode) or (TBBUrw.stp==17)) then begin
	        PrintValue("F_BELOPP",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 1:
	      if ((blank(TBBUrw.ArtCode)) and (nonblank(TBBUrw.Comment))) then begin
	        PrintValue("F_BELOPP",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 2:
	      if ((blank(TBBUrw.ArtCode)) and (nonblank(TBBUrw.Comment)) or (TBBUrw.stp==17)) then begin
	        PrintValue("F_BELOPP",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_BELOPP",TBBUrw.Sum,M4Val,LangNrr,SysFormatRec,false);
	  end;  
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        OUTFORMFIELD("F_SERNR",TBBUrw.Invoiced);
	      end;
	    case 3:
	      OUTFORMFIELD("F_SERNR",TBBUrw.Invoiced);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_COST",TBBUrw.Cost,M423Val,LangNrr,SysFormatRec,false);
	        PrintValue("F_COSTSUMROW",TBBUrw.Cost*TBBUrw.Qty,M423Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_COST",TBBUrw.Cost,M423Val,LangNrr,SysFormatRec,false);
	      PrintValue("F_COSTSUMROW",TBBUrw.Cost*TBBUrw.Qty,M423Val,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        PrintValue("F_TOTALGP",TBBUrw.Cost,M423Val,LangNrr,SysFormatRec,false);
	      end;
	    case 3:
	      PrintValue("F_TOTALGP",TBBUrw.Cost,M423Val,LangNrr,SysFormatRec,false);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (nonblank(TBBUrw.ArtCode)) then begin
	        OUTFORMFIELD("F_INVDATE",TBBUrw.InvAfter);
	      end;
	    case 3:
	      OUTFORMFIELD("F_INVDATE",TBBUrw.InvAfter);
	  end;
	  switch (RepSpec.UsedOnly) begin
	    case 0:
	      if (TBBUrw.stp!=9) then begin
          EndFormRow;
        end;
	    case 1:
	      if (TBBUrw.stp==9) then begin
          EndFormRow;
        end;
	    case 2:
        EndFormRow;
	    case 3:
        EndFormRow;
	  end;
LSKIPTBBURow:;    
  end;
  RETURN;
END;

global
procedure DoTBBudgetForm(record RcVc RepSpec,record TBBUVc TBBUr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  Boolean printf,langf;
  Integer intdocnr;
  string 30 formcode,langcode;

  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoTBBudgetForm;
  end;
  rwcnt = MatRowCnt(FDr);
  langcode = TBBUr.LangCode;
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(FDr,i,FDrw);
    if (FDrw.LangCode==langcode) then begin
      i = -1;
      langf = true;
    end;
  end;
  if (langf==false) then begin langcode = ""; end;
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,-1,FDrw.PrintGroupCode,
                      langcode,intdocnr,"TBBUVc",formcode)) then
      begin
        goto LBREAKTBBudget;
      end;
    end;
LBREAKTBBudget:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(formcode,MatRowCnt(TBBUr));          
        PrintTBBudget(formcode,RepSpec,TBBUr);
        CloseForm;
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoTBBudgetForm:;  
  RETURN;
END;
