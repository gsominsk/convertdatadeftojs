external procedure PrintCurrencyCode(string,string);
external function Boolean GetWHTaxRow(string,var row WHTaxBlock);
external function roundmode SetRoundModeD(Integer);
external procedure CommonDocumentFields(record RcVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);

procedure GetOPRow(LongInt OPNr,Integer oprow,var row OPVc OPrw)
begin
  record OPVc OPr;
  
  ClearRow(OPr,OPrw,1)
  OPr.SerNr = OPNr;
  if (ReadFirstMain(OPr,1,true)) then begin
    if (OPRow<MatRowCnt(OPr)) then begin
      MatRowGet(OPr,oprow,OPrw);
    end;
  end;
  return;
end;

procedure PrintPaymentRowComment(LongInt OPNr,LongInt OPRow)
begin
  record OPVc OPr;
  row OPVc OPrw;
  
  OPr.SerNr = OPNr;
  if (ReadFirstMain(OPr,1,true)) then begin
    if (OPRow >= 0 and OPRow <= MatRowCnt(OPr)) then begin 
      MatRowGet(OPr,OPRow,OPrw);
      OUTFORMFIELD("F_SPECIFIKATION",OPrw.Comment);
    end;
  end;
  return;
end;

function Integer FindDash(string taxcode)
begin
  Integer res,i;
  
  for (i=0;i<len(taxcode);i=i+1) begin
    if ((Mid(taxcode,i,1)=="-") or (Mid(taxcode,i,1)=="/") or (Mid(taxcode,i,1)=="¤")) then begin
      res = i;
      goto LFindDash;
    end;
  end;
LFindDash:;  
  FindDash = res;
  return;
end;

global
procedure PrintWHCertificate(record WHCertificateVc WHCr)
begin
  record CUVc VEr;
  row OPVc OPrw;
  record VIVc VIr;
  Record WHCalcFormVc WHr;
  row WHTaxBlock WHTaxrw;
  Integer pos;
  row WHCertificateVc WHCrw;
  Integer i,rwcnt;
    
  VEr.Code = WHCr.VECode;
  if (ReadFirstMain(VEr,1,true)) then begin 
  end;
  OUTFORMFIELD("F_LEVVATNR",VEr.VATNr);
  OUTFORMFIELD("F_VEREGNUMBER1",VEr.RegNr1);
  OUTFORMFIELD("F_VEREGNUMBER2",VEr.RegNr2);
  OUTFORMFIELD("F_LEVLEVERANTOR",VEr.InvAddr0);
  OUTFORMFIELD("F_LEVLEVERANTOR",VEr.InvAddr1);
  OUTFORMFIELD("F_LEVLEVERANTOR",VEr.InvAddr2);
  OUTFORMFIELD("F_LEVLEVERANTOR",VEr.InvAddr3);
  OUTFORMFIELD("F_LEVLEVERANTOR",VEr.InvAddr4);        

  if (WHCr.OPRow>=0) then begin
    GetOPRow(WHCr.OPNr,WHCr.OPRow,OPrw);
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)) then begin
    end;
    OUTFORMFIELD("F_FAKTURANR",VIr.InvoiceNr);
    PrintPaymentRowComment(WHCr.OPNr,WHCr.OPRow);
  end else begin
    rwcnt = MatRowCnt(WHCr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(WHCr,i,WHCrw);
      GetOPRow(WHCr.OPNr,WHCrw.OPRow,OPrw);
      VIr.SerNr = OPrw.VISerNr;
      ReadFirstMain(VIr,1,true);
      OUTFORMFIELD("F_FAKTURANR",VIr.InvoiceNr);
      OUTFORMFIELD("F_ROWBASE",WHCrw.BaseAmount);
      OUTFORMFIELD("F_BELOPP",WHCrw.Amount);
      EndFormRow;
    end;
  end;
  OUTFORMFIELD("F_TOTALBASE",WHCr.CalcBase);
  OUTFORMFIELD("F_TAXPERCENTAGE",WHCr.TaxPrc);
  
  OUTFORMFIELD("F_TRANSNR",WHCr.SerNr);
  OUTFORMFIELD("F_NUMMER",WHCr.WHTaxSerNr);
  OUTFORMFIELD("F_CALCULATIONFORMULA",WHCr.CalcForm);  
  OUTFORMFIELD("F_PAYMODE",WHCr.PayMode);  
  OUTFORMFIELD("F_LEVERANTOR",WHCr.VECode);
  OUTFORMFIELD("F_LEVNAMN",WHCr.VEName);
  OUTFORMFIELD("F_SALESMAN",WHCr.Sign);
  OUTFORMFIELD("F_SALJARNAMN",WHCr.UserName);
  OUTFORMFIELD("F_COMMENT",WHCr.Comment);
  OUTFORMFIELD("F_UTBETNR",WHCr.OPNr);
  OUTFORMFIELD("F_UTBETDATUM",WHCr.OPTransDate);
  OUTFORMFIELD("F_REFERENSNUMMER",WHCr.OPRefStr);
  OUTFORMFIELD("F_KOMMENTAR",WHCr.OPComment);
  PrintCurrencyCode("F_VALUTA",WHCr.BankCurncy);
  OUTFORMFIELD("F_AMOUNT",Round(WHCr.Amount,SetRoundModeD(2)));
  WHr.PayCode = WHCr.CalcForm;
  if(ReadFirstMain(WHr,1,true)) then begin 
  end; 
  OUTFORMFIELD("F_BESKRIVNING",WHr.Comment);
  GetWHTaxRow(WHCr.WHTax,WHTaxrw);
  pos = FindDash(WHTaxrw.TaxCode);
  OUTFORMFIELD("F_TAXCODE",Left(WHTaxrw.TaxCode,pos));
  OUTFORMFIELD("F_TAXARTICLE",Right(WHTaxrw.TaxCode,len(WHTaxrw.TaxCode)-pos-1));
  OUTFORMFIELD("F_TAXCOMMENT",WHCr.WHTaxComment);
  return;
end;

global
procedure DoWHCertificateForm(record RcVc RepSpec,record WHCertificateVc WHCr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  Integer i,rwcnt;
  
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoWHCertificateForm;
  end;
  rwcnt = MatRowCnt(FDr);
  
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = WHCr.DocName;
    if (blank(formcode)) then begin
      for (i=rwcnt-1;i>=0;i=i-1) begin
        MatRowGet(FDr,i,FDrw);
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,-1,-1,FDrw.PrintGroupCode,
                        "",intdocnr,"WHCertificateVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end else begin
      printf = false;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin  
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        PrintWHCertificate(WHCr);
        CloseForm;        
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    printf = false;
    intdocnr = intdocnr + 1;
  end;
LDoWHCertificateForm:;  
  RETURN;  
END;     
                