external procedure PortugueseFormFields(Integer);
external function Boolean FindFormcode(Integer,Integer);
external procedure CommonDocumentFields(record RcVc);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external procedure GetLangNr(string,var record LangNrVc);

procedure AdrLab(record RcVc RepSpec,record CUVc CUr,record LangNrVc LangNrr,record SysFormatBlock SysFormatRec)
BEGIN
  string 255 tstr,t2;
  Integer i,cp;
  string 1 c;
  
  
  if (HasLocalization("PRT")) then begin
    PortugueseFormFields(1819);
  end;
  OUTFORMFIELD("F_KUNDNR",CUr.Code);
  OUTFORMFIELD("F_NAMN",CUr.Name);
  OUTFORMFIELD("F_ADDR1",CUr.InvAddr0);
  OUTFORMFIELD("F_ADDR2",CUr.InvAddr1);
  OUTFORMFIELD("F_ADDR3",CUr.InvAddr2);
  OUTFORMFIELD("F_INVADDR3",CUr.InvAddr3);
  OUTFORMFIELD("F_INVADDR4",CUr.InvAddr4);
  OUTFORMFIELD("F_LEVADDR1",CUr.DelAddr0);
  OUTFORMFIELD("F_LEVADDR2",CUr.DelAddr1);
  OUTFORMFIELD("F_LEVADDR3",CUr.DelAddr2);
  OUTFORMFIELD("F_LEVADDR4",CUr.DelAddr3);
  OUTFORMFIELD("F_LEVADDR5",CUr.DelAddr4);
  OUTFORMFIELD("F_KONTAKT",CUr.Person);
  OUTFORMFIELD("F_DEPARTMENT",CUr.Department);
  OUTFORMFIELD("F_ANTAL",RepSpec.long1);
  if (nonblank(CUr.DelAddr2)) then begin
    tstr = CUr.DelAddr2;
  end else begin
    if (nonblank(CUr.DelAddr1)) then begin
      tstr = CUr.DelAddr1;
    end else begin
      tstr = CUr.DelAddr0;
    end;
  end;
  cp = 0;
  for (i=0;i<=len(tstr);i=i+1) begin
    c = Mid(tstr,i,1);
    if (asc(c)>asc("9")) then begin
      cp = i;
      goto L30AdrLab;
    end;
  end;
L30AdrLab:;
  for (i=cp;i<=len(tstr);i=i+1) begin
    t2 = t2 & Mid(tstr,i,1);
  end;
  tstr = tstr & t2;
  OUTFORMFIELD("F_ORT",tstr);
  RETURN;  
END;
  
procedure DoAdrLabFormPrint(record RcVc RepSpec,string formcode,string printer)
BEGIN
  record CUVc CUr;
  string 255 frcu,tocu;
  Boolean TrHs;
  LongInt incnt;
  Integer lbls;
  LongInt j;
  Boolean testf;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;

  incnt = 0;
  GetLangNr("",LangNrr);
  BlockLoad(SysFormatRec);
  FormLabelGrid(1,1,1,1);
  frcu = FirstInRange(RepSpec.f1,20);
  tocu = LastInRange(RepSpec.f1,20);
  CUr.Code = frcu;
  TrHs = true;
  while (LoopMain(CUr,1,TrHs)) begin  
    if (TrHs) then begin
      testf = true;
      if (nonblank(tocu)) then begin
        if (CUr.Code>tocu) then begin
          TrHs = false;
        end;
      end;
    end;
    if (CUr.CUType==0) then begin testf = false; end;
    if (TrHs and testf) then begin
      for (j=0;j<RepSpec.long1;j=j+1) begin    
        if (OpenForm(formcode)==false) then begin goto LDoAdrLabFormPrint; end;
        SetPrinter(printer);  
        FormLabelGrid(1,1,1,1);
        AdrLab(RepSpec,CUr,LangNrr,SysFormatRec);
        EndFormLabel;
        CloseForm;
      end;
    end;
  end;
LDoAdrLabFormPrint:;
  RETURN;
END;  

global
procedure DoAdrLabForm(record RcVc Dummyr,record RcVc RepSpec)
BEGIN
  Integer i,rwcnt;  
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  record FormDefVc FDr;
  row FormDefVc FDrw;

  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoAdrLabForm;
  end;
  rwcnt = MatRowCnt(FDr);
  
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,-1,"",
                      "",intdocnr,"",formcode)) then
      begin
        goto LBREAKAdrLab;
      end;
    end;
LBREAKAdrLab:;
    if (nonblank(formcode)) then begin
      DoAdrLabFormPrint(RepSpec,formcode,FDrw.PrintGroupCode);
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoAdrLabForm:;
  RETURN;
END;  

global
procedure AdrLabForm(record RcVc RepSpec)
BEGIN
  Boolean tmpf;
  
  tmpf = PrintDocument(RepSpec,"AdrLabForm",false);
  RETURN;
END;
