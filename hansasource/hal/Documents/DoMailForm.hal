external procedure PortugueseFormFields(Integer);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure CommonDocumentFields(record RcVc);

procedure PrintMailText(record MailVc Mailr)
BEGIN
  Integer i,rwcnt;
  string 255 tstr;
  
  rwcnt = LineTextCnt(Mailr);
  for (i=0;i<rwcnt;i=i+1) begin
    tstr = LineTextGet(Mailr,i);
    OUTFORMFIELD("F_TEXT",tstr);    
    EndFormRow;    
  end;  
  RETURN;
END;

procedure PrintMailRows(record RcVc RepSpec,record MailVc Mailr)
BEGIN
  Integer i,rwcnt;
  row MailVc Mailrw;
  string 255 tstr;
  Boolean printetc;
  
  printetc = false;
  rwcnt = MatRowCnt(Mailr);
  if (rwcnt>5) then begin
    rwcnt = 5;
    printetc = true;
  end;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Mailr,i,Mailrw);
    switch (Mailrw.RowTyp) begin
      case 1:
        tstr = USetStr(8130);
      case 0:
        tstr = USetStr(8131);
      case 2:
        tstr = USetStr(8132);
      case 3:
        tstr = USetStr(8133);
      case 4:
        tstr = USetStr(8134);
    end;    
    OUTFORMFIELD("F_TRANSNR",tstr);
    OUTFORMFIELD("F_ADRESS",Mailrw.AddrCode);
    OUTFORMFIELD("F_TRANSROW",i+1);          
  end;
  if (printetc) then begin
    OUTFORMFIELD("F_TRANSNR","...");
    OUTFORMFIELD("F_ADRESS","..........");
    OUTFORMFIELD("F_TRANSROW",rwcnt);          
  end;
  RETURN;
END;

global
procedure DoMailForm(record RcVc RepSpec,record MailVc Mailr)
BEGIN
  record CUVc CUr;
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
    
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoMailForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,Mailr.SerNr,FDrw.PrintGroupCode,
                      "",intdocnr,"MailVc",formcode)) then
      begin
        goto LBREAK;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          CommonDocumentFields(RepSpec);
          NumberofDocumentPages(FDrw.FPCode,LineTextCnt(Mailr));
          if (HasLocalization("PRT")) then begin
            PortugueseFormFields(20509);
          end;  
          OUTFORMFIELD("F_SERNR",Mailr.SerNr);
          OUTFORMFIELD("F_COMMENT",Mailr.Header);
          OUTFORMFIELD("F_TRANSDATE",Mailr.TransDate);
          OUTFORMFIELD("F_TRANSTID",Mailr.TransTime);
          PrintMailRows(RepSpec,Mailr);
          PrintMailText(Mailr);
          CloseForm;        
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoMailForm:;  
  RETURN;  
END;     
 
