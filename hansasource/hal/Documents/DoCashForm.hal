external procedure PrintCurrencyCode(string,string);
external procedure GetFieldArgument(record DocVc,Integer,var string);
external procedure PrintValueInclZero(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external function Boolean FindFormcode(Integer,Integer);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure GetLangNr(string,var record LangNrVc);
external procedure CommonDocumentFields(record RcVc);

procedure PrintCashEventRows(record RcVc RepSpec,record CashVc Cashr,record DocVc Docr,record LangNrVc LangNrr,record SysFormatBlock SFb)
begin
  Integer i,rwcnt;
  row CashVc Cashrw;

  rwcnt = MatRowCnt(Cashr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Cashr,i,Cashrw);
    OUTFORMFIELD("F_PAYMODE",Cashrw.PMCode);
    PrintCurrencyCode("F_VALUTA",Cashrw.CurncyCodeCode);
    PrintValueInclZero("F_BELOPP",Cashrw.Amount,M4Val,LangNrr,SFb,false);
  end;
  return;
end;

global
procedure DoCashForm(record RcVc RepSpec,record CashVc Cashr)
BEGIN
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  string 255 tstr;
  record LangNrVc LangNrr;
  Boolean printf,langf;
  Integer intdocnr;
  string 30 formcode,langcode;
  record DocVc Docr;
  record SysFormatBlock SFb;
  
  BlockLoad(SFb);
  GetLangNr("",LangNrr);
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoCashForm;
  end;
  rwcnt = MatRowCnt(FDr);
  langcode = "";
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(FDr,i,FDrw);
    if (FDrw.LangCode==langcode) then begin
      i = -1;
      langf = true;
    end;
  end;
  if (langf==false) then begin langcode = ""; end;
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(Cashr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,Cashr.SerNr,FDrw.PrintGroupCode,
                        langcode,intdocnr,"CashVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          CommonDocumentFields(RepSpec);
          NumberofDocumentPages(FDrw.FPCode,MatRowCnt(Cashr));
          Docr.Code = formcode;
          if (ReadFirstMain(Docr,1,true)) then begin
          end;

          OUTFORMFIELD("F_SERNR",Cashr.SerNr);
          OUTFORMFIELD("F_TRANSDATE",Cashr.TransDate);
          OUTFORMFIELD("F_TRANSTID",Cashr.TransTime);
          OUTFORMFIELD("F_DRAWER",Cashr.Drawer);
          OUTFORMFIELD("F_MACHINE",Cashr.MachineName);
          OUTFORMFIELD("F_COMMENT",Cashr.Comment);
          PrintValueInclZero("F_TOTSUM",Cashr.Total,M4Val,LangNrr,SFb,false);
          OUTFORMFIELD("F_SIGNATURE",Cashr.Sign);
          OUTFORMFIELD("F_COSTACCOUNT",Cashr.CredAcc);
          OUTFORMFIELD("F_EVENTTYPE",USetStr(16760+Cashr.Event));
          
          PrintCashEventRows(RepSpec,Cashr,Docr,LangNrr,SFb);
          CloseForm;        
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoCashForm:;  
  return;
end;