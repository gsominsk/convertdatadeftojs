external procedure PrintCurrencyCode(string,string);
external procedure OutAddress(string,string,string,string,string,string,string);
external function Boolean FindFormcode(Integer,Integer);
external function val MulRateToBase2(var string,val,val,val,val,val,val,roundmode);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external function Integer NumberofDocumentPages(string,Integer);
external procedure GetLangNr(string,var record LangNrVc);
external procedure GetUserName(string,var string);
external procedure GetFullCurncyRateText(Boolean,var string,val,val,val,val,val);
external procedure ItemBC39(string,var string);
external procedure GetItemGroup(string,var string);
external procedure GetUnitStr(string,string,var string);
external procedure GetInterestPrc(var string);
external procedure GetPayDealText(string,string,var string);
external procedure GetShipDealText(string,string,var string);
external procedure GetShipModeText(string,string,var string);
external procedure GetContractClassText(string,var string);
external procedure ItemBCEAN(string,var string);
external procedure ItemBCEAN13(string,var string);
external procedure CommonDocumentFields(record RcVc);
external procedure ValToText(val,Integer,string,string,var string);
external procedure COSetFax(record CUVc,record COVc);

procedure PrintContractRows(record RcVc RepSpec,record COVc COr,record LangNrVc LangNrr)
BEGIN
  Integer i,rwcnt;
  row COVc COrw;
  string 255 tstr;
  record SysFormatBlock SysFormatRec;
  
  BlockLoad(SysFormatRec);
  rwcnt = MatRowCnt(COr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(COr,i,COrw);
    if (FIELDINFORM("F_ENHET")) then begin
      GetUnitStr(COrw.ArtCode,COr.LangCode,tstr);
      OUTFORMFIELD("F_ENHET",tstr);
    end;  
    OUTFORMFIELD("F_ARTNR",COrw.ArtCode);
    OUTFORMFIELD("F_ARTNR2",COrw.ArtCode);
    if (FIELDINFORM("F_ARTNRBC39")) then begin
      ItemBC39(COrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBC39",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN")) then begin
      ItemBCEAN(COrw.ArtCode,tstr);
      OUTFORMFIELD("F_ARTNRBCEAN",tstr);
    end;  
    if (FIELDINFORM("F_ARTNRBCEAN13")) then begin
      ItemBCEAN13(COrw.ArtCode,tstr);    
      OUTFORMFIELD("F_ARTNRBCEAN13",tstr);
    end;  
    GetItemGroup(COrw.ArtCode,tstr);
    OUTFORMFIELD("F_ARTGRUPP",tstr);
    tstr = ValToString(COrw.Quant,M4UVal,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);    
    OUTFORMFIELD("F_ANTAL",tstr);
    OUTFORMFIELD("F_SPECIFIKATION",COrw.Spec);
    tstr = ValToString(COrw.Price,M423Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
    OUTFORMFIELD("F_APRIS",tstr);
    OUTFORMFIELD("F_BELOPP",COrw.Sum);
    tstr = ValToString(COrw.vRebate,M41Val,SysFormatRec.thousSep,SysFormatRec.decimalPt,LangNrr.CutDecimals);
    OUTFORMFIELD("F_RABATT",tstr);
    OUTFORMFIELD("F_BASPRIS",COrw.BasePrice);
    OUTFORMFIELD("F_MOMSKOD",COrw.VATCode);
    OUTFORMFIELD("F_PRICEFACTOR",COrw.PriceFactor);
    OUTFORMFIELD("F_DUEDATE",COrw.InvoiceAfter);
    OUTFORMFIELD("F_FAKTURANUMMER",COrw.InvoiceNo);
    OUTFORMFIELD("F_ITEMTYPE",COrw.Type);
    EndFormRow;    
  end;
  RETURN;
END;

global
procedure DoContractForm(record RcVc RepSpec,record COVc COr)
BEGIN
  record CUVc CUr;
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  string 255 tstr;
  val t;
  record DocVc Docr;
  row DocVc Docrw;
  record LangNrVc LangNrr;
  Boolean printf,langf;
  Integer intdocnr;
  string 30 formcode,langcode;
  val factor;
  
  GetLangNr(COr.LangCode,LangNrr);      
  langcode = COr.LangCode;
  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoContractForm;
  end;
  rwcnt = MatRowCnt(FDr);
  for (i=rwcnt-1;i>=0;i=i-1) begin
    MatRowGet(FDr,i,FDrw);
    if (FDrw.LangCode==langcode) then begin
      i = -1;
      langf = true;
    end;
  end;
  if (langf==false) then begin langcode = ""; end;
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (FindFormcode(COr.OKFlag,FDrw.Typ)) then begin 
        if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,COr.SerNr,FDrw.PrintGroupCode,
                        langcode,intdocnr,"COVc",formcode)) then
        begin
          goto LBREAK;
        end;
      end;
    end;
LBREAK:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin  
          RepSpec.sStartDate = COr.startDate;
          RepSpec.sEndDate = COr.endDate;
          CommonDocumentFields(RepSpec);
          NumberofDocumentPages(FDrw.FPCode,MatRowCnt(COr));
          CUr.Code = COr.CustCode;
          if (ReadFirstMain(CUr,1,true)) then begin
          end;
          OUTFORMFIELD("F_DEPARTMENT",COr.Department);
          OUTFORMFIELD("F_KUNDNR",COr.CustCode);
          OUTFORMFIELD("F_KUNDNAMN",COr.Addr0);
          OUTFORMFIELD("F_NUMMER",COr.SerNr);
          OutAddress("F_ADRESS",COr.Addr0,COr.Addr1,COr.Addr2,COr.Addr3,COr.InvAddr3,COr.InvAddr4);
          OUTFORMFIELD("F_ADDR2",COr.Addr1);
          OUTFORMFIELD("F_ADDR3",COr.Addr2);
          OUTFORMFIELD("F_ADDR4",COr.Addr3);
          OUTFORMFIELD("F_INVADDR3",COr.InvAddr3);
          OUTFORMFIELD("F_INVADDR4",COr.InvAddr4);
          OUTFORMFIELD("F_VARREFERENS",COr.OurContact);
          OUTFORMFIELD("F_ERREFERENS",COr.ClientContact);
          OUTFORMFIELD("F_KOMMENTAR",COr.InvComment);
          if (FIELDINFORM("F_SALJARNAMN")) then begin
            GetUserName(COr.SalesMan,tstr);
            OUTFORMFIELD("F_SALJARNAMN",tstr);
          end;  
          OUTFORMFIELD("F_LOCATION",COr.Location);
          OUTFORMFIELD("F_INLEVADRESS",COr.ShipAddr0);
          OUTFORMFIELD("F_INLEVADRESS",COr.ShipAddr1);
          OUTFORMFIELD("F_INLEVADRESS",COr.ShipAddr2);
          OUTFORMFIELD("F_INLEVADRESS",COr.ShipAddr3);
          OUTFORMFIELD("F_INLEVADRESS",COr.DelAddr3);
          OUTFORMFIELD("F_INLEVADRESS",COr.DelAddr4);
          OUTFORMFIELD("F_INVLEVSATT",COr.ShipMode);
          if (FIELDINFORM("F_INVLEVSATTTEXT")) then begin
            GetShipModeText(COr.ShipMode,COr.LangCode,tstr);
            OUTFORMFIELD("F_INVLEVSATTTEXT",tstr);
          end;  
          OUTFORMFIELD("F_INVLEVVILLK",COr.ShipDeal);
          if (FIELDINFORM("F_INVLEVVILLKTEXT")) then begin
            GetShipDealText(COr.ShipDeal,COr.LangCode,tstr);
            OUTFORMFIELD("F_INVLEVVILLKTEXT",tstr);
          end;  
          if (FIELDINFORM("F_VILLKOR")) then begin
            GetPayDealText(COr.PayDeal,COr.LangCode,tstr);
            OUTFORMFIELD("F_VILLKOR",tstr);
          end;  
          PrintCurrencyCode("F_VALUTA",COr.CurncyCode);
          OUTFORMFIELD("F_KONTRAKTSDATUM",COr.CODate);
          OUTFORMFIELD("F_KONTRAKTSDATUMHIJRI",ConvertDate(kCalendarGregorian,COr.CODate,kCalendarHijri));
          OUTFORMFIELD("F_STARTDATUM",COr.startDate);
          OUTFORMFIELD("F_STARTDATUMHIJRI",ConvertDate(kCalendarGregorian,COr.startDate,kCalendarHijri));
          OUTFORMFIELD("F_LASTINVDATE",COr.lastInvDate);
          OUTFORMFIELD("F_ENDDATE",COr.endDate);
          OUTFORMFIELD("F_ENDDATEHIJRI",ConvertDate(kCalendarGregorian,COr.endDate,kCalendarHijri));
          OUTFORMFIELD("F_AVRUNDNING",COr.Sum0);
          OUTFORMFIELD("F_SUMMA",COr.Sum1);
          GetFullCurncyRateText(true,tstr,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2);          
          OUTFORMFIELD("F_RATE",tstr);
          GetFullCurncyRateText(false,tstr,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2);          
          OUTFORMFIELD("F_BASERATE",tstr);
          if (FIELDINFORM("F_AVTALSKLASS")) then begin
            GetContractClassText(COr.ContractClass,tstr);
            OUTFORMFIELD("F_AVTALSKLASS",tstr);
          end;  
          OUTFORMFIELD("F_PERIODLENGTH",COr.perLength);
          OUTFORMFIELD("F_FAKTURADAGAR",COr.invDays);
          GetInterestPrc(tstr);
          OUTFORMFIELD("F_RANTASATS",tstr);
          if (FIELDINFORM("F_PERIODTYPE")) then begin
            if (COr.perType!=0) then begin
              tstr = USetStr(2991);          
            end else begin
              tstr = USetStr(2990);          
            end;
            OUTFORMFIELD("F_PERIODTYPE",tstr);
          end;  
          if (FIELDINFORM("F_FAKTURAPERIOD")) then begin
            if (COr.invDtype!=0) then begin
              tstr = USetStr(2992);          
            end else begin
              tstr = USetStr(2993);          
            end;
            OUTFORMFIELD("F_FAKTURAPERIOD",tstr);
          end;  
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.Addr0;
          end else begin
            tstr = COr.ShipAddr0;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.Addr1;
          end else begin
            tstr = COr.ShipAddr1;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.Addr2;
          end else begin
            tstr = COr.ShipAddr2;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.Addr3;
          end else begin
            tstr = COr.ShipAddr3;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.InvAddr3;
          end else begin
            tstr = COr.DelAddr3;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          if (blank(COr.ShipAddr0)) then begin
            tstr = COr.InvAddr4;
          end else begin
            tstr = COr.DelAddr4;
          end;
          OUTFORMFIELD("F_INLEVADRESS2",tstr);
          
          OUTFORMFIELD("F_SUMMAMOMS",COr.Sum1 - COr.Sum2);
          OUTFORMFIELD("F_BASE1SUMMA",MulRateToBase1(COr.CurncyCode,COr.Sum1,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_BASE2SUMMA",MulRateToBase2(COr.CurncyCode,COr.Sum1,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_SUMMAEJMOMS",COr.Sum2);
          OUTFORMFIELD("F_BASE1MOMS",MulRateToBase1(COr.CurncyCode,COr.Sum3,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_BASE2MOMS",MulRateToBase2(COr.CurncyCode,COr.Sum3,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_TOPAYEXCLFREIGHT",COr.Sum1 - COr.FrPrice + COr.Sum3);
          OUTFORMFIELD("F_MOMS",COr.Sum3);
          OUTFORMFIELD("F_ATTBETALA",COr.Sum4);
          if (FIELDINFORM("F_ATTBETALATEXT")) then begin
            ValToText(COr.Sum4,M4Val,COr.CurncyCode,COr.LangCode,tstr);
            OUTFORMFIELD("F_ATTBETALATEXT",tstr);        
          end;  
          if (FIELDINFORM("F_POSNEGTEXT")) then begin
            if (COr.Sum4<0) then begin
              tstr = USetStr(1567);
            end else begin
              tstr = USetStr(1566);
            end;  
            OUTFORMFIELD("F_POSNEGTEXT",tstr);
          end;  
          OUTFORMFIELD("F_BASE1BETALA",MulRateToBase1(COr.CurncyCode,COr.Sum4,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_BASE2BETALA",MulRateToBase2(COr.CurncyCode,COr.Sum4,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          factor = 1.00;
          if (COr.normalFactor!=0) then begin
            factor = COr.normalFactor;
          end;
          OUTFORMFIELD("F_BASE1BETALAFACTOR",MulRateToBase1(COr.CurncyCode,COr.Sum4*factor,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));
          OUTFORMFIELD("F_BASE2BETALAFACTOR",MulRateToBase2(COr.CurncyCode,COr.Sum4*factor,COr.FrRate,COr.ToRateB1,COr.ToRateB2,COr.BaseRate1,COr.BaseRate2,DefaultCurRoundOff));

          if (FIELDINFORM("F_SUMMAMOMSPLIKTIGT")) then begin
            if (COr.InclVAT>0) then begin
              tstr = COr.Sum4 - COr.Sum3 - COr.Sum2;
            end else begin
              tstr = COr.Sum1 - COr.Sum2;
            end;          
            OUTFORMFIELD("F_SUMMAMOMSPLIKTIGT",tstr);
          end;  
          if (FIELDINFORM("F_SUMMAMOMSPLIKTEJFRAKT")) then begin
            if (COr.InclVAT>0) then begin
              t = COr.Sum1;
            end else begin
              t = COr.Sum1 - COr.Sum2;
            end;
            tstr = t - COr.FrPrice;
            OUTFORMFIELD("F_SUMMAMOMSPLIKTEJFRAKT",tstr);
          end;  
          OUTFORMFIELD("F_FRAKT",COr.FrPrice);
          OUTFORMFIELD("F_SUMFREIGHT",COr.Sum1 - COr.FrPrice);
          OUTFORMFIELD("F_KUNDMOMSNR",CUr.VATNr);
          OUTFORMFIELD("F_KUNDFAX",CUr.Fax);
          rwcnt = MatRowCnt(Docr);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(Docr,i,Docrw);
            if (Docrw.fieldSetNr==0) then begin
              OUTFORMFIELD(Docrw.unitText,Docrw.unitText);
            end;
          end;              
          PrintContractRows(RepSpec,COr,LangNrr);
          COSetFax(CUr,COr);
          CloseForm;
      end else begin
        printf = false;
        MessageBox(1546,formcode);
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoContractForm:;  
  RETURN;
END;
