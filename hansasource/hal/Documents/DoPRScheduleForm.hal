external function Boolean FindFormcode(Integer,Integer);
external procedure GetFieldArgument(record DocVc,Integer,var string);
external procedure Val2ToText(string,val,Integer,string,string,var string);
external procedure PrintValue(string,val,Integer,record LangNrVc,record SysFormatBlock,Boolean);
external procedure GetLangNr(string,var record LangNrVc);
external procedure CommonDocumentFields(record RcVc);
external function Integer NumberofDocumentPages(string,Integer);
external function Boolean Getformcode(Integer,Integer,string,string,string,LongInt,LongInt,string,string,Integer,string,var string);
external procedure GetDateMonthInWords(Date,var string);
external procedure OutAddress(string,string,string,string,string,string,string);

procedure PrintPRSchedule(record RcVc RepSpec,record PRScheduleVc PRScheduler,string formcode)
begin
  record DocVc Docr;
  row PRScheduleVc PRSchedulerw;
  Integer i,rwcnt;
  string 255 tstr,fldarg;
  val t,tcur;
  record SysFormatBlock SysFormatRec;
  record LangNrVc LangNrr;
  record UserVc Userr;
  record PRVc PRr;
  val tothoursperday,tottbbuqty;
  record TBBUVc TBBUr;
  row TBBUVc TBBUrw;

  TBBUr.PRCode = PRScheduler.PRCode;
  ReadFirstMain(TBBUr,1,true);
  GetLangNr("",LangNrr);   
  BlockLoad(SysFormatRec);
  Docr.Code = formcode;
  if (ReadFirstMain(Docr,1,true)) then begin
  end;
  
  PRr.Code = PRScheduler.PRCode;
  if (ReadFirstMain(PRr,1,true)) then begin
  end;

  OUTFORMFIELD("F_DOCTYPE",USetStr(21130));
  OUTFORMFIELD("F_VERSION",PRScheduler.VersionNr); 
  OUTFORMFIELD("F_TRANSDATE",PRScheduler.TransDate); 
  OUTFORMFIELD("F_PROJEKTNUMMER",PRScheduler.PRCode); 
  OUTFORMFIELD("F_PROJECTNAME",PRScheduler.PRName); 
  OUTFORMFIELD("F_KUNDNR",PRScheduler.CustCode); 
  OUTFORMFIELD("F_KUNDNAMN",PRScheduler.CustName); 
  OutAddress("F_ADRESS",PRScheduler.PRName,PRScheduler.InvAddr0,PRScheduler.InvAddr1,PRScheduler.InvAddr2,PRScheduler.InvAddr3,PRScheduler.InvAddr4);
  OUTFORMFIELD("F_CONTACT",PRScheduler.CustContact);  
  OUTFORMFIELD("F_TOTALPERCENTAGE",PRScheduler.TotalPerc);  
  OUTFORMFIELD("F_COMPLETEPERCENTAGE",PRScheduler.CompletePerc);  
  OUTFORMFIELD("F_OUTSTANDINGPERCENTAGE",PRScheduler.OutstandingPerc);  

  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc0);
  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc1);
  OUTFORMFIELD("F_PROJECTTEXT",PRr.Desc2);
  OUTFORMFIELD("F_LEDARE",PRr.Leader);  
  OUTFORMFIELD("F_LEDARE2",PRr.Leader2);  
  OUTFORMFIELD("F_LEDARE3",PRr.Leader3);  
  OUTFORMFIELD("F_LEDARE4",PRr.Leader4);  
  OUTFORMFIELD("F_LEDARE5",PRr.Leader5);  
  OUTFORMFIELD("F_NAMN",PRr.LeaderName);  
  OUTFORMFIELD("F_NAMN2",PRr.Leader2Name);  
  OUTFORMFIELD("F_NAMN3",PRr.Leader3Name);  
  OUTFORMFIELD("F_NAMN4",PRr.Leader4Name);  
  OUTFORMFIELD("F_NAMN5",PRr.Leader5Name);  
  OUTFORMFIELD("F_STARTDATUM",PRr.StartDate);
  OUTFORMFIELD("F_ENDDATE",PRr.EndDate);
  OUTFORMFIELD("F_KONTAKT",PRr.Contact);

  rwcnt = MatRowCnt(PRScheduler);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PRScheduler,i,PRSchedulerw);
    switch (PRSchedulerw.stp) begin
      case 17:
        OUTFORMFIELD("F_PROJECTSTAGENAME",PRSchedulerw.PRStageComment);
      otherwise
        OUTFORMFIELD("F_PROJECTSTAGE",PRSchedulerw.PRStage);
        OUTFORMFIELD("F_PROJECTSTAGENAME",PRSchedulerw.PRStageComment);
        OUTFORMFIELD("F_STARTDATE",PRSchedulerw.StartDate);
        OUTFORMFIELD("F_ROWENDDATE",PRSchedulerw.EndDate);
        OUTFORMFIELD("F_DUEDATE",PRSchedulerw.DueDate);
        OUTFORMFIELD("F_DURATIONDAYS",PRSchedulerw.DurDays);
        OUTFORMFIELD("F_DURATIONHOURS",PRSchedulerw.DurHours);
        OUTFORMFIELD("F_HOURSPERDAY",PRSchedulerw.HoursPerDay);
        OUTFORMFIELD("F_RESPONSIBLEPERSON",PRSchedulerw.Responsible);        
        OUTFORMFIELD("F_COMPLETE",PRSchedulerw.Complete);        
        OUTFORMFIELD("F_PROJECTSTAGESIGN",PRSchedulerw.PRStageSign);        
        tothoursperday = tothoursperday + PRSchedulerw.HoursPerDay;
    end;
    EndFormRow;
  end;
  OUTFORMFIELD("F_HOURSPERDAYTOTAL",tothoursperday); 

  rwcnt = MatRowCnt(TBBUr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(TBBUr,i,TBBUrw);
    tottbbuqty = tottbbuqty + TBBUrw.Qty;
  end;
  OUTFORMFIELD("F_ORDANTAL",tottbbuqty); 
  return;
end;

global
procedure DoPRScheduleForm(record RcVc RepSpec,record PRScheduleVc PRScheduler)
begin
  record FormDefVc FDr;
  row FormDefVc FDrw;
  Integer i,rwcnt;
  Boolean printf;
  Integer intdocnr;
  string 30 formcode;
  string 255 tstr;

  FDr.repname = RepSpec.repname;
  FDr.shortname = RepSpec.shortname;
  if (ReadFirstMain(FDr,1,true)==false) then begin
    MessageBox(1624, " " & USetStr(1623));
    goto LDoPRScheduleForm;
  end;
  rwcnt = MatRowCnt(FDr);
  intdocnr = 1;
  printf = true;
  while (printf) begin  
    formcode = "";
    for (i=rwcnt-1;i>=0;i=i-1) begin
      MatRowGet(FDr,i,FDrw);
      if (Getformcode(i,FDrw.intdocnr,FDrw.FPCode,FDrw.UserGroup,FDrw.LangCode,FDrw.SerNr,PRScheduler.PRCode,FDrw.PrintGroupCode,
                      "",intdocnr,"PRScheduleVc",formcode)) then
      begin
        goto LBREAKPRSchedule;
      end;
    end;
LBREAKPRSchedule:;
    if (nonblank(formcode)) then begin
      if (OpenForm(formcode)) then begin
        CommonDocumentFields(RepSpec);
        NumberofDocumentPages(formcode,MatRowCnt(PRScheduler));
        GetDateMonthInWords(PRScheduler.TransDate,tstr);
        OUTFORMFIELD("F_DATEMONTHINWORDS",tstr);
        PrintPRSchedule(RepSpec,PRScheduler,formcode);
        CloseForm;
      end;
    end else begin
      printf = false;
      if (intdocnr==1) then begin
        MessageBox(1624, " " & USetStr(1623));
      end;
    end;
    intdocnr = intdocnr + 1;
  end;
LDoPRScheduleForm:;  
  return;
end;
