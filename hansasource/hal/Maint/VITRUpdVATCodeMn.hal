external function Integer MakeTransFromVI(record TRVc,record SMVc,record VIVc,Boolean,Boolean);
external function string 20 GetPayPurchVATAcc(string,record VATCodeBlock);
external procedure VIGetVATCodeAccNumbers(string,record APAccBlock,string,Integer,var string,var string);

global
updating procedure VITRUpdVATCodeMn(record RcVc RepSpec)
begin
  record VIVc VIr;
  row VIVc VIrw;
  record OPVc OPr;
  row OPVc OPrw;
  Boolean found,testf;
  record TRVc oldTRr;
  record TRVc TRr;
  row TRVc TRrw;
  record TRVc gTRp;
  row TRVc gTRrw;
  record SMVc gSMr;
  Integer i,rwcnt;
  Integer vi,vrwcnt;
  string 255 svatacc,pvatacc;
  record APAccBlock APb;
  Boolean rowupdf,updf;
  record APPayHistVc APPHr;
  record VATCodeBlock VATCodeb;
  Integer error;

  BlockLoad(APb);
  BlockLoad(VATCodeb);
  found = true;
  VIr.TransDate = RepSpec.sStartDate;
  while (LoopKey("TransDate",VIr,1,found)) begin
    if (VIr.TransDate>RepSpec.sEndDate) then begin
      found = false;
    end;
    if (found) then begin
      testf = true;
      if (VIr.OKFlag==0) then begin testf = false; end;
      if (VIr.Invalid!=0) then begin testf = false; end;
      if (testf) then begin
        TRr.Number = VIr.SerNr;
        TRr.IntYc = VIYc;
        if (ReadFirstMain(TRr,2,true)) then begin
          updf = false;
          RecordCopy(oldTRr,TRr);
          VIr.OKFlag = 0;
          error = MakeTransFromVI(gTRp,gSMr,VIr,false,true);
          vrwcnt = MatRowCnt(gTRp);
          rwcnt = MatRowCnt(TRr);
          for (vi=0;vi<vrwcnt;vi=vi+1) begin
            MatRowGet(gTRp,vi,gTRrw);
            for (i=0;i<rwcnt;i=i+1) begin
              MatRowGet(TRr,i,TRrw);
              rowupdf = false;
              if (TRrw.AccNumber==gTRrw.AccNumber) and (TRrw.DebVal==gTRrw.DebVal) and (TRrw.CredVal==gTRrw.CredVal) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = gTRrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              if (rowupdf) then begin
                MatRowPut(TRr,i,TRrw);
              end;
            end;
          end;
/*          
          vrwcnt = MatRowCnt(VIr);
          rwcnt = MatRowCnt(TRr);
          for (vi=0;vi<vrwcnt;vi=vi+1) begin
            MatRowGet(VIr,vi,VIrw);
            for (i=0;i<rwcnt;i=i+1) begin
              MatRowGet(TRr,i,TRrw);
              rowupdf = false;
              if (TRrw.AccNumber==VIrw.AccNumber) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = VIrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              VIGetVATCodeAccNumbers(VIrw.VATCode,APb,svatacc,pvatacc);
              if (TRrw.AccNumber==svatacc) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = VIrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              if (TRrw.AccNumber==pvatacc) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = VIrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              if (rowupdf) then begin
                MatRowPut(TRr,i,TRrw);
              end;
            end;
          end;
*/          
          if (updf) then begin
            RecordUpdate(oldTRr,TRr,false);
          end;
        end;
      end;
    end;
  end;

  found = true;
  APPHr.TransDate = RepSpec.sStartDate;
  while (LoopKey("TransDate",APPHr,1,found)) begin
    if (APPHr.TransDate>RepSpec.sEndDate) then begin
      found = false;
    end;
    if (found) then begin
      testf = true;
      if (APPHr.FileName!="OPVc") then begin testf = false; end;
      if (testf) then begin
        OPr.SerNr = APPHr.SerNr;
        if (ReadFirstMain(OPr,1,true)) then begin 
        end;
        TRr.Number = APPHr.SerNr;
        TRr.IntYc = OPYc;
        if (ReadFirstMain(TRr,2,true)) then begin
          updf = false;
          RecordCopy(oldTRr,TRr);
          vrwcnt = MatRowCnt(OPr);
          rwcnt = MatRowCnt(TRr);
          for (vi=0;vi<vrwcnt;vi=vi+1) begin
            MatRowGet(OPr,vi,OPrw);
            for (i=0;i<rwcnt;i=i+1) begin
              MatRowGet(TRr,i,TRrw);
              rowupdf = false;
              if (TRrw.AccNumber==APb.OnAccVAT) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = OPrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              pvatacc = GetPayPurchVATAcc(OPrw.VATCode,VATCodeb);
              if (blank(pvatacc)) then begin        
                pvatacc = APb.VATAcc;
              end;
              if (TRrw.AccNumber==pvatacc) then begin
                if (blank(TRrw.VATCode)) then begin
                  TRrw.VATCode = VIrw.VATCode;
                  updf = true;
                  rowupdf = true;
                end;
              end;
              if (rowupdf) then begin
                MatRowPut(TRr,i,TRrw);
              end;
            end;
          end;
          if (updf) then begin
            RecordUpdate(oldTRr,TRr,false);
          end;
        end;
      end;
    end;
  end;
  return;
end;
