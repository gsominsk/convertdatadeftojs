external procedure CheckFlush(var Integer,Integer);

updating procedure FixVIPrepaymentRows(record VIVc VIp,var Integer flushcnt)
begin
  row VIVc VIrw;
  Integer i,rwcnt;
  record APPayHistVc APPayHistr;
  Boolean storef;
  record VIVc oldVIr;
  record OPVc OPp;
  row OPVc OPrw;
  Integer opi,oprwcnt;
  val coeff;
  
  storef = false;
  RecordCopy(oldVIr,VIp);
  rwcnt = MatRowCnt(VIp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(VIp,i,VIrw);
    if (VIrw.stp==6) then begin
      APPayHistr.FileName = "OPVc";
      APPayHistr.VEPNr = VIrw.PrepayNr;
      if (ReadFirstMain(APPayHistr,2,true)) then begin
        OPp.SerNr = APPayHistr.SerNr;
        if (ReadFirstMain(OPp,1,true)) then begin
          oprwcnt = MatRowCnt(OPp);
          for (opi=0;opi<oprwcnt;opi=opi+1) begin
            MatRowGet(OPp,opi,OPrw);
            if (OPrw.PrepayNr==APPayHistr.VEPNr) then begin
              coeff = VIp.PayVal / OPrw.PInvVal;
              goto LFixVIPrep11;           
            end;
          end;
          goto LFixVIPrep99;  
LFixVIPrep11:;
          VIrw.Sum = APPayHistr.BookVal * coeff;
          MatRowPut(VIp,i,VIrw);
          storef = true;
        end;  
      end;  
    end;
  end;
  if (storef) then begin
    if (RecordUpdate(oldVIr,VIp,false)==0) then begin
    end;
    CheckFlush(flushcnt,10);
  end;
LFixVIPrep99:;  
  return;
end;

global
updating procedure FixVIPrepaymentMn(record RcVc RepSpec)
begin
  record VIVc VIp;
  Boolean TrHs;
  LongInt afr,ato;
  Integer flushcnt;
  
  TrHs = true;
  afr = FirstInRange(RepSpec.f1,10);
  ato = LastInRange(RepSpec.f1,10);
  VIp.SerNr = afr;
  while (LoopMain(VIp,1,TrHs)) begin
    if (ato<>-1) then begin
      if (VIp.SerNr>ato) then begin
        TrHs = false;
      end;
    end;
    if (TrHs) then begin
      FixVIPrepaymentRows(VIp,flushcnt);      
    end;  
    MaintTrace(VIp.SerNr);
  end;  
  return;
end;
