external procedure CheckFlush(var Integer,Integer);

// Delete could be made much faster, if we looped over the PersColListVc instead of the respective registers

global
updating procedure AddPersColMn(record RcVc RepSpec)
BEGIN
  record PersColListVc PersColListr;
  record PersColListVc testPersColListr;
  record CUVc CUr;
  string 100 key;
  String 20 fromcust;
  String 20 tocust;
  String 60 class;
  Boolean TrHs,testf;
  Integer flushcnt;

  flushcnt = 0;
  fromcust = FirstInRange(RepSpec.f1,20);
  tocust = LastInRange(RepSpec.f1,20);
  class = FirstInRange(RepSpec.f2,60);
  TrHs = true;
  if (nonblank(RepSpec.Stext)) then begin
/*
    if (RepSpec.ArtMode==1) then begin
      Profiler.Code = fromcust;
      while(LoopKey("GuestActCode",Profiler,1,TrHs)) begin
        if (nonblank(RepSpec.f1)) then begin
          if (Profiler.Code>tocust) then begin
            TrHs = false;
          end;
        end;
        testf = true;
        if (TrHs==false) then begin
          testf = false;
        end;
        if (nonblank(RepSpec.f2)) then begin 
          if(SetInSet(RepSpec.f2, Profiler.Classification)==false) then begin
            testf = false;
          end;  
        end;
        if (nonblank(RepSpec.f3)) then begin 
          if(RepSpec.f3!=Profiler.Newspaper) then begin
            testf = false;
          end;  
        end;
        if (CUr.blockedFlag!=0) then begin
          testf = false;
        end;
        if (testf) then begin
          RecordNew(PersColListr);
          PersColListr.Code = Profiler.Code;
          PersColListr.Name = Profiler.Name;
          PersColListr.PersColCode = RepSpec.Stext;
          PersColListr.FileName = "ProfileVc";
          if (RepSpec.flags[1]==0) then begin
            if (RecordStore(PersColListr,false)) then begin end;
            CheckFlush(flushcnt,10);
          end else begin
            if (ReadFirstMain(PersColListr,4,true)) then begin
              RecordRemove(PersColListr);
              CheckFlush(flushcnt,10);
            end;
          end;
        end;
      end;
    end;
*/
    if (RepSpec.ArtMode==2) then begin
      CUr.Code = fromcust;
      while(LoopMain(CUr,1,TrHs)) begin
        if (nonblank(RepSpec.f1)) then begin
          if (CUr.Code>tocust) then begin
            TrHs = false;
          end;
        end;
        testf = true;
        if (TrHs==false) then begin
          testf = false;
        end;
        if (nonblank(RepSpec.f2)) then begin 
          if(SetInSet(RepSpec.f2, CUr.Classification)==false) then begin
            testf = false;
          end;  
        end;
        if (nonblank(RepSpec.FirstAcc)) then begin 
          if (CUr.CustCat!=RepSpec.FirstAcc) then begin testf = false; end;
        end;
        if (CUr.CUType==0) then begin testf = false; end;
        if (CUr.blockedFlag!=0) then begin
          testf = false;
        end;
        if (testf) then begin
          RecordNew(PersColListr);
          PersColListr.Code = CUr.Code;
          if (nonblank(CUr.Person)) then begin
            PersColListr.Name = CUr.Person;
          end else begin
            PersColListr.Name = CUr.Name;
          end;
          PersColListr.PersColCode = RepSpec.Stext;
          PersColListr.FileName = "CUVc";
          if (RepSpec.flags[1]==0) then begin
            if (RecordStore(PersColListr,false)) then begin end;
            CheckFlush(flushcnt,10);
          end else begin
            if (ReadFirstMain(PersColListr,4,true)) then begin
              RecordRemove(PersColListr);
              CheckFlush(flushcnt,10);
            end;
          end;
        end;
      end;
    end;
    if (RepSpec.ArtMode==3) then begin
      CUr.Code = fromcust;
      while(LoopMain(CUr,1,TrHs)) begin
        if (nonblank(RepSpec.f1)) then begin
          if (CUr.Code>tocust) then begin
            TrHs = false;
          end;
        end;
        testf = true;
        if (TrHs==false) then begin
          testf = false;
        end;
        if (nonblank(RepSpec.f2)) then begin 
          if(SetInSet(RepSpec.f2, CUr.Classification)==false) then begin
            testf = false;
          end;  
        end;
        if (CUr.GuestType!=0) or (CUr.VEType!=0) or (CUr.CUType!=0) then begin testf = false; end;
        if (CUr.blockedFlag!=0) then begin
          testf = false;
        end;
        if (testf) then begin
          RecordNew(PersColListr);
          PersColListr.Code = CUr.Code;
          if (nonblank(CUr.Person)) then begin
            PersColListr.Name = CUr.Person;
          end else begin
            PersColListr.Name = CUr.Name;
          end;
          PersColListr.PersColCode = RepSpec.Stext;
          PersColListr.FileName = "CUVc";
          if (RepSpec.flags[1]==0) then begin
            if (RecordStore(PersColListr,false)) then begin end;
            CheckFlush(flushcnt,10);
          end else begin
            if (ReadFirstMain(PersColListr,4,true)) then begin
              RecordRemove(PersColListr);
              CheckFlush(flushcnt,10);
            end;
          end;
        end;
      end;
    end;

/*
    if (RepSpec.ArtMode==3) then begin
      Contactr.Company = fromcust;
      while(LoopKey("CompKey",Contactr,1,TrHs)) begin
        if (nonblank(RepSpec.f1)) then begin
          if (Contactr.Company>tocust) then begin
            TrHs = false;
          end;
        end;
        testf = true;
        if (TrHs==false) then begin
          testf = false;
        end;
        if (nonblank(RepSpec.f2)) then begin 
          if(SetInSet(RepSpec.f2, Contactr.Classification)==false) then begin
            testf = false;
          end;  
        end;
        if (testf) then begin
          RecordNew(PersColListr);
          PersColListr.Code = Contactr.Company;
          PersColListr.Name = Contactr.Name;
          PersColListr.PersColCode = RepSpec.Stext;
          PersColListr.FileName = "ContactVc";
          if (RepSpec.flags[1]==0) then begin
            RecordCopy(testPersColListr,PersColListr);
            testPersColListr.FileName = "CUVc";
            if (ReadFirstMain(testPersColListr,4,true)==false) then begin
              if (RecordStore(PersColListr,false)) then begin end;
              CheckFlush(flushcnt,10);
            end;
          end else begin
            if (ReadFirstMain(PersColListr,4,true)) then begin
              RecordRemove(PersColListr);
              CheckFlush(flushcnt,10);
            end;
          end;
        end;
      end;
    end;
*/
    if (RepSpec.ArtMode==4) then begin
      key = "Code:" & RepSpec.f1;
      TrHs = true;
      while (LoopKey(key,PersColListr,1,TrHs)) begin
        RecordCopy(testPersColListr,PersColListr);
        testPersColListr.PersColCode = RepSpec.Stext;
        if (RepSpec.flags[1]==0) then begin
          if (RecordStore(testPersColListr,false)) then begin end;
          CheckFlush(flushcnt,10);
        end else begin
          if (ReadFirstMain(testPersColListr,4,true)) then begin
            RecordRemove(testPersColListr);
            CheckFlush(flushcnt,10);
          end;
        end;
      end;
    end;
    if (RepSpec.ArtMode==5) then begin
      CUr.Code = fromcust;
      while(LoopMain(CUr,1,TrHs)) begin
        if (nonblank(RepSpec.f1)) then begin
          if (CUr.Code>tocust) then begin
            TrHs = false;
          end;
        end;
        testf = true;
        if (TrHs==false) then begin
          testf = false;
        end;
        if (nonblank(RepSpec.f2)) then begin 
          if(SetInSet(RepSpec.f2, CUr.Classification)==false) then begin
            testf = false;
          end;  
        end;
        if (nonblank(RepSpec.FirstAcc)) then begin 
          if (CUr.VECat!=RepSpec.FirstAcc) then begin testf = false; end;
        end;
        if (CUr.VEType==0) then begin testf = false; end;
        if (CUr.blockedFlag!=0) then begin
          testf = false;
        end;
        if (testf) then begin
          RecordNew(PersColListr);
          PersColListr.Code = CUr.Code;
          if (nonblank(CUr.Person)) then begin
            PersColListr.Name = CUr.Person;
          end else begin
            PersColListr.Name = CUr.Name;
          end;
          PersColListr.PersColCode = RepSpec.Stext;
          PersColListr.FileName = "CUVc";
          if (RepSpec.flags[1]==0) then begin
            if (RecordStore(PersColListr,false)) then begin end;
            CheckFlush(flushcnt,10);
          end else begin
            if (ReadFirstMain(PersColListr,4,true)) then begin
              RecordRemove(PersColListr);
              CheckFlush(flushcnt,10);
            end;
          end;
        end;
      end;
    end;    
  end;
  RETURN;
END;
