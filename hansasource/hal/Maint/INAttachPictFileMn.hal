external procedure ExtractObj(string,var Integer,var string);

/*
the code below is amazingly slow
global
updating procedure INAttachPictFileMn(record RcVc RepSpec)
begin
  Boolean found,testf;
  record INVc INr;
  record INVc oldINr;
  string 20 frin,toin;
  Integer cnt;
  String 100 fname;
  LongInt longvar;
  Integer i,numoffiles;
  
  if (blank(RepSpec.f1)) then begin
    frin = "00000000";
    toin = "ZZZZZZZZ";
  end;
  frin = FirstInRange(RepSpec.f1,20);
  toin = LastInRange(RepSpec.f1,20);
  INr.Code = frin;
  found = true;
  while (LoopMain(INr,1,found)) begin 
    if (nonblank(RepSpec.f1)) then begin 
      if (INr.Code>toin) then begin found = false; end;
    end;
    if (found) then begin
      if (blank(INr.AlternativeCode)) then begin
        goto LINAttachPictFileMn2;
      end;
      numoffiles = CountFilesInDir("Pictures");
      for (i=0;i<numoffiles;i=i+1) begin
        testf = true;
        fname = GetFileNameInDir("Pictures",i);
        switch (RepSpec.flags[0]) begin
          case 0:
            if ((Left(fname,Len(INr.Code)+1) == INr.Code & ".")==false) then begin
              testf = false;
            end;
          case 1:
            if ((Left(fname,Len(INr.AlternativeCode)+1) == INr.AlternativeCode & ".")==false) then begin
              testf = false;
            end;
        end;
        if (testf) then begin
          if (RECORDLINKFILE("Pictures/" & fname,0,INr,CurrentCompany)) then begin
//LogText(0,"File attached for Item " &  INr.Code &": " & fname);
          end;
          goto LINAttachPictFileMn2;
        end;
      end;
      
    end;
LINAttachPictFileMn2:;
  end;
LINAttachPictFileMn:;  
  return;
end;
*/

global
updating procedure INAttachPictFileMn(record RcVc RepSpec)
begin
  Boolean found,testf;
  record INVc INr;
  record INVc oldINr;
  string 20 frin,toin;
  Integer cnt;
  String 100 fname,filename;
  LongInt longvar;
  Integer i,numoffiles;
  Integer pos;
  string 255 ext;
  
  if (blank(RepSpec.f2)) then begin
    goto LINAttachPictFileMn;
  end;
  if (blank(RepSpec.f1)) then begin
    frin = "00000000";
    toin = "ZZZZZZZZ";
  end;
  frin = FirstInRange(RepSpec.f1,20);
  toin = LastInRange(RepSpec.f1,20);
  INr.Code = frin;
  found = true;
  while (LoopMain(INr,1,found)) begin 
    if (nonblank(RepSpec.f1)) then begin 
      if (INr.Code>toin) then begin found = false; end;
    end;
    if (found) then begin
      switch (RepSpec.flags[0]) begin
        case 0:
          fname = INr.Code & ".";
          pos = 0;
          ExtractObj(RepSpec.f2,pos,ext);
          while (nonblank(ext)) begin
            filename = "Pictures/" & fname & ext;
            if (FileExists(filename)) then begin
              if (RECORDLINKFILE(filename,0,INr,CurrentCompany)) then begin
LogText(0,"File attached for Item " &  INr.Code &": " & fname);
              end;
            end;
            ExtractObj(RepSpec.f2,pos,ext);
          end;
        case 1:
          if (blank(INr.AlternativeCode)) then begin
            goto LINAttachPictFileMn2;
          end;
          fname = INr.AlternativeCode & ".";
          pos = 0;
          ExtractObj(RepSpec.f2,pos,ext);
          while (nonblank(ext)) begin
            filename = "Pictures/" & fname & ext;
            if (FileExists(filename)) then begin
              if (RECORDLINKFILE(filename,0,INr,CurrentCompany)) then begin
LogText(0,"File attached for Item " &  INr.Code &": " & fname);
              end;
            end;
            ExtractObj(RepSpec.f2,pos,ext);
          end;
      end;
    end;
LINAttachPictFileMn2:;
  end;
LINAttachPictFileMn:;  
  return;
end;
