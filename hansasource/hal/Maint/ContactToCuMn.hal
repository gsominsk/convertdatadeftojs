external function Boolean GetNextCustNr(var string);
external procedure NextM4Number(string,var string);
external procedure CheckFlush(var Integer,Integer);

updating procedure MoveAttachments(record ContactVc Contactr,record CUVc CUr)
begin
  record RLinkVc RLr;
  record RLinkVc RL2r;
  Boolean foundf;
  string 255 tstr;
  Integer compno;

  compno = CurrentCompany;
  tstr = BuildRecordIdStr(Contactr,compno);
LUpdateAllActLinksOne:;
  foundf = true;
  ResetLoop(RLr);
  RLr.ToRecidStr = tstr;
  while (LoopKey("ToRecKey",RLr,1,foundf)) begin
    if (RLr.ToRecidStr!=tstr) then begin
      foundf = false;
    end;
    if (foundf) then begin
      RecordCopy(RL2r,RLr);
      RLr.ToRecidStr = BuildRecordIdStr(CUr,compno);
      if (RecordUpdate(RL2r,RLr,false)==0) then begin
        goto LUpdateAllActLinksOne;
      end;
    end;
  end;
  tstr = BuildRecordIdStr(Contactr,compno);
LUpdateAllActLinksTwo:;
  foundf = true;
  ResetLoop(RLr);
  RLr.FromRecidStr = tstr;
  while (LoopMain(RLr,1,foundf)) begin
    if (RLr.FromRecidStr!=tstr) then begin
      foundf = false;
    end;
    if (foundf) then begin
      RecordCopy(RL2r,RLr);
      RLr.FromRecidStr = BuildRecordIdStr(CUr,compno);
      if (RecordUpdate(RL2r,RLr,false)==0) then begin
        goto LUpdateAllActLinksTwo;
      end;
    end;
  end;
  return;
end;

global
updating procedure ContactToCuMn(record RcVc RepSpec)
BEGIN
  record CUVc CUr;
  record ContactVc Contactr;
  record ContactVc oldContactr;
  record ContactRelVc ContactRelr;
  Boolean TrHs,testf;
  Boolean corelf,cumovedf,movingfailedf;
  string 255 lastcunr;
  Integer flushcnt;
  
  TrHs = true;
  if (nonblank(RepSpec.f1)) then begin
    lastcunr = RepSpec.f1;
  end else begin
    if (GetNextCustNr(lastcunr)) then begin end;
  end;
  Contactr.Name = "";
  while (LoopMain(Contactr,1,TrHs)) begin
    CUr.Code = lastcunr;
    if (ReadFirstMain(CUr,1,true)) then begin
      TrHs = false;
      movingfailedf = true;
    end;
    testf = TrHs;
/*
    if (Contactr.Closed!=0) then begin
      testf = false;
    end;
*/
    if (testf) then begin
      CUr.Code = Contactr.Company;
      RecordNew(ContactRelr);
      if (ReadFirstMain(CUr,1,true)==false) then begin
        corelf = false;
      end else begin
        ContactRelr.CustCode = CUr.Code;
        ContactRelr.CustName = CUr.Name;
        corelf = true;
      end;
      RecordNew(CUr);

      CUr.Code = lastcunr;
      CUr.Name = Contactr.Name;
      CUr.InvAddr0 = Contactr.Adress0;
      CUr.InvAddr1 = Contactr.Adress1;
      CUr.InvAddr2 = Contactr.Adress2;
      CUr.InvAddr3 = Contactr.Adress3;
      CUr.InvAddr4 = Contactr.Adress4;
      CUr.Phone = Contactr.Phone;
      CUr.Fax = Contactr.Fax;
      CUr.eMail = Contactr.Email;
      CUr.Comment0 = Contactr.Comment0;
      CUr.Comment1 = Contactr.Comment1;
      CUr.Comment2 = Contactr.Comment2;
      CUr.Title = Contactr.Title;
      CUr.Department = Contactr.Department;
      CUr.JobDesc = Contactr.JobDesc;
      CUr.Classification = Contactr.Classification;
      CUr.Mobile = Contactr.Mobile;
      CUr.AltPhone = Contactr.AltPhone;
      CUr.BirthDate = Contactr.BirthDate;
      CUr.Salutation1 = Contactr.Salutation1;
      CUr.Salutation2 = Contactr.Salutation2;
      CUr.Salutation3 = Contactr.Salutation3;
      CUr.SkypeName = Contactr.SkypeName;
      CUr.NoMailPosting = Contactr.NoMailPosting;
      CUr.NoLetterPosting = Contactr.NoLetterPosting;
      CUr.CustCat = "";
      CUr.CustCat = RepSpec.FirstAcc;
      CUr.RegNr1 = "";
      CUr.RegNr2 = "";
      CUr.VATNr = "";
      CUr.CustType = 1;
      CUr.CUType = 0;
      CUr.VEType = 0;
      CUr.GuestType = 0;
      CUr.Person = "";
      CUr.blockedFlag = Contactr.Closed;
      cumovedf = RecordStore(CUr,true);
      MoveAttachments(Contactr,CUr);
      ContactRelr.ContactCode = CUr.Code;
      ContactRelr.ContactName = CUr.Name;
      ContactRelr.ContactPhone = CUr.Phone;
      ContactRelr.ContactMobile = CUr.Mobile;
      ContactRelr.ContacteMail = CUr.eMail;
      ContactRelr.ContactTitle = CUr.Title;
      ContactRelr.ContactAltPhone = CUr.AltPhone;
      ContactRelr.Invalid = CUr.blockedFlag;
      ContactRelr.JobTitle = CUr.JobDesc;
      if (corelf) then begin
        if (RecordStore(ContactRelr,true)) then begin end;
      end;

      if (cumovedf) then begin
        if (RepSpec.ArtMode!=0) then begin
          RecordDelete(Contactr);
          StepBack(Contactr);
        end else begin
          RecordCopy(oldContactr,Contactr);
          Contactr.Closed = 1;
          if (RecordUpdate(oldContactr,Contactr,false)==0) then begin end;
        end;
      end else begin
        movingfailedf = true;
      end;
      CheckFlush(flushcnt,10);
      NextM4Number(lastcunr,lastcunr);
    end;
  end;
/*  
  if (RepSpec.ArtMode!=0) then begin
    ResetLoop(Contactr);
    Contactr.Name = "";
    while (LoopMain(Contactr,1,TrHs)) begin
      if (Contactr.Closed!=0) then begin
        RecordDelete(Contactr);
        StepBack(Contactr);
        CheckFlush(flushcnt,20);
      end;
    end;
  end;
*/  
  if (movingfailedf) then begin
    MessageBox(20924," " & USetStr(1764));
  end;
  RETURN;
END;