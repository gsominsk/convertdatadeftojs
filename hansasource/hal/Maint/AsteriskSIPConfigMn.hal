external function string 255 MakeTrailingSlash(string);
external function string 255 SoundFileName(string,Integer);
external updating procedure GenerateAsteriskConfigFiles(record PBXConnectionVc,Boolean);
external procedure MoveAsteriskFileInPlace(string,string,string);
external procedure MoveAsteriskSoundFileInPlace(record PBXConnectionVc,string,string);
external function string 255 AsteriskConfigBaseDir(record PBXConnectionVc,Boolean);
external procedure  MoveAsteriskDirInPlace(string,string);
external procedure MoveAsteriskSoundDirInPlace(record PBXConnectionVc,string,string);

updating procedure SendAsteriskFilesToServer(record PBXConnectionVc PBXCr)
begin
  record PBXSoundVc PBXSr;
  record Attach2Vc Attach2r;
  record RLinkVc RLr;
  Integer filenr;
  string 255 fname,basedir,remsounddir;

  basedir = AsteriskConfigBaseDir(PBXCr,false);
  MoveAsteriskDirInPlace(PBXCr.Code,basedir & "etc/asterisk/");

  remsounddir = MakeTrailingSlash(PBXCr.RemoteConfigDir);
  remsounddir = left(remsounddir,len(remsounddir)-len("etc/asterisk/"));
  while (LoopMain(PBXSr,1,true)) begin
    if (PBXSr.Event==kAsteriskEventSoundMusicOnHold) then begin
      MoveAsteriskSoundDirInPlace(PBXCr,basedir & "var/lib/asterisk/moh/HW/",remsounddir & "var/lib/asterisk/moh/HW/");
    end else begin
      MoveAsteriskSoundDirInPlace(PBXCr,basedir & "var/lib/asterisk/sounds/",remsounddir & "var/lib/asterisk/sounds/");
    end;
  end;
end;

global
updating procedure AsteriskSIPConfigMn(record RcVc RepSpec)
begin
  record PBXConnectionVc PBXCr;
  Time t;

  PBXCr.Code = RepSpec.f1;
  if (ReadFirstMain(PBXCr,1,true)) then begin
    CreateFolderHierarchy(AsteriskConfigBaseDir(PBXCr,false) & "etc/asterisk/");
    GenerateAsteriskConfigFiles(PBXCr,false);
    if (RepSpec.flags[0]<>0) then begin
      t = CurrentTime;
      t.second = t.second + 20;
      SendAsteriskFilesToServer(PBXCr);
      NewTimedTask("ReloadAsterisk","Reload Asterisk with delay","ReloadAsterisk",":" & RepSpec.f1 & ":",CurrentDate,t,CurrentTime,"");
    end;
  end;
  return;
end;
