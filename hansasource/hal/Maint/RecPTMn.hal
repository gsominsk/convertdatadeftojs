external procedure CheckFlush(var Integer,Integer);
external updating procedure TSCreateTBIV(record TSVc,Integer,row TSVc,Boolean,Integer);

global
updating procedure RebPTMn(record RcVc RepSpec)
begin
  record TBIVVc TBIVr;
  record TSVc TSr;
  row TSVc TSrw;
  Boolean found,testf,missing,found2,maketrans;
  LongInt frpr,topr;
  LongInt i,rwcnt;
  LongInt LLoop1,LLoop2;
  record GeneralOptionBlock GenOptr;
  Integer flushcnt;
  
  BlockLoad(GenOptr);
  frpr = FirstInRange(RepSpec.f2,10);
  topr = LastInRange(RepSpec.f2,10);
  found = true;
  TSr.SerNr = frpr;
  LLoop1 = -1;
  found = true;
  while (LoopMain(TSr,1,found)) begin
    if (topr<>-1) then begin
      if (TSr.SerNr>topr) then begin 
        found = false;
      end;
    end;
    if (found) then begin
      testf = true;
      if (TSr.OKFlag==0) then begin
        testf = false;
      end;
      if (testf==true) then begin
        rwcnt = MatRowCnt(TSr);
        for (i=0; i<rwcnt;i=i+1) begin
          missing = false;
          MatRowGet(TSr,i,TSrw);
          TBIVr.SerNr = TSr.SerNr;
          TBIVr.oVc = 1;
          TBIVr.Row = i;
          TBIVr.EMCode = TSrw.EMCode;
          TBIVr.PRCode = TSrw.PRCode;
          TBIVr.ArtCode = TSrw.ArtCode;
          if (ReadFirstMain(TBIVr,6,true)) then begin
            if ((TBIVr.PRCode<>TSrw.PRCode) or (TBIVr.oVc!=1) or (TBIVr.SerNr!=TSr.SerNr) or
                (TBIVr.EMCode<>TSrw.EMCode) or (TBIVr.Row!=i) or (TBIVr.ArtCode<>TSrw.ArtCode)) then begin
              missing = true;
            end;
          end else begin
            missing = true;
          end;
          if (missing==true) then begin
            maketrans = true;
            switch (RepSpec.ArtMode) begin
              case 1:
                found2 = true;
                TBIVr.oVc = 1;
                TBIVr.PRCode = TSrw.PRCode;
                TBIVr.ArtCode = TSrw.ArtCode;
                found2 = true;
                while (LoopKey("ArtCode",TBIVr,3,found2)) begin
                  if ((TBIVr.PRCode==TSrw.PRCode) and (TBIVr.oVc==1) and
                      (TBIVr.ArtCode==TBIVr.ArtCode) and (TBIVr.Qty==TSrw.Qty) and 
                      (TBIVr.EMCode==TSrw.EMCode)) then begin
                    maketrans = false;
                    if (RepSpec.flags[1]==0) then begin
                      if (TBIVr.SerNr<>-1) then begin
                        maketrans = true;
                      end else begin
                        goto LRebPTMn;
                      end;
                    end;
                  end else begin
                    if ((TBIVr.PRCode<>TSrw.PRCode) or (TBIVr.oVc<>-1) or (TBIVr.ArtCode<>TSrw.ArtCode)) then begin
                      found2 = false;
                    end;
                  end;
                end;
              case 2:
                found2 = true;
                TBIVr.oVc = 1;
                TBIVr.EMCode = TSrw.EMCode;
                TBIVr.PRCode = TSrw.PRCode;
                TBIVr.ArtCode = TSrw.ArtCode;
                found2 = true;
                while (LoopKey("EMCode",TBIVr,4,found2)) begin
                  if ((TBIVr.PRCode==TSrw.PRCode) and (TBIVr.oVc==1) and
                      (TBIVr.EMCode==TBIVr.EMCode) and (TBIVr.Qty==TSrw.Qty) and 
                      (TBIVr.ArtCode==TSrw.ArtCode)) then begin
                    maketrans = false;
                    if (RepSpec.flags[1]==0) then begin
                      if (TBIVr.SerNr<>-1) then begin
                        maketrans = true;
                      end else begin
                        goto LRebPTMn;
                      end;
                    end;
                  end else begin
                    if ((TBIVr.PRCode<>TSrw.PRCode) or (TBIVr.oVc<>-1) or (TBIVr.EMCode<>TSrw.EMCode)) then begin
                      found2 = false;
                    end;
                  end;
                end;
            end;
LRebPTMn:;
            if (maketrans) then begin
              if (RepSpec.flags[0]==0) then begin
                TSCreateTBIV(TSr,i,TSrw,false,GenOptr.UseDiscount);
              end else begin
                TSCreateTBIV(TSr,i,TSrw,true,GenOptr.UseDiscount);
              end;
              CheckFlush(flushcnt,10);              
            end;
          end;
        end;
      end;
    end;
    MaintTrace(TSr.SerNr);
  end;
  return;
end;
