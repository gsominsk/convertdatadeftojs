external inner function Integer GetCompanyCodeFromCode(Integer);

event startup
begin

  SetLangMode(LangEnglish,"ENG",0);
  
  Report("Contacts Prefix Check",CUPrefixCheckRClass,CUPrefixCheckRn,0,modCRM);

  return;
end;

event DefineWindows
begin
  Real h,h1,h2,h3,h4,h5,h6,h7,hs,hm,v,v3,l,vs,vm,f,t,x,v2;

  SetLangMode(LangEnglish,"ENG",0);

  WindowBegin("Specify Contacts Prefix Check",CUPrefixCheckRClass,CGRcW,RcType);
  SetWRect(20,80,450,200);
  vs = 20;
  EditFieldTL(h=120,v=6, 150,"Prefix",M4UStr,Normal,5,f1,false,0);
  EditFieldTL(h,v+=vs,200,"Reg. In Country",M4Str,Normal,92,f2,false,SetSClass);
  EndWindow;

  return;
end;

global
procedure CUPrefixCheckRn(record RcVc RepSpec)
begin
  record CUVc CUr;
  Boolean found,testf;
  Integer rw,oldcomp;
  
  StartReportJob("Contacts Prefix Check");
  rw = 1;
  Header(rw,"Prefix " & RepSpec.f1,1);
  rw = rw + 1;
  EndHeader;

  StartFormat(15);
   OutString(0,0,"Customers with incorect prefix",false);
  EndFormat;
  StartFormat(15);
   OutString(0,0,"Code",false);
   OutString(100,0,"Name",false);
  EndFormat;
  Gray_Divider(0,1);
  
  if (nonblank(RepSpec.f2)) then begin
    oldcomp = CurrentCompany;  
    if (SetCompany(GetCompanyCodeFromCode(SetFromString(92,RepSpec.f2)),false)) then begin
    end;    
  end;
  found = true;
  while (LoopMain(CUr,1,found)) begin
    if (found) then begin
      testf = true;
      if (Left(CUr.Code,len(RepSpec.f1))==RepSpec.f1) then begin
        testf = false;
      end;
      if (testf) then begin
        StartFormat(15);
         OutString(0,"DblCUVc",CUr.Code,false);
         OutString(100,0,CUr.Name,false);
        EndFormat;
      end;
    end;
  end;  
  EndJob;
  if (nonblank(RepSpec.f2)) then begin
    ResetCompany(oldcomp);
  end;  
  return;
end;
