external function roundmode GetVATRoundModeRB();
external function roundmode DefaultRoundMode();
// Latvija - Unibanka

#ifdef HAL

Procedure FirstF(string str,var string ret)
Begin
integer fp,i,l;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)=="/") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret=str;
end else begin	 
	ret=mid(str,0,fp);
end;	
Return;
End;

Procedure LastF(string str,var string ret)
Begin
integer fp,i,l,d;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)=="/") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret="";
end else begin	 
	ret=mid(str,fp+1,l-fp);
end;	
Return;
End;

Procedure SelectNumber(string str,var string ret)
Begin
integer fp,i,l;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)==",") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret=str;
end else begin	 
	ret=mid(str,0,fp);
end;	
Return;
End;

global
procedure BankExpLatvia0(record OPVc OPr,integer expdate)  //  Latvija - Unibanka
begin
record BankVc Bankr;
record CUVc Ver;
string 255 outstr,BankComment;
string 1 emptystr;
string 20 FirstVECode;
Boolean testf,TrHs, first;
row OPVc OPrws;
integer rwc,i;
val totsum, totvat;

   	testf = true;
    totsum = 0;
    totvat = 0;
    BankComment = "";
    FirstVECode = "";
    first = true;
    NewLine;
   		    rwc=MatRowCnt(OPr); 		
   		    for (i=0; i<rwc; i=i+1) begin
   			    MatRowGet(OPr,i,OPrws);
                if ((OPrws.stp == 1) and (OPrws.ovst == 0)) then begin
                    if first then begin
                        FirstVECode = OPrws.VECode;
                        first = false;
                    end;
                    if (FirstVECode == OPrws.VECode) then begin
                       totsum = totsum + Round(OPrws.RecVal,DefaultRoundMode);
                       totvat = totvat + Round(OPrws.VATVal,GetVATRoundModeRB);
                       SelectNumber(OPrws.Comment,outstr);
                       if ((len(BankComment)+len(outstr))<=220) then begin
                          BankComment = BankComment & outstr & ",";
                       end;
                    end;
                end;
   		    end;
            if (expdate == 0) then begin
               outstr = DateToString(OPr.PayDate,"YYYYMMDD");
              end else begin
               outstr = DateToString(OPr.TransDate,"YYYYMMDD");
            end;

   			MatRowGet(OPr,0,OPrws);

		    ExportPadString(OPr.SerNr,6," ",False);//1.Document  number
		    ExportPadString(outstr,8," ",False);//2.Document date
   			FirstF(OPr.BankAcc,outstr);
            outstr = OPr.BankAcc;
		    ExportPadString(outstr,35," ",False);//3.Account
 		    ExportPadString(totsum,17," ",False);//4.Summa
            if blank(OPr.PayCurCode) then begin
               outstr = "LVL";
              end else begin
               outstr = OPr.PayCurCode;
            end;
 		    ExportPadString(outstr,3," ",False);//5.Currency code
   			Ver.Code=OPrws.VECode;
		    if (ReadFirstMain(Ver,1,true)==True) then begin
		    	Bankr.Code=Ver.AccOperator;  
		    	if (ReadFirstMain(Bankr,1,true)==True) then begin
		    		outstr=Bankr.Nr2;
		    	end;
		    end;
 		    ExportPadString(outstr,9," ",False);//6.Supplier bank code
   			FirstF(OPrws.BankAcc,outstr);
 		    ExportPadString(outstr,35," ",false);//7.Supplier account
   			outstr=Ver.Name;
 		    ExportPadString(outstr,60," ",False);//8.Supplier name
   			outstr=LastInRange(Ver.VATNr,11);
 		    ExportPadString(outstr,12," ",False);//9.Supplier reg number
   			outstr= BankComment;
		    if (totvat>0) then begin
		    	outstr=outstr&" t.sk. PVN 18% ";
		    	outstr=outstr&totvat;
		    	outstr=outstr&OPr.PayCurCode;
		    end;
 		    ExportPadString(outstr,140," ",False);//10.Info string
   			LastF(OPrws.BankAcc,outstr);
 		    ExportPadString(outstr,20," ",False);//11.supplier sub-account
            outstr = "";
 		    ExportPadString(outstr,60," ",False);//12.Supplier sub-account name
 		    ExportPadString(outstr,12," ",False);//13.sub-account reg number
//   			NewLine;
 		
return;
end;

#endif
