external procedure ExpBackupString(string);

procedure OutInvoiceHead2(record IVVc IVp)
BEGIN
  val s1,s3,s4;
  integer rwcnt,i;
  row IVVc IVrw;

  if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
    s1 = -IVp.Sum1;
    s3 = -IVp.Sum3;
    s4 = -IVp.Sum4;
  end else begin
    s1 = IVp.Sum1;
    s3 = IVp.Sum3;
    s4 = IVp.Sum4;
  end;
 
  ExportLongInt(IVp.SerNr);
  ExportDate(IVp.InvDate);
  ExportDate(IVp.PayDate);
  ExportLongInt(IVp.ExportFlag);
  ExportLongInt(IVp.Prntdf);
  ExportString(IVp.PayDeal);
  ExportLongInt(IVp.pdays);
  ExportVal(IVp.pdvrebt,M41Val);
  ExportLongInt(IVp.pdrdays);
  ExportString(IVp.pdComment);
  ExportLongInt(IVp.OrderNr);
  ExportLongInt(IVp.OKFlag);
  ExportString(IVp.IntCode);
  ExportString("");
  ExportLongInt(IVp.InvType);
  ExportString(IVp.PriceList);
  ExportString(IVp.Objects,);
  ExportString("");
  ExportLongInt(IVp.InclVAT);
  ExportString(IVp.ARAcc);
  ExportString(IVp.CredMark);
  ExportString("");
  ExportString(IVp.CurncyCode);
  ExportVal(IVp.ToRateB1,M4Val);  // M4Rate ??
  ExportDate(IVp.TransDate);
  ExportLongInt(IVp.UpdStockFlag);
  ExportLongInt(IVp.LastRemndr);
  ExportDate(IVp.LastRemDate);
  ExportVal(IVp.FrRate,M4Val);  //  M4Rate?? 
  ExportVal(IVp.ToRateB2,M4Val); //  M4Rate??
  ExportVal(IVp.BaseRate1,M4Val); //M4Rate??
  ExportVal(IVp.BaseRate2,M4Val); // M4Rate?? 
  ExportString(IVp.Sign); 
  NewLine;
  ExportString(IVp.CustCode);
  ExportString(IVp.Addr0);
  ExportString(IVp.Addr1);
  ExportString(IVp.Addr2);
  ExportString(IVp.Addr3);
  ExportString(IVp.CustCat);
  ExportString(IVp.InvAddr3);
  ExportString(IVp.InvAddr4);
  ExportString(IVp.DelAddr3);
  ExportString(IVp.DelAddr4);
  ExportString(IVp.DelAddrCode);
  NewLine;
  ExportString(IVp.ClientContact);   /* er referens */
  ExportString(IVp.OurContact);  /* vår referens */
  ExportString(IVp.InvComment);  /* text */
 
  ExportString(IVp.SalesMan);
  ExportString(IVp.LangCode);
  ExportString(IVp.OrgCust);
  ExportString(IVp.CustOrdNr);
  NewLine;
  ExportVal(IVp.Sum0,M4Val);
  ExportVal(IVp.Sum1,M4Val);
  ExportVal(IVp.Sum2,M4Val);
  ExportVal(IVp.Sum3,M4Val);
  ExportVal(IVp.Sum4,M4Val);
  ExportString(IVp.FrItem);
  ExportVal(IVp.FrPrice,M4Val);
  ExportVal(IVp.FrBase,M4Val);
  ExportString(IVp.FrVATCode);
  ExportString(IVp.FrObjects);
  ExportVal(IVp.FrGP,M4Val);
  ExportString(IVp.ShipAddr0);
  ExportString(IVp.ShipAddr1);
  ExportString(IVp.ShipAddr2);
  ExportString(IVp.ShipAddr3);
  ExportString(IVp.VATNr);
  ExportString(IVp.ShipDeal);
  ExportString(IVp.ShipMode);
  ExportString(IVp.PRCode);
  ExportString(IVp.FrSalesAcc);
  ExportVal(IVp.TAX1Sum,M4Val);
  ExportString(IVp.Location);
  ExportString(IVp.CustVATCode);
  ExportString(IVp.RebCode);
  ExportString(IVp.CalcFinRef);
  ExportString(IVp.Phone);
  ExportString(IVp.Fax);
  ExportLongInt(IVp.ARonTR);
  ExportLongInt(IVp.CredInv);
  ExportVal(IVp.BaseSum4,M4Val);
  ExportVal(IVp.DiscPerc,M4Val);
  ExportVal(IVp.DiscSum,M4Val);
  ExportString(IVp.InvoiceNr);  
  ExportVal(IVp.TotGP,M4Val);
  ExportLongInt(IVp.LocOKNr);
  ExportLongInt(IVp.Invalid);
  ExportString(IVp.CreditCard);
  ExportString(IVp.AuthorizationCode);
  ExportVal(IVp.RecValue,M4Val);
  ExportVal(IVp.RetValue,M4Val);
  ExportLongInt(IVp.FromBUQT);
  ExportString(IVp.Sorting);
  ExportLongInt(IVp.NoInterestFlag);
  ExportLongInt(IVp.NoRemndrFlag);
  ExportLongInt(IVp.SVONr);
  ExportLongInt(IVp.InstallmentInv);
  ExportString(IVp.OfficialSerNr);
  ExportString(IVp.OfficialSerNr2);
  ExportVal(IVp.TotQty,M4Qty);
  ExportVal(IVp.TotWeight,M4Qty);
  ExportVal(IVp.TotVolume,M4Qty);  
  ExportLongInt(IVp.AutoGiro);
  ExportString(IVp.SalesGroup);
  ExportLongInt(IVp.DisputedFlag);
  ExportLongInt(IVp.NoColectionFlag);
  ExportLongInt(IVp.QTNr);
  ExportLongInt(IVp.FiscalFlag);
  NewLine;
  rwcnt = MatRowCnt(IVp);
  for (i = 0 ; i<rwcnt ;i=i+1) begin
    MatRowGet(IVp,i,IVrw);
    ExportLongInt(IVrw.stp);
    switch (IVrw.stp) begin
      case 3:
        ExportString("");
        ExportString("");
        ExportString("");
        ExportString("");
        ExportString("");
        ExportLongInt(IVrw.OrdRow);
      case 4:
        ExportString(IVrw.ArtCode);
        ExportVal(IVrw.Quant,M4UVal);
        ExportString(IVrw.Spec);
        ExportString("");
        ExportVal(IVrw.Sum,M4Val);
        ExportVal(IVrw.vRebate,M41Val);
        ExportString(IVrw.SalesAcc);
        ExportString("");
        ExportString("");
        ExportString(IVrw.VATCode);
        ExportLongInt(IVrw.OrdRow);
        ExportVal(IVrw.BasePrice,M4Val);
      case 5:
        ExportString(IVrw.Spec);
        ExportVal(IVrw.Sum,M4Val);
        ExportString(IVrw.SalesAcc);
        ExportString(IVrw.VATCode);
      case 6:
        ExportLongInt(IVrw.CUPNr);
        ExportVal(IVrw.Sum,M4Val);
        ExportVal(IVrw.BasePrice,M4Val);
      case 7:
      case 8:
        ExportString(IVrw.CuAccCode);
        ExportString(IVrw.SalesAcc);
        ExportString(IVrw.Objects);
        ExportVal(IVrw.Sum,M4Val);
        ExportString(IVrw.VATCode);
     otherwise
        if (IVrw.stp==kInvoiceRowTypeVoid) then begin 
          IVrw.Quant = -IVrw.Quant;
          IVrw.Sum = -IVrw.Sum;
        end;
        ExportString(IVrw.ArtCode);
        ExportVal(IVrw.Quant,M4UVal);
        ExportString(IVrw.Spec);
        ExportVal(IVrw.Price,M423Val);
        ExportVal(IVrw.Sum,M4Val);
        ExportVal(IVrw.vRebate,M41Val);
        ExportString(IVrw.SalesAcc);
        ExportString(IVrw.Objects);
        ExportLongInt(IVrw.OrdRow);
        ExportVal(IVrw.BasePrice,M4Val);
        ExportVal(IVrw.rowGP,M4Val);
        ExportVal(IVrw.FIFO,M45Val);
        ExportString(IVrw.VATCode);
        ExportString(IVrw.Recepy);
        ExportString(IVrw.SerialNr);
        ExportVal(IVrw.PriceFactor,M45Val);
        ExportString(IVrw.VARList);
        ExportVal(IVrw.FIFORowVal,M45Val);
        ExportVal(IVrw.Coefficient,M45Val);
        ExportString(IVrw.CuAccCode);
        ExportString(IVrw.ExciseNr);
        ExportString(IVrw.PeriodCode);
        ExportString(IVrw.UnitCode);
        ExportVal(IVrw.UnitFactQuant,M4UVal);
        ExportVal(IVrw.UnitFactPrice,M423Val);
        ExportVal(IVrw.UnitXval,M423Val);
        ExportVal(IVrw.UnitYval,M423Val);
        ExportVal(IVrw.UnitZval,M423Val);
        ExportString(IVrw.Location);
    end;
    NewLine;
  end;
  RETURN;
END;

procedure OutInvoiceHead(record IVVc IVp)
BEGIN
  val s1,s3,s4;
  
  if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
    s1 = -IVp.Sum1;
    s3 = -IVp.Sum3;
    s4 = -IVp.Sum4;
  end else begin
    s1 = IVp.Sum1;
    s3 = IVp.Sum3;
    s4 = IVp.Sum4;
  end;
  ExportLongInt(IVp.SerNr);
  ExportDate(IVp.InvDate);
  ExportString(IVp.CustCode);
  ExportString(IVp.Addr0);
  ExportVal(s1,M4Val);
  ExportVal(s3,M4Val);
  ExportVal(s4,M4Val);
  ExportString(IVp.Objects);
  NewLine;
  RETURN;
END;

global
procedure InvEn(var record RcVc RepSpec)
BEGIN
  record IVVc IVr;
  Boolean TrHs,testf;
  string 255 fromcust,tocust;
  string 255 tstr;

  RepSpec.long1 = FirstInRange(RepSpec.f1,10);
  RepSpec.long2 = LastInRange(RepSpec.f1,10);
  fromcust = FirstInRange(RepSpec.f2,20);
  tocust = LastInRange(RepSpec.f2,20);
  IVr.SerNr = RepSpec.long1;
  TrHs = ReadFirstMain(IVr,1,false);
  if ((TrHs) and ((RepSpec.ArtMode==0) or (RepSpec.ArtMode==2))) then begin
    ExportFormat;
//    BlockExport("SysFormatBlock");
    ExpBackupString(RepSpec.f3);
    ExportString(GetRegisterTag("IVVc"));
    NewLine;
  end;
  TrHs = true;
  while (LoopMain(IVr,1,TrHs)) begin
    if (RepSpec.long2!=-1) then begin 
      if (IVr.SerNr>RepSpec.long2) then begin
        TrHs = false;
      end;
    end;    
    if (TrHs) then begin
      testf = true;
      if (DateInRange(IVr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin testf = false; end;
      if (nonblank(RepSpec.f2)) then begin
        if ((IVr.CustCode<fromcust) or (IVr.CustCode>tocust)) then begin
          testf = false;
        end;  
      end;  
      if (nonblank(RepSpec.ObjStr)) then begin
        if (SetInSet(RepSpec.ObjStr,IVr.Objects)==false) then begin
          testf = false;
        end;
      end;    
      if (testf) then begin
        if (RepSpec.ArtMode==0) then begin
          ExportRecord(IVr);
          NewLine;
        end;  
        if (RepSpec.ArtMode==2) then begin
          OutInvoiceHead2(IVr);
          NewLine;
        end;  
        if (RepSpec.ArtMode==1) then begin
          OutInvoiceHead(IVr);
        end;  
      end;
      UserTrace(IVr.SerNr,M4Long);
    end;
  end;
  RETURN;
END;