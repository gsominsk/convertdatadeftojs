external function roundmode GetRowSumRoundModeRB();
external function roundmode GetVATRoundModeRB();
external function roundmode DefaultRoundMode();
//  Latvija - Hansabanka
#ifdef HAL

Procedure FirstF(string str,var string ret)
Begin
integer fp,i,l;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)=="/") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret=str;
end else begin	 
	ret=mid(str,0,fp);
end;	
Return;
End;

Procedure LastF(string str,var string ret)
Begin
integer fp,i,l,d;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)=="/") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret="";
end else begin	 
	ret=mid(str,fp+1,l-fp);
end;	
Return;
End;

Procedure SelectNumber(string str,var string ret)
Begin
integer fp,i,l;
l=len(str);
fp=0;
for (i=0;i<l;i=i+1) begin
	if (mid(str,i,1)==",") then begin
		fp=i;
		i=l;
	end;
end;
if (fp==0) then begin
	ret=str;
end else begin	 
	ret=mid(str,0,fp);
end;	
Return;
End;

global
procedure BankExpLatvia2(record OPVc OPr,integer expdate,integer commision)  // Latvija - Hansabanka
begin
record BankVc Bankr;
record CUVc Ver;
string 255 outstr,outstr2,outstr3,BankComment,teststr;
string 1 emptystr;
Boolean testf,TrHs;
row OPVc OPrws;
integer rwc,i;
val totsum, totvat;


IF (OPr.SortCode=="P") then begin
   	testf = true;
    totsum = 0;
    totvat = 0;
    BankComment = "";
   		    rwc=MatRowCnt(OPr); 		
   		    for (i=0; i<rwc; i=i+1) begin
   			    MatRowGet(OPr,i,OPrws);
                if ((OPrws.stp == 1) and (OPrws.ovst == 0)) then begin
                    totsum = totsum + Round(OPrws.RecVal,DefaultRoundMode);
                    totvat = totvat + Round(OPrws.VATVal,GetVATRoundModeRB);
                    SelectNumber(OPrws.Comment,outstr);
                    if ((len(BankComment)+len(outstr))<=220) then begin
                       BankComment = BankComment & outstr & ",";
                    end;
                end;
   		    end;
            if (expdate == 0) then begin
               outstr = DateToString(OPr.PayDate,"YYYYMMDD");
              end else begin
               outstr = DateToString(OPr.TransDate,"YYYYMMDD");
            end;

   			MatRowGet(OPr,0,OPrws);

		    ExportPadString("P0331024",8," ",False);//1.Ieraksta tips, versija, garums
            outstr = OPr.BankAcc;
		    ExportPadString(outstr,13," ",False);//2.Maksªtªja konts
            if blank(OPr.PayCurCode) then begin
               outstr = "LVL";
              end else begin
               outstr = OPr.PayCurCode;
            end;
 		    ExportPadString(outstr,3," ",False);//3.Valæta
 		    ExportPadString(totsum,15," ",False);//4.Summa
		    ExportPadString("1",1," ",False);//5.Sa√ºmºja bankas koda tips
   			Ver.Code=OPrws.VECode;
		    if (ReadFirstMain(Ver,1,true)==True) then begin
		    	Bankr.Code=Ver.AccOperator;  
		    	if (ReadFirstMain(Bankr,1,true)==True) then begin
		    		outstr=Bankr.Nr2;
		    		outstr2=Bankr.Name;
		    		outstr3=Bankr.CorrspAcc;
		    	end;
		    end;
 		    ExportPadString(outstr,12," ",False);//6.Sa√ºmºja bankas kods
 		    ExportPadString(outstr2,100," ",False);//7.Sa√ºmºja bankas nosaukums
 		    ExportPadString(" ",40," ",False);//8.Rezerve
 		    ExportPadString(outstr3,34," ",False);//9.Sa√ºmºja bankas konts starpniekbankª
 		    ExportPadString(" ",1," ",False);//10.Rezerve
		    ExportPadString("1",1," ",False);//11.Starpniekbankas koda tips
 		    ExportPadString(" ",12," ",False);//12.Starpniekbankas kods
 		    ExportPadString(" ",140," ",False);//13.Starpniekbankas nosaukums
   			FirstF(OPrws.BankAcc,outstr);
 		    ExportPadString(outstr,34," ",False);//14.Sa√ºmºja konts
 		    ExportPadString(" ",1," ",False);//15.Rezerve
   			outstr=Ver.Name;
 		    ExportPadString(outstr,100," ",False);//16.Sa√ºmºja nosaukums
 		    ExportPadString(" ",40," ",False);//17.Rezerve
   			outstr= BankComment;
		    if (totvat>0) then begin
		    	outstr=outstr&" t.sk. PVN 18% ";
		    	outstr=outstr&totvat;
		    	outstr=outstr&OPr.PayCurCode;
		    end;
 		    ExportPadString(outstr,140," ",False);//18.Informªcija sa√ºmºjam
            if (commision==0) then begin
   			       outstr="1";
               end else begin
   			       outstr="2";
            end;
 		    ExportPadString(outstr,1," ",False);//19.Komisijas
 		    ExportPadString(" ",100," ",False);//20.Informªcija bankai
 		    ExportPadString(" ",228," ",False);//21.Rezerve
//   			NewLine;
END;
 		
IF (OPr.SortCode=="Y") then begin
   	testf = true;
    totsum = 0;
    totvat = 0;
    BankComment = "";
   		    rwc=MatRowCnt(OPr); 		
   		    for (i=0; i<rwc; i=i+1) begin
   			    MatRowGet(OPr,i,OPrws);
                if ((OPrws.stp == 1) and (OPrws.ovst == 0)) then begin
                    totsum = totsum + Round(OPrws.RecVal,DefaultRoundMode);
                    totvat = totvat + Round(OPrws.VATVal,GetRowSumRoundModeRB);
                    SelectNumber(OPrws.Comment,outstr);
                    if ((len(BankComment)+len(outstr))<=220) then begin
                       BankComment = BankComment & outstr & ",";
                    end;
                end;
   		    end;
            if (expdate == 0) then begin
               outstr = DateToString(OPr.PayDate,"YYYYMMDD");
              end else begin
               outstr = DateToString(OPr.TransDate,"YYYYMMDD");
            end;

   			MatRowGet(OPr,0,OPrws);

		    ExportPadString("Y0381024",8," ",False);//1.Ieraksta tips, versija, garums
            outstr = OPr.BankAcc;
		    ExportPadString(outstr,13," ",False);//2.Maksªtªja konts
            if blank(OPr.PayCurCode) then begin
               outstr = "LVL";
              end else begin
               outstr = OPr.PayCurCode;
            end;
 		    ExportPadString(outstr,3," ",False);//3.Valæta
 		    ExportPadString(totsum,15," ",False);//4.Summa
 		    ExportPadString(" ",1," ",False);//5.Rezerve
   			Ver.Code=OPrws.VECode;
		    if (ReadFirstMain(Ver,1,true)==True) then begin
		    	Bankr.Code=Ver.AccOperator;  
		    	if (ReadFirstMain(Bankr,1,true)==True) then begin
		    		outstr=Bankr.Nr2;
		    		outstr2=Bankr.Name;
		    		outstr3=Bankr.CorrspAcc;
		    	end;
		    end;
 		    ExportPadString(outstr,12," ",False);//6.Sa√ºmºja bankas kods
 		    ExportPadString(outstr2,100," ",False);//7.Sa√ºmºja bankas nosaukums
 		    ExportPadString(" ",228," ",False);//8.Rezerve
   			FirstF(OPrws.BankAcc,outstr);
 		    ExportPadString(outstr,34," ",False);//9.Sa√ºmºja konts
 		    ExportPadString(" ",1," ",False);//10.Rezerve
   			outstr=Ver.Name;
 		    ExportPadString(outstr,100," ",False);//11.Sa√ºmºja nosaukums
 		    ExportPadString(" ",10," ",False);//12.Rezerve
   			LastF(OPrws.BankAcc,outstr);
 		    ExportPadString(outstr,11," ",False);//13.Bud∆eta subkonts
 		    ExportPadString(" ",4," ",False);//14.Rezerve
   			outstr=LastInRange(Ver.VATNr,11);
 		    ExportPadString(outstr,13," ",False);//15.Supplier reg number
 		    ExportPadString(" ",2," ",False);//16.Rezerve
   			outstr= BankComment;
		    if (totvat>0) then begin
		    	outstr=outstr&" t.sk. PVN 18% ";
		    	outstr=outstr&totvat;
		    	outstr=outstr&OPr.PayCurCode;
		    end;
 		    ExportPadString(outstr,140," ",False);//17.Informªcija sa√ºmºjam
            if (commision==0) then begin
   			       outstr="1";
               end else begin
   			       outstr="2";
            end;
 		    ExportPadString(outstr,1," ",False);//18.Komisijas
 		    ExportPadString(" ",100," ",False);//19.Informªcija bankai
 		    ExportPadString(" ",228," ",False);//20.Rezerve
   			NewLine;
END;
return;
end;

#endif
