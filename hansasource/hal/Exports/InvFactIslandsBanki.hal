global
procedure ExportInvIslandsBanki(var record RcVc RepSpec,var record FactoringBlock factp)
BEGIN
  record ARVc ARr;
  record IVVc IVr;
  record CUVc CUr;
  Boolean TrHs,testf;
  string 255 tstr;
  LongInt appsernr;
  Boolean exported;
  record CYBlock CYRec;
  Date curdate;  
  LongInt friv,toiv;
  
  friv = FirstInRange(RepSpec.f1,10);
  toiv = LastInRange(RepSpec.f1,10);
  curdate = CurrentDate;
  BlockLoad(CYRec);
/*
  ExportPadString(CYRec.BankCode,4," ",false);
  ExportPadString("",10," ",false);
  ExportPadString("Islandsbanki",26," ",false);
  NewLine;
*/  
  appsernr = 0;
  if (factp.Bank==1) then begin 
    appsernr = RepSpec.FirstVer;
  end;  
  TrHs = true;
  IVr.InvDate = RepSpec.sStartDate;
  while (LoopKey("InvDate",IVr,1,TrHs)) begin
    if (IVr.InvDate>RepSpec.sEndDate) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      testf = true;
      if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin testf = false; end;
      if (nonblank(RepSpec.f1)) then begin
        if (IVr.SerNr<friv) then begin testf = false; end;
        if (IVr.SerNr>toiv) then begin testf = false; end;
      end;
      if (testf) then begin
        ARr.InvoiceNr = IVr.SerNr;
        if (ReadFirstMain(ARr,1,true)) then begin
          CUr.Code = IVr.CustCode;
          if (ReadFirstMain(CUr,1,true)) then begin
          end;
          tstr = StripNonDigits(CYRec.OrgNr);
          ExportPadString(tstr,10," ",false);
          ExportPadString("",4," ",false);
          ExportPadString("K",1," ",false);
          ExportPadString(DateToString(IVr.PayDate,"YYYYMMDD"),8," ",false);
          ExportPadString(DateToString(AddDay(IVr.PayDate,15),"YYYYMMDD"),8," ",false);//cancel date
          ExportPadString("03",2," ",false);
          tstr = StripNonDigits(IVr.CustCode);
          ExportPadString(tstr,10," ",false);
          tstr = StripNonDigits(CUr.BankAccount);
          ExportPadString(Left(tstr,4),4," ",false);
          ExportPadString(Mid(tstr,4,2),2," ",false);
          ExportPadString(Mid(tstr,6,6),6," ",false);          
          ExportPadString(ValToString(IVr.Sum4,M4Val,"",",",0),11,"0",true);          
          ExportPadString(IVr.SerNr,16," ",false);
          ExportPadString(DateToString(IVr.PayDate,"YYYYMMDD"),8," ",false);
          ExportPadString(factp.User,14," ",false);
          ExportPadString("",19," ",false);
          NewLine;
          exported = true;
        end;
      end;  
    end;
  end;
  if (exported) then begin
    factp.LastSerNr = factp.LastSerNr + 1;
    factp.LastDate = curdate;
  end;  
  RETURN;
END;
