
procedure ExportEPL1Line(record IVVc IVr,string phone,record CYBlock CompYear)
begin
  string 200 tstr;

  ExportPadString("EPL1",4," ",false);   /* EPL1 */
//  ExportPadString("001080",6," ",false); /* Customer ID */
  ExportPadString(CompYear.ANACode,6," ",false); /* Customer ID */
//  ExportPadString("0777",4," ",false);   /* Password */
  ExportPadString(CompYear.ChiefAccountant,4," ",false);   /* Password */
  ExportPadString("0",1," ",false);      /* File Format */
  ExportPadString("T",1," ",false);      /* Service Actions */ /* Remove T after testing */
  ExportPadString("T",1," ",false);      /* Electronic Archiving */
  ExportPadString("",1," ",false);       /* Reserved */
  ExportPadString("0",1," ",false);      /* Optical Control */
  ExportPadString("1",1," ",false);      /* Letter Class */
  ExportPadString("S",1," ",false);      /* Envelope */
  ExportPadString("",1," ",false);       /* Reference Code for Accounting */
  ExportPadString("",1," ",false);       /* Reserved */
  ExportPadString("0",1," ",false);      /* Paper */
  ExportPadString("",2," ",false);       /* Reserved */
  ExportPadString("",2," ",false);       /* Application ID for eArchiving */
  ExportPadString("",4," ",false);       /* Reserved */
  ExportPadString("",7," ",false);       /* Reserved */
  tstr = IVr.OurContact;
  if (nonblank(tstr)) then begin tstr = tstr & " "; end;
  tstr = tstr & phone;
  ExportPadString(tstr,40," ",false);     /* Contact Information */
  NewLine;
  return;
end;

procedure ExportEPLKLine(record IVVc IVr)
begin
  ExportPadString("EPLK",4," ",false);   /* EPLK */
  ExportPadString("FI",2," ",false);     /* Country Code */
  ExportPadString(IVr.Sorting,8," ",false);  /* Recipients postal code */
  ExportPadString("1",1," ",false);      /* Number of copies included in the same envelope */
  ExportPadString("00",2," ",false);     /* Reserved */
  ExportPadString("",23," ",false);      /* Reserved */
  ExportPadString("",5," ",false);       /* departement code */
  ExportPadString("",34," ",false);      /* Reserved */
  NewLine;
  return;
end;

procedure Export10Line(record CYBlock CompYear)
begin
  ExportPadString("10",2," ",false);                /* PCC Code */
  ExportPadString(CompYear.CompName,60," ",false);  /* Address Line 1 */
  NewLine;
//  ExportPadString("EPL5",4," ",false);            /* EPL5 = Customer Specified Forms */
//  ExportPadString("0862",4," ",false);            /* What form to use */
  ExportPadString("EPL8",4," ",false);              /* EPL8 = Service Provider Forms */
  ExportPadString("9800",4," ",false);              /* What form to use */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(CompYear.Addr0,60," ",false);     /* Address Line 1 */
  NewLine;
  if (nonblank(CompYear.Addr1)) then begin
    ExportPadString("0",2," ",true);                /* PCC Code */
    ExportPadString(CompYear.Addr1,60," ",false);   /* Address Line 2 */
    NewLine;
  end;
  if (nonblank(CompYear.Addr2)) then begin
    ExportPadString("0",2," ",true);                /* PCC Code */
    ExportPadString(CompYear.Addr2,60," ",false);   /* Address Line 3 */
    NewLine;
  end;
  return;
end;

procedure Export20Line(record IVVc IVr)
begin
  ExportPadString("20",2," ",false);        /* PCC Code */
  ExportPadString(IVr.Addr0,60," ",false);  /* Address Line 1 */
  NewLine;
  ExportPadString("0",2," ",true);          /* PCC Code */
  ExportPadString(IVr.Addr1,60," ",false);  /* Address Line 1 */
  NewLine;
  if (nonblank(IVr.Addr2)) then begin
    ExportPadString("0",2," ",true);         /* PCC Code */
    ExportPadString(IVr.Addr2,60," ",false); /* Address Line 2 */
    NewLine;
  end;
  if (nonblank(IVr.Addr3)) then begin
    ExportPadString("0",2," ",true);         /* PCC Code */
    ExportPadString(IVr.Addr3,60," ",false); /* Address Line 3 */
    NewLine;
  end;
  return;
end;

/* Not for multi Language, but it works.... */
procedure GetShipDealText(string a,var string res)
begin
  record ShipDealVc ShipDealr;
  
  res = "";
  ShipDealr.Code = a;
  if (ReadFirstMain(ShipDealr,1,true)) then begin
    res = ShipDealr.Comment;
  end;
  return;
end;

procedure GetPayDealText(string a,var string res)
begin
  record PDVc PDr;
  
  res = "";
  PDr.Code = a;
  if (ReadFirstMain(PDr,1,true)) then begin
    res = PDr.pdComment;
  end;
  return;
end;

procedure Export50Line(record IVVc IVr)
begin
  string 200 tstr;

  ExportPadString("50",2," ",false);        /* PCC Code */
  ExportPadString("LASKU",22," ",false);    /* First Line of Text */
  NewLine;
  ExportPadString("0",2," ",true);                                       /* PCC Code */
  ExportPadString(DateToString(IVr.InvDate,"DD.MM.YYYY"),17," ",false);  /* Invoice Date */
  ExportPadString(" ",1," ",false);                                      /* Space */
  ExportPadString(IVr.SerNr,17," ",false);                               /* Invoice Number */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.ClientContact,35," ",false);  /* Your Reference */
  NewLine;
  ExportPadString("0",2," ",true);              /* PCC Code */
  ExportPadString(IVr.CustCode,17," ",false);   /* Customer Code */
  ExportPadString(" ",1," ",false);             /* Space */
  ExportPadString(IVr.OurContact,17," ",false); /* Our Reference */
  NewLine;
  GetShipDealText(IVr.ShipDeal,tstr);
  ExportPadString("0",2," ",true);              /* PCC Code */
  ExportPadString(tstr,35," ",false);           /* Delivery Terms */
  NewLine;
  GetPayDealText(IVr.PayDeal,tstr);
  ExportPadString("0",2," ",true);              /* PCC Code */
  ExportPadString(tstr,35," ",false);           /* Payment Terms */
  NewLine;
  return;
end;

procedure Export30Line(record IVVc IVr,Integer startrow,Integer endrow)
begin
  row IVVc IVrw;
  record INVc INr;
  Integer i;
  string 200 tstr;

  ExportPadString("30",2," ",false);             /* PCC Code */
//  ExportPadString("TILPVM:"DateToString(IVr.OrdDate,"DDMMYY"),22," ",false);  /* Some dates?? */
  NewLine;
  for (i=startrow;i<endrow;i=i+1) begin
    MatRowGet(IVr,i,IVrw);
    INr.Code = IVrw.ArtCode;
    tstr = "";
    if (ReadFirstMain(INr,1,true)) then begin
      tstr = INr.Unittext;
    end;
    ExportPadString("0",2," ",true);             /* PCC Code */
    ExportPadString(IVrw.ArtCode,10," ",false);  /* Item Code */
    ExportPadString(IVrw.Spec,30," ",false);     /* Item Name */
    ExportPadString(ValToString(IVrw.Quant,M4UVal,".",".",0),6," ",true); /* Item Qty */
    ExportPadString(" " & tstr,5," ",false);     /* Item Unit */
    ExportPadString(ValToString(IVrw.Price,M4Val,".",".",0),11," ",true); /* Item Qty */
    ExportPadString(ValToString(IVrw.Sum,  M4Val,".",".",0),11," ",true); /* Item Qty */
    NewLine;
  end;
  return;
end;

procedure Export40Line(record IVVc IVr,string bankno)
begin
  string 200 tstr;

  ExportPadString("40",2," ",false);                /* PCC Code */
  ExportPadString("",24," ",false);                 /* Seemd to be empty */
  ExportPadString(IVr.CalcFinRef,30," ",false);     /* Reference Number */
  ExportPadString(ValToString(IVr.Sum4,M4Val,".",".",0),15," ",true);  /* Total Sum */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.Phone,20," ",false);          /* Phone */
  ExportPadString(" ",1," ",false);                 /* Space */
  ExportPadString(IVr.Fax,20," ",false);            /* Fax */
  ExportPadString(" ",1," ",false);                 /* Space */
  ExportPadString(bankno,20," ",false);             /* Invoice Number */
  NewLine;
  return;
end;

procedure Export60Line(record IVVc IVr,string bankno,string bankno2)
begin
  string 200 tstr;

  ExportPadString("60",2," ",false);                /* PCC Code */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(bankno,30," ",false);             /* Bank Account 1 */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(bankno2,30," ",false);            /* Bank Account 2 */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.Addr0,60," ",false);          /* Customer Address */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.Addr1,60," ",false);          /* Customer Address */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.Addr2,60," ",false);          /* Customer Address */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString(IVr.Addr3,60," ",false);          /* Customer Address */
  NewLine;
  ExportPadString("0",2," ",true);                  /* PCC Code */
  ExportPadString("",20," ",true);                  /* Empty */
  ExportPadString(DateToString(IVr.PayDate,"DD.MM.YYYY"),17," ",false);  /* Due Date */
  ExportPadString(ValToString(IVr.Sum4,M4Val,".",".",0),15," ",true);  /* Total Sum */
  NewLine;
  return;
end;

procedure ExportEPLBLine(record IVVc IVr)
begin
  ExportPadString("EPLB",4," ",false);   /* EPLK */
  NewLine;
  return;
end;

global
procedure EPostInvEn(record RcVc RepSpec)
begin
  record IVVc IVr;
  Boolean TrHs,testf;
  LongInt fromiv,toiv;
  record CYBlock CompYear;
  Integer rwcnt;
  Boolean firstf;
  
  firstf = true;
  TrHs = false;  
  BlockLoad(CompYear);
  fromiv = FirstInRange(RepSpec.f1,20);
  toiv = LastInRange(RepSpec.f1,20);
  IVr.TransDate = RepSpec.sStartDate;
  IVr.SerNr = fromiv;
  TrHs = true;
  while (LoopKey("InvDate",IVr,1,TrHs)) begin
    if (IVr.TransDate>RepSpec.sEndDate) then begin
      TrHs = false;
    end;
    testf = true;
    if (nonblank(RepSpec.f1)) then begin
      if (IVr.SerNr>toiv)   then begin testf = false; end;
      if (IVr.SerNr<fromiv) then begin testf = false; end;
    end;
    if (TrHs==false) then begin testf = false; end;
    if (nonblank(RepSpec.f2)) then begin
      if (IVr.CustCode<>RepSpec.f2) then begin
        testf = false;
      end;
    end;
    if (testf) then begin
      rwcnt = MatRowCnt(IVr);
      if (firstf) then begin
        ExportEPL1Line(IVr,CompYear.Phone,CompYear);
        firstf = false;
      end;
      ExportEPLKLine(IVr);
      Export10Line(CompYear);
      Export20Line(IVr);
      Export50Line(IVr);
      Export30Line(IVr,0,rwcnt);
      Export40Line(IVr,CompYear.Bank1);
      Export60Line(IVr,CompYear.Bank1,CompYear.Bank2);
      ExportEPLBLine(IVr);
    end;
  end;
  return;
end;

