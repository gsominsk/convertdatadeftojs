external function Date IntMonthToDate(Integer);

procedure UserDefRowExport(record RcVc KeyRepSpec,string code,string comment,string defstr,Integer i,var Boolean Outf)
BEGIN
  val v;
  Integer j;
  string 255 tstr

  if (nonblank(KeyRepSpec.FirstAcc)) then begin
    if (code==KeyRepSpec.FirstAcc) then begin
      Outf = true;
    end;
  end;
  if (Outf) then begin
    if (KeyRepSpec.flags[2]!=1) then begin
      if (KeyRepSpec.flags[0]==1) then begin
        ExportString(code);
        ExportString(comment);
      end;
    end;
    if (KeyRepSpec.flags[1]==1) then begin
      ExportString(""); // startbal 
      for (j=KeyRepSpec.sm1;j<=KeyRepSpec.em1;j=j+1) begin
        KeyRepSpec.sStartDate = IntMonthToDate(j);
        KeyRepSpec.sEndDate = IntMonthToDate(j+1);
        KeyRepSpec.sEndDate = AddDay(KeyRepSpec.sEndDate,-1);
        if (nonblank(defstr)) then begin
          v = EvalToVal(defstr);
          SetTransVal(code,v);//:(( doent work
          ExportVal(v,M4Val);
        end;
      end;
    end else begin
      if (nonblank(defstr)) then begin
        v = EvalToVal(defstr);
        ExportVal(v,M4Val);
        SetTransVal(code,v);
      end;
    end;
    NewLine;
    UserTrace(comment,M4Str);
  end;
  if (nonblank(KeyRepSpec.LastAcc)) then begin
    if (code==KeyRepSpec.LastAcc) then begin
      Outf = false;
    end;
  end;
  RETURN;
END;

global
procedure KeyEn(record RcVc RepSpec)
BEGIN
  record UserDefRepVc UserDefRepr;
  row UserDefRepVc UserDefReprw;
  Integer i,gKsprwcnt;
  transaction record RcVc KeyRepSpec;
  string 255 tstr;
  Boolean Outf;
  transaction Integer keyconscompany;
  
  keyconscompany = CurrentCompany;
  UserDefRepr.shortname = "KeyRn"; // RepSpec.shortname
  if (ReadFirstMain(UserDefRepr,1,true)) then begin
    RecordCopy(KeyRepSpec,RepSpec);
    if (KeyRepSpec.em1>(KeyRepSpec.sm1+18)) then begin KeyRepSpec.em1 = KeyRepSpec.sm1 + 18; end;
    KeyRepSpec.FirstAcc = FirstInRange(KeyRepSpec.f1,20);
    KeyRepSpec.LastAcc = LastInRange(KeyRepSpec.f1,20);

    if (blank(KeyRepSpec.FirstAcc)) then begin
      Outf = true; 
    end else begin
      Outf = false;
    end;
    gKsprwcnt = MatRowCnt(UserDefRepr);
    for (i=0;i<gKsprwcnt;i=i+1) begin
      MatRowGet(UserDefRepr,i,UserDefReprw);
      UserDefRowExport(KeyRepSpec,UserDefReprw.Code,UserDefReprw.Comment,UserDefReprw.defstr,i,Outf);
    end;
  end;
  RETURN;
END;