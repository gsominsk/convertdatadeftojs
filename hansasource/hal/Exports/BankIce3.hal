/*ISLANDSBANKI*/
global
procedure BankExpIceland3(record OPVc OPr,record RcVc RepSpec)
BEGIN
  record VIVc VIr;
  record CUVc VEr;
  Integer i,rwcnt;
  row OPVc OPrw;
  Boolean testf;
  string 255 tstr,vebankacc;

  rwcnt = MatRowCnt(OPr);
  for (i = 0 ; i<rwcnt ;i=i+1) begin
    MatRowGet(OPr,i,OPrw);
    if (OPrw.ovst<>0) then begin goto LBankExpIceland3; end;
    if (blank(OPrw.BankAcc)) then begin goto LBankExpIceland3; end;    
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)==false) then begin goto LBankExpIceland3; end;
    testf = true;
    if (VIr.Invalid<>0) then begin goto LBankExpIceland3; end;
    testf = true;           
    if (testf) then begin
      VEr.Code = OPrw.VECode;
      if (ReadFirstMain(VEr,1,true)) then begin end;
      vebankacc = StripNonDigits(OPrw.BankAcc);
      tstr = Left(VEr.Bank,8);
      ExportPadString(tstr,len(tstr)," ",true);
      ExportPadString("|",1," ",true);
      ExportPadString(Left(vebankacc,4),4,"0",true);
      ExportPadString("|",1," ",true);
      ExportPadString(Mid(vebankacc,4,2),2,"0",true);
      ExportPadString("|",1," ",true);
      ExportPadString(Mid(vebankacc,6,6),6," ",false);
      ExportPadString("|",1," ",true);
      tstr = ValToString(OPrw.BankVal,M4Val,"",",",0);
      ExportPadString(tstr,15,"0",true);
      ExportPadString("|",1," ",true);
      tstr = Left(OPrw.VECode,14);
      tstr = StripNonDigits(tstr);
      ExportPadString(tstr,len(tstr)," ",false);
      ExportPadString("|",1," ",true);
      if (Left(VEr.Bank,8)=="SB")  then begin
        ExportPadString(DateToString(VIr.DueDate,"DDMMYY"),6," ",false);
      end;
      ExportPadString("|",1," ",true);
      ExportPadString("03",2," ",false);
      ExportPadString("|",1," ",true);
      tstr = Left(VIr.RefStr,7);
      ExportPadString(tstr,len(tstr)," ",false);
      ExportPadString("|",1," ",true);
      ExportPadString("J",1," ",true);
      ExportPadString("|",1," ",true);
      ExportPadString("N",1," ",true);
      ExportPadString("|",1," ",true);
      tstr = Left(VEr.Name,30);
      ExportPadString(tstr,len(tstr)," ",false);
      ExportPadString("|",1," ",true);
//      ExportPadString("",30," ",false);
      ExportPadString("|",1," ",true);
//      ExportPadString("",30," ",false);
      ExportPadString("|",1," ",true);
//      ExportPadString("",30," ",false);
      ExportPadString("|",1," ",true);
//      ExportPadString(DateToString(CurrentDate,"DD.MM.YYYY"),10," ",false);
      NewLine;
    end;    
  end;
LBankExpIceland3:;
  RETURN;
END;
