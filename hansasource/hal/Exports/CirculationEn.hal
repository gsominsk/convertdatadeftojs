external procedure NewLineExport();

global
procedure CirculationEn(record RcVc RepSpec)
BEGIN
  record COVc COr;
  Boolean TrHs;
  Boolean testf;
  Date invdate,invpers,invpere;
  string 255 frcc,tocc;
  LongInt frco,toco;
  string 255 ckey;
  string 255 tstr,t1;
  string 5 frcocl,tococl;
  
  frcc = FirstInRange(RepSpec.f1,20);
  tocc = LastInRange(RepSpec.f1,20);
  frco = FirstInRange(RepSpec.f2,10);
  toco = LastInRange(RepSpec.f2,10);
  frcocl = FirstInRange(RepSpec.FirstAcc,5);
  tococl = LastInRange(RepSpec.FirstAcc,5);


  if (RepSpec.ArtMode==0) then begin// sorting by main key 
    ckey = "SerNr";
  end;
  if (RepSpec.ArtMode==1) then begin// sorting by customer
    ckey = "CustCode";
    COr.CustCode = frcc;
  end;
  if (RepSpec.ArtMode==2) then begin// sorting by adress line 2 
    ckey = "PostCode";
    COr.Addr3 = "";
  end;
  if (RepSpec.ArtMode==3) then begin// sorting by class
    ckey = "ContractClass";
    COr.ContractClass = frcocl;
  end;
  COr.SerNr = frco;
  COr.ChildSerNr = -1;
  TrHs = true;
  while (LoopKey(ckey,COr,2,TrHs)) begin
    testf = false;
    if (TrHs) then begin
      if (RepSpec.ArtMode==0) then begin
        if (toco!=-1) then begin
          if (COr.SerNr>toco) then begin
            TrHs = false;
          end;
        end;
      end;      
      if (RepSpec.ArtMode==1) then begin
        if (nonblank(RepSpec.f1)) then begin
          if (COr.CustCode>tocc) then begin 
            TrHs = false; 
          end;
        end;
      end;
    end;
    if (TrHs) then begin
      testf = true;
      if (toco!=-1) then begin
        if (COr.SerNr>toco) then begin testf = false; end;
      end;  
      if (nonblank(RepSpec.f1)) then begin
        if (COr.CustCode>tocc) then begin testf = false; end;
        if (COr.CustCode<frcc) then begin testf = false; end;
      end;
      if (nonblankdate(COr.lastInvDate)) then begin
        if (COr.lastInvDate>RepSpec.d2) then begin
          testf = false;
        end;  
      end;
      if (nonblank(RepSpec.f3)) then begin
        if (RepSpec.f3!=COr.ContractClass) then begin
          testf = false;
        end;  
      end;
      if (nonblank(RepSpec.FirstAcc)) then begin
        if (RepSpec.ArtMode==3) then begin
           if (COr.ContractClass<frcocl) then begin TrHs = false; end;
           if (COr.ContractClass>tococl) then begin TrHs = false; end;
        end else begin
           if (COr.ContractClass<frcocl) then begin testf = false; end;
           if (COr.ContractClass>tococl) then begin testf = false; end;
        end;  
      end;            
    end;
    if (TrHs==false) then begin testf = false; end;
    if (testf) then begin
      if (COr.perLength<=0) then begin
        goto L88;
      end;  
      invpers = COr.startDate;
      if (nonblankdate(COr.endDate)) then begin
        if (invpers>COr.endDate) then begin 
          goto L88;
        end;  
      end else begin
        if (invpers>RepSpec.d2) then begin
          goto L88;
        end;  
      end;  
      if (COr.perType==0) then begin
        invpere = invpers;
        invpere = AddMonth(invpere,COr.perLength);
      end else begin
        invpere = AddDay(invpers,COr.perLength);
      end;
      invpere = AddDay(invpere,-1);
      if (COr.invDtype==0) then begin
        invdate = AddDay(invpers,-COr.invDays);
      end else begin
        invdate = AddDay(invpere,COr.invDays);
      end;
      if (DateInRange(invdate,RepSpec.d1,RepSpec.d2)) then begin
        if (RepSpec.flags[10]==0) then begin// TAB Seperated 
          ExportLongInt(COr.SerNr);          
          if (RepSpec.flags[4]==0) then begin
            ExportString(COr.Addr0);
            ExportString(COr.Addr1);
            ExportString(COr.Addr2);
            ExportString(COr.Addr3);
          end else begin
            ExportString(COr.ShipAddr0);
            ExportString(COr.ShipAddr1);
            ExportString(COr.ShipAddr2);
            ExportString(COr.ShipAddr3);
          end;  
          ExportString(COr.ContractClass);
          ExportVal(COr.TotQuant,M4Qty);
          NewLine;
        end;
        if (RepSpec.flags[10]==1) then begin// Comma separated: "xxx","xxx","xxx" 
          tstr = """";
          tstr = tstr & COr.SerNr;
          tstr = tstr & """";
          tstr = tstr & ",";
          tstr = tstr & "\"";
          if (RepSpec.flags[4]==0) then begin            
            tstr = tstr & COr.Addr0;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.Addr1;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.Addr2;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.Addr3;
          end else begin
            tstr = tstr & COr.ShipAddr0;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.ShipAddr1;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.ShipAddr2;
            tstr = tstr & "\"";
            tstr = tstr & ",";
            tstr = tstr & "\"";
            tstr = tstr & COr.ShipAddr3;
          end;  
          tstr = tstr & "\"";
          ExportString(tstr);            
          tstr = "\"";
          tstr = tstr & COr.TotQuant;
          tstr = tstr & "\"";
          ExportString(tstr);            
          NewLineExport;
        end;
      end;
      invpers = AddDay(invpere,1);
L88:;
    end;
  end;
  RETURN;
END;