external procedure GetShipDealText(string,string,var string);

procedure CreateMessageIdentifier(var string res)
BEGIN  
  res = "";
  res = res & CurrentDate;
  res = res & CurrentTime;
  RETURN;
END;

procedure MaheExportUNT(string messident,var LongInt rowcnt)
BEGIN
  string 255 tstr;
  
  ExportPadString("UNT",3," ",false);  
  ExportPadString("01",2," ",false);  
  tstr = rowcnt;
  ExportPadString(tstr,6,"0",true);
  ExportPadString(messident,14," ",false);
  NewLine;
  RETURN;
END;

procedure MaheExportBGM(LongInt ordernr,var LongInt rowcnt)
BEGIN
  
  ExportPadString("BGM01",5," ",false);  
  ExportPadString("730",3," ",false);  
  ExportPadString(ordernr,35," ",false);
  ExportPadString("9",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportDTM(string number,string label,Date td,var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("DTM",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString(label,3," ",false);
  tstr = DateToString(td,"YYMMDD");
  ExportPadString(tstr,35," ",false);
  ExportPadString("101",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportTSR(var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("TSR01",5," ",false);  
  ExportPadString("?",3," ",false);//carriage condition
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);//Service req
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);//priority
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);//cargo nature
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportMOA(val sum4,string crncycode,var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("MOA01",5," ",false);  
  ExportPadString("77",3," ",false);
  tstr = ValToString(sum4,M4Val,"","",0);
  ExportPadString(tstr,18,"0",true);
  ExportPadString(crncycode,3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportFTX(string number,string label,string comment,var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("FTX",3," ",false);  
  ExportPadString(number,2," ",false);
  ExportPadString(label,3," ",false);
  ExportPadString("",3,"",false);
  ExportPadString("???",3," ",false);
  ExportPadString("",3,"",false);
  ExportPadString("",3,"",false);
  ExportPadString(comment,70,"",false);
  ExportPadString("",70,"",false);
  ExportPadString("",70,"",false);
  ExportPadString("",70,"",false);
  ExportPadString("",70,"",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportMEA(string number,string label,val sum,var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("MEA",3," ",false);  
  ExportPadString(number,2," ",false);
  ExportPadString(label,3," ",false);
  ExportPadString("",3,"",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3,"",false);
  ExportPadString("",3,"",false);
  tstr = ValToString(sum,M423Val,"","",0);
  ExportPadString(tstr,18,"0",true);
  ExportPadString("",3,"",false);
  ExportPadString("",18,"0",true);
  ExportPadString("",3,"",false);
  ExportPadString("",18,"0",true);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportPCI(string number,string label,var LongInt rowcnt)
BEGIN
  string 255 tstr;
    
  ExportPadString("PCI",3," ",false);  
  ExportPadString(number,2," ",false);
  ExportPadString(label,3," ",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",35,"",false);
  ExportPadString("",3,"",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportTOD(string shipdeal,string langcode,var LongInt rowcnt)
BEGIN
  string 255 tstr;
  
  ExportPadString("TOD01",5," ",false);  
  ExportPadString("6",3," ",false);  
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString(shipdeal,3," ",false);
  ExportPadString("",3," ",false);
  GetShipDealText(shipdeal,langcode,tstr);
  ExportPadString(tstr,70," ",false);
  ExportPadString("",70," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportLOC(string number,string label,string place,var LongInt rowcnt)
BEGIN
  
  ExportPadString("LOC",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString(label,3," ",false);  
  ExportPadString(place,25," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",17," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportCTA(string number,string label,var LongInt rowcnt)
BEGIN
  
  ExportPadString("CTA",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString(label,3," ",false);  
  ExportPadString("",17," ",false);
  ExportPadString("",35," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportCOM(string number,string label,var LongInt rowcnt)
BEGIN
  
  ExportPadString("COM",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString("",25," ",false);
  ExportPadString(label,3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportGID(string number,var LongInt rowcnt)
BEGIN
  
  ExportPadString("GID",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString("",5," ",false);
  ExportPadString("",8,"0",true);
  ExportPadString("",2," ",false);
  ExportPadString("",7," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",8,"0",true);
  ExportPadString("",2," ",false);
  ExportPadString("",7," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",8,"0",true);
  ExportPadString("",2," ",false);
  ExportPadString("",7," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportNAD(string number,string label,string comment,var LongInt rowcnt)
BEGIN
  
  ExportPadString("NAD",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString(label,3," ",false);  
  ExportPadString("",17," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",9," ",false);
  ExportPadString("",9," ",false);
  ExportPadString("",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportRFF(string label,var LongInt rowcnt)
BEGIN
  
  ExportPadString("RFF01",5," ",false);  
  ExportPadString(label,3," ",false);  
  ExportPadString("",35," ",false);
  ExportPadString("",6," ",false);
  ExportPadString("",35," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;
  
procedure MaheExportTDT(string number,string label,var LongInt rowcnt)
BEGIN
  ExportPadString("TDT",3," ",false);  
  ExportPadString(number,2," ",false);  
  ExportPadString(label,3," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",8," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",35," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",9," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",3," ",false);
  ExportPadString("",17," ",false);
  ExportPadString("",3," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportUNB(string ouranacode,record ORVc ORr,var LongInt rowcnt)
BEGIN
  record CUVc CUr;
  Boolean cufoundf;
  string 255 tstr;
  
  CUr.Code = ORr.CustCode;
  cufoundf = ReadFirstMain(CUr,1,true);
  ExportPadString("UNB01",5," ",false);  
  tstr = StripNonDigits(ouranacode);
  ExportPadString(tstr,35," ",false);
  ExportPadString("",4," ",false);
  tstr = StripNonDigits(CUr.ANACode);
  ExportPadString(tstr,35," ",false);
  ExportPadString("",4," ",false);
  tstr = DateToString(CurrentDate,"YYMMDD");  
  ExportPadString(tstr,6," ",false);
  ExportPadString(CurrentTime,4," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  RETURN;
END;

procedure MaheExportUNH(string messident,var LongInt rowcnt)
BEGIN
  ExportPadString("UNH01",5," ",false);  
  ExportPadString(messident,14," ",false);
  ExportPadString("IFTMIN",6," ",false);  
  ExportPadString("S",3," ",false);  
  ExportPadString("93A",3," ",false);  
  ExportPadString("UN",2," ",false);  
  ExportPadString(" ",6," ",false);
  rowcnt = rowcnt + 1;
  NewLine;
  return;
end;
  
global
procedure MaheOREn(record RcVc RepSpec)
BEGIN
  record ORVc ORr;
  record CYBlock CYRec;
  Boolean TrHs,testf,firstf;
  string 20 keystr;
  string 255 messident;
  Integer keys;
  LongInt fror,toor;
  LongInt rowcnt;
  
  if (blank(RepSpec.f2)) then begin goto LMaheOREn; end;
  CreateMessageIdentifier(messident);
  rowcnt = 0;
  firstf = true;
  BlockLoad(CYRec);
  fror = FirstInRange(RepSpec.f1,10);
  toor = LastInRange(RepSpec.f1,10);
  keys = 1;
  if (nonblank(RepSpec.f1)) then begin
    ORr.SerNr = fror;
    keys = 2;
  end;
  keystr = "CustCode";
  ORr.CustCode = RepSpec.f2;  
  TrHs = true;
  while (LoopKey(keystr,ORr,keys,TrHs)) begin
    if (ORr.CustCode!=RepSpec.f2) then begin
      TrHs = false;
    end;
    if (nonblank(RepSpec.f1)) then begin
      if (ORr.SerNr>toor) then begin
        TrHs = false;
      end;
    end;
    if (TrHs) then begin
      testf = true;
      if (ORr.OrdDate<RepSpec.sStartDate) then begin
        testf = false;
      end;
      if (ORr.OrdDate>RepSpec.sEndDate) then begin
        testf = false;
      end;
      if (testf) then begin
        if (firstf) then begin
          MaheExportUNB(CYRec.ANACode,ORr,rowcnt);
          firstf = false;
        end;
        MaheExportUNH(messident,rowcnt);
        MaheExportBGM(ORr.SerNr,rowcnt);
        MaheExportDTM("01","200",StringToDate(ORr.PlanShip),rowcnt);
        MaheExportTSR(rowcnt);
        MaheExportMOA(ORr.Sum4,ORr.CurncyCode,rowcnt)
        MaheExportFTX("01","AAI",ORr.Comment,rowcnt);
        MaheExportFTX("01","AAA","",rowcnt);
        MaheExportFTX("01","ZTM","",rowcnt);
        MaheExportFTX("01","SPH","",rowcnt);
        MaheExportFTX("01","OSI","",rowcnt);
        MaheExportTOD(ORr.ShipDeal,ORr.LangCode,rowcnt);
        MaheExportLOC("01","1",ORr.Addr3,rowcnt);
        MaheExportRFF("CU",rowcnt);
        //CPI
        MaheExportTDT("01","20",rowcnt);
        MaheExportDTM("03","10",StringToDate(ORr.PlanShip),rowcnt);
        MaheExportDTM("03","69",StringToDate(ORr.PlanShip),rowcnt);
        MaheExportLOC("03","9","CPH",rowcnt);
        MaheExportTDT("01","21",rowcnt);
        MaheExportDTM("03","133",ORr.OrdDate,rowcnt);
        MaheExportLOC("03","8","",rowcnt);
        MaheExportTDT("01","22",rowcnt);
        MaheExportNAD("01","CZ","",rowcnt);
        MaheExportCTA("01","IC",rowcnt);
        MaheExportCOM("01","TE",rowcnt);
        MaheExportGID("01",rowcnt);
        MaheExportFTX("03","AAI","",rowcnt);
        MaheExportMEA("01","WT",ORr.TotWeight,rowcnt);
        MaheExportMEA("01","VOL",ORr.TotVolume,rowcnt);
        MaheExportMEA("01","PAL",ORr.TotWeight,rowcnt);
        MaheExportPCI("01","28",rowcnt);
      end;
    end;
  end;
  if (firstf==false) then begin
    MaheExportUNT(messident,rowcnt);
  end;
LMaheOREn:;  
  RETURN;
END;
