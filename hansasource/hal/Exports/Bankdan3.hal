#ifdef HAL
external procedure M4PadString(string,Integer,string,Boolean,var string);
external procedure M4WriteDanStr(string,Integer,Boolean);
external procedure FinnishBankVal(var string,val);



global
procedure BankExpDanish3(record OPVc OPr,var val TotSump,var LongInt betcount)
BEGIN
  row OPVc OPrw;
  row OPVc OP2rw;  
  record VIVc VIr;
  record CUVc VEr;
  record BankVc BKr;
  Boolean VEf,BKf,testf;
  val totsum;
  string 255 tstr,t1,t2;
  record CYBlock CompYear;
  record BankFileBlock bfr;
  Boolean hitf;
  Integer rwcnt,i,j;
  
  BlockLoad(bfr);
  BlockLoad(CompYear);
  rwcnt = MatRowCnt(OPr);
  for (i = 0 ; i<rwcnt ;i=i+1) begin
    MatRowGet(OPr,i,OPrw);
    if (OPrw.ovst<>0) then begin goto L88; end;
//    if (blank(OPrw.BankAcc)) then begin goto L88; end;    
    
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)==false) then begin goto L88; end;
    if (VIr.InvType==kInvoiceTypeNormalSpecialSales) then begin VIr.InvType = kInvoiceTypeNormal; end;
    if (VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin VIr.InvType = kInvoiceTypeCredit; end;
    if ((VIr.InvType<kInvoiceTypeNormal) or (VIr.InvType>kInvoiceTypeCredit)) then begin VIr.InvType = kInvoiceTypeNormal; end;

    if ((VIr.InvType==kInvoiceTypeNormal) and (VIr.PayVal<0)) then begin
      VIr.InvType = kInvoiceTypeCredit; 
    end;
    VEr.Code = VIr.VECode;
    VEf = ReadFirstMain(VEr,1,true);
    begin
      testf = true;
      if (VIr.Invalid<>0) then begin testf = false; end;
      if (testf) then begin
        totsum = 0;
        for (j=i;j<rwcnt;j=j+1) begin
          MatRowGet(OPr,j,OP2rw);
          if (OP2rw.VECode==OPrw.VECode) then begin
            totsum = totsum + OP2rw.PInvVal;
          end;
        end;
        if (totsum<0) then begin goto L77; end;
        
        BKr.Code = VEr.AccOperator; 
        BKf = ReadFirstMain(BKr,1,true);        
        if (len(OPrw.BankAcc)>2) then begin
          tstr = "IB030202000003";
          M4WriteDanStr(tstr,14,false);
          M4PadString("1",4,"0",true,t2);
          M4WriteDanStr(t2,4,false);
          t2 = DateToString(OPr.PayDate,"YYYYMMDD");                    
          M4WriteDanStr(tstr,8,false);
          FinnishBankVal(tstr,OPrw.PInvVal);
          tstr = tstr & "+";
          M4PadString(tstr,14,"0",true,t2);
          M4WriteDanStr(t2,14,false);
          M4WriteDanStr("2",1,false);
          tstr = StripNonDigits(OPr.BankAcc);                    
          M4PadString(tstr,15,"0",true,t2);
          M4WriteDanStr(t2,15,false);
          M4WriteDanStr("2",1,false);
          t2 = Left(OPrw.BankAcc,4);
          tstr = StripNonDigits(t2);                    
          M4PadString(tstr,4,"0",true,t2);
          M4WriteDanStr(t2,4,false);
          if (len(OPrw.BankAcc)>4) then begin
            t2 = Right(OPrw.BankAcc,len(OPrw.BankAcc)-4);          
          end else begin
            t2 = " ";
          end;
          tstr = StripNonDigits(t2);                    
          M4PadString(tstr,10,"0",true,t2);
          M4WriteDanStr(t2,10,false);
          M4WriteDanStr("0",1,false);
          M4PadString(OPrw.Comment,35," ",true,t2);
          M4WriteDanStr(t2,35,false);
          M4PadString(VEr.Name,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          M4PadString(VEr.InvAddr0,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          M4PadString(VEr.InvAddr1,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          t2 = Left(OPrw.BankAcc,4);
          tstr = StripNonDigits(t2);                    
          M4PadString(tstr,4,"0",true,t2);
          M4WriteDanStr(t2,4,false);
          M4PadString(VEr.InvAddr2,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          M4PadString(" ",35," ",true,t2);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,7,false);
          M4PadString(" ",215," ",true,t2);
          M4WriteDanStr(t2,215,true);
          NewLine;
          TotSump = TotSump + OPrw.PInvVal;
          betcount = betcount + 1;
        end else begin//11
          tstr = "IB030207000000";
          M4WriteDanStr(tstr,14,false);
          M4PadString("1",4,"0",true,t2);
          M4WriteDanStr(t2,4,false);
          t2 = DateToString(OPr.PayDate,"YYYYMMDD");                    
          M4WriteDanStr(tstr,8,false);
          FinnishBankVal(tstr,OPrw.PInvVal);
          tstr = tstr & "+";
          M4PadString(tstr,14,"0",true,t2);
          M4WriteDanStr(t2,14,false);
          M4WriteDanStr("2",1,false);
          tstr = StripNonDigits(OPr.BankAcc);                              
          M4PadString(tstr,15,"0",true,t2);
          M4WriteDanStr(t2,15,false);
          tstr = Left(OPrw.BankAcc,2);
          M4PadString(tstr,2,"0",true,t2);
          M4WriteDanStr(t2,2,false);
          M4PadString(" ",19," ",true,t2);
          M4WriteDanStr(t2,19,false);
          M4PadString("0",4,"0",true,t2);
          M4WriteDanStr(t2,4,false);
          M4PadString("0",10,"0",true,t2);
          M4WriteDanStr(t2,10,false);
          M4PadString(VEr.RegNr2,8,"0",true,t2);
          M4WriteDanStr(t2,8,false);
          M4PadString(VEr.Name,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          M4PadString(BKr.Name,32," ",true,t2);
          M4WriteDanStr(t2,32,false);
          M4PadString(OPrw.Comment,35," ",true,t2);
          M4WriteDanStr(t2,35,false);
          M4PadString(" ",35," ",true,t2);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(t2,35,false);
          M4PadString(" ",92," ",true,t2);
          M4WriteDanStr(t2,92,false);
          M4PadString(tstr,215," ",true,t2);
          M4WriteDanStr(t2,215,true);
          NewLine;
          TotSump = TotSump + OPrw.PInvVal;
          betcount = betcount + 1;
        end;
L77:;      
      end;
    end;    
L88:;
  end;
L99:;  
//  UserTrace(OPr.SerNr,M4Long);  
  RETURN;
END;  
#endif
