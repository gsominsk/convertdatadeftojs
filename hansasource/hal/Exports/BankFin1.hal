external procedure NewLineExport();

global
procedure BankExpFinland1(record OPVc OPr,Integer today,String curnc)
begin
  record VIVc VIr;
  record CYBlock CompYear;
  record CUVc VEr;
  row OPVc OPrw;
  string 100 tstr;
  val temp;
  val sumfakt,sumkred;
  Integer cntfakt,cntkred;
  Integer i,rwcnt;
  Integer rowcount;
  Integer rowtype;
  Boolean testf;
  Boolean VEf;
  
  BlockLoad(CompYear);
  cntfakt = 0;
  cntkred = 0;
  ExportPadString("LM02",4," ",true);
  ExportPadString("0",1," ",true);
  ExportPadString("0",1," ",true);
  ExportPadString(ConvertSpecStr(OPr.BankAcc,"FINBANKACC"),14," ",true);
  ExportPadString(StripNonDigits(CompYear.OrgNr),9,"0",true);
  ExportPadString(DateToString(CurrentDate,"YYMMDD"),6," ",true);
  tstr = CurrentTime;
  ExportPadString(StripNonDigits(tstr),4," ",false);
  ExportPadString(ConvertSpecStr(OPr.BankAcc,"FINBANKGROUP"),2," ",false);//MH
//  ExportPadString(" ",1," ",true);
  if (today==1) Then Begin
    ExportPadString(DateToString(OPr.TransDate,"YYMMDD"),6," ",true);
  End Else Begin
    ExportPadString(DateToString(CurrentDate,"YYMMDD"),6," ",true);
  End;
  ExportPadString(CompYear.CompName,35," ",false);
  ExportPadString(" ",35," ",false);
  ExportPadString(" ",17," ",false);
  if (curnc=="FIM") then begin
    ExportPadString("0",1,"0",false);
    ExportPadString(" ",65," ",false);
    ExportPadString(" ",23," ",false);
  end;
  if ((curnc=="EUR") or (curnc=="")) then begin
    ExportPadString("1",1,"1",false); 
    ExportPadString(" ",65," ",false);
    ExportPadString(" ",23," ",false);
  end;
  ExportPadString("0",1," ",true);
  ExportPadString(StripNonDigits(CompYear.OrgNr),10,"0",true);
  ExportPadString(" ",66," ",false);
  NewLineExport;

  rwcnt = MatRowCnt(OPr);  
  for (i = 0; i<rwcnt; i=i+1) begin
    MatRowGet(OPr,i,OPrw);
    testf = false;
    If (OPrw.ovst==0) AND (OPrw.stp==1) Then Begin
      testf = true;
    End;
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)==false) then begin
      testf = false;
    end;
    if (testf) then begin
      if (VIr.Invalid<>0) then begin testf = false; end;
    end;
    if (testf==true) then begin
      VEr.Code = VIr.VECode;
      VEf = ReadFirstMain(VEr,1,true);
      if (OPrw.RecVal<0) then begin
        cntkred = cntkred + 1;
//        temp = 0 - OPrw.RecVal;
        temp = 0 - OPrw.BankVal;
        sumkred = sumkred + temp;
        rowtype = 2;
      end else begin
        cntfakt = cntfakt + 1;
//        sumfakt = sumfakt + OPrw.RecVal;
        sumfakt = sumfakt + OPrw.BankVal;
        rowtype = 0;
      end;
      ExportPadString("LM02",4," ",true);
      ExportPadString("1",1," ",true);
      ExportPadString(rowtype,1," ",true);
      ExportPadString(ConvertSpecStr(OPr.BankAcc,"FINBANKACC"),14," ",true);
      ExportPadString(VIr.VEName,30," ",false);
      ExportPadString(" ",20," ",false);
      ExportPadString(" ",20," ",false);
      ExportPadString(ConvertSpecStr(OPrw.BankAcc,"FINBANKACC"),14," ",true);
      ExportPadString("89",3," ",true);
      if (nonblank(VIr.RefStr)) then begin
        ExportPadString("1",1," ",true);
        ExportPadString(VIr.RefStr,20,"0",true);
        ExportPadString(" ",50," ",true);
      end else begin
        ExportPadString("2",1," ",true);
        if (VEf) then begin
          ExportPadString(VEr.VECustID,10," ",false);
        end else begin
          ExportPadString(" ",10," ",false);
        end;
        ExportPadString(VIr.InvoiceNr,15," ",false);
        ExportPadString(DateToString(VIr.InvDate,"YYMMDD"),6," ",false);
        ExportPadString(" ",39," ",false);
      end;
      ExportPadString(" ",2," ",false);
      ExportPadString(DateToString(OPr.TransDate,"YYMMDD"),6," ",false);
      if (OPrw.RecVal<0) then begin
//        temp = 0 - OPrw.RecVal;
        temp = 0 - OPrw.BankVal;
      end else begin
//        temp = OPrw.RecVal;
        temp = OPrw.BankVal;
      end;
      ExportPadString(ValToString(temp,M4Val,"","",0),12,"0",true);
      ExportPadString("0",1,"0",false);
      ExportPadString("0",4,"0",false); 
      ExportPadString("0",12,"0",false);
      ExportPadString(OPrw.Comment,20," ",false);
      ExportPadString(OPrw.Objects,20," ",false);
      ExportPadString(OPrw.Objects,5," ",false);
      ExportPadString(OPrw.Objects,40," ",false);
      NewLineExport;
    end;
  end;
  UserTrace("" & OPr.SerNr,2);
  ExportPadString("LM02",4," ",true);
  ExportPadString("9",1," ",true);
  ExportPadString("0",1," ",true);
  ExportPadString(ConvertSpecStr(OPr.BankAcc,"FINBANKACC"),14," ",true);
  ExportPadString(StripNonDigits(CompYear.OrgNr),9,"0",true);
  ExportPadString(DateToString(CurrentDate,"YYMMDD"),6," ",true);
  ExportPadString(cntfakt,6,"0",true);
  ExportPadString(ValToString(sumfakt,M4Val,"","",0),13,"0",true);
  ExportPadString(cntkred,6,"0",true);
  ExportPadString(ValToString(sumkred,M4Val,"","",0),13,"0",true);
  ExportPadString(" ",35," ",false);
  ExportPadString(" ",17," ",false);
  ExportPadString(" ",69," ",false);
  ExportPadString(" ",106," ",false);
  NewLineExport;
  return;
End;



