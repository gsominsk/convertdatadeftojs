external procedure StripLeadingSpaces(var string);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external procedure SplitAddress(string,var string,var string);
external procedure GetCountry(string,var string);
external procedure RemoveCharacterFromString(var string,string);
external procedure FinnishBankVal(var string,val);
external procedure CreateKIDCode2(string,LongInt,var string,record BankFileBlock);
external procedure M4PadString(string,Integer,string,Boolean,var string);
external procedure CalcNorCheck(var string,Boolean);

procedure SplitStrings(var string str1,var string str2,Integer pos)
BEGIN
  string 255 tstr;
  LongInt i,j,start;
  string 1 ch;
  
  ch = Mid(str1,pos,1);
  if (ch==" ") then begin
    start = pos + 1;
  end else begin
    start = pos;
  end;  
  j = 0;
  for (i=start;i<=len(str1);i=i+1) begin
    tstr = tstr & Mid(str1,i,1);
  end;
  if (nonblank(str2)) then begin
    tstr = tstr & " ";
  end;
  tstr = tstr & str2;
  str2 = tstr;
  str1 = Mid(str1,0,pos-1);
  RETURN; 
END;

procedure AddQuotationToString(string tstr,var string res)
BEGIN
  res = "\"";
  res = res & tstr;
  res = res & "\"";
  res = res & " ";
  RETURN;
END;

procedure GetFactPayTermNor(record IVVc IVp,var string res)
BEGIN
  record PDVc PDp;
  string 255 tstr;
  
  PDp.Code = IVp.PayDeal;
  if (ReadFirstMain(PDp,1,true)) then begin
    if (PDp.PDType==3) then begin
      res = "00000";
    end;
// I don't think 4 or 6 is working here
    if ((PDp.PDType==1) or (PDp.PDType==kInvoiceTypeCash) or (PDp.PDType==4) or (PDp.PDType==kInvoiceTypeDebit) or (PDp.PDType==6) or (PDp.PDType==7)) then begin
      if (PDp.pdrdays>0) then begin
        if (PDp.pdrdays<99) then begin
          res = "0";
        end;   
        if (PDp.pdrdays<9) then begin
          res = "0";
        end;  
        tstr = PDp.pdrdays;
        res = res & tstr;
        tstr = PDp.pdvrebt;
        tstr = Left(tstr,len(tstr)-1);  // remove one decimal 
        if (len(tstr)>3) then begin
          res = res & "00";
        end else begin
          res = res & Mid(tstr,1,1);
          res = res & Mid(tstr,3,1);
        end;
      end else begin
        res = "00000";
      end;
    end;
  end else begin
    res = "00000";
  end;
  RETURN;
END;

procedure ExpFactIVNor(record RcVc RepSpec,record IVVc IVp,Integer bnr,Integer typ,record BankFileBlock BankFileRec)
BEGIN
  record CUVc CUr;
  row IVVc IVrw;
  Integer i,rwcnt;
  string 255 tstr,t2,t3;
  val rs;
  boolean mod10;
  
  if (typ==2) then begin// Gjensidige Bank 
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "9";
    end else begin
      tstr = "1";
    end;  
    ExportPadString(tstr,1," ",false);
    ExportPadString(RepSpec.f3,4,"0",true);
    ExportPadString(IVp.CustCode,9,"0",true);
    ExportPadString(IVp.SerNr,8,"0",true);
    tstr = DateToString(IVp.InvDate,"DDMMYY");
    ExportPadString(tstr,6," ",false);
    tstr = DateToString(IVp.PayDate,"DDMMYY");
    ExportPadString(tstr,6," ",false);
    rs = MulRateToBase1(IVp.CurncyCode,IVp.Sum4,IVp.FrRate,IVp.ToRateB1,IVp.ToRateB2,IVp.BaseRate1,IVp.BaseRate2,DefaultCurRoundOff);
    FinnishBankVal(tstr,rs);
    ExportPadString(tstr,11,"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      if (MatRowCnt(IVp)>0) then begin
        MatRowGet(IVp,0,IVrw);
        if (IVrw.stp==3) then begin
          tstr = IVrw.OrdRow;
          ExportPadString(tstr,8,"0",true);
        end else begin
          tstr = " ";
          ExportPadString(tstr,8," ",false);
        end;
      end else begin
        tstr = " ";
        ExportPadString(tstr,8," ",false);
      end;
      tstr = " ";
      ExportPadString(tstr,5," ",false);
    end else begin
      GetFactPayTermNor(IVp,tstr);
      ExportPadString(tstr,5,"0",false);
      tstr = " ";
      ExportPadString(tstr,8," ",false);
    end;
    ExportPadString(IVp.InvComment,40," ",false);
    ExportPadString(IVp.SalesMan,4," ",false);
    tstr = " ";
    ExportPadString(tstr,7," ",false);
    ExportPadString(IVp.CurncyCode,3," ",false);
    FinnishBankVal(tstr,IVp.Sum4);
    ExportPadString(tstr,11,"0",true);
    tstr = " ";
    ExportPadString(tstr,5," ",false);
    NewLine;
  end;
  if (typ==3) then begin// Factoring Finans 
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "N56";
    end else begin
      tstr = "N55";
    end;    
    ExportPadString(tstr,3," ",false);
    ExportPadString(IVp.CustCode,8,"0",true);
    ExportPadString(RepSpec.f3,4,"0",true);
    tstr = "";
    ExportPadString(tstr,2,"0",true);
    tstr = DateToString(CurrentDate,"DDMMYY");
    ExportPadString(tstr,6," ",true);
    ExportPadString(bnr,3,"0",true);
    if (nonblank(RepSpec.CurncyCode)) then begin
      tstr = RepSpec.CurncyCode;
    end else begin
      tstr = "NOM";
    end;    
    ExportPadString(tstr,3," ",false);
    tstr = DateToString(IVp.InvDate,"DDMMYY");
    ExportPadString(tstr,6," ",true);
    ExportPadString(IVp.SerNr,7,"0",true);
    FinnishBankVal(tstr,IVp.Sum4);
    ExportPadString(tstr,11,"0",true);
    tstr = "";
    ExportPadString(tstr,4," ",false); 
    tstr = "V";
    ExportPadString(tstr,1," ",false);
    tstr = DateToString(IVp.PayDate,"DDMMYY");
    ExportPadString(tstr,6," ",true);
    tstr = "";
    ExportPadString(tstr,5," ",false); 
    ExportPadString(IVp.InvComment,15," ",false);
    ExportPadString(IVp.SalesMan,4," ",false);
    NewLine;
  end;
  if (typ==6) then begin// Nord Finans NOR
    ExportPadString(RepSpec.f3,3,"0",false);
    IVp.CustCode = UpperCase(IVp.CustCode);        
    ExportPadString(IVp.CustCode,6,"0",true);
    ExportPadString(IVp.SerNr,6,"0",true);
    tstr = DateToString(IVp.InvDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = DateToString(IVp.PayDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = DateToString(CurrentDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = "0";
    ExportPadString(tstr,5,"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "22";
    end else begin 
      tstr = "21";
    end;    
    ExportPadString(tstr,2,"0",true);
    FinnishBankVal(tstr,IVp.Sum4);
    ExportPadString(tstr,11,"0",true);
    CreateKIDCode2(IVp.CustCode,IVp.SerNr,tstr,BankFileRec);  
    if ( BankFileRec.KIDMod == 0 ) then begin
      mod10 = true;
    end else begin
      mod10 = false;    
    end;
    CalcNorCheck(tstr,mod10);
    ExportPadString(tstr,16,"0",false); 
    tstr = " ";
    ExportPadString(tstr,61," ",false);      
    NewLine;        
  end;
  if (typ==7) then begin//Finance Credit Norge ASA         
    CUr.Code = IVp.CustCode;
    if (ReadFirstMain(CUr,1,true)) then begin
    end;        
    M4PadString(RepSpec.f3,3,"0",true,t2);  
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    M4PadString(IVp.CustCode,8,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    tstr = DateToString(IVp.InvDate,"YYYYMMDD");
    M4PadString(tstr,8,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    M4PadString(IVp.SerNr,8,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "22";
    end else begin
      tstr = "21";
    end;  
    M4PadString(tstr,2,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    tstr = " ";
    M4PadString(tstr,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    tstr = DateToString(IVp.PayDate,"YYYYMMDD");
    M4PadString(tstr,8,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      rs = -IVp.Sum4;   
    end else begin
      rs = IVp.Sum4;
    end;
    FinnishBankVal(tstr,rs);
    M4PadString(tstr,20,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    CreateKIDCode2(IVp.CustCode,IVp.SerNr,tstr,BankFileRec);
    M4PadString(tstr,25,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    M4PadString(IVp.Addr0,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    M4PadString(IVp.Addr1,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    M4PadString(IVp.Addr2,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    IVp.Addr3 = UpperCase(IVp.Addr3);
    t3 = "";
    tstr = IVp.Addr3;
    if (len(tstr)>4) then begin
      SplitStrings(tstr,t3,5);
      tstr = Left(tstr,4);
    end else begin
      tstr = IVp.Addr3;
    end;      
    M4PadString(tstr,6,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    M4PadString(t3,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    M4PadString(CUr.Phone,10,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    M4PadString(CUr.Fax,10,"0",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr),"0",true);
    M4PadString(IVp.OurContact,30," ",true,t2);
    AddQuotationToString(t2,tstr);
    ExportPadString(tstr,len(tstr)," ",true);
    NewLine;
  end;
  if (typ==8) then begin//Kredittstyring 
    ExportPadString(IVp.CustCode,8,"0",true);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.Addr0,30," ",false);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.Addr1,30," ",false);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.Addr2,30," ",false);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.Addr3,30," ",false);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.Phone,12," ",false);
    ExportPadString(",",1," ",true);
    ExportPadString(IVp.VATNr,11,"0",true);
    ExportPadString(",",1," ",false);
    ExportPadString("B",1," ",false);
    ExportPadString(",",1," ",false);
    ExportPadString(IVp.OurContact,15," ",false);
    ExportPadString(",",1," ",false);
    ExportPadString(IVp.SerNr,12,"0",true);
    ExportPadString(",",1," ",false);
    tstr = DateToString(IVp.InvDate,"DDMMYY");
    ExportPadString(tstr,len(tstr),"0",true);
    ExportPadString(",",1," ",false);
    tstr = DateToString(IVp.PayDate,"YYMMDD");
    ExportPadString(tstr,len(tstr),"0",true);
    ExportPadString(",",1," ",false);
    ExportPadString(IVp.CurncyCode,len(IVp.CurncyCode)," ",false);
    ExportPadString(",",1," ",false);
    ExportPadString(IVp.CustOrdNr,30," ",false);
    ExportPadString(",",1," ",false);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = -IVp.Sum4;   
    end else begin
      tstr = IVp.Sum4;
    end;  
    ExportPadString(tstr,len(tstr),"0",true);
    ExportPadString(",",1," ",false);          
    rwcnt = MatRowCnt(IVp);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(IVp,i,IVrw);
      ExportPadString(IVrw.Spec,len(IVrw.Spec)," ",false);
      ExportPadString(",",1," ",false);
    end;            
  end;
  if (typ==20) then begin// Nord Finans - DK HŠr
    ExportPadString(RepSpec.f3,3,"0",false);
    IVp.CustCode = UpperCase(IVp.CustCode);        
    ExportPadString(IVp.CustCode,6,"0",true);
    ExportPadString(IVp.SerNr,6,"0",true);
    tstr = DateToString(IVp.InvDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = DateToString(IVp.PayDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = DateToString(CurrentDate,"YYMMDD");
    ExportPadString(tstr,6,"0",true);
    tstr = "0";
    ExportPadString(tstr,5,"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "22";
    end else begin 
      tstr = "21";
    end;    
    ExportPadString(tstr,2,"0",true);
    FinnishBankVal(tstr,IVp.Sum4);
    ExportPadString(tstr,11,"0",true);
    CreateKIDCode2(IVp.CustCode,IVp.SerNr,tstr,BankFileRec);  
    if ( BankFileRec.KIDMod == 0 ) then begin
      mod10 = true;
    end else begin
      mod10 = false;    
    end;
    CalcNorCheck(tstr,mod10);
    ExportPadString(tstr,16,"0",false); 
    tstr = " ";
    ExportPadString(tstr,61," ",false);      
    NewLine;        
  end;
  if (typ==26) then begin// SG Finans NOR
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      tstr = "9";
    end else begin
      tstr = "1";
    end;  
    ExportPadString(tstr,1," ",false);
    ExportPadString(RepSpec.f3,4,"0",true);
    ExportPadString(IVp.CustCode,9,"0",true);
    ExportPadString(IVp.SerNr,8,"0",true);
    tstr = DateToString(IVp.InvDate,"YYMMDD");
    ExportPadString(tstr,6," ",false);
    tstr = DateToString(IVp.PayDate,"YYMMDD");
    ExportPadString(tstr,6," ",false);
    rs = MulRateToBase1(IVp.CurncyCode,IVp.Sum4,IVp.FrRate,IVp.ToRateB1,IVp.ToRateB2,IVp.BaseRate1,IVp.BaseRate2,DefaultCurRoundOff);
    FinnishBankVal(tstr,rs);
    ExportPadString(tstr,11,"0",true);
    if (IVp.InvType==kInvoiceTypeCredit or IVp.InvType==kInvoiceTypeCreditSpecialSales) then begin
      if (MatRowCnt(IVp)>0) then begin
        MatRowGet(IVp,0,IVrw);
        if (IVrw.stp==3) then begin
          tstr = IVrw.OrdRow;
          ExportPadString(tstr,8,"0",true);
        end else begin
          tstr = " ";
          ExportPadString(tstr,8," ",false);
        end;
      end else begin
        tstr = " ";
        ExportPadString(tstr,8," ",false);
      end;
      tstr = " ";
      ExportPadString(tstr,5," ",false);
    end else begin
      GetFactPayTermNor(IVp,tstr);
      ExportPadString(tstr,5,"0",false);
      tstr = " ";
      ExportPadString(tstr,8," ",false);
    end;
    ExportPadString(IVp.InvComment,40," ",false);
    ExportPadString(IVp.SalesMan,4," ",false);
    tstr = " ";
    ExportPadString(tstr,7," ",false);
    ExportPadString(IVp.CurncyCode,3," ",false);
    FinnishBankVal(tstr,IVp.Sum4);
    ExportPadString(tstr,11,"0",true);
    tstr = " ";
    ExportPadString(tstr,5," ",false);
    NewLine;
  end;

  RETURN;
END;

procedure ExpFactHeaderIVNor(record RcVc RepSpec,record IVVc IVp,val debp,val credp,Integer LastSerNr,Integer typ)
BEGIN
  string 255 tstr;
  
  if ((typ==2) or (typ==6) or (typ==7) or (typ==8) or (typ==20) or (typ==26)) then begin // HŠr
//2: // Gjensidige Bank 
//6: // Nord Finans NOR
//7: // Finance Credit Norge ASA 
//8: // Kredittstyring 
//20: // Nord Finans DK
//26: //SG Finans NOR
  end else begin
    tstr = "N54";
    ExportPadString(tstr,3," ",false);
    ExportPadString(RepSpec.f3,4,"0",true);
    tstr = "";
    ExportPadString(tstr,2,"0",true);
    if (typ==2) then begin
      tstr = DateToString(CurrentDate,"DDMMYY");
    end else begin
      tstr = DateToString(CurrentDate,"DDMMYY");
    end;
    ExportPadString(tstr,6," ",true);
    tstr = LastSerNr;
    ExportPadString(tstr,3,"0",true);
    if (nonblank(RepSpec.CurncyCode)) then begin
      tstr = RepSpec.CurncyCode;
    end else begin
      tstr = "NOM";
    end;   
    ExportPadString(tstr,3," ",false);
    FinnishBankVal(tstr,debp);
    ExportPadString(tstr,13,"0",true);
    FinnishBankVal(tstr,credp);
    ExportPadString(tstr,13,"0",true);
    NewLine;
   end;  
  RETURN;
END;

procedure ExpFactCUNor(record RcVc RepSpec,record IVVc IVp,Integer typ)
BEGIN
  record CUVc CUr;
  string 255 tstr,pnr,stad;
  
  CUr.Code = IVp.CustCode;
  if (ReadFirstMain(CUr,1,true)) then begin
    if (typ==2) then begin // Gjensidige Bank 
      tstr = "K";
      ExportPadString(tstr,1," ",false);
      tstr = "9409";
      ExportPadString(tstr,4," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      ExportPadString(CUr.Code,9,"0",true);
      ExportPadString(CUr.VATNr,11," ",false);
      ExportPadString(CUr.Name,35," ",false);
      tstr = " ";
      ExportPadString(tstr,20," ",false);
      ExportPadString(CUr.InvAddr0,30," ",false);
      if (blank(CUr.InvAddr2)) then begin
        SplitAddress(CUr.InvAddr1,pnr,stad);
      end else begin
        SplitAddress(CUr.InvAddr2,pnr,stad);
      end;
      tstr = pnr;
      //BUG; this removes all characters from tstr.
      //Returns blank.
    //  RemoveCharacterFromString(tstr," ");      
      ExportPadString(tstr,4," ",false);
      ExportPadString(stad,23," ",false);
      ExportPadString(CUr.Person,20," ",false);
      ExportPadString(CUr.Phone,12," ",false);
      GetCountry(CUr.CountryCode,tstr);
      ExportPadString(tstr,20," ",false);
      ExportPadString(CUr.CountryCode,2," ",false);
      tstr = " ";
      ExportPadString(tstr,18," ",false);
      NewLine;
    end;
    if (typ==3) then begin // Factoring Finans 
      tstr = "K01";
      ExportPadString(tstr,3," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      tstr = "N";
      ExportPadString(tstr,1," ",false);
      tstr = "";
      ExportPadString(tstr,8," ",false);
      ExportPadString(CUr.Code,7," ",false);
      tstr = "1";
      ExportPadString(tstr,1," ",false);
      ExportPadString(CUr.Name,30," ",false);
      ExportPadString(CUr.VATNr,11,"0",true);
      NewLine;
      tstr = "K01";
      ExportPadString(tstr,3," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      tstr = "N";
      ExportPadString(tstr,1," ",false);
      tstr = "";
      ExportPadString(tstr,8," ",false);
      ExportPadString(CUr.Code,7," ",false);
      tstr = "2";
      ExportPadString(tstr,1," ",false);
      ExportPadString(CUr.InvAddr0,30," ",false);
      NewLine;
      tstr = "K01";
      ExportPadString(tstr,3," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      tstr = "N";
      ExportPadString(tstr,1," ",false);
      tstr = "";
      ExportPadString(tstr,8," ",false);
      ExportPadString(CUr.Code,7," ",false);
      tstr = "3";
      ExportPadString(tstr,1," ",false);
      ExportPadString(CUr.InvAddr1,30," ",false);
      NewLine;
      tstr = "K01";
      ExportPadString(tstr,3," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      tstr = "N";
      ExportPadString(tstr,1," ",false);
      tstr = "";
      ExportPadString(tstr,8," ",false);
      ExportPadString(CUr.Code,7," ",false);
      tstr = "4";
      ExportPadString(tstr,1," ",false);
      if (blank(CUr.InvAddr2)) then begin
        SplitAddress(CUr.InvAddr1,pnr,stad);
      end else begin
        SplitAddress(CUr.InvAddr2,pnr,stad);
      end;
      ExportPadString(pnr,4," ",false);
      tstr = "";
      ExportPadString(tstr,1," ",false);
      ExportPadString(stad,15," ",false);
      ExportPadString(tstr,4,"0",false); 
      ExportPadString(tstr,1,"0",false); 
      ExportPadString(tstr,4,"0",false); 
      ExportPadString(CUr.Code,8," ",false);
      ExportPadString(tstr,4,"0",false); 
      NewLine;
    end;
    if (typ==6) then begin // Nord Finans - NOR
      tstr = "A";
      ExportPadString(tstr,1," ",false);
      CUr.Code = UpperCase(CUr.Code);
      ExportPadString(CUr.Code,6,"0",true);        
      CUr.Name = UpperCase(CUr.Name);
      ExportPadString(CUr.Name,30," ",false);
      ExportPadString(CUr.Name,10," ",false);
      if ( CUr.BankAccount <> "") then begin
        ExportPadString(CUr.BankAccount,11,"0",true);
      end else begin
        ExportPadString(CUr.BankAccount,11," ",true);      
      end;
      ExportPadString(CUr.Phone,13," ",false);
      tstr = " ";
      ExportPadString(tstr,57," ",false);
      NewLine;
      tstr = "B";
      ExportPadString(tstr,1," ",false);
      CUr.Code = UpperCase(CUr.Code);
      ExportPadString(CUr.Code,6,"0",true);
      IVp.Addr1 = UpperCase(IVp.Addr1);
      ExportPadString(IVp.Addr1,30," ",false);
      CUr.Person = UpperCase(CUr.Person);
      ExportPadString(CUr.Person,30," ",false);
      IVp.Addr3 = UpperCase(IVp.Addr3);
      tstr = "";
      if (nonblank(IVp.Addr3)) then begin
        SplitStrings(IVp.Addr3,tstr,5);
      end;  
      ExportPadString(IVp.Addr3,4,"0",true);
      ExportPadString(tstr,26," ",false);
      tstr = " ";
      ExportPadString(tstr,31," ",false);        
      NewLine;
    end;
    if (typ==20) then begin // Nord Finans - DK HŠr
      tstr = "A";
      ExportPadString(tstr,1," ",false);
      CUr.Code = UpperCase(CUr.Code);
      ExportPadString(CUr.Code,6,"0",true);        
      CUr.Name = UpperCase(CUr.Name);
      ExportPadString(CUr.Name,30," ",false);
      ExportPadString(CUr.Name,10," ",false);
      if ( CUr.BankAccount <> "") then begin
        ExportPadString(CUr.BankAccount,11,"0",true);
      end else begin
        ExportPadString(CUr.BankAccount,11," ",true);      
      end;
      ExportPadString(CUr.Phone,13," ",false);
      tstr = " ";
      ExportPadString(tstr,57," ",false);
      NewLine;
      tstr = "B";
      ExportPadString(tstr,1," ",false);
      CUr.Code = UpperCase(CUr.Code);
      ExportPadString(CUr.Code,6,"0",true);
      IVp.Addr1 = UpperCase(IVp.Addr1);
      ExportPadString(IVp.Addr1,30," ",false);
      CUr.Person = UpperCase(CUr.Person);
      ExportPadString(CUr.Person,30," ",false);
      IVp.Addr3 = UpperCase(IVp.Addr3);
      tstr = "";
      if (nonblank(IVp.Addr3)) then begin
        SplitStrings(IVp.Addr3,tstr,5);
      end;  
      ExportPadString(IVp.Addr3,4,"0",true);
      ExportPadString(tstr,26," ",false);
      tstr = " ";
      ExportPadString(tstr,31," ",false);        
      NewLine;
    end;
    if (typ==26) then begin // SG Finans NOR
      tstr = "K";
      ExportPadString(tstr,1," ",false);
      tstr = "9409";
      ExportPadString(tstr,4," ",false);
      ExportPadString(RepSpec.f3,4,"0",true);
      ExportPadString(CUr.Code,9,"0",true);
      ExportPadString(CUr.VATNr,11,"0",true);
      ExportPadString(CUr.Name,35," ",false);
      tstr = " ";
      ExportPadString(tstr,20," ",false);
      ExportPadString(CUr.InvAddr0,30," ",false);
      if (blank(CUr.InvAddr2)) then begin
        SplitAddress(CUr.InvAddr1,pnr,stad);
      end else begin
        SplitAddress(CUr.InvAddr2,pnr,stad);
      end;
      StripLeadingSpaces(stad);
      tstr = pnr;
      ExportPadString(tstr,4," ",false);
      ExportPadString(stad,23," ",false);
      ExportPadString(CUr.Person,20," ",false);
      ExportPadString(CUr.Phone,12," ",false);
      GetCountry(CUr.CountryCode,tstr);
      ExportPadString(tstr,20," ",false);
      ExportPadString(CUr.CountryCode,2," ",false);
      tstr = " ";
      ExportPadString(tstr,18," ",false);
      ExportPadString(tstr,35," ",false);
      ExportPadString(CUr.CurncyCode,3," ",false);
      NewLine;
    end;

  end;
  RETURN;
END;

global
procedure ExportInvFactNor(var record RcVc RepSpec,var record FactoringBlock factp)
BEGIN
  record IVVc IVr;
  Boolean TrHs;
  string 20 fromcust,tocust;
  Boolean testf;
  Integer bnr;
  Integer cnt;
  val bsum,credsum;
  record BankFileBlock BankFileRec;
  record CUvc CUr;
  vector Boolean custexportedf;

  BlockLoad(BankFileRec);
  bnr = 1;
  cnt = 0;
  if (factp.Bank==26) then begin
    if (SetExportCodepage("ISO-8859-1")==false) then begin
      LogText(0,"Failed to set codepage ISO-8859-1");
    end;
  end else begin
    if (SetExportCodepage("CP437")==false) then begin
      LogText(0,"Failed to set codepage CP437");
    end;
  end;
  RepSpec.long1 = FirstInRange(RepSpec.f1,10);
  RepSpec.long2 = LastInRange(RepSpec.f1,10);
  fromcust = FirstInRange(RepSpec.f2,20);
  tocust = LastInRange(RepSpec.f2,20);

  IVr.SerNr = RepSpec.long1;
  IVr.InvDate = RepSpec.sStartDate;
  TrHs = true;
  if (RepSpec.flags[1]==0) then begin
// export customer
    while (LoopKey("InvDate",IVr,2,TrHs)) begin
      if (IVr.TransDate>RepSpec.sEndDate) then begin TrHs = false; end;
      if (TrHs) then begin
        testf = true;
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr>RepSpec.long2) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr<RepSpec.long1) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f2)) then begin
          if ((IVr.CustCode<fromcust) or (IVr.CustCode>tocust)) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.ObjStr)) then begin
          if (SetInSet(RepSpec.ObjStr,IVr.Objects)==false) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.CurncyCode)) then begin
          if (IVr.CurncyCode!=RepSpec.CurncyCode) then begin testf = false; end;
        end;
        if (IVr.OKFlag==0) then begin testf = false; end;
        if (IVr.Invalid!=0) then begin testf = false; end;
        if (IVr.InvType==kInvoiceTypeCash) then begin testf = false; end;
        CUr.Code = IVr.CustCode;
        if (ReadFirstMain(CUr,1,true)) then begin end;
        if (CUr.NoFactoringFlag!=0) then begin testf = false; end;
        if (custexportedf[IVr.CustCode]==true) then begin testf = false; end;
        if (testf) then begin
          ExpFactCUNor(RepSpec,IVr,factp.Bank);
          UserTrace(IVr.CustCode,M4Str);
          custexportedf[IVr.CustCode] = true;
        end;
      end;
    end;
  end;
  if (RepSpec.flags[1]==1) then begin
    IVr.SerNr = RepSpec.long1;
    IVr.InvDate = RepSpec.sStartDate;
    TrHs = true;
// export the invoices 
    ResetLoop(IVr);
    while (LoopKey("InvDate",IVr,2,TrHs)) begin
      if (IVr.TransDate>RepSpec.sEndDate) then begin TrHs = false; end;
      if (TrHs) then begin
        testf = true;
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr>RepSpec.long2) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr<RepSpec.long1) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f2)) then begin
          if ((IVr.CustCode<fromcust) or (IVr.CustCode>tocust)) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.ObjStr)) then begin
          if (SETINSET(RepSpec.ObjStr,IVr.Objects)==false) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.CurncyCode)) then begin
          if (IVr.CurncyCode!=RepSpec.CurncyCode) then begin testf = false; end;
        end;
        if (IVr.OKFlag==0) then begin testf = false; end;
        if (IVr.Invalid!=0) then begin testf = false; end;
        if (IVr.InvType==kInvoiceTypeCash) then begin testf = false; end;
        if (testf) then begin
          if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin
            credsum = credsum + IVr.Sum4;
          end else begin
            bsum = bsum + IVr.Sum4;
          end;  
        end;
      end;
    end;
    if ((bsum!=0) or (credsum!=0)) then begin
      ExpFactHeaderIVNor(RepSpec,IVr,bsum,credsum,factp.LastSerNr,factp.Bank);
    end;      
    IVr.SerNr = RepSpec.long1;
    IVr.InvDate = RepSpec.sStartDate;
    TrHs = true;
    ResetLoop(IVr);
    while (LoopKey("InvDate",IVr,2,TrHs)) begin
      if (IVr.TransDate>RepSpec.sEndDate) then begin TrHs = false; end;
      if (TrHs) then begin
        testf = true;
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr>RepSpec.long2) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f1)) then begin
          if (IVr.SerNr<RepSpec.long1) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.f2)) then begin
          if ((IVr.CustCode<fromcust) or (IVr.CustCode>tocust)) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.ObjStr)) then begin
          if (SetInSet(RepSpec.ObjStr,IVr.Objects)==false) then begin testf = false; end;
        end;  
        if (nonblank(RepSpec.CurncyCode)) then begin
          if (IVr.CurncyCode!=RepSpec.CurncyCode) then begin testf = false; end;          
        end;
        CUr.Code = IVr.CustCode;
        if (ReadFirstMain(CUr,1,true)) then begin end;
        if (CUr.NoFactoringFlag!=0) then begin testf = false; end;
        if (IVr.OKFlag==0) then begin testf = false; end;
        if (IVr.Invalid!=0) then begin testf = false; end;
        if (IVr.InvType==kInvoiceTypeCash) then begin testf = false; end;
        if (testf) then begin
          ExpFactIVNor(RepSpec,IVr,factp.LastSerNr,factp.Bank,BankFileRec);
          cnt = cnt + 1;
          if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales) then begin
            credsum = credsum + IVr.Sum4;
          end else begin
            bsum = bsum + IVr.Sum4;
          end;  
          UserTrace(IVr.SerNr,M4Long);
        end;
      end;
    end;
    factp.LastSerNr = factp.LastSerNr + 1;
    factp.LastDate = CurrentDate;
  end;
  RETURN;
END;
