#ifdef HAL
external procedure M4PadString(string,Integer,string,Boolean,var string);
external procedure M4WriteDanStr(string,Integer,Boolean);
external procedure CalcNorCheck(var string,Boolean);

procedure CreateDanishCheckCiffer(string instr,var string res)
BEGIN
  string 255 tstr,t2;

  tstr = instr;
  M4PadString(tstr,14,"0",true,t2);  
  CalcNorCheck(t2,true);
  res = t2;
  RETURN;
END;

global
procedure BankExpDanish1(record OPVc OPr)
BEGIN
  Integer i,j,rwcnt;
  row OPVc OPrw;
  row OPVc OP2rw;  
  record VIVc VIr;
  record CUVc VEr;
  record BankVc BKr;
  Boolean VEf,BKf,testf;
  val totsum;
  string 255 tstr,t1,t2;
  record CYBlock CompYear;
  record BankFileBlock bfr;

  BlockLoad(bfr);
  BlockLoad(CompYear);

  rwcnt = MatRowCnt(OPr);
  for (i = 0 ; i<rwcnt ;i=i+1) begin
    MatRowGet(OPr,i,OPrw);
    if (OPrw.ovst<>0) then begin goto L88; end;
    if (blank(OPrw.BankAcc)) then begin goto L88; end;    
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)==false) then begin goto L88; end;
    if (VIr.InvType==kInvoiceTypeNormalSpecialSales) then begin VIr.InvType = kInvoiceTypeNormal; end;
    if (VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin VIr.InvType = kInvoiceTypeCredit; end;
    if ((VIr.InvType<kInvoiceTypeNormal) or (VIr.InvType>kInvoiceTypeCredit)) then begin VIr.InvType = kInvoiceTypeNormal; end;
    if ((VIr.InvType==kInvoiceTypeNormal) and (VIr.PayVal<0)) then begin
      VIr.InvType = kInvoiceTypeCredit;
    end;
    VEr.Code = VIr.VECode;
    VEf = ReadFirstMain(VEr,1,true);
    begin
      testf = true;
      if (VIr.Invalid<>0) then begin testf = false; end;
      if (testf) then begin
        totsum = 0;
        for (j=i;j<rwcnt;j=j+1) begin          
          MatRowGet(OPr,j,OP2rw);
          if (OP2rw.VECode==OPrw.VECode) then begin
            totsum = totsum + OP2rw.PInvVal;
          end;
        end;
        if (totsum<0) then begin goto L77; end;        
        BKr.Code = VEr.AccOperator;
        BKf = ReadFirstMain(BKr,1,true);
        if (len(OPrw.BankAcc)>2) then begin
          tstr = "003";
          M4WriteDanStr(tstr,3,false);
          tstr = "003";
          M4WriteDanStr(tstr,3,false);
          t2 = DateToString(OPr.PayDate,"YYYYMMDD");          
          tstr = Left(t2,4);
          tstr = tstr & "-";
          t1 = Right(t2,len(t2)-4);
          t1 = Left(t1,2);
          t1 = t1 & "-";
          tstr = tstr & t1;
          t1 = Right(t2,len(t2)-6);
          tstr = tstr & t1;
          if (len(tstr)>10) then begin tstr = Left(tstr,10); end;
          M4WriteDanStr(tstr,10,false);
          tstr = OPrw.PInvVal;
          M4WriteDanStr(tstr,15,false);
          tstr = "00000000";
          M4WriteDanStr(tstr,8,false);
          M4WriteDanStr(tstr,8,false);
          if (len(OPr.BankAcc)>4) then begin
            t1 = Right(OPr.BankAcc,len(OPr.BankAcc)-4);            
          end else begin
            t1 = "0";
          end;
          tstr = StripNonDigits(t1);          
          M4WriteDanStr(tstr,11,false);
          if (len(OPrw.BankAcc)>4) then begin
            tstr = Left(OPrw.BankAcc,4);
            M4WriteDanStr(tstr,4,false);
            t1 = Right(OPr.BankAcc,len(OPr.BankAcc)-4);            
            tstr = StripNonDigits(t1);
            M4WriteDanStr(tstr,10,false);
          end else begin
            tstr = "0";
            M4WriteDanStr(tstr,4,false);
            M4WriteDanStr(tstr,10,false);
          end;
          M4WriteDanStr(VEr.Name,29,false);
          M4WriteDanStr(VEr.InvAddr0,29,false);
          tstr = "0019";
          M4WriteDanStr(tstr,4,false);
          tstr = "Faktura no. ";
          tstr = tstr & VIr.InvoiceNr;
          M4WriteDanStr(tstr,20,true);
          NewLine;
        end else begin
          tstr = "009";
          M4WriteDanStr(tstr,3,false);
          tstr = "003";
          M4WriteDanStr(tstr,3,false);
          t2 = DateToString(OPr.PayDate,"YYYYMMDD");                    
          tstr = Left(t2,4);
          tstr = tstr & "-";
          t1 = Right(t2,len(t2)-4);
          t1 = Left(t1,2);
          t1 = t1 & "-";
          tstr = tstr & t1;
          t1 = Right(t2,len(t2)-6);
          tstr = tstr & t1;
          if (len(tstr)>10) then begin tstr = Left(tstr,10); end;
          M4WriteDanStr(tstr,10,false);
          tstr = OPrw.PInvVal;
          M4WriteDanStr(tstr,15,false);
          tstr = "00000000";
          M4WriteDanStr(tstr,8,false);
          M4WriteDanStr(tstr,8,false);
          if (len(OPr.BankAcc) > 4) then begin
            t1 = Right(OPr.BankAcc,len(OPr.BankAcc)-4);            
          end else begin
            t1 = "0";
          end;
          tstr = StripNonDigits(t1);                    
          M4WriteDanStr(tstr,11,false);
          tstr = "";
          M4WriteDanStr(tstr,3,false);
          tstr = Left(OPrw.BankAcc,2);
          M4WriteDanStr(tstr,2,false);
          CreateDanishCheckCiffer(VIr.InvoiceNr,tstr); 
          M4WriteDanStr(tstr,16,false);
          M4WriteDanStr(VEr.RegNr2,10,true);
          NewLine;
        end;  
L77:;      
      end;
    end;    
L88:;
  end;
L99:;  
//  UserTrace(OPr.SerNr,M4Long);
  RETURN;
END;
#endif
