#ifdef HAL
external procedure M4PadString(string,Integer,string,Boolean,var string);
external procedure M4WriteDanStr(string,Integer,Boolean);
external procedure CalcNorCheck(var string,Boolean);

procedure CreateDanishCheckCiffer(string instr,var string res)
BEGIN
  string 255 tstr,t2;

  tstr = instr;
  M4PadString(tstr,14,"0",true,t2);  
  CalcNorCheck(t2,true);
  res = t2;
  RETURN;
END;

global
procedure BankExpDanish2(record OPVc OPr)
BEGIN
  Integer i,j,rwcnt;
  row OPVc OPrw;
  row OPVc OP2rw;  
  record VIVc VIr;
  record CUVc VEr;
  record BankVc BKr;
  Boolean VEf,BKf,testf;
  val totsum;
  string 255 tstr,t1,t2;
  record CYBlock CompYear;
  record BankFileBlock bfr;
  Boolean hitf;

  BlockLoad(bfr);
  BlockLoad(CompYear);
  rwcnt = MatRowCnt(OPr);
  for (i = 0 ; i<rwcnt ;i=i+1) begin
    MatRowGet(OPr,i,OPrw);
    if (OPrw.ovst<>0) then begin goto L88; end;
    if (blank(OPrw.BankAcc)) then begin goto L88; end;    
    
    VIr.SerNr = OPrw.VISerNr;
    if (ReadFirstMain(VIr,1,true)==false) then begin goto L88; end;
    if (VIr.InvType==kInvoiceTypeNormalSpecialSales) then begin VIr.InvType = kInvoiceTypeNormal; end;
    if (VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin VIr.InvType = kInvoiceTypeCredit; end;
    if ((VIr.InvType<kInvoiceTypeNormal) or (VIr.InvType>kInvoiceTypeCredit)) then begin VIr.InvType = kInvoiceTypeNormal; end;

    if ((VIr.InvType==kInvoiceTypeNormal) and (VIr.PayVal<0)) then begin
      VIr.InvType = kInvoiceTypeCredit; 
    end;
    VEr.Code = VIr.VECode;
    VEf = ReadFirstMain(VEr,1,true);
    begin
      testf = true;
      if (VIr.Invalid<>0) then begin testf = false; end;
      if (testf) then begin
        totsum = 0;
        for (j=i;j<rwcnt;j=j+1) begin          
          MatRowGet(OPr,j,OP2rw);
          if (OP2rw.VECode==OPrw.VECode) then begin
            totsum = totsum + OP2rw.PInvVal;
          end;
        end;
        if (totsum<0) then begin goto L77; end;
                
        BKr.Code = VEr.AccOperator; 
        BKf = ReadFirstMain(BKr,1,true);        
        if (len(OPrw.BankAcc)>2) then begin
          tstr = "CMBO";
          M4WriteDanStr(tstr,8,false);
          tstr = StripNonDigits(OPr.BankAcc);          
          M4WriteDanStr(tstr,14,false);//15
          tstr = StripNonDigits(OPrw.BankAcc);          
          M4WriteDanStr(tstr,14,false);//15
          tstr = OPrw.PInvVal;
          M4WriteDanStr(tstr,15,false);
          tstr = DateToString(OPr.PayDate,"DDMMYY");
          M4WriteDanStr(tstr,6,false);
          tstr = "";
          M4WriteDanStr(tstr,4,false);
          tstr = "A";
          M4WriteDanStr(tstr,1,false);
          if ((tstr=="01") or (tstr=="41")) then begin
            tstr = "J";
          end else begin
            tstr = "N";
          end;  
          M4WriteDanStr(tstr,1,false);
          tstr = "";
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          tstr = "N";
          M4WriteDanStr(tstr,1,false);
          tstr = "";
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(VIr.VECode,35,false);
          M4WriteDanStr(VEr.Name,35,false);
          M4WriteDanStr(VEr.InvAddr0,35,false);
          M4WriteDanStr(VEr.InvAddr1,35,false);
          M4WriteDanStr(CompYear.CompName,20,false);
          
          tstr = "";
          M4WriteDanStr(tstr,24,false);
          M4WriteDanStr(VEr.Name,20,false);
       
          t2 = "";
          M4WriteDanStr(t2,2,false);
          hitf = false;
          tstr = "";
          M4WriteDanStr(tstr,10,false);
          t1 = OPrw.VISerNr;
          M4WriteDanStr(t1,35,false);
          tstr = "";
          M4WriteDanStr(tstr,35,false);
          t2 = "To Invoice no. ";
          t2 = t2 & t1;
          M4WriteDanStr(t2,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,true);
          NewLine;
//          betcount = betcount + 1;
        end else begin
          tstr = "CMBO";
          M4WriteDanStr(tstr,8,false);
          tstr = StripNonDigits(OPr.BankAcc);          
          M4WriteDanStr(tstr,14,false);//15          
          if (nonblank(VEr.RegNr2)) then begin
            t2 = VEr.RegNr2;
          end else begin
            t2 = "0";
          end;  
          tstr = StripNonDigits(t2);          
          t2 = "IK";
          t2 = t2 & tstr;
          M4WriteDanStr(t2,14,false);
          tstr = OPrw.PInvVal;
          M4WriteDanStr(tstr,15,false);
          tstr = DateToString(OPr.PayDate,"DDMMYY");
          M4WriteDanStr(tstr,6,false);
          tstr = "";
          M4WriteDanStr(tstr,4,false);
          tstr = "A";
          M4WriteDanStr(tstr,1,false);
          tstr = "";
          M4WriteDanStr(tstr,1,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          M4WriteDanStr(tstr,35,false);
          tstr = "N";
          M4WriteDanStr(tstr,1,false);
          M4WriteDanStr("",35,false);
          M4WriteDanStr("",35,false);
          M4WriteDanStr(VIr.VECode,35,false);
          M4WriteDanStr(VEr.Name,35,false);
          M4WriteDanStr(VEr.InvAddr0,35,false);
          M4WriteDanStr(VEr.InvAddr1,35,false);
          M4WriteDanStr(CompYear.CompName,20,false);
          
          M4WriteDanStr("",24,false);
          M4WriteDanStr(VEr.Name,20,false);
          t2 = Left(OPrw.BankAcc,2);
          M4WriteDanStr(t2,2,false);
          hitf = false;
          CreateDanishCheckCiffer(VIr.InvoiceNr,tstr); 
          if (t2=="71") then begin
            M4WriteDanStr(tstr,15,true);
            hitf = true;
          end;
          if (t2=="01") then begin
            M4WriteDanStr(tstr,15,true);
            hitf = true;
          end;
          if (t2=="04") then begin
            M4WriteDanStr(tstr,16,true);
            hitf = true;
          end;
          if (t2=="08") then begin
            M4WriteDanStr(tstr,16,true);
            hitf = true;
          end;
          if (t2=="15") then begin
            M4WriteDanStr(tstr,16,true);
            hitf = true;
          end;
          if (t2=="41") then begin
            M4WriteDanStr(tstr,10,true);
            hitf = true;
          end;
          if (t2=="4") then begin
            M4WriteDanStr(tstr,10,true);
            hitf = true;
          end;
          if (hitf==false) then begin
            M4WriteDanStr(tstr,10,true);
          end;
          NewLine;
//          betcount = betcount + 1;
        end;  
L77:;      
      end;
    end;    
L88:;
  end;
L99:;  
//  UserTrace(OPr->SerNr,M4Long);
  RETURN;
END;
#endif
