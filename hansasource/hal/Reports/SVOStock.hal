external procedure HTLocations(string, string, var string);
external function boolean CheckItemGroupClassification(string,string,string);
external procedure HTItemClass(string,var string);
external procedure HTArtSel(string,string, var string);
external procedure HTDetailLevel(Integer, var string);
external procedure HTCusts(string, string, var string);
external procedure HTObj(string,var string);
external procedure HTArts(string, string, var string);
external procedure HTServiceOrder(LongInt,LongInt,var string );

procedure PrintSVODatailed(record SVOVc SVOr,record RcVc RepSpec)
begin
   Gray_Divider(0,1);                
   StartFormat(15);
   OutLongInt(0,"DblSVOVc",SVOr.SerNr,false);
   OutDate(3,0,SVOr.TransDate,false);              
   OutString(4,0,SVOr.PlanShip,true);
   OutString(5,"DblCUVc",SVOr.CustCode,false);
   OutString(270,0,SVOr.Addr0,false);
   OutString(450,0,SVOr.OrderClass,false);
   EndFormat;
   if (nonblank(SVOr.OurContact)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.OurContact,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.CustContact)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.CustContact,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.CustOrdNr)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.CustOrdNr,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.Comment1)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.Comment1,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.Comment2)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.Comment2,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.Comment3)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.Comment3,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.Comment4)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.Comment4,false);
      EndFormat;      
   end;          
   if (nonblank(SVOr.InvoiceToCode)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.InvoiceToCode,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.VATNr)) then begin
      StartFormat(15);
      OutString(200,0,SVOr.VATNr,false);
      EndFormat;                
   end;
   if (nonblank(SVOr.Objects)) then begin                    
      StartFormat(15);
      OutString(200,0,SVOr.Objects,false);
      EndFormat;           
   end;     
   if (nonblank(SVOr.Addr1)) then begin                    
      StartFormat(15);
      OutString(200,0,SVOr.Addr1,false);
      EndFormat;                
   end;  
   if (nonblank(SVOr.Addr2)) then begin                    
      StartFormat(15);
      OutString(200,0,SVOr.Addr2,false);
      EndFormat;                
   end;
   if (nonblank(SVOr.Addr3)) then begin                                      
      StartFormat(15);
      OutString(200,0,SVOr.Addr3,false);
      EndFormat;                
   end;  
  return;
end;
 
global
procedure SVOStockRn(record RcVc RepSpec)
begin
  record SVOVc SVOr;
  record WOVc WOr;
  row SVOVc SVOrw;
  Integer i, rwcnt;
  LongInt afr, ato, pwonr;
  Boolean testf, TrHs;
  Boolean issf, startf, finf, cancf, prheadf;  
  string 20 frcu, tocu,tstr;
  Integer rw;
  boolean woexist,showorder,TrHs2,showline;
  LongInt StatusText;
  
  afr = FirstInRange(RepSpec.f1,20);
  ato = LastInRange(RepSpec.f1,20);
  frcu = FirstInRange(RepSpec.f2,20);
  tocu = LastInRange(RepSpec.f2,20);

  StartReportJob(USetStr(7775));
  rw = 1;
  HTServiceOrder(afr,ato,tstr);
  Header(rw,tstr,1);
  rw = rw + 1;
  HTArtSel(RepSpec.LastAcc,RepSpec.f3,tstr);
  Header(rw,tstr,1);
  rw = rw + 1;
  if (nonblank(RepSpec.f8)) then begin 
    HTItemClass(RepSpec.f8,tstr);
    Header(rw,tstr,1);  
    rw = rw + 1;  
  end;
  HTCusts(frcu,tocu,tstr);
  Header(rw,tstr,1);
  rw = rw + 1;
  if (RepSpec.ArtMode==2) then begin
    tstr = USetStr(6658);
    Header(rw,tstr,0);
    rw = rw + 1;
  end else begin
    HTDetailLevel(RepSpec.ArtMode,tstr);
    Header(rw,tstr,0);
  end;
  if (nonblank(RepSpec.ObjStr)) then begin
    HTObj(RepSpec.ObjStr,tstr);
    Header(rw,tstr,1);
    rw = rw + 1;
  end;
  if (nonblank(RepSpec.FirstAcc)) then begin
    tstr = USetStr(1825);
    tstr = tstr & RepSpec.FirstAcc;
    Header(rw,tstr,1);
    rw = rw + 1;
  end;
  if (nonblank(RepSpec.Stext)) then begin
    tstr = USetStr(14557);
    tstr = tstr & " " & RepSpec.Stext;
    Header(rw,tstr,1);
    rw = rw + 1;
  end;
  HTLocations(RepSpec.AccStr,RepSpec.AccStr,tstr);
  if (nonblank(tstr)) then begin
    Header(rw,tstr,1);
    rw = rw + 1;
  end;
  tstr = "";
  if (RepSpec.flags[2]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7784);
  end;
  if (RepSpec.flags[3]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7785);
  end;
  if (RepSpec.flags[4]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7787);
  end;
  if (RepSpec.flags[5]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7788);
  end;
  if (RepSpec.flags[8]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7795);
  end;
  if (RepSpec.flags[6]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(15210);
  end;
  if (RepSpec.flags[7]==1) then begin
    if (nonblank(tstr)) then begin tstr = tstr & "/"; end;
    tstr = tstr & USetStr(7786);
  end;
  if (blank(tstr)) then begin
    tstr = USetStr(7796);
  end;
  Header(rw,tstr,1);
  rw = rw + 1;
  EndHeader;
  if (RepSpec.ArtMode!=2) then begin
    SetRepCol(2,0);
    SetRepCol(3,80);  
    SetRepCol(4,160); 
    SetRepCol(5,220); 
    if ((RepSpec.ArtMode==1) or (RepSpec.ArtMode==2)) then begin
      SetRepCol(6,20);
      SetRepCol(7,110); 
    end; 
    SetRepCol(8,390);
  end else begin
    SetRepCol(2,60);
    SetRepCol(3,120);  
    SetRepCol(4,280); 
  end;
  
  if (RepSpec.ArtMode==0) then begin
      StartFormat(15);
      OutString(2,0,USetStr(7783),false);
      OutString(3,0,USetStr(7781),false);
      OutString(4,0,USetStr(7778),false);
      OutString(5,0,USetStr(7779),false);
      OutString(1,0,USetStr(7780),true);
      EndFormat;
      StartFormat(15);
      OutString(20,0,USetStr(7789),false);
      OutString(80,0,USetStr(7790),false);
      EndFormat;
      Gray_Divider(0,1);                
  end;
  if (RepSpec.ArtMode==1) then begin
      StartFormat(15);
      OutString(2,0,USetStr(7783),false);
      OutString(3,0,USetStr(7781),false);
      OutString(4,0,USetStr(7778),false);
      OutString(5,0,USetStr(7779),true);
      EndFormat;
      Gray_Divider(0,1);                
  end;
  if (RepSpec.ArtMode==2) then begin
    StartFormat(15);
     OutString(0,0,USetStr(7783),false);
     OutString(2,0,USetStr(7781),false);
     OutString(3,0,USetStr(7792),false);
     OutString(4,0,USetStr(7793),true);
     OutString(380,0,USetStr(7790),false);
     OutString(1,0,USetStr(7794),true);
    EndFormat;
    Gray_Divider(0,1);
  end;
  TrHs = true;
  SVOr.SerNr = afr;
  while (LoopMain(SVOr,1,TrHs)) begin
    testf = true;
    if (nonblank(RepSpec.f1)) then begin
      if (SVOr.SerNr>ato) then begin
        TrHs = false; testf = false;
      end;
    end;
    if (nonblank(RepSpec.FirstAcc)) then begin
      if (SVOr.OrderClass<>RepSpec.FirstAcc) then begin
        testf = false;
      end;
    end;
    if (nonblank(RepSpec.ObjStr)) then begin
      if (SetInSet(RepSpec.ObjStr,SVOr.Objects)==false) then begin
        testf = false;
      end;
    end;
    if (nonblank(RepSpec.Stext)) then begin
      if (SVOr.PlanShip<>RepSpec.Stext) then begin
        testf = false;
      end;
    end;
    if (nonblank(RepSpec.AccStr)) then begin
      if (SVOr.ServLocation!=RepSpec.AccStr) then begin testf = false; end;
    end;
    if (nonblank(RepSpec.f2)) then begin
      if (SVOr.CustCode<frcu) or (SVOr.CustCode>tocu) then begin
        testf = false;
      end;
    end;
    if (testf) then begin
      WOr.SVOSerNr = SVOr.SerNr;
      TrHs2 = true;
      woexist = false;
      showorder = false;
      ResetLoop(WOr);
      While (LoopKey("SVOSerNr",WOr,1,TrHs2)) begin
        if (WOr.SVOSerNr<>SVOr.SerNr) then begin
          TrHs2 = false;
        end else begin
          woexist = true;
          if (RepSpec.flags[3]==1) and (WOr.Closed==0) then begin
            showorder = true;TrHs2 = false;
          end;
          if (RepSpec.flags[4]==1) and (WOr.Closed==2) then begin
            showorder = true;TrHs2 = false;
          end;
          if (RepSpec.flags[5]==1) and (WOr.Closed==3) then begin 
            showorder = true;TrHs2 = false;
          end;
          if (RepSpec.flags[8]==1) and (WOr.Closed==3) and (SVOr.InvFlag==0) then begin 
            showorder = true;TrHs2 = false;
          end;
          if (RepSpec.flags[7]==1) and (WOr.Closed==1) then begin  
            showorder = true;TrHs2 = false;
          end;      
        end;  
      end;
      if (woexist) and (showorder==false) then begin
        testf = false;
      end;
      if (woexist==false) and (RepSpec.flags[2]==0) then begin
        testf = false;
      end;
    end;        
    if (testf) then begin
      if (RepSpec.ArtMode==2 or RepSpec.ArtMode==1) then begin
        if (nonblank(RepSpec.LastAcc) or nonblank(RepSpec.f3) or nonblank(RepSpec.f8)) then begin
          testf = false;
          rwcnt = MatRowCnt(SVOr);
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(SVOr,i,SVOrw);
            if (nonblank(RepSpec.LastAcc)) then begin 
              if (SVOrw.ArtCode==RepSpec.LastAcc) then begin 
                testf = true; 
                i = rwcnt;
              end;
            end;
            if (testf==false) then begin
              if (CheckItemGroupClassification(SVOrw.ArtCode,RepSpec.f3,RepSpec.f8)==true) then begin 
                testf = true; 
                i = rwcnt;
              end;
            end;
          end;
        end;   
      end;
    end;
      
    if (testf) then begin
      if (RepSpec.ArtMode==0) then begin //OverView
        Gray_Divider(0,1);                
        StartFormat(15);
        OutLongInt(0,"DblSVOVc",SVOr.SerNr,false);
        OutString(3,0,SVOr.TransDate,false);
        OutString(4,0,SVOr.PlanShip,false);
        OutString(5,0,SVOr.Addr0,false);
        OutString(1,"DblCUVc",SVOr.InvoiceToCode,true);
        EndFormat;    
        rwcnt = MatRowCnt(SVOr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(SVOr,i,SVOrw);
          StatusText = 7784;
          if SVOrw.WOSerNr>0 then begin
            WOr.SerNr = SVOrw.WOSerNr;
            if (ReadFirstMain(WOr,1,true)) then begin
              if (WOr.Closed==0) then begin StatusText = 7785; end;
              if (WOr.Closed==2) then begin StatusText = 7787; end;
              if (WOr.Closed==3) then begin StatusText = 7788; end;
              if (WOr.Closed==4) then begin StatusText = 7786; end; 
            end;  
          end;      
          StartFormat(15);
          OutLongInt(20,0,i+1,false);
          OutString(80,0,USetStr(StatusText),false);              
          OutString(150,0,SVOrw.PlanShiprw,false);
          EndFormat; 
        end;
      end;
      if (RepSpec.ArtMode==1) then begin //Detailed
        PrintSVODatailed(SVOr,RepSpec);
        rwcnt = MatRowCnt(SVOr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(SVOr,i,SVOrw);
          testf = true;
          if (nonblank(RepSpec.LastAcc)) then begin
            if (SVOrw.ArtCode!=RepSpec.LastAcc) then begin testf = false; end;
          end;
          testf = CheckItemGroupClassification(SVOrw.ArtCode,RepSpec.f3,RepSpec.f8); 
          if (testf) then begin
            StartFormat(15);
            OutString(0,0,SVOrw.ArtCode,false);
            OutString(60,0,SVOrw.Spec,false);              
            OutString(280,0,SVOrw.SerialNr,false);
            OutString(350,0,SVOrw.Quant,true);
            OutLongInt(400,"DblWOVc",SVOrw.WOSerNr,true);
            OutString(440,0,SVOrw.StandProblem,false);
           EndFormat;
           StartFormat(15);
           tstr = "-";
           if (SVOrw.ItemType==1) then begin tstr = USetStr(7761); end;
           if (SVOrw.ItemType==2) then begin tstr = USetStr(7762); end;
           if (SVOrw.ItemType==3) then begin tstr = USetStr(7763); end;
           if (SVOrw.ItemType==4) then begin tstr = USetStr(7768); end;
           OutString(0,0,tstr,false);                                 
           OutLongInt(70,0,SVOrw.ContractNr,false);
           OutString(120,0,SVOrw.Objects,false);
           EndFormat;
           Gray_Divider(0,100);                
          end;      
        end;  
      end;
                 
      if (RepSpec.ArtMode==2) then begin //Order Rows
        rwcnt = MatRowCnt(SVOr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(SVOr,i,SVOrw);
          testf = true;
          if (nonblank(RepSpec.LastAcc)) then begin
            if (SVOrw.ArtCode!=RepSpec.LastAcc) then begin testf = false; end;
          end;
          testf = CheckItemGroupClassification(SVOrw.ArtCode,RepSpec.f3,RepSpec.f8); 
          if (testf) then begin
            StatusText = 7784;
            showline = true;
            if SVOrw.WOSerNr>0 then begin
              WOr.SerNr = SVOrw.WOSerNr;
              if (ReadFirstMain(WOr,1,true)) then begin
                showline = false;
                if (RepSpec.flags[3]==1) and (WOr.Closed==0) then begin
                  showline = true;StatusText = 7785;
                end;
                if (RepSpec.flags[4]==1) and (WOr.Closed==2) then begin
                  showline = true;StatusText = 7787;
                end;
                if (RepSpec.flags[5]==1) and (WOr.Closed==3) then begin 
                  showline = true;StatusText = 7788;
                end;
                if (RepSpec.flags[8]==1) and (WOr.Closed==3) and (SVOr.InvFlag==0) then begin 
                  showline = true;StatusText = 7788;
                end;
                if (RepSpec.flags[7]==1) and (WOr.Closed==1) then begin  
                  showline = true;StatusText = 7786;   
                end;                  
              end;
            end;
            if (showline) then begin
              testf = true;
              if (nonblank(RepSpec.LastAcc)) then begin
                if (SVOrw.ArtCode!=RepSpec.LastAcc) then begin testf = false; end;
              end;
              testf = CheckItemGroupClassification(SVOrw.ArtCode,RepSpec.f3,RepSpec.f8); 
              if (testf) then begin
                StartFormat(15);
                OutLongInt(0,"DblSVOVc",SVOr.SerNr,false);
                OutDate(2,0,SVOr.TransDate,false);
                OutString(3,0,SVOrw.ArtCode,false);
                OutString(4,0,SVOrw.Quant,true);
                tstr = USetStr(StatusText);
                OutString(380,0,tstr,false);
                OutLongInt(1,"DblWOVc",SVOrw.WOSerNr,true);
                EndFormat;
              end;
            end;
          end; 
        end;
      end;
/* This part doesn't seem to be needed. It's just doing the same thing as the code above... - HRO
      if (SVOr.WOMark<>0) then begin
          rwcnt = MatRowCnt(SVOr);
          prheadf = false;
          for (i=0;i<rwcnt;i=i+1) begin
            MatRowGet(SVOr,i,SVOrw);
            testf = false;
            finf = false;
            issf = false;
            startf = false;
            cancf = false;
            WOr.SerNr = SVOrw.WOSerNr;
            if (ReadFirstMain(WOr,1,true)) then begin
               if (RepSpec.flags[3]==1) then begin  
                 if (WOr.Closed==0) then begin testf = true; issf = true; end;
               end;
               if (RepSpec.flags[4]==1) then begin  
                 if (WOr.Closed==2) then begin testf = true; startf = true; end;
               end;
               if (RepSpec.flags[5]==1) then begin  
                 if (WOr.Closed==3) then begin testf = true; finf = true; end;
               end;
               if (RepSpec.flags[8]==1) then begin  
                 if ((WOr.Closed==3) and (SVOr.InvFlag==0)) then begin testf = true; finf = true; end;
               end;
               if (RepSpec.flags[7]==1) then begin  
                 if (WOr.Closed==1) then begin testf = true; cancf = true; end;
               end;
            end;
            if (RepSpec.flags[9]==1) then begin
              if (SVOrw.WOSerNr==-1) then begin
                testf = true;
              end else begin
                testf = false;
              end;
            end;
            if (testf) then begin
              if (RepSpec.ArtMode==0) then begin
                if (prheadf==false) then begin
                  Gray_Divider(0,1);                
                  StartFormat(15);
                   OutLongInt(0,"DblSVOVc",SVOr.SerNr,false);
                   OutDate(3,0,SVOr.TransDate,false);              
                   OutString(4,0,SVOr.PlanShip,false);
                   OutString(5,0,SVOr.Addr0,false);
                   OutString(430,0,SVOr.InvoiceToCode,false);
                  EndFormat;
                  prheadf = true;
                end;  
                if (pwonr<>SVOrw.WOSerNr) then begin
                  StartFormat(15);
                   OutLongInt(20,0,i+1,false);
                   if (issf) then begin
                     OutString(80,0,USetStr(7785),false);              
                   end;
                   if (startf) then begin
                     OutString(80,0,USetStr(7787),false);              
                   end;
                   if (finf) then begin
                     OutString(80,0,USetStr(7788),false);              
                   end;
                   if (cancf) then begin
                     OutString(80,0,USetStr(7786),false);              
                   end;
                   OutString(150,0,SVOrw.PlanShiprw,false);
                  EndFormat;
                end;  
                pwonr = SVOrw.WOSerNr;
              end;  
              if (RepSpec.ArtMode==1) then begin
                if (prheadf==false) then begin
                  PrintSVODatailed(SVOr,RepSpec);
                  prheadf = true;
                end; 
                rwcnt = MatRowCnt(SVOr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(SVOr,i,SVOrw);
                  testf = true;
                  if (nonblank(RepSpec.LastAcc)) then begin
                    if (SVOrw.ArtCode!=RepSpec.LastAcc) then begin testf = false; end;
                  end;
                  if (testf) then begin
                    StartFormat(15);
                    OutString(0,0,SVOrw.ArtCode,false);
                    OutString(60,0,SVOrw.Spec,false);              
                    OutString(280,0,SVOrw.SerialNr,false);
                    OutString(350,0,SVOrw.Quant,true);
                    OutLongInt(400,"DblWOVc",SVOrw.WOSerNr,true);
                    OutString(440,0,SVOrw.StandProblem,false);
                   EndFormat;
                   StartFormat(15);
                   if (SVOrw.ItemType==1) then begin
                      OutString(0,0,USetStr(7761),false);                                 
                   end;
                   if (SVOrw.ItemType==2) then begin
                     OutString(0,0,USetStr(7762),false);              
                   end;
                   if (SVOrw.ItemType==3) then begin
                     OutString(0,0,USetStr(7763),false);                                 
                   end;
                   if (SVOrw.ItemType==4) then begin
                     OutString(0,0,USetStr(7768),false);                                 
                   end;                 
                   OutLongInt(70,0,SVOrw.ContractNr,false);
                   OutString(120,0,SVOrw.Objects,false);
                   EndFormat;
                   Gray_Divider(0,100);                
                  end;
                end;                  
              end;    
              if (RepSpec.ArtMode==2) then begin
                rwcnt = MatRowCnt(SVOr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(SVOr,i,SVOrw);
                  testf = true;
                  if (nonblank(RepSpec.LastAcc)) then begin
                    if (SVOrw.ArtCode!=RepSpec.LastAcc) then begin testf = false; end;
                  end;
                  if (testf) then begin
                    StartFormat(15);
                    OutLongInt(0,"DblSVOVc",SVOr.SerNr,false);
                    OutDate(2,0,SVOr.TransDate,false);
                    OutString(3,0,SVOrw.ArtCode,false);
                    OutString(4,0,SVOrw.Quant,true);
                    OutLongInt(440,"DblWOVc",SVOrw.WOSerNr,true);
                    EndFormat;
                  end;
                end;
              end;                        
            end;//testf
          end;          
      end;  //nonbl
*/
    end;  //testf
  end;
  EndJob;
  return;
end; 
