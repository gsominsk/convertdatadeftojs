external procedure ExtractObj(string,var Integer,var string);
external procedure HT2Per(Date, Date , var string);

procedure TerminatedCOCU(record RcVc RepSpec)
begin
  record COCUServiceVc COCUServicer;
  Boolean found,testf,foundclass,prntclassf;
  Integer pos;
  string 255 classification,index;
  record HWCOClassVc HWCOClr;
  Integer cnt;
  
  foundclass = true;
  index = "Code";
  if (nonblank(RepSpec.LastAcc)) then begin
    index = "ClType";
  end;
  HWCOClr.ClType = RepSpec.LastAcc;
  while (LoopKey(index,HWCOClr,1,foundclass)) begin
    if (nonblank(RepSpec.LastAcc)) then begin
      if (HWCOClr.ClType!=RepSpec.LastAcc) then begin foundclass = false; end;
    end;
    testf = foundclass;
    if (nonblank(RepSpec.f1)) then begin
      if (SetInSet(HWCOClr.Code,RepSpec.f1)==false) then begin testf = false; end;
    end;
    if (testf) then begin
      cnt = 0;
      prntclassf = true;
      ResetLoop(COCUServicer);
      found = true;
      COCUServicer.endDate = RepSpec.sStartDate;
      while (LoopKey("endDate",COCUServicer,1,found)) begin
        if (!DateInRange(COCUServicer.endDate,RepSpec.sStartDate,RepSpec.sEndDate)) then begin found = false; end;
        if (found) then begin
          testf = true;
          if (SetInSet(HWCOClr.Code,COCUServicer.Classification)==false) then begin testf = false; end;
          if (nonblank(RepSpec.FirstAcc)) then begin 
            if (COCUServicer.Class!=RepSpec.FirstAcc) then begin testf = false; end;
          end;
          if (testf) then begin
            if (prntclassf) then begin
              StartFormat(15);
               OutString(0,0,HWCOClr.Comment,false);
              EndFormat;
              prntclassf = false;
              Gray_Divider(0,1);
            end;
            StartFormat(15);
             OutString(0,"DblCUVc",COCUServicer.CustCode,false);
             OutString(100,"DblCOCUServiceVc",COCUServicer.SerNr,false);
             OutDate(150,0,COCUServicer.endDate,false);
             OutString(220,0,COCUServicer.Classification,false);
             OutString(300,0,COCUServicer.InvComment,false);
            EndFormat;
            cnt = cnt + 1;
          end;
        end;
      end;
      if (prntclassf==false) then begin
        Gray_Divider(0,1);
        StartFormat(15);
         OutString(0,0,USetStr(19360),false);
         OutString(100,0,HWCOClr.Comment,false);
         OutLongInt(220,0,cnt,false);
        EndFormat;
        Gray_Divider(0,1);
        StartFormat(15);
        EndFormat;
      end;
    end;
  end;
  return;
end;

global
procedure TerminatedCOCURn(record RcVc RepSpec)
begin
  string 255 tstr;
  Integer rw;

  StartReportJob(USetStr(19350));
   HT2Per(RepSpec.sStartDate,RepSpec.sEndDate,tstr);
   Header(rw,tstr,1);
   rw = rw + 1;
   Header(rw,tstr,1);
   rw = rw + 1;
   if (nonblank(RepSpec.FirstAcc)) then begin 
     Header(rw,USetStr(19351) & ": " & RepSpec.FirstAcc,1);   
     rw = rw + 1; 
   end;
   if (nonblank(RepSpec.LastAcc)) then begin
     Header(rw,USetStr(19352) & ": " & RepSpec.LastAcc,1);   
     rw = rw + 1; 
   end;
   if (nonblank(RepSpec.f1)) then begin
     Header(rw,USetStr(19353) & ": " & RepSpec.f1,1);   
     rw = rw + 1; 
   end;
  EndHeader;
  if (blank(RepSpec.LastAcc)) then begin
    StartFormat(15);
     OutString(0,0,USetStr(19359),false);
    EndFormat;
    goto LTerminatedCOCURn;
  end;
  
  StartFormat(15);
   OutString(0,0,USetStr(19354),false);
   OutString(100,0,USetStr(19355),false);
   OutString(150,0,USetStr(19356),false);
   OutString(220,0,USetStr(19357),false);
   OutString(300,0,USetStr(19358),false);
  EndFormat;
  Gray_Divider(0,1);
  
  TerminatedCOCU(RepSpec);
LTerminatedCOCURn:;
  EndJob;
  return;
end;