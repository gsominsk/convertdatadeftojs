procedure PrintPositionsForSH(record RcVc RepSpec,LongInt shnr)
BEGIN
  record SHVc SHr;
  record StockMovVc StockMovr;
  row StockMovVc StockMovrw;
  Integer i,rwcnt;  
  Boolean TrHs,testf;
  LongInt lastsh;
  Integer rw;
  string 255 tstr;

  TrHs = true;
  StockMovr.FileName = "SHVc";   
  StockMovr.TransNr = shnr;   
  while (LoopKey("FileName",StockMovr,2,TrHs)) begin
    if (StockMovr.FileName!="SHVc") then begin TrHs = false; end;
    if (StockMovr.TransNr!=shnr) then begin TrHs = false; end;
    if (TrHs) then begin
      testf = true;
      if (StockMovr.TransNr<=0) then begin testf = false; end;
      if (StockMovr.OKFlag!=0) then begin
        if (RepSpec.flags[1]==0) then begin
          testf = false;
        end;
      end;
      if (StockMovr.OKFlag==0) then begin
        if (RepSpec.flags[2]==0) then begin
          testf = false;
        end;
      end;
      if (testf) then begin
        if (lastsh!=StockMovr.TransNr) then begin
          if (lastsh!=-1) then begin
            Gray_Divider(0,1);
          end;
          SHr.SerNr = StockMovr.TransNr;
          if (ReadFirstMain(SHr,1,true)) then begin          
            StartFormat(15);
             OutString(0,0,USetStr(14114),false);
             OutLongInt(90,0,SHr.OrderNr,false);
            EndFormat;
            Gray_Divider(0,150);
          end;
          StartFormat(15);
           OutString(15,0,USetStr(14111),false);
           OutLongInt(105,"DblSHVc",StockMovr.TransNr,false);
          EndFormat;
          StartFormat(15);
           OutString(50,0,USetStr(14112),false);
           OutString(150,0,USetStr(14113),false);
          EndFormat;
          Gray_Divider(0,300);
        end;
        rwcnt = MatRowCnt(StockMovr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(StockMovr,i,StockMovrw);
          StartFormat(15);
           OutStringID(50,"DblStockMov",StockMovrw.ToPosCode,false,StockMovr.SerNr);
           OutString(150,0,StockMovrw.ArtCode,false);
           OutVal(300,0,StockMovrw.Quant,M4Qty,true);
          EndFormat;
          i = rwcnt;
        end;
      end;
      lastsh = StockMovr.TransNr;
    end;
  end;
  RETURN;
END;

global
procedure PositionsForSHRn(record RcVc RepSpec)
BEGIN
  LongInt frsh,tosh;
  LongInt fror,toor;
  record SHVc SHr;
  Boolean TrHs;
  string 20 keystr;
  Integer keys,mode;

  StartReportJob(USetStr(14110));
  EndHeader;
  
  if (blank(RepSpec.f1)) and (blank(RepSpec.f2)) then begin
    StartFormat(15);
     OutString(15,0,USetStr(14117),false);
    EndFormat;
    goto LPositionsForSHRn;
  end;
  frsh = FirstInRange(RepSpec.f1,10);
  tosh = LastInRange(RepSpec.f1,10);  
  fror = FirstInRange(RepSpec.f2,10);
  toor = LastInRange(RepSpec.f2,10);  
  if (nonblank(RepSpec.f1)) and (nonblank(RepSpec.f2)) then begin
    SHr.OrderNr = fror;
    SHr.SerNr = frsh;
    keys = 2;
    keystr = "OrderKey";
    mode = 1;
    goto LLoop;
  end;
  if (nonblank(RepSpec.f2)) then begin
    SHr.OrderNr = fror;
    keys =1;
    keystr = "OrderKey";
    mode = 2;
    goto LLoop;
  end;
  if (nonblank(RepSpec.f1)) then begin
    SHr.SerNr = frsh;
    keys = 1;
    keystr = "SerNr";
    mode = 3;
    goto LLoop;
  end;
LLoop:;  
  TrHs = true;
  while (LoopKey(keystr,SHr,keys,TrHs)) begin
    switch (mode) begin
      case 1:
        if (SHr.OrderNr>toor) then begin TrHs = false; end;
        if (SHr.SerNr>tosh) then begin TrHs = false; end;
      case 2:
        if (SHr.OrderNr>toor) then begin TrHs = false; end;
      case 3:
        if (SHr.SerNr>tosh) then begin TrHs = false; end;
    end;
    if (TrHs) then begin
      PrintPositionsForSH(RepSpec,SHr.SerNr);
    end;
  end;
LPositionsForSHRn:;  
  EndJob;
  RETURN;
END;