global
function Boolean FindPurInvValDet(string project,Integer vc, record RcVc RepSpec,var val tbivv,var Boolean projectf)
begin
  record TBIVVc TBIVr;
  Boolean tbivf,found,testf,firstf;
  Integer rwcnt,i,col;
  val t;
  Integer comparison,quantities;
 
  quantities = RepSpec.flags[4];
  comparison = RepSpec.flags[5];
  col = 280;
  tbivf = false;
  firstf = true;
  tbivv = 0;
  TBIVr.PRCode = project;
  TBIVr.oVc = vc;
  found = true;
  ResetLoop(TBIVr);
  while (LoopKey("PRCode",TBIVr,2,found)) begin
     testf = true;
     if (TBIVr.PRCode<>project) then begin found = false; end;
     if (TBIVr.oVc<>vc) then begin testf = false; end;
     if (found and testf) then begin
       if (projectf) then begin
         StartFormat(15);
         OutString(0,0,project,false);  
//         OutString(70,0,PRr.Name,false);
         EndFormat;
         projectf = false;
       end;
       if (firstf) then begin
         StartFormat(15);
         if (vc==2) then begin
           OutString(60,0,USetStr(4161),false);
         end else begin
           OutString(60,0,USetStr(5152),false);
         end;
         EndFormat;
         firstf = false;
       end;
       StartFormat(15);
        OutString(60,0,TBIVr.ArtCode,false);
        if (quantities==1) then begin
          t = TBIVr.InvQty;
          col = 210;
        end else begin
          if (comparison==0) then begin
            t = TBIVr.Sum;
          end;
          if (comparison==1) then begin
            t = TBIVr.Sum;
          end;
          if (comparison==2) then begin
            t = TBIVr.CostPrice;
          end;  
        end;           
        OutVal(col,0,t,M4Val,true); 
       EndFormat;
       tbivv = tbivv + t;
       tbivf = true;
     end;  
  end;
  FindPurInvValDet = tbivf;
return;
end;

global
function Boolean PrintPORnBudgetDet(record PRVc PRr,record RcVc RepSpec,var val budv,var Boolean projectf)
begin
  record TBBUVc TBBr;
  row TBBUVc TBBrw;
  Boolean budf,testf;
  Integer rwcnt,i;
  val t;
  string 20 fromin,toin;
  Integer quantities,comparison;
  string 255 f2;
  
  quantities = RepSpec.flags[5];
  comparison = RepSpec.flags[4];
  f2 = RepSpec.f2;
  fromin = FirstInRange(f2,20);
  toin = LastInRange(f2,20);
  budf = false;
  budv = 0;
  TBBr.PRCode = PRr.Code;
  if (ReadFirstMain(TBBr,1,true)) then begin
    StartFormat(15);
     OutString(60,0,USetStr(4825),false);
    EndFormat;
    rwcnt = MatRowCnt(TBBr);
    for (i=0; i<rwcnt; i = i + 1) begin
      MatRowGet(TBBr,i,TBBrw);
      testf = true;
//      if (TBBrw.ArtCode==item) then begin
      if (nonblank(fromin)) then begin
        if (TBBrw.ArtCode<fromin) then begin testf = false; end;
      end;
      if (nonblank(toin)) then begin
        if (TBBrw.ArtCode>toin) then begin testf = false; end;
      end;
      if (testf) then begin
        if (quantities==1) then begin
          t = TBBrw.Qty;
        end else begin
          if (comparison==0) then begin
            t = TBBrw.Sum;
          end;
          if (comparison==1) then begin
            t = TBBrw.Cost;
          end;
          if (comparison==2) then begin
            t = TBBrw.Cost;
          end;  
        end;
        budv = t + budv;
        budf = true;
        if (projectf) then begin
          StartFormat(15);
          OutString(0,0,PRr.Code,false);  
          OutString(70,0,PRr.Name,false);
          EndFormat;
          projectf = false;
        end;
        StartFormat(15);
          OutString(60,0,TBBrw.ArtCode,false);
          if (quantities==1) then begin
            OutVal(210,0,TBBrw.Qty,M4Qty,true); 
          end else begin
            if (comparison==0) then begin
              OutVal(280,0,TBBrw.Sum,M4Val,true); 
            end;
            if (comparison==1) then begin
              OutVal(280,0,TBBrw.Sum,M4Val,true); 
            end;
            if (comparison==2) then begin
              OutVal(280,0,TBBrw.Cost,M4Val,true); 
            end;  
          end;  
        EndFormat;
      end;
    end;
  end;
  PrintPORnBudgetDet = budf;
return;
end;

global
procedure FindProjName(string project,var string projname)
begin
  record PRVc PRr;
  Boolean res;
  
  PRr.Code = project;
  res = ReadFirstMain(PRr,1,true);
  projname = PRr.Name;
  return;
end;

global
procedure FindItemName(string item,var string itemname)
begin
  record INVc INr;
  Boolean res;
  
  INr.Code = item;
  res = ReadFirstMain(INr,1,true);    
  itemname = INr.Name;
  return;
end;

global
function Boolean FindPORnInvoicedVal(string project, string item, Integer vc,var val tbivv,Integer quantities,Integer ArtMode,Integer sorting)
begin
  record TBIVVc TBIVr;
  Boolean tbivf,found,testf;
  Integer rwcnt,i;
  val t;
  string 255 ckey;

  tbivf = false;
  tbivv = 0;
  if (sorting<>1) then begin
    ckey = "PRCode";
  end;
  if (sorting==1) then begin
    ckey = "ArtCode";
  end;
  TBIVr.PRCode = project;
  TBIVr.ArtCode = item;
  TBIVr.oVc = vc;
  found = true;
  ResetLoop(TBIVr);
  while (LoopKey(ckey,TBIVr,3,found)) begin
     testf = true;
     if (sorting<>1) then begin
       if (TBIVr.PRCode<>project) then begin found = false; end;
     end;
     if (sorting==1) then begin
       if (TBIVr.ArtCode<>item) then begin found = false; end;
     end;
     if (TBIVr.Invoice==-1) then begin testf = false; end;
     if (TBIVr.oVc<>vc) then begin testf = false; end;
     if (found==false) then begin testf = false; end;
     if (testf) then begin
       if (quantities==1) then begin
         t = TBIVr.InvQty;
       end else begin
         t = TBIVr.Sum;
       end;  
       tbivv = tbivv + t;
       tbivf = true;
     end;  
  end;

  FindPORnInvoicedVal = tbivf;
return;
end;

global
function Boolean FindPORnPurInvVal(string project, string item,Integer vc, var val tbivv,Integer quantities,Integer ArtMode,string f2,string f1,Integer sorting)
begin
  record TBIVVc TBIVr;
  Boolean tbivf,found,testf;
  Integer rwcnt,i;
  val t;
  string 20 fromin,toin,frompr,topr;
  string 255 ckey;

  fromin = FirstInRange(f2,20);
  toin = LastInRange(f2,20);
  frompr = FirstInRange(f1,20);
  topr = LastInRange(f1,20);
  tbivf = false;
  tbivv = 0;
  if (sorting<>1) then begin
    ckey = "PRCode";
  end;
  if (sorting==1) then begin
    ckey = "ArtCode";
  end;
  TBIVr.PRCode = project;
  TBIVr.ArtCode = item;
  TBIVr.oVc = vc;
  found = true;
  ResetLoop(TBIVr);
  while (LoopKey(ckey,TBIVr,3,found)) begin
     testf = true;
     if (TBIVr.oVc<>vc) then begin testf = false; end;
     if (sorting<>1) then begin
       if (TBIVr.PRCode<>project) then begin found = false; end;
       if (nonblank(fromin)) then begin
         if (TBIVr.ArtCode<fromin) then begin testf = false; end;
       end;
       if (nonblank(toin)) then begin
         if (TBIVr.ArtCode>toin) then begin testf = false; end;
       end;
     end;
     if (sorting==1) then begin
       if (TBIVr.ArtCode<>item) then begin found = false; end;
       if (nonblank(frompr)) then begin
         if (TBIVr.PRCode<frompr) then begin testf = false; end;
       end;
       if (nonblank(topr)) then begin
         if (TBIVr.PRCode>topr) then begin testf = false; end;
       end;
     end;
//     if (TBIVr.Invoice<>-1) then begin testf = false; end;     
     if (found and testf) then begin
       if (quantities==1) then begin
         t = TBIVr.InvQty;
       end else begin
         t = TBIVr.Sum;
       end;
       tbivv = tbivv + t;
       tbivf = true;
     end;  
  end;
  FindPORnPurInvVal = tbivf;
return;
end;

global
function Boolean FindPORnBudgetVal(string project, string item, var val budv,Integer quantities,string f2,Integer sorting)
begin
  Boolean budf,testf;
  record TBBUVc TBBr;
  row TBBUVc TBBrw;
  Integer rwcnt,i;
  val t;
  string 20 fromin,toin;

  fromin = FirstInRange(f2,20);
  toin = LastInRange(f2,20);
  budf = false;
  budv = 0;
  TBBr.PRCode = project;
  if (ReadFirstMain(TBBr,1,true)) then begin
    rwcnt = MatRowCnt(TBBr);
    for (i=0; i<rwcnt; i = i + 1) begin
      MatRowGet(TBBr,i,TBBrw);
      testf = true;
      if (sorting<>1) then begin
        if (nonblank(fromin)) then begin
          if (TBBrw.ArtCode<fromin) then begin testf = false; end;
        end;
        if (nonblank(toin)) then begin
          if (TBBrw.ArtCode>toin) then begin testf = false; end;
        end;
      end;  
      if (sorting==1) then begin
        if (TBBrw.ArtCode<>item) then begin testf = false; end;
      end;
      if (testf) then begin
        if (quantities==1) then begin
          t = TBBrw.Qty;
        end else begin
          t = TBBrw.Sum;
        end;
        budv = t + budv;
        budf = true;
      end;
    end;
  end;
  FindPORnBudgetVal = budf;
return;
end;
