function Boolean AddToArray(LongInt shnr,Array LongInt ashnr,var Integer acnt)
BEGIN
  Boolean res;
  Integer i;
  
  for (i=0;i<acnt;i=i+1) begin
    if (shnr==ashnr[i]) then begin
      goto LAddToArray;
    end;
  end;
  ashnr[acnt] = shnr;
  acnt = acnt + 1;
  res = true;
LAddToArray:;  
  AddToArray = res;
  RETURN;
END;

procedure FindDeliveriesForPosition(string poscode,LongInt punr,var Boolean printedf,Array LongInt ashnr, var Integer acnt)
BEGIN
  record CUVc CUr;
  record SHVc SHr;
  record StockMovVc StockMovr;
  row StockMovVc StockMovrw;
  Boolean TrHs,testf,firstf;
  string 50 ckey;
  Integer i,rwcnt;
  
  firstf = true;
  TrHs = true;
  ckey = "FrPosCodeSerNr:" & poscode;
  while (LoopKey(ckey,StockMovr,1,TrHs)) begin
    if (TrHs) then begin
      testf = true;
      if (StockMovr.TransNr<=0) then begin testf = false; end;
      if (StockMovr.FileName!="SHVc") then begin testf = false; end;
      if (testf) then begin
        rwcnt = MatRowCnt(StockMovr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(StockMovr,i,StockMovrw);
          testf = true;
          if (StockMovrw.FrPosCode!=poscode) then begin testf = false; end;
          if (testf) then begin
            if (AddToArray(StockMovr.TransNr,ashnr,acnt)) then begin
              if (printedf==false) then begin
                StartFormat(15);
                 OutString(0,0,USetStr(14151) & ": " & punr,false);
                EndFormat;
                printedf = true;
                Gray_Divider(0,1);
                StartFormat(15);
                 OutString(15,0,USetStr(14152),false);
                 OutString(105,0,USetStr(14153),false);
                 OutString(185,0,USetStr(14154),false);
                 OutString(285,0,USetStr(14155),false);
                EndFormat;
                firstf = false;
                Gray_Divider(0,1);
              end;
              SHr.SerNr = StockMovr.TransNr;
              if (ReadFirstMain(SHr,1,true)) then begin end;
              CUr.Code = SHr.CustCode;
              if (ReadFirstMain(CUr,1,true)) then begin end;
              StartFormat(15);
               OutLongInt(15,"DblSHVc",SHr.SerNr,false);             
               OutString(105,0,SHr.CustCode,false);
               OutString(185,0,CUr.Phone,false);
               OutString(285,0,CUr.eMail,false);
              EndFormat;
              i = rwcnt;            
            end;
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

procedure PUResult(record PUVc PUr)
BEGIN
  row PUVc PUrw;
  Integer i,rwcnt,acnt;
  Array LongInt ashnr;
  string 20 lastposcode;
  Boolean printedf;

  rwcnt = MatRowCnt(PUr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(PUr,i,PUrw);
    if (PUrw.ToPosCode!=lastposcode) then begin      
      FindDeliveriesForPosition(PUrw.ToPosCode,PUr.SerNr,printedf,ashnr,acnt);
    end;
    lastposcode = PUrw.ToPosCode;
  end; 
  RETURN;
END;

global
procedure SHForPURn(record RcVc RepSpec)
BEGIN
  LongInt frpu,topu;
  record PUVc PUr;
  Boolean TrHs,testf;
  
  frpu = FirstInRange(RepSpec.f1,20);
  topu = LastInRange(RepSpec.f1,20);
  StartReportJob(USetStr(14150));  
//    HTPositions(frpos,topos,tstr);
//    Header(rw,tstr,1);
//    rw = rw + 1;
  EndHeader;
  if (blank(RepSpec.f1)) then begin 
    StartFormat(15);
     OutString(15,0,USetStr(14156),false);
    EndFormat;
    goto LSHForPURn;
  end;
  TrHs = true;
  PUr.SerNr = frpu;   
  while (LoopMain(PUr,1,TrHs)) begin
    if (nonblank(RepSpec.f1)) then begin
      if (PUr.SerNr>topu) then begin TrHs = false; end;
    end;
    if (TrHs) then begin
      testf = true;
      if (testf) then begin    
        PUResult(PUr);        
      end;
    end;
  end;  
LSHForPURn:;  
  EndJob;
  RETURN;
END;