external function Boolean BuildBudget(string,record TBBUVc,Array Integer,var Integer);
external procedure ProjectHeader(record RcVc,record PRVc,Integer);
external procedure GetPRItemName(string,string,var string);
external procedure FindBudgetSum(string,string,string,Array Integer,Integer,var val);
external procedure FindBudgetRow(string,string,string,Integer,var Date,var Integer);

global
procedure PRPLDetRn(record RcVc RepSpec)
BEGIN
  record TBIVVc TBIVr;
  record TBBUVc TBBUr;
  record PRVc PRr;
  Boolean found,testf;
  Date dt;
  Integer brow;
  string 255 tstr;
  val sum,tsum;
  LongInt recid,budrec;
  Boolean headerf;
  val t,sumbud;
  Integer uarracnt;
  Array Integer uarr;
  Boolean budfound;
  Integer budtype;
  
  headerf = false;
  StartReportJob(USetStr(4821));
  EndHeader;
  StartFormat(15);
  tstr = "   ";
  OutString(0,0,tstr,false);
  EndFormat;

  PRr.Code = RepSpec.f1;
  if (ReadFirstMain(PRr,1,true)==false) then begin goto L99; end;
  budfound = BuildBudget(PRr.Code,TBBUr,uarr,uarracnt);

  TBIVr.PRCode = RepSpec.f1;
  TBIVr.Invoice = -1;
  TBIVr.oVc = 1;
  found = true;
  while (LoopKey("InvKey",TBIVr,3,found)) begin
    testf = true;
    if (TBIVr.PRCode<>RepSpec.f1) then begin found = false; end;
    if (nonblankdate(RepSpec.d1)) then begin
      if (TBIVr.TransDate>RepSpec.d1) then begin
        testf = false;
      end;  
    end else begin
      if (TBIVr.TransDate>CurrentDate) then begin
        testf = false;
      end;  
    end;
//    if (TBIVr.ItemType<>RepSpec.flags[0]) then begin testf = false; end;
    FindBudgetRow(RepSpec.f1,RepSpec.f2,"",RepSpec.flags[0],dt,budtype);    
    if (nonblankdate(dt)) then begin
      if (nonblankdate(RepSpec.d1)) then begin
        if (dt>RepSpec.d1) then begin testf = false; end;
      end else begin
        if (dt>CurrentDate) then begin testf = false; end;
      end;
    end;
    if (found==false) then begin testf = false; end;
    
    if (testf) then begin
      if (headerf==false) then begin
        StartFormat(15);
        OutString(0,0,USetStr(4842),false);
        EndFormat;
        Gray_Divider(0,1);
        ProjectHeader(RepSpec,PRr,1);
        headerf = true;
      end;
      StartFormat(15);
      OutString(20,0,TBIVr.ArtCode,false);//OpM46o(20,GetDblClk("DblPR"),&TBIVr.ArtCode,M4Str,false,recid);
      OutString(80,0,TBIVr.EMCode,false);//OpM46o(80,GetDblClk("DblPR"),&TBIVr.EMCode,M4Str,false,recid);
      OutVal(120,0,TBIVr.InvQty,M4UVal,true);//OpM46o(120,GetDblClk("DblPR"),&TBIVr.InvQty,M4UVal,true,recid);
      if (RepSpec.flags[12]==1) then begin
        GetPRItemName(TBIVr.ArtCode,TBIVr.Comment,tstr);
        OutString(125,0,tstr,false);
      end;
      if (RepSpec.flags[11]==1) then begin
        OutVal(270,0,TBIVr.Price,M423Val,true);//OpM46o(270,GetDblClk("DblPR"),&TBIVr.Price,M423Val,true,recid);
      end;  
      OutVal(300,0,TBIVr.Discount,M41Val,true);//OpM46o(300,GetDblClk("DblPR"),&TBIVr.Discount,M41Val,true,recid);
      OutVal(370,0,TBIVr.Sum,M4Val,true);//OpM46o(370,GetDblClk("DblPR"),&TBIVr.Sum,M4Val,true,recid);
      FindBudgetSum(TBIVr.PRCode,TBIVr.ArtCode,TBIVr.EMCode,uarr,uarracnt,t);
      OutVal(430,0,t,M4Val,true);//OpM46o(430,GetDblClk("DblTSBud"),&t,M4Val,true,budrec);
      OutDate(480,0,TBIVr.TransDate,true);//OpM46o(480,GetDblClk("DblPR"),&TBIVr.TransDate,M4Date,true,recid);
      EndFormat;
      sum = sum + TBIVr.Sum;
      tsum = tsum + TBIVr.Sum;
      sumbud = sumbud + t;
    end;
  end;
  if (headerf) then begin
     Black_Divider(280,450);
     StartFormat(15);
     OutVal(370,0,sum,M4Val,true);
     OutVal(450,0,sumbud,M4Val,true);
     EndFormat;
     StartFormat(10);
     EndFormat;
     sum = 0;
  end;
L99:;
  EndJob;
  RETURN;
END;
#endif
