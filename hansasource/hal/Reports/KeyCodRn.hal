external procedure HT2Per(Date, Date , var string);

procedure PrintPersonCustAct(record RcVc RepSpec,record UserVc USp,var Boolean printedf,var Integer counter)
BEGIN
  Boolean TrHs,testf;
  string 20 frcc,tocc;
  record ActVc Actr;
  string 255 ckey;
  string 255 tstr;

  frcc = FirstInRange(RepSpec.f1,20);   
  tocc = LastInRange(RepSpec.f1,20);    
  ckey = "UserMain:";
  tstr = USp.Code;
  ckey = ckey & tstr;
  Actr.TransDate = RepSpec.sStartDate;
  Actr.OKFlag = 1;
  TrHs = true;
  while (LoopKey(ckey,Actr,3,TrHs)) begin
    if (TrHs) then begin
      if (DateInRange(Actr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin TrHs = false; end;
    end;
    if (TrHs) then begin
      testf = true;
      if (Actr.OKFlag==0) then begin testf = false; end;
      if (nonblank(frcc)) then begin
        if (Actr.CUCode<frcc) then begin testf = false; end;
      end;  
      if (nonblank(tocc)) then begin
        if (Actr.CUCode>tocc) then begin testf = false; end;
      end;  
      if (testf) then begin
        if (printedf==false) then begin
          StartFormat(15);
          OutString(0,0,USp.Code,false);
          OutString(100,0,USp.Name,false);
          EndFormat;
          StartFormat(15);
          EndFormat;
          StartFormat(15);
          OutString(0,0,USetStr(6682),false);
          OutString(60,0,USetStr(6687),false);
          OutString(130,0,USetStr(6686),false);
          OutString(190,0,USetStr(6688),false);
          OutString(290,0,USetStr(6685),false);
          EndFormat;
          printedf = true;
        end;
        counter = counter + 1;
      end;
    end;
  end;
  RETURN;
END;

Function
Boolean AddToActCounters(record ActVc Actr,var Integer hfcnt,var Integer focnt,var Integer o2cnt,var Integer hrcnt,var Integer rtcnt,var Integer odcnt)
begin
  row ActVc Actrw;
  Integer i,rwcnt;
  String 5 cod;
  Boolean addf;
  
  addf = false;
  rwcnt = MatRowCnt(Actr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(Actr,i,Actrw);
    if (Actrw.TextCode=="CS") then begin
    end;
    if (Actrw.TextCode=="CC") then begin
      cod = Left(Actrw.Text,3);
    end;
    if (Actrw.TextCode=="KEY") then begin
      if (nonblank(Actrw.Text)) then begin
        addf = true;
      end;
    end;
  end;
  if (addf) then begin
    if ((cod=="101") or (cod=="102") or (cod=="103") or (cod=="104") or (cod=="501")) then begin 
      odcnt = odcnt + 1; 
    end;
    if ((cod=="105") or (cod=="106") or (cod=="108") or (cod=="109") or (cod=="110") or (cod=="111") or (cod=="115")) then begin 
      hfcnt = hfcnt + 1; 
    end;
    if ((cod=="107") or (cod=="113") or (cod=="117")) then begin 
      focnt = focnt + 1; 
    end;
    if ((cod=="112") or (cod=="116")) then begin 
      o2cnt = o2cnt + 1; 
    end;
    if ((cod=="901") or (cod=="902") or (cod=="903")) then begin 
      hrcnt = hrcnt + 1; 
    end;
    if (cod=="951") then begin 
      rtcnt = rtcnt + 1; 
    end;
  end;
  AddToActCounters = addf;
  return;
end;

Function
Integer PrintThisCustAct(record RcVc RepSpec,record CUVc CUr,var Integer hfcnt,var Integer focnt,var Integer o2cnt,var Integer hrcnt,var Integer rtcnt,var Integer odcnt,var Boolean printedf)
BEGIN
  record ActVc Actr;
  Boolean TrHs,testf;
  Integer it,thecnt;
  row ActVc Actrw;
  Integer i,rwcnt;

  hfcnt = 0;
  focnt = 0;
  o2cnt = 0;
  hrcnt = 0;
  rtcnt = 0;
  odcnt = 0;
  Actr.CUCode = CUr.Code;
  Actr.TransDate = RepSpec.sStartDate;
  Actr.OKFlag = 1;
  TrHs = true;
  while (LoopKey("OKFlag",Actr,3,TrHs)) begin
    if (TrHs) then begin
      if (Actr.OKFlag==0) then begin TrHs = false; end;
      if (Actr.CUCode<>CUr.Code) then begin TrHs = false; end;
      if (DateInRange(Actr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin TrHs = false; end;
    end;
    if (TrHs) then begin
      testf = true;
      if (nonblank(RepSpec.f2)) then begin
        if (SetInSet(RepSpec.f2,Actr.MainPersons)==false) then begin
          testf = false;
        end;
      end;
      if (testf) then begin
        if (AddToActCounters(Actr,hfcnt,focnt,o2cnt,hrcnt,rtcnt,odcnt)) then begin
          thecnt = thecnt + 1;
          it = 0;
          if (thecnt>0) then begin
            if (RepSpec.flags[2]==0) then begin it = it + hfcnt; end;
            if (RepSpec.flags[3]==0) then begin it = it + focnt; end;
            if (RepSpec.flags[4]==0) then begin it = it + o2cnt; end;
            if (RepSpec.flags[5]==0) then begin it = it + hrcnt; end;
            if (RepSpec.flags[6]==0) then begin it = it + rtcnt; end;
            if (RepSpec.flags[7]==0) then begin it = it + odcnt; end;
            if (it==0) then begin thecnt = 0; end;
          end;
          if ((RepSpec.ArtMode==1) and (thecnt>0)) then begin
            if (printedf==false) then begin
              StartFormat(15);
              OutString(0,0,CUr.Code,false);
              OutString(2,0,CUr.Name,false);
               EndFormat;
              Gray_Divider(0,1);
              printedf = true;
            end;
            StartFormat(15);
            OutString(30,0,Actr.MainPersons,false);
            OutDate(80,0,Actr.TransDate,false);
            MatRowGet(Actr,0,Actrw);
            OutString(145,0,Actrw.Text,false);
            MatRowGet(Actr,1,Actrw);
            OutString(375,0,Actrw.Text,false);
            MatRowGet(Actr,2,Actrw);
            OutString(430,0,Actrw.Text,false);
            EndFormat;
          end;
        end;
      end;
    end;
  end;
  PrintThisCustAct = thecnt;
  RETURN;
END;

global
procedure KeyCodeRn(record RcVc RepSpec)
BEGIN
  record CUVc CUr;
  record UserVc USr;
  Boolean TrHs;
  string 20 frpers,topers;
  string 20 frcust,tocust;
  Boolean printedf;
  Integer rw,keycnt,custcnt,totcustcnt,totkeycnt;
  Integer hfcnt,focnt,o2cnt,hrcnt,rtcnt,odcnt,counter;
  string 255 tstr;
  
  frpers = FirstInRange(RepSpec.f2,5);  
  topers = LastInRange(RepSpec.f2,5);  
  frcust = FirstInRange(RepSpec.f1,5);  
  tocust = LastInRange(RepSpec.f1,5);  
  StartReportJob(USetStr(6681));  
  rw = 1;
  custcnt = 0;
  totcustcnt = 0;
  HT2Per(RepSpec.sStartDate,RepSpec.sEndDate,tstr);
  Header(rw,tstr,1);
  rw = rw +1;
  if (nonblank(RepSpec.f1)) then begin
    tstr = USetStr(6686);
    tstr = tstr & " ";
    tstr = tstr & RepSpec.f1;
    Header(rw,tstr,1);
    rw = rw + 1;
  end; 
   if (nonblank(RepSpec.f2)) then begin
    tstr = USetStr(6684);
    tstr = tstr & " ";
    tstr = tstr & RepSpec.f2;
    Header(rw,tstr,1);
    rw = rw + 1;
  end;
  EndHeader;
  SetRepCol(2,80);
  SetRepCol(5,230);
  SetRepCol(6,280);
  SetRepCol(7,330);
  SetRepCol(8,380);
  SetRepCol(9,430);
  if (RepSpec.flags[0]==1) then begin
    USr.Code = frpers;
    Gray_Divider(0,1);
    TrHs = true;    
    while (LoopMain(USr,1,TrHs)) begin
      printedf = false;
      if (nonblank(RepSpec.f2)) then begin
        if (USr.Code>topers) then begin TrHs = false; end;
      end;  
      if (TrHs) then begin
//        PrintPersonCustAct(RepSpec,USr,printedf,counter);
        if (printedf) then begin
          Gray_Divider(0,1);
          StartFormat(15);
          OutString(450,0,USetStr(6690),true);        
          tstr = counter;
          OutString(480,0,tstr,true);
          EndFormat;
          counter = 0;
        end;
      end;
    end;
  end else begin
    StartFormat(15);
    OutString(0,0,USetStr(6686),false);
    OutString(5,0,"HF",true);
    OutString(6,0,"FO",true);
    OutString(7,0,"O2",true);
    OutString(8,0,"HR",true);
    OutString(9,0,"RT",true);
    OutString(1,0,"Other",true);
    EndFormat;
    CUr.Code = frcust;
    Gray_Divider(0,1);
    TrHs = true;    
    while (LoopMain(CUr,1,TrHs)) begin
      printedf = false;
      if (nonblank(RepSpec.f1)) then begin
        if (CUr.Code>tocust) then begin TrHs = false; end;
      end;  
      if (TrHs) then begin
        keycnt = PrintThisCustAct(RepSpec,CUr,hfcnt,focnt,o2cnt,hrcnt,rtcnt,odcnt,printedf);
        if (RepSpec.long1>-1) then begin
          if (keycnt<RepSpec.long1) then begin
            keycnt = 0;
          end;
        end;
        if (keycnt>0) then begin
          if (RepSpec.ArtMode==0) then begin
            StartFormat(15);
            OutString(0,0,CUr.Code,false);
            OutString(2,0,CUr.Name,false);
          end else begin
            Gray_Divider(0,1);
            StartFormat(15);
            OutString(2,0,USetStr(6813),false);
          end;
/*
          if (RepSpec.flags[2]==0) then begin OutLongInt(5,0,hfcnt,true); end;
          if (RepSpec.flags[3]==0) then begin OutLongInt(6,0,focnt,true); end;
          if (RepSpec.flags[4]==0) then begin OutLongInt(7,0,o2cnt,true); end;
          if (RepSpec.flags[5]==0) then begin OutLongInt(8,0,hrcnt,true); end;
          if (RepSpec.flags[6]==0) then begin OutLongInt(9,0,rtcnt,true); end;
          if (RepSpec.flags[7]==0) then begin OutLongInt(1,0,odcnt,true); end;
*/
          OutLongInt(5,0,hfcnt,true);
          OutLongInt(6,0,focnt,true);
          OutLongInt(7,0,o2cnt,true);
          OutLongInt(8,0,hrcnt,true);
          OutLongInt(9,0,rtcnt,true);
          OutLongInt(1,0,odcnt,true);
          EndFormat;
          if (RepSpec.ArtMode==1) then begin
            StartFormat(30);
            EndFormat;
          end;
          custcnt = custcnt + 1;
          totkeycnt = totkeycnt + keycnt;
        end;
        totcustcnt = totcustcnt + 1;
      end;
    end;
  end;
  Black_Divider(0,1);
  StartFormat(15);
  OutString(300,0,"Total number of Customers:",false);
  OutLongInt(1,0,totcustcnt,true);
  EndFormat;
  StartFormat(15);
  OutString(300,0,"Customers that received Keys",false);
  OutLongInt(1,0,custcnt,true);
  EndFormat;
  StartFormat(15);
  OutString(300,0,"Number of Keys given",false);
  OutLongInt(1,0,totkeycnt,true);
  EndFormat;
  EndJob;
  RETURN;
END;
