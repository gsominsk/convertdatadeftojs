external function string 255 NodeURL(record CloudNodeVc);external function Boolean TreatServiceError(LongInt,string,string);globalprocedure GetServersWithHAL(var array string afolders)begin  LongInt i,n;  string 255 tmp;    n = CountFoldersInDir("/Servers");    for (i = 0; i<n; i = i + 1) begin    tmp = GetFolderNameInDir("/Servers",i);    if (FileExists("/Servers/" & tmp & "/halcust") or FileExists("/Servers/" & tmp & "/halpatch")) then begin      afolders[afolders.length] = tmp;    end;  end;end;function Boolean RCSMissingForFolder(string folder,string node,record RCVc RepSpec)begin  Boolean res,loopf;  record RemoteCloudServerVc RCSr;    res = true;    if (RepSpec.flags[1]==1) then begin    res = false;  end;    RCSr.Controller = node;  loopf = true;  while (LoopKey("Controller",RCSr,1,loopf)) begin    if (RCSr.Controller<>node) then begin loopf = false; end;    if (loopf) then begin      if (RCSr.DataFolder==("/Servers/" & folder)) then begin        res = true;        if (RepSpec.flags[0]==0 and nonblank(RCSr.CUCode)) then begin          res = false;        end;        goto LRCSMissingForFolder;      end;    end;  end;  LRCSMissingForFolder:;  RCSMissingForFolder = res;  return;end;procedure ListServersWithHALOnNode(record CloudNodeVc CNr,record RCVc RepSpec)begin  array string 255 afolders;  string 255 url;  LongInt stat;  boolean failf;  Integer i;    url = NodeURL(CNr);    if (CNr.Closed!=0) then begin    goto LListServersWithHALOnNode;  end;    stat = CallService(url).GetServersWithHAL(afolders);  failf = TreatServiceError(stat,url,"GetServersFolder");    if (failf) then begin    goto LListServersWithHALOnNode;  end;    for (i = 0; i<afolders.length; i = i + 1) begin    if (RCSMissingForFolder(afolders[i],CNr.Code,RepSpec)) then begin      StartFormat(15);      OutString(0,0,CNr.Code,false);      OutString(200,0,afolders[i],false);      EndFormat;    end;  end;  LListServersWithHALOnNode:;  return;end;globalprocedure ListServersWithHALRn(record RcVc RepSpec)begin  record CloudNodeVc CNr;    StartReportJob("List Servers with HAL");  EndHeader;    while (LoopMain(CNr,0,true)) begin    ListServersWithHALOnNode(CNr,RepSpec);  end;    EndJob;  return;end;