external procedure HTDetailLevel(Integer, var string);
external procedure HTOKF(Integer,Integer, var string);
external procedure HT2Per(Date, Date , var string);

procedure HTSorting(Integer sorting,var string tstr)
begin
  tstr = USetStr(17546);
  switch (sorting) begin
    case 0: tstr = tstr & " " & USetStr(17531);
    case 1: tstr = tstr & " " & USetStr(17538);
    case 2: tstr = tstr & " " & USetStr(17547);
  end;
  return;
end;

global
procedure BuyBackJRn(record RcVc RepSpec)
begin
  Boolean found,testf,first;
  record BuyBackVc BBr;
  string 255 keystr,lastbbnr;
  Integer keys,rw; 
  string 255 tstr;
  val op,bbp,odiff,ad,ac,adiff,com;
  val totop,totbbp,totodiff,totad,totac,totadiff,totcom;
  
  StartReportJob(USetStr(17530));
   rw = 1;
   HT2Per(RepSpec.sStartDate,RepSpec.sEndDate,tstr);
   Header(rw,tstr,1);
   rw = rw + 1;
   HTOKF(RepSpec.flags[1],RepSpec.flags[2],tstr);
   Header(rw,tstr,0);
   HTDetailLevel(RepSpec.ArtMode,tstr);
   Header(rw,tstr,1);
   rw = rw + 1;
   if (nonblank(RepSpec.f1)) then begin
     Header(rw,USetStr(17538) & ":" & RepSpec.f1,1);
     rw = rw + 1;
   end;
   HTSorting(RepSpec.flags[4],tstr);
   Header(rw,tstr,1);
   rw = rw + 1;
   if (RepSpec.flags[0]!=0) then begin
     Header(rw,USetStr(17539),1);
     rw = rw + 1;
   end;
  EndHeader;
  switch (RepSpec.ArtMode) begin
    case 0:
      SetRepCol(2,170);
      SetRepCol(3,220);
      SetRepCol(4,270);
      SetRepCol(5,320);
      SetRepCol(6,370);
      SetRepCol(7,420);
      StartFormat(15);
       OutString(0,0,USetStr(17531),false);
       OutString(60,0,USetStr(17540),false);
       OutString(2,0,USetStr(17532),true);
       OutString(3,0,USetStr(17533),true);
       OutString(4,0,USetStr(17536),true);
       OutString(5,0,USetStr(17534),true);
       OutString(6,0,USetStr(17535),true);
       OutString(7,0,USetStr(17537),true);
       OutString(1,0,USetStr(17536),true);
      EndFormat;
      if (RepSpec.flags[4]==1) then begin 
        StartFormat(15);
        OutString(0,0,USetStr(17548),false);
        EndFormat;
      end;
      if (RepSpec.flags[4]==2) then begin 
        StartFormat(15);
        OutString(0,0,USetStr(17547),false);
        OutString(60,0,USetStr(17548),false);
        EndFormat;
      end;
    case 1:
      SetRepCol(2,70);
      SetRepCol(3,140);
      SetRepCol(4,220);
      SetRepCol(5,280);
      StartFormat(15);
       OutString(0,0,USetStr(17531),false);
       OutString(2,0,USetStr(17540),false);
       OutString(3,0,USetStr(17545),false);
       OutString(4,0,USetStr(17542),false);
       OutString(5,0,USetStr(17543),false);
       OutString(1,0,USetStr(17544),true);
       if (RepSpec.Media==mtFile) or (RepSpec.Media==mtExcel) then begin
         OutString(1,0,USetStr(17547),false);
       end;
      EndFormat;
    case 1:
  end;
  Gray_Divider(0,1);
  switch (RepSpec.flags[4]) begin
    case 0:
      keystr = "TransDate";
      keys = 1;
      if (nonblank(RepSpec.f1)) then begin
        keystr = "BuyBackNr";
        keys = 2;
        BBr.BuyBackNr = RepSpec.f1;
      end;
    case 1:
      keystr = "BuyBackNr";
      keys = 2;
    case 2:
      keystr = "CustCode";
      keys = 2;
  end;
  found = true;
  BBr.TransDate = RepSpec.sStartDate;
  while (LoopKey(keystr,BBr,1,found)) begin
    switch (RepSpec.flags[4]) begin
      case 0:
        if (nonblank(RepSpec.f1)) then begin
          if (BBr.BuyBackNr!=RepSpec.f1) then begin found = false; end;     
        end else begin
          if (DateInRange(BBr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin found = false; end;
        end;
      case 1:
        if (nonblank(RepSpec.f1)) then begin
          if (BBr.BuyBackNr!=RepSpec.f1) then begin found = false; end;     
        end;
      case 2:
    end;
    if (BBr.TransDate>RepSpec.sEndDate) then begin found = false; end;
    if (found) then begin
      testf = true;
      switch (RepSpec.flags[4]) begin
        case 0:
          if (DateInRange(BBr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin testf = false; end;
        case 0:
          if (DateInRange(BBr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin testf = false; end;
        case 0:
          if (DateInRange(BBr.TransDate,RepSpec.sStartDate,RepSpec.sEndDate)==false) then begin testf = false; end;
          if (nonblank(RepSpec.f1)) then begin
            if (BBr.BuyBackNr!=RepSpec.f1) then begin testf = false; end;     
          end;
      end;
      if (RepSpec.flags[0]==0) then begin        
        if (BBr.Invalid!=0) then begin testf = false; end;
      end;
      if (RepSpec.flags[1]==0) then begin  
        if (BBr.OKFlag==0) then begin testf = false; end;
      end;
      if (RepSpec.flags[2]==0) then begin  
        if (BBr.OKFlag!=0) then begin testf = false; end;
      end;
      if (RepSpec.flags[3]!=0) then begin
        if ((BBr.OrgPrice-BBr.BuyBackPrice-BBr.Commision)==0) then begin testf = false; end;
      end;
      if (RepSpec.flags[5]!=0) then begin  
        if (BBr.Reconciled!=0) then begin testf = false; end;
      end;
      if (RepSpec.flags[6]!=0) then begin  
        if (nonblank(BBr.BuyBackNr)) then begin testf = false; end;
      end;
      if (testf) then begin
        if (RepSpec.flags[4]!=0) and (first==false) and (RepSpec.ArtMode==0) then begin 
          if (RepSpec.flags[4]==1) then begin 
            if (nonblank(BBr.BuyBackNr)) then begin 
              StartFormat(15);
              OutString(0,0,USetStr(17548) & " " & BBr.BuyBackNr,false);
              EndFormat;
            end else begin 
              StartFormat(15);
              OutString(0,0,USetStr(17549),false);
              EndFormat;
            end;
          end;
          if (RepSpec.flags[4]==2) then begin 
            OutString(0,"DblCUVc",BBr.CustCode,false);
            StartFormat(15);
            if (nonblank(BBr.BuyBackNr)) then begin 
              OutString(60,0,BBr.BuyBackNr,false);
            end else begin 
              OutString(60,0,USetStr(17549),false);
            end;  
            EndFormat;
          end;
          first = true;
        end;  
        if (nonblank(lastbbnr)) then begin
          if (lastbbnr!=BBr.BuyBackNr) then begin
            if (op!=0) or (bbp!=0) or (odiff!=0) or (ad!=0) or (ac!=0) or (adiff!=0) or (com!=0) then begin
              switch (RepSpec.ArtMode) begin
                case 0:
                  if (RepSpec.flags[4]!=0) then begin 
                    Gray_Divider(120,1);
                    StartFormat(15);
                    OutVal(2,0,op,M4Val,true);
                    OutVal(3,0,bbp,M4Val,true);
                    OutVal(4,0,odiff,M4Val,true);
                    OutVal(5,0,ad,M4Val,true);
                    OutVal(6,0,ac,M4Val,true);
                    OutVal(7,0,com,M4Val,true);
                    OutVal(1,0,adiff,M4Val,true);
                    EndFormat;
                    if (RepSpec.flags[4]==1) then begin 
                      if (nonblank(BBr.BuyBackNr)) then begin 
                        StartFormat(15);
                        OutString(0,0,BBr.BuyBackNr,false);
                        EndFormat;
                      end else begin 
                        StartFormat(15);
                        OutString(0,0,USetStr(17549),false);
                        EndFormat;
                      end;  
                    end;
                    if (RepSpec.flags[4]==2) then begin 
                      OutString(0,"DblCUVc",BBr.CustCode,false);
                      StartFormat(15);
                      if (nonblank(BBr.BuyBackNr)) then begin 
                        OutString(60,0,BBr.BuyBackNr,false);
                      end else begin 
                        OutString(60,0,USetStr(17549),false);
                      end;  
                      EndFormat;
                    end;
                  end;  
              end;
            end;
            op = blankval; bbp = blankval; odiff = blankval; ad = blankval; ac = blankval; adiff = blankval;
            com = blankval;
          end;
        end;
        switch (RepSpec.ArtMode) begin
          case 0:
            StartFormat(15);
             OutString(0,"DblBuyBackVc",BBr.SerNr,false);
             OutString(60,"DblINVc",BBr.ArtCode,false);
//             OutString(90,0,BBr.BuyBackNr,false);
             OutVal(2,0,BBr.OrgPrice,M4Val,true);
             OutVal(3,0,BBr.BuyBackPrice,M4Val,true);
             OutVal(4,0,BBr.OrgPrice-BBr.BuyBackPrice,M4Val,true);
             OutVal(5,0,BBr.ActualDebit,M4Val,true);
             OutVal(6,0,BBr.ActualCredit,M4Val,true);
             OutVal(7,0,BBr.Commision,M4Val,true);
             OutVal(1,0,BBr.OrgPrice-BBr.BuyBackPrice-BBr.Commision,M4Val,true);
            EndFormat;
          case 1:
            StartFormat(15);
             OutString(0,"DblBuyBackVc",BBr.SerNr,false);
             OutString(2,"DblINVc",BBr.ArtCode,false);
             OutStringID(3,"DblSerialNrHistory",BBr.SerialNr,false,BBr.ArtCode);
             if (BBr.IVNr>0) then begin 
               OutString(4,"DblIVVc",BBr.IVNr,false);
             end else begin 
               OutString(4,0,"",false);
             end;
             if (Left(BBr.OrgInvoiceNr,Len(USetStr(1152))+1)==USetStr(1152) & ":") then begin
               OutString(5,"DblVIVc",Right(BBr.OrgInvoiceNr,Len(BBr.OrgInvoiceNr)-Len(USetStr(1152))-1),false);
             end else begin
               OutString(5,"DblVI2Vc",BBr.OrgInvoiceNr,false);
             end;  
             OutVal(1,0,BBr.Quant,M4Val,true);
             if (RepSpec.Media==mtFile) or (RepSpec.Media==mtExcel) then begin
                OutString(0,0,BBr.CustName,false);
             end else begin
               EndFormat;
               StartFormat(15);
               OutString(0,0,BBr.CustName,false);
             end;
             EndFormat;
        end;
        op = op + BBr.OrgPrice;
        bbp = bbp + BBr.BuyBackPrice;
        odiff = odiff + (BBr.OrgPrice-BBr.BuyBackPrice);
        ad = ad + BBr.ActualDebit;
        ac = ac + BBr.ActualCredit;
        adiff = adiff + (BBr.OrgPrice-BBr.BuyBackPrice-BBr.Commision);
        com = com + BBr.Commision;

        totop = totop + BBr.OrgPrice;
        totbbp = totbbp + BBr.BuyBackPrice;
        totodiff = totodiff + (BBr.OrgPrice-BBr.BuyBackPrice);
        totad = totad + BBr.ActualDebit;
        totac = totac + BBr.ActualCredit;
        totadiff = totadiff + (BBr.OrgPrice-BBr.BuyBackPrice-BBr.Commision);
        totcom = totcom + BBr.Commision;
      end;
      lastbbnr = BBr.BuyBackNr;
    end;
  end;
  switch (RepSpec.ArtMode) begin
    case 0:
      if (RepSpec.flags[4]!=0) then begin 
        Gray_Divider(120,1);
        StartFormat(15);
        OutVal(2,0,op,M4Val,true);
        OutVal(3,0,bbp,M4Val,true);
        OutVal(4,0,odiff,M4Val,true);
        OutVal(5,0,ad,M4Val,true);
        OutVal(6,0,ac,M4Val,true);
        OutVal(7,0,com,M4Val,true);
        OutVal(1,0,adiff,M4Val,true);
        EndFormat;
      end;  
      Gray_Divider(0,1);
      StartFormat(15);
       OutVal(2,0,totop,M4Val,true);
       OutVal(3,0,totbbp,M4Val,true);
       OutVal(4,0,totodiff,M4Val,true);
       OutVal(5,0,totad,M4Val,true);
       OutVal(6,0,totac,M4Val,true);
       OutVal(7,0,totcom,M4Val,true);
       OutVal(1,0,totadiff,M4Val,true);
      EndFormat;
  end;
  EndJob;
  return;
end;