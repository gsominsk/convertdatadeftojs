external function Boolean BuildBudget(string,record TBBUVc,Array Integer,var Integer);
external procedure ProjectHeader(record RcVc,record PRVc,Integer);
external procedure GetPRItemName(string,string,var string);
external procedure FindBudgetSum(string,string,string,Array Integer,Integer,var val);
external procedure FindBudgetRow(string,string,string,Integer,var Date,var Integer);

global
procedure PRItemSpecRn(record RcVc RepSpec)
BEGIN
  record TBIVVc TBIVr;
  record TBBUVc TBBUr;
  record PRVc PRr;
  Boolean found,testf;
  Date dt;
  Integer brow;
  string 255 tstr,dblstr;
  val sum,tsum;
  LongInt recid,budrec;
  Boolean headerf;
  val t,sumbud;
  Integer uarracnt;
  Array Integer uarr;
  Boolean budfound;
  Integer budtype;
  Integer totprcnt;
  
  headerf = false;
  StartReportJob(USetStr(4871));
  EndHeader;
  StartFormat(15);
  tstr = "   ";
  OutString(0,0,tstr,false);
  EndFormat;

  PRr.Code = RepSpec.f1;
  if (ReadFirstMain(PRr,1,true)==false) then begin goto L99; end;
  budfound = BuildBudget(PRr.Code,TBBUr,uarr,uarracnt);

  TBIVr.PRCode = RepSpec.f1;
  TBIVr.Invoice = -1;
  TBIVr.oVc = 1;
  found = true;
  while (LoopKey("InvKey",TBIVr,3,found)) begin
    testf = true;
    if (TBIVr.PRCode<>RepSpec.f1) then begin found = false; end;
    if (TBIVr.Invoice<>-1) then begin found = false; end;
    if (nonblankdate(RepSpec.d1)) then begin
      if (TBIVr.TransDate>RepSpec.d1) then begin
        testf = false;
      end;  
      if (testf) then begin
        if (nonblankdate(TBIVr.InvAfter)) then begin
          if (RepSpec.d1<TBIVr.InvAfter) then begin testf = false; end;
        end;
      end;
    end else begin
      if (TBIVr.TransDate>CurrentDate) then begin
        testf = false;
      end;  
    end;
    if (TBIVr.ItemType<>RepSpec.flags[0]) then begin testf = false; end;
    if (TBIVr.ArtCode<>RepSpec.f2) then begin testf = false; end;    
    FindBudgetRow(RepSpec.f1,RepSpec.f2,"",RepSpec.flags[0],dt,budtype);    
    if (nonblankdate(dt)) then begin
      if (nonblankdate(RepSpec.d1)) then begin
        if (dt>RepSpec.d1) then begin testf = false; end;
      end else begin
        if (dt>CurrentDate) then begin testf = false; end;
      end;
    end;
    if (found==false) then begin testf = false; end;
    
    if (testf) then begin
      if (headerf==false) then begin
        StartFormat(15);
        OutString(0,0,USetStr(4842),false);
        EndFormat;
        Gray_Divider(0,1);
        ProjectHeader(RepSpec,PRr,1);
        headerf = true;
      end;
      dblstr = TBIVr.SerNr;
      dblstr = dblstr & ",";
      dblstr = dblstr & TBIVr.Row;
      dblstr = dblstr & ",";
      dblstr = dblstr & TBIVr.PRCode;
      dblstr = dblstr & ",";
      dblstr = dblstr & TBIVr.oVc;
      StartFormat(15);      
      OutStringID(20,"DblPR",TBIVr.ArtCode,false,dblstr);//OpM46o(20,GetDblClk("DblPR"),&TBIVr.ArtCode,M4Str,false,recid);
      OutStringID(80,"DblPR",TBIVr.EMCode,false,dblstr);//OpM46o(80,GetDblClk("DblPR"),&TBIVr.EMCode,M4Str,false,recid);
      OutVal(120,0,TBIVr.InvQty,M4UVal,true);//OpM46o(120,GetDblClk("DblPR"),&TBIVr.InvQty,M4UVal,true,recid);
      if (RepSpec.flags[12]==1) then begin
        GetPRItemName(TBIVr.ArtCode,TBIVr.Comment,tstr);
        OutString(125,0,Left(tstr,25),false);
      end;
      if (RepSpec.flags[11]==1) then begin
        OutVal(300,0,TBIVr.Price,M423Val,true);//OpM46o(270,GetDblClk("DblPR"),&TBIVr.Price,M423Val,true,recid);
      end;  
      OutVal(330,0,TBIVr.Discount,M41Val,true);//OpM46o(300,GetDblClk("DblPR"),&TBIVr.Discount,M41Val,true,recid);
      OutVal(400,0,TBIVr.Sum,M4Val,true);//OpM46o(370,GetDblClk("DblPR"),&TBIVr.Sum,M4Val,true,recid);
      FindBudgetSum(TBIVr.PRCode,TBIVr.ArtCode,TBIVr.EMCode,uarr,uarracnt,t);
      OutVal(480,0,t,M4Val,true);//OpM46o(430,GetDblClk("DblTSBud"),&t,M4Val,true,budrec);
//      OutDate(480,0,TBIVr.TransDate,true);//OpM46o(480,GetDblClk("DblPR"),&TBIVr.TransDate,M4Date,true,recid);
      EndFormat;
      sum = sum + TBIVr.Sum;
      tsum = tsum + TBIVr.Sum;
      sumbud = sumbud + t;
      totprcnt = totprcnt + 1;
    end;
  end;
  if (headerf) then begin
     Black_Divider(280,1);
     StartFormat(15);
     OutVal(400,0,sum,M4Val,true);
     OutVal(480,0,sumbud,M4Val,true);
     EndFormat;
     sum = 0;
  end;
  Gray_Divider(0,1);
  StartFormat(10);
  OutString(300,0,USetStr(4872) & ": ",false);
  OutString(1,0,totprcnt,true);
  EndFormat;
  
L99:;
  EndJob;
  RETURN;
END;
