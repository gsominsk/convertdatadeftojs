	  //SourceRn.hal

#ifdef HAL

external procedure BeginCurncyTotals(var Integer);
external procedure HTCusts(string, string, var string);

procedure HT2Per2(Date a,Date b, var string tstr, var string tstr1)
begin
  string 255 tstr2;

  tstr2 = PackStrDate(a);
  tstr = USetStr(3013);
  tstr = tstr & tstr2;
  tstr = tstr & " : ";
  tstr2 = PackStrDate(b);
  tstr = tstr & tstr2;
  tstr1 = USetStr(3013) & a & " : " & b;
return;
end;

procedure HTOrder(LongInt a,LongInt b,var string res)
begin
  if (a==-1 and b==-1) then begin
    res = USetStr(1823);
  end else begin
    if (a==b) then begin
      res = USetStr(1822);
    end else begin
      res = USetStr(1821);
    end;  
    res = res & a;
    if (a<>b) then begin
      res = res & " : ";
      res = res & b;
    end;
  end;
  return;
end;


procedure PrintCust (Record ORVc ORr)
begin
  if (nonblank(ORr.Addr1)) then begin
    StartFormat(15);
    OutString(140,0,ORr.Addr1,false);
    EndFormat;
  end;
  if (nonblank(ORr.Addr2)) then begin
    StartFormat(15);
    OutString(140,0,ORr.Addr2,false);
    EndFormat;
  end;
  if (nonblank(ORr.Addr3)) then begin
    StartFormat(15);
    OutString(140,0,ORr.Addr3,false);
    EndFormat;
  end;
  RETURN;
END;

procedure PrintCust2 (Record ORVc ORr)
begin
  if (nonblank(ORr.Addr1)) then begin
    StartFormat(15);
    OutString(0,0,ORr.Addr1,false);
    EndFormat;
  end;
  if (nonblank(ORr.Addr2)) then begin
    StartFormat(15);
    OutString(0,0,ORr.Addr2,false);
    EndFormat;
  end;
  if (nonblank(ORr.Addr3)) then begin
    StartFormat(15);
    OutString(0,0,ORr.Addr3,false);
    EndFormat;
  end;
  RETURN;
END;

procedure PrintOrdHeader (Record ORVc ORr, var Boolean footf)
begin
  StartFormat(15);
  OutString(0,0, USetStr(2584),false);
  OutString(60,0, USetStr(5203),false);
  OutString(140,0, USetStr(2564),false);
  OutString(290,0, USetStr(8611),false);
  OutString(420,0, USetStr(8152),false);
  EndFormat;
  Gray_Divider(0,1);
  StartFormat(15);
  OutString(0,0,ORr.SerNr,false);
  OutString(60,0,ORr.CustCode,false);
  OutString(140,0,ORr.Addr0,false);
  OutString(290,0,ORr.CustOrdNr,false);
  OutString(420,0,ORr.PlanShip,false);
//  PrintCust (ORr);
  EndFormat;
  StartFormat(15);
  OutString(0,0, USetStr(2593),false);
  OutString(90,0, USetStr(8612),false);
  OutString(140,0, USetStr(2504),false);
  EndFormat;
  StartFormat(15);
  OutString(11,0,USetStr(8613),false);
  OutString(70,0,USetStr(8614),false);
  OutString(130,0,USetStr(8615),false);
  OutString(185,0,USetStr(8616),false);
  OutString(240,0,USetStr(8617),false);
  OutString(300,0,USetStr(8618),false);
  OutString(350,0,USetStr(8624),false);
  OutString(420,0,USetStr(8625),false);
  EndFormat;

  Gray_Divider(0,1);

  footf = true;
  RETURN;
END;

procedure PrintOrdHeader2 (Record ORVc ORr, var Boolean footf)
begin
  StartFormat(15);
  OutString(0,0, USetStr(2584) & ": " & ORr.SerNr,false);
  EndFormat;
  StartFormat(15);
  OutString(0,0, USetStr(5203) & ": " & ORr.CustCode,false);
  EndFormat;
  StartFormat(15);
  OutString(0,0, USetStr(2564) & ": ",false);
  EndFormat;
  StartFormat(15);
  OutString(0,0,ORr.Addr0,false);
  EndFormat;
  PrintCust2 (ORr);
  StartFormat(15);
  OutString(0,0, USetStr(8611) & ": " & ORr.CustOrdNr,false);
  EndFormat;
  StartFormat(15);
  OutString(0,0, USetStr(8152) & ": " & ORr.PlanShip,false);
  EndFormat;
  footf = true;
  RETURN;
END;

procedure PrintItemCodeTotals(record SMVc SMr)
BEGIN
  row SMVc SMrw;
  Integer i,rwcnt;

  rwcnt = MatRowCnt(SMr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(SMr,i,SMrw);
    StartFormat(15);
    OutString(0,0,SMrw.Objects,false);
    OutString(100,0,SMrw.Comment,false);
    OutVal(400,0,SMrw.DebVal,M40Val,true);
    EndFormat;
  end;
  RETURN;
END;


procedure AddItemCodeTotalRow(string artcode,string spec,val quant,record SMVc SMr)
BEGIN
  row SMVc SMrw;
  Integer i,rwcnt;
  Boolean notfound;

  notfound = true;
  rwcnt = MatRowCnt(SMr);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(SMr,i,SMrw);
    if (SMrw.Objects==artcode) then begin
      SMrw.DebVal =  SMrw.DebVal + quant;
      notfound = false;
      MatRowPut(SMr,i,SMrw);
      goto L99;
    end;
  end;
  if ((notfound) and (nonblank(artcode))) then begin
    SMrw.Objects = artcode;
    SMrw.DebVal = quant;
    SMrw.Comment = spec;    
    MatRowPut(SMr,rwcnt,SMrw);
  end;
L99:;
  RETURN;
END;

global
procedure SourceRn(record RcVc RepSpec)
begin
  record ORVc ORr;
  row ORVc ORrw;
  Boolean TrHs;
  Boolean testf, printf, keyf, printheaderf, footf, locf;
  val iv;
  val TotSum;
  LongInt afr;
  LongInt ato;
  string 255 tstr, tstr2, tstr3, tstr4;
  Integer rw, keynr,myradio, rwcnt, i;
  string 20 frc,toc, mykey;
  Date td,td2;
  record SMVc SMr;
  array val av1;
  array val av2;
  array val av3;
  array string 20 acur;
  Integer curcnt;

  RecordNew(SMr);
  printf = false;
  TotSum = 0;
  mykey = "SerNr";
  keyf = true;
  printheaderf = true;
  keynr = 1;
  myradio = 0;
  frc = FirstInRange(RepSpec.f2,20);//Customer
  toc =  LastInRange(RepSpec.f2,20);			
  afr = FirstInRange(RepSpec.f1,10);//Order no
  ato =  LastInRange(RepSpec.f1,10);
  if (RepSpec.flags[1] == 1) then begin//Customer Sorting
    mykey = "CustCode";
    keynr = 1;
    myradio = 0;
  end;
  if (RepSpec.flags[1] == 0) then begin//SerNr Sorting
      mykey = "SerNr";
      keynr = 1;
      myradio = 1;
  end;
  if (RepSpec.ArtMode == 0) begin
    printf = true;
  end;
  rw = 1;

  BeginCurncyTotals(curcnt);
  StartReportJob( USetStr(8610));
  HT2Per2(RepSpec.sStartDate,RepSpec.sEndDate,tstr,tstr2);
  Header(rw,tstr,1);
  rw = rw + 1;
  if (nonblank(RepSpec.f3)) then begin
    Header(rw, USetStr(8621) & RepSpec.f3,0);
    tstr3 = USetStr(8621) & RepSpec.f3;
  end else begin
    Header(rw, USetStr(8623),0);
    tstr3 = USetStr(8623);
  end;
  HTCusts(frc,toc,tstr);
  Header(rw,tstr,1);
  rw = rw + 1;
  if (nonblank(RepSpec.f2)) then begin
    ORr.CustCode = frc;
  end;
  if (nonblank(RepSpec. ObjStr)) then begin
    Header(rw, USetStr(8622) & RepSpec. ObjStr,0);
    tstr4 = USetStr(8622) & RepSpec. ObjStr;
  end;
  if (nonblank(RepSpec.f1)) then begin
    HTOrder(afr,ato,tstr);
    Header(rw,tstr,1);
    rw = rw + 1;
    ORr.SerNr = afr;
  end;
  if (nonblank(RepSpec.Stext)) then begin
    Header(rw, USetStr(2768) & RepSpec.Stext,0);
  end;
  if (nonblankdate(RepSpec.d1)) then begin
    Header(rw, USetStr(8619) &" "& RepSpec.d1,1);
    rw = rw + 1;
  end;
  if (nonblankdate(RepSpec.d2)) then begin
    Header(rw, USetStr(8614) &" "& RepSpec.d2,1);
    rw = rw + 1;
  end;
  if (nonblankdate(RepSpec.RegDate)) then begin
    Header(rw, USetStr(8624) & " " & RepSpec.RegDate,1);
    rw = rw + 1;
  end;
  if (nonblank(RepSpec.AccStr)) then begin
    td2 = StringToDate(RepSpec.AccStr);
    Header(rw, USetStr(8617) & " " & td2,1);
  end;
  EndHeader;
  if (RepSpec.flags[3] == 1) then begin
    StartFormat(15);
    OutString(0,0,USetStr(8610),false);
    EndFormat;
    StartFormat(15);
    OutString(0,0,tstr2, false);
    EndFormat;
    StartFormat(15);
    OutString(0,0,tstr3,false);
    EndFormat;
    StartFormat(15);
    HTCusts(frc,toc,tstr);
    OutString(0,0,tstr, false);
    EndFormat;
    HTOrder(afr,ato,tstr);
    StartFormat(15);
    OutString(0,0,tstr,false);
    EndFormat;
    StartFormat(15);
    OutString(0,0,tstr4, false);
    EndFormat;
  end;
  if (nonblank(RepSpec.f2)) then begin
    ORr.CustCode = frc;
  end;
  if (nonblank(RepSpec.f1)) then begin
    ORr.SerNr = afr;
  end;
  TrHs = true;
  while (LoopKey(mykey,ORr,keynr,TrHs)) begin
    testf = true;
    printheaderf = true;
    footf = false;
    if ((ORr.OrdDate < RepSpec.sStartDate) or (ORr.OrdDate > RepSpec.sEndDate ))then begin
      testf = false;
    end;
    if (ato <> -1) then begin
      if (ORr.SerNr > ato) then begin
        if (myradio == 1) then begin
          TrHs = false;
        end;
        if (myradio == 0) then begin
          testf = false;
        end;
      end;
    end;
    if (afr <> -1) then begin
      if (ORr.SerNr < afr) then begin
        if (myradio == 1) then begin
          TrHs = false;
        end;
        if (myradio == 0) then begin
          testf = false;
        end;
      end;
    end;
    if nonblank(toc) then begin
      if (ORr.CustCode > toc) then begin
        if (myradio == 0) then begin
          TrHs = false;
        end;
        if (myradio == 1) then begin
          testf = false;
        end;
      end;
    end;
    if nonblank(frc) then begin
      if (ORr.CustCode < frc) then begin
        if (myradio == 1) then begin
          testf = false;
        end;
      end;
    end;
    if (TrHs == false) then begin
      testf = false;
    end;
    if ((RepSpec.flags[2] == 0) and (ORr.Closed == 1)) then begin
      testf = false;
    end;
    if nonblank(RepSpec.ObjStr) then begin
      if (RepSpec.ObjStr <> ORr.OrderClass) then begin
        testf = false;
      end;
    end;
    if (nonblankdate(RepSpec.d1)) then begin
      td = StringToDate(ORr.PlanShip);
      if (nonblank(ORr.PlanShip) and (td<>RepSpec.d1)) then begin
        testf = false;
      end;
      if (blank(ORr.PlanShip)) then begin
        testf = false;
      end;
    end;
    if (testf) then begin
      rwcnt = MatRowCnt(ORr);
      for (i=0;i<rwcnt;i=i+1) begin
        locf = true;
        MatRowGet(ORr,i,ORrw);
        if (RepSpec.flags[3] <> 1) then begin
          if nonblank(RepSpec.f3) or nonblank(RepSpec.Stext) or nonblankdate(RepSpec.d2) or nonblankdate(RepSpec.RegDate) or nonblankdate(td2) then begin
            if ((nonblank(RepSpec.f3)) and (RepSpec.f3 <> ORrw.Source)) then begin
              locf = false;
            end;
            if ((nonblank(RepSpec.Stext)) and (RepSpec.Stext <> ORrw.Location)) then begin
              locf = false;
            end;
            if ((nonblankdate(RepSpec.d2)) and (RepSpec.d2 <> ORrw.PickingDate)) then begin
              locf = false;
            end;
            if ((nonblankdate(RepSpec.RegDate)) and (RepSpec.RegDate <> ORr.DespatchDate)) then begin
              locf = false;
            end;
            if ((nonblankdate(td2)) and (ORrw.InloadingDate <> td2)) then begin
              locf = false;
            end;
            if (locf) then begin
              AddItemCodeTotalRow(ORrw.ArtCode,ORrw.Spec,ORrw.Quant,SMr);
              if (printheaderf) then begin
                PrintOrdHeader (ORr,footf);
                printheaderf = false;
              end;
              StartFormat(15);
              OutString(0,0,ORrw.ArtCode,false);
              OutVal(90,0,ORrw.Quant,M40Val,false);
              OutString(140,0,ORrw.Spec,false);
              EndFormat;
              StartFormat(15);
              OutString(11,0,ORrw.Source,false);
              OutDate(70,0,ORrw.PickingDate,false);
              OutString(130,0,ORrw.PickingTime,false);
              OutString(185,0,ORrw.Location,false);
              OutDate(240,0,ORrw.InloadingDate,false);
              OutString(300,0,ORrw.InloadingTime,false);
              if (nonblankdate(ORrw.DespatchRowDate)) then begin
                OutDate(350,0, ORrw.DespatchRowDate,false);
              end else begin
                OutDate(350,0, ORr.DespatchDate,false);
              end;
              OutString(420,0, ORrw.DespatchRowTime,false);
              EndFormat;
            end;
          end else begin
            if (printheaderf) then begin
              PrintOrdHeader (ORr,footf);
              printheaderf = false;
            end;
            StartFormat(15);
            OutString(0,0,ORrw.ArtCode,false);
            OutVal(90,0,ORrw.Quant,M40Val,false);
            OutString(140,0,ORrw.Spec,false);
            EndFormat;
            StartFormat(15);
            OutString(11,0, ORrw.Source,false);
            OutDate(70,0, ORrw.PickingDate,false);
            OutString(130,0, ORrw.PickingTime,false);
            OutString(185,0, ORrw.Location,false);
            OutDate(240,0, ORrw.InloadingDate,false);
            OutString(300,0, ORrw.InloadingTime,false);
            if (nonblankdate(ORrw.DespatchRowDate)) then begin
              OutDate(350,0, ORrw.DespatchRowDate,false);
            end else begin
              OutDate(350,0, ORr.DespatchDate,false);
            end;
            OutString(420,0, ORrw.DespatchRowTime,false);
            EndFormat;
          end;
        end else begin
          if nonblank(RepSpec.f3) or nonblank(RepSpec.Stext) or nonblankdate(RepSpec.d2) or nonblankdate(RepSpec.RegDate) or nonblankdate(td2) then begin
            if ((nonblank(RepSpec.f3)) and (RepSpec.f3 <> ORrw.Source)) then begin
              locf = false;
            end;
            if ((nonblank(RepSpec.Stext)) and (RepSpec.Stext <> ORrw.Location)) then begin
              locf = false;
            end;
            if ((nonblankdate(RepSpec.d2)) and (RepSpec.d2 <> ORrw.PickingDate)) then begin
              locf = false;
            end;
            if ((nonblankdate(RepSpec.RegDate)) and (RepSpec.RegDate <> ORr.DespatchDate)) then begin
              locf = false;
            end;
            if ((nonblankdate(td2)) and (td2 <> ORrw.InloadingDate)) then begin
              locf = false;
            end;
            if (locf) then begin
              if (printheaderf) then begin
                PrintOrdHeader2 (ORr,footf);
                printheaderf = false;
              end;
              StartFormat(15);
              OutString(0,0, USetStr(2593) & ": " & ORrw.ArtCode & "      " &  USetStr(2504) & ": " & ORrw.Spec, false);
              EndFormat;
              StartFormat(15);
              OutString(0,0, USetStr(8612) & ": " & ORrw.Quant,false);
              EndFormat;
              StartFormat(15);
              OutString(0,0,USetStr(8613) & ": " & ORrw.Source,false);
              EndFormat;
              StartFormat(15);
              OutString(0,0,USetStr(8614) & ": " & ORrw. PickingDate & "      "  & USetStr(8615) & ": "& ORrw. PickingTime,false);
              EndFormat;
              StartFormat(15);
              OutString(0,0,USetStr(8616) & ": " & ORrw. Location,false);
              EndFormat;
              StartFormat(15);
              OutString(0,0,USetStr(8617) & ": " & ORrw. InloadingDate  & "      "  & USetStr(8618) &": " & ORrw. InloadingTime,false);
              EndFormat;
          //    if (ORrw.DespatchDate <> blank) then begin  // BS changed from "" to blank
                OutString(0,0,USetStr(8624) & ": " & ORrw. DespatchRowDate & "      " & USetStr(8625) & ": " & ORrw. DespatchRowTime,false);
          //    end else begin
          //      OutString(0,0,USetStr(8624) & ": " & ORr. DespatchDate & "      " & USetStr(8625) & ": " & ORrw. DespatchTime,false);
          //    end;
              StartFormat(15);
              EndFormat;
              StartFormat(15);
              OutString(0,0, "------------------------------------------------------------------",false);
              EndFormat;
            end;
          end else begin
            if (printheaderf) then begin
              PrintOrdHeader2 (ORr,footf);
              printheaderf = false;
            end;
            StartFormat(15);
            EndFormat;
            StartFormat(15);
            OutString(0,0, USetStr(2593) & ": " & ORrw.ArtCode & "      " &  USetStr(2504) & ": " & ORrw.Spec, false);
            EndFormat;
            StartFormat(15);
            OutString(0,0, USetStr(8612) & ": " & ORrw.Quant,false);
            EndFormat;
            StartFormat(15);
            OutString(0,0,USetStr(8613) & ": " & ORrw.Source,false);
            EndFormat;
            StartFormat(15);
            OutString(0,0,USetStr(8614) & ": " & ORrw. PickingDate & "     "  & USetStr(8615) & ": "& ORrw. PickingTime,false);
            EndFormat;
            StartFormat(15);
            OutString(0,0,USetStr(8616) & ": " & ORrw. Location,false);
            EndFormat;
            StartFormat(15);
            OutString(0,0,USetStr(8617) & ": " & ORrw. InloadingDate  & "     "  & USetStr(8618) &": " & ORrw. InloadingTime,false);
            EndFormat;
        //    if (ORrw.DespatchDate <> blank) then begin // BS changed from "" to blank
              OutString(0,0,USetStr(8624) & ": " & ORrw. DespatchRowDate & "     " & USetStr(8625) & ": " & ORrw. DespatchRowTime,false);
        //    end else begin
        //      OutString(0,0,USetStr(8624) & ": " & ORr. DespatchDate & "      " & USetStr(8625) & ": " & ORrw. DespatchTime,false);
       //     end;
            StartFormat(15);
            EndFormat;
            StartFormat(15);
            OutString(0,0, "------------------------------------------------------------------",false);
            EndFormat;
          end;
        end;  
        if ((printf) and (RepSpec.Media == 1)) then begin
          NewPage(false);
        end;
      end;
    end;
    if (footf) then begin
      StartFormat(15);
      if nonblank(ORr.Comment) then begin
        if (RepSpec.flags[3] <> 1) then begin
           OutString(0,0, USetStr( 2925),false);
           OutString(2,0, ORr.Comment,false);
        end else begin
          OutString(0,0, USetStr( 2925),false);
          EndFormat;
          OutString(2,0, ORr.Comment,false);
        end;
      end;
      EndFormat;
      if (RepSpec.flags[3] <> 1) then begin
        Black_Divider(0,1);
      end else begin
        OutString(0,0, "__________________________________________________________________",false);
        EndFormat;
      end;
/*
      StartFormat(15);
      EndFormat;
*/
    end;
  end;
  PrintItemCodeTotals(SMr);
  EndJob;
return;
end;

#endif
