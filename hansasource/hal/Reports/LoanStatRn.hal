external function roundmode SetRoundModeD(Integer);
external procedure GetAccTurnover(string,string,Date,Date,record ObjBalVc,string,Integer,Integer,Integer,var val,var val);
external function Boolean EobjInEobj(string,string);
external procedure GetAccStartBalance(string,string,Date,record ObjBalVc,Integer,Integer,string,Integer,var val);
external function Boolean GetObjBal(string,string,var record ObjBalVc);
external procedure HT2Per(Date, Date , var string);
external function Boolean GetCuAccUseRow(string,var row CuAccBlock);

global
function Boolean CalculateLoanInstallments(var record CuAccVc CuAccp,Integer type)
BEGIN
  row CuAccVc CuAccrw;
  record ObjBalVc ObjBalr;
  Integer i,rwcnt;
  Date sd;
  val CurBal,diff,instnr;
  Boolean res;
  LongInt lv;
  row CuAccBlock CuAccRec;
  val diff1,rv,t1,t2,t;
  record IRVc IRr;
  row IRVc IRrw;
  val p,interest,tmp;
  Integer ircnt;

  t1 = 1;
  instnr = CuAccp.InstNr;
  rwcnt = MatRowCnt(CuAccp);
  if (rwcnt==0) then begin goto LCalculateLoanInstallments; end;
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(CuAccp,i,CuAccrw);
    if (CuAccrw.InvNr==-1) then begin
      sd = CuAccrw.PlanDate;
      goto L11CalculateLoanInstallments;
    end;
  end;
L11CalculateLoanInstallments:;
  if (blankdate(sd)) then begin goto LCalculateLoanInstallments; end;
  if (GetObjBal(CuAccp.MainAcc,CuAccp.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccp.MainAcc,CuAccp.Objects,sd,ObjBalr,0,0,"",0,CurBal);
  end;
// if (M4ValZeroTest(&CurBal)) then goto LCalculateLoanInstallments; 
 if (GetCuAccUseRow(CuAccp.Objects,CuAccRec)) then begin end;
 if (GetObjBal(CuAccRec.ToRoyalty,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.ToRoyalty,CuAccp.Objects,sd,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end;
 if (GetObjBal(CuAccRec.FromRoyalty,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.FromRoyalty,CuAccp.Objects,sd,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end;  
 if (GetObjBal(CuAccRec.ToStock,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.ToStock,CuAccp.Objects,sd,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end;  
 if (GetObjBal(CuAccRec.Losses,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.Losses,CuAccp.Objects,sd,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end;  
 if (GetObjBal(CuAccRec.InstallmentAcc,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.InstallmentAcc,CuAccp.Objects,CurrentDate,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end; 
 if (GetObjBal(CuAccRec.TopayLoanAcc,CuAccp.Objects,ObjBalr)) then begin
   GetAccStartBalance(CuAccRec.TopayLoanAcc,CuAccp.Objects,CurrentDate,ObjBalr,0,0,"",0,diff);
   CurBal = CurBal + diff;
 end;  
 rv = blankval;
 if (type==0) then begin
   for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(CuAccp,i,CuAccrw);
      if (CuAccrw.InvNr!=-1) then begin       
        instnr = instnr - t1;
        t = StringToVal(CuAccrw.ValStr,M4Val);
        CurBal = CurBal - t;
      end else begin
        if (instnr!=0) then begin
          diff = CurBal/instnr;    
          t2 = Round(diff,SetRoundModeD(0));
          CuAccrw.ValStr = t2;          
          diff1 = StringToVal(CuAccrw.ValStr,M4Val);
          t2 = diff - diff1;
          rv = rv + t2;
          if (i==(rwcnt-1)) then begin
            diff = diff + rv;
            diff = diff - t2;
            CuAccrw.ValStr = diff;
          end;                            
          MatRowPut(CuAccp,i,CuAccrw);
          instnr = instnr - t1;
          CurBal = CurBal - diff;
          res = true;
        end else begin
          goto LCalculateLoanInstallments;
        end;
      end;
   end;
 end;
 if (type==1) then begin
   interest = 1;
   IRr.Code = CuAccp.IntCode;
   IRr.startDate = CuAccp.TransDate;
   if (ReadFirstMain(IRr,1,true)) then begin
      ircnt = MatRowCnt(IRr);     
      if (ircnt>0) then begin
        MatRowGet(IRr,0,IRrw);
        interest = IRrw.rate;
        interest = interest/100;
      end;  
   end;   
   tmp = interest + t1;
   p = tmp;
   ircnt = CuAccp.InstNr;
   for (i=1;i<ircnt;i=i+1) begin
     p = p*tmp;
   end;   
   p = t1/p;
   p = t1 - p;
   p = interest/p;
   p = CurBal*p;
   for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(CuAccp,i,CuAccrw);
      if (CuAccrw.InvNr!=-1) then begin
        instnr = instnr - t1;
        t = StringToVal(CuAccrw.ValStr,M4Val);
        CurBal = CurBal - t;
      end else begin
        if (instnr!=0) then begin
          tmp = CurBal*interest;   
          diff = p - tmp;                    
          CuAccrw.ValStr = diff;
          MatRowPut(CuAccp,i,CuAccrw);
          instnr = instnr - t1;
          CurBal = CurBal - diff;
          res = true;
        end else begin
          goto LCalculateLoanInstallments;
        end;
      end;
   end; 
 end; 
LCalculateLoanInstallments:;
  CalculateLoanInstallments = res;
  RETURN;
END;

// Add RegArchiveDetailVc to this report. I would have, if I knew it was used by anyone, but I don't think it is...
global
procedure LoanStatRn(record RcVc RepSpec)
BEGIN
  record CuAccVc CuAccr;
  record ObjBalVc ObjBalr;
  record TRVc TRr;
  record SMVc SMr;
  record FBVc FBr;
  record IRVc IRr;
  row FBVc FBrw;
  row TRVc TRrw;
  row CuAccVc CuAccrw;
  record MainVc mainr1,mainr2,mainr3,mainr4,mainr5,mainr6,mainr7;
  row CuAccBlock CuAccRec;
  Integer i,rwcnt;
  val total,paid,instl;
  Boolean TrHsCuAcc,TrHsInstAcc,firstloopf,tmpf;
  Date curDate,lastTRDate,curEndDate,cntDate,tmpDate;
  LongInt diy,totnrdays;
  val cuint,inter,totint,t,temp;
  Boolean TrHsToRoy,TrHsFromRoy,TrHsLosses,TrHsToStock,TrHsPaym;
  string 255 tstr,t2;
  Integer rw;
  Boolean prf;
  val cinstl;
  
  totnrdays = 0;
  firstloopf = true;
  CuAccr.Code = RepSpec.f1;
  if (ReadFirstMain(CuAccr,1,true)==false) then begin goto LLoanStatRn; end;
  if (GetCuAccUseRow(CuAccr.Objects,CuAccRec)) then begin end;
  if (CuAccRec.YearDays==0) then begin
    diy = 360; 
  end else begin
    diy = 365;
  end;
  StartReportJob(USetStr(8089));
   rw = 1;    
   HT2Per(RepSpec.sStartDate,RepSpec.sEndDate,tstr);
   Header(rw,tstr,1);
   rw = rw + 1;
   tstr = USetStr(8090);
   tstr = tstr & CuAccr.Code;
   Header(rw,tstr,0);    
   tstr = USetStr(8093);
   tstr = tstr & CuAccr.InstNr;
   Header(rw,tstr,1);
   rw = rw + 1;
   tstr = USetStr(8091);
   tstr = tstr & CuAccr.CUCode;
   Header(rw,tstr,0);    
   tstr = USetStr(8095);
   tstr = tstr & CuAccr.Limit;
   Header(rw,tstr,1);    
   rw = rw + 1;
   tstr = USetStr(8092);
   tstr = tstr & CuAccr.CUName;
   Header(rw,tstr,0);    
  EndHeader;
  if (nonblank(CuAccr.LoanStatus)) then begin
    StartFormat(15);
    OutString(0,0,CuAccr.LoanStatus,false);
    EndFormat;
  end;
  if (nonblank(CuAccr.LoanSuccess)) then begin
    StartFormat(15);
    OutString(0,0,CuAccr.LoanSuccess,false);
    EndFormat;
  end;
  if ((nonblank(CuAccr.LoanStatus)) or (nonblank(CuAccr.LoanSuccess))) then begin
    StartFormat(15);
    EndFormat;
  end;
  StartFormat(15);
   OutString(0,0,USetStr(8094),false);
   OutString(120,0,USetStr(8087),true);
   OutString(200,0,USetStr(8096),true);
   OutString(280,0,USetStr(8097),true);
   OutString(360,0,USetStr(8098),true);
   OutString(380,0,USetStr(8088),false);
   OutString(480,0,USetStr(8099),true);
  EndFormat;
  Gray_Divider(0,1);
  curDate = RepSpec.sStartDate;
  cntDate = curDate;
  tmpDate = cntDate;
  if (GetObjBal(CuAccr.MainAcc,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccr.MainAcc,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                       RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,total);
  end;
  if (GetObjBal(CuAccRec.TopayLoanAcc,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.TopayLoanAcc,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                       RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (GetObjBal(CuAccRec.InstallmentAcc,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.InstallmentAcc,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                     RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (GetObjBal(CuAccRec.Losses,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.Losses,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                       RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (GetObjBal(CuAccRec.ToStock,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.ToStock,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                     RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (GetObjBal(CuAccRec.ToRoyalty,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.ToRoyalty,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                     RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (GetObjBal(CuAccRec.FromRoyalty,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.FromRoyalty,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                     RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,instl);
    total = total + instl;                     
  end;
  if (total!=blankval) then begin
    StartFormat(15);
     OutDate(0,0,RepSpec.sStartDate,false);
     OutVal(120,0,total,M4Val,true);
     OutVal(360,0,total,M4Val,true);                        
    EndFormat;      
  end;    
  instl = blankval;
  mainr3.AccNumber = CuAccRec.ToRoyalty;
  mainr3.FileName = "";
  TrHsToRoy = true;
  mainr4.AccNumber = CuAccRec.FromRoyalty;
  mainr4.FileName = "";
  TrHsFromRoy = true;
  mainr5.AccNumber = CuAccRec.Losses;
  mainr5.FileName = "";
  TrHsLosses = true;
  mainr6.AccNumber = CuAccRec.ToStock;
  mainr6.FileName = "";
  TrHsToStock = true;
  mainr7.AccNumber = CuAccRec.TopayLoanAcc;
  mainr7.FileName = "";
  TrHsPaym = true;
  mainr2.AccNumber = CuAccRec.InstallmentAcc;
  mainr2.FileName = "";
  TrHsInstAcc = true;
  
  mainr1.AccNumber = CuAccr.MainAcc;
  TrHsCuAcc = true; 
while ((cntDate<=RepSpec.sEndDate) and (TrHsCuAcc or TrHsInstAcc or TrHsToRoy or TrHsFromRoy or TrHsLosses or TrHsToStock or TrHsPaym)) begin
  if (TrHsCuAcc) then begin
    mainr1.TransDate = cntDate;
    while (LoopMain(mainr1,2,TrHsCuAcc)) begin
      if (mainr1.AccNumber!=CuAccr.MainAcc) then begin TrHsCuAcc = false; end;
      if (TrHsCuAcc) then begin
        if (cntDate!=mainr1.TransDate) then begin//>
          if (firstloopf) then  begin
            tmpDate = mainr1.TransDate;
            tmpf = true;
          end;
          goto L11;
        end;
        if (mainr1.FileName=="TRVc") then begin
          TRr.Number = mainr1.TransNr;
          TRr.IntYc = mainr1.IntYc;
          if (ReadFirstMain(TRr,0,true)) then begin
            if (mainr1.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccr.MainAcc) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr1.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);                        
                         EndFormat;
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr1.FileName=="FBVc") then begin
          FBr.SerNr = mainr1.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr1.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccr.MainAcc) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr1.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L11:;    
    if (mainr1.TransDate>cntDate) then begin
      StepBack(mainr1);
    end;
  end;//TrHsCuAcc  
  if (TrHsToRoy) then begin
    mainr3.TransDate = cntDate;
    while (LoopMain(mainr3,2,TrHsToRoy)) begin
      if (mainr3.AccNumber!=CuAccRec.ToRoyalty) then begin TrHsToRoy = false; end;
      if (TrHsFromRoy) then begin
        if (cntDate!=mainr3.TransDate) then begin//>
          if (firstloopf) then  begin
   		    if ((mainr3.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr3.TransDate;
              tmpf = true;
            end;
          end;
          goto L13;
        end;
        if (mainr3.FileName=="TRVc") then begin
          TRr.Number = mainr3.TransNr;
          TRr.IntYc = mainr3.IntYc;
          if (ReadFirstMain(TRr,2,true)) then begin
            if (mainr3.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.ToRoyalty) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr3.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);   
                          OutString(380,0,USetStr(8083),false);                     
                         EndFormat;
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr3.FileName=="FBVc") then begin
          FBr.SerNr = mainr3.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr3.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccRec.ToRoyalty) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr3.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L13:;    
    if (mainr3.TransDate>cntDate) then begin
      StepBack(mainr3);
    end;
  end;//TrHsToRoy  
  if (TrHsFromRoy) then begin
    mainr4.TransDate = cntDate;
    while (LoopMain(mainr4,2,TrHsFromRoy)) begin
      if (mainr4.AccNumber!=CuAccRec.FromRoyalty) then begin TrHsFromRoy = false; end;
      if (TrHsToRoy) then begin
        if (cntDate!=mainr4.TransDate) then begin//>
          if (firstloopf) then  begin
   		    if ((mainr4.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr4.TransDate;
              tmpf = true;
            end;
          end;
          goto L14;
        end;
        if (mainr4.FileName=="TRVc") then begin
          TRr.Number = mainr4.TransNr;
          TRr.IntYc = mainr4.IntYc;
          if (ReadFirstMain(TRr,2,true)) then begin
            if (mainr4.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.FromRoyalty) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr4.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);                        
                          OutString(380,0,USetStr(8084),false);                     
                         EndFormat;                         
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr4.FileName=="FBVc") then begin
          FBr.SerNr = mainr4.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr4.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccRec.FromRoyalty) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr4.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L14:;    
    if (mainr4.TransDate>cntDate) then begin
      StepBack(mainr4);
    end;
  end;//TrHsFromRoy  
  if (TrHsLosses) then begin
    mainr5.TransDate = cntDate;
    while (LoopMain(mainr5,2,TrHsLosses)) begin
      if (mainr5.AccNumber!=CuAccRec.Losses) then begin TrHsLosses = false; end;
      if (TrHsLosses) then begin
        if (cntDate!=mainr5.TransDate) then begin//>
          if (firstloopf) then  begin
     	    if ((mainr5.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr5.TransDate;
              tmpf = true;
            end;
          end;
          goto L15;
        end;
        if (mainr5.FileName=="TRVc") then begin
          TRr.Number = mainr5.TransNr;
          TRr.IntYc = mainr5.IntYc;
          if (ReadFirstMain(TRr,2,true)) then begin
            if (mainr5.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.Losses) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr5.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);                        
                          OutString(380,0,USetStr(8085),false);                     
                         EndFormat;
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr5.FileName=="FBVc") then begin
          FBr.SerNr = mainr5.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr5.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccRec.Losses) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr5.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L15:;    
    if (mainr5.TransDate>cntDate) then begin
      StepBack(mainr5);
    end;
  end;//TrHsLosses  
  if (TrHsToStock) then begin
    mainr6.TransDate = cntDate;
    while (LoopMain(mainr6,2,TrHsToStock)) begin
      if (mainr6.AccNumber==CuAccRec.ToStock) then begin TrHsToStock = false; end;
      if (TrHsToStock) then begin
        if (cntDate!=mainr6.TransDate) then begin//>
          if (firstloopf) then  begin
   		    if ((mainr6.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr6.TransDate;
              tmpf = true;
            end;
          end;
          goto L16;
        end;
        if (mainr6.FileName=="TRVc") then begin
          TRr.Number = mainr6.TransNr;
          TRr.IntYc = mainr6.IntYc;
          if (ReadFirstMain(TRr,2,true)) then begin
            if (mainr6.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.ToStock) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr6.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);                        
                          OutString(380,0,USetStr(8086),false);                     
                         EndFormat;
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr6.FileName=="FBVc") then begin
          FBr.SerNr = mainr6.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr6.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccRec.ToStock) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr6.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L16:;    
    if (mainr6.TransDate>cntDate) then begin
      StepBack(mainr6);
    end;
  end;//TrHsToStock    
  if (TrHsPaym) then begin
    mainr7.TransDate = cntDate;
    while (LoopMain(mainr7,2,TrHsPaym)) begin
      if (mainr7.AccNumber!=CuAccRec.TopayLoanAcc) then begin TrHsPaym = false; end;
      if (TrHsPaym) then begin
        if (cntDate!=mainr7.TransDate) then begin//>
          if (firstloopf) then  begin
   		    if ((mainr7.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr7.TransDate;
              tmpf = true;
            end;
          end;
          goto L17;
        end;
        if (mainr7.FileName=="TRVc") then begin
          TRr.Number = mainr7.TransNr;
          TRr.IntYc = mainr7.IntYc;
          if (ReadFirstMain(TRr,2,true)) then begin
            if (mainr7.TransDate==TRr.TransDate) then begin
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.TopayLoanAcc) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         paid = paid + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         curDate = mainr7.TransDate;
                         StartFormat(15);
                          OutDate(0,0,TRr.TransDate,false);
                          if (TRrw.DebVal!=0) then begin
                            OutVal(200,0,TRrw.DebVal,M4Val,true);
                          end;
                          if (TRrw.CredVal!=0) then begin
                            OutVal(280,0,TRrw.CredVal,M4Val,true);
                          end;
                          OutVal(360,0,total,M4Val,true);                        
                          OutString(380,0,USetStr(8082),false);                     
                         EndFormat;
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
        end;
        if (mainr7.FileName=="FBVc") then begin
          FBr.SerNr = mainr7.TransNr;
          if (ReadFirstMain(FBr,0,true)) then begin
            if (mainr7.TransDate==FBr.TransDate) then begin
              if (EobjInEobj(CuAccr.Objects,FBr.Objects)) then begin
                rwcnt = MatRowCnt(FBr);
                for (i=0;i<rwcnt;i=i+1) begin
                  MatRowGet(FBr,i,FBrw);
                  if (FBrw.AccNumber==CuAccRec.TopayLoanAcc) then begin
                    total = total + FBrw.DebVal;
                    total = total - FBrw.CredVal;
                    curDate = mainr7.TransDate;
                    StartFormat(15);
                     OutDate(0,0,FBr.TransDate,false);
                     if (FBrw.DebVal!=0) then begin
                       OutVal(120,0,FBrw.DebVal,M4Val,true);                        
                     end;
                     if (FBrw.CredVal!=0) then begin
                       OutVal(120,0,FBrw.CredVal,M4NegVal,true);                        
                     end;
                     OutVal(360,0,total,M4Val,true);                        
                    EndFormat;
                  end;
                end;
              end;
            end;
          end;
        end;//fbvc
      end;
    end;//while
L17:;    
    if (mainr7.TransDate>cntDate) then begin
      StepBack(mainr7);
    end;
  end;//TrHsPaym  
  cuint = blankval;
  inter = blankval;
  curEndDate = curDate;
  lastTRDate = curEndDate;
  if (TrHsInstAcc) then begin
    mainr2.TransDate = cntDate;
    while (LoopMain(mainr2,2,TrHsInstAcc)) begin
      if (mainr2.AccNumber!=CuAccRec.InstallmentAcc) then begin TrHsInstAcc = false; end;
      if (TrHsInstAcc) then begin
        if (cntDate!=mainr2.TransDate) then begin//>
          if (firstloopf) then begin
            if ((mainr2.TransDate<tmpDate) or (tmpf==false)) then begin
              tmpDate = mainr2.TransDate;
              tmpf = true;
            end;
            goto L12;
          end;
        end;
        if (mainr2.FileName=="TRVc") then begin
          TRr.Number = mainr2.TransNr;
          TRr.IntYc = mainr2.IntYc;
          if (ReadFirstMain(TRr,0,true)) then begin
            if (mainr2.TransDate==TRr.TransDate) then begin
               inter = blankval;
               cinstl = blankval;
               rwcnt = MatRowCnt(TRr);
               for (i=0;i<rwcnt;i=i+1) begin
                 MatRowGet(TRr,i,TRrw);
                 if (TRrw.stp==1) then begin
                   if (TRrw.ovst==0) then begin
                     if (TRrw.AccNumber==CuAccRec.InterestAcc) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         inter = inter + TRrw.CredVal;
                         totint = totint + TRrw.CredVal;
                         prf = true;
                       end;  
                     end;
                     if (TRrw.AccNumber==CuAccRec.InstallmentAcc) then begin
                       if (EobjInEobj(CuAccr.Objects,TRrw.Objects)) then begin
                         cinstl = cinstl - TRrw.CredVal;
                         cinstl = cinstl + TRrw.DebVal;
                         instl = instl + TRrw.CredVal;
                         total = total + TRrw.DebVal;
                         total = total - TRrw.CredVal;
                         prf = true;            
                       end;
                     end;
                   end;
                 end;
               end;//for
            end;
          end;
          if (prf) then begin
            StartFormat(15);
            OutDate(0,0,TRr.TransDate,false);
            if (cinstl>0) then begin 
              OutVal(200,0,cinstl,M4Val,true);                        
            end else begin
              t = -cinstl;
              OutVal(280,0,t,M4Val,true);                        
            end;
            OutVal(360,0,total,M4Val,true);                        
            tstr = USetStr(8093);
            OutVal(480,0,inter,M4Val,true);
            EndFormat;          
          end;        end;  
      end;//trHsinstacc
    end;  //while
L12:;    
    if (mainr2.TransDate>cntDate) then begin
      StepBack(mainr2);
    end;
  end;//trHsinstacc
  t = blankval;
  cuint = blankval;
  if (GetObjBal(CuAccRec.InterestAcc,CuAccr.Objects,ObjBalr)) then begin
    GetAccStartBalance(CuAccRec.InterestAcc,CuAccr.Objects,RepSpec.sStartDate,ObjBalr,RepSpec.SimVerf,
                       RepSpec.basecurncy,RepSpec.CurncyCode,RepSpec.IncDaughter,t);
    t = -t;
    GetAccTurnover(CuAccRec.InterestAcc,CuAccr.Objects,RepSpec.sStartDate,RepSpec.sEndDate,ObjBalr,RepSpec.CurncyCode,RepSpec.SimVerf,RepSpec.basecurncy,RepSpec.IncDaughter,temp,cuint);
    cuint = -cuint;
  end;
  if (firstloopf) then begin
     if (blankdate(tmpDate)) then begin 
       tmpDate = cntDate;
     end;
     cntDate = AddDay(tmpDate,-1);
     firstloopf = false;
  end;
  cntDate = AddDay(cntDate,1);
end;      
  Gray_Divider(0,1);
  StartFormat(15);
   OutVal(200,0,paid,M4Val,true);                        
   OutVal(280,0,instl,M4Val,true);                        
   OutVal(360,0,total,M4Val,true);                        
//    OpM42(380,0,&totnrdays,M4Long,true);                        
   OutVal(480,0,totint,M4Val,true);
  EndFormat;
  StartFormat(15);
   cuint = cuint - totint;
   cuint = cuint + t;
   OutString(200,0,USetStr(8099),false);
   OutVal(480,0,cuint,M4Val,true);
  EndFormat;   
  StartFormat(15);
   t = cuint + totint;
   OutString(200,0,USetStr(8080),false);
   OutVal(480,0,t,M4Val,true);
  EndFormat; 
 if (CalculateLoanInstallments(CuAccr,0)) then begin
    rwcnt = MatRowCnt(CuAccr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(CuAccr,i,CuAccrw);
      if (CuAccrw.InvNr!=-1) then begin
        t = StringToVal(CuAccrw.ValStr,M4Val);
        total = total + t;
      end;
    end;    
    StartFormat(15);    
     OutString(200,0,USetStr(5011),false);
     OutVal(360,0,total,M4Val,true);
     t = rwcnt;
     OutVal(420,0,t,M4Val,true);                        
     total = total/t;
     OutVal(480,0,total,M4Val,true);                        
    EndFormat;      
  end;
  EndJob;  
LLoanStatRn:;
  RETURN;
END;