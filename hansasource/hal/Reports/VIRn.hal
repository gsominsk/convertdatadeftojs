procedure VIFormat(record VIVc VIr)
BEGIN  
  record AccVc Accr;
  row VIVc VIrw;
  Boolean Accs;
  string 255 temp;
  Integer i,rwcnt;

  rwcnt = MatRowCnt(VIr);
    StartFormat(15);
    EndFormat;
    StartFormat(15);
    OutStringOvst(400,0,USetStr(3041),true,VIr.Invalid);
    OutLongIntOvst(1,"DblVIVc",VIr.SerNr,true,VIr.Invalid);
    EndFormat;
    StartFormat(15);
    OutStringOvst(0,0,VIr.VECode,false,VIr.Invalid);
    OutStringOvst(80,0,VIr.VEName,false,VIr.Invalid);
    OutStringOvst(400,0,USetStr(3043),true,VIr.Invalid);
    OutDateOvst(1,0,VIr.InvDate,true,VIr.Invalid);
    EndFormat;
    StartFormat(15);
    OutStringOvst(0,0,USetStr(3044),false,VIr.Invalid);
    OutStringOvst(80,0,VIr.OKPersons,false,VIr.Invalid);
    OutStringOvst(400,0,USetStr(3045),true,VIr.Invalid);
    OutDateOvst(1,0,VIr.TransDate,true,VIr.Invalid);
    EndFormat;
    StartFormat(15);
    OutStringOvst(0,0,USetStr(3057),false,VIr.Invalid);
    OutStringOvst(80,0,VIr.RefStr,false,VIr.Invalid);
    OutStringOvst(400,0,USetStr(3060),true,VIr.Invalid);
    OutStringOvst(1,0,VIr.PayDeal,true,VIr.Invalid);
    EndFormat;
    StartFormat(15);
    OutStringOvst(0,0,USetStr(3059),false,VIr.Invalid);
    OutStringOvst(80,0,VIr.InvoiceNr,false,VIr.Invalid);
    EndFormat;
    StartFormat(60);
    EndFormat;
    StartFormat(15);
    OutStringOvst(20,0,USetStr(3046),false,VIr.Invalid);
    OutStringOvst(60,0,USetStr(3047),false,VIr.Invalid);
    OutStringOvst(160,0,USetStr(3048),false,VIr.Invalid);
    OutStringOvst(380,0,USetStr(3049),true,VIr.Invalid);
    OutStringOvst(460,0,USetStr(3050),true,VIr.Invalid);
    EndFormat;
    StartFormat(2);
    EndFormat;
    for (i = 0 ; i<rwcnt ;i=i+1) begin
      MatRowGet(VIr,i,VIrw);
      if (VIrw.stp==1) then begin
        Accr.AccNumber = VIrw.AccNumber;
        Accs = ReadFirstKey("AccNumber",Accr,1,true);
        StartFormat(15);
        temp = "";
        if (nonblank(VIrw.Comment)) then begin
            temp = VIrw.Comment;
        end else begin
          if (Accs) then begin
            temp = Accr.Comment;
          end;    
        end; 
        if (VIrw.ovst<>0) then begin
          OutStringOvst(0,0,"O",false,VIr.Invalid);
        end;
        OutStringOvst(20,0,VIrw.AccNumber,false,VIr.Invalid);//VIrw.ovst
        OutStringOvst(60,0,VIrw.Objects,false,VIr.Invalid);//VIrw.ovst
        OutStringOvst(160,0,temp,false,VIr.Invalid);//VIrw.ovst
        if (VIr.InvType<>kInvoiceTypeCredit and VIr.InvType!=kInvoiceTypeCreditSpecialSales) then begin
          if (VIrw.Sum < 0) then begin  
            VIrw.Sum = -VIrw.Sum;
            OutValOvst(460,0,VIrw.Sum,M4Val,true,VIr.Invalid);//VIrw.ovst
          end else begin
            OutValOvst(380,0,VIrw.Sum,M4Val,true,VIr.Invalid);//VIrw.ovst
          end;    
        end;
        if (VIr.InvType==kInvoiceTypeCredit or VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin
          if (VIrw.Sum > 0) then begin  
             OutValOvst(460,0,VIrw.Sum,M4Val,true,VIr.Invalid);//VIrw.ovst
          end else begin
            VIrw.Sum = -VIrw.Sum;
           OutValOvst(380,0,VIrw.Sum,M4Val,true,VIr.Invalid);//VIrw.ovst
          end;    
        end;
        OutStringOvst(1,0,VIrw.VATCode,true,VIr.Invalid);
//TaxTemplateCode        
        EndFormat;
      end;
    end; 
    StartFormat(30);
    EndFormat;
    StartFormat(15);
    OutStringOvst(160,0,USetStr(3058),false,VIr.Invalid);
    if (VIr.InvType==kInvoiceTypeCredit or VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin
      OutValOvst(380,0,VIr.PayVal,M4Val,true,VIr.Invalid);
    end else begin
      OutValOvst(460,0,VIr.PayVal,M4Val,true,VIr.Invalid);
    end;
    EndFormat;
  RETURN;
END;

global
procedure VIRn(record RcVc RepSpec)
BEGIN
  record VIVc VIr;
  Boolean TrHs;
  LongInt afr,ato;
  Boolean testf;
//  Integer MediaPrinter;

/*
  MediaPrinter = 1;
  if ((RepSpec.Media<>MediaPrinter)) then begin
//    Error0(1048);
    goto L99;
  end;
  if (RepSpec.Media==MediaPrinter) then begin
*/
    afr = FirstInRange(RepSpec.f1,20);
    ato = LastInRange(RepSpec.f1,20);
    StartReportJob(USetStr(4161));     
    EndHeader;
    VIr.SerNr = afr;
    TrHs = true;
    while (LoopMain(VIr,1,TrHs)) begin
      if ((VIr.SerNr<=ato) or (ato==-1)) then begin
        testf = true;
        if (RepSpec.OnlyUnprntd==0) then begin
          if (VIr.OKFlag<>0) then begin testf = false; end;
        end;  
//        if (VIr.Invalid<>0) then begin testf = false; end;// they want to be able to print invalidated
        if (testf) then begin
          VIFormat(VIr);
          NewPage(false);
        end;
      end else begin
        TrHs = false;
      end;
    end;
    EndJob;
//  end;
L99:;
  RETURN;
END;
