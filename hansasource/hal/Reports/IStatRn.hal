external procedure HT2Per(Date, Date , var string);
external procedure HTCusts(string,string,var string);
external procedure HTOKF(Integer,Integer, var string);
external procedure OutLineText(string);
external procedure OutLine (string,string,val,val,val);
external function boolean FindItemSt(string,string,var val,var val,var val,date,date);
external function boolean FindItemStSlow(record RcVc,string,string,var val,var val,var val); 
external function Boolean SetInSet2(string,string);
 

procedure HTSaleMan1(string a,string b,var string res)
begin
  if (blank(a) and blank(b)) then begin
    res = USetStr(4918);
  end else begin
    res = USetStr(8314);
    res = res & " " & a;
    if (a!=b) then begin
      res = res & " : " & b;
    end;
  end;
  return;
end;
           
global
procedure IStatRn(record RcVc RepSpec)
BEGIN
  val totval,totqty,totgp;
  val totvalsum,totqtysum,totgpsum,totigvalsum,totigqtysum,totiggpsum;
  LongInt friv,toiv;
  string 20 fromus,tous,fromcust,tocust;
  string 20 fromit,toit,frig,toig;
  string 255 tstr;
  integer rw;
  record UserVc USr;
  record INVc INr;
  record ITVc ITr;
  Boolean found,found1,found2,testf1,TrHs,testf3,testf4;
  integer em;
  Boolean testf,testf2,testf5;
  Boolean item1,itemgroup,rtype;
  Boolean userprntdf;
  date cntdate;
  
  rtype = false;
  
  fromus = FirstInRange(RepSpec.f1,5);
  tous = LastInRange(RepSpec.f1,5);
  
  fromit = FirstInRange(RepSpec.f2,20);
  toit = LastInRange(RepSpec.f2,20);
  
  friv = FirstInRange(RepSpec.f3,20);
  toiv = LastInRange(RepSpec.f3,20);
  
  frig = FirstInRange(RepSpec.Stext,20);
  toig = LastInRange(RepSpec.Stext,20);
  
  fromcust = FirstInRange(RepSpec.ObjStr,20);
  tocust = LastInRange(RepSpec.ObjStr,20);
  
  if (nonblank(RepSpec.ObjStr)) then begin
    rtype = true;
  end;   
  
  StartReportJob(USetStr(2460));
    rw = 1;
    HT2Per(RepSpec.sStartDate,RepSpec.sEndDate,tstr);
    Header(rw,tstr,1);
    rw = rw + 1;
    HTCusts(fromcust,tocust,tstr);
    Header(rw,tstr,1);
    rw = rw + 1;
    HTSaleMan1(fromus,tous,tstr);
    if (nonblank(tstr)) then begin
      Header(rw,tstr,1);
      rw = rw + 1;
    end;  
    if (RepSpec.flags[3]==0) then begin
      tstr = USetStr(8554);
    end else begin
      tstr = USetStr(8555);
    end;
    Header(rw,tstr,0);
    if (nonblank(RepSpec.f3)) then begin
      rtype = true; 
      tstr = USetStr(1112);
      tstr = tstr & friv;
      if (friv!=toiv) then begin
        tstr = tstr & " : " & toiv;
      end;
    end else begin
      tstr = USetStr(1111);
    end;
    Header(rw,tstr,1);
    rw = rw + 1;
    if nonblank(RepSpec.Stext) then begin
      tstr = USetStr(1135);
      tstr = tstr & RepSpec.Stext;
      Header(rw,tstr,1);
      rw = rw + 1;
    end;
    if nonblank(RepSpec.LastAcc) then begin
      rtype = true;
      tstr = USetStr(1114);
      tstr = tstr & RepSpec.LastAcc;
      Header(rw,tstr,1);
      rw = rw + 1;
    end;
  EndHeader;
  if (RepSpec.wholemonthf==0) then begin
    StartFormat(15);
    OutString(0,0,USetStr(1163),false);
    EndFormat;
    goto LIStatRn;
  end;  
  SetRepCol(2,70);
  SetRepCol(3,20);
  SetRepCol(4,80);
  SetRepCol(5,40);
  SetRepCol(6,100);
  SetRepCol(7,300);
  SetRepCol(8,400);
  SetRepCol(9,480);
  if (RepSpec.flags[3]==0) then begin  
    if (tous!=fromus or blank(RepSpec.f1)) then begin  
      OutLineText(USetStr(4908));
    end else begin  
      OutLineText(USetStr(2325));
    end;  
    if (nonblank(RepSpec.Stext)) then begin
      // PER GROUP
      TrHs = true;
      ITr.Code = frig;
      itemgroup = false;
      ResetLoop(ITr);
      while (LoopMain(ITr,1,TrHs)) begin
        testf3 = true;
        if (toig<ITr.Code) then begin testf3 = false; end;
        if (testf3) then begin
          found = true;
          INr.Code = fromit;
          INr.Group = ITr.Code;
          ResetLoop(INr);
          itemgroup = true;
          item1 = false;
          while (LoopMain(INr,2,found)) begin
            testf4 = true;
            if (INr.Group!=ITr.Code) then begin testf4 = false; end;
            if (nonblank(RepSpec.f2)) then begin
              if (INr.Code>toit) then begin testf4 = false; end;
            end;
            if (nonblank(RepSpec.f4)) then begin
              if (SetInSet2(RepSpec.f4,INr.DispGroups)==false) then begin
                testf4 = false;
              end;
            end;
            if (testf4) then begin
              totval = 0;
              totqty = 0;
              totgp = 0;
              item1 = true;
              found2 = true;
              ResetLoop(USr);
              USr.Code = fromus;
              while (LoopMain(USr,1,found2)) begin
                testf1 = true;
                if (blank(USr.Code)) then begin testf1 = false; end;
                if (nonblank(RepSpec.f1)) then begin
                  if (USr.Code>tous) then begin
                    testf1 = false;
                  end;
                end; 
                if (testf1) then begin
                  found1 = false;
                  if (rtype) then begin
                    found1 = FindItemStSlow(RepSpec,USr.Code,INr.Code,totval,totqty,totgp); 
                  end else begin
                    found1 = FindItemSt(USr.Code,INr.Code,totval,totqty,totgp,RepSpec.sStartDate,RepSpec.sEndDate);
                  end;  
                  if (found1) then begin
                    // GROUP OUPUT
                    if (itemgroup) then begin
                      StartFormat(15);
                      OutString(0,0,ITr.Code,false);
                      OutString(2,0,ITr.Comment,false);
                      EndFormat;
                      Black_Divider(0,1);
                      itemgroup = false;
                    end;
                    if (item1) then begin
                      if (tous!=fromus or blank(RepSpec.f1)) then begin
                        Black_Divider(0,1);
                        StartFormat(15);
                        OutString(3,0,INr.Code,false);
                        OutString(4,0,INr.Name,false);
                        EndFormat;
                      end;  
                      item1 = false;
                    end;  
                    // SALESMAN OUTPUT WITH VALUES
                    if (tous!=fromus or blank(RepSpec.f1)) then begin
                      OutLine(USr.Code,USr.Name,totqty,totval,totgp);
                    end else begin
                      OutLine(INr.Code,INr.Name,totqty,totval,totgp);
                    end;   
                    totvalsum = totvalsum + totval;
                    totqtysum = totqtysum + totqty;
                    totgpsum = totgpsum + totgp;
                    totigvalsum = totigvalsum + totval;
                    totigqtysum = totigqtysum + totqty;
                    totiggpsum = totiggpsum + totgp; 
                  end;                    
                end;                   
              end;  
            end;
            if (tous!=fromus or blank(RepSpec.f1)) then begin
              if (totigvalsum!=0 and totigqtysum!=0 and totiggpsum!=0) then begin
                Black_Divider(0,1);
                OutLine(USetStr(2357),INr.Name,totigqtysum,totigvalsum,totiggpsum);
                totigvalsum = 0;
                totigqtysum = 0;
                totiggpsum = 0;
                StartFormat(15);
                EndFormat;
              end;   
            end;  
          end;  
        end; 
        if (totvalsum!=0 and totqtysum!=0 and totgpsum!=0) then begin
          Black_Divider(0,1);
          OutLine(USetStr(8553),ITr.Comment,totqtysum,totvalsum,totgpsum);
          totvalsum = 0;
          totqtysum = 0;
          totgpsum = 0;
          StartFormat(15);
          EndFormat;
        end;
      end;
    end;
    // PER ITEM
    if (blank(RepSpec.Stext)) then begin
      found = true;
      INr.Code = fromit;
      ResetLoop(INr);
      item1 = false;
      while (LoopMain(INr,1,found)) begin
        testf4 = true;          
        if (nonblank(RepSpec.f2)) then begin
           if (INr.Code>toit) then begin testf4 = false; end;
        end; 
        if (nonblank(RepSpec.f4)) then begin
          if (SetInSet2(RepSpec.f4,INr.DispGroups)==false) then begin
            testf4 = false;
          end;
        end;     
        if (testf4) then begin
          item1 = true;
          found2 = true;
          ResetLoop(USr);
          USr.Code = fromus;
          while (LoopMain(USr,1,found2)) begin  
            testf1 = true;
            if (nonblank(RepSpec.f1)) then begin
              if (USr.Code>tous) then begin
                testf1 = false;
                found2 = false;
              end;
            end;
            if blank(USr.Code) then begin testf1 = false; end;
            if (testf1) then begin
              found1 = false; 
              if (rtype) then begin  
                found1 = FindItemStSlow(RepSpec,USr.Code,INr.Code,totval,totqty,totgp); 
              end else begin
                found1 = FindItemSt(USr.Code,INr.Code,totval,totqty,totgp,RepSpec.sStartDate,RepSpec.sEndDate);
              end;
              if (found1) then begin 
                if (item1) then begin
                  // ITEM INPUT
                  if (tous!=fromus or blank(RepSpec.f1)) then begin
                    StartFormat(15);
                    OutString(0,0,INr.Code,false);
                    OutString(2,0,INr.Name,false);
                    EndFormat;
                  end;  
                  item1 = false;
                end;  
                if (tous!=fromus or blank(RepSpec.f1)) then begin   
                  OutLine(USr.Code,USr.Name,totqty,totval,totgp);
                end else begin
                  OutLine(INr.Code,INr.Name,totqty,totval,totgp);  
                end;  
                totvalsum = totvalsum + totval;
                totqtysum = totqtysum + totqty;
                totgpsum = totgpsum + totgp;
              end; 
            end;  
          end;
          if (tous!=fromus or blank(RepSpec.f1)) then begin  
            if (totqtysum!=0 and totvalsum!=0 and totgpsum!=0) then begin
              Black_Divider(0,1);
              OutLine(USetStr(2357),INr.Name,totqtysum,totvalsum,totgpsum);
              StartFormat(15);
              EndFormat;
              totqtysum = 0;
              totvalsum = 0;
              totgpsum = 0;
            end;
          end;  
        end;
      end; 
      if (totvalsum!=0 and totqtysum!=0 and totgpsum!=0) then begin
        Black_Divider(0,1);
        OutLine(USetStr(8553),ITr.Comment,totqtysum,totvalsum,totgpsum);
        totvalsum = 0;
        totqtysum = 0;
        totgpsum = 0;
        StartFormat(15);
        EndFormat;
      end;  
    end;    
  end;
  //SALESMAN \ ITEM
  if (RepSpec.flags[3]==1) then begin
    if (tous!=fromus or blank(RepSpec.f1)) then begin  
      OutLineText(USetStr(4908));
    end else begin  
      OutLineText(USetStr(2325));
    end;
    ResetLoop(USr);
    found = true;
    USr.Code = fromus;
    while (LoopMain(USr,1,found)) begin
      testf = true;
      if (nonblank(tous)) then begin
        if (tous<USr.Code) then begin
          testf = false;
          found = false;
        end;
      end;
      if blank(USr.Code) then begin testf = false; end;
      if (testf) then begin
        userprntdf = false;
        itemgroup = false;
        if (nonblank(RepSpec.Stext)) then begin
          ITr.Code = frig;
          ResetLoop(ITr);
          TrHs = true;
          item1 = false;
          while (LoopMain(ITr,1,TrHs)) begin
            testf5 = true;
            itemgroup = true;
            if (ITr.Code>toig) then begin
              testf5 = false;
              TrHs = false;
            end;            
            if (testf5) then begin
              found2 = true;
              ResetLoop(INr);
              INr.Code = fromit;
              while (LoopMain(INr,1,found2)) begin
                testf2 = true;
                if (nonblank(toit)) then begin
                  if (toit<INr.Code) then begin
                    testf2 = false;
                  end;
                end;
                if (INr.Group!=ITr.Code) then begin
                  testf2 = false;
                end;
                if (nonblank(RepSpec.f4)) then begin
                  if (SetInSet2(RepSpec.f4,INr.DispGroups)==false) then begin
                    testf2 = false;
                  end;
                end;
                if (testf2) then begin
                  found1 = false;
                  if (rtype) then begin
                    found1 = FindItemStSlow(RepSpec,USr.Code,INr.Code,totval,totqty,totgp); 
                  end else begin
                    found1 = FindItemSt(USr.Code,INr.Code,totval,totqty,totgp,RepSpec.sStartDate,RepSpec.sEndDate);
                  end; 
                  if (found1) then begin
                    if (userprntdf==false) then begin
                      StartFormat(15);
                      OutString(0,0,USr.Code,false);
                      OutString(2,0,USr.Name,false);
                      EndFormat;
                      Black_Divider(0,1);
                      userprntdf = true;
                    end;
                    // GROUP OUPUT
                    if (itemgroup) then begin
                      StartFormat(15);
                      OutString(0,0,ITr.Code,false);
                      OutString(2,0,ITr.Comment,false);
                      EndFormat;
                      itemgroup = false;
                    end;
                    if (item1) then begin
                      if (tous!=fromus or blank(RepSpec.f1)) then begin
                        Black_divider(0,1);
                        StartFormat(15);
                        OutString(3,0,USr.Code,false);
                        OutString(4,0,USr.Name,false);
                        EndFormat;
                      end;  
                      item1 = false;
                    end;  
                    OutLine(INr.Code,INr.Name,totqty,totval,totgp);
                    totvalsum = totvalsum + totval;
                    totqtysum = totqtysum + totqty;
                    totgpsum = totgpsum + totgp;
                    totigvalsum = totigvalsum + totval;
                    totigqtysum = totigqtysum + totqty;
                    totiggpsum = totiggpsum + totgp; 
                  end;   //found1                 
                end; //testf2                   
              end;  //while INr
            end;//testf5
            
            if (tous!=fromus or blank(RepSpec.f1)) then begin
              if (totigvalsum!=0 and totigqtysum!=0 and totiggpsum!=0) then begin
                Black_Divider(0,1);
                OutLine(USetStr(2357),ITr.Comment,totigqtysum,totigvalsum,totiggpsum);
                totigvalsum = 0;
                totigqtysum = 0;
                totiggpsum = 0;
                StartFormat(15);
                EndFormat;
              end;   
            end;  
          end; // while ITr
          if (totvalsum!=0 and totqtysum!=0 and totgpsum!=0) then begin
            Black_Divider(0,1);
            OutLine(USetStr(8553),USr.Name,totqtysum,totvalsum,totgpsum);
            totvalsum = 0;
            totqtysum = 0;
            totgpsum = 0;
            StartFormat(15);
            EndFormat;
          end; 
        end;   //Stext
        if (blank(RepSpec.Stext)) then begin
          found = true;
          ResetLoop(INr);
          item1 = true;
          found2 = true;
          INr.Code = fromit;
          while (LoopMain(INr,1,found2)) begin  
            testf1 = true;
            if (nonblank(RepSpec.f2)) then begin
              if (INr.Code>toit) then begin
                testf1 = false;
                found2 = false;
              end;
            end;
            if (nonblank(RepSpec.f4)) then begin
              if (SetInSet2(RepSpec.f4,INr.DispGroups)==false) then begin
                testf1 = false;
              end;
            end;
            if (testf1) then begin
              found1 = false; 
              if (rtype) then begin
                found1 = FindItemStSlow(RepSpec,USr.Code,INr.Code,totval,totqty,totgp); 
              end else begin
                found1 = FindItemSt(USr.Code,INr.Code,totval,totqty,totgp,RepSpec.sStartDate,RepSpec.sEndDate);
              end;
              if (found1) then begin 
                totvalsum = totvalsum + totval;
                totqtysum = totqtysum + totqty;
                totgpsum = totgpsum + totgp;
                if (userprntdf==false) then begin
                  StartFormat(15);
                  OutString(0,0,USr.Code,false);
                  OutString(2,0,USr.Name,false);
                  EndFormat;
                  Black_Divider(0,1);
                  userprntdf = true;
                end;
                if (tous!=fromus or blank(RepSpec.f1)) then begin   
                  OutLine(INr.Code,INr.Name,totqty,totval,totgp);
                end else begin
                  OutLine(INr.Code,INr.Name,totqty,totval,totgp);  
                end;  
              end;  
            end; 
          end;  
          if (totvalsum!=0 and totqtysum!=0 and totgpsum!=0) then begin
            Black_Divider(0,1);
            OutLine(USetStr(8553),USr.Name,totqtysum,totvalsum,totgpsum);
            totvalsum = 0;
            totqtysum = 0;
            totgpsum = 0;
            StartFormat(15);
            EndFormat;
          end;
        end;
      end;
    end;
  end;
LIStatRn:;
  EndJob;
  return;
END;  
