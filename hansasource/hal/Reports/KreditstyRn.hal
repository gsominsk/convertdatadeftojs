external function LongInt DateDiff(Date,Date);
external procedure M4PadString(string,Integer,string,Boolean,var string);

procedure KreditstyRepIV(record IVVc IVp,record ARVc ARp,Integer bnr)
BEGIN
  row IVVc IVrw;
  Integer i,rwcnt;
  
  StartFormat(15);
   OutString(0,0,IVp.CustCode,false);
   OutString(60,0,IVp.SerNr,false);
   OutString(120,0,IVp.Phone,false);
   OutString(200,0,IVp.VATNr,false);
   OutDate(250,0,IVp.InvDate,false);
   OutDate(310,0,ARp.DueDate,false);
   OutString(390,0,IVp.CurncyCode,false);
   OutVal(480,0,ARp.RVal,M4Val,true);
  EndFormat;
  StartFormat(15);
   OutString(11,0,IVp.Addr0,false);
  EndFormat;
  StartFormat(15);
   OutString(11,0,IVp.Addr1,false);
  EndFormat;
  StartFormat(15);
   OutString(11,0,IVp.Addr2,false);
  EndFormat;
  StartFormat(15);
   OutString(11,0,IVp.Addr3,false);
  EndFormat;
  StartFormat(15);
   OutString(11,0,IVp.OurContact,false);
  EndFormat;
  Gray_Divider(0,200);
  rwcnt = MatRowCnt(IVp);
  for (i=0;i<rwcnt;i=i+1) begin
    MatRowGet(IVp,i,IVrw);
    StartFormat(15);
     OutString(20,0,IVrw.Spec,false);
    EndFormat;
  end;            
  Gray_Divider(0,1);
  RETURN;    
END;       

global 
procedure KreditstyRn(record RcVc RepSpec)
BEGIN
  record FactoringBlock factb;
  record ARVc ARr;
  record IVVc IVr;
  Boolean TrHs,testf;
  LongInt frinv,toinv;
  string 20 frcu,tocu;
  LongInt cnt;
  Date curdate;
  
  curdate = CurrentDate;  
  StartReportJob("Kreditstyrning");
  EndHeader;
  StartFormat(15);
   OutString(0,0,USetStr(2923),false);
   OutString(60,0,USetStr(3576),false);
   OutString(120,0,USetStr(8277),false);
   OutString(200,0,USetStr(9362),false);
   OutString(250,0,USetStr(2372),false);
   OutString(310,0,USetStr(8469),false);
   OutString(390,0,USetStr(5246),false);
   OutString(480,0,USetStr(5624),true);
  EndFormat;
  Gray_Divider(0,1);
  BlockLoad(factb);
  factb.LastSerNr = RepSpec.FirstVer;
  if (factb.LastSerNr==0) then begin factb.LastSerNr = 1; end;
  if (factb.LastSerNr==999) then begin factb.LastSerNr = 1; end;  
  frinv = FirstInRange(RepSpec.f1,10);
  toinv = LastInRange(RepSpec.f1,10);
  frcu = FirstInRange(RepSpec.f2,20);
  tocu = LastInRange(RepSpec.f2,20);
  cnt = 0;
  TrHs = true;
  ARr.DueDate = RepSpec.sStartDate;
  ARr.InvoiceNr = frinv;
  while (LoopKey("DueDate",ARr,2,TrHs)) begin
    if (ARr.DueDate>RepSpec.sEndDate) then begin TrHs = false; end;
    if (TrHs) then begin
      testf = true;
      if (nonblank(RepSpec.f1)) then begin
        if (ARr.InvoiceNr>toinv) then begin testf = false; end;
        if (ARr.InvoiceNr<frinv) then begin testf = false; end;
      end;  
      if (nonblank(RepSpec.f2)) then begin
        if ((ARr.CustCode<frcu) or (ARr.CustCode>tocu)) then begin testf = false; end;
      end;  
      if (nonblank(RepSpec.CurncyCode)) then begin
        if (ARr.ARCurncyCode!=RepSpec.CurncyCode) then begin testf = false; end;
      end;  
      if (testf) then begin      
        IVr.SerNr = ARr.InvoiceNr;
        if (ReadFirstMain(IVr,1,true)) then begin end;
        if (nonblank(RepSpec.ObjStr)) then begin
          if (SetInSet(RepSpec.ObjStr,IVr.Objects)==false) then begin testf = false; end;
        end;  
      end;  
      if (IVr.LastRemndr==99) then begin testf = false; end;
      if (RepSpec.long1!=-1) then begin
        if (IVr.LastRemndr!=RepSpec.long1) then begin testf = false; end;
      end;  
      if (RepSpec.long2!=-1) then begin
        if (DateDiff(curdate,IVr.PayDate)<RepSpec.long2) then begin testf = false; end;
      end;              
      if (testf) then begin
        KreditstyRepIV(IVr,ARr,factb.LastSerNr);
        cnt = cnt + 1;
      end;    
    end;
  end;
  EndJob;
  RETURN;
END;
