procedure POStock(string vecode)
BEGIN
  Boolean testf,TrHs,firstf,firstpof;
  record POVc POr;
  row POVc POrw;
  Integer i,rwcnt;
    
  StartFormat(15);
  EndFormat;
  firstf = true;
  TrHs = true;
  POr.OSFlag = 1;
  while (LoopKey("OSFlag",POr,1,TrHs)) begin
    if (POr.OSFlag!=1) then begin
      TrHs = false;
    end;
    if (TrHs) then begin
      testf = true;
      if (POr.Closed!=0) then begin testf = false; end;
      if (POr.VECode!=vecode) then begin testf = false; end;
      if (POr.VECode!=vecode) then begin testf = false; end;
      if (testf) then begin
        firstpof = true;
        rwcnt = MatRowCnt(POr);
        for (i=0;i<rwcnt;i=i+1) begin
          MatRowGet(POr,i,POrw);
          if (POrw.Quant!=POrw.Invd) then begin
            if (firstf) then begin
              StartFormat(15);
               OutString(0,0,"Not Invoiced Orders",false);
              EndFormat;
              firstf = false;
            end;
            if (firstpof) then begin
              StartFormat(15);
               OutLongInt(15,"DblPOVc",POr.SerNr,false);
              EndFormat;
              StartFormat(15);
               OutString(20,0,"Row no.",false);
               OutString(80,0,"Item",false);
               OutString(240,0,"PO",true);
               OutString(320,0,"PI",true);
              EndFormat;
              firstpof = false;
            end;            
            StartFormat(15);
            OutLongInt(20,0,i+1,false);
            OutString(80,0,POrw.ArtCode,false);
            OutVal(240,0,POrw.Quant,M4Qty,true);
            OutVal(320,0,POrw.Invd,M4Qty,true);
            EndFormat;
          end;
        end;
      end;
    end;
  end;
  RETURN;
END;

procedure PUNotReconciled(LongInt punr)
BEGIN
  Boolean res,firstf,firstpuf;
  Integer i,rwcnt;
  row PUVc PUrw;
  record PUVc PUr;
  val t;
  
  PUr.SerNr = punr;
  if (ReadFirstMain(PUr,1,true)) then begin
    firstf = true;
    firstpuf = true;
    rwcnt = MatRowCnt(PUr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(PUr,i,PUrw);
      if (PUrw.Quant!=PUrw.VIRecon) then begin
        if (firstf) then begin
          StartFormat(15);
           OutString(0,0,"Not recon Invoices qtys",false);
          EndFormat;
          firstf = false;
        end;
        if (firstpuf) then begin
          StartFormat(15);
           OutLongInt(15,"DblPU",PUr.SerNr,false);
          EndFormat;
          StartFormat(15);
           OutString(20,0,"Row no.",false);
           OutString(80,0,"Item",false);
           OutString(240,0,"GR",true);
           OutString(320,0,"PI",true);
          EndFormat;
          firstpuf = false;
        end;
        StartFormat(15);
        OutLongInt(20,0,i+1,false);
        OutString(80,0,PUrw.ArtCode,false);
        OutVal(240,0,PUrw.Quant,M4Qty,true);
        t = PUrw.VIRecon;
        if (t==0) then begin t = 0; end;
        OutVal(320,0,t,M4Qty,true);
        EndFormat;      
      end;
    end;
    firstf = true;
    firstpuf = true;
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(PUr,i,PUrw);
      if (PUrw.Quant!=PUrw.PORecon) then begin
        if (firstf) then begin
          StartFormat(15);
           OutString(0,0,"Not recon Orders qtys",false);
          EndFormat;
          firstf = false;
        end;
        if (firstpuf) then begin
          StartFormat(15);
           OutLongInt(15,"DblPU",PUr.SerNr,false);
          EndFormat;
          StartFormat(15);
           OutString(20,0,"Row no.",false);
           OutString(80,0,"Item",false);
           OutString(240,0,"GR",true);
           OutString(320,0,"PO",true);
          EndFormat;
          firstpuf = false;
        end;
        StartFormat(15);
        OutLongInt(20,0,i+1,false);
        OutString(80,0,PUrw.ArtCode,false);
        OutVal(240,0,PUrw.Quant,M4Qty,true);
        t = PUrw.PORecon;
        if (t==0) then begin t = 0; end;
        OutVal(320,0,t,M4Qty,true);
        EndFormat;
      end;
    end;    
  end;  
  RETURN;  
END;

global 
procedure PUNotReconRn(record RcVc RepSpec)
BEGIN
  record VIVc VIr;
  Integer i,rwcnt;
  row VIVc VIrw;
  
  StartReportJob("Not Recon POs");
  EndHeader;

  StartFormat(15);
  EndFormat;
  Gray_Divider(0,1);  
  VIr.SerNr = RepSpec.long1;
  if (ReadFirstMain(VIr,1,true)) then begin
    rwcnt = MatRowCnt(VIr);
    for (i=0;i<rwcnt;i=i+1) begin
      MatRowGet(VIr,i,VIrw);
      if (VIrw.PUNr!=-1) then begin
        PUNotReconciled(VIrw.PUNr);
        goto LPUNotReconRn;//only one invoice from GR at the moment
      end;
    end;
  end;  
LPUNotReconRn:;  
  POStock(VIr.VECode);
  EndJob;
  RETURN;
END;

