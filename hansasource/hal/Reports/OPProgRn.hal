external function Boolean HasContactClassification();
external function Boolean HasCategories();
external procedure HTLevCat(string,var string);
external procedure HTCustClass(string,var string);
external function Boolean ContactInGroupClass2(string,string,string,string,string,string,string);
external procedure GetAccPeriodComments(Integer,Date,var string,var string,var string,var string,var string,var string,var string);
external function roundmode GetTotalRoundMode(record RoundBlock);
external function val MulRateToBase1(var string,val,val,val,val,val,val,roundmode);
external function val MulWithRateToBase1(var string,Date,val,roundmode);
external function LongInt DateDiff(Date,Date);
external procedure HTVends(string, string, var string);
external procedure HTObj(string,var string);
external procedure HTOT(string,var string);
external procedure SumAged(Date,Integer,Integer,var val,var val,var val,var val,var val,var val,var val,var val,var val,var val);
external procedure PrintAgedLine(val,val,val,val,val,val,val,val,val,val,val,Integer,Integer,string);
external procedure CountPeriods(var Integer);
external procedure GetPDVRebt(string,var val);
external procedure HTCustClass(string,var string);
external procedure HTCustClassType(string,var string);
external function Boolean SetInSet2(string,string);
external procedure ClassTypef(string,string,var Boolean);

procedure PrintAgedHeader(Date d1,Integer nrofper)
begin
  record AgedBlock AgedRec;
  string 30 tstr1,tstr2,tstr3,tstr4,tstr5,tstr6,tstr7;
  LongInt p1,p2;
  Date agedate;

  BlockLoad(AgedRec);  
  if (AgedRec.UseAccPeriod) then begin
    agedate = d1;
    if (blankdate(agedate)) then begin agedate = CurrentDate; end;
    GetAccPeriodComments(1,agedate,tstr1,tstr2,tstr3,tstr4,tstr5,tstr6,tstr7);
    if (nrofper<=1) then begin
      tstr2 = tstr2 & " - ";
    end;
    if (nrofper<=2) then begin
      tstr3 = tstr3 & " - ";
    end;
    if (nrofper<=3) then begin
      tstr4 = tstr4 & " - ";
    end;
    if (nrofper<=4) then begin
      tstr5 = tstr5 & " - ";
    end;
    if (nrofper<=5) then begin
      tstr6 = tstr6 & " - ";
    end;
    tstr7 = tstr7 & " - ";
  end else begin
    p1 = AgedRec.Per1;
    p2 = AgedRec.Per2;
    if (p1==-1) then begin p1 = 15; end;
    if (p2==-1) then begin p2 = 30; end;
    tstr1 = "0 - " & p1;
    tstr2 = "" & p1+1 & " - " & p2;
    tstr3 = "" & p2+1 & " - "; 
    if (AgedRec.Per3>-1) then begin tstr3 = tstr3 & AgedRec.Per3; end;
    tstr4 = "" & AgedRec.Per3+1 & " - ";
    if (AgedRec.Per4>-1) then begin tstr4 = tstr4 & AgedRec.Per4; end;
    tstr5 = "" & AgedRec.Per4+1 & " - ";
    if (AgedRec.Per5>-1) then begin tstr5 = tstr5 & AgedRec.Per5; end;
    tstr6 = "" & AgedRec.Per5+1 & " - ";
    if (AgedRec.Per6>-1) then begin tstr6 = tstr6 & AgedRec.Per6; end;
    tstr7 = "" & AgedRec.Per6+1 & " - ";
  end;
  StartFormat(15);
  OutStringAdjust(2,0,USetStr(4137),true,M4Val);
  OutStringAdjust(3,0,tstr1,true,M4Val);
  OutStringAdjust(4,0,tstr2,true,M4Val);
  OutStringAdjust(5,0,tstr3,true,M4Val);
  if (nrofper>2) then begin
    OutStringAdjust(6,0,tstr4,true,M4Val);
  end;
  if (nrofper>3) then begin
    OutStringAdjust(7,0,tstr5,true,M4Val);
  end;
  if (nrofper>4) then begin
    OutStringAdjust(8,0,tstr6,true,M4Val);
  end;
  if (nrofper>5) then begin
    OutStringAdjust(9,0,tstr7,true,M4Val);
  end;
  OutStringAdjustBiDi(1,0,USetStr(4046),true,M4Val,520);
  EndFormat;
  Gray_Divider(0,1);
  return;
end;

procedure PrintNSumOPInstall(record RcVc RepSpec,record VIVc VIp,var val APSump,var val sact,var val s0,var val s1,var val s2,var val s3,var val s4,var val s5,var val s6,var val s7)
BEGIN
  record APInstallVC APIr;
  Boolean TrHs;
  LongInt latedays;

  APIr.VISerNr = VIp.SerNr;
  TrHs = true;
  while (LoopKey("VISerNr",APIr,1,TrHs)) begin
    if (APIr.VISerNr!=VIp.SerNr) then begin
      TrHs = false;
    end;  
    if (TrHs) then begin
      latedays = DateDiff(APIr.DueDate,CurrentDate);
      APSump = APSump + APIr.BookRVal;
      if (RepSpec.flags[0]==0) then begin
        StartFormat(15);
        OutDate(0,0,APIr.DueDate,false);
        OutLongInt(70,"DblVIVc",VIp.SerNr,false);
        OutString(150,0,VIp.VECode,false);
        OutString(220,0,VIp.VEName,false);
        OutVal(400,0,APIr.BookRVal,M4Val,true);
        OutVal(480,0,APSump,M4Val,true);
        EndFormat;
        if (nonblank(VIp.Comment)) then begin
          StartFormat(15);
          OutString(40,0,VIp.Comment,false);
          EndFormat;
       end;
      end;
      SumAged(CurrentDate,-latedays,0,APIr.BookRVal,sact,s0,s1,s2,s3,s4,s5,s6,s7);
    end;
  end;
  RETURN;
END;

global
procedure OPProgRn(record RcVc RepSpec) 
BEGIN
  record APVc APr;
  record VIVc VIr;
  record ObjVc OBr;  
  Boolean TrHs;
  val APSum,rs;
  val APVal,pdvrebt,tv;
  val sact,s0,s1,s2,s3,s4,s5,s6,s7,tot;
  LongInt latedays;
  Boolean testf,vif,Accs;
  string 255 ckey,tstr,t2;
  Date pd,thed;
  Integer rw,nrofper;
  record RoundBlock Roundb;
  record AccBlock Accb;
  
  BlockLoad(Accb); 
  BlockLoad(Roundb); 
  thed = RepSpec.d1;
  if (blankdate(thed)) then begin 
    thed = CurrentDate;
  end;
  StartReportJob(USetStr(4121));
  rw = 1;    
  HTVends(RepSpec.f2,RepSpec.f2,tstr);
  Header(rw,tstr,1);
  rw = rw + 1;
   if (RepSpec.ArtMode==1) then begin
     tstr = USetStr(4128);
   end else begin
     tstr = USetStr(4127);
   end;  
   Header(rw,tstr,0);
   if (RepSpec.flags[1]==0) then begin
     tstr = USetStr(4133);
   end else begin
     tstr = USetStr(4134);
   end;  
   Header(rw,tstr,1);
   rw = rw + 1;
   if (RepSpec.flags[0]==0) then begin
     tstr = USetStr(4129);
   end else begin
     tstr = USetStr(4130);
   end;  
   Header(rw,tstr,0);
   if (nonblank(RepSpec.ObjStr)) then begin
     HTObj(RepSpec.ObjStr,tstr);
     Header(rw,tstr,1);
     rw = rw + 1;
   end else begin
     if (nonblank(RepSpec.ObjType)) then begin
       HTOT(RepSpec.ObjType,tstr);
       Header(rw,tstr,1);
       rw = rw + 1;
     end;
   end;
  if (IsBooks==false) then begin
    if (HasContactClassification) then begin
      HTCustClass(RepSpec.f4,tstr);
      if (nonblank(tstr)) then begin
        Header(rw,tstr,1);
        rw = rw + 1;
      end;
    end;
    HTCustClassType(RepSpec.f5,tstr);
    if (nonblank(tstr)) then begin
      Header(rw,tstr,1);
      rw = rw + 1;
    end; 
    if (HasCategories) then begin
      HTLevCat(RepSpec.f7,tstr);
      if (nonblank(tstr)) then begin
        Header(rw,tstr,1);
        rw = rw + 1;
      end;
    end;
  end;   
  EndHeader;
  if (RepSpec.flags[0]!=0) then begin
  CountPeriods(nrofper);
  if (nrofper==2) then begin
    SetRepColBiDi(2,250,290);
    SetRepColBiDi(3,300,340);
    SetRepColBiDi(4,350,390);
    SetRepColBiDi(5,400,440);
  end;
  if (nrofper==3) then begin
    SetRepColBiDi(2,100,140);
    SetRepColBiDi(3,180,220);
    SetRepColBiDi(4,260,300);
    SetRepColBiDi(5,320,360);
    SetRepColBiDi(6,400,440);
  end;
  if (nrofper==4) then begin
    SetRepColBiDi(2,80,120);
    SetRepColBiDi(3,160,200);
    SetRepColBiDi(4,240,280);
    SetRepColBiDi(5,320,360);
    SetRepColBiDi(6,380,420);
    SetRepColBiDi(7,430,470);
  end;
  if (nrofper==5) then begin
    SetRepColBiDi(2,60,100);
    SetRepColBiDi(3,120,160);
    SetRepColBiDi(4,180,220);
    SetRepColBiDi(5,240,280);
    SetRepColBiDi(6,300,340);
    SetRepColBiDi(7,360,400);
    SetRepColBiDi(8,420,460);    
  end;
  if (nrofper==6) then begin
    SetRepColBiDi(2,50,90);
    SetRepColBiDi(3,100,140);
    SetRepColBiDi(4,150,190);
    SetRepColBiDi(5,200,240);
    SetRepColBiDi(6,250,290);
    SetRepColBiDi(7,300,340);
    SetRepColBiDi(8,350,390);
    SetRepColBiDi(9,400,440);
  end;
  end;
  if (RepSpec.ArtMode==1) then begin
    ckey = "RebDate";
  end else begin
    ckey = "DueDate";
  end;
  if (RepSpec.flags[0]==0) then begin
    StartFormat(15);
    OutString(0,0,USetStr(4122),false);
   // OutString(60,0,USetStr(4136),false);
    OutString(70,0,USetStr(4123),false);
    OutString(150,0,USetStr(4126),false);
    OutString(220,0,USetStr(4132),false);
    OutStringAdjustBiDi(400,0,USetStr(4124),true,M4Val,450);
    OutStringAdjustBiDi(1,0,USetStr(4125),true,M4Val,505);
    EndFormat;
  end else begin
    PrintAgedHeader(RepSpec.d1,nrofper);
  end;
  APr.SerNr = 0;
  if (RepSpec.flags[0]==0) then begin
    Gray_Divider(0,1);
  end;  
  TrHs = true;
  while (LoopKey(ckey,APr,2,TrHs)) begin
    VIr.SerNr = APr.SerNr;
    vif = ReadFirstMain(VIr,1,true);
    if (RepSpec.ArtMode==1) then begin
      if (vif) then begin
        pd = VIr.RebDate;
      end else begin
        pd = APr.RebDate;
      end;
    end else begin
      if (vif) then begin
        pd = VIr.DueDate;
      end else begin
        pd = APr.DueDate;
      end;  
    end;
    if (blankdate(pd)) then begin
      pd = VIr.DueDate;
    end;
    if (nonblankdate(RepSpec.d1)) then begin
      if (pd>RepSpec.d1) then begin
        TrHs = false;
      end;  
    end;  
    if (TrHs) then begin
      if (blank(RepSpec.f2) or (RepSpec.f2==APr.VECode)) then begin
        testf = true;
        if (RepSpec.flags[1]==1) then begin
          if (vif) then begin
            if (VIr.Closed!=0) then begin
              testf = false;
            end;
          end;    
        end;
        if (testf) then begin
          testf = ContactInGroupClass2(VIr.VECode,RepSpec.f7,RepSpec.f4,RepSpec.f5,"SUPP","","");
        end;
        if (testf) then begin
          if (nonblank(RepSpec.ObjStr)) then begin 
            if (SetInSet(RepSpec.ObjStr,VIr.Objects)==false) then begin
              testf = false;
            end;  
          end else begin
            if ((testf==true) and (nonblank(RepSpec.ObjType))) then begin
              testf = false;
              OBr.OTCode = RepSpec.ObjType;
              OBr.Code = "";
              Accs = true;
              ResetLoop(OBr);
              while (LoopKey("OTCode",OBr,1,Accs)) begin
                if ((Accs==true) and (RepSpec.ObjType==OBr.OTCode)) then begin
                  if (SetInSet(OBr.Code,VIr.Objects)) then begin
                    testf = true;
                    Accs = false;
                  end;
                end;
              end; 
            end;
          end;
        end;
        if (testf) then begin
          if ((vif==false) or (VIr.InstallmentInv==0)) then begin
            if (RepSpec.ArtMode==1) then begin
              latedays = DateDiff(pd,thed);
              APVal = APr.RVal;
              GetPDVRebt(VIr.PayDeal,pdvrebt);
              if (pdvrebt!=0) then begin
                tv = (VIr.RebVal*APVal)/VIr.PayVal;
                if (tv==0) then begin
                  if (Accb.DiscCashVAT!=0) then begin
                    tv = VIr.CalcVATVal;
                    if (VIr.VATVal!=0) then begin
                      tv = VIr.VATVal;
                    end;
                    tv = VIr.PayVal - tv;
                    tv = tv*pdvrebt;
                  end else begin
                    tv = APVal*pdvrebt;
                  end;
                  tv = tv/100;
                  tv = Round(tv,GetTotalRoundMode(Roundb));
                end;
                APVal = APVal - tv;
//pdvrebt2                
              end;
            end else begin
              if (vif) then begin
                latedays = DateDiff(VIr.DueDate,thed);
              end else begin
                latedays = DateDiff(APr.DueDate,thed);
              end;   
              APVal = APr.RVal;
            end;
            APVal = APVal - VIr.HoldSum;
            if (vif) then begin
//              rs = MulRateToBase1(VIr.CurncyCode,APVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);
//they say it should be todays rate in forecast
              rs = MulWithRateToBase1(VIr.CurncyCode,CurrentDate,APVal,DefaultCurRoundOff);          
            end else begin
              rs = MulWithRateToBase1(APr.CurncyCode,APr.DueDate,APVal,DefaultCurRoundOff);
            end;  
            APSum = APSum + rs;
            if (vif==false) then begin
              VIr.SerNr = APr.SerNr;
              VIr.VECode = APr.VECode;
              VIr.VEName = APr.VEName;
              VIr.Comment = "";
              t2 = USetStr(2530);
            end;
            tstr = VIr.SerNr;
            if (VIr.POSerNr>=1) then begin
              t2 = VIr.POSerNr;
            end else begin
              t2 = "";
            end;
            if (vif==false) then begin
              tstr = t2;
            end;  
            if (RepSpec.flags[0]==0) then begin
              StartFormat(15);
              OutDate(0,0,pd,false);
              if (HasLocalization("ARG")) then begin
                OutStringID(70,"DblVIVc",VIr.SerNr & ",(" & VIr.InvoiceNr & ")",false,VIr.SerNr);
              end else begin 
                OutString(70,"DblVIVc",VIr.SerNr,false);
              end;  
              OutString(150,0,VIr.VECode,false);
              OutString(220,0,VIr.VEName,false);
              OutValBiDi(400,0,rs,M4Val,true,450);
              OutValBiDi(1,0,APSum,M4Val,true,505);
/*              
              OutString(70,"DblVIVc",tstr,false);
              OutString(110,"DblPOVc",t2,false);
              OutString(150,0,VIr.VECode,false);
              OutString(210,0,VIr.VEName,false);
              OutVal(380,0,rs,M4Val,true);
              OutVal(480,0,APSum,M4Val,true);
*/              
              EndFormat;
              if (nonblank(VIr.Comment)) then begin
                StartFormat(15);
                OutString(40,0,VIr.Comment,false);
                EndFormat;
              end;
            end;
            SumAged(thed,-latedays,0,rs,sact,s0,s1,s2,s3,s4,s5,s6,s7);        
          end else begin
            PrintNSumOPInstall(RepSpec,VIr,APSum,sact,s0,s1,s2,s3,s4,s5,s6,s7);
          end;
        end;
      end;
    end;  
  end;
  if (RepSpec.flags[0]==0) then begin
    Gray_Divider(0,1);
  end;  
  if (RepSpec.flags[0]==1) then begin
    tot = s0 + s1;
    tot = tot + s2;
    tot = tot + s3;
    tot = tot + s4;
    tot = tot + s5;
    tot = tot + s6;
    tot = tot + s7;
    tot = tot + sact;
    PrintAgedLine(sact,s0,s1,s2,s3,s4,s5,s6,s7,blankval,tot,nrofper,480,"");
  end;
  if ((RepSpec.flags[2]!=0) or (RepSpec.flags[3]!=0)) then begin
    if (RepSpec.flags[3]!=0) then begin
      tstr = USetStr(2366);        
      if (RepSpec.flags[2]!=0) then begin
        t2 = USetStr(2891);
        tstr = tstr & t2;
        t2 = USetStr(3023);        
        tstr = tstr & t2;
      end;      
    end else begin
      tstr = USetStr(3023);        
    end;
    StartFormat(15);
    if (RepSpec.flags[0]==0) then begin
      OutString(0,0,tstr,false);
    end else begin
      OutString(140,0,tstr,false);
    end;
    EndFormat;
    APSum = 0;
    s0 = 0;
    s1 = 0;
    s2 = 0;
    s3 = 0;
    s4 = 0;
    s5 = 0;
    s6 = 0;
    s7 = 0;      
    VIr.OKFlag = 0;
    VIr.SerNr = -1;
    TrHs = true;
    while (LoopKey("OKFlag",VIr,2,TrHs)) begin
      if (VIr.OKFlag!=0) then begin TrHs = false; end;
      if (TrHs) then begin
        testf = true;        
        if (RepSpec.ArtMode==1) then begin
          pd = VIr.RebDate;
        end else begin
          pd = VIr.DueDate;
        end;        
        if (nonblankdate(RepSpec.d1)) then begin
          if (RepSpec.ArtMode==1) then begin
            if (pd>RepSpec.d1) then begin testf = false; end;
          end else begin
            if (pd>RepSpec.d1) then begin testf = false; end;
          end;          
        end;  
        if (nonblank(RepSpec.f2) and (RepSpec.f2!=VIr.VECode)) then begin
          testf = false;
        end;  
        if (blank(RepSpec.f2) or (RepSpec.f2==VIr.VECode)) then begin
          if (RepSpec.flags[1]==1) then begin
            if (VIr.Closed!=0) then begin testf = false; end;
          end;
        end;
        if (testf) then begin
          testf = ContactInGroupClass2(VIr.VECode,RepSpec.f7,RepSpec.f4,RepSpec.f5,"SUPP","","");
        end;        
        if (RepSpec.flags[2]==0) then begin
          if (VIr.PrelBook!=0) then begin testf = false; end;
        end;  
        if (RepSpec.flags[3]==0) then begin
          if (VIr.PrelBook==0) then begin testf = false; end;
        end;  
        if (testf) then begin
          if (nonblank(RepSpec.ObjStr)) then begin 
            if (SetInSet(RepSpec.ObjStr,VIr.Objects)==false) then begin
              testf = false;
            end;  
          end else begin
            if ((testf==true) and (nonblank(RepSpec.ObjType))) then begin
              testf = false;
              OBr.OTCode = RepSpec.ObjType;
              OBr.Code = "";
              Accs = true;
              ResetLoop(OBr);
              while (LoopKey("OTCode",OBr,1,Accs)) begin
                if ((Accs==true) and (RepSpec.ObjType==OBr.OTCode)) then begin
                  if (SetInSet(OBr.Code,VIr.Objects)==true) then begin
                    testf = true;
                    Accs = false;
                  end;
                end;
              end; 
            end;
          end;
        end;  
        if (testf) then begin
          if (RepSpec.ArtMode==1) then begin
            latedays = DateDiff(pd,thed);
            APVal = VIr.PayVal;
            GetPDVRebt(VIr.PayDeal,pdvrebt);
            if (pdvrebt!=0) then begin
              tv = APVal*pdvrebt;
              tv = tv/100;
              tv = Round(tv,GetTotalRoundMode(Roundb));
              APVal = APVal - tv;
//pdvrebt2              
            end;
          end else begin            
            latedays = DateDiff(VIr.DueDate,thed);
            APVal = VIr.PayVal;
          end;
          APVal = APVal - VIr.HoldSum;
          rs = MulRateToBase1(VIr.CurncyCode,APVal,VIr.FrRate,VIr.ToRateB1,VIr.ToRateB2,VIr.BaseRate1,VIr.BaseRate2,DefaultCurRoundOff);
          if (VIr.InvType==kInvoiceTypeCredit or VIr.InvType==kInvoiceTypeCreditSpecialSales) then begin
            rs = -rs;
          end;  
          APSum = APSum + rs;
          tstr = VIr.SerNr;
          if (vif==false) then begin
            tstr =  tstr & t2;
          end;  
          if (RepSpec.flags[0]==0) then begin
            StartFormat(15);
            OutDate(0,0,pd,false);
           // OutString(60,0,t2,false);
            OutString(70,"DblVIVc",VIr.SerNr,false);
            OutString(140,0,VIr.VECode,false);
            OutString(200,0,VIr.VEName,false);
            OutValBiDi(400,0,rs,M4Val,true,450);
            OutValBiDi(1,0,APSum,M4Val,true,505);
            EndFormat;
            if (nonblank(VIr.Comment)) then begin
              StartFormat(15);
              OutString(70,0,VIr.Comment,false);
              EndFormat;
            end;
          end;
          SumAged(thed,-latedays,0,rs,sact,s0,s1,s2,s3,s4,s5,s6,s7);        
        end;
      end;
    end;
    if (RepSpec.flags[0]==0) then begin
      Gray_Divider(0,1);    
    end;  
    if (RepSpec.flags[0]==1) then begin
      PrintAgedLine(sact,s0,s1,s2,s3,s4,s5,s6,s7,blankval,tot,nrofper,480,"");
    end;        
  end;  
  EndJob;
  RETURN;
END;
