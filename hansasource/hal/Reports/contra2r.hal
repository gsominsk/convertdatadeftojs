external function Boolean HasCategories();
external function Boolean HasContactClassification();
external function Boolean SetInSet2(string,string);
external procedure HTCustCat(string,var string);
external procedure HTCustClass(string,var string);

global
procedure Contra2Rn(record RcVc RepSpec)
begin
  record COVc COr;
  record CUVc CUr;
  Integer xkey;
  Integer rw;
  Boolean TrHs;
  Boolean testf;
  String 255 tstr;
  val totsum;
  
  rw = 1;
  totsum = 0;
  StartReportJob(USetStr(8910));
  if (RepSpec.f1<>"") then begin
    tstr = USetStr(7113);
    tstr = tstr & RepSpec.f2;
    Header(rw,tstr,1);
    rw = rw + 1;
  end else begin
    tstr = USetStr(6661);
    Header(rw,tstr,1);
  end;
  if (HasCategories) then begin 
    HTCustCat(RepSpec.f3,tstr);
    if (nonblank(tstr)) then begin
      Header(rw,tstr,1);
      rw = rw + 1;
    end;
  end; 
  if (HasContactClassification) then begin
    HTCustClass(RepSpec.Stext,tstr);
    if (nonblank(tstr)) then begin
      Header(rw,tstr,1);
      rw = rw + 1;
    end;  
  end;     
  EndHeader;
  tstr ="";
  StartFormat(15);
  OutString(0,0,USetStr(5552),false);
  OutString(70,0,USetStr(2448),false);
  OutString(240,0,USetStr(5543),false);
  OutString(300,0,USetStr(6688),false);
  OutString(480,0,USetStr(7025),true);
  EndFormat;
  Gray_Divider(0,1);
  TrHs = true;
  while (LoopMain(COr,1,TrHs)) begin
    testf = true;
    if (TrHs) then begin
      if (nonblank(RepSpec.f1)) then begin
        if (COr.Department<>RepSpec.f1) then begin
          testf = false;
        end;
      end;
    end; 
    if (testf) then begin
      CUr.Code = COr.CustCode;
      if (ReadFirstMain(CUr,1,true)) then begin
        tstr = CUr.Phone;
      end else begin
        tstr ="----";
      end;
    end;
    if (testf) then begin 
      if (nonblank(RepSpec.Stext)) then begin
        if (SetInSet2(RepSpec.Stext,CUr.Classification)==false) then begin
          testf = false;
        end;
      end;      
    end;
    if (testf) then begin 
      if (nonblank(RepSpec.f3)) then begin
        if (RepSpec.f3!=CUr.CustCat) then begin
          testf = false;
        end;
      end;      
    end;       
    if (testf) then begin
      StartFormat(15);
      OutString(0,"DblCUVc",COr.CustCode,false);
      OutString(70,0,Left(COr.Addr0,30),false);
      OutString(240,"DblCOVc",COr.SerNr,false);
      OutString(300,0,COr.VEContact,false);
      OutString(480,0,tstr,true);
      EndFormat;
      totsum = totsum + 1;
    end;
  end;
  Black_Divider(0,1);
  StartFormat(15);
  OutString(350,0,USetStr(6712),false);
  OutVal(480,0,totsum,M4UVal,true);
  EndFormat;
  EndJob;
  return;
end;

